open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module TDSL = Operation.TDSL
module NTDSL = Operation.NTDSL
module CDSL = Train.CDSL
module Utils = Arrayjit.Utils
module Rand = Arrayjit.Rand.Lib

let main () =
  let seed = 1 in
  let hid_dim = 16 in
  (* let hid_dim = 4 in *)
  let batch_size = 120 in
  (* let batch_size = 60 in *)
  (* let batch_size = 20 in *)
  let len = batch_size * 20 in
  let init_lr = 0.1 in
  (* let epochs = 10 in *)
  let epochs = 20 in
  (* let epochs = 1 in *)
  let noise () = Rand.float_range (-0.1) 0.1 in
  let moons_flat =
    Array.concat_map (Array.create ~len ())
      ~f:
        Float.(
          fun () ->
            let i = Rand.int len in
            let v = of_int i * pi / of_int len in
            let c = cos v and s = sin v in
            [| c + noise (); s + noise (); 1.0 - c + noise (); 0.5 - s + noise () |])
  in
  let moons_flat ~b = TDSL.init_const ~l:"moons_flat" ~b ~o:[ 2 ] moons_flat in
  let moons_classes = Array.init (len * 2) ~f:(fun i -> if i % 2 = 0 then 1. else -1.) in
  let moons_classes ~b = TDSL.init_const ~l:"moons_classes" ~b ~o:[ 1 ] moons_classes in
  let%op mlp x = "b3" + ("w3" * ?/("b2" hid_dim + ("w2" * ?/("b1" hid_dim + ("w1" * x))))) in
  (* let%op mlp x = "b" + ("w" * x) in *)
  let%op loss_fn ~output ~expectation = ?/(!..1 - (expectation *. output)) in
  (* We don't need a regression loss formula thanks to weight_decay built into the sgd_update
     computation. *)
  let weight_decay = 0.0002 in
  (* So that we can inspect them. *)
  let backend = Arrayjit.Backends.fresh_backend () in
  let per_batch_callback ~at_batch ~at_step ~learning_rate ~batch_loss ~epoch_loss =
    if (at_batch + 1) % 20 = 0 then
      Stdio.printf "Batch=%d, step=%d, lr=%f, batch loss=%f, epoch loss=%f\n%!" at_batch at_step
        learning_rate batch_loss epoch_loss
  in
  (* Tn.print_accessible_headers (); *)
  let per_epoch_callback ~at_step ~at_epoch ~learning_rate ~epoch_loss =
    Stdio.printf "Epoch=%d, step=%d, lr=%f, epoch loss=%f\n%!" at_epoch at_step learning_rate
      epoch_loss
  in
  let module Backend = (val backend) in
  let inputs, outputs, _model_result, infer_callback, _batch_losses, _epoch_losses, _learning_rates
      =
    Train.example_train_loop ~seed ~batch_size ~max_num_devices:(batch_size / 2) ~init_lr
      ~data_len:len ~epochs ~inputs:moons_flat ~outputs:moons_classes ~model:mlp ~loss_fn
      ~weight_decay ~per_batch_callback ~per_epoch_callback
      (module Backend)
      ()
  in
  let points = Tensor.value_2d_points ~xdim:0 ~ydim:1 inputs in
  let classes = Tensor.value_1d_points ~xdim:0 outputs in
  let points1, points2 = Array.partitioni_tf points ~f:Float.(fun i _ -> classes.(i) > 0.) in
  let callback (x, y) = Float.((infer_callback [| x; y |]).(0) >= 0.) in
  let plot_moons =
    let open PrintBox_utils in
    plot ~no_axes:true ~size:(120, 40)
      [
        Scatterplot { points = points1; pixel = "#" };
        Scatterplot { points = points2; pixel = "%" };
        Boundary_map { pixel_false = "."; pixel_true = "*"; callback };
      ]
  in
  Stdio.printf "\nHalf-moons scatterplot and decision boundary:\n";
  PrintBox_text.output Stdio.stdout plot_moons

let%expect_test "Half-moons data parallel" =
  Tensor.unsafe_reinitialize ();
  main ();
  (* NOTE: as of OCANNL 0.4, moons_demo_parallel, while deterministic on a single machine, gives
     slightly different results on machines with a different hardware, e.g. arm64, ppc. Here we list
     the results from the various CI targets. The first result is the one typically observed, the
     second comes from targets debian-arm64 and debian-s390x, the third one from debian-ppc. *)
  let result = [%expect.output] in
  let typical_target_sync_cc =
    {|
Batch=19, step=20, lr=0.195250, batch loss=0.263769, epoch loss=45.768608
Epoch=0, step=20, lr=0.195250, epoch loss=45.768608
Batch=19, step=40, lr=0.190250, batch loss=0.210844, epoch loss=5.625710
Epoch=1, step=40, lr=0.190250, epoch loss=5.625710
Batch=19, step=60, lr=0.185250, batch loss=0.199376, epoch loss=5.396800
Epoch=2, step=60, lr=0.185250, epoch loss=5.396800
Batch=19, step=80, lr=0.180250, batch loss=0.193945, epoch loss=5.220046
Epoch=3, step=80, lr=0.180250, epoch loss=5.220046
Batch=19, step=100, lr=0.175250, batch loss=0.189124, epoch loss=5.124980
Epoch=4, step=100, lr=0.175250, epoch loss=5.124980
Batch=19, step=120, lr=0.170250, batch loss=0.190997, epoch loss=5.006840
Epoch=5, step=120, lr=0.170250, epoch loss=5.006840
Batch=19, step=140, lr=0.165250, batch loss=0.179420, epoch loss=4.851730
Epoch=6, step=140, lr=0.165250, epoch loss=4.851730
Batch=19, step=160, lr=0.160250, batch loss=0.166937, epoch loss=4.694808
Epoch=7, step=160, lr=0.160250, epoch loss=4.694808
Batch=19, step=180, lr=0.155250, batch loss=0.155812, epoch loss=4.430248
Epoch=8, step=180, lr=0.155250, epoch loss=4.430248
Batch=19, step=200, lr=0.150250, batch loss=0.139330, epoch loss=4.112350
Epoch=9, step=200, lr=0.150250, epoch loss=4.112350
Batch=19, step=220, lr=0.145250, batch loss=0.118694, epoch loss=3.616201
Epoch=10, step=220, lr=0.145250, epoch loss=3.616201
Batch=19, step=240, lr=0.140250, batch loss=0.087419, epoch loss=2.948867
Epoch=11, step=240, lr=0.140250, epoch loss=2.948867
Batch=19, step=260, lr=0.135250, batch loss=0.054353, epoch loss=2.079585
Epoch=12, step=260, lr=0.135250, epoch loss=2.079585
Batch=19, step=280, lr=0.130250, batch loss=0.036618, epoch loss=1.943864
Epoch=13, step=280, lr=0.130250, epoch loss=1.943864
Batch=19, step=300, lr=0.125250, batch loss=0.025849, epoch loss=0.977757
Epoch=14, step=300, lr=0.125250, epoch loss=0.977757
Batch=19, step=320, lr=0.120250, batch loss=0.009790, epoch loss=0.637346
Epoch=15, step=320, lr=0.120250, epoch loss=0.637346
Batch=19, step=340, lr=0.115250, batch loss=0.006237, epoch loss=0.458649
Epoch=16, step=340, lr=0.115250, epoch loss=0.458649
Batch=19, step=360, lr=0.110250, batch loss=0.005388, epoch loss=0.362362
Epoch=17, step=360, lr=0.110250, epoch loss=0.362362
Batch=19, step=380, lr=0.105250, batch loss=0.004444, epoch loss=0.256659
Epoch=18, step=380, lr=0.105250, epoch loss=0.256659
Batch=19, step=400, lr=0.100250, batch loss=0.004354, epoch loss=0.211964
Epoch=19, step=400, lr=0.100250, epoch loss=0.211964

Half-moons scatterplot and decision boundary:
***************************************#********************************************************************************
***************************#*#*#########*###**######********************************************************************
***************************######*####*#*#####*########*#***************************************************************
*********************#**#########**#######*###############*###**********************************************************
******************####*####################################*###*********************************************************
***************#*#*###*###*###########*#*##*#####################*******************************************************
************#*######**#########*##*****************##*##*########*#*****************************************************
*************########*#*###*#**********************#******####*######***************************************************
**************#######*#*##******************************#########*##*##************************************************.
**********#######*###*#****************************************###**###*#******************************************.....
********#*######**##****************....**********************#*##*####*#***************************************........
********###*#*#**##*************............*******************###########*#*********************************...........
******########**************.........%....%.%...*******************##########*******************************..........%.
*******#######*************...........%..........*******************##*######*****************************.......%.%..%.
****##########************............%%%.%%%......*****************##########***************************......%..%%%%%.
*****######*#************............%%%.%...........**************#*#########*************************........%.%.%%..%
**######*#***************............%%%%%%%%.........*****************#*##*###**********************...........%%%%%%%.
**##*#####**************..............%%%%%%%...........**************#########*********************............%%.%%%..
**########*************..............%%%%%%%%.............**************##*######*****************..............%%%%%%%.
*########**************..............%%%.%%%.%%............**************#####*******************.............%%%%%%%%%.
*########*************................%%%%%%%%%..............************###*##*#**************................%%%%%%%..
##*######************.................%%%%%%%.%...............************######*#************................%%%%%%%%..
######*##************.................%%.%%%%%%.................**********########**********..................%%%%.%%.%.
###*##**#***********...................%.%%%%%%%%.................*********#####*#*********..................%%%%%%%%...
##*#####***********.....................%%%%%%.%.%.................*******#*#*####*******...................%%.%%%%%....
#####*##***********.....................%.%%%%%%%%...................*****##**##********..................%%%%%%%%%%%...
**#*##*#**********.......................%%%.%%%%%.%...................***#####*#*****.....................%%%%%%%......
##****##*********.........................%%.%%%%%%%%...................****###*##***...................%%%%%%%%%%......
*****************.........................%%.%%%%%%%......................*********.....................%..%%.%%%.......
****************............................%...%%%%%.%%....................******.................%.%%%%%%%%%%.........
***************...............................%.%%%%%.%%%%...................***...................%%%%%%%%.%.%%........
***************.................................%..%%%%%...%......................................%%%%%%%%%%............
**************....................................%%%.%%%%%%%%..............................%%..%%%%.%%%%%.%............
*************....................................%%%.%%%%%%.%%...%.........................%.%%%%%%%.%%%.%..............
*************........................................%.%%%.%%%%%%%%%...................%.%%%%%%%%%%%%%.%.%..............
************..........................................%.%%%%.%%%%%%%%%.%%%%%%%%%.%.%%%%%%%%%%%%%%%%%%%.%................
***********.............................................%%%%%%%%%%%%%%%%%%%%%.%%%%%%%.%%%.%%%%%%%%%%....................
***********.................................................%%%%%%%%%%%%%%%%%.%%%%%%%%%%%%%%%%%%%.......................
**********......................................................%%%%%%.%%%%%%%%%%%%%%%%%%%%%%%..........................
*********..........................................................%....%%%%%.%%..%%%%...%..............................|}
  in
  let new_typical_target_sync_cc =
    {|
Batch=19, step=20, lr=0.195250, batch loss=0.263683, epoch loss=45.768524
Epoch=0, step=20, lr=0.195250, epoch loss=45.768524
Batch=19, step=40, lr=0.190250, batch loss=0.220793, epoch loss=5.662821
Epoch=1, step=40, lr=0.190250, epoch loss=5.662821
Batch=19, step=60, lr=0.185250, batch loss=0.197911, epoch loss=5.259723
Epoch=2, step=60, lr=0.185250, epoch loss=5.259723
Batch=19, step=80, lr=0.180250, batch loss=0.191768, epoch loss=5.281074
Epoch=3, step=80, lr=0.180250, epoch loss=5.281074
Batch=19, step=100, lr=0.175250, batch loss=0.186862, epoch loss=5.097180
Epoch=4, step=100, lr=0.175250, epoch loss=5.097180
Batch=19, step=120, lr=0.170250, batch loss=0.181911, epoch loss=4.987223
Epoch=5, step=120, lr=0.170250, epoch loss=4.987223
Batch=19, step=140, lr=0.165250, batch loss=0.178275, epoch loss=4.835103
Epoch=6, step=140, lr=0.165250, epoch loss=4.835103
Batch=19, step=160, lr=0.160250, batch loss=0.165620, epoch loss=4.702625
Epoch=7, step=160, lr=0.160250, epoch loss=4.702625
Batch=19, step=180, lr=0.155250, batch loss=0.156137, epoch loss=4.458982
Epoch=8, step=180, lr=0.155250, epoch loss=4.458982
Batch=19, step=200, lr=0.150250, batch loss=0.139483, epoch loss=4.074086
Epoch=9, step=200, lr=0.150250, epoch loss=4.074086
Batch=19, step=220, lr=0.145250, batch loss=0.118495, epoch loss=3.605957
Epoch=10, step=220, lr=0.145250, epoch loss=3.605957
Batch=19, step=240, lr=0.140250, batch loss=0.091701, epoch loss=3.061533
Epoch=11, step=240, lr=0.140250, epoch loss=3.061533
Batch=19, step=260, lr=0.135250, batch loss=0.062137, epoch loss=2.342423
Epoch=12, step=260, lr=0.135250, epoch loss=2.342423
Batch=19, step=280, lr=0.130250, batch loss=0.030009, epoch loss=1.588885
Epoch=13, step=280, lr=0.130250, epoch loss=1.588885
Batch=19, step=300, lr=0.125250, batch loss=0.016336, epoch loss=0.904919
Epoch=14, step=300, lr=0.125250, epoch loss=0.904919
Batch=19, step=320, lr=0.120250, batch loss=0.009264, epoch loss=0.579104
Epoch=15, step=320, lr=0.120250, epoch loss=0.579104
Batch=19, step=340, lr=0.115250, batch loss=0.007289, epoch loss=0.451346
Epoch=16, step=340, lr=0.115250, epoch loss=0.451346
Batch=19, step=360, lr=0.110250, batch loss=0.005304, epoch loss=0.342835
Epoch=17, step=360, lr=0.110250, epoch loss=0.342835
Batch=19, step=380, lr=0.105250, batch loss=0.004483, epoch loss=0.259518
Epoch=18, step=380, lr=0.105250, epoch loss=0.259518
Batch=19, step=400, lr=0.100250, batch loss=0.004777, epoch loss=0.212706
Epoch=19, step=400, lr=0.100250, epoch loss=0.212706

Half-moons scatterplot and decision boundary:
***************************************#********************************************************************************
***************************#*#*#########*###**######********************************************************************
***************************######*####*#*#####*########*#***************************************************************
*********************#**#########**#######*###############*###**********************************************************
******************####*####################################*###*********************************************************
***************#*#*###*###*###########*#*##*#####################*******************************************************
************#*######**#########*##*****************##*##*########*#*****************************************************
*************########*#*###*#**********************#******####*######*************************************************..
**************#######*#*##******************************#########*##*##********************************************.....
**********#######*###*#****************************************###**###*#***************************************........
********#*######**##****************.....*********************#*##*####*#************************************...........
********###*#*#**##************..............******************###########*#*******************************.............
******########**************.........%....%.%...*******************##########*****************************............%.
*******#######*************...........%...........******************##*######***************************.........%.%..%.
****##########************............%%%.%%%......*****************##########*************************........%..%%%%%.
*****######*#************............%%%.%...........**************#*#########***********************..........%.%.%%..%
**######*#***************............%%%%%%%%..........****************#*##*###*********************............%%%%%%%.
**##*#####**************..............%%%%%%%...........**************#########*******************..............%%.%%%..
**########*************..............%%%%%%%%.............**************##*######****************...............%%%%%%%.
*########**************..............%%%.%%%.%%.............*************#####*****************...............%%%%%%%%%.
*########*************................%%%%%%%%%..............************###*##*#*************.................%%%%%%%..
##*######*************................%%%%%%%.%................***********######*#**********..................%%%%%%%%..
######*##************.................%%.%%%%%%..................*********########*********...................%%%%.%%.%.
###*##**#***********...................%.%%%%%%%%.................*********#####*#********...................%%%%%%%%...
##*#####************....................%%%%%%.%.%..................******#*#*####******....................%%.%%%%%....
#####*##***********.....................%.%%%%%%%%...................*****##**##*******...................%%%%%%%%%%%...
**#*##*#**********.......................%%%.%%%%%.%...................***#####*#****......................%%%%%%%......
##****##**********........................%%.%%%%%%%%....................***###*##**....................%%%%%%%%%%......
*****************.........................%%.%%%%%%%......................********......................%..%%.%%%.......
****************............................%...%%%%%.%%....................*****..................%.%%%%%%%%%%.........
****************..............................%.%%%%%.%%%%....................*....................%%%%%%%%.%.%%........
***************.................................%..%%%%%...%......................................%%%%%%%%%%............
**************....................................%%%.%%%%%%%%..............................%%..%%%%.%%%%%.%............
**************...................................%%%.%%%%%%.%%...%.........................%.%%%%%%%.%%%.%..............
*************........................................%.%%%.%%%%%%%%%...................%.%%%%%%%%%%%%%.%.%..............
************..........................................%.%%%%.%%%%%%%%%.%%%%%%%%%.%.%%%%%%%%%%%%%%%%%%%.%................
************............................................%%%%%%%%%%%%%%%%%%%%%.%%%%%%%.%%%.%%%%%%%%%%....................
***********.................................................%%%%%%%%%%%%%%%%%.%%%%%%%%%%%%%%%%%%%.......................
**********......................................................%%%%%%.%%%%%%%%%%%%%%%%%%%%%%%..........................
**********.........................................................%....%%%%%.%%..%%%%...%..............................|}
  in
  let arm64_and_s390x_target_sync_cc =
    {|
Batch=19, step=20, lr=0.195250, batch loss=0.263769, epoch loss=45.768606
Epoch=0, step=20, lr=0.195250, epoch loss=45.768606
Batch=19, step=40, lr=0.190250, batch loss=0.210844, epoch loss=5.625710
Epoch=1, step=40, lr=0.190250, epoch loss=5.625710
Batch=19, step=60, lr=0.185250, batch loss=0.199376, epoch loss=5.396801
Epoch=2, step=60, lr=0.185250, epoch loss=5.396801
Batch=19, step=80, lr=0.180250, batch loss=0.193945, epoch loss=5.220046
Epoch=3, step=80, lr=0.180250, epoch loss=5.220046
Batch=19, step=100, lr=0.175250, batch loss=0.189125, epoch loss=5.124979
Epoch=4, step=100, lr=0.175250, epoch loss=5.124979
Batch=19, step=120, lr=0.170250, batch loss=0.190998, epoch loss=5.006839
Epoch=5, step=120, lr=0.170250, epoch loss=5.006839
Batch=19, step=140, lr=0.165250, batch loss=0.179421, epoch loss=4.851728
Epoch=6, step=140, lr=0.165250, epoch loss=4.851728
Batch=19, step=160, lr=0.160250, batch loss=0.166938, epoch loss=4.694803
Epoch=7, step=160, lr=0.160250, epoch loss=4.694803
Batch=19, step=180, lr=0.155250, batch loss=0.155118, epoch loss=4.448225
Epoch=8, step=180, lr=0.155250, epoch loss=4.448225
Batch=19, step=200, lr=0.150250, batch loss=0.139187, epoch loss=4.068927
Epoch=9, step=200, lr=0.150250, epoch loss=4.068927
Batch=19, step=220, lr=0.145250, batch loss=0.120533, epoch loss=3.596531
Epoch=10, step=220, lr=0.145250, epoch loss=3.596531
Batch=19, step=240, lr=0.140250, batch loss=0.092738, epoch loss=3.095690
Epoch=11, step=240, lr=0.140250, epoch loss=3.095690
Batch=19, step=260, lr=0.135250, batch loss=0.063846, epoch loss=2.381923
Epoch=12, step=260, lr=0.135250, epoch loss=2.381923
Batch=19, step=280, lr=0.130250, batch loss=0.032194, epoch loss=1.615712
Epoch=13, step=280, lr=0.130250, epoch loss=1.615712
Batch=19, step=300, lr=0.125250, batch loss=0.018738, epoch loss=1.039877
Epoch=14, step=300, lr=0.125250, epoch loss=1.039877
Batch=19, step=320, lr=0.120250, batch loss=0.010287, epoch loss=0.635963
Epoch=15, step=320, lr=0.120250, epoch loss=0.635963
Batch=19, step=340, lr=0.115250, batch loss=0.006988, epoch loss=0.345229
Epoch=16, step=340, lr=0.115250, epoch loss=0.345229
Batch=19, step=360, lr=0.110250, batch loss=0.004683, epoch loss=0.345663
Epoch=17, step=360, lr=0.110250, epoch loss=0.345663
Batch=19, step=380, lr=0.105250, batch loss=0.004371, epoch loss=0.272611
Epoch=18, step=380, lr=0.105250, epoch loss=0.272611
Batch=19, step=400, lr=0.100250, batch loss=0.004675, epoch loss=0.214198
Epoch=19, step=400, lr=0.100250, epoch loss=0.214198

Half-moons scatterplot and decision boundary:
***************************************#********************************************************************************
***************************#*#*#########*###**######********************************************************************
***************************######*####*#*#####*########*#***************************************************************
*********************#**#########**#######*###############*###**********************************************************
******************####*####################################*###*********************************************************
***************#*#*###*###*###########*#*##*#####################*******************************************************
************#*######**#########*##*****************##*##*########*#*****************************************************
*************########*#*###*#**********************#******####*######*************************************************..
**************#######*#*##******************************#########*##*##********************************************.....
**********#######*###*#****************************************###**###*#***************************************........
********#*######**##******************..**********************#*##*####*#************************************...........
********###*#*#**##*************............*******************###########*#*******************************.............
******########***************........%....%.%...*******************##########****************************.............%.
*******#######*************...........%...........******************##*######***************************.........%.%..%.
****##########************............%%%.%%%......*****************##########************************.........%..%%%%%.
*****######*#*************...........%%%.%...........**************#*#########***********************..........%.%.%%..%
**######*#***************............%%%%%%%%..........****************#*##*###*********************............%%%%%%%.
**##*#####**************..............%%%%%%%...........**************#########*******************..............%%.%%%..
**########**************.............%%%%%%%%.............**************##*######****************...............%%%%%%%.
*########**************..............%%%.%%%.%%............**************#####*****************...............%%%%%%%%%.
*########*************................%%%%%%%%%..............************###*##*#*************.................%%%%%%%..
##*######*************................%%%%%%%.%................***********######*#**********..................%%%%%%%%..
######*##************.................%%.%%%%%%.................**********########*********...................%%%%.%%.%.
###*##**#***********...................%.%%%%%%%%.................*********#####*#********...................%%%%%%%%...
##*#####************....................%%%%%%.%.%..................******#*#*####******....................%%.%%%%%....
#####*##***********.....................%.%%%%%%%%...................*****##**##*******...................%%%%%%%%%%%...
**#*##*#**********.......................%%%.%%%%%.%...................***#####*#****......................%%%%%%%......
##****##**********........................%%.%%%%%%%%....................***###*##**....................%%%%%%%%%%......
*****************.........................%%.%%%%%%%......................********......................%..%%.%%%.......
****************............................%...%%%%%.%%....................*****..................%.%%%%%%%%%%.........
****************..............................%.%%%%%.%%%%....................*....................%%%%%%%%.%.%%........
***************.................................%..%%%%%...%......................................%%%%%%%%%%............
**************....................................%%%.%%%%%%%%..............................%%..%%%%.%%%%%.%............
**************...................................%%%.%%%%%%.%%...%.........................%.%%%%%%%.%%%.%..............
*************........................................%.%%%.%%%%%%%%%...................%.%%%%%%%%%%%%%.%.%..............
************..........................................%.%%%%.%%%%%%%%%.%%%%%%%%%.%.%%%%%%%%%%%%%%%%%%%.%................
************............................................%%%%%%%%%%%%%%%%%%%%%.%%%%%%%.%%%.%%%%%%%%%%....................
***********.................................................%%%%%%%%%%%%%%%%%.%%%%%%%%%%%%%%%%%%%.......................
**********......................................................%%%%%%.%%%%%%%%%%%%%%%%%%%%%%%..........................
*********..........................................................%....%%%%%.%%..%%%%...%..............................|}
  in
  let new_arm64_target_sync_cc =
    {|
Batch=19, step=20, lr=0.195250, batch loss=0.263683, epoch loss=45.768524
Epoch=0, step=20, lr=0.195250, epoch loss=45.768524
Batch=19, step=40, lr=0.190250, batch loss=0.220793, epoch loss=5.662821
Epoch=1, step=40, lr=0.190250, epoch loss=5.662821
Batch=19, step=60, lr=0.185250, batch loss=0.197911, epoch loss=5.259723
Epoch=2, step=60, lr=0.185250, epoch loss=5.259723
Batch=19, step=80, lr=0.180250, batch loss=0.191768, epoch loss=5.281074
Epoch=3, step=80, lr=0.180250, epoch loss=5.281074
Batch=19, step=100, lr=0.175250, batch loss=0.186862, epoch loss=5.097180
Epoch=4, step=100, lr=0.175250, epoch loss=5.097180
Batch=19, step=120, lr=0.170250, batch loss=0.181911, epoch loss=4.987223
Epoch=5, step=120, lr=0.170250, epoch loss=4.987223
Batch=19, step=140, lr=0.165250, batch loss=0.178275, epoch loss=4.835102
Epoch=6, step=140, lr=0.165250, epoch loss=4.835102
Batch=19, step=160, lr=0.160250, batch loss=0.165620, epoch loss=4.702624
Epoch=7, step=160, lr=0.160250, epoch loss=4.702624
Batch=19, step=180, lr=0.155250, batch loss=0.156137, epoch loss=4.458979
Epoch=8, step=180, lr=0.155250, epoch loss=4.458979
Batch=19, step=200, lr=0.150250, batch loss=0.139482, epoch loss=4.074081
Epoch=9, step=200, lr=0.150250, epoch loss=4.074081
Batch=19, step=220, lr=0.145250, batch loss=0.118496, epoch loss=3.605949
Epoch=10, step=220, lr=0.145250, epoch loss=3.605949
Batch=19, step=240, lr=0.140250, batch loss=0.091702, epoch loss=3.061521
Epoch=11, step=240, lr=0.140250, epoch loss=3.061521
Batch=19, step=260, lr=0.135250, batch loss=0.062139, epoch loss=2.342407
Epoch=12, step=260, lr=0.135250, epoch loss=2.342407
Batch=19, step=280, lr=0.130250, batch loss=0.030010, epoch loss=1.588868
Epoch=13, step=280, lr=0.130250, epoch loss=1.588868
Batch=19, step=300, lr=0.125250, batch loss=0.016337, epoch loss=0.904904
Epoch=14, step=300, lr=0.125250, epoch loss=0.904904
Batch=19, step=320, lr=0.120250, batch loss=0.009264, epoch loss=0.579091
Epoch=15, step=320, lr=0.120250, epoch loss=0.579091
Batch=19, step=340, lr=0.115250, batch loss=0.007289, epoch loss=0.451335
Epoch=16, step=340, lr=0.115250, epoch loss=0.451335
Batch=19, step=360, lr=0.110250, batch loss=0.005304, epoch loss=0.342827
Epoch=17, step=360, lr=0.110250, epoch loss=0.342827
Batch=19, step=380, lr=0.105250, batch loss=0.004483, epoch loss=0.259510
Epoch=18, step=380, lr=0.105250, epoch loss=0.259510
Batch=19, step=400, lr=0.100250, batch loss=0.004777, epoch loss=0.212701
Epoch=19, step=400, lr=0.100250, epoch loss=0.212701

Half-moons scatterplot and decision boundary:
***************************************#********************************************************************************
***************************#*#*#########*###**######********************************************************************
***************************######*####*#*#####*########*#***************************************************************
*********************#**#########**#######*###############*###**********************************************************
******************####*####################################*###*********************************************************
***************#*#*###*###*###########*#*##*#####################*******************************************************
************#*######**#########*##*****************##*##*########*#*****************************************************
*************########*#*###*#**********************#******####*######*************************************************..
**************#######*#*##******************************#########*##*##********************************************.....
**********#######*###*#****************************************###**###*#***************************************........
********#*######**##****************.....*********************#*##*####*#************************************...........
********###*#*#**##************..............******************###########*#*******************************.............
******########**************.........%....%.%...*******************##########*****************************............%.
*******#######*************...........%...........******************##*######***************************.........%.%..%.
****##########************............%%%.%%%......*****************##########*************************........%..%%%%%.
*****######*#************............%%%.%...........**************#*#########***********************..........%.%.%%..%
**######*#***************............%%%%%%%%..........****************#*##*###*********************............%%%%%%%.
**##*#####**************..............%%%%%%%...........**************#########*******************..............%%.%%%..
**########*************..............%%%%%%%%.............**************##*######****************...............%%%%%%%.
*########**************..............%%%.%%%.%%.............*************#####*****************...............%%%%%%%%%.
*########*************................%%%%%%%%%..............************###*##*#*************.................%%%%%%%..
##*######*************................%%%%%%%.%................***********######*#**********..................%%%%%%%%..
######*##************.................%%.%%%%%%..................*********########*********...................%%%%.%%.%.
###*##**#***********...................%.%%%%%%%%.................*********#####*#********...................%%%%%%%%...
##*#####************....................%%%%%%.%.%..................******#*#*####******....................%%.%%%%%....
#####*##***********.....................%.%%%%%%%%...................*****##**##*******...................%%%%%%%%%%%...
**#*##*#**********.......................%%%.%%%%%.%...................***#####*#****......................%%%%%%%......
##****##**********........................%%.%%%%%%%%....................***###*##**....................%%%%%%%%%%......
*****************.........................%%.%%%%%%%......................********......................%..%%.%%%.......
****************............................%...%%%%%.%%....................*****..................%.%%%%%%%%%%.........
****************..............................%.%%%%%.%%%%....................*....................%%%%%%%%.%.%%........
***************.................................%..%%%%%...%......................................%%%%%%%%%%............
**************....................................%%%.%%%%%%%%..............................%%..%%%%.%%%%%.%............
**************...................................%%%.%%%%%%.%%...%.........................%.%%%%%%%.%%%.%..............
*************........................................%.%%%.%%%%%%%%%...................%.%%%%%%%%%%%%%.%.%..............
************..........................................%.%%%%.%%%%%%%%%.%%%%%%%%%.%.%%%%%%%%%%%%%%%%%%%.%................
************............................................%%%%%%%%%%%%%%%%%%%%%.%%%%%%%.%%%.%%%%%%%%%%....................
***********.................................................%%%%%%%%%%%%%%%%%.%%%%%%%%%%%%%%%%%%%.......................
**********......................................................%%%%%%.%%%%%%%%%%%%%%%%%%%%%%%..........................
**********.........................................................%....%%%%%.%%..%%%%...%..............................|}
  in
  let ppc64_target_sync_cc =
    {|
Batch=19, step=20, lr=0.195250, batch loss=0.263769, epoch loss=45.768607
Epoch=0, step=20, lr=0.195250, epoch loss=45.768607
Batch=19, step=40, lr=0.190250, batch loss=0.210844, epoch loss=5.625710
Epoch=1, step=40, lr=0.190250, epoch loss=5.625710
Batch=19, step=60, lr=0.185250, batch loss=0.199376, epoch loss=5.396801
Epoch=2, step=60, lr=0.185250, epoch loss=5.396801
Batch=19, step=80, lr=0.180250, batch loss=0.193945, epoch loss=5.220046
Epoch=3, step=80, lr=0.180250, epoch loss=5.220046
Batch=19, step=100, lr=0.175250, batch loss=0.189125, epoch loss=5.124979
Epoch=4, step=100, lr=0.175250, epoch loss=5.124979
Batch=19, step=120, lr=0.170250, batch loss=0.190997, epoch loss=5.006840
Epoch=5, step=120, lr=0.170250, epoch loss=5.006840
Batch=19, step=140, lr=0.165250, batch loss=0.179420, epoch loss=4.851730
Epoch=6, step=140, lr=0.165250, epoch loss=4.851730
Batch=19, step=160, lr=0.160250, batch loss=0.166937, epoch loss=4.694807
Epoch=7, step=160, lr=0.160250, epoch loss=4.694807
Batch=19, step=180, lr=0.155250, batch loss=0.155119, epoch loss=4.448232
Epoch=8, step=180, lr=0.155250, epoch loss=4.448232
Batch=19, step=200, lr=0.150250, batch loss=0.139188, epoch loss=4.068939
Epoch=9, step=200, lr=0.150250, epoch loss=4.068939
Batch=19, step=220, lr=0.145250, batch loss=0.120531, epoch loss=3.596548
Epoch=10, step=220, lr=0.145250, epoch loss=3.596548
Batch=19, step=240, lr=0.140250, batch loss=0.092733, epoch loss=3.095092
Epoch=11, step=240, lr=0.140250, epoch loss=3.095092
Batch=19, step=260, lr=0.135250, batch loss=0.063844, epoch loss=2.381390
Epoch=12, step=260, lr=0.135250, epoch loss=2.381390
Batch=19, step=280, lr=0.130250, batch loss=0.032202, epoch loss=1.615177
Epoch=13, step=280, lr=0.130250, epoch loss=1.615177
Batch=19, step=300, lr=0.125250, batch loss=0.023749, epoch loss=1.002408
Epoch=14, step=300, lr=0.125250, epoch loss=1.002408
Batch=19, step=320, lr=0.120250, batch loss=0.010579, epoch loss=0.639300
Epoch=15, step=320, lr=0.120250, epoch loss=0.639300
Batch=19, step=340, lr=0.115250, batch loss=0.005478, epoch loss=0.413458
Epoch=16, step=340, lr=0.115250, epoch loss=0.413458
Batch=19, step=360, lr=0.110250, batch loss=0.004929, epoch loss=0.341771
Epoch=17, step=360, lr=0.110250, epoch loss=0.341771
Batch=19, step=380, lr=0.105250, batch loss=0.004629, epoch loss=0.249017
Epoch=18, step=380, lr=0.105250, epoch loss=0.249017
Batch=19, step=400, lr=0.100250, batch loss=0.004609, epoch loss=0.221509
Epoch=19, step=400, lr=0.100250, epoch loss=0.221509

Half-moons scatterplot and decision boundary:
***************************************#********************************************************************************
***************************#*#*#########*###**######********************************************************************
***************************######*####*#*#####*########*#***************************************************************
*********************#**#########**#######*###############*###**********************************************************
******************####*####################################*###*********************************************************
***************#*#*###*###*###########*#*##*#####################*******************************************************
************#*######**#########*##*****************##*##*########*#*****************************************************
*************########*#*###*#**********************#******####*######***************************************************
**************#######*#*##******************************#########*##*##**********************************************...
**********#######*###*#****************************************###**###*#*****************************************......
********#*######**##****************....**********************#*##*####*#*************************************..........
********###*#*#**##*************............*******************###########*#********************************............
******########***************........%....%.%...*******************##########*****************************............%.
*******#######*************...........%...........******************##*######****************************........%.%..%.
****##########************............%%%.%%%......*****************##########*************************........%..%%%%%.
*****######*#*************...........%%%.%...........**************#*#########************************.........%.%.%%..%
**######*#***************............%%%%%%%%..........****************#*##*###*********************............%%%%%%%.
**##*#####**************..............%%%%%%%...........**************#########********************.............%%.%%%..
**########**************.............%%%%%%%%.............**************##*######****************...............%%%%%%%.
*########**************..............%%%.%%%.%%.............*************#####******************..............%%%%%%%%%.
*########*************................%%%%%%%%%..............************###*##*#*************.................%%%%%%%..
##*######*************................%%%%%%%.%................***********######*#***********.................%%%%%%%%..
######*##************.................%%.%%%%%%.................**********########*********...................%%%%.%%.%.
###*##**#***********...................%.%%%%%%%%.................*********#####*#********...................%%%%%%%%...
##*#####************....................%%%%%%.%.%..................******#*#*####******....................%%.%%%%%....
#####*##***********.....................%.%%%%%%%%...................*****##**##*******...................%%%%%%%%%%%...
**#*##*#**********.......................%%%.%%%%%.%...................***#####*#****......................%%%%%%%......
##****##**********........................%%.%%%%%%%%....................***###*##**....................%%%%%%%%%%......
*****************.........................%%.%%%%%%%......................********......................%..%%.%%%.......
****************............................%...%%%%%.%%....................*****..................%.%%%%%%%%%%.........
****************..............................%.%%%%%.%%%%....................*....................%%%%%%%%.%.%%........
***************.................................%..%%%%%...%......................................%%%%%%%%%%............
**************....................................%%%.%%%%%%%%..............................%%..%%%%.%%%%%.%............
**************...................................%%%.%%%%%%.%%...%.........................%.%%%%%%%.%%%.%..............
*************........................................%.%%%.%%%%%%%%%...................%.%%%%%%%%%%%%%.%.%..............
************..........................................%.%%%%.%%%%%%%%%.%%%%%%%%%.%.%%%%%%%%%%%%%%%%%%%.%................
************............................................%%%%%%%%%%%%%%%%%%%%%.%%%%%%%.%%%.%%%%%%%%%%....................
***********.................................................%%%%%%%%%%%%%%%%%.%%%%%%%%%%%%%%%%%%%.......................
**********......................................................%%%%%%.%%%%%%%%%%%%%%%%%%%%%%%..........................
**********.........................................................%....%%%%%.%%..%%%%...%..............................|}
  in
  let new_typical_target_cc =
    {|
Batch=59, step=60, lr=0.199250, batch loss=3.584908, epoch loss=35.992126
Batch=119, step=120, lr=0.198250, batch loss=0.508806, epoch loss=39.762860
Batch=179, step=180, lr=0.197250, batch loss=1.143455, epoch loss=42.709079
Batch=239, step=240, lr=0.196250, batch loss=0.233751, epoch loss=44.287360
Batch=299, step=300, lr=0.195250, batch loss=0.264367, epoch loss=45.444531
Epoch=0, step=300, lr=0.195250, epoch loss=45.444531
Batch=59, step=360, lr=0.194250, batch loss=0.357212, epoch loss=1.086070
Batch=119, step=420, lr=0.193250, batch loss=0.280062, epoch loss=2.236337
Batch=179, step=480, lr=0.192250, batch loss=0.359549, epoch loss=3.410923
Batch=239, step=540, lr=0.191250, batch loss=0.218992, epoch loss=4.657392
Batch=299, step=600, lr=0.190250, batch loss=0.211925, epoch loss=5.639823
Epoch=1, step=600, lr=0.190250, epoch loss=5.639823
Batch=59, step=660, lr=0.189250, batch loss=0.335044, epoch loss=1.016661
Batch=119, step=720, lr=0.188250, batch loss=0.265320, epoch loss=2.101982
Batch=179, step=780, lr=0.187250, batch loss=0.345294, epoch loss=3.235675
Batch=239, step=840, lr=0.186250, batch loss=0.212680, epoch loss=4.438331
Batch=299, step=900, lr=0.185250, batch loss=0.203080, epoch loss=5.346784
Epoch=2, step=900, lr=0.185250, epoch loss=5.346784
Batch=59, step=960, lr=0.184250, batch loss=0.318383, epoch loss=0.971478
Batch=119, step=1020, lr=0.183250, batch loss=0.252484, epoch loss=1.990582
Batch=179, step=1080, lr=0.182250, batch loss=0.332303, epoch loss=3.084707
Batch=239, step=1140, lr=0.181250, batch loss=0.236703, epoch loss=4.270380
Batch=299, step=1200, lr=0.180250, batch loss=0.192542, epoch loss=5.220604
Epoch=3, step=1200, lr=0.180250, epoch loss=5.220604
Batch=59, step=1260, lr=0.179250, batch loss=0.311022, epoch loss=0.920874
Batch=119, step=1320, lr=0.178250, batch loss=0.254555, epoch loss=1.951498
Batch=179, step=1380, lr=0.177250, batch loss=0.322302, epoch loss=3.019574
Batch=239, step=1440, lr=0.176250, batch loss=0.211926, epoch loss=4.159011
Batch=299, step=1500, lr=0.175250, batch loss=0.191340, epoch loss=5.094362
Epoch=4, step=1500, lr=0.175250, epoch loss=5.094362
Batch=59, step=1560, lr=0.174250, batch loss=0.300162, epoch loss=0.925442
Batch=119, step=1620, lr=0.173250, batch loss=0.234122, epoch loss=1.884817
Batch=179, step=1680, lr=0.172250, batch loss=0.314382, epoch loss=2.933512
Batch=239, step=1740, lr=0.171250, batch loss=0.206372, epoch loss=4.049262
Batch=299, step=1800, lr=0.170250, batch loss=0.189386, epoch loss=4.968022
Epoch=5, step=1800, lr=0.170250, epoch loss=4.968022
Batch=59, step=1860, lr=0.169250, batch loss=0.293783, epoch loss=0.907181
Batch=119, step=1920, lr=0.168250, batch loss=0.233358, epoch loss=1.862263
Batch=179, step=1980, lr=0.167250, batch loss=0.307281, epoch loss=2.885774
Batch=239, step=2040, lr=0.166250, batch loss=0.198570, epoch loss=3.975470
Batch=299, step=2100, lr=0.165250, batch loss=0.186456, epoch loss=4.885281
Epoch=6, step=2100, lr=0.165250, epoch loss=4.885281
Batch=59, step=2160, lr=0.164250, batch loss=0.285026, epoch loss=0.881035
Batch=119, step=2220, lr=0.163250, batch loss=0.233946, epoch loss=1.825867
Batch=179, step=2280, lr=0.162250, batch loss=0.304087, epoch loss=2.827248
Batch=239, step=2340, lr=0.161250, batch loss=0.197686, epoch loss=3.892371
Batch=299, step=2400, lr=0.160250, batch loss=0.175436, epoch loss=4.774447
Epoch=7, step=2400, lr=0.160250, epoch loss=4.774447
Batch=59, step=2460, lr=0.159250, batch loss=0.277176, epoch loss=0.839226
Batch=119, step=2520, lr=0.158250, batch loss=0.219097, epoch loss=1.742900
Batch=179, step=2580, lr=0.157250, batch loss=0.296120, epoch loss=2.717792
Batch=239, step=2640, lr=0.156250, batch loss=0.186325, epoch loss=3.737960
Batch=299, step=2700, lr=0.155250, batch loss=0.173464, epoch loss=4.533937
Epoch=8, step=2700, lr=0.155250, epoch loss=4.533937
Batch=59, step=2760, lr=0.154250, batch loss=0.258948, epoch loss=0.809692
Batch=119, step=2820, lr=0.153250, batch loss=0.211562, epoch loss=1.658516
Batch=179, step=2880, lr=0.152250, batch loss=0.279560, epoch loss=2.586335
Batch=239, step=2940, lr=0.151250, batch loss=0.186238, epoch loss=3.574098
Batch=299, step=3000, lr=0.150250, batch loss=0.160910, epoch loss=4.366731
Epoch=9, step=3000, lr=0.150250, epoch loss=4.366731
Batch=59, step=3060, lr=0.149250, batch loss=0.242446, epoch loss=0.758009
Batch=119, step=3120, lr=0.148250, batch loss=0.207589, epoch loss=1.586454
Batch=179, step=3180, lr=0.147250, batch loss=0.261913, epoch loss=2.460192
Batch=239, step=3240, lr=0.146250, batch loss=0.179334, epoch loss=3.396323
Batch=299, step=3300, lr=0.145250, batch loss=0.149323, epoch loss=4.109129
Epoch=10, step=3300, lr=0.145250, epoch loss=4.109129
Batch=59, step=3360, lr=0.144250, batch loss=0.222070, epoch loss=0.698342
Batch=119, step=3420, lr=0.143250, batch loss=0.187309, epoch loss=1.441868
Batch=179, step=3480, lr=0.142250, batch loss=0.242789, epoch loss=2.226570
Batch=239, step=3540, lr=0.141250, batch loss=0.163388, epoch loss=3.064501
Batch=299, step=3600, lr=0.140250, batch loss=0.135239, epoch loss=3.759928
Epoch=11, step=3600, lr=0.140250, epoch loss=3.759928
Batch=59, step=3660, lr=0.139250, batch loss=0.197498, epoch loss=0.631151
Batch=119, step=3720, lr=0.138250, batch loss=0.149163, epoch loss=1.269227
Batch=179, step=3780, lr=0.137250, batch loss=0.187890, epoch loss=1.911570
Batch=239, step=3840, lr=0.136250, batch loss=0.157161, epoch loss=2.630481
Batch=299, step=3900, lr=0.135250, batch loss=0.111108, epoch loss=3.309291
Epoch=12, step=3900, lr=0.135250, epoch loss=3.309291
Batch=59, step=3960, lr=0.134250, batch loss=0.157552, epoch loss=0.515831
Batch=119, step=4020, lr=0.133250, batch loss=0.126440, epoch loss=0.991936
Batch=179, step=4080, lr=0.132250, batch loss=0.150557, epoch loss=1.510895
Batch=239, step=4140, lr=0.131250, batch loss=0.072994, epoch loss=2.135794
Batch=299, step=4200, lr=0.130250, batch loss=0.077608, epoch loss=2.550157
Epoch=13, step=4200, lr=0.130250, epoch loss=2.550157
Batch=59, step=4260, lr=0.129250, batch loss=0.119654, epoch loss=0.464356
Batch=119, step=4320, lr=0.128250, batch loss=0.111217, epoch loss=0.828470
Batch=179, step=4380, lr=0.127250, batch loss=0.105463, epoch loss=1.169195
Batch=239, step=4440, lr=0.126250, batch loss=0.046586, epoch loss=1.499768
Batch=299, step=4500, lr=0.125250, batch loss=0.048648, epoch loss=1.813541
Epoch=14, step=4500, lr=0.125250, epoch loss=1.813541
Batch=59, step=4560, lr=0.124250, batch loss=0.076112, epoch loss=0.285040
Batch=119, step=4620, lr=0.123250, batch loss=0.042774, epoch loss=0.499583
Batch=179, step=4680, lr=0.122250, batch loss=0.090994, epoch loss=0.756041
Batch=239, step=4740, lr=0.121250, batch loss=0.023378, epoch loss=1.019069
Batch=299, step=4800, lr=0.120250, batch loss=0.031148, epoch loss=1.253701
Epoch=15, step=4800, lr=0.120250, epoch loss=1.253701
Batch=59, step=4860, lr=0.119250, batch loss=0.052486, epoch loss=0.148289
Batch=119, step=4920, lr=0.118250, batch loss=0.018166, epoch loss=0.286293
Batch=179, step=4980, lr=0.117250, batch loss=0.043061, epoch loss=0.434003
Batch=239, step=5040, lr=0.116250, batch loss=0.016334, epoch loss=0.663831
Batch=299, step=5100, lr=0.115250, batch loss=0.020574, epoch loss=0.799833
Epoch=16, step=5100, lr=0.115250, epoch loss=0.799833
Batch=59, step=5160, lr=0.114250, batch loss=0.028596, epoch loss=0.082687
Batch=119, step=5220, lr=0.113250, batch loss=0.010091, epoch loss=0.146780
Batch=179, step=5280, lr=0.112250, batch loss=0.040288, epoch loss=0.260536
Batch=239, step=5340, lr=0.111250, batch loss=0.014054, epoch loss=0.431177
Batch=299, step=5400, lr=0.110250, batch loss=0.008746, epoch loss=0.492590
Epoch=17, step=5400, lr=0.110250, epoch loss=0.492590
Batch=59, step=5460, lr=0.109250, batch loss=0.018616, epoch loss=0.066092
Batch=119, step=5520, lr=0.108250, batch loss=0.007184, epoch loss=0.114477
Batch=179, step=5580, lr=0.107250, batch loss=0.046729, epoch loss=0.231879
Batch=239, step=5640, lr=0.106250, batch loss=0.011923, epoch loss=0.367700
Batch=299, step=5700, lr=0.105250, batch loss=0.006371, epoch loss=0.406609
Epoch=18, step=5700, lr=0.105250, epoch loss=0.406609
Batch=59, step=5760, lr=0.104250, batch loss=0.016859, epoch loss=0.047542
Batch=119, step=5820, lr=0.103250, batch loss=0.004291, epoch loss=0.082976
Batch=179, step=5880, lr=0.102250, batch loss=0.026261, epoch loss=0.162595
Batch=239, step=5940, lr=0.101250, batch loss=0.010116, epoch loss=0.257129
Batch=299, step=6000, lr=0.100250, batch loss=0.005555, epoch loss=0.288202
Epoch=19, step=6000, lr=0.100250, epoch loss=0.288202

Half-moons scatterplot and decision boundary:
***************************************#********************************************************************************
***************************#*#*#########*###**######********************************************************************
***************************######*####*#*#####*########*#***************************************************************
*********************#**#########**#######*###############*###**********************************************************
******************####*####################################*###*********************************************************
***************#*#*###*###*###########*#*##*#####################*******************************************************
************#*######**#########*##*****************##*##*########*#*****************************************************
*************########*#*###*#**********************#******####*######***************************************************
**************#######*#*##******************************#########*##*##**********************************************...
**********#######*###*#****************************************###**###*#*****************************************......
********#*######**##******************************************#*##*####*#*************************************..........
********###*#*#**##**************...........*******************###########*#*******************************.............
******########***************........%....%.%...*******************##########****************************.............%.
*******#######*************...........%...........******************##*######***************************.........%.%..%.
****##########************............%%%.%%%.......****************##########************************.........%..%%%%%.
*****######*#*************...........%%%.%............*************#*#########***********************..........%.%.%%..%
**######*#***************............%%%%%%%%..........****************#*##*###*********************............%%%%%%%.
**##*#####**************..............%%%%%%%............*************#########*******************..............%%.%%%..
**########*************..............%%%%%%%%..............*************##*######****************...............%%%%%%%.
*########**************..............%%%.%%%.%%.............*************#####******************..............%%%%%%%%%.
*########*************................%%%%%%%%%...............***********###*##*#*************.................%%%%%%%..
##*######************.................%%%%%%%.%.................**********######*#***********.................%%%%%%%%..
######*##************.................%%.%%%%%%..................*********########*********...................%%%%.%%.%.
###*##**#***********...................%.%%%%%%%%..................********#####*#*******....................%%%%%%%%...
##*#####***********.....................%%%%%%.%.%...................*****#*#*####******....................%%.%%%%%....
#####*##**********......................%.%%%%%%%%....................****##**##******....................%%%%%%%%%%%...
**#*##*#**********.......................%%%.%%%%%.%....................**#####*#****......................%%%%%%%......
##****##*********.........................%%.%%%%%%%%.....................**###*##*.....................%%%%%%%%%%......
****************..........................%%.%%%%%%%.......................*******......................%..%%.%%%.......
***************.............................%...%%%%%.%%.....................***...................%.%%%%%%%%%%.........
***************...............................%.%%%%%.%%%%.........................................%%%%%%%%.%.%%........
**************..................................%..%%%%%...%......................................%%%%%%%%%%............
*************.....................................%%%.%%%%%%%%..............................%%..%%%%.%%%%%.%............
*************....................................%%%.%%%%%%.%%...%.........................%.%%%%%%%.%%%.%..............
************.........................................%.%%%.%%%%%%%%%...................%.%%%%%%%%%%%%%.%.%..............
***********...........................................%.%%%%.%%%%%%%%%.%%%%%%%%%.%.%%%%%%%%%%%%%%%%%%%.%................
**********..............................................%%%%%%%%%%%%%%%%%%%%%.%%%%%%%.%%%.%%%%%%%%%%....................
**********..................................................%%%%%%%%%%%%%%%%%.%%%%%%%%%%%%%%%%%%%.......................
*********.......................................................%%%%%%.%%%%%%%%%%%%%%%%%%%%%%%..........................
********...........................................................%....%%%%%.%%..%%%%...%..............................|}
  in
  let result_deltas =
    List.map
      [
        new_typical_target_sync_cc;
        new_arm64_target_sync_cc;
        typical_target_sync_cc;
        arm64_and_s390x_target_sync_cc;
        ppc64_target_sync_cc;
        new_typical_target_cc;
      ] ~f:(fun target -> Expect_test_patdiff.patdiff target result)
  in
  (if List.exists ~f:String.is_empty result_deltas then
     Stdio.print_string "moons_demo_parallel result is as expected"
   else
     let delta =
       Option.value_exn
       @@ List.min_elt result_deltas ~compare:(fun x y ->
              Int.compare (String.length x) (String.length y))
     in
     Stdio.print_endline "Unexpected result. Difference with the nearest expected result:";
     Stdio.print_string delta);
  [%expect "moons_demo_parallel result is as expected"]
