open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module Rand = Arrayjit.Rand.Lib

module type Backend = Arrayjit.Backend_intf.Backend

let%expect_test "Hello World" =
  Tensor.unsafe_reinitialize ();
  Stdio.printf "Hello World!\n";
  [%expect {| Hello World! |}]

let%expect_test "Pointwise multiplication dims 1" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* "Hey" is inferred to be a scalar. *)
  let%op y = 2 *. "hey" 7.0 in
  Train.forward_and_forget backend ctx y;

  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌────────────────────┐
    │[3]: *._y shape 0:1 │
    │┌┬────────┐         │
    │││axis 0  │         │
    │├┼────────┤         │
    │││ 1.4e+1 │         │
    │└┴────────┘         │
    └────────────────────┘
    |}]

let%expect_test "Matrix multiplication dims 1x1" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* Hey is inferred to be a matrix because of matrix multiplication [*]. *)
  let%op y = ("hey" 7.0 * 'q' 2.0) + 'p' 1.0 in
  Train.forward_and_forget backend ctx y;
  (* Punning for ["hey"] above introduced the [hey] identifier. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌────────────────────────┐
    │[0]: hey shape 1:1->0:1 │
    │┌──────┬──────┐         │
    ││      │axis 1│         │
    │├──────┼──────┤         │
    ││axis 0│ 7.0  │         │
    │└──────┴──────┘         │
    └────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌───────────────────┐
    │[6]: +_y shape 0:1 │
    │┌┬────────┐        │
    │││axis 0  │        │
    │├┼────────┤        │
    │││ 1.5e+1 │        │
    │└┴────────┘        │
    └───────────────────┘
    |}]

let%expect_test "Print constant tensor" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;

  let%op hey = [ (1, 2, 3); (4, 5, 6) ] in
  Train.forward_and_forget backend ctx hey;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hey;
  [%expect {| [1.0, 2.0, 3.0; 4.0, 5.0, 6.0] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: [1.0, 2.0, 3.0; 4.0, 5.0, 6.0]_hey shape 1:3->0:2 │
    │┌──────┬───────────────┐                               │
    ││      │axis 1         │                               │
    │├──────┼───────────────┤                               │
    ││axis 0│ 1.0  2.0  3.0 │                               │
    ││      │ 4.0  5.0  6.0 │                               │
    │└──────┴───────────────┘                               │
    └───────────────────────────────────────────────────────┘
    |}];
  let%op hoo = [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |] in
  Train.forward_and_forget backend ctx hoo;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hoo;
  [%expect {| [|[1.0; 2.0; 3.0]; [4.0; 5.0; 6.0]|] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hoo;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────┐
    │[1]: [|[1.0; 2.0; 3.0]; [4.0; 5.0; 6.0]|]_hoo shape 0:2|1:3 │
    │┌──────┬───────────────┐                                    │
    ││      │axis 1         │                                    │
    │├──────┼───────────────┤                                    │
    ││axis 0│ 1.0  2.0  3.0 │                                    │
    ││      │ 4.0  5.0  6.0 │                                    │
    │└──────┴───────────────┘                                    │
    └────────────────────────────────────────────────────────────┘
    |}];
  let%op hey2 =
    [
      ((1, 2, 3), (4, 5, 6));
      ((7, 8, 9), (10, 11, 12));
      ((13, 14, 15), (16, 17, 18));
      ((19, 20, 21), (22, 23, 24));
    ]
  in
  Train.forward_and_forget backend ctx hey2;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hey2;
  [%expect
    {|
    [(1.0, 2.0, 3.0), (4.0, 5.0, 6.0); (7.0, 8.0, 9.0), (10.0, 11.0, 12.0);
      (13.0, 14.0, 15.0), (16.0, 17.0, 18.0);
      (19.0, 20.0, 21.0), (22.0, 23.0, 24.0)]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[2]: c4x2x3_hey2 shape 1:2,2:3->0:4                       │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 1                   │1 @ 1                   ││
    ││      │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 0│ 1.0     2.0     3.0    │ 4.0     5.0     6.0    ││
    ││      │ 7.0     8.0     9.0    │ 1.0e+1  1.1e+1  1.2e+1 ││
    ││      │ 1.3e+1  1.4e+1  1.5e+1 │ 1.6e+1  1.7e+1  1.8e+1 ││
    ││      │ 1.9e+1  2.0e+1  2.1e+1 │ 2.2e+1  2.3e+1  2.4e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  let%op hoo2 =
    [|
      [ [ 1; 2; 3 ]; [ 4; 5; 6 ] ];
      [ [ 7; 8; 9 ]; [ 10; 11; 12 ] ];
      [ [ 13; 14; 15 ]; [ 16; 17; 18 ] ];
      [ [ 19; 20; 21 ]; [ 22; 23; 24 ] ];
    |]
  in
  Train.forward_and_forget backend ctx hoo2;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hoo2;
  [%expect
    {|
    [|[[1.0; 2.0; 3.0]; [4.0; 5.0; 6.0]]; [[7.0; 8.0; 9.0]; [10.0; 11.0; 12.0]];
      [[13.0; 14.0; 15.0]; [16.0; 17.0; 18.0]];
      [[19.0; 20.0; 21.0]; [22.0; 23.0; 24.0]]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hoo2;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: c4x2x3_hoo2 shape 0:4|1:2,2:3                                                                 │
    │┌──────┬───────────────┬────────────────────────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0          │1 @ 0                   │2 @ 0                   │3 @ 0                   ││
    ││      │axis 2         │axis 2                  │axis 2                  │axis 2                  ││
    │├──────┼───────────────┼────────────────────────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 1.0  2.0  3.0 │ 7.0     8.0     9.0    │ 1.3e+1  1.4e+1  1.5e+1 │ 1.9e+1  2.0e+1  2.1e+1 ││
    ││      │ 4.0  5.0  6.0 │ 1.0e+1  1.1e+1  1.2e+1 │ 1.6e+1  1.7e+1  1.8e+1 │ 2.2e+1  2.3e+1  2.4e+1 ││
    │└──────┴───────────────┴────────────────────────┴────────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo =
    [|
      [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |];
      [| [ 7; 8; 9 ]; [ 10; 11; 12 ] |];
      [| [ 13; 14; 15 ]; [ 16; 17; 18 ] |];
      [| [ 19; 20; 21 ]; [ 22; 23; 24 ] |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo;
  [%expect
    {|
    [|[|[1.0; 2.0; 3.0]; [4.0; 5.0; 6.0]|];
      [|[7.0; 8.0; 9.0]; [10.0; 11.0; 12.0]|];
      [|[13.0; 14.0; 15.0]; [16.0; 17.0; 18.0]|];
      [|[19.0; 20.0; 21.0]; [22.0; 23.0; 24.0]|]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: c4x2x3_heyhoo shape 0:4,1:2|2:3                                                               │
    │┌──────┬───────────────┬────────────────────────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0          │1 @ 0                   │2 @ 0                   │3 @ 0                   ││
    ││      │axis 2         │axis 2                  │axis 2                  │axis 2                  ││
    │├──────┼───────────────┼────────────────────────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 1.0  2.0  3.0 │ 7.0     8.0     9.0    │ 1.3e+1  1.4e+1  1.5e+1 │ 1.9e+1  2.0e+1  2.1e+1 ││
    ││      │ 4.0  5.0  6.0 │ 1.0e+1  1.1e+1  1.2e+1 │ 1.6e+1  1.7e+1  1.8e+1 │ 2.2e+1  2.3e+1  2.4e+1 ││
    │└──────┴───────────────┴────────────────────────┴────────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo2 =
    [|
      [| [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] |];
      [| [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] |];
      [| [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] |];
      [| [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo2;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo2;
  [%expect
    {|
    [|
      [|[[1.0; 31.0]; [2.0; 32.0]; [3.0; 33.0]];
        [[4.0; 34.0]; [5.0; 35.0]; [6.0; 36.0]]|];
      [|[[7.0; 37.0]; [8.0; 38.0]; [9.0; 39.0]];
        [[10.0; 40.0]; [11.0; 41.0]; [12.0; 42.0]]|];
      [|[[13.0; 43.0]; [14.0; 44.0]; [15.0; 45.0]];
        [[16.0; 46.0]; [17.0; 47.0]; [18.0; 48.0]]|];
      [|[[19.0; 49.0]; [20.0; 50.0]; [21.0; 51.0]];
        [[22.0; 52.0]; [23.0; 53.0]; [24.0; 54.0]]|]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo2;
  [%expect
    {|
    ┌────────────────────────────────────────────┐
    │[5]: c4x2x3x2_heyhoo2 shape 0:4,1:2|2:3,3:2 │
    │┌──────┬────────────────┬────────────────┐  │
    ││      │0 @ 1           │1 @ 1           │  │
    ││      │axis 3          │axis 3          │  │
    │├──────┼────────────────┼────────────────┤  │
    ││0 @ 0 │ 1.0  3.1e+1    │ 4.0  3.4e+1    │  │
    ││axis 2│ 2.0  3.2e+1    │ 5.0  3.5e+1    │  │
    ││      │ 3.0  3.3e+1    │ 6.0  3.6e+1    │  │
    │├──────┼────────────────┼────────────────┤  │
    ││1 @ 0 │ 7.0  3.7e+1    │ 1.0e+1  4.0e+1 │  │
    ││axis 2│ 8.0  3.8e+1    │ 1.1e+1  4.1e+1 │  │
    ││      │ 9.0  3.9e+1    │ 1.2e+1  4.2e+1 │  │
    │├──────┼────────────────┼────────────────┤  │
    ││2 @ 0 │ 1.3e+1  4.3e+1 │ 1.6e+1  4.6e+1 │  │
    ││axis 2│ 1.4e+1  4.4e+1 │ 1.7e+1  4.7e+1 │  │
    ││      │ 1.5e+1  4.5e+1 │ 1.8e+1  4.8e+1 │  │
    │├──────┼────────────────┼────────────────┤  │
    ││3 @ 0 │ 1.9e+1  4.9e+1 │ 2.2e+1  5.2e+1 │  │
    ││axis 2│ 2.0e+1  5.0e+1 │ 2.3e+1  5.3e+1 │  │
    ││      │ 2.1e+1  5.1e+1 │ 2.4e+1  5.4e+1 │  │
    │└──────┴────────────────┴────────────────┘  │
    └────────────────────────────────────────────┘
    |}];
  let%op heyhoo3 =
    [|
      [|
        [ [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] ];
        [ [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] ];
      |];
      [|
        [ [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] ];
        [ [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] ];
      |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo3;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo3;
  [%expect
    {|
    [|
      [|
        [[[1.0; 31.0]; [2.0; 32.0]; [3.0; 33.0]];
          [[4.0; 34.0]; [5.0; 35.0]; [6.0; 36.0]]];
        [[[7.0; 37.0]; [8.0; 38.0]; [9.0; 39.0]];
          [[10.0; 40.0]; [11.0; 41.0]; [12.0; 42.0]]]|];
      [|
        [[[13.0; 43.0]; [14.0; 44.0]; [15.0; 45.0]];
          [[16.0; 46.0]; [17.0; 47.0]; [18.0; 48.0]]];
        [[[19.0; 49.0]; [20.0; 50.0]; [21.0; 51.0]];
          [[22.0; 52.0]; [23.0; 53.0]; [24.0; 54.0]]]|]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo3;
  [%expect
    {|
    ┌──────────────────────────────────────────────────┐
    │[6]: c2x2x2x3x2_heyhoo3 shape 0:2,1:2|2:2,3:3,4:2 │
    │┌──────┬─────────────┬────────────────┐           │
    ││0 @ 0 │0 @ 2        │1 @ 2           │           │
    ││      │axis 4       │axis 4          │           │
    │├──────┼─────────────┼────────────────┤           │
    ││0 @ 1 │ 1.0  3.1e+1 │ 4.0  3.4e+1    │           │
    ││axis 3│ 2.0  3.2e+1 │ 5.0  3.5e+1    │           │
    ││      │ 3.0  3.3e+1 │ 6.0  3.6e+1    │           │
    │├──────┼─────────────┼────────────────┤           │
    ││1 @ 1 │ 7.0  3.7e+1 │ 1.0e+1  4.0e+1 │           │
    ││axis 3│ 8.0  3.8e+1 │ 1.1e+1  4.1e+1 │           │
    ││      │ 9.0  3.9e+1 │ 1.2e+1  4.2e+1 │           │
    │└──────┴─────────────┴────────────────┘           │
    ├──────────────────────────────────────────────────┤
    │┌──────┬────────────────┬────────────────┐        │
    ││1 @ 0 │0 @ 2           │1 @ 2           │        │
    ││      │axis 4          │axis 4          │        │
    │├──────┼────────────────┼────────────────┤        │
    ││0 @ 1 │ 1.3e+1  4.3e+1 │ 1.6e+1  4.6e+1 │        │
    ││axis 3│ 1.4e+1  4.4e+1 │ 1.7e+1  4.7e+1 │        │
    ││      │ 1.5e+1  4.5e+1 │ 1.8e+1  4.8e+1 │        │
    │├──────┼────────────────┼────────────────┤        │
    ││1 @ 1 │ 1.9e+1  4.9e+1 │ 2.2e+1  5.2e+1 │        │
    ││axis 3│ 2.0e+1  5.0e+1 │ 2.3e+1  5.3e+1 │        │
    ││      │ 2.1e+1  5.1e+1 │ 2.4e+1  5.4e+1 │        │
    │└──────┴────────────────┴────────────────┘        │
    └──────────────────────────────────────────────────┘
    |}];
  let%op heyhoo4 =
    [|
      [
        [ [ (1, 31); (2, 32); (3, 33) ]; [ (4, 34); (5, 35); (6, 36) ] ];
        [ [ (7, 37); (8, 38); (9, 39) ]; [ (10, 40); (11, 41); (12, 42) ] ];
      ];
      [
        [ [ (13, 43); (14, 44); (15, 45) ]; [ (16, 46); (17, 47); (18, 48) ] ];
        [ [ (19, 49); (20, 50); (21, 51) ]; [ (22, 52); (23, 53); (24, 54) ] ];
      ];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo4;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo4;
  [%expect
    {|
    [|
      [[[1.0, 31.0; 2.0, 32.0; 3.0, 33.0]; [4.0, 34.0; 5.0, 35.0; 6.0, 36.0]];
        [[7.0, 37.0; 8.0, 38.0; 9.0, 39.0]; [10.0, 40.0; 11.0, 41.0; 12.0, 42.0]]
        ];
      [
        [[13.0, 43.0; 14.0, 44.0; 15.0, 45.0];
          [16.0, 46.0; 17.0, 47.0; 18.0, 48.0]];
        [[19.0, 49.0; 20.0, 50.0; 21.0, 51.0];
          [22.0, 52.0; 23.0, 53.0; 24.0, 54.0]]]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo4;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[7]: c2x2x2x3x2_heyhoo4 shape 0:2|4:2->1:2,2:2,3:3 │
    │┌──────┬─────────────┬────────────────┐            │
    ││0 @ 0 │0 @ 2        │1 @ 2           │            │
    ││      │axis 4       │axis 4          │            │
    │├──────┼─────────────┼────────────────┤            │
    ││0 @ 1 │ 1.0  3.1e+1 │ 4.0  3.4e+1    │            │
    ││axis 3│ 2.0  3.2e+1 │ 5.0  3.5e+1    │            │
    ││      │ 3.0  3.3e+1 │ 6.0  3.6e+1    │            │
    │├──────┼─────────────┼────────────────┤            │
    ││1 @ 1 │ 7.0  3.7e+1 │ 1.0e+1  4.0e+1 │            │
    ││axis 3│ 8.0  3.8e+1 │ 1.1e+1  4.1e+1 │            │
    ││      │ 9.0  3.9e+1 │ 1.2e+1  4.2e+1 │            │
    │└──────┴─────────────┴────────────────┘            │
    ├───────────────────────────────────────────────────┤
    │┌──────┬────────────────┬────────────────┐         │
    ││1 @ 0 │0 @ 2           │1 @ 2           │         │
    ││      │axis 4          │axis 4          │         │
    │├──────┼────────────────┼────────────────┤         │
    ││0 @ 1 │ 1.3e+1  4.3e+1 │ 1.6e+1  4.6e+1 │         │
    ││axis 3│ 1.4e+1  4.4e+1 │ 1.7e+1  4.7e+1 │         │
    ││      │ 1.5e+1  4.5e+1 │ 1.8e+1  4.8e+1 │         │
    │├──────┼────────────────┼────────────────┤         │
    ││1 @ 1 │ 1.9e+1  4.9e+1 │ 2.2e+1  5.2e+1 │         │
    ││axis 3│ 2.0e+1  5.0e+1 │ 2.3e+1  5.3e+1 │         │
    ││      │ 2.1e+1  5.1e+1 │ 2.4e+1  5.4e+1 │         │
    │└──────┴────────────────┴────────────────┘         │
    └───────────────────────────────────────────────────┘
    |}]

let%expect_test "Matrix multiplication dims 2x3" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* Hey is inferred to be a matrix. *)
  let%op y = ("hey" 7.0 * [ 2; 3 ]) + [ 4; 5; 6 ] in
  Train.forward_and_forget backend ctx y;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌────────────────────────┐
    │[0]: hey shape 1:2->0:3 │
    │┌──────┬──────────┐     │
    ││      │axis 1    │     │
    │├──────┼──────────┤     │
    ││axis 0│ 7.0  7.0 │     │
    ││      │ 7.0  7.0 │     │
    ││      │ 7.0  7.0 │     │
    │└──────┴──────────┘     │
    └────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌───────────────────────────┐
    │[6]: +_y shape 0:3         │
    │┌┬────────────────────────┐│
    │││axis 0                  ││
    │├┼────────────────────────┤│
    │││ 3.9e+1  4.0e+1  4.1e+1 ││
    │└┴────────────────────────┘│
    └───────────────────────────┘
    |}]

let%expect_test "Big matrix" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* Hey is inferred to be a matrix. *)
  let hey = Tensor.param ~values:[| 0.5 |] "hey" in
  let zero_to_twenty = TDSL.range 20 in
  let y = TDSL.O.((hey * zero_to_twenty) + zero_to_twenty) in
  Train.forward_and_forget backend ctx y;
  Tensor.print ~with_code:false ~with_grad:false `Inline zero_to_twenty;
  [%expect
    {|
    [0.0; 1.0; 2.0; 3.0; 4.0; 5.0; 6.0; 7.0; 8.0; 9.0; 10.0; 11.0; 12.0; 13.0;
      14.0; 15.0; 16.0; 17.0; 18.0; 19.0; 20.0]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default zero_to_twenty;
  [%expect
    {|
    ┌──────────────────────────────────┐
    │[2]: 0...20 shape 0:21            │
    │┌┬───────────────────────────────┐│
    │││axis 0                         ││
    │├┼───────────────────────────────┤│
    │││ 0.0  1.0  ...  1.9e+1  2.0e+1 ││
    │└┴───────────────────────────────┘│
    └──────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default hey;
  [%expect
    {|
    ┌──────────────────────────────────────────────┐
    │[0]: hey shape 1:21->0:21                     │
    │┌──────┬─────────────────────────────────────┐│
    ││      │axis 1                               ││
    │├──────┼─────────────────────────────────────┤│
    ││axis 0│ 5.0e-1  5.0e-1  ...  5.0e-1  5.0e-1 ││
    ││      │ 5.0e-1  5.0e-1  ...  5.0e-1  5.0e-1 ││
    ││      │ ...     ...     ...  ...     ...    ││
    ││      │ 5.0e-1  5.0e-1  ...  5.0e-1  5.0e-1 ││
    ││      │ 5.0e-1  5.0e-1  ...  5.0e-1  5.0e-1 ││
    │└──────┴─────────────────────────────────────┘│
    └──────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default y;
  [%expect
    {|
    ┌────────────────────────────────────────┐
    │[5]: + shape 0:21                       │
    │┌┬─────────────────────────────────────┐│
    │││axis 0                               ││
    │├┼─────────────────────────────────────┤│
    │││ 1.1e+2  1.1e+2  ...  1.2e+2  1.3e+2 ││
    │└┴─────────────────────────────────────┘│
    └────────────────────────────────────────┘
    |}]

let%expect_test "Very big tensor" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey =
    TDSL.range_of_shape ~batch_dims:[ 6 ] ~input_dims:[ 7; 8; 9 ] ~output_dims:[ 10; 11 ] ()
  in
  let%op hoo = (hey * (1 + 1)) - 10 in
  Train.forward_and_forget backend ctx hoo;
  Tensor.print ~with_code:false ~with_grad:false `Default hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r6x10x11x7x8x9 shape 0:6|3:7,4:8,5:9->1:10,2:11                                                                                                                   │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││0 @ 0 │0 @ 4                                │1 @ 4                                │~~~~~ │6 @ 4                                │7 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5│axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 1 │ 0.0     1.0     ...  7.0     8.0    │ 9.0     1.0e+1  ...  1.6e+1  1.7e+1 │ ...  │ 5.4e+1  5.5e+1  ...  6.1e+1  6.2e+1 │ 6.3e+1  6.4e+1  ...  7.0e+1  7.1e+1 ││
    ││axis 2│ 5.0e+2  5.1e+2  ...  5.1e+2  5.1e+2 │ 5.1e+2  5.1e+2  ...  5.2e+2  5.2e+2 │      │ 5.6e+2  5.6e+2  ...  5.7e+2  5.7e+2 │ 5.7e+2  5.7e+2  ...  5.7e+2  5.8e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 4.5e+3  4.5e+3  ...  4.5e+3  4.5e+3 │ 4.5e+3  4.5e+3  ...  4.6e+3  4.6e+3 │      │ 4.6e+3  4.6e+3  ...  4.6e+3  4.6e+3 │ 4.6e+3  4.6e+3  ...  4.6e+3  4.6e+3 ││
    ││      │ 5.0e+3  5.0e+3  ...  5.0e+3  5.0e+3 │ 5.0e+3  5.1e+3  ...  5.1e+3  5.1e+3 │      │ 5.1e+3  5.1e+3  ...  5.1e+3  5.1e+3 │ 5.1e+3  5.1e+3  ...  5.1e+3  5.1e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 1 │ 5.5e+3  5.5e+3  ...  5.6e+3  5.6e+3 │ 5.6e+3  5.6e+3  ...  5.6e+3  5.6e+3 │ ...  │ 5.6e+3  5.6e+3  ...  5.6e+3  5.6e+3 │ 5.6e+3  5.6e+3  ...  5.6e+3  5.6e+3 ││
    ││axis 2│ 6.0e+3  6.0e+3  ...  6.1e+3  6.1e+3 │ 6.1e+3  6.1e+3  ...  6.1e+3  6.1e+3 │      │ 6.1e+3  6.1e+3  ...  6.1e+3  6.1e+3 │ 6.1e+3  6.1e+3  ...  6.1e+3  6.1e+3 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.0e+4  1.0e+4  ...  1.0e+4  1.0e+4 │ 1.0e+4  1.0e+4  ...  1.0e+4  1.0e+4 │      │ 1.0e+4  1.0e+4  ...  1.0e+4  1.0e+4 │ 1.0e+4  1.0e+4  ...  1.0e+4  1.0e+4 ││
    ││      │ 1.1e+4  1.1e+4  ...  1.1e+4  1.1e+4 │ 1.1e+4  1.1e+4  ...  1.1e+4  1.1e+4 │      │ 1.1e+4  1.1e+4  ...  1.1e+4  1.1e+4 │ 1.1e+4  1.1e+4  ...  1.1e+4  1.1e+4 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...  │ ...                                 │ ...                                 ││
    ││axis 2│                                     │                                     │      │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││8 @ 1 │ 4.4e+4  4.4e+4  ...  4.4e+4  4.4e+4 │ 4.4e+4  4.4e+4  ...  4.4e+4  4.4e+4 │ ...  │ 4.4e+4  4.4e+4  ...  4.4e+4  4.4e+4 │ 4.4e+4  4.4e+4  ...  4.4e+4  4.4e+4 ││
    ││axis 2│ 4.5e+4  4.5e+4  ...  4.5e+4  4.5e+4 │ 4.5e+4  4.5e+4  ...  4.5e+4  4.5e+4 │      │ 4.5e+4  4.5e+4  ...  4.5e+4  4.5e+4 │ 4.5e+4  4.5e+4  ...  4.5e+4  4.5e+4 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 │      │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 ││
    ││      │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 │      │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 │ 4.9e+4  4.9e+4  ...  4.9e+4  4.9e+4 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││9 @ 1 │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 │ ...  │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 ││
    ││axis 2│ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 │      │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 │ 5.0e+4  5.0e+4  ...  5.0e+4  5.0e+4 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 5.4e+4  5.4e+4  ...  5.4e+4  5.4e+4 │ 5.4e+4  5.4e+4  ...  5.4e+4  5.4e+4 │      │ 5.4e+4  5.4e+4  ...  5.4e+4  5.4e+4 │ 5.4e+4  5.4e+4  ...  5.5e+4  5.5e+4 ││
    ││      │ 5.5e+4  5.5e+4  ...  5.5e+4  5.5e+4 │ 5.5e+4  5.5e+4  ...  5.5e+4  5.5e+4 │      │ 5.5e+4  5.5e+4  ...  5.5e+4  5.5e+4 │ 5.5e+4  5.5e+4  ...  5.5e+4  5.5e+4 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││1 @ 0 │0 @ 4                                │1 @ 4                                │~~~~~ │6 @ 4                                │7 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5│axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 1 │ 5.5e+4  5.5e+4  ...  5.5e+4  5.5e+4 │ 5.5e+4  5.5e+4  ...  5.5e+4  5.5e+4 │ ...  │ 5.5e+4  5.5e+4  ...  5.6e+4  5.6e+4 │ 5.6e+4  5.6e+4  ...  5.6e+4  5.6e+4 ││
    ││axis 2│ 5.6e+4  5.6e+4  ...  5.6e+4  5.6e+4 │ 5.6e+4  5.6e+4  ...  5.6e+4  5.6e+4 │      │ 5.6e+4  5.6e+4  ...  5.6e+4  5.6e+4 │ 5.6e+4  5.6e+4  ...  5.6e+4  5.6e+4 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 6.0e+4  6.0e+4  ...  6.0e+4  6.0e+4 │ 6.0e+4  6.0e+4  ...  6.0e+4  6.0e+4 │      │ 6.0e+4  6.0e+4  ...  6.0e+4  6.0e+4 │ 6.0e+4  6.0e+4  ...  6.0e+4  6.0e+4 ││
    ││      │ 6.0e+4  6.0e+4  ...  6.0e+4  6.0e+4 │ 6.0e+4  6.0e+4  ...  6.0e+4  6.0e+4 │      │ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 │ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 1 │ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 │ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 │ ...  │ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 │ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 ││
    ││axis 2│ 6.1e+4  6.1e+4  ...  6.1e+4  6.1e+4 │ 6.1e+4  6.1e+4  ...  6.2e+4  6.2e+4 │      │ 6.2e+4  6.2e+4  ...  6.2e+4  6.2e+4 │ 6.2e+4  6.2e+4  ...  6.2e+4  6.2e+4 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 │      │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 ││
    ││      │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 │      │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 │ 6.6e+4  6.6e+4  ...  6.6e+4  6.6e+4 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...  │ ...                                 │ ...                                 ││
    ││axis 2│                                     │                                     │      │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││8 @ 1 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ ...  │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 ││
    ││axis 2│ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │      │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │      │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 ││
    ││      │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │      │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 │ 1.0e+5  1.0e+5  ...  1.0e+5  1.0e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││9 @ 1 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ ...  │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 ││
    ││axis 2│ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │      │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │      │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 ││
    ││      │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │      │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 │ 1.1e+5  1.1e+5  ...  1.1e+5  1.1e+5 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                                                                                                   │
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││4 @ 0 │0 @ 4                                │1 @ 4                                │~~~~~ │6 @ 4                                │7 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5│axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 1 │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 │ ...  │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 ││
    ││axis 2│ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 │      │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 │ 2.2e+5  2.2e+5  ...  2.2e+5  2.2e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 ││
    ││      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 1 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ ...  │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 ││
    ││axis 2│ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 ││
    ││      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │      │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 │ 2.3e+5  2.3e+5  ...  2.3e+5  2.3e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...  │ ...                                 │ ...                                 ││
    ││axis 2│                                     │                                     │      │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││8 @ 1 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ ...  │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 ││
    ││axis 2│ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │      │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │      │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 ││
    ││      │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │      │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││9 @ 1 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ ...  │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 ││
    ││axis 2│ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │      │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 │ 2.7e+5  2.7e+5  ...  2.7e+5  2.7e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    ││      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││5 @ 0 │0 @ 4                                │1 @ 4                                │~~~~~ │6 @ 4                                │7 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5│axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 1 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ ...  │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    ││axis 2│ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    ││      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 1 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ ...  │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    ││axis 2│ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │      │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 │ 2.8e+5  2.8e+5  ...  2.8e+5  2.8e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 │      │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 ││
    ││      │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 │      │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 │ 2.9e+5  2.9e+5  ...  2.9e+5  2.9e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...  │ ...                                 │ ...                                 ││
    ││axis 2│                                     │                                     │      │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││8 @ 1 │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 │ ...  │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 ││
    ││axis 2│ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 │      │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 │ 3.2e+5  3.2e+5  ...  3.2e+5  3.2e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 ││
    ││      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││9 @ 1 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ ...  │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 ││
    ││axis 2│ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 ││
    ││      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │      │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 │ 3.3e+5  3.3e+5  ...  3.3e+5  3.3e+5 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default hoo;
  (* Disable line wrapping for viewing the output. In VSCode: `View: Toggle Word Wrap`. *)
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: -_hoo shape 0:6|1:10,2:11                                                                                                                                         │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││      │0 @ 0                                │1 @ 0                                │~~~~~ │4 @ 0                                │5 @ 0                                ││
    ││      │axis 2                               │axis 2                               │axis 2│axis 2                               │axis 2                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││axis 1│ 2.5e+5  7.6e+5  ...  4.8e+6  5.3e+6 │ 5.6e+7  5.7e+7  ...  6.1e+7  6.1e+7 │ ...  │ 2.2e+8  2.2e+8  ...  2.3e+8  2.3e+8 │ 2.8e+8  2.8e+8  ...  2.8e+8  2.8e+8 ││
    ││      │ 5.8e+6  6.3e+6  ...  1.0e+7  1.1e+7 │ 6.2e+7  6.2e+7  ...  6.6e+7  6.7e+7 │      │ 2.3e+8  2.3e+8  ...  2.3e+8  2.3e+8 │ 2.9e+8  2.9e+8  ...  2.9e+8  2.9e+8 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 4.5e+7  4.5e+7  ...  5.0e+7  5.0e+7 │ 1.0e+8  1.0e+8  ...  1.1e+8  1.1e+8 │      │ 2.7e+8  2.7e+8  ...  2.7e+8  2.7e+8 │ 3.2e+8  3.2e+8  ...  3.3e+8  3.3e+8 ││
    ││      │ 5.1e+7  5.1e+7  ...  5.5e+7  5.6e+7 │ 1.1e+8  1.1e+8  ...  1.1e+8  1.1e+8 │      │ 2.7e+8  2.7e+8  ...  2.8e+8  2.8e+8 │ 3.3e+8  3.3e+8  ...  3.3e+8  3.4e+8 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
