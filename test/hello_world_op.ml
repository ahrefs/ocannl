open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module Rand = Arrayjit.Rand.Lib

let%expect_test "Hello World" =
  Stdio.printf "Hello World!\n";
  [%expect {| Hello World! |}]

let%expect_test "Pointwise multiplication dims 1" =
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend = (module Backend : Train.Backend_type with type context = Backend.context) in
  let device = Backend.(new_virtual_device @@ get_device ~ordinal:0) in
  let ctx = Backend.init device in
  Rand.init 0;
  (* "Hey" is inferred to be a scalar. *)
  let%op y = 2 *. "hey" in
  Train.forward_and_forget backend ctx y;

  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌────────────────────┐
    │[3]: *._y shape 0:1 │
    │┌┬─────────┐        │
    │││axis 0   │        │
    │├┼─────────┼─────── │
    │││ 7.38e-2 │        │
    │└┴─────────┘        │
    └────────────────────┘ |}]

let%expect_test "Matrix multiplication dims 1x1" =
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend = (module Backend : Train.Backend_type with type context = Backend.context) in
  let device = Backend.(new_virtual_device @@ get_device ~ordinal:0) in
  let ctx = Backend.init device in
  Rand.init 0;
  (* Hey is inferred to be a matrix because of matrix multiplication [*]. *)
  let%op y = ("hey" * 'q' 2.0) + 'p' 1.0 in
  Train.forward_and_forget backend ctx y;
  (* Punning for ["hey"] above introduced the [hey] identifier. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌────────────────────────┐
    │[5]: hey shape 1:1->0:1 │
    │┌──────┬─────────┐      │
    ││      │axis 1   │      │
    │├──────┼─────────┼───── │
    ││axis 0│ 3.69e-2 │      │
    │└──────┴─────────┘      │
    └────────────────────────┘ |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌────────────────────┐
    │[11]: +_y shape 0:1 │
    │┌┬─────────┐        │
    │││axis 0   │        │
    │├┼─────────┼─────── │
    │││ 1.07e+0 │        │
    │└┴─────────┘        │
    └────────────────────┘ |}]

let%expect_test "Print constant tensor" =
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend = (module Backend : Train.Backend_type with type context = Backend.context) in
  let device = Backend.(new_virtual_device @@ get_device ~ordinal:0) in
  let ctx = Backend.init device in
  Rand.init 0;

  let%op hey = [ (1, 2, 3); (4, 5, 6) ] in
  Train.forward_and_forget backend ctx hey;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ hey;
  [%expect {| [1.00, 2.00, 3.00; 4.00, 5.00, 6.00] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────┐
    │[13]: [1.00, 2.00, 3.00; 4.00, 5.00, 6.00]_hey shape 1:3->0:2 │
    │┌──────┬───────────────────────────┐                          │
    ││      │axis 1                     │                          │
    │├──────┼───────────────────────────┼───────────────────────── │
    ││axis 0│ 1.00e+0  2.00e+0  3.00e+0 │                          │
    ││      │ 4.00e+0  5.00e+0  6.00e+0 │                          │
    │└──────┴───────────────────────────┘                          │
    └──────────────────────────────────────────────────────────────┘ |}];
  let%op hoo = [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |] in
  Train.forward_and_forget backend ctx hoo;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ hoo;
  [%expect {| [|[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]|] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hoo;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────┐
    │[14]: [|[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]|]_hoo shape 0:2|1:3 │
    │┌──────┬───────────────────────────┐                               │
    ││      │axis 1                     │                               │
    │├──────┼───────────────────────────┼────────────────────────────── │
    ││axis 0│ 1.00e+0  2.00e+0  3.00e+0 │                               │
    ││      │ 4.00e+0  5.00e+0  6.00e+0 │                               │
    │└──────┴───────────────────────────┘                               │
    └───────────────────────────────────────────────────────────────────┘ |}];
  let%op hey2 =
    [
      ((1, 2, 3), (4, 5, 6));
      ((7, 8, 9), (10, 11, 12));
      ((13, 14, 15), (16, 17, 18));
      ((19, 20, 21), (22, 23, 24));
    ]
  in
  Train.forward_and_forget backend ctx hey2;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ hey2;
  [%expect
    {|
    [(1.00, 2.00, 3.00), (4.00, 5.00, 6.00);
      (7.00, 8.00, 9.00), (10.00, 11.00, 12.00);
      (13.00, 14.00, 15.00), (16.00, 17.00, 18.00);
      (19.00, 20.00, 21.00), (22.00, 23.00, 24.00)] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────┐
    │[15]: c4x2x3_hey2 shape 1:2,2:3->0:4                            │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 1                      │1 @ 1                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 0│ 1.00e+0  2.00e+0  3.00e+0 │ 4.00e+0  5.00e+0  6.00e+0 ││
    ││      │ 7.00e+0  8.00e+0  9.00e+0 │ 1.00e+1  1.10e+1  1.20e+1 ││
    ││      │ 1.30e+1  1.40e+1  1.50e+1 │ 1.60e+1  1.70e+1  1.80e+1 ││
    ││      │ 1.90e+1  2.00e+1  2.10e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘ |}];
  let%op hoo2 =
    [|
      [ [ 1; 2; 3 ]; [ 4; 5; 6 ] ];
      [ [ 7; 8; 9 ]; [ 10; 11; 12 ] ];
      [ [ 13; 14; 15 ]; [ 16; 17; 18 ] ];
      [ [ 19; 20; 21 ]; [ 22; 23; 24 ] ];
    |]
  in
  Train.forward_and_forget backend ctx hoo2;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ hoo2;
  [%expect
    {|
    [|[[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]];
      [[7.00; 8.00; 9.00]; [10.00; 11.00; 12.00]];
      [[13.00; 14.00; 15.00]; [16.00; 17.00; 18.00]];
      [[19.00; 20.00; 21.00]; [22.00; 23.00; 24.00]]|] |}];
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Default @@ hoo2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[16]: c4x2x3_hoo2 shape 0:4|1:2,2:3                                                                                     │
    │┌──────┬───────────────────────────┬───────────────────────────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      │2 @ 0                      │3 @ 0                      ││
    ││      │axis 2                     │axis 2                     │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 1.00e+0  2.00e+0  3.00e+0 │ 7.00e+0  8.00e+0  9.00e+0 │ 1.30e+1  1.40e+1  1.50e+1 │ 1.90e+1  2.00e+1  2.10e+1 ││
    ││      │ 4.00e+0  5.00e+0  6.00e+0 │ 1.00e+1  1.10e+1  1.20e+1 │ 1.60e+1  1.70e+1  1.80e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
  let%op heyhoo =
    [|
      [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |];
      [| [ 7; 8; 9 ]; [ 10; 11; 12 ] |];
      [| [ 13; 14; 15 ]; [ 16; 17; 18 ] |];
      [| [ 19; 20; 21 ]; [ 22; 23; 24 ] |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ heyhoo;
  [%expect
    {|
    [|[|[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]|];
      [|[7.00; 8.00; 9.00]; [10.00; 11.00; 12.00]|];
      [|[13.00; 14.00; 15.00]; [16.00; 17.00; 18.00]|];
      [|[19.00; 20.00; 21.00]; [22.00; 23.00; 24.00]|]|] |}];
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Default @@ heyhoo;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[17]: c4x2x3_heyhoo shape 0:4,1:2|2:3                                                                                   │
    │┌──────┬───────────────────────────┬───────────────────────────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      │2 @ 0                      │3 @ 0                      ││
    ││      │axis 2                     │axis 2                     │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 1.00e+0  2.00e+0  3.00e+0 │ 7.00e+0  8.00e+0  9.00e+0 │ 1.30e+1  1.40e+1  1.50e+1 │ 1.90e+1  2.00e+1  2.10e+1 ││
    ││      │ 4.00e+0  5.00e+0  6.00e+0 │ 1.00e+1  1.10e+1  1.20e+1 │ 1.60e+1  1.70e+1  1.80e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
  let%op heyhoo2 =
    [|
      [| [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] |];
      [| [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] |];
      [| [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] |];
      [| [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo2;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ heyhoo2;
  [%expect
    {|
    [|
      [|[[1.00; 31.00]; [2.00; 32.00]; [3.00; 33.00]];
        [[4.00; 34.00]; [5.00; 35.00]; [6.00; 36.00]]|];
      [|[[7.00; 37.00]; [8.00; 38.00]; [9.00; 39.00]];
        [[10.00; 40.00]; [11.00; 41.00]; [12.00; 42.00]]|];
      [|[[13.00; 43.00]; [14.00; 44.00]; [15.00; 45.00]];
        [[16.00; 46.00]; [17.00; 47.00]; [18.00; 48.00]]|];
      [|[[19.00; 49.00]; [20.00; 50.00]; [21.00; 51.00]];
        [[22.00; 52.00]; [23.00; 53.00]; [24.00; 54.00]]|]|] |}];
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Default @@ heyhoo2;
  [%expect
    {|
    ┌──────────────────────────────────────────────┐
    │[18]: c4x2x3x2_heyhoo2 shape 0:4,1:2|2:3,3:2  │
    │┌──────┬──────────────────┬──────────────────┐│
    ││      │0 @ 1             │1 @ 1             ││
    ││      │axis 3            │axis 3            ││
    │├──────┼──────────────────┼──────────────────┤│
    ││0 @ 0 │ 1.00e+0  3.10e+1 │ 4.00e+0  3.40e+1 ││
    ││axis 2│ 2.00e+0  3.20e+1 │ 5.00e+0  3.50e+1 ││
    ││      │ 3.00e+0  3.30e+1 │ 6.00e+0  3.60e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││1 @ 0 │ 7.00e+0  3.70e+1 │ 1.00e+1  4.00e+1 ││
    ││axis 2│ 8.00e+0  3.80e+1 │ 1.10e+1  4.10e+1 ││
    ││      │ 9.00e+0  3.90e+1 │ 1.20e+1  4.20e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││2 @ 0 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 ││
    ││axis 2│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 ││
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││3 @ 0 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 ││
    ││axis 2│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 ││
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 ││
    │└──────┴──────────────────┴──────────────────┘│
    └──────────────────────────────────────────────┘ |}];
  let%op heyhoo3 =
    [|
      [|
        [ [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] ];
        [ [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] ];
      |];
      [|
        [ [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] ];
        [ [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] ];
      |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo3;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ heyhoo3;
  [%expect
    {|
    [|
      [|
        [[[1.00; 31.00]; [2.00; 32.00]; [3.00; 33.00]];
          [[4.00; 34.00]; [5.00; 35.00]; [6.00; 36.00]]];
        [[[7.00; 37.00]; [8.00; 38.00]; [9.00; 39.00]];
          [[10.00; 40.00]; [11.00; 41.00]; [12.00; 42.00]]]|];
      [|
        [[[13.00; 43.00]; [14.00; 44.00]; [15.00; 45.00]];
          [[16.00; 46.00]; [17.00; 47.00]; [18.00; 48.00]]];
        [[[19.00; 49.00]; [20.00; 50.00]; [21.00; 51.00]];
          [[22.00; 52.00]; [23.00; 53.00]; [24.00; 54.00]]]|]|] |}];
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Default @@ heyhoo3;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[19]: c2x2x2x3x2_heyhoo3 shape 0:2,1:2|2:2,3:3,4:2 │
    │┌──────┬──────────────────┬──────────────────┐     │
    ││0 @ 0 │0 @ 2             │1 @ 2             │     │
    ││      │axis 4            │axis 4            │     │
    │├──────┼──────────────────┼──────────────────┼──── │
    ││0 @ 1 │ 1.00e+0  3.10e+1 │ 4.00e+0  3.40e+1 │     │
    ││axis 3│ 2.00e+0  3.20e+1 │ 5.00e+0  3.50e+1 │     │
    ││      │ 3.00e+0  3.30e+1 │ 6.00e+0  3.60e+1 │     │
    │├──────┼──────────────────┼──────────────────┼──── │
    ││1 @ 1 │ 7.00e+0  3.70e+1 │ 1.00e+1  4.00e+1 │     │
    ││axis 3│ 8.00e+0  3.80e+1 │ 1.10e+1  4.10e+1 │     │
    ││      │ 9.00e+0  3.90e+1 │ 1.20e+1  4.20e+1 │     │
    │└──────┴──────────────────┴──────────────────┘     │
    ├───────────────────────────────────────────────────┤
    │┌──────┬──────────────────┬──────────────────┐     │
    ││1 @ 0 │0 @ 2             │1 @ 2             │     │
    ││      │axis 4            │axis 4            │     │
    │├──────┼──────────────────┼──────────────────┼──── │
    ││0 @ 1 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 │     │
    ││axis 3│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 │     │
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 │     │
    │├──────┼──────────────────┼──────────────────┼──── │
    ││1 @ 1 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 │     │
    ││axis 3│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 │     │
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 │     │
    │└──────┴──────────────────┴──────────────────┘     │
    └───────────────────────────────────────────────────┘ |}];
  let%op heyhoo4 =
    [|
      [
        [ [ (1, 31); (2, 32); (3, 33) ]; [ (4, 34); (5, 35); (6, 36) ] ];
        [ [ (7, 37); (8, 38); (9, 39) ]; [ (10, 40); (11, 41); (12, 42) ] ];
      ];
      [
        [ [ (13, 43); (14, 44); (15, 45) ]; [ (16, 46); (17, 47); (18, 48) ] ];
        [ [ (19, 49); (20, 50); (21, 51) ]; [ (22, 52); (23, 53); (24, 54) ] ];
      ];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo4;
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Inline @@ heyhoo4;
  [%expect
    {|
    [|
      [
        [[1.00, 31.00; 2.00, 32.00; 3.00, 33.00];
          [4.00, 34.00; 5.00, 35.00; 6.00, 36.00]];
        [[7.00, 37.00; 8.00, 38.00; 9.00, 39.00];
          [10.00, 40.00; 11.00, 41.00; 12.00, 42.00]]];
      [
        [[13.00, 43.00; 14.00, 44.00; 15.00, 45.00];
          [16.00, 46.00; 17.00, 47.00; 18.00, 48.00]];
        [[19.00, 49.00; 20.00, 50.00; 21.00, 51.00];
          [22.00, 52.00; 23.00, 53.00; 24.00, 54.00]]]|] |}];
  Tensor.print ~force:true ~with_code:false ~with_grad:false `Default @@ heyhoo4;
  [%expect
    {|
    ┌────────────────────────────────────────────────────┐
    │[20]: c2x2x2x3x2_heyhoo4 shape 0:2|4:2->1:2,2:2,3:3 │
    │┌──────┬──────────────────┬──────────────────┐      │
    ││0 @ 0 │0 @ 2             │1 @ 2             │      │
    ││      │axis 4            │axis 4            │      │
    │├──────┼──────────────────┼──────────────────┼───── │
    ││0 @ 1 │ 1.00e+0  3.10e+1 │ 4.00e+0  3.40e+1 │      │
    ││axis 3│ 2.00e+0  3.20e+1 │ 5.00e+0  3.50e+1 │      │
    ││      │ 3.00e+0  3.30e+1 │ 6.00e+0  3.60e+1 │      │
    │├──────┼──────────────────┼──────────────────┼───── │
    ││1 @ 1 │ 7.00e+0  3.70e+1 │ 1.00e+1  4.00e+1 │      │
    ││axis 3│ 8.00e+0  3.80e+1 │ 1.10e+1  4.10e+1 │      │
    ││      │ 9.00e+0  3.90e+1 │ 1.20e+1  4.20e+1 │      │
    │└──────┴──────────────────┴──────────────────┘      │
    ├────────────────────────────────────────────────────┤
    │┌──────┬──────────────────┬──────────────────┐      │
    ││1 @ 0 │0 @ 2             │1 @ 2             │      │
    ││      │axis 4            │axis 4            │      │
    │├──────┼──────────────────┼──────────────────┼───── │
    ││0 @ 1 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 │      │
    ││axis 3│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 │      │
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 │      │
    │├──────┼──────────────────┼──────────────────┼───── │
    ││1 @ 1 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 │      │
    ││axis 3│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 │      │
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 │      │
    │└──────┴──────────────────┴──────────────────┘      │
    └────────────────────────────────────────────────────┘ |}]

let%expect_test "Matrix multiplication dims 2x3" =
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend = (module Backend : Train.Backend_type with type context = Backend.context) in
  let device = Backend.(new_virtual_device @@ get_device ~ordinal:0) in
  let ctx = Backend.init device in
  Rand.init 0;
  (* Hey is inferred to be a matrix. *)
  let%op y = ("hey" * [ 2; 3 ]) + [ 4; 5; 6 ] in
  Train.forward_and_forget backend ctx y;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────┐
    │[21]: hey shape 1:2->0:3   │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 3.69e-2  4.69e-1 ││
    ││      │ 8.17e-1  9.70e-1 ││
    ││      │ 1.94e-1  5.50e-1 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘ |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌──────────────────────────────┐
    │[27]: +_y shape 0:3           │
    │┌┬───────────────────────────┐│
    │││axis 0                     ││
    │├┼───────────────────────────┤│
    │││ 5.48e+0  9.54e+0  8.04e+0 ││
    │└┴───────────────────────────┘│
    └──────────────────────────────┘ |}]

let%expect_test "Big matrix" =
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend = (module Backend : Train.Backend_type with type context = Backend.context) in
  let device = Backend.(new_virtual_device @@ get_device ~ordinal:0) in
  let ctx = Backend.init device in
  Rand.init 0;
  (* Hey is inferred to be a matrix. *)
  let hey = TDSL.O.(!~"hey") in
  let zero_to_twenty = TDSL.range 20 in
  let y = TDSL.O.((hey * zero_to_twenty) + zero_to_twenty) in
  Train.forward_and_forget backend ctx y;
  Tensor.print ~with_code:false ~with_grad:false `Inline zero_to_twenty;
  [%expect
    {|
      [0.00; 1.00; 2.00; 3.00; 4.00; 5.00; 6.00; 7.00; 8.00; 9.00; 10.00; 11.00;
        12.00; 13.00; 14.00; 15.00; 16.00; 17.00; 18.00; 19.00; 20.00] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default zero_to_twenty;
  [%expect
    {|
      ┌────────────────────────────────────────────┐
      │[31]: 0...20 shape 0:21                     │
      │┌┬─────────────────────────────────────────┐│
      │││axis 0                                   ││
      │├┼─────────────────────────────────────────┤│
      │││ 0.00e+0  1.00e+0  ...  1.90e+1  2.00e+1 ││
      │└┴─────────────────────────────────────────┘│
      └────────────────────────────────────────────┘ |}];
  Tensor.print ~with_code:false ~with_grad:false `Default hey;
  [%expect
    {|
      ┌──────────────────────────────────────────────────┐
      │[29]: hey shape 1:21->0:21                        │
      │┌──────┬─────────────────────────────────────────┐│
      ││      │axis 1                                   ││
      │├──────┼─────────────────────────────────────────┤│
      ││axis 0│ 3.69e-2  4.69e-1  ...  2.12e-1  1.92e-1 ││
      ││      │ 9.69e-1  6.75e-1  ...  8.33e-2  9.15e-1 ││
      ││      │ ...      ...      ...  ...      ...     ││
      ││      │ 9.86e-2  4.10e-1  ...  8.05e-1  1.01e-1 ││
      ││      │ 5.29e-1  5.14e-1  ...  2.27e-2  4.98e-1 ││
      │└──────┴─────────────────────────────────────────┘│
      └──────────────────────────────────────────────────┘ |}];
  Tensor.print ~with_code:false ~with_grad:false `Default y;
  [%expect
    {|
      ┌────────────────────────────────────────────┐
      │[34]: + shape 0:21                          │
      │┌┬─────────────────────────────────────────┐│
      │││axis 0                                   ││
      │├┼─────────────────────────────────────────┤│
      │││ 1.01e+2  1.06e+2  ...  1.16e+2  1.08e+2 ││
      │└┴─────────────────────────────────────────┘│
      └────────────────────────────────────────────┘ |}]

let%expect_test "Very big tensor" =
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend = (module Backend : Train.Backend_type with type context = Backend.context) in
  let device = Backend.(new_virtual_device @@ get_device ~ordinal:0) in
  let ctx = Backend.init device in
  Rand.init 0;
  let hey =
    TDSL.range_of_shape ~batch_dims:[ 6 ] ~input_dims:[ 7; 8; 9 ] ~output_dims:[ 10; 11 ] ()
  in
  let%op hoo = (hey * (1 + 1)) - 10 in
  Train.forward_and_forget backend ctx hoo;
  Tensor.print ~with_code:false ~with_grad:false `Default hey;
  [%expect
    {|
      ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │[36]: r6x10x11x7x8x9 shape 0:6|3:7,4:8,5:9->1:10,2:11                                                                                                                                  │
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││0 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 0.00e+0  1.00e+0  ...  7.00e+0  8.00e+0 │ 9.00e+0  1.00e+1  ...  1.60e+1  1.70e+1 │ ...  │ 5.40e+1  5.50e+1  ...  6.10e+1  6.20e+1 │ 6.30e+1  6.40e+1  ...  7.00e+1  7.10e+1 ││
      ││axis 2│ 5.04e+2  5.05e+2  ...  5.11e+2  5.12e+2 │ 5.13e+2  5.14e+2  ...  5.20e+2  5.21e+2 │      │ 5.58e+2  5.59e+2  ...  5.65e+2  5.66e+2 │ 5.67e+2  5.68e+2  ...  5.74e+2  5.75e+2 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 4.54e+3  4.54e+3  ...  4.54e+3  4.54e+3 │ 4.54e+3  4.55e+3  ...  4.55e+3  4.55e+3 │      │ 4.59e+3  4.59e+3  ...  4.60e+3  4.60e+3 │ 4.60e+3  4.60e+3  ...  4.61e+3  4.61e+3 ││
      ││      │ 5.04e+3  5.04e+3  ...  5.05e+3  5.05e+3 │ 5.05e+3  5.05e+3  ...  5.06e+3  5.06e+3 │      │ 5.09e+3  5.10e+3  ...  5.10e+3  5.10e+3 │ 5.10e+3  5.10e+3  ...  5.11e+3  5.11e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 5.54e+3  5.54e+3  ...  5.55e+3  5.55e+3 │ 5.55e+3  5.55e+3  ...  5.56e+3  5.56e+3 │ ...  │ 5.60e+3  5.60e+3  ...  5.60e+3  5.61e+3 │ 5.61e+3  5.61e+3  ...  5.61e+3  5.62e+3 ││
      ││axis 2│ 6.05e+3  6.05e+3  ...  6.06e+3  6.06e+3 │ 6.06e+3  6.06e+3  ...  6.06e+3  6.06e+3 │      │ 6.10e+3  6.10e+3  ...  6.11e+3  6.11e+3 │ 6.11e+3  6.11e+3  ...  6.12e+3  6.12e+3 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │      │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │ 1.01e+4  1.01e+4  ...  1.02e+4  1.02e+4 ││
      ││      │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │      │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │ 1.06e+4  1.06e+4  ...  1.07e+4  1.07e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ ...  │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 ││
      ││axis 2│ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │      │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 4.89e+4  4.89e+4  ...  4.89e+4  4.89e+4 │ 4.89e+4  4.89e+4  ...  4.89e+4  4.89e+4 │      │ 4.89e+4  4.89e+4  ...  4.89e+4  4.90e+4 │ 4.90e+4  4.90e+4  ...  4.90e+4  4.90e+4 ││
      ││      │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 │      │ 4.94e+4  4.94e+4  ...  4.95e+4  4.95e+4 │ 4.95e+4  4.95e+4  ...  4.95e+4  4.95e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 │ ...  │ 5.00e+4  5.00e+4  ...  5.00e+4  5.00e+4 │ 5.00e+4  5.00e+4  ...  5.00e+4  5.00e+4 ││
      ││axis 2│ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │      │ 5.05e+4  5.05e+4  ...  5.05e+4  5.05e+4 │ 5.05e+4  5.05e+4  ...  5.05e+4  5.05e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │      │ 5.45e+4  5.45e+4  ...  5.45e+4  5.45e+4 │ 5.45e+4  5.45e+4  ...  5.45e+4  5.45e+4 ││
      ││      │ 5.49e+4  5.49e+4  ...  5.49e+4  5.49e+4 │ 5.49e+4  5.49e+4  ...  5.50e+4  5.50e+4 │      │ 5.50e+4  5.50e+4  ...  5.50e+4  5.50e+4 │ 5.50e+4  5.50e+4  ...  5.50e+4  5.50e+4 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││1 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 5.54e+4  5.54e+4  ...  5.54e+4  5.54e+4 │ 5.54e+4  5.54e+4  ...  5.55e+4  5.55e+4 │ ...  │ 5.55e+4  5.55e+4  ...  5.55e+4  5.55e+4 │ 5.55e+4  5.55e+4  ...  5.55e+4  5.55e+4 ││
      ││axis 2│ 5.59e+4  5.59e+4  ...  5.60e+4  5.60e+4 │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 │      │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │      │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 ││
      ││      │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │      │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │ 6.05e+4  6.05e+4  ...  6.06e+4  6.06e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ ...  │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ 6.10e+4  6.10e+4  ...  6.11e+4  6.11e+4 ││
      ││axis 2│ 6.15e+4  6.15e+4  ...  6.15e+4  6.15e+4 │ 6.15e+4  6.15e+4  ...  6.15e+4  6.15e+4 │      │ 6.15e+4  6.15e+4  ...  6.15e+4  6.16e+4 │ 6.16e+4  6.16e+4  ...  6.16e+4  6.16e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │      │ 6.56e+4  6.56e+4  ...  6.56e+4  6.56e+4 │ 6.56e+4  6.56e+4  ...  6.56e+4  6.56e+4 ││
      ││      │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │      │ 6.61e+4  6.61e+4  ...  6.61e+4  6.61e+4 │ 6.61e+4  6.61e+4  ...  6.61e+4  6.61e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 │ ...  │ 9.98e+4  9.98e+4  ...  9.99e+4  9.99e+4 │ 9.99e+4  9.99e+4  ...  9.99e+4  9.99e+4 ││
      ││axis 2│ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │      │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 ││
      ││      │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │      │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ ...  │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 ││
      ││axis 2│ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 │ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 │      │ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 │ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 ││
      ││      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │ ...                                                                                                                                                                                   │
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││4 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ ...  │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 ││
      ││axis 2│ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │      │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 ││
      ││      │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │      │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ ...  │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 ││
      ││axis 2│ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 │ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 │      │ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 │ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 ││
      ││      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ ...  │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 ││
      ││axis 2│ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 │ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 │      │ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 │ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 ││
      ││      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ ...  │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 ││
      ││axis 2│ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │      │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 ││
      ││      │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │      │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││5 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ ...  │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 ││
      ││axis 2│ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 │ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 │      │ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 │ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 ││
      ││      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ ...  │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 ││
      ││axis 2│ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │      │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 ││
      ││      │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 │      │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ ...  │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 ││
      ││axis 2│ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │      │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 ││
      ││      │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │      │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ ...  │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 ││
      ││axis 2│ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 │ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 │      │ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 │ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 ││
      ││      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
  Tensor.print ~with_code:false ~with_grad:false `Default hoo;
  (* Disable line wrapping for viewing the output. In VSCode: `View: Toggle Word Wrap`. *)
  [%expect
    {|
      ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │[42]: -_hoo shape 0:6|1:10,2:11                                                                                                                                                        │
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││      │0 @ 0                                    │1 @ 0                                    │~~~~~ │4 @ 0                                    │5 @ 0                                    ││
      ││      │axis 2                                   │axis 2                                   │axis 2│axis 2                                   │axis 2                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││axis 1│ 2.54e+5  7.62e+5  ...  4.83e+6  5.33e+6 │ 5.61e+7  5.66e+7  ...  6.07e+7  6.12e+7 │ ...  │ 2.24e+8  2.24e+8  ...  2.28e+8  2.29e+8 │ 2.80e+8  2.80e+8  ...  2.84e+8  2.85e+8 ││
      ││      │ 5.84e+6  6.35e+6  ...  1.04e+7  1.09e+7 │ 6.17e+7  6.22e+7  ...  6.63e+7  6.68e+7 │      │ 2.29e+8  2.30e+8  ...  2.34e+8  2.34e+8 │ 2.85e+8  2.86e+8  ...  2.90e+8  2.90e+8 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 4.50e+7  4.55e+7  ...  4.95e+7  5.00e+7 │ 1.01e+8  1.01e+8  ...  1.05e+8  1.06e+8 │      │ 2.68e+8  2.69e+8  ...  2.73e+8  2.74e+8 │ 3.24e+8  3.25e+8  ...  3.29e+8  3.29e+8 ││
      ││      │ 5.05e+7  5.11e+7  ...  5.51e+7  5.56e+7 │ 1.06e+8  1.07e+8  ...  1.11e+8  1.12e+8 │      │ 2.74e+8  2.75e+8  ...  2.79e+8  2.79e+8 │ 3.30e+8  3.30e+8  ...  3.35e+8  3.35e+8 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
