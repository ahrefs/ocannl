open Base
open Ocannl

module FDSL = Operation.FDSL

let () = Session.SDSL.set_executor OCaml

let%expect_test "Hello World" =
  Stdio.printf "Hello World!\n";
  [%expect {| Hello World! |}]

let%expect_test "Pointwise multiplication dims 1" =
  let open Session.SDSL in
  drop_session();
  Random.init 0;
  (* "Hey" is inferred to be a scalar.
     Note the pointwise multiplication means "hey" does not have any input axes. *)
  let%nn_op y = 2 *. "hey" in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ y;
  [%expect {|
    ┌───────────────┐
    │[3]: shape 0:1 │
    │┌┬─────────┐   │
    │││axis 0   │   │
    │├┼─────────┼── │
    │││ 2.67e-1 │   │
    │└┴─────────┘   │
    └───────────────┘ |}]

let%expect_test "op:Matrix multiplication dims 1x1" =
  let open Session.SDSL in
  drop_session();
  Random.init 0;
  (* Hey is inferred to be a matrix. *)
  let%nn_op y = "hey" * 'q' 2.0 + 'p' 1.0 in
  (* Punning for ["hey"] above introduced the [hey] identifier. *)
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect {|
    ┌────────────────────────┐
    │[1]: shape q=1:1->p=0:1 │
    │┌────────┬─────────┐    │
    ││        │axis q=1 │    │
    │├────────┼─────────┼─── │
    ││axis p=0│ 1.34e-1 │    │
    │└────────┴─────────┘    │
    └────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ y;
  [%expect {|
    ┌─────────────────┐
    │[5]: shape p=0:1 │
    │┌┬─────────┐     │
    │││axis p=0 │     │
    │├┼─────────┼──── │
    │││ 1.27e+0 │     │
    │└┴─────────┘     │
    └─────────────────┘ |}]

let%expect_test "op:Print constant tensor" =
  Session.drop_session();
  Random.init 0;
  let open Session.SDSL in
  let%nn_op hey = [1, 2, 3; 4, 5, 6] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ hey;
  [%expect {| [1.00, 2.00, 3.00; 4.00, 5.00, 6.00] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect {|
    ┌────────────────────────────────────┐
    │[1]: shape 1:3->0:2                 │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 1.00e+0  2.00e+0  3.00e+0 ││
    ││      │ 4.00e+0  5.00e+0  6.00e+0 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘ |}];
  let%nn_op hoo = [| [1; 2; 3]; [4; 5; 6] |] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ hoo;
  [%expect {| [|[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]|] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ hoo;
  [%expect {|
    ┌────────────────────────────────────┐
    │[2]: shape 0:2|1:3                  │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 1.00e+0  2.00e+0  3.00e+0 ││
    ││      │ 4.00e+0  5.00e+0  6.00e+0 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘ |}];
  let%nn_op hey2 = [(1, 2, 3), (4, 5, 6); (7, 8, 9), (10, 11, 12); (13, 14, 15), (16, 17, 18);
                     (19, 20, 21), (22, 23, 24)] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ hey2;
  [%expect {|
    [(1.00, 2.00, 3.00), (4.00, 5.00, 6.00);
      (7.00, 8.00, 9.00), (10.00, 11.00, 12.00);
      (13.00, 14.00, 15.00), (16.00, 17.00, 18.00);
      (19.00, 20.00, 21.00), (22.00, 23.00, 24.00)
    ] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────┐
    │[3]: shape 1:2,2:3->0:4                                         │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 1                      │1 @ 1                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 0│ 1.00e+0  2.00e+0  3.00e+0 │ 4.00e+0  5.00e+0  6.00e+0 ││
    ││      │ 7.00e+0  8.00e+0  9.00e+0 │ 1.00e+1  1.10e+1  1.20e+1 ││
    ││      │ 1.30e+1  1.40e+1  1.50e+1 │ 1.60e+1  1.70e+1  1.80e+1 ││
    ││      │ 1.90e+1  2.00e+1  2.10e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘ |}];
  let%nn_op hoo2 = [| [[1; 2; 3]; [4; 5; 6]]; [[7; 8; 9]; [10; 11; 12]]; [[13; 14; 15]; [16; 17; 18]];
                       [[19; 20; 21]; [22; 23; 24]] |] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ hoo2;
  [%expect {|
    [|[[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]];
      [[7.00; 8.00; 9.00]; [10.00; 11.00; 12.00]];
      [[13.00; 14.00; 15.00]; [16.00; 17.00; 18.00]];
      [[19.00; 20.00; 21.00]; [22.00; 23.00; 24.00]]
    |] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ hoo2;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: shape 0:4|1:2,2:3                                                                                                  │
    │┌──────┬───────────────────────────┬───────────────────────────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      │2 @ 0                      │3 @ 0                      ││
    ││      │axis 2                     │axis 2                     │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 1.00e+0  2.00e+0  3.00e+0 │ 7.00e+0  8.00e+0  9.00e+0 │ 1.30e+1  1.40e+1  1.50e+1 │ 1.90e+1  2.00e+1  2.10e+1 ││
    ││      │ 4.00e+0  5.00e+0  6.00e+0 │ 1.00e+1  1.10e+1  1.20e+1 │ 1.60e+1  1.70e+1  1.80e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
  let%nn_op heyhoo = [| [|[1; 2; 3]; [4; 5; 6]|]; [|[7; 8; 9]; [10; 11; 12]|]; [|[13; 14; 15]; [16; 17; 18]|];
                       [|[19; 20; 21]; [22; 23; 24]|] |] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ heyhoo;
  [%expect {|
    [|[|[1.00; 2.00; 3.00]; [4.00; 5.00; 6.00]|];
      [|[7.00; 8.00; 9.00]; [10.00; 11.00; 12.00]|];
      [|[13.00; 14.00; 15.00]; [16.00; 17.00; 18.00]|];
      [|[19.00; 20.00; 21.00]; [22.00; 23.00; 24.00]|]
    |] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ heyhoo;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: shape 0:4,1:2|2:3                                                                                                  │
    │┌──────┬───────────────────────────┬───────────────────────────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      │2 @ 0                      │3 @ 0                      ││
    ││      │axis 2                     │axis 2                     │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 1.00e+0  2.00e+0  3.00e+0 │ 7.00e+0  8.00e+0  9.00e+0 │ 1.30e+1  1.40e+1  1.50e+1 │ 1.90e+1  2.00e+1  2.10e+1 ││
    ││      │ 4.00e+0  5.00e+0  6.00e+0 │ 1.00e+1  1.10e+1  1.20e+1 │ 1.60e+1  1.70e+1  1.80e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
  let%nn_op heyhoo2 = [| [|[[1; 31]; [2; 32]; [3; 33]]; [[4; 34]; [5; 35]; [6; 36]]|];
                          [|[[7; 37]; [8; 38]; [9; 39]]; [[10; 40]; [11; 41]; [12; 42]]|];
                          [|[[13; 43]; [14; 44]; [15; 45]]; [[16; 46]; [17; 47]; [18; 48]]|];
                          [|[[19; 49]; [20; 50]; [21; 51]]; [[22; 52]; [23; 53]; [24; 54]]|] |] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ heyhoo2;
  [%expect {|
    [|
      [|[[1.00; 31.00]; [2.00; 32.00]; [3.00; 33.00]];
        [[4.00; 34.00]; [5.00; 35.00]; [6.00; 36.00]]|];
      [|[[7.00; 37.00]; [8.00; 38.00]; [9.00; 39.00]];
        [[10.00; 40.00]; [11.00; 41.00]; [12.00; 42.00]]|];
      [|[[13.00; 43.00]; [14.00; 44.00]; [15.00; 45.00]];
        [[16.00; 46.00]; [17.00; 47.00]; [18.00; 48.00]]|];
      [|[[19.00; 49.00]; [20.00; 50.00]; [21.00; 51.00]];
        [[22.00; 52.00]; [23.00; 53.00]; [24.00; 54.00]]|]
    |] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ heyhoo2;
  [%expect {|
    ┌──────────────────────────────────────────────┐
    │[6]: shape 0:4,1:2|2:3,3:2                    │
    │┌──────┬──────────────────┬──────────────────┐│
    ││      │0 @ 1             │1 @ 1             ││
    ││      │axis 3            │axis 3            ││
    │├──────┼──────────────────┼──────────────────┤│
    ││0 @ 0 │ 1.00e+0  3.10e+1 │ 4.00e+0  3.40e+1 ││
    ││axis 2│ 2.00e+0  3.20e+1 │ 5.00e+0  3.50e+1 ││
    ││      │ 3.00e+0  3.30e+1 │ 6.00e+0  3.60e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││1 @ 0 │ 7.00e+0  3.70e+1 │ 1.00e+1  4.00e+1 ││
    ││axis 2│ 8.00e+0  3.80e+1 │ 1.10e+1  4.10e+1 ││
    ││      │ 9.00e+0  3.90e+1 │ 1.20e+1  4.20e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││2 @ 0 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 ││
    ││axis 2│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 ││
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││3 @ 0 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 ││
    ││axis 2│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 ││
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 ││
    │└──────┴──────────────────┴──────────────────┘│
    └──────────────────────────────────────────────┘ |}];
  let%nn_op heyhoo3 = [| [| [[[1; 31]; [2; 32]; [3; 33]]; [[4; 34]; [5; 35]; [6; 36]]];
                             [[[7; 37]; [8; 38]; [9; 39]]; [[10; 40]; [11; 41]; [12; 42]]] |];
                          [| [[[13; 43]; [14; 44]; [15; 45]]; [[16; 46]; [17; 47]; [18; 48]]];
                             [[[19; 49]; [20; 50]; [21; 51]]; [[22; 52]; [23; 53]; [24; 54]]] |] |] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ heyhoo3;
  [%expect {|
    [|
      [|
        [[[1.00; 31.00]; [2.00; 32.00]; [3.00; 33.00]];
          [[4.00; 34.00]; [5.00; 35.00]; [6.00; 36.00]]];
        [[[7.00; 37.00]; [8.00; 38.00]; [9.00; 39.00]];
          [[10.00; 40.00]; [11.00; 41.00]; [12.00; 42.00]]]|];
      [|
        [[[13.00; 43.00]; [14.00; 44.00]; [15.00; 45.00]];
          [[16.00; 46.00]; [17.00; 47.00]; [18.00; 48.00]]];
        [[[19.00; 49.00]; [20.00; 50.00]; [21.00; 51.00]];
          [[22.00; 52.00]; [23.00; 53.00]; [24.00; 54.00]]]|]
    |] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ heyhoo3;
  [%expect {|
    ┌──────────────────────────────────────────────┐
    │[7]: shape 0:2,1:2|2:2,3:3,4:2                │
    │┌──────┬──────────────────┬──────────────────┐│
    ││0 @ 0 │0 @ 2             │1 @ 2             ││
    ││      │axis 4            │axis 4            ││
    │├──────┼──────────────────┼──────────────────┤│
    ││0 @ 1 │ 1.00e+0  3.10e+1 │ 4.00e+0  3.40e+1 ││
    ││axis 3│ 2.00e+0  3.20e+1 │ 5.00e+0  3.50e+1 ││
    ││      │ 3.00e+0  3.30e+1 │ 6.00e+0  3.60e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││1 @ 1 │ 7.00e+0  3.70e+1 │ 1.00e+1  4.00e+1 ││
    ││axis 3│ 8.00e+0  3.80e+1 │ 1.10e+1  4.10e+1 ││
    ││      │ 9.00e+0  3.90e+1 │ 1.20e+1  4.20e+1 ││
    │└──────┴──────────────────┴──────────────────┘│
    ├──────────────────────────────────────────────┤
    │┌──────┬──────────────────┬──────────────────┐│
    ││1 @ 0 │0 @ 2             │1 @ 2             ││
    ││      │axis 4            │axis 4            ││
    │├──────┼──────────────────┼──────────────────┤│
    ││0 @ 1 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 ││
    ││axis 3│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 ││
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││1 @ 1 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 ││
    ││axis 3│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 ││
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 ││
    │└──────┴──────────────────┴──────────────────┘│
    └──────────────────────────────────────────────┘ |}];
  let%nn_op heyhoo4 = [| [ [[1, 31; 2, 32; 3, 33]; [4, 34; 5, 35; 6, 36]];
                             [[7, 37; 8, 38; 9, 39]; [10, 40; 11, 41; 12, 42]] ];
                          [ [[13, 43; 14, 44; 15, 45]; [16, 46; 17, 47; 18, 48]];
                             [[19, 49; 20, 50; 21, 51]; [22, 52; 23, 53; 24, 54]] ] |] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline @@ heyhoo4;
  [%expect {|
    [|
      [
        [[1.00, 31.00; 2.00, 32.00; 3.00, 33.00];
          [4.00, 34.00; 5.00, 35.00; 6.00, 36.00]];
        [[7.00, 37.00; 8.00, 38.00; 9.00, 39.00];
          [10.00, 40.00; 11.00, 41.00; 12.00, 42.00]]];
      [
        [[13.00, 43.00; 14.00, 44.00; 15.00, 45.00];
          [16.00, 46.00; 17.00, 47.00; 18.00, 48.00]];
        [[19.00, 49.00; 20.00, 50.00; 21.00, 51.00];
          [22.00, 52.00; 23.00, 53.00; 24.00, 54.00]]]
    |] |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ heyhoo4;
  [%expect {|
    ┌──────────────────────────────────────────────┐
    │[8]: shape 0:2|4:2->1:2,2:2,3:3               │
    │┌──────┬──────────────────┬──────────────────┐│
    ││0 @ 0 │0 @ 2             │1 @ 2             ││
    ││      │axis 4            │axis 4            ││
    │├──────┼──────────────────┼──────────────────┤│
    ││0 @ 1 │ 1.00e+0  3.10e+1 │ 4.00e+0  3.40e+1 ││
    ││axis 3│ 2.00e+0  3.20e+1 │ 5.00e+0  3.50e+1 ││
    ││      │ 3.00e+0  3.30e+1 │ 6.00e+0  3.60e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││1 @ 1 │ 7.00e+0  3.70e+1 │ 1.00e+1  4.00e+1 ││
    ││axis 3│ 8.00e+0  3.80e+1 │ 1.10e+1  4.10e+1 ││
    ││      │ 9.00e+0  3.90e+1 │ 1.20e+1  4.20e+1 ││
    │└──────┴──────────────────┴──────────────────┘│
    ├──────────────────────────────────────────────┤
    │┌──────┬──────────────────┬──────────────────┐│
    ││1 @ 0 │0 @ 2             │1 @ 2             ││
    ││      │axis 4            │axis 4            ││
    │├──────┼──────────────────┼──────────────────┤│
    ││0 @ 1 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 ││
    ││axis 3│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 ││
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 ││
    │├──────┼──────────────────┼──────────────────┤│
    ││1 @ 1 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 ││
    ││axis 3│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 ││
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 ││
    │└──────┴──────────────────┴──────────────────┘│
    └──────────────────────────────────────────────┘ |}]

let%expect_test "op:Matrix multiplication dims 2x3" =
  let open Session.SDSL in
  drop_session();
  Random.init 0;
  (* Hey is inferred to be a matrix. *)
  let%nn_op hey = "hey" in
  let%nn_op y = hey * [2; 3] + [4; 5; 6] in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect {|
    ┌───────────────────────────┐
    │[1]: shape 1:2->0:3        │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 1.34e-1  8.68e-1 ││
    ││      │ 4.49e-1  2.68e-1 ││
    ││      │ 3.56e-2  5.87e-1 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ y;
  [%expect {|
    ┌──────────────────────────────┐
    │[5]: shape 0:3                │
    │┌┬───────────────────────────┐│
    │││axis 0                     ││
    │├┼───────────────────────────┤│
    │││ 6.60e+0  5.80e+0  7.76e+0 ││
    │└┴───────────────────────────┘│
    └──────────────────────────────┘ |}]

let%expect_test "Big matrix" =
  let open Session.SDSL in
  drop_session();
  Random.init 0;
  (* Hey is inferred to be a matrix. *)
  let hey = FDSL.O.(!~ "hey") in
  let zero_to_twenty = FDSL.range 20 in
  let y = FDSL.O.(hey * zero_to_twenty + zero_to_twenty) in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Inline zero_to_twenty;
  [%expect {|
      [0.00; 1.00; 2.00; 3.00; 4.00; 5.00; 6.00; 7.00; 8.00; 9.00; 10.00; 11.00;
        12.00; 13.00; 14.00; 15.00; 16.00; 17.00; 18.00; 19.00; 20.00
      ] |}];
  print_formula ~with_code:false ~with_grad:false `Default zero_to_twenty;
  [%expect {|
      ┌────────────────────────────────────────────┐
      │[2]: shape 0:21                             │
      │┌┬─────────────────────────────────────────┐│
      │││axis 0                                   ││
      │├┼─────────────────────────────────────────┤│
      │││ 0.00e+0  1.00e+0  ...  1.90e+1  2.00e+1 ││
      │└┴─────────────────────────────────────────┘│
      └────────────────────────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default hey;
  [%expect {|
      ┌──────────────────────────────────────────────────┐
      │[1]: shape 1:21->0:21                             │
      │┌──────┬─────────────────────────────────────────┐│
      ││      │axis 1                                   ││
      │├──────┼─────────────────────────────────────────┤│
      ││axis 0│ 1.34e-1  8.68e-1  ...  5.46e-1  4.70e-1 ││
      ││      │ 5.31e-1  4.31e-1  ...  9.64e-1  4.50e-2 ││
      ││      │ ...      ...      ...  ...      ...     ││
      ││      │ 3.78e-1  1.22e-1  ...  3.10e-1  4.93e-1 ││
      ││      │ 8.50e-1  4.69e-1  ...  6.16e-2  8.49e-1 ││
      │└──────┴─────────────────────────────────────────┘│
      └──────────────────────────────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default y;
  [%expect {|
      ┌────────────────────────────────────────────┐
      │[4]: shape 0:21                             │
      │┌┬─────────────────────────────────────────┐│
      │││axis 0                                   ││
      │├┼─────────────────────────────────────────┤│
      │││ 9.39e+0  1.90e+0  ...  2.89e+1  3.70e+1 ││
      │└┴─────────────────────────────────────────┘│
      └────────────────────────────────────────────┘ |}]

let%expect_test "op:Very big tensor" =
    let open Session.SDSL in
    drop_session();
    Random.init 0;
    (* Hey is inferred to be a matrix. *)
    let hey =
      FDSL.range_of_shape ~batch_dims:[6] ~input_dims:[7; 8; 9] ~output_dims:[10; 11] () in
    let%nn_op hoo = hey * (1 + 1) - 10 in
    refresh_session ();
    print_formula ~with_code:false ~with_grad:false `Default hey;
    [%expect {|
      ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │[1]: shape 0:6|3:7,4:8,5:9->1:10,2:11                                                                                                                                                  │
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││0 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 0.00e+0  1.00e+0  ...  7.00e+0  8.00e+0 │ 9.00e+0  1.00e+1  ...  1.60e+1  1.70e+1 │ ...  │ 5.40e+1  5.50e+1  ...  6.10e+1  6.20e+1 │ 6.30e+1  6.40e+1  ...  7.00e+1  7.10e+1 ││
      ││axis 2│ 5.04e+2  5.05e+2  ...  5.11e+2  5.12e+2 │ 5.13e+2  5.14e+2  ...  5.20e+2  5.21e+2 │      │ 5.58e+2  5.59e+2  ...  5.65e+2  5.66e+2 │ 5.67e+2  5.68e+2  ...  5.74e+2  5.75e+2 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 4.54e+3  4.54e+3  ...  4.54e+3  4.54e+3 │ 4.54e+3  4.55e+3  ...  4.55e+3  4.55e+3 │      │ 4.59e+3  4.59e+3  ...  4.60e+3  4.60e+3 │ 4.60e+3  4.60e+3  ...  4.61e+3  4.61e+3 ││
      ││      │ 5.04e+3  5.04e+3  ...  5.05e+3  5.05e+3 │ 5.05e+3  5.05e+3  ...  5.06e+3  5.06e+3 │      │ 5.09e+3  5.10e+3  ...  5.10e+3  5.10e+3 │ 5.10e+3  5.10e+3  ...  5.11e+3  5.11e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 5.54e+3  5.54e+3  ...  5.55e+3  5.55e+3 │ 5.55e+3  5.55e+3  ...  5.56e+3  5.56e+3 │ ...  │ 5.60e+3  5.60e+3  ...  5.60e+3  5.61e+3 │ 5.61e+3  5.61e+3  ...  5.61e+3  5.62e+3 ││
      ││axis 2│ 6.05e+3  6.05e+3  ...  6.06e+3  6.06e+3 │ 6.06e+3  6.06e+3  ...  6.06e+3  6.06e+3 │      │ 6.10e+3  6.10e+3  ...  6.11e+3  6.11e+3 │ 6.11e+3  6.11e+3  ...  6.12e+3  6.12e+3 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │      │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │ 1.01e+4  1.01e+4  ...  1.02e+4  1.02e+4 ││
      ││      │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │      │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │ 1.06e+4  1.06e+4  ...  1.07e+4  1.07e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ ...  │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 ││
      ││axis 2│ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │      │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 4.89e+4  4.89e+4  ...  4.89e+4  4.89e+4 │ 4.89e+4  4.89e+4  ...  4.89e+4  4.89e+4 │      │ 4.89e+4  4.89e+4  ...  4.89e+4  4.90e+4 │ 4.90e+4  4.90e+4  ...  4.90e+4  4.90e+4 ││
      ││      │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 │      │ 4.94e+4  4.94e+4  ...  4.95e+4  4.95e+4 │ 4.95e+4  4.95e+4  ...  4.95e+4  4.95e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 │ ...  │ 5.00e+4  5.00e+4  ...  5.00e+4  5.00e+4 │ 5.00e+4  5.00e+4  ...  5.00e+4  5.00e+4 ││
      ││axis 2│ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │      │ 5.05e+4  5.05e+4  ...  5.05e+4  5.05e+4 │ 5.05e+4  5.05e+4  ...  5.05e+4  5.05e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │      │ 5.45e+4  5.45e+4  ...  5.45e+4  5.45e+4 │ 5.45e+4  5.45e+4  ...  5.45e+4  5.45e+4 ││
      ││      │ 5.49e+4  5.49e+4  ...  5.49e+4  5.49e+4 │ 5.49e+4  5.49e+4  ...  5.50e+4  5.50e+4 │      │ 5.50e+4  5.50e+4  ...  5.50e+4  5.50e+4 │ 5.50e+4  5.50e+4  ...  5.50e+4  5.50e+4 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││1 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 5.54e+4  5.54e+4  ...  5.54e+4  5.54e+4 │ 5.54e+4  5.54e+4  ...  5.55e+4  5.55e+4 │ ...  │ 5.55e+4  5.55e+4  ...  5.55e+4  5.55e+4 │ 5.55e+4  5.55e+4  ...  5.55e+4  5.55e+4 ││
      ││axis 2│ 5.59e+4  5.59e+4  ...  5.60e+4  5.60e+4 │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 │      │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │      │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 ││
      ││      │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │      │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │ 6.05e+4  6.05e+4  ...  6.06e+4  6.06e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ ...  │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ 6.10e+4  6.10e+4  ...  6.11e+4  6.11e+4 ││
      ││axis 2│ 6.15e+4  6.15e+4  ...  6.15e+4  6.15e+4 │ 6.15e+4  6.15e+4  ...  6.15e+4  6.15e+4 │      │ 6.15e+4  6.15e+4  ...  6.15e+4  6.16e+4 │ 6.16e+4  6.16e+4  ...  6.16e+4  6.16e+4 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │      │ 6.56e+4  6.56e+4  ...  6.56e+4  6.56e+4 │ 6.56e+4  6.56e+4  ...  6.56e+4  6.56e+4 ││
      ││      │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │      │ 6.61e+4  6.61e+4  ...  6.61e+4  6.61e+4 │ 6.61e+4  6.61e+4  ...  6.61e+4  6.61e+4 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 │ ...  │ 9.98e+4  9.98e+4  ...  9.99e+4  9.99e+4 │ 9.99e+4  9.99e+4  ...  9.99e+4  9.99e+4 ││
      ││axis 2│ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │      │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 ││
      ││      │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │      │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ ...  │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 ││
      ││axis 2│ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 │ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 │      │ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 │ 1.06e+5  1.06e+5  ...  1.06e+5  1.06e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 ││
      ││      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │ ...                                                                                                                                                                                   │
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││4 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ ...  │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 ││
      ││axis 2│ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │      │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 ││
      ││      │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │      │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ ...  │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 ││
      ││axis 2│ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 │ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 │      │ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 │ 2.28e+5  2.28e+5  ...  2.28e+5  2.28e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 ││
      ││      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ ...  │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 ││
      ││axis 2│ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 │ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 │      │ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 │ 2.67e+5  2.67e+5  ...  2.67e+5  2.67e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 ││
      ││      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ ...  │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 ││
      ││axis 2│ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │      │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 ││
      ││      │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │      │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││5 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 1 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ ...  │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 ││
      ││axis 2│ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 │ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 │      │ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 │ 2.78e+5  2.78e+5  ...  2.78e+5  2.78e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 ││
      ││      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 1 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ ...  │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 ││
      ││axis 2│ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │      │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 ││
      ││      │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 │      │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 │ 2.88e+5  2.88e+5  ...  2.88e+5  2.88e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
      ││axis 2│                                         │                                         │      │                                         │                                         ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││8 @ 1 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ ...  │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 ││
      ││axis 2│ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │      │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 ││
      ││      │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │      │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││9 @ 1 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ ...  │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 ││
      ││axis 2│ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 │ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 │      │ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 │ 3.28e+5  3.28e+5  ...  3.28e+5  3.28e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 ││
      ││      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
    print_formula ~with_code:false ~with_grad:false `Default hoo;
    (* Disable line wrapping for viewing the output. In VSCode: `View: Toggle Word Wrap`. *)
    [%expect {|
      ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │[9]: shape 0:6|1:10,2:11                                                                                                                                                               │
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││      │0 @ 0                                    │1 @ 0                                    │~~~~~ │4 @ 0                                    │5 @ 0                                    ││
      ││      │axis 2                                   │axis 2                                   │axis 2│axis 2                                   │axis 2                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││axis 1│ 9.96e+2  2.00e+3  ...  1.01e+4  1.11e+4 │ 1.12e+5  1.13e+5  ...  1.21e+5  1.22e+5 │ ...  │ 4.45e+5  4.46e+5  ...  4.54e+5  4.55e+5 │ 5.55e+5  5.56e+5  ...  5.64e+5  5.65e+5 ││
      ││      │ 1.21e+4  1.31e+4  ...  2.12e+4  2.22e+4 │ 1.23e+5  1.24e+5  ...  1.32e+5  1.33e+5 │      │ 4.56e+5  4.57e+5  ...  4.65e+5  4.66e+5 │ 5.66e+5  5.67e+5  ...  5.76e+5  5.77e+5 ││
      ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
      ││      │ 8.97e+4  9.07e+4  ...  9.88e+4  9.98e+4 │ 2.01e+5  2.02e+5  ...  2.10e+5  2.11e+5 │      │ 5.33e+5  5.34e+5  ...  5.42e+5  5.43e+5 │ 6.44e+5  6.45e+5  ...  6.53e+5  6.54e+5 ││
      ││      │ 1.01e+5  1.02e+5  ...  1.10e+5  1.11e+5 │ 2.12e+5  2.13e+5  ...  2.21e+5  2.22e+5 │      │ 5.44e+5  5.45e+5  ...  5.53e+5  5.54e+5 │ 6.55e+5  6.56e+5  ...  6.64e+5  6.65e+5 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
