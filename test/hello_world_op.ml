open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module Rand = Arrayjit.Rand.Lib

module type Backend = Arrayjit.Backend_intf.Backend

let%expect_test "Hello World" =
  Tensor.unsafe_reinitialize ();
  Stdio.printf "Hello World!\n";
  [%expect {| Hello World! |}]

let%expect_test "Pointwise multiplication dims 1" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* "Hey" is inferred to be a scalar. *)
  let%op y = 2 *. "hey" 7.0 in
  Train.forward_and_forget backend ctx y;

  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌────────────────────┐
    │[3]: *._y shape 0:1 │
    │┌┬────────────┐     │
    │││axis 0      │     │
    │├┼────────────┤     │
    │││ 1.40000e+1 │     │
    │└┴────────────┘     │
    └────────────────────┘
    |}]

let%expect_test "Matrix multiplication dims 1x1" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* Hey is inferred to be a matrix because of matrix multiplication [*]. *)
  let%op y = ("hey" 7.0 * 'q' 2.0) + 'p' 1.0 in
  Train.forward_and_forget backend ctx y;
  (* Punning for ["hey"] above introduced the [hey] identifier. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌────────────────────────┐
    │[0]: hey shape 1:1->0:1 │
    │┌──────┬─────────┐      │
    ││      │axis 1   │      │
    │├──────┼─────────┤      │
    ││axis 0│ 7.00000 │      │
    │└──────┴─────────┘      │
    └────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌───────────────────┐
    │[6]: +_y shape 0:1 │
    │┌┬────────────┐    │
    │││axis 0      │    │
    │├┼────────────┤    │
    │││ 1.50000e+1 │    │
    │└┴────────────┘    │
    └───────────────────┘
    |}]

let%expect_test "Print constant tensor" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;

  let%op hey = [ (1, 2, 3); (4, 5, 6) ] in
  Train.forward_and_forget backend ctx hey;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hey;
  [%expect {| [1.00000, 2.00000, 3.00000; 4.00000, 5.00000, 6.00000] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[0]: c2x3_hey shape 1:3->0:2        │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 1.00000  2.00000  3.00000 ││
    ││      │ 4.00000  5.00000  6.00000 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘
    |}];
  let%op hoo = [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |] in
  Train.forward_and_forget backend ctx hoo;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hoo;
  [%expect {| [|[1.00000; 2.00000; 3.00000]; [4.00000; 5.00000; 6.00000]|] |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hoo;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[1]: c2x3_hoo shape 0:2|1:3         │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 1.00000  2.00000  3.00000 ││
    ││      │ 4.00000  5.00000  6.00000 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘
    |}];
  let%op hey2 =
    [
      ((1, 2, 3), (4, 5, 6));
      ((7, 8, 9), (10, 11, 12));
      ((13, 14, 15), (16, 17, 18));
      ((19, 20, 21), (22, 23, 24));
    ]
  in
  Train.forward_and_forget backend ctx hey2;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hey2;
  [%expect
    {|
    [(1.00000, 2.00000, 3.00000), (4.00000, 5.00000, 6.00000);
      (7.00000, 8.00000, 9.00000), (10.00000, 11.00000, 12.00000);
      (13.00000, 14.00000, 15.00000), (16.00000, 17.00000, 18.00000);
      (19.00000, 20.00000, 21.00000), (22.00000, 23.00000, 24.00000)]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │[2]: c4x2x3_hey2 shape 1:2,2:3->0:4                                               │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 1                               │1 @ 1                               ││
    ││      │axis 2                              │axis 2                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 0│ 1.00000     2.00000     3.00000    │ 4.00000     5.00000     6.00000    ││
    ││      │ 7.00000     8.00000     9.00000    │ 1.00000e+1  1.10000e+1  1.20000e+1 ││
    ││      │ 1.30000e+1  1.40000e+1  1.50000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1 ││
    ││      │ 1.90000e+1  2.00000e+1  2.10000e+1 │ 2.20000e+1  2.30000e+1  2.40000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op hoo2 =
    [|
      [ [ 1; 2; 3 ]; [ 4; 5; 6 ] ];
      [ [ 7; 8; 9 ]; [ 10; 11; 12 ] ];
      [ [ 13; 14; 15 ]; [ 16; 17; 18 ] ];
      [ [ 19; 20; 21 ]; [ 22; 23; 24 ] ];
    |]
  in
  Train.forward_and_forget backend ctx hoo2;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ hoo2;
  [%expect
    {|
    [|[[1.00000; 2.00000; 3.00000]; [4.00000; 5.00000; 6.00000]];
      [[7.00000; 8.00000; 9.00000]; [10.00000; 11.00000; 12.00000]];
      [[13.00000; 14.00000; 15.00000]; [16.00000; 17.00000; 18.00000]];
      [[19.00000; 20.00000; 21.00000]; [22.00000; 23.00000; 24.00000]]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hoo2;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: c4x2x3_hoo2 shape 0:4|1:2,2:3                                                                                                                 │
    │┌──────┬───────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                               │2 @ 0                               │3 @ 0                               ││
    ││      │axis 2                     │axis 2                              │axis 2                              │axis 2                              ││
    │├──────┼───────────────────────────┼────────────────────────────────────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 1.00000  2.00000  3.00000 │ 7.00000     8.00000     9.00000    │ 1.30000e+1  1.40000e+1  1.50000e+1 │ 1.90000e+1  2.00000e+1  2.10000e+1 ││
    ││      │ 4.00000  5.00000  6.00000 │ 1.00000e+1  1.10000e+1  1.20000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1 │ 2.20000e+1  2.30000e+1  2.40000e+1 ││
    │└──────┴───────────────────────────┴────────────────────────────────────┴────────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo =
    [|
      [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |];
      [| [ 7; 8; 9 ]; [ 10; 11; 12 ] |];
      [| [ 13; 14; 15 ]; [ 16; 17; 18 ] |];
      [| [ 19; 20; 21 ]; [ 22; 23; 24 ] |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo;
  [%expect
    {|
    [|[|[1.00000; 2.00000; 3.00000]; [4.00000; 5.00000; 6.00000]|];
      [|[7.00000; 8.00000; 9.00000]; [10.00000; 11.00000; 12.00000]|];
      [|[13.00000; 14.00000; 15.00000]; [16.00000; 17.00000; 18.00000]|];
      [|[19.00000; 20.00000; 21.00000]; [22.00000; 23.00000; 24.00000]|]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: c4x2x3_heyhoo shape 0:4,1:2|2:3                                                                                                               │
    │┌──────┬───────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                               │2 @ 0                               │3 @ 0                               ││
    ││      │axis 2                     │axis 2                              │axis 2                              │axis 2                              ││
    │├──────┼───────────────────────────┼────────────────────────────────────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 1.00000  2.00000  3.00000 │ 7.00000     8.00000     9.00000    │ 1.30000e+1  1.40000e+1  1.50000e+1 │ 1.90000e+1  2.00000e+1  2.10000e+1 ││
    ││      │ 4.00000  5.00000  6.00000 │ 1.00000e+1  1.10000e+1  1.20000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1 │ 2.20000e+1  2.30000e+1  2.40000e+1 ││
    │└──────┴───────────────────────────┴────────────────────────────────────┴────────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo2 =
    [|
      [| [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] |];
      [| [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] |];
      [| [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] |];
      [| [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo2;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo2;
  [%expect
    {|
    [|
      [|[[1.00000; 31.00000]; [2.00000; 32.00000]; [3.00000; 33.00000]];
        [[4.00000; 34.00000]; [5.00000; 35.00000]; [6.00000; 36.00000]]|];
      [|[[7.00000; 37.00000]; [8.00000; 38.00000]; [9.00000; 39.00000]];
        [[10.00000; 40.00000]; [11.00000; 41.00000]; [12.00000; 42.00000]]|];
      [|[[13.00000; 43.00000]; [14.00000; 44.00000]; [15.00000; 45.00000]];
        [[16.00000; 46.00000]; [17.00000; 47.00000]; [18.00000; 48.00000]]|];
      [|[[19.00000; 49.00000]; [20.00000; 50.00000]; [21.00000; 51.00000]];
        [[22.00000; 52.00000]; [23.00000; 53.00000]; [24.00000; 54.00000]]|]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[5]: c4x2x3x2_heyhoo2 shape 0:4,1:2|2:3,3:2               │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 1                   │1 @ 1                   ││
    ││      │axis 3                  │axis 3                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││0 @ 0 │ 1.00000  3.10000e+1    │ 4.00000  3.40000e+1    ││
    ││axis 2│ 2.00000  3.20000e+1    │ 5.00000  3.50000e+1    ││
    ││      │ 3.00000  3.30000e+1    │ 6.00000  3.60000e+1    ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││1 @ 0 │ 7.00000  3.70000e+1    │ 1.00000e+1  4.00000e+1 ││
    ││axis 2│ 8.00000  3.80000e+1    │ 1.10000e+1  4.10000e+1 ││
    ││      │ 9.00000  3.90000e+1    │ 1.20000e+1  4.20000e+1 ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││2 @ 0 │ 1.30000e+1  4.30000e+1 │ 1.60000e+1  4.60000e+1 ││
    ││axis 2│ 1.40000e+1  4.40000e+1 │ 1.70000e+1  4.70000e+1 ││
    ││      │ 1.50000e+1  4.50000e+1 │ 1.80000e+1  4.80000e+1 ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││3 @ 0 │ 1.90000e+1  4.90000e+1 │ 2.20000e+1  5.20000e+1 ││
    ││axis 2│ 2.00000e+1  5.00000e+1 │ 2.30000e+1  5.30000e+1 ││
    ││      │ 2.10000e+1  5.10000e+1 │ 2.40000e+1  5.40000e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo3 =
    [|
      [|
        [ [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] ];
        [ [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] ];
      |];
      [|
        [ [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] ];
        [ [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] ];
      |];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo3;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo3;
  [%expect
    {|
    [|
      [|
        [[[1.00000; 31.00000]; [2.00000; 32.00000]; [3.00000; 33.00000]];
          [[4.00000; 34.00000]; [5.00000; 35.00000]; [6.00000; 36.00000]]];
        [[[7.00000; 37.00000]; [8.00000; 38.00000]; [9.00000; 39.00000]];
          [[10.00000; 40.00000]; [11.00000; 41.00000]; [12.00000; 42.00000]]]|];
      [|
        [[[13.00000; 43.00000]; [14.00000; 44.00000]; [15.00000; 45.00000]];
          [[16.00000; 46.00000]; [17.00000; 47.00000]; [18.00000; 48.00000]]];
        [[[19.00000; 49.00000]; [20.00000; 50.00000]; [21.00000; 51.00000]];
          [[22.00000; 52.00000]; [23.00000; 53.00000]; [24.00000; 54.00000]]]|]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo3;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[6]: c2x2x2x3x2_heyhoo3 shape 0:2,1:2|2:2,3:3,4:2         │
    │┌──────┬─────────────────────┬────────────────────────┐   │
    ││0 @ 0 │0 @ 2                │1 @ 2                   │   │
    ││      │axis 4               │axis 4                  │   │
    │├──────┼─────────────────────┼────────────────────────┤   │
    ││0 @ 1 │ 1.00000  3.10000e+1 │ 4.00000  3.40000e+1    │   │
    ││axis 3│ 2.00000  3.20000e+1 │ 5.00000  3.50000e+1    │   │
    ││      │ 3.00000  3.30000e+1 │ 6.00000  3.60000e+1    │   │
    │├──────┼─────────────────────┼────────────────────────┤   │
    ││1 @ 1 │ 7.00000  3.70000e+1 │ 1.00000e+1  4.00000e+1 │   │
    ││axis 3│ 8.00000  3.80000e+1 │ 1.10000e+1  4.10000e+1 │   │
    ││      │ 9.00000  3.90000e+1 │ 1.20000e+1  4.20000e+1 │   │
    │└──────┴─────────────────────┴────────────────────────┘   │
    ├──────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││1 @ 0 │0 @ 2                   │1 @ 2                   ││
    ││      │axis 4                  │axis 4                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││0 @ 1 │ 1.30000e+1  4.30000e+1 │ 1.60000e+1  4.60000e+1 ││
    ││axis 3│ 1.40000e+1  4.40000e+1 │ 1.70000e+1  4.70000e+1 ││
    ││      │ 1.50000e+1  4.50000e+1 │ 1.80000e+1  4.80000e+1 ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││1 @ 1 │ 1.90000e+1  4.90000e+1 │ 2.20000e+1  5.20000e+1 ││
    ││axis 3│ 2.00000e+1  5.00000e+1 │ 2.30000e+1  5.30000e+1 ││
    ││      │ 2.10000e+1  5.10000e+1 │ 2.40000e+1  5.40000e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo4 =
    [|
      [
        [ [ (1, 31); (2, 32); (3, 33) ]; [ (4, 34); (5, 35); (6, 36) ] ];
        [ [ (7, 37); (8, 38); (9, 39) ]; [ (10, 40); (11, 41); (12, 42) ] ];
      ];
      [
        [ [ (13, 43); (14, 44); (15, 45) ]; [ (16, 46); (17, 47); (18, 48) ] ];
        [ [ (19, 49); (20, 50); (21, 51) ]; [ (22, 52); (23, 53); (24, 54) ] ];
      ];
    |]
  in
  Train.forward_and_forget backend ctx heyhoo4;
  Tensor.print ~with_code:false ~with_grad:false `Inline @@ heyhoo4;
  [%expect
    {|
    [|
      [
        [[1.00000, 31.00000; 2.00000, 32.00000; 3.00000, 33.00000];
          [4.00000, 34.00000; 5.00000, 35.00000; 6.00000, 36.00000]];
        [[7.00000, 37.00000; 8.00000, 38.00000; 9.00000, 39.00000];
          [10.00000, 40.00000; 11.00000, 41.00000; 12.00000, 42.00000]]];
      [
        [[13.00000, 43.00000; 14.00000, 44.00000; 15.00000, 45.00000];
          [16.00000, 46.00000; 17.00000, 47.00000; 18.00000, 48.00000]];
        [[19.00000, 49.00000; 20.00000, 50.00000; 21.00000, 51.00000];
          [22.00000, 52.00000; 23.00000, 53.00000; 24.00000, 54.00000]]]|]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ heyhoo4;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[7]: c2x2x2x3x2_heyhoo4 shape 0:2|4:2->1:2,2:2,3:3        │
    │┌──────┬─────────────────────┬────────────────────────┐   │
    ││0 @ 0 │0 @ 2                │1 @ 2                   │   │
    ││      │axis 4               │axis 4                  │   │
    │├──────┼─────────────────────┼────────────────────────┤   │
    ││0 @ 1 │ 1.00000  3.10000e+1 │ 4.00000  3.40000e+1    │   │
    ││axis 3│ 2.00000  3.20000e+1 │ 5.00000  3.50000e+1    │   │
    ││      │ 3.00000  3.30000e+1 │ 6.00000  3.60000e+1    │   │
    │├──────┼─────────────────────┼────────────────────────┤   │
    ││1 @ 1 │ 7.00000  3.70000e+1 │ 1.00000e+1  4.00000e+1 │   │
    ││axis 3│ 8.00000  3.80000e+1 │ 1.10000e+1  4.10000e+1 │   │
    ││      │ 9.00000  3.90000e+1 │ 1.20000e+1  4.20000e+1 │   │
    │└──────┴─────────────────────┴────────────────────────┘   │
    ├──────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││1 @ 0 │0 @ 2                   │1 @ 2                   ││
    ││      │axis 4                  │axis 4                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││0 @ 1 │ 1.30000e+1  4.30000e+1 │ 1.60000e+1  4.60000e+1 ││
    ││axis 3│ 1.40000e+1  4.40000e+1 │ 1.70000e+1  4.70000e+1 ││
    ││      │ 1.50000e+1  4.50000e+1 │ 1.80000e+1  4.80000e+1 ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││1 @ 1 │ 1.90000e+1  4.90000e+1 │ 2.20000e+1  5.20000e+1 ││
    ││axis 3│ 2.00000e+1  5.00000e+1 │ 2.30000e+1  5.30000e+1 ││
    ││      │ 2.10000e+1  5.10000e+1 │ 2.40000e+1  5.40000e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}]

let%expect_test "Matrix multiplication dims 2x3" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* Hey is inferred to be a matrix. *)
  let%op y = ("hey" 7.0 * [ 2; 3 ]) + [ 4; 5; 6 ] in
  Train.forward_and_forget backend ctx y;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────┐
    │[0]: hey shape 1:2->0:3    │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 7.00000  7.00000 ││
    ││      │ 7.00000  7.00000 ││
    ││      │ 7.00000  7.00000 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ y;
  [%expect
    {|
    ┌───────────────────────────────────────┐
    │[6]: +_y shape 0:3                     │
    │┌┬────────────────────────────────────┐│
    │││axis 0                              ││
    │├┼────────────────────────────────────┤│
    │││ 3.90000e+1  4.00000e+1  4.10000e+1 ││
    │└┴────────────────────────────────────┘│
    └───────────────────────────────────────┘
    |}]

let%expect_test "Big matrix" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  (* Hey is inferred to be a matrix. *)
  let hey = Tensor.param ~values:[| 0.5 |] "hey" in
  let zero_to_twenty = TDSL.range 20 in
  let y = TDSL.O.((hey * zero_to_twenty) + zero_to_twenty) in
  Train.forward_and_forget backend ctx y;
  Tensor.print ~with_code:false ~with_grad:false `Inline zero_to_twenty;
  [%expect
    {|
    [0.00000; 1.00000; 2.00000; 3.00000; 4.00000; 5.00000; 6.00000; 7.00000;
      8.00000; 9.00000; 10.00000; 11.00000; 12.00000; 13.00000; 14.00000;
      15.00000; 16.00000; 17.00000; 18.00000; 19.00000; 20.00000]
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default zero_to_twenty;
  [%expect
    {|
    ┌──────────────────────────────────────────────────┐
    │[2]: 0...20 shape 0:21                            │
    │┌┬───────────────────────────────────────────────┐│
    │││axis 0                                         ││
    │├┼───────────────────────────────────────────────┤│
    │││ 0.00000  1.00000  ...  1.90000e+1  2.00000e+1 ││
    │└┴───────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default hey;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────┐
    │[0]: hey shape 1:21->0:21                                     │
    │┌──────┬─────────────────────────────────────────────────────┐│
    ││      │axis 1                                               ││
    │├──────┼─────────────────────────────────────────────────────┤│
    ││axis 0│ 5.00000e-1  5.00000e-1  ...  5.00000e-1  5.00000e-1 ││
    ││      │ 5.00000e-1  5.00000e-1  ...  5.00000e-1  5.00000e-1 ││
    ││      │ ...         ...         ...  ...         ...        ││
    ││      │ 5.00000e-1  5.00000e-1  ...  5.00000e-1  5.00000e-1 ││
    ││      │ 5.00000e-1  5.00000e-1  ...  5.00000e-1  5.00000e-1 ││
    │└──────┴─────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default y;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────┐
    │[5]: + shape 0:21                                       │
    │┌┬─────────────────────────────────────────────────────┐│
    │││axis 0                                               ││
    │├┼─────────────────────────────────────────────────────┤│
    │││ 1.05000e+2  1.06000e+2  ...  1.24000e+2  1.25000e+2 ││
    │└┴─────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────┘
    |}]

let%expect_test "Very big tensor" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey =
    TDSL.range_of_shape ~batch_dims:[ 6 ] ~input_dims:[ 7; 8; 9 ] ~output_dims:[ 10; 11 ] ()
  in
  let%op hoo = (hey * (1 + 1)) - 10 in
  Train.forward_and_forget backend ctx hoo;
  Tensor.print ~with_code:false ~with_grad:false `Default hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r6x10x11x7x8x9 shape 0:6|3:7,4:8,5:9->1:10,2:11                                                                                                                                                                                   │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││0 @ 0 │0 @ 4                                                │1 @ 4                                                │~~~~~ │6 @ 4                                                │7 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5│axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 1 │ 0.00000     1.00000     ...  7.00000     8.00000    │ 9.00000     1.00000e+1  ...  1.60000e+1  1.70000e+1 │ ...  │ 5.40000e+1  5.50000e+1  ...  6.10000e+1  6.20000e+1 │ 6.30000e+1  6.40000e+1  ...  7.00000e+1  7.10000e+1 ││
    ││axis 2│ 5.04000e+2  5.05000e+2  ...  5.11000e+2  5.12000e+2 │ 5.13000e+2  5.14000e+2  ...  5.20000e+2  5.21000e+2 │      │ 5.58000e+2  5.59000e+2  ...  5.65000e+2  5.66000e+2 │ 5.67000e+2  5.68000e+2  ...  5.74000e+2  5.75000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 4.53600e+3  4.53700e+3  ...  4.54300e+3  4.54400e+3 │ 4.54500e+3  4.54600e+3  ...  4.55200e+3  4.55300e+3 │      │ 4.59000e+3  4.59100e+3  ...  4.59700e+3  4.59800e+3 │ 4.59900e+3  4.60000e+3  ...  4.60600e+3  4.60700e+3 ││
    ││      │ 5.04000e+3  5.04100e+3  ...  5.04700e+3  5.04800e+3 │ 5.04900e+3  5.05000e+3  ...  5.05600e+3  5.05700e+3 │      │ 5.09400e+3  5.09500e+3  ...  5.10100e+3  5.10200e+3 │ 5.10300e+3  5.10400e+3  ...  5.11000e+3  5.11100e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 1 │ 5.54400e+3  5.54500e+3  ...  5.55100e+3  5.55200e+3 │ 5.55300e+3  5.55400e+3  ...  5.56000e+3  5.56100e+3 │ ...  │ 5.59800e+3  5.59900e+3  ...  5.60500e+3  5.60600e+3 │ 5.60700e+3  5.60800e+3  ...  5.61400e+3  5.61500e+3 ││
    ││axis 2│ 6.04800e+3  6.04900e+3  ...  6.05500e+3  6.05600e+3 │ 6.05700e+3  6.05800e+3  ...  6.06400e+3  6.06500e+3 │      │ 6.10200e+3  6.10300e+3  ...  6.10900e+3  6.11000e+3 │ 6.11100e+3  6.11200e+3  ...  6.11800e+3  6.11900e+3 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.00800e+4  1.00810e+4  ...  1.00870e+4  1.00880e+4 │ 1.00890e+4  1.00900e+4  ...  1.00960e+4  1.00970e+4 │      │ 1.01340e+4  1.01350e+4  ...  1.01410e+4  1.01420e+4 │ 1.01430e+4  1.01440e+4  ...  1.01500e+4  1.01510e+4 ││
    ││      │ 1.05840e+4  1.05850e+4  ...  1.05910e+4  1.05920e+4 │ 1.05930e+4  1.05940e+4  ...  1.06000e+4  1.06010e+4 │      │ 1.06380e+4  1.06390e+4  ...  1.06450e+4  1.06460e+4 │ 1.06470e+4  1.06480e+4  ...  1.06540e+4  1.06550e+4 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...  │ ...                                                 │ ...                                                 ││
    ││axis 2│                                                     │                                                     │      │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││8 @ 1 │ 4.43520e+4  4.43530e+4  ...  4.43590e+4  4.43600e+4 │ 4.43610e+4  4.43620e+4  ...  4.43680e+4  4.43690e+4 │ ...  │ 4.44060e+4  4.44070e+4  ...  4.44130e+4  4.44140e+4 │ 4.44150e+4  4.44160e+4  ...  4.44220e+4  4.44230e+4 ││
    ││axis 2│ 4.48560e+4  4.48570e+4  ...  4.48630e+4  4.48640e+4 │ 4.48650e+4  4.48660e+4  ...  4.48720e+4  4.48730e+4 │      │ 4.49100e+4  4.49110e+4  ...  4.49170e+4  4.49180e+4 │ 4.49190e+4  4.49200e+4  ...  4.49260e+4  4.49270e+4 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 4.88880e+4  4.88890e+4  ...  4.88950e+4  4.88960e+4 │ 4.88970e+4  4.88980e+4  ...  4.89040e+4  4.89050e+4 │      │ 4.89420e+4  4.89430e+4  ...  4.89490e+4  4.89500e+4 │ 4.89510e+4  4.89520e+4  ...  4.89580e+4  4.89590e+4 ││
    ││      │ 4.93920e+4  4.93930e+4  ...  4.93990e+4  4.94000e+4 │ 4.94010e+4  4.94020e+4  ...  4.94080e+4  4.94090e+4 │      │ 4.94460e+4  4.94470e+4  ...  4.94530e+4  4.94540e+4 │ 4.94550e+4  4.94560e+4  ...  4.94620e+4  4.94630e+4 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││9 @ 1 │ 4.98960e+4  4.98970e+4  ...  4.99030e+4  4.99040e+4 │ 4.99050e+4  4.99060e+4  ...  4.99120e+4  4.99130e+4 │ ...  │ 4.99500e+4  4.99510e+4  ...  4.99570e+4  4.99580e+4 │ 4.99590e+4  4.99600e+4  ...  4.99660e+4  4.99670e+4 ││
    ││axis 2│ 5.04000e+4  5.04010e+4  ...  5.04070e+4  5.04080e+4 │ 5.04090e+4  5.04100e+4  ...  5.04160e+4  5.04170e+4 │      │ 5.04540e+4  5.04550e+4  ...  5.04610e+4  5.04620e+4 │ 5.04630e+4  5.04640e+4  ...  5.04700e+4  5.04710e+4 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 5.44320e+4  5.44330e+4  ...  5.44390e+4  5.44400e+4 │ 5.44410e+4  5.44420e+4  ...  5.44480e+4  5.44490e+4 │      │ 5.44860e+4  5.44870e+4  ...  5.44930e+4  5.44940e+4 │ 5.44950e+4  5.44960e+4  ...  5.45020e+4  5.45030e+4 ││
    ││      │ 5.49360e+4  5.49370e+4  ...  5.49430e+4  5.49440e+4 │ 5.49450e+4  5.49460e+4  ...  5.49520e+4  5.49530e+4 │      │ 5.49900e+4  5.49910e+4  ...  5.49970e+4  5.49980e+4 │ 5.49990e+4  5.50000e+4  ...  5.50060e+4  5.50070e+4 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││1 @ 0 │0 @ 4                                                │1 @ 4                                                │~~~~~ │6 @ 4                                                │7 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5│axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 1 │ 5.54400e+4  5.54410e+4  ...  5.54470e+4  5.54480e+4 │ 5.54490e+4  5.54500e+4  ...  5.54560e+4  5.54570e+4 │ ...  │ 5.54940e+4  5.54950e+4  ...  5.55010e+4  5.55020e+4 │ 5.55030e+4  5.55040e+4  ...  5.55100e+4  5.55110e+4 ││
    ││axis 2│ 5.59440e+4  5.59450e+4  ...  5.59510e+4  5.59520e+4 │ 5.59530e+4  5.59540e+4  ...  5.59600e+4  5.59610e+4 │      │ 5.59980e+4  5.59990e+4  ...  5.60050e+4  5.60060e+4 │ 5.60070e+4  5.60080e+4  ...  5.60140e+4  5.60150e+4 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 5.99760e+4  5.99770e+4  ...  5.99830e+4  5.99840e+4 │ 5.99850e+4  5.99860e+4  ...  5.99920e+4  5.99930e+4 │      │ 6.00300e+4  6.00310e+4  ...  6.00370e+4  6.00380e+4 │ 6.00390e+4  6.00400e+4  ...  6.00460e+4  6.00470e+4 ││
    ││      │ 6.04800e+4  6.04810e+4  ...  6.04870e+4  6.04880e+4 │ 6.04890e+4  6.04900e+4  ...  6.04960e+4  6.04970e+4 │      │ 6.05340e+4  6.05350e+4  ...  6.05410e+4  6.05420e+4 │ 6.05430e+4  6.05440e+4  ...  6.05500e+4  6.05510e+4 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 1 │ 6.09840e+4  6.09850e+4  ...  6.09910e+4  6.09920e+4 │ 6.09930e+4  6.09940e+4  ...  6.10000e+4  6.10010e+4 │ ...  │ 6.10380e+4  6.10390e+4  ...  6.10450e+4  6.10460e+4 │ 6.10470e+4  6.10480e+4  ...  6.10540e+4  6.10550e+4 ││
    ││axis 2│ 6.14880e+4  6.14890e+4  ...  6.14950e+4  6.14960e+4 │ 6.14970e+4  6.14980e+4  ...  6.15040e+4  6.15050e+4 │      │ 6.15420e+4  6.15430e+4  ...  6.15490e+4  6.15500e+4 │ 6.15510e+4  6.15520e+4  ...  6.15580e+4  6.15590e+4 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 6.55200e+4  6.55210e+4  ...  6.55270e+4  6.55280e+4 │ 6.55290e+4  6.55300e+4  ...  6.55360e+4  6.55370e+4 │      │ 6.55740e+4  6.55750e+4  ...  6.55810e+4  6.55820e+4 │ 6.55830e+4  6.55840e+4  ...  6.55900e+4  6.55910e+4 ││
    ││      │ 6.60240e+4  6.60250e+4  ...  6.60310e+4  6.60320e+4 │ 6.60330e+4  6.60340e+4  ...  6.60400e+4  6.60410e+4 │      │ 6.60780e+4  6.60790e+4  ...  6.60850e+4  6.60860e+4 │ 6.60870e+4  6.60880e+4  ...  6.60940e+4  6.60950e+4 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...  │ ...                                                 │ ...                                                 ││
    ││axis 2│                                                     │                                                     │      │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││8 @ 1 │ 9.97920e+4  9.97930e+4  ...  9.97990e+4  9.98000e+4 │ 9.98010e+4  9.98020e+4  ...  9.98080e+4  9.98090e+4 │ ...  │ 9.98460e+4  9.98470e+4  ...  9.98530e+4  9.98540e+4 │ 9.98550e+4  9.98560e+4  ...  9.98620e+4  9.98630e+4 ││
    ││axis 2│ 1.00296e+5  1.00297e+5  ...  1.00303e+5  1.00304e+5 │ 1.00305e+5  1.00306e+5  ...  1.00312e+5  1.00313e+5 │      │ 1.00350e+5  1.00351e+5  ...  1.00357e+5  1.00358e+5 │ 1.00359e+5  1.00360e+5  ...  1.00366e+5  1.00367e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.04328e+5  1.04329e+5  ...  1.04335e+5  1.04336e+5 │ 1.04337e+5  1.04338e+5  ...  1.04344e+5  1.04345e+5 │      │ 1.04382e+5  1.04383e+5  ...  1.04389e+5  1.04390e+5 │ 1.04391e+5  1.04392e+5  ...  1.04398e+5  1.04399e+5 ││
    ││      │ 1.04832e+5  1.04833e+5  ...  1.04839e+5  1.04840e+5 │ 1.04841e+5  1.04842e+5  ...  1.04848e+5  1.04849e+5 │      │ 1.04886e+5  1.04887e+5  ...  1.04893e+5  1.04894e+5 │ 1.04895e+5  1.04896e+5  ...  1.04902e+5  1.04903e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││9 @ 1 │ 1.05336e+5  1.05337e+5  ...  1.05343e+5  1.05344e+5 │ 1.05345e+5  1.05346e+5  ...  1.05352e+5  1.05353e+5 │ ...  │ 1.05390e+5  1.05391e+5  ...  1.05397e+5  1.05398e+5 │ 1.05399e+5  1.05400e+5  ...  1.05406e+5  1.05407e+5 ││
    ││axis 2│ 1.05840e+5  1.05841e+5  ...  1.05847e+5  1.05848e+5 │ 1.05849e+5  1.05850e+5  ...  1.05856e+5  1.05857e+5 │      │ 1.05894e+5  1.05895e+5  ...  1.05901e+5  1.05902e+5 │ 1.05903e+5  1.05904e+5  ...  1.05910e+5  1.05911e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.09872e+5  1.09873e+5  ...  1.09879e+5  1.09880e+5 │ 1.09881e+5  1.09882e+5  ...  1.09888e+5  1.09889e+5 │      │ 1.09926e+5  1.09927e+5  ...  1.09933e+5  1.09934e+5 │ 1.09935e+5  1.09936e+5  ...  1.09942e+5  1.09943e+5 ││
    ││      │ 1.10376e+5  1.10377e+5  ...  1.10383e+5  1.10384e+5 │ 1.10385e+5  1.10386e+5  ...  1.10392e+5  1.10393e+5 │      │ 1.10430e+5  1.10431e+5  ...  1.10437e+5  1.10438e+5 │ 1.10439e+5  1.10440e+5  ...  1.10446e+5  1.10447e+5 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                                                                                                                                                                   │
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││4 @ 0 │0 @ 4                                                │1 @ 4                                                │~~~~~ │6 @ 4                                                │7 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5│axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 1 │ 2.21760e+5  2.21761e+5  ...  2.21767e+5  2.21768e+5 │ 2.21769e+5  2.21770e+5  ...  2.21776e+5  2.21777e+5 │ ...  │ 2.21814e+5  2.21815e+5  ...  2.21821e+5  2.21822e+5 │ 2.21823e+5  2.21824e+5  ...  2.21830e+5  2.21831e+5 ││
    ││axis 2│ 2.22264e+5  2.22265e+5  ...  2.22271e+5  2.22272e+5 │ 2.22273e+5  2.22274e+5  ...  2.22280e+5  2.22281e+5 │      │ 2.22318e+5  2.22319e+5  ...  2.22325e+5  2.22326e+5 │ 2.22327e+5  2.22328e+5  ...  2.22334e+5  2.22335e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.26296e+5  2.26297e+5  ...  2.26303e+5  2.26304e+5 │ 2.26305e+5  2.26306e+5  ...  2.26312e+5  2.26313e+5 │      │ 2.26350e+5  2.26351e+5  ...  2.26357e+5  2.26358e+5 │ 2.26359e+5  2.26360e+5  ...  2.26366e+5  2.26367e+5 ││
    ││      │ 2.26800e+5  2.26801e+5  ...  2.26807e+5  2.26808e+5 │ 2.26809e+5  2.26810e+5  ...  2.26816e+5  2.26817e+5 │      │ 2.26854e+5  2.26855e+5  ...  2.26861e+5  2.26862e+5 │ 2.26863e+5  2.26864e+5  ...  2.26870e+5  2.26871e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 1 │ 2.27304e+5  2.27305e+5  ...  2.27311e+5  2.27312e+5 │ 2.27313e+5  2.27314e+5  ...  2.27320e+5  2.27321e+5 │ ...  │ 2.27358e+5  2.27359e+5  ...  2.27365e+5  2.27366e+5 │ 2.27367e+5  2.27368e+5  ...  2.27374e+5  2.27375e+5 ││
    ││axis 2│ 2.27808e+5  2.27809e+5  ...  2.27815e+5  2.27816e+5 │ 2.27817e+5  2.27818e+5  ...  2.27824e+5  2.27825e+5 │      │ 2.27862e+5  2.27863e+5  ...  2.27869e+5  2.27870e+5 │ 2.27871e+5  2.27872e+5  ...  2.27878e+5  2.27879e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.31840e+5  2.31841e+5  ...  2.31847e+5  2.31848e+5 │ 2.31849e+5  2.31850e+5  ...  2.31856e+5  2.31857e+5 │      │ 2.31894e+5  2.31895e+5  ...  2.31901e+5  2.31902e+5 │ 2.31903e+5  2.31904e+5  ...  2.31910e+5  2.31911e+5 ││
    ││      │ 2.32344e+5  2.32345e+5  ...  2.32351e+5  2.32352e+5 │ 2.32353e+5  2.32354e+5  ...  2.32360e+5  2.32361e+5 │      │ 2.32398e+5  2.32399e+5  ...  2.32405e+5  2.32406e+5 │ 2.32407e+5  2.32408e+5  ...  2.32414e+5  2.32415e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...  │ ...                                                 │ ...                                                 ││
    ││axis 2│                                                     │                                                     │      │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││8 @ 1 │ 2.66112e+5  2.66113e+5  ...  2.66119e+5  2.66120e+5 │ 2.66121e+5  2.66122e+5  ...  2.66128e+5  2.66129e+5 │ ...  │ 2.66166e+5  2.66167e+5  ...  2.66173e+5  2.66174e+5 │ 2.66175e+5  2.66176e+5  ...  2.66182e+5  2.66183e+5 ││
    ││axis 2│ 2.66616e+5  2.66617e+5  ...  2.66623e+5  2.66624e+5 │ 2.66625e+5  2.66626e+5  ...  2.66632e+5  2.66633e+5 │      │ 2.66670e+5  2.66671e+5  ...  2.66677e+5  2.66678e+5 │ 2.66679e+5  2.66680e+5  ...  2.66686e+5  2.66687e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.70648e+5  2.70649e+5  ...  2.70655e+5  2.70656e+5 │ 2.70657e+5  2.70658e+5  ...  2.70664e+5  2.70665e+5 │      │ 2.70702e+5  2.70703e+5  ...  2.70709e+5  2.70710e+5 │ 2.70711e+5  2.70712e+5  ...  2.70718e+5  2.70719e+5 ││
    ││      │ 2.71152e+5  2.71153e+5  ...  2.71159e+5  2.71160e+5 │ 2.71161e+5  2.71162e+5  ...  2.71168e+5  2.71169e+5 │      │ 2.71206e+5  2.71207e+5  ...  2.71213e+5  2.71214e+5 │ 2.71215e+5  2.71216e+5  ...  2.71222e+5  2.71223e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││9 @ 1 │ 2.71656e+5  2.71657e+5  ...  2.71663e+5  2.71664e+5 │ 2.71665e+5  2.71666e+5  ...  2.71672e+5  2.71673e+5 │ ...  │ 2.71710e+5  2.71711e+5  ...  2.71717e+5  2.71718e+5 │ 2.71719e+5  2.71720e+5  ...  2.71726e+5  2.71727e+5 ││
    ││axis 2│ 2.72160e+5  2.72161e+5  ...  2.72167e+5  2.72168e+5 │ 2.72169e+5  2.72170e+5  ...  2.72176e+5  2.72177e+5 │      │ 2.72214e+5  2.72215e+5  ...  2.72221e+5  2.72222e+5 │ 2.72223e+5  2.72224e+5  ...  2.72230e+5  2.72231e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.76192e+5  2.76193e+5  ...  2.76199e+5  2.76200e+5 │ 2.76201e+5  2.76202e+5  ...  2.76208e+5  2.76209e+5 │      │ 2.76246e+5  2.76247e+5  ...  2.76253e+5  2.76254e+5 │ 2.76255e+5  2.76256e+5  ...  2.76262e+5  2.76263e+5 ││
    ││      │ 2.76696e+5  2.76697e+5  ...  2.76703e+5  2.76704e+5 │ 2.76705e+5  2.76706e+5  ...  2.76712e+5  2.76713e+5 │      │ 2.76750e+5  2.76751e+5  ...  2.76757e+5  2.76758e+5 │ 2.76759e+5  2.76760e+5  ...  2.76766e+5  2.76767e+5 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││5 @ 0 │0 @ 4                                                │1 @ 4                                                │~~~~~ │6 @ 4                                                │7 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5│axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 1 │ 2.77200e+5  2.77201e+5  ...  2.77207e+5  2.77208e+5 │ 2.77209e+5  2.77210e+5  ...  2.77216e+5  2.77217e+5 │ ...  │ 2.77254e+5  2.77255e+5  ...  2.77261e+5  2.77262e+5 │ 2.77263e+5  2.77264e+5  ...  2.77270e+5  2.77271e+5 ││
    ││axis 2│ 2.77704e+5  2.77705e+5  ...  2.77711e+5  2.77712e+5 │ 2.77713e+5  2.77714e+5  ...  2.77720e+5  2.77721e+5 │      │ 2.77758e+5  2.77759e+5  ...  2.77765e+5  2.77766e+5 │ 2.77767e+5  2.77768e+5  ...  2.77774e+5  2.77775e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.81736e+5  2.81737e+5  ...  2.81743e+5  2.81744e+5 │ 2.81745e+5  2.81746e+5  ...  2.81752e+5  2.81753e+5 │      │ 2.81790e+5  2.81791e+5  ...  2.81797e+5  2.81798e+5 │ 2.81799e+5  2.81800e+5  ...  2.81806e+5  2.81807e+5 ││
    ││      │ 2.82240e+5  2.82241e+5  ...  2.82247e+5  2.82248e+5 │ 2.82249e+5  2.82250e+5  ...  2.82256e+5  2.82257e+5 │      │ 2.82294e+5  2.82295e+5  ...  2.82301e+5  2.82302e+5 │ 2.82303e+5  2.82304e+5  ...  2.82310e+5  2.82311e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 1 │ 2.82744e+5  2.82745e+5  ...  2.82751e+5  2.82752e+5 │ 2.82753e+5  2.82754e+5  ...  2.82760e+5  2.82761e+5 │ ...  │ 2.82798e+5  2.82799e+5  ...  2.82805e+5  2.82806e+5 │ 2.82807e+5  2.82808e+5  ...  2.82814e+5  2.82815e+5 ││
    ││axis 2│ 2.83248e+5  2.83249e+5  ...  2.83255e+5  2.83256e+5 │ 2.83257e+5  2.83258e+5  ...  2.83264e+5  2.83265e+5 │      │ 2.83302e+5  2.83303e+5  ...  2.83309e+5  2.83310e+5 │ 2.83311e+5  2.83312e+5  ...  2.83318e+5  2.83319e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.87280e+5  2.87281e+5  ...  2.87287e+5  2.87288e+5 │ 2.87289e+5  2.87290e+5  ...  2.87296e+5  2.87297e+5 │      │ 2.87334e+5  2.87335e+5  ...  2.87341e+5  2.87342e+5 │ 2.87343e+5  2.87344e+5  ...  2.87350e+5  2.87351e+5 ││
    ││      │ 2.87784e+5  2.87785e+5  ...  2.87791e+5  2.87792e+5 │ 2.87793e+5  2.87794e+5  ...  2.87800e+5  2.87801e+5 │      │ 2.87838e+5  2.87839e+5  ...  2.87845e+5  2.87846e+5 │ 2.87847e+5  2.87848e+5  ...  2.87854e+5  2.87855e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...  │ ...                                                 │ ...                                                 ││
    ││axis 2│                                                     │                                                     │      │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││8 @ 1 │ 3.21552e+5  3.21553e+5  ...  3.21559e+5  3.21560e+5 │ 3.21561e+5  3.21562e+5  ...  3.21568e+5  3.21569e+5 │ ...  │ 3.21606e+5  3.21607e+5  ...  3.21613e+5  3.21614e+5 │ 3.21615e+5  3.21616e+5  ...  3.21622e+5  3.21623e+5 ││
    ││axis 2│ 3.22056e+5  3.22057e+5  ...  3.22063e+5  3.22064e+5 │ 3.22065e+5  3.22066e+5  ...  3.22072e+5  3.22073e+5 │      │ 3.22110e+5  3.22111e+5  ...  3.22117e+5  3.22118e+5 │ 3.22119e+5  3.22120e+5  ...  3.22126e+5  3.22127e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 3.26088e+5  3.26089e+5  ...  3.26095e+5  3.26096e+5 │ 3.26097e+5  3.26098e+5  ...  3.26104e+5  3.26105e+5 │      │ 3.26142e+5  3.26143e+5  ...  3.26149e+5  3.26150e+5 │ 3.26151e+5  3.26152e+5  ...  3.26158e+5  3.26159e+5 ││
    ││      │ 3.26592e+5  3.26593e+5  ...  3.26599e+5  3.26600e+5 │ 3.26601e+5  3.26602e+5  ...  3.26608e+5  3.26609e+5 │      │ 3.26646e+5  3.26647e+5  ...  3.26653e+5  3.26654e+5 │ 3.26655e+5  3.26656e+5  ...  3.26662e+5  3.26663e+5 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││9 @ 1 │ 3.27096e+5  3.27097e+5  ...  3.27103e+5  3.27104e+5 │ 3.27105e+5  3.27106e+5  ...  3.27112e+5  3.27113e+5 │ ...  │ 3.27150e+5  3.27151e+5  ...  3.27157e+5  3.27158e+5 │ 3.27159e+5  3.27160e+5  ...  3.27166e+5  3.27167e+5 ││
    ││axis 2│ 3.27600e+5  3.27601e+5  ...  3.27607e+5  3.27608e+5 │ 3.27609e+5  3.27610e+5  ...  3.27616e+5  3.27617e+5 │      │ 3.27654e+5  3.27655e+5  ...  3.27661e+5  3.27662e+5 │ 3.27663e+5  3.27664e+5  ...  3.27670e+5  3.27671e+5 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 3.31632e+5  3.31633e+5  ...  3.31639e+5  3.31640e+5 │ 3.31641e+5  3.31642e+5  ...  3.31648e+5  3.31649e+5 │      │ 3.31686e+5  3.31687e+5  ...  3.31693e+5  3.31694e+5 │ 3.31695e+5  3.31696e+5  ...  3.31702e+5  3.31703e+5 ││
    ││      │ 3.32136e+5  3.32137e+5  ...  3.32143e+5  3.32144e+5 │ 3.32145e+5  3.32146e+5  ...  3.32152e+5  3.32153e+5 │      │ 3.32190e+5  3.32191e+5  ...  3.32197e+5  3.32198e+5 │ 3.32199e+5  3.32200e+5  ...  3.32206e+5  3.32207e+5 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default hoo;
  (* Disable line wrapping for viewing the output. In VSCode: `View: Toggle Word Wrap`. *)
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: -_hoo shape 0:6|1:10,2:11                                                                                                                                                                                                         │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                │1 @ 0                                                │~~~~~ │4 @ 0                                                │5 @ 0                                                ││
    ││      │axis 2                                               │axis 2                                               │axis 2│axis 2                                               │axis 2                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││axis 1│ 2.53502e+5  7.61534e+5  ...  4.82579e+6  5.33382e+6 │ 5.61368e+7  5.66449e+7  ...  6.07091e+7  6.12171e+7 │ ...  │ 2.23787e+8  2.24295e+8  ...  2.28359e+8  2.28867e+8 │ 2.79671e+8  2.80179e+8  ...  2.84243e+8  2.84751e+8 ││
    ││      │ 5.84185e+6  6.34989e+6  ...  1.04141e+7  1.09222e+7 │ 6.17252e+7  6.22332e+7  ...  6.62974e+7  6.68054e+7 │      │ 2.29376e+8  2.29884e+8  ...  2.33948e+8  2.34456e+8 │ 2.85259e+8  2.85767e+8  ...  2.89831e+8  2.90339e+8 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 4.49602e+7  4.54682e+7  ...  4.95324e+7  5.00405e+7 │ 1.00844e+8  1.01352e+8  ...  1.05416e+8  1.05924e+8 │      │ 2.68494e+8  2.69002e+8  ...  2.73066e+8  2.73574e+8 │ 3.24377e+8  3.24886e+8  ...  3.28950e+8  3.29458e+8 ││
    ││      │ 5.05485e+7  5.10565e+7  ...  5.51208e+7  5.56288e+7 │ 1.06432e+8  1.06940e+8  ...  1.11004e+8  1.11512e+8 │      │ 2.74082e+8  2.74590e+8  ...  2.78655e+8  2.79163e+8 │ 3.29966e+8  3.30474e+8  ...  3.34538e+8  3.35046e+8 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
