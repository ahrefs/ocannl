open Base
open Ocannl
module Tn = Ir.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module NTDSL = Operation.NTDSL

module type Backend = Ir.Backend_intf.Backend

let plot_unop ?(x_min = -5.) ?(x_max = 5.) ~f () =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let open Operation.At in
  CDSL.virtualize_settings.enable_device_only <- false;
  let size = 100 in
  let xs =
    Array.init size ~f:Float.(fun i -> x_min + (of_int i * (x_max - x_min) / (of_int size - 1.)))
  in
  let x_flat = Tensor.term_init xs ~label:[ "x_flat" ] ~grad_spec:Require_grad () in
  let step_sym, bindings = IDX.get_static_symbol ~static_range:size IDX.empty in
  let%op x = x_flat @| step_sym in
  let%op fx = f x in
  Train.set_hosted x.value;
  Train.set_hosted (Option.value_exn ~here:[%here] x.Tensor.diff).grad;
  (* There actually are no params! Stress test the empty comp case. *)
  let ctx = Train.init_params (module Backend) IDX.empty fx in
  let update = Train.grad_update fx in
  let fx_routine = Train.to_routine (module Backend) ctx bindings update in
  Train.run fx_routine;
  let step_ref = IDX.find_exn fx_routine.bindings step_sym in
  let ys, dys =
    Array.unzip
    @@ Array.mapi xs ~f:(fun i _ ->
           step_ref := i;
           Train.run fx_routine;
           (fx.@[0], x.@%[0]))
  in
  (* It is fine to loop around the data: it's "next epoch". We redo the work though. *)
  PrintBox_utils.plot ~x_label:"x" ~y_label:"f(x)"
    [
      Scatterplot { points = Array.zip_exn xs dys; content = PrintBox.line "*" };
      Scatterplot { points = Array.zip_exn xs ys; content = PrintBox.line "#" };
      Line_plot { points = Array.create ~len:20 0.; content = PrintBox.line "-" };
    ]

let%expect_test "relu" =
  let%op f x = relu x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 5.00│                                                                                                   #│
    │     │                                                                                                  # │
    │     │                                                                                                 #  │
    │     │                                                                                                #   │
    │     │                                                                                              #     │
    │     │                                                                                             #      │
    │     │                                                                                            #       │
    │     │                                                                                           #        │
    │     │                                                                                         ##         │
    │     │                                                                                        #           │
    │     │                                                                                      #             │
    │     │                                                                                      #             │
    │     │                                                                                    ##              │
    │     │                                                                                   #                │
    │     │                                                                                 #                  │
    │     │                                                                                ##                  │
    │     │                                                                               #                    │
    │     │                                                                              #                     │
    │f    │                                                                             #                      │
    │(    │                                                                           ##                       │
    │x    │                                                                          #                         │
    │)    │                                                                         #                          │
    │     │                                                                        #                           │
    │     │                                                                      ##                            │
    │     │                                                                     #                              │
    │     │                                                                    #                               │
    │     │                                                                   #                                │
    │     │                                                                 ##                                 │
    │     │                                                                #                                   │
    │     │                                                               #                                    │
    │     │                                                             ##                                     │
    │     │                                                            #                                       │
    │     │                                                 * ******************************* **** ******* ****│
    │     │                                                          #                                         │
    │     │                                                        ##                                          │
    │     │                                                       #                                            │
    │     │                                                      #                                             │
    │     │                                                     #                                              │
    │     │                                                   ##                                               │
    │ 0.00│**** *** *** *** ********-*************** ********-    -    -    -    -    -    -    -    -    -    │
    ├─────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │     │-5.00                                                                                           5.00│
    │     │                                                 x                                                  │
    └─────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "sat01" =
  let%op f x = sat01 x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 1.00│                                                 * *********###################### #### ####### ####│
    │     │                                                                                                    │
    │     │                                                           #                                        │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                          #                                         │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                         #                                          │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                        #                                           │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │f    │                                                       #                                            │
    │(    │                                                                                                    │
    │x    │                                                                                                    │
    │)    │                                                                                                    │
    │     │                                                      #                                             │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                     #                                              │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                    #                                               │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                   #                                                │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                 #                                                  │
    │ 0.00│**** *** *** *** ********-*************** ********-    -    ********************** **** *******-****│
    ├─────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │     │-5.00                                                                                           5.00│
    │     │                                                 x                                                  │
    └─────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "exp(x)" =
  let%op f x = exp x in
  let plot_box = plot_unop ~f ~x_max:1.0 () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 2.71│                                                                                                   *│
    │     │                                                                                                    │
    │     │                                                                                                    │
    │     │                                                                                                  * │
    │     │                                                                                                    │
    │     │                                                                                                 *  │
    │     │                                                                                                    │
    │     │                                                                                                *   │
    │     │                                                                                                    │
    │     │                                                                                               *    │
    │     │                                                                                                    │
    │     │                                                                                              *     │
    │     │                                                                                             *      │
    │     │                                                                                                    │
    │     │                                                                                            *       │
    │     │                                                                                           *        │
    │     │                                                                                                    │
    │     │                                                                                          *         │
    │f    │                                                                                         *          │
    │(    │                                                                                        *           │
    │x    │                                                                                                    │
    │)    │                                                                                       *            │
    │     │                                                                                      *             │
    │     │                                                                                     *              │
    │     │                                                                                    *               │
    │     │                                                                                   *                │
    │     │                                                                                 **                 │
    │     │                                                                                *                   │
    │     │                                                                               *                    │
    │     │                                                                             **                     │
    │     │                                                                           **                       │
    │     │                                                                        **                          │
    │     │                                                                       *                            │
    │     │                                                                     **                             │
    │     │                                                                  ***                               │
    │     │                                                              ****                                  │
    │     │                                                         *****                                      │
    │     │                                                  *******                                           │
    │     │                                       ***********                                                  │
    │ 0.00│********* ************ ************** * -    -    -    -    -    -    -    -    -    -    -    -    │
    ├─────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │     │-5.00                                                                                           1.00│
    │     │                                                 x                                                  │
    └─────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "log(x)" =
  let%op f x = log x in
  let plot_box = plot_unop ~f ~x_min:0.1 ~x_max:5.0 () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 1.00e+1│*                                                                                                   │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │ *                                                                                                  │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │  *                                                                                                 │
    │        │                                                                                                    │
    │f       │                                                                                                    │
    │(       │   *                                                                                                │
    │x       │                                                                                                    │
    │)       │                                                                                                    │
    │        │    *                                                                                               │
    │        │     *                                                                                              │
    │        │      *                                                                                             │
    │        │       *                                                                                            │
    │        │        **                                                                                          │
    │        │          **                                                                           #############│
    │        │            ***                                                ################### ####             │
    │        │                ******                        ######### #### ##                                     │
    │        │                      ******** *****##### ####                                                      │
    │        │                        ###### ##   ***** ************* **** ********************* *******          │
    │        │-    -    -    - ####### -    -    -    -    -    -    -    -    -    -    -    -    -    **********│
    │        │            ### #                                                                                   │
    │        │        ####                                                                                        │
    │        │      ##                                                                                            │
    │        │    ##                                                                                              │
    │        │  ##                                                                                                │
    │        │ #                                                                                                  │
    │ -2.30  │#                                                                                                   │
    ├────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │        │1.00e-1                                                                                         5.00│
    │        │                                                 x                                                  │
    └────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "log2(x)" =
  let%op f x = log2 x in
  let plot_box = plot_unop ~f ~x_min:0.1 ~x_max:5.0 () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 1.44e+1│*                                                                                                   │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │ *                                                                                                  │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │  *                                                                                                 │
    │        │                                                                                                    │
    │f       │                                                                                                    │
    │(       │   *                                                                                                │
    │x       │                                                                                                    │
    │)       │                                                                                                    │
    │        │    *                                                                                               │
    │        │     *                                                                                              │
    │        │      *                                                                                             │
    │        │       *                                                                                            │
    │        │        **                                                                                          │
    │        │          **                                                                           #############│
    │        │            ***                                                ################### ####             │
    │        │                ******                        ######### #### ##                                     │
    │        │                      ******** *****##### ####                                                      │
    │        │                        ###### ##   ***** ************* **** ********************* *******          │
    │        │-    -    -    - ####### -    -    -    -    -    -    -    -    -    -    -    -    -    **********│
    │        │            ### #                                                                                   │
    │        │        ####                                                                                        │
    │        │      ##                                                                                            │
    │        │    ##                                                                                              │
    │        │  ##                                                                                                │
    │        │ #                                                                                                  │
    │ -3.32  │#                                                                                                   │
    ├────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │        │1.00e-1                                                                                         5.00│
    │        │                                                 x                                                  │
    └────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "sin(x)" =
  let%op f x = sin x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 9.99e-1 │                                                                 #                                  │
    │         │#### ##                                        *** **         ### ###                               │
    │         │      #                                      **      **      #       #                              │
    │         │       #                                    *          *    #         #                             │
    │         │         #                                                 #           #                            │
    │         │          #                                *            * #             #                           │
    │         │                                          *              *               #                          │
    │         │           #                            *                #*                                         │
    │         │           #                                            #                 #                         │
    │         │                                        *                  *                                        │
    │         │             #                         *               #    *              #                        │
    │         │                                                      #                     #                       │
    │         │              #                       *                      *                                      │
    │         │               #                                     #                       #                      │
    │         │*                                    *                        *                                    *│
    │         │               #                                    #                         #                     │
    │         │ *                                  *                          *                                  * │
    │         │                 #                                 #                           #                    │
    │f        │  *                                *                            *                                *  │
    │(        │                  #                              #                              #                   │
    │x        │- *  -    -    -    -    -    -   *-    -    -    -    -    -    *    -    -    -    -    -    -*   │
    │)        │                   #                             #                               #                  │
    │         │   *                             *                                *                           *     │
    │         │                    #                           #                                #                  │
    │         │     *                          *                                  *                          *     │
    │         │                     #                         #                                   #                │
    │         │      *                        *                                    *                        *      │
    │         │                      #                       #                                     #               │
    │         │      *                       *                                      *               #      *       │
    │         │                       #     *               #                        *                             │
    │         │       *                #                   #                                         #    *        │
    │         │         *                  *                                          *                  *         │
    │         │                        #                  #                                          #             │
    │         │          *                *              #                             *               #*          │
    │         │           *              *                                              *              *           │
    │         │                        *  #            #                                 *              #          │
    │         │           *            *   #           #                                  *          *   #         │
    │         │             *         *     #         #                                    *         *    #        │
    │         │              **      *       #       #                                      *      **      #       │
    │ -9.99e-1│               * *****         #######                                        **** *         ## ####│
    ├─────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │         │-5.00                                                                                           5.00│
    │         │                                                 x                                                  │
    └─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "cos(x)" =
  let%op f x = cos x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 9.99e-1 │                                  *                                                                 │
    │         │                               *** ***         ### ##                                        ** ****│
    │         │                              *       *      ##      ##                                     *       │
    │         │                             *         *    #          #                                   *        │
    │         │                            *           *                                                 *         │
    │         │                           *            *  #            #                                *          │
    │         │                          *               #              #                                          │
    │         │                                        # *               #                             *           │
    │         │                        *                  *                                          *             │
    │         │                                        #                  #                                        │
    │         │                        *              #    *               #                         *             │
    │         │                       *                     *                                                      │
    │         │                                      #                      #                       *              │
    │         │                      *                       *                                     *               │
    │         │#                                    #                        #                                    #│
    │         │                     *                         *                                   *                │
    │         │ #                                  #                          #                                  # │
    │         │                    *                           *                                *                  │
    │f        │  #                                #                            #                                #  │
    │(        │                   *                             *                               *                  │
    │x        │- #  -    -    -    -    -    -   #-    -    -    -    -    -    #    -    -    -    -    -    -#   │
    │)        │                  *                              *                              *                   │
    │         │   #                             #                                #                           #     │
    │         │                 *                                 *                           *                    │
    │         │     #                          #                                  #                          #     │
    │         │               *                                    *                         *                     │
    │         │      #                        #                                    #                        #      │
    │         │               *                                     *                       *                      │
    │         │      #       *               #                                      #                      #       │
    │         │                             #                        *               #     *                       │
    │         │       #     *                                         *                   *               #        │
    │         │         #                  #                                          #                  #         │
    │         │           *                                            *                 *                         │
    │         │          #*               #                             *              #                #          │
    │         │           #              #                                              *              #           │
    │         │          *             #                                 *             * #                         │
    │         │         * #            #                                  *           *   #          #             │
    │         │       *     #         #                                    *         *     #         #             │
    │         │      *       ##      #                                      *       *       #      ##              │
    │ -9.99e-1│**** **        # #####                                        *******         #### #                │
    ├─────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │         │-5.00                                                                                           5.00│
    │         │                                                 x                                                  │
    └─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "neg(x)" =
  let%op f x = neg x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌──────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 5.00 │#                                                                                                   │
    │      │ ##                                                                                                 │
    │      │  ## #                                                                                              │
    │      │      #                                                                                             │
    │      │       # ##                                                                                         │
    │      │           #                                                                                        │
    │      │             ###                                                                                    │
    │      │               # #                                                                                  │
    │      │                  ###                                                                               │
    │      │                     ##                                                                             │
    │      │                       ##                                                                           │
    │      │                          ##                                                                        │
    │      │                            ###                                                                     │
    │      │                               ##                                                                   │
    │      │                                 ###                                                                │
    │      │                                    ###                                                             │
    │      │                                       ##                                                           │
    │      │                                        # ##                                                        │
    │f     │                                            ##                                                      │
    │(     │                                              ###                                                   │
    │x     │-    -    -    -    -    -    -    -    -    -   #-    -    -    -    -    -    -    -    -    -    │
    │)     │                                                   ###                                              │
    │      │                                                      ##                                            │
    │      │                                                        ###                                         │
    │      │**** *** *** *** ******** *************** ******** ******************************* **** ******* ****│
    │      │                                                             ###                                    │
    │      │                                                                ###                                 │
    │      │                                                                   ##                               │
    │      │                                                                     ###                            │
    │      │                                                                        ##                          │
    │      │                                                                          ###                       │
    │      │                                                                             ##                     │
    │      │                                                                               ###                  │
    │      │                                                                                 # #                │
    │      │                                                                                    ###             │
    │      │                                                                                      # #           │
    │      │                                                                                         ###        │
    │      │                                                                                            ##      │
    │      │                                                                                              # #   │
    │ -5.00│                                                                                                 ###│
    ├──────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │      │-5.00                                                                                           5.00│
    │      │                                                 x                                                  │
    └──────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "fma(x, 2, 1)" =
  let%op f x = fma x !.2. !.1. in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 1.10e+1│                                                                                                   #│
    │        │                                                                                                 ## │
    │        │                                                                                              # #   │
    │        │                                                                                            ##      │
    │        │                                                                                         ###        │
    │        │                                                                                      # #           │
    │        │                                                                                    ###             │
    │        │                                                                                 # #                │
    │        │                                                                               ###                  │
    │        │                                                                             ##                     │
    │        │                                                                          ###                       │
    │        │                                                                        ##                          │
    │        │                                                                     ###                            │
    │        │                                                                   ##                               │
    │        │                                                                ###                                 │
    │        │                                                             ###                                    │
    │        │                                                           ##                                       │
    │        │                                                        ###                                         │
    │f       │**** *** *** *** ******** *************** ******** ******************************* **** ******* ****│
    │(       │                                                   ###                                              │
    │x       │                                                 #                                                  │
    │)       │                                              ###                                                   │
    │        │-    -    -    -    -    -    -    -    -   ##    -    -    -    -    -    -    -    -    -    -    │
    │        │                                        # ##                                                        │
    │        │                                       ##                                                           │
    │        │                                    ###                                                             │
    │        │                                 ###                                                                │
    │        │                               ##                                                                   │
    │        │                            ###                                                                     │
    │        │                          ##                                                                        │
    │        │                       ##                                                                           │
    │        │                     ##                                                                             │
    │        │                  ###                                                                               │
    │        │               # #                                                                                  │
    │        │             ###                                                                                    │
    │        │           #                                                                                        │
    │        │       # ##                                                                                         │
    │        │      #                                                                                             │
    │        │  ## #                                                                                              │
    │ -9.00  │###                                                                                                 │
    ├────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │        │-5.00                                                                                           5.00│
    │        │                                                 x                                                  │
    └────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "sqrt(x)" =
  let%op f x = sqrt x in
  let plot_box = plot_unop ~f ~x_min:0.1 ~x_max:5.0 () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 2.23│                                                                                                   #│
    │     │                                                                                              ##### │
    │     │                                                                                         #####      │
    │     │                                                                                     ####           │
    │     │                                                                                ## ##               │
    │     │                                                                           #####                    │
    │     │                                                                       ####                         │
    │     │                                                                  #####                             │
    │     │                                                              ####                                  │
    │     │                                                          ## #                                      │
    │     │                                                      # ##                                          │
    │     │                                                   ###                                              │
    │     │*                                              ####                                                 │
    │     │                                           ####                                                     │
    │     │                                        # #                                                         │
    │     │                                     ###                                                            │
    │     │                                  ###                                                               │
    │     │ *                             ###                                                                  │
    │f    │                            ##                                                                      │
    │(    │                         ###                                                                        │
    │x    │  *                   ###                                                                           │
    │)    │                    ##                                                                              │
    │     │   *              ##                                                                                │
    │     │              # ##                                                                                  │
    │     │    *        ##                                                                                     │
    │     │     *     ##                                                                                       │
    │     │      **  #                                                                                         │
    │     │        *#                                                                                          │
    │     │       # **                                                                                         │
    │     │     ##    ***                                                                                      │
    │     │    #         * *                                                                                   │
    │     │   #             *****                                                                              │
    │     │  #                   ********                                                                      │
    │     │ #                           * **********                                                           │
    │     │#                                       * ************* ****                                        │
    │     │                                                           * ********************* ************     │
    │     │                                                                                               *****│
    │     │                                                                                                    │
    │     │                                                                                                    │
    │ 0.00│-    -    -    -    -    -    -    -    -    -    -    -    -    -    -    -    -    -    -    -    │
    ├─────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │     │1.00e-1                                                                                         5.00│
    │     │                                                 x                                                  │
    └─────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "recip(x)" =
  let%op f x = recip x in
  let plot_box = plot_unop ~f ~x_min:0.1 ~x_max:5.0 () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 1.00e+1 │#                                                                                                   │
    │         │                                                                                                    │
    │         │ ##                                                                                                 │
    │         │   #########                                                                                        │
    │         │-    -    - ###-**************-********** *************-****-********************* *****************│
    │         │        *******                                                                                     │
    │         │      **                                                                                            │
    │         │     *                                                                                              │
    │         │    *                                                                                               │
    │         │                                                                                                    │
    │         │   *                                                                                                │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │  *                                                                                                 │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │f        │                                                                                                    │
    │(        │                                                                                                    │
    │x        │ *                                                                                                  │
    │)        │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │ -1.00e+2│*                                                                                                   │
    ├─────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │         │1.00e-1                                                                                         5.00│
    │         │                                                 x                                                  │
    └─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "recip_sqrt(x)" =
  let%op f x = recip_sqrt x in
  let plot_box = plot_unop ~f ~x_min:0.1 ~x_max:5.0 () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 3.16    │#                                                                                                   │
    │         │                                                                                                    │
    │         │ ##                                                                                                 │
    │         │   ##                                                                                               │
    │         │     #######                                                                                        │
    │         │            ### ############## #####                                                                │
    │         │                                    ##### ############# #### ##################### #################│
    │         │-    -    -    -    -    -    -********** *************-****-********************* *****************│
    │         │              * **************                                                                      │
    │         │          ****                                                                                      │
    │         │       ***                                                                                          │
    │         │      *                                                                                             │
    │         │     *                                                                                              │
    │         │    *                                                                                               │
    │         │                                                                                                    │
    │         │   *                                                                                                │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │f        │                                                                                                    │
    │(        │  *                                                                                                 │
    │x        │                                                                                                    │
    │)        │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │ *                                                                                                  │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │         │                                                                                                    │
    │ -1.58e+1│*                                                                                                   │
    ├─────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │         │1.00e-1                                                                                         5.00│
    │         │                                                 x                                                  │
    └─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "tanh(x)" =
  let%op f x = tanh x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 9.99e-1 │                                                                                                   #│
    │         │                                                ** *                ############## #### ####### ### │
    │         │                                               *    *           ####                                │
    │         │                                              *      *        ##                                    │
    │         │                                             *        *      #                                      │
    │         │                                            *          *   ##                                       │
    │         │                                                          #                                         │
    │         │                                           *            *                                           │
    │         │                                          *              *                                          │
    │         │                                                        #                                           │
    │         │                                        *              #  *                                         │
    │         │                                        *                  *                                        │
    │         │                                                      #                                             │
    │         │                                       *             #      *                                       │
    │         │                                      *                      *                                      │
    │         │                                     *              #         *                                     │
    │         │                                   **                          **                                   │
    │         │                                 **                #             **                                 │
    │f        │                               **                                  **                               │
    │(        │                        * *****                  #                   ******                         │
    │x        │**** *** *** *** ********-    -    -    -    -    -    -    -    -    -    ******* **** *******-****│
    │)        │                                                 #                                                  │
    │         │                                                                                                    │
    │         │                                                #                                                   │
    │         │                                                                                                    │
    │         │                                               #                                                    │
    │         │                                                                                                    │
    │         │                                              #                                                     │
    │         │                                             #                                                      │
    │         │                                                                                                    │
    │         │                                            #                                                       │
    │         │                                           #                                                        │
    │         │                                          #                                                         │
    │         │                                                                                                    │
    │         │                                        #                                                           │
    │         │                                       ##                                                           │
    │         │                                      #                                                             │
    │         │                                    ##                                                              │
    │         │                                ####                                                                │
    │ -9.99e-1│#### ### ### ### ######## ######                                                                    │
    ├─────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │         │-5.00                                                                                           5.00│
    │         │                                                 x                                                  │
    └─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "uint4x32_to_prec_uniform(x)" =
  let%op f x = uint4x32_to_prec_uniform x in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 7.52e-1│#                                                                                                   │
    │        │ ### ### ### ### ######## ############### ########                                                  │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │f       │                                                                                                    │
    │(       │                                                                                                    │
    │x       │                                                                                                    │
    │)       │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                              #### #### ####### ####│
    │        │                                                 # ###########################                      │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │        │                                                                                                    │
    │ 0.00   │**** *** *** *** ********-*************** ********-******************************* **** *******-****│
    ├────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │        │-5.00                                                                                           5.00│
    │        │                                                 x                                                  │
    └────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "where(x < 0, sin(x), cos(x))" =
  let%op f x = where (x < !.0.) (sin x) (cos x) in
  let plot_box = plot_unop ~f () in
  PrintBox_text.output Stdio.stdout plot_box;
  [%expect {|
    ┌─────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │ 9.99e-1 │  #                                                                                             *   │
    │         │#### ##                                        *** ##                                        **  ***│
    │         │      #                                      **      ##                                     *       │
    │         │       #                                    *          #                                   *        │
    │         │         #                                                                                *         │
    │         │          #                                *            #                                *          │
    │         │                                          *              #                                          │
    │         │           #                            *                 #                             *           │
    │         │           #                                                                          *             │
    │         │                                        *                  #                                        │
    │         │             #                         *                    #                         *             │
    │         │                                                                                                    │
    │         │              #                       *                      #                       *              │
    │         │               #                                                                    *               │
    │         │*                                    *                        #                                    #│
    │         │               #                                                                   *                │
    │         │ *                                  *                          #                                  # │
    │         │                 #                                                               *                  │
    │f        │  *                                *                            #                                #  │
    │(        │                  #                                                              *                  │
    │x        │- *  -    -    -    -    -    -   *-    -    -    -    -    -    #    -    -    -    -    -    -#   │
    │)        │                   #                             *                              *                   │
    │         │   *                             *                                #                           #     │
    │         │                    #                           #  *                           *                    │
    │         │     *                          *                                  #                          #     │
    │         │                     #                         #    *                         *                     │
    │         │      *                        *                                    #                        #      │
    │         │                      #                       #      *                       *                      │
    │         │      *                       *                                      #                      #       │
    │         │                       #     *               #        *               #     *                       │
    │         │       *                #                   #          *                   *               #        │
    │         │         *                  *                                          #                  #         │
    │         │                        #                  #            *                 *                         │
    │         │          *                *              #              *              #                #          │
    │         │           *              *                                              *              #           │
    │         │                        *  #            #                 *             * #                         │
    │         │           *            *   #           #                  *           *   #          #             │
    │         │             *         *     #         #                    *         *     #         #             │
    │         │              **      *       #       #                      *       *       #      ##              │
    │ -9.99e-1│               * *****         #######                        *******         #### #                │
    ├─────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │         │-5.00                                                                                           5.00│
    │         │                                                 x                                                  │
    └─────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
