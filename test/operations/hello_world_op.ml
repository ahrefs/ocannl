open Base
open Ocannl
module Tn = Ir.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL

module type Backend = Ir.Backend_intf.Backend

let%expect_test "Hello World" =
  Tensor.unsafe_reinitialize ();
  Stdio.printf "Hello World!\n";
  [%expect {| Hello World! |}]

let%expect_test "Pointwise multiplication dims 1" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event
       and type optimize_ctx = Backend.optimize_ctx)
  in

  (* "Hey" is inferred to be a scalar. *)
  let%op y = 2 *. "hey" 7.0 in
  ignore (Train.forward_once backend y);

  Train.printf ~here:[%here] ~with_code:false ~with_grad:false y;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:31:21
    ┌────────────────────┐
    │[3]: *._y shape 0:1 │
    │┌┬─────────┐        │
    │││axis 0   │        │
    │├┼─────────┤        │
    │││ 1.40e+1 │        │
    │└┴─────────┘        │
    └────────────────────┘
    |}]

let%expect_test "Matrix multiplication dims 1x1" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event
       and type optimize_ctx = Backend.optimize_ctx)
  in

  (* Hey is inferred to be a matrix because of matrix multiplication [*]. *)
  let%op y = ("hey" 7.0 * 'q' 2.0) + 'p' 1.0 in
  ignore (Train.forward_once backend y);
  (* Punning for ["hey"] above introduced the [hey] identifier. *)
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hey;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:61:21
    ┌────────────────────────┐
    │[0]: hey shape 1:1->0:1 │
    │┌──────┬──────┐         │
    ││      │axis 1│         │
    │├──────┼──────┤         │
    ││axis 0│ 7.00 │         │
    │└──────┴──────┘         │
    └────────────────────────┘
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false y;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:74:21
    ┌───────────────────┐
    │[6]: +_y shape 0:1 │
    │┌┬─────────┐       │
    │││axis 0   │       │
    │├┼─────────┤       │
    │││ 1.50e+1 │       │
    │└┴─────────┘       │
    └───────────────────┘
    |}]

let%expect_test "Print tensor too early" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let _print_tensor = Train.printf ~with_code:false ~with_grad:false in

  let%op a = [| 1.; 2.; 3.; 4. |] in
  let%op b = [| 2.; 3.; 4.; 5. |] in
  Tensor.print ~here:[%here] ~force:false ~with_code:false ~with_grad:false `Inline a;
  Tensor.print ~here:[%here] ~force:false ~with_code:false ~with_grad:false `Inline b;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:95:21
    [0]: 1,2,3,4_a shape 0:4|  <not-in-yet>

    HERE: test/operations/hello_world_op.ml:96:21
    [1]: 2,3,4,5_b shape 0:4|  <not-in-yet>
    |}];
  let%op c = a *. b in

  ignore (Train.forward_once (module Backend) c);
  Train.printf ~here:[%here] c;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:108:21
    ┌─────────────────────────────────┐
    │[2]: *._c shape 0:4|             │
    │┌┬──────────────────────────────┐│
    │││axis 0                        ││
    │├┼──────────────────────────────┤│
    │││ 2.00  6.00  1.20e+1  2.00e+1 ││
    │└┴──────────────────────────────┘│
    └─────────────────────────────────┘
    |}]

let%expect_test "Print constant tensor" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event
       and type optimize_ctx = Backend.optimize_ctx)
  in

  let%op hey = [ (1, 2, 3); (4, 5, 6) ] in
  ignore (Train.forward_once backend hey);
  (* ignore (failwith @@ Tn.debug_memory_mode hey.value.memory_mode); *)
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline hey;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:137:21
    [0]: 1,2,3,4,5..._hey shape 1:3->0:2  [
       1.00 , 2.00 , 3.00
      ;  4.00 , 5.00 , 6.00
    ]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hey;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:146:21
    ┌─────────────────────────────────────┐
    │[0]: 1,2,3,4,5..._hey shape 1:3->0:2 │
    │┌──────┬──────────────────┐          │
    ││      │axis 1            │          │
    │├──────┼──────────────────┤          │
    ││axis 0│ 1.00  2.00  3.00 │          │
    ││      │ 4.00  5.00  6.00 │          │
    │└──────┴──────────────────┘          │
    └─────────────────────────────────────┘
    |}];
  let%op hoo = [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |] in
  ignore (Train.forward_once backend hoo);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline hoo;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:162:21
    [1]: 1,2,3,4,5..._hoo shape 0:2|1:3  [|
      [ 1.00 ; 2.00 ; 3.00 ]
      ; [ 4.00 ; 5.00 ; 6.00 ]
    |]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hoo;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:171:21
    ┌────────────────────────────────────┐
    │[1]: 1,2,3,4,5..._hoo shape 0:2|1:3 │
    │┌──────┬──────────────────┐         │
    ││      │axis 1            │         │
    │├──────┼──────────────────┤         │
    ││axis 0│ 1.00  2.00  3.00 │         │
    ││      │ 4.00  5.00  6.00 │         │
    │└──────┴──────────────────┘         │
    └────────────────────────────────────┘
    |}];
  let%op hey2 =
    [
      ((1, 2, 3), (4, 5, 6));
      ((7, 8, 9), (10, 11, 12));
      ((13, 14, 15), (16, 17, 18));
      ((19, 20, 21), (22, 23, 24));
    ]
  in
  ignore (Train.forward_once backend hey2);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false @@ hey2;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:194:21
    ┌────────────────────────────────────────────────────────────────┐
    │[2]: 1,2,3,4,5..._hey2 shape 1:2,2:3->0:4                       │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 1                      │1 @ 1                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 0│ 1.00     2.00     3.00    │ 4.00     5.00     6.00    ││
    ││      │ 7.00     8.00     9.00    │ 1.00e+1  1.10e+1  1.20e+1 ││
    ││      │ 1.30e+1  1.40e+1  1.50e+1 │ 1.60e+1  1.70e+1  1.80e+1 ││
    ││      │ 1.90e+1  2.00e+1  2.10e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hey2;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:211:21
    ┌────────────────────────────────────────────────────────────────┐
    │[2]: 1,2,3,4,5..._hey2 shape 1:2,2:3->0:4                       │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 1                      │1 @ 1                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 0│ 1.00     2.00     3.00    │ 4.00     5.00     6.00    ││
    ││      │ 7.00     8.00     9.00    │ 1.00e+1  1.10e+1  1.20e+1 ││
    ││      │ 1.30e+1  1.40e+1  1.50e+1 │ 1.60e+1  1.70e+1  1.80e+1 ││
    ││      │ 1.90e+1  2.00e+1  2.10e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘
    |}];
  let%op hoo2 =
    [|
      [ [ 1; 2; 3 ]; [ 4; 5; 6 ] ];
      [ [ 7; 8; 9 ]; [ 10; 11; 12 ] ];
      [ [ 13; 14; 15 ]; [ 16; 17; 18 ] ];
      [ [ 19; 20; 21 ]; [ 22; 23; 24 ] ];
    |]
  in
  ignore (Train.forward_once backend hoo2);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline hoo2;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:237:21
    [3]: 1,2,3,4,5..._hoo2 shape 0:4|1:2,2:3  [|
      [ [ 1.00 ; 2.00 ; 3.00 ] ; [ 4.00 ; 5.00 ; 6.00 ] ]
      ; [ [ 7.00 ; 8.00 ; 9.00 ] ; [ 10.00 ; 11.00 ; 12.00 ] ]
      ; [ [ 13.00 ; 14.00 ; 15.00 ] ; [ 16.00 ; 17.00 ; 18.00 ] ]
      ; [ [ 19.00 ; 20.00 ; 21.00 ] ; [ 22.00 ; 23.00 ; 24.00 ] ]
    |]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hoo2;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:248:21
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: 1,2,3,4,5..._hoo2 shape 0:4|1:2,2:3                                                                       │
    │┌──────┬──────────────────┬───────────────────────────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0             │1 @ 0                      │2 @ 0                      │3 @ 0                      ││
    ││      │axis 2            │axis 2                     │axis 2                     │axis 2                     ││
    │├──────┼──────────────────┼───────────────────────────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 1.00  2.00  3.00 │ 7.00     8.00     9.00    │ 1.30e+1  1.40e+1  1.50e+1 │ 1.90e+1  2.00e+1  2.10e+1 ││
    ││      │ 4.00  5.00  6.00 │ 1.00e+1  1.10e+1  1.20e+1 │ 1.60e+1  1.70e+1  1.80e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴──────────────────┴───────────────────────────┴───────────────────────────┴───────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo =
    [|
      [| [ 1; 2; 3 ]; [ 4; 5; 6 ] |];
      [| [ 7; 8; 9 ]; [ 10; 11; 12 ] |];
      [| [ 13; 14; 15 ]; [ 16; 17; 18 ] |];
      [| [ 19; 20; 21 ]; [ 22; 23; 24 ] |];
    |]
  in
  ignore (Train.forward_once backend heyhoo);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline heyhoo;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:272:21
    [4]: 1,2,3,4,5..._heyhoo shape 0:4,1:2|2:3  [|
      [| [ 1.00 ; 2.00 ; 3.00 ] ; [ 4.00 ; 5.00 ; 6.00 ] |]
      ; [| [ 7.00 ; 8.00 ; 9.00 ] ; [ 10.00 ; 11.00 ; 12.00 ] |]
      ; [| [ 13.00 ; 14.00 ; 15.00 ] ; [ 16.00 ; 17.00 ; 18.00 ] |]
      ; [| [ 19.00 ; 20.00 ; 21.00 ] ; [ 22.00 ; 23.00 ; 24.00 ] |]
    |]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false heyhoo;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:283:21
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: 1,2,3,4,5..._heyhoo shape 0:4,1:2|2:3                                                                     │
    │┌──────┬──────────────────┬───────────────────────────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0             │1 @ 0                      │2 @ 0                      │3 @ 0                      ││
    ││      │axis 2            │axis 2                     │axis 2                     │axis 2                     ││
    │├──────┼──────────────────┼───────────────────────────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 1.00  2.00  3.00 │ 7.00     8.00     9.00    │ 1.30e+1  1.40e+1  1.50e+1 │ 1.90e+1  2.00e+1  2.10e+1 ││
    ││      │ 4.00  5.00  6.00 │ 1.00e+1  1.10e+1  1.20e+1 │ 1.60e+1  1.70e+1  1.80e+1 │ 2.20e+1  2.30e+1  2.40e+1 ││
    │└──────┴──────────────────┴───────────────────────────┴───────────────────────────┴───────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo2 =
    [|
      [| [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] |];
      [| [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] |];
      [| [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] |];
      [| [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] |];
    |]
  in
  ignore (Train.forward_once backend heyhoo2);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline heyhoo2;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:307:21
    [5]: 1,31,2,32,3..._heyhoo2 shape 0:4,1:2|2:3,3:2  [|
      [|
        [ [ 1.00 ; 31.00 ] ; [ 2.00 ; 32.00 ] ; [ 3.00 ; 33.00 ] ]
        ; [ [ 4.00 ; 34.00 ] ; [ 5.00 ; 35.00 ] ; [ 6.00 ; 36.00 ] ]
      |]
      ; [|
        [ [ 7.00 ; 37.00 ] ; [ 8.00 ; 38.00 ] ; [ 9.00 ; 39.00 ] ]
        ; [ [ 10.00 ; 40.00 ] ; [ 11.00 ; 41.00 ] ; [ 12.00 ; 42.00 ] ]
      |]
      ; [|
        [ [ 13.00 ; 43.00 ] ; [ 14.00 ; 44.00 ] ; [ 15.00 ; 45.00 ] ]
        ; [ [ 16.00 ; 46.00 ] ; [ 17.00 ; 47.00 ] ; [ 18.00 ; 48.00 ] ]
      |]
      ; [|
        [ [ 19.00 ; 49.00 ] ; [ 20.00 ; 50.00 ] ; [ 21.00 ; 51.00 ] ]
        ; [ [ 22.00 ; 52.00 ] ; [ 23.00 ; 53.00 ] ; [ 24.00 ; 54.00 ] ]
      |]
    |]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false heyhoo2;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:330:21
    ┌──────────────────────────────────────────────────┐
    │[5]: 1,31,2,32,3..._heyhoo2 shape 0:4,1:2|2:3,3:2 │
    │┌──────┬──────────────────┬──────────────────┐    │
    ││      │0 @ 1             │1 @ 1             │    │
    ││      │axis 3            │axis 3            │    │
    │├──────┼──────────────────┼──────────────────┤    │
    ││0 @ 0 │ 1.00  3.10e+1    │ 4.00  3.40e+1    │    │
    ││axis 2│ 2.00  3.20e+1    │ 5.00  3.50e+1    │    │
    ││      │ 3.00  3.30e+1    │ 6.00  3.60e+1    │    │
    │├──────┼──────────────────┼──────────────────┤    │
    ││1 @ 0 │ 7.00  3.70e+1    │ 1.00e+1  4.00e+1 │    │
    ││axis 2│ 8.00  3.80e+1    │ 1.10e+1  4.10e+1 │    │
    ││      │ 9.00  3.90e+1    │ 1.20e+1  4.20e+1 │    │
    │├──────┼──────────────────┼──────────────────┤    │
    ││2 @ 0 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 │    │
    ││axis 2│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 │    │
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 │    │
    │├──────┼──────────────────┼──────────────────┤    │
    ││3 @ 0 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 │    │
    ││axis 2│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 │    │
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 │    │
    │└──────┴──────────────────┴──────────────────┘    │
    └──────────────────────────────────────────────────┘
    |}];
  let%op heyhoo3 =
    [|
      [|
        [ [ [ 1; 31 ]; [ 2; 32 ]; [ 3; 33 ] ]; [ [ 4; 34 ]; [ 5; 35 ]; [ 6; 36 ] ] ];
        [ [ [ 7; 37 ]; [ 8; 38 ]; [ 9; 39 ] ]; [ [ 10; 40 ]; [ 11; 41 ]; [ 12; 42 ] ] ];
      |];
      [|
        [ [ [ 13; 43 ]; [ 14; 44 ]; [ 15; 45 ] ]; [ [ 16; 46 ]; [ 17; 47 ]; [ 18; 48 ] ] ];
        [ [ [ 19; 49 ]; [ 20; 50 ]; [ 21; 51 ] ]; [ [ 22; 52 ]; [ 23; 53 ]; [ 24; 54 ] ] ];
      |];
    |]
  in
  ignore (Train.forward_once backend heyhoo3);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline heyhoo3;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:371:21
    [6]: 1,31,2,32,3..._heyhoo3 shape 0:2,1:2|2:2,3:3,4:2  [|
      [|
        [
          [ [ 1.00 ; 31.00 ] ; [ 2.00 ; 32.00 ] ; [ 3.00 ; 33.00 ] ]
          ; [ [ 4.00 ; 34.00 ] ; [ 5.00 ; 35.00 ] ; [ 6.00 ; 36.00 ] ]
        ]
        ; [
          [ [ 7.00 ; 37.00 ] ; [ 8.00 ; 38.00 ] ; [ 9.00 ; 39.00 ] ]
          ; [ [ 10.00 ; 40.00 ] ; [ 11.00 ; 41.00 ] ; [ 12.00 ; 42.00 ] ]
        ]
      |]
      ; [|
        [
          [ [ 13.00 ; 43.00 ] ; [ 14.00 ; 44.00 ] ; [ 15.00 ; 45.00 ] ]
          ; [ [ 16.00 ; 46.00 ] ; [ 17.00 ; 47.00 ] ; [ 18.00 ; 48.00 ] ]
        ]
        ; [
          [ [ 19.00 ; 49.00 ] ; [ 20.00 ; 50.00 ] ; [ 21.00 ; 51.00 ] ]
          ; [ [ 22.00 ; 52.00 ] ; [ 23.00 ; 53.00 ] ; [ 24.00 ; 54.00 ] ]
        ]
      |]
    |]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false heyhoo3;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:398:21
    ┌──────────────────────────────────────────────────────┐
    │[6]: 1,31,2,32,3..._heyhoo3 shape 0:2,1:2|2:2,3:3,4:2 │
    │┌──────┬───────────────┬──────────────────┐           │
    ││0 @ 0 │0 @ 2          │1 @ 2             │           │
    ││      │axis 4         │axis 4            │           │
    │├──────┼───────────────┼──────────────────┤           │
    ││0 @ 1 │ 1.00  3.10e+1 │ 4.00  3.40e+1    │           │
    ││axis 3│ 2.00  3.20e+1 │ 5.00  3.50e+1    │           │
    ││      │ 3.00  3.30e+1 │ 6.00  3.60e+1    │           │
    │├──────┼───────────────┼──────────────────┤           │
    ││1 @ 1 │ 7.00  3.70e+1 │ 1.00e+1  4.00e+1 │           │
    ││axis 3│ 8.00  3.80e+1 │ 1.10e+1  4.10e+1 │           │
    ││      │ 9.00  3.90e+1 │ 1.20e+1  4.20e+1 │           │
    │└──────┴───────────────┴──────────────────┘           │
    ├──────────────────────────────────────────────────────┤
    │┌──────┬──────────────────┬──────────────────┐        │
    ││1 @ 0 │0 @ 2             │1 @ 2             │        │
    ││      │axis 4            │axis 4            │        │
    │├──────┼──────────────────┼──────────────────┤        │
    ││0 @ 1 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 │        │
    ││axis 3│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 │        │
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 │        │
    │├──────┼──────────────────┼──────────────────┤        │
    ││1 @ 1 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 │        │
    ││axis 3│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 │        │
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 │        │
    │└──────┴──────────────────┴──────────────────┘        │
    └──────────────────────────────────────────────────────┘
    |}];
  let%op heyhoo4 =
    [|
      [
        [ [ (1, 31); (2, 32); (3, 33) ]; [ (4, 34); (5, 35); (6, 36) ] ];
        [ [ (7, 37); (8, 38); (9, 39) ]; [ (10, 40); (11, 41); (12, 42) ] ];
      ];
      [
        [ [ (13, 43); (14, 44); (15, 45) ]; [ (16, 46); (17, 47); (18, 48) ] ];
        [ [ (19, 49); (20, 50); (21, 51) ]; [ (22, 52); (23, 53); (24, 54) ] ];
      ];
    |]
  in
  ignore (Train.forward_once backend heyhoo4);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false ~style:`Inline heyhoo4;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:444:21
    [7]: 1,31,2,32,3..._heyhoo4 shape 0:2|4:2->1:2,2:2,3:3  [|
      [
        [
          [  1.00 , 31.00  ;  2.00 , 32.00  ;  3.00 , 33.00  ]
          ; [  4.00 , 34.00  ;  5.00 , 35.00  ;  6.00 , 36.00  ]
        ]
        ; [
          [  7.00 , 37.00  ;  8.00 , 38.00  ;  9.00 , 39.00  ]
          ; [  10.00 , 40.00  ;  11.00 , 41.00  ;  12.00 , 42.00  ]
        ]
      ]
      ; [
        [
          [  13.00 , 43.00  ;  14.00 , 44.00  ;  15.00 , 45.00  ]
          ; [  16.00 , 46.00  ;  17.00 , 47.00  ;  18.00 , 48.00  ]
        ]
        ; [
          [  19.00 , 49.00  ;  20.00 , 50.00  ;  21.00 , 51.00  ]
          ; [  22.00 , 52.00  ;  23.00 , 53.00  ;  24.00 , 54.00  ]
        ]
      ]
    |]
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false heyhoo4;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:471:21
    ┌───────────────────────────────────────────────────────┐
    │[7]: 1,31,2,32,3..._heyhoo4 shape 0:2|4:2->1:2,2:2,3:3 │
    │┌──────┬───────────────┬──────────────────┐            │
    ││0 @ 0 │0 @ 2          │1 @ 2             │            │
    ││      │axis 4         │axis 4            │            │
    │├──────┼───────────────┼──────────────────┤            │
    ││0 @ 1 │ 1.00  3.10e+1 │ 4.00  3.40e+1    │            │
    ││axis 3│ 2.00  3.20e+1 │ 5.00  3.50e+1    │            │
    ││      │ 3.00  3.30e+1 │ 6.00  3.60e+1    │            │
    │├──────┼───────────────┼──────────────────┤            │
    ││1 @ 1 │ 7.00  3.70e+1 │ 1.00e+1  4.00e+1 │            │
    ││axis 3│ 8.00  3.80e+1 │ 1.10e+1  4.10e+1 │            │
    ││      │ 9.00  3.90e+1 │ 1.20e+1  4.20e+1 │            │
    │└──────┴───────────────┴──────────────────┘            │
    ├───────────────────────────────────────────────────────┤
    │┌──────┬──────────────────┬──────────────────┐         │
    ││1 @ 0 │0 @ 2             │1 @ 2             │         │
    ││      │axis 4            │axis 4            │         │
    │├──────┼──────────────────┼──────────────────┤         │
    ││0 @ 1 │ 1.30e+1  4.30e+1 │ 1.60e+1  4.60e+1 │         │
    ││axis 3│ 1.40e+1  4.40e+1 │ 1.70e+1  4.70e+1 │         │
    ││      │ 1.50e+1  4.50e+1 │ 1.80e+1  4.80e+1 │         │
    │├──────┼──────────────────┼──────────────────┤         │
    ││1 @ 1 │ 1.90e+1  4.90e+1 │ 2.20e+1  5.20e+1 │         │
    ││axis 3│ 2.00e+1  5.00e+1 │ 2.30e+1  5.30e+1 │         │
    ││      │ 2.10e+1  5.10e+1 │ 2.40e+1  5.40e+1 │         │
    │└──────┴──────────────────┴──────────────────┘         │
    └───────────────────────────────────────────────────────┘
    |}]

let%expect_test "Matrix multiplication dims 2x3" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event
       and type optimize_ctx = Backend.optimize_ctx)
  in

  (* Hey is inferred to be a matrix. *)
  let%op y = ("hey" 7.0 * [ 2; 3 ]) + [ 4; 5; 6 ] in
  ignore (Train.forward_once backend y);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hey;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:520:21
    ┌────────────────────────┐
    │[0]: hey shape 1:2->0:3 │
    │┌──────┬────────────┐   │
    ││      │axis 1      │   │
    │├──────┼────────────┤   │
    ││axis 0│ 7.00  7.00 │   │
    ││      │ 7.00  7.00 │   │
    ││      │ 7.00  7.00 │   │
    │└──────┴────────────┘   │
    └────────────────────────┘
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false y;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:535:21
    ┌──────────────────────────────┐
    │[6]: +_y shape 0:3            │
    │┌┬───────────────────────────┐│
    │││axis 0                     ││
    │├┼───────────────────────────┤│
    │││ 3.90e+1  4.00e+1  4.10e+1 ││
    │└┴───────────────────────────┘│
    └──────────────────────────────┘
    |}]

let%expect_test "Big matrix" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event
       and type optimize_ctx = Backend.optimize_ctx)
  in

  (* Hey is inferred to be a matrix. *)
  let hey = TDSL.param ~value:0.5 "hey" in
  let zero_to_twenty = TDSL.range 20 in
  let y = TDSL.O.((hey * zero_to_twenty) + zero_to_twenty) in
  ignore (Train.forward_once backend y);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hey;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:566:21
    ┌──────────────────────────────────────────────────┐
    │[0]: hey shape 1:21->0:21                         │
    │┌──────┬─────────────────────────────────────────┐│
    ││      │axis 1                                   ││
    │├──────┼─────────────────────────────────────────┤│
    ││axis 0│ 5.00e-1  5.00e-1  ...  5.00e-1  5.00e-1 ││
    ││      │ 5.00e-1  5.00e-1  ...  5.00e-1  5.00e-1 ││
    ││      │ ...      ...      ...  ...      ...     ││
    ││      │ 5.00e-1  5.00e-1  ...  5.00e-1  5.00e-1 ││
    ││      │ 5.00e-1  5.00e-1  ...  5.00e-1  5.00e-1 ││
    │└──────┴─────────────────────────────────────────┘│
    └──────────────────────────────────────────────────┘
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false y;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:583:21
    ┌────────────────────────────────────────────┐
    │[5]: + shape 0:21                           │
    │┌┬─────────────────────────────────────────┐│
    │││axis 0                                   ││
    │├┼─────────────────────────────────────────┤│
    │││ 1.05e+2  1.06e+2  ...  1.24e+2  1.25e+2 ││
    │└┴─────────────────────────────────────────┘│
    └────────────────────────────────────────────┘
    |}]

let%expect_test "Very big tensor" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event
       and type optimize_ctx = Backend.optimize_ctx)
  in

  let hey =
    TDSL.range_of_shape ~batch_dims:[ 6 ] ~input_dims:[ 7; 8; 9 ] ~output_dims:[ 10; 11 ] ()
  in
  let%op hoo = (hey * (1 + 1)) - 10 in
  Train.set_hosted hey.value;
  ignore (Train.forward_once backend hoo);
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hey;
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:615:21
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r6x10x11x7x8x9 shape 0:6|3:7,4:8,5:9->1:10,2:11                                                                                                                                   │
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││0 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 1 │ 0.00     1.00     ...  7.00     8.00    │ 9.00     1.00e+1  ...  1.60e+1  1.70e+1 │ ...  │ 5.40e+1  5.50e+1  ...  6.10e+1  6.20e+1 │ 6.30e+1  6.40e+1  ...  7.00e+1  7.10e+1 ││
    ││axis 2│ 5.04e+2  5.05e+2  ...  5.11e+2  5.12e+2 │ 5.13e+2  5.14e+2  ...  5.20e+2  5.21e+2 │      │ 5.58e+2  5.59e+2  ...  5.65e+2  5.66e+2 │ 5.67e+2  5.68e+2  ...  5.74e+2  5.75e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 4.53e+3  4.53e+3  ...  4.54e+3  4.54e+3 │ 4.54e+3  4.54e+3  ...  4.55e+3  4.55e+3 │      │ 4.59e+3  4.59e+3  ...  4.59e+3  4.59e+3 │ 4.59e+3  4.60e+3  ...  4.60e+3  4.60e+3 ││
    ││      │ 5.04e+3  5.04e+3  ...  5.04e+3  5.04e+3 │ 5.04e+3  5.05e+3  ...  5.05e+3  5.05e+3 │      │ 5.09e+3  5.09e+3  ...  5.10e+3  5.10e+3 │ 5.10e+3  5.10e+3  ...  5.11e+3  5.11e+3 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 1 │ 5.54e+3  5.54e+3  ...  5.55e+3  5.55e+3 │ 5.55e+3  5.55e+3  ...  5.56e+3  5.56e+3 │ ...  │ 5.59e+3  5.59e+3  ...  5.60e+3  5.60e+3 │ 5.60e+3  5.60e+3  ...  5.61e+3  5.61e+3 ││
    ││axis 2│ 6.04e+3  6.04e+3  ...  6.05e+3  6.05e+3 │ 6.05e+3  6.05e+3  ...  6.06e+3  6.06e+3 │      │ 6.10e+3  6.10e+3  ...  6.10e+3  6.11e+3 │ 6.11e+3  6.11e+3  ...  6.11e+3  6.11e+3 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.00e+4  1.00e+4  ...  1.00e+4  1.00e+4 │ 1.00e+4  1.00e+4  ...  1.00e+4  1.00e+4 │      │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 │ 1.01e+4  1.01e+4  ...  1.01e+4  1.01e+4 ││
    ││      │ 1.05e+4  1.05e+4  ...  1.05e+4  1.05e+4 │ 1.05e+4  1.05e+4  ...  1.06e+4  1.06e+4 │      │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 │ 1.06e+4  1.06e+4  ...  1.06e+4  1.06e+4 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
    ││axis 2│                                         │                                         │      │                                         │                                         ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││8 @ 1 │ 4.43e+4  4.43e+4  ...  4.43e+4  4.43e+4 │ 4.43e+4  4.43e+4  ...  4.43e+4  4.43e+4 │ ...  │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 │ 4.44e+4  4.44e+4  ...  4.44e+4  4.44e+4 ││
    ││axis 2│ 4.48e+4  4.48e+4  ...  4.48e+4  4.48e+4 │ 4.48e+4  4.48e+4  ...  4.48e+4  4.48e+4 │      │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 │ 4.49e+4  4.49e+4  ...  4.49e+4  4.49e+4 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 4.88e+4  4.88e+4  ...  4.88e+4  4.88e+4 │ 4.88e+4  4.88e+4  ...  4.89e+4  4.89e+4 │      │ 4.89e+4  4.89e+4  ...  4.89e+4  4.89e+4 │ 4.89e+4  4.89e+4  ...  4.89e+4  4.89e+4 ││
    ││      │ 4.93e+4  4.93e+4  ...  4.93e+4  4.94e+4 │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 │      │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 │ 4.94e+4  4.94e+4  ...  4.94e+4  4.94e+4 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││9 @ 1 │ 4.98e+4  4.98e+4  ...  4.99e+4  4.99e+4 │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 │ ...  │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 │ 4.99e+4  4.99e+4  ...  4.99e+4  4.99e+4 ││
    ││axis 2│ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │      │ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 │ 5.04e+4  5.04e+4  ...  5.04e+4  5.04e+4 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │      │ 5.44e+4  5.44e+4  ...  5.44e+4  5.44e+4 │ 5.44e+4  5.44e+4  ...  5.45e+4  5.45e+4 ││
    ││      │ 5.49e+4  5.49e+4  ...  5.49e+4  5.49e+4 │ 5.49e+4  5.49e+4  ...  5.49e+4  5.49e+4 │      │ 5.49e+4  5.49e+4  ...  5.49e+4  5.49e+4 │ 5.49e+4  5.50e+4  ...  5.50e+4  5.50e+4 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││1 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 1 │ 5.54e+4  5.54e+4  ...  5.54e+4  5.54e+4 │ 5.54e+4  5.54e+4  ...  5.54e+4  5.54e+4 │ ...  │ 5.54e+4  5.54e+4  ...  5.55e+4  5.55e+4 │ 5.55e+4  5.55e+4  ...  5.55e+4  5.55e+4 ││
    ││axis 2│ 5.59e+4  5.59e+4  ...  5.59e+4  5.59e+4 │ 5.59e+4  5.59e+4  ...  5.59e+4  5.59e+4 │      │ 5.59e+4  5.59e+4  ...  5.60e+4  5.60e+4 │ 5.60e+4  5.60e+4  ...  5.60e+4  5.60e+4 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 5.99e+4  5.99e+4  ...  5.99e+4  5.99e+4 │ 5.99e+4  5.99e+4  ...  5.99e+4  5.99e+4 │      │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 │ 6.00e+4  6.00e+4  ...  6.00e+4  6.00e+4 ││
    ││      │ 6.04e+4  6.04e+4  ...  6.04e+4  6.04e+4 │ 6.04e+4  6.04e+4  ...  6.04e+4  6.04e+4 │      │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 │ 6.05e+4  6.05e+4  ...  6.05e+4  6.05e+4 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 1 │ 6.09e+4  6.09e+4  ...  6.09e+4  6.09e+4 │ 6.09e+4  6.09e+4  ...  6.10e+4  6.10e+4 │ ...  │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 │ 6.10e+4  6.10e+4  ...  6.10e+4  6.10e+4 ││
    ││axis 2│ 6.14e+4  6.14e+4  ...  6.14e+4  6.14e+4 │ 6.14e+4  6.14e+4  ...  6.15e+4  6.15e+4 │      │ 6.15e+4  6.15e+4  ...  6.15e+4  6.15e+4 │ 6.15e+4  6.15e+4  ...  6.15e+4  6.15e+4 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │      │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 │ 6.55e+4  6.55e+4  ...  6.55e+4  6.55e+4 ││
    ││      │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │      │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 │ 6.60e+4  6.60e+4  ...  6.60e+4  6.60e+4 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
    ││axis 2│                                         │                                         │      │                                         │                                         ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││8 @ 1 │ 9.97e+4  9.97e+4  ...  9.97e+4  9.98e+4 │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 │ ...  │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 │ 9.98e+4  9.98e+4  ...  9.98e+4  9.98e+4 ││
    ││axis 2│ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │      │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 │ 1.00e+5  1.00e+5  ...  1.00e+5  1.00e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 ││
    ││      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │      │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 │ 1.04e+5  1.04e+5  ...  1.04e+5  1.04e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││9 @ 1 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ ...  │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 ││
    ││axis 2│ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │      │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 │ 1.05e+5  1.05e+5  ...  1.05e+5  1.05e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.09e+5  1.09e+5  ...  1.09e+5  1.09e+5 │ 1.09e+5  1.09e+5  ...  1.09e+5  1.09e+5 │      │ 1.09e+5  1.09e+5  ...  1.09e+5  1.09e+5 │ 1.09e+5  1.09e+5  ...  1.09e+5  1.09e+5 ││
    ││      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │      │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 │ 1.10e+5  1.10e+5  ...  1.10e+5  1.10e+5 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                                                                                                                   │
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││4 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 1 │ 2.21e+5  2.21e+5  ...  2.21e+5  2.21e+5 │ 2.21e+5  2.21e+5  ...  2.21e+5  2.21e+5 │ ...  │ 2.21e+5  2.21e+5  ...  2.21e+5  2.21e+5 │ 2.21e+5  2.21e+5  ...  2.21e+5  2.21e+5 ││
    ││axis 2│ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │      │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 │ 2.22e+5  2.22e+5  ...  2.22e+5  2.22e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 ││
    ││      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │      │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 │ 2.26e+5  2.26e+5  ...  2.26e+5  2.26e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 1 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ ...  │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 ││
    ││axis 2│ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │      │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 │ 2.27e+5  2.27e+5  ...  2.27e+5  2.27e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.31e+5  2.31e+5  ...  2.31e+5  2.31e+5 │ 2.31e+5  2.31e+5  ...  2.31e+5  2.31e+5 │      │ 2.31e+5  2.31e+5  ...  2.31e+5  2.31e+5 │ 2.31e+5  2.31e+5  ...  2.31e+5  2.31e+5 ││
    ││      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │      │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 │ 2.32e+5  2.32e+5  ...  2.32e+5  2.32e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
    ││axis 2│                                         │                                         │      │                                         │                                         ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││8 @ 1 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ ...  │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 ││
    ││axis 2│ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │      │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 │ 2.66e+5  2.66e+5  ...  2.66e+5  2.66e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.70e+5  2.70e+5  ...  2.70e+5  2.70e+5 │ 2.70e+5  2.70e+5  ...  2.70e+5  2.70e+5 │      │ 2.70e+5  2.70e+5  ...  2.70e+5  2.70e+5 │ 2.70e+5  2.70e+5  ...  2.70e+5  2.70e+5 ││
    ││      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │      │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││9 @ 1 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ ...  │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 │ 2.71e+5  2.71e+5  ...  2.71e+5  2.71e+5 ││
    ││axis 2│ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │      │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 │ 2.72e+5  2.72e+5  ...  2.72e+5  2.72e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 ││
    ││      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │      │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 │ 2.76e+5  2.76e+5  ...  2.76e+5  2.76e+5 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││5 @ 0 │0 @ 4                                    │1 @ 4                                    │~~~~~ │6 @ 4                                    │7 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5│axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 1 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ ...  │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 ││
    ││axis 2│ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │      │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 │ 2.77e+5  2.77e+5  ...  2.77e+5  2.77e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.81e+5  2.81e+5  ...  2.81e+5  2.81e+5 │ 2.81e+5  2.81e+5  ...  2.81e+5  2.81e+5 │      │ 2.81e+5  2.81e+5  ...  2.81e+5  2.81e+5 │ 2.81e+5  2.81e+5  ...  2.81e+5  2.81e+5 ││
    ││      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │      │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 1 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ ...  │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 │ 2.82e+5  2.82e+5  ...  2.82e+5  2.82e+5 ││
    ││axis 2│ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │      │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 │ 2.83e+5  2.83e+5  ...  2.83e+5  2.83e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 ││
    ││      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │      │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 │ 2.87e+5  2.87e+5  ...  2.87e+5  2.87e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││~~~~~ │ ...                                     │ ...                                     │ ...  │ ...                                     │ ...                                     ││
    ││axis 2│                                         │                                         │      │                                         │                                         ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││8 @ 1 │ 3.21e+5  3.21e+5  ...  3.21e+5  3.21e+5 │ 3.21e+5  3.21e+5  ...  3.21e+5  3.21e+5 │ ...  │ 3.21e+5  3.21e+5  ...  3.21e+5  3.21e+5 │ 3.21e+5  3.21e+5  ...  3.21e+5  3.21e+5 ││
    ││axis 2│ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │      │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 │ 3.22e+5  3.22e+5  ...  3.22e+5  3.22e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 ││
    ││      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │      │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 │ 3.26e+5  3.26e+5  ...  3.26e+5  3.26e+5 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││9 @ 1 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ ...  │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 ││
    ││axis 2│ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │      │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 │ 3.27e+5  3.27e+5  ...  3.27e+5  3.27e+5 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 3.31e+5  3.31e+5  ...  3.31e+5  3.31e+5 │ 3.31e+5  3.31e+5  ...  3.31e+5  3.31e+5 │      │ 3.31e+5  3.31e+5  ...  3.31e+5  3.31e+5 │ 3.31e+5  3.31e+5  ...  3.31e+5  3.31e+5 ││
    ││      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │      │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 │ 3.32e+5  3.32e+5  ...  3.32e+5  3.32e+5 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Train.printf ~here:[%here] ~with_code:false ~with_grad:false hoo;
  (* Disable line wrapping for viewing the output. In VSCode: `View: Toggle Word Wrap`. *)
  [%expect
    {|
    HERE: test/operations/hello_world_op.ml:752:21
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: -_hoo shape 0:6|1:10,2:11                                                                                                                                                         │
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││      │0 @ 0                                    │1 @ 0                                    │~~~~~ │4 @ 0                                    │5 @ 0                                    ││
    ││      │axis 2                                   │axis 2                                   │axis 2│axis 2                                   │axis 2                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││axis 1│ 2.53e+5  7.61e+5  ...  4.82e+6  5.33e+6 │ 5.61e+7  5.66e+7  ...  6.07e+7  6.12e+7 │ ...  │ 2.23e+8  2.24e+8  ...  2.28e+8  2.28e+8 │ 2.79e+8  2.80e+8  ...  2.84e+8  2.84e+8 ││
    ││      │ 5.84e+6  6.34e+6  ...  1.04e+7  1.09e+7 │ 6.17e+7  6.22e+7  ...  6.62e+7  6.68e+7 │      │ 2.29e+8  2.29e+8  ...  2.33e+8  2.34e+8 │ 2.85e+8  2.85e+8  ...  2.89e+8  2.90e+8 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 4.49e+7  4.54e+7  ...  4.95e+7  5.00e+7 │ 1.00e+8  1.01e+8  ...  1.05e+8  1.05e+8 │      │ 2.68e+8  2.69e+8  ...  2.73e+8  2.73e+8 │ 3.24e+8  3.24e+8  ...  3.28e+8  3.29e+8 ││
    ││      │ 5.05e+7  5.10e+7  ...  5.51e+7  5.56e+7 │ 1.06e+8  1.06e+8  ...  1.11e+8  1.11e+8 │      │ 2.74e+8  2.74e+8  ...  2.78e+8  2.79e+8 │ 3.29e+8  3.30e+8  ...  3.34e+8  3.35e+8 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
