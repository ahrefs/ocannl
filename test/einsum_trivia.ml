open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module NTDSL = Operation.NTDSL
module Rand = Arrayjit.Rand.Lib

module type Backend = Arrayjit.Backend_intf.Backend

let%expect_test "einsum1 permute axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => o|b->i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:4|2:2->1:3                                                                                                      │
    │┌──────┬─────────────────────────────┬─────────────────────────────┬─────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0                        │1 @ 0                        │2 @ 0                        │3 @ 0                           ││
    ││      │axis 2                       │axis 2                       │axis 2                       │axis 2                          ││
    │├──────┼─────────────────────────────┼─────────────────────────────┼─────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.200000000e+1 │ 3.000000000  1.500000000e+1 │ 6.000000000  1.800000000e+1 │ 9.000000000     2.100000000e+1 ││
    ││      │ 1.000000000  1.300000000e+1 │ 4.000000000  1.600000000e+1 │ 7.000000000  1.900000000e+1 │ 1.000000000e+1  2.200000000e+1 ││
    ││      │ 2.000000000  1.400000000e+1 │ 5.000000000  1.700000000e+1 │ 8.000000000  2.000000000e+1 │ 1.100000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────┴─────────────────────────────┴─────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => cf|ae->db" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                                                                                                                                                            │
    │┌──────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                           │1 @ 4                                                                           │2 @ 4                                                                           │3 @ 4                                                                           ││
    ││      │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000     1.000000000     2.000000000     3.000000000     4.000000000    │ 5.000000000     6.000000000     7.000000000     8.000000000     9.000000000    │ 1.000000000e+1  1.100000000e+1  1.200000000e+1  1.300000000e+1  1.400000000e+1 │ 1.500000000e+1  1.600000000e+1  1.700000000e+1  1.800000000e+1  1.900000000e+1 ││
    ││axis 3│ 2.000000000e+1  2.100000000e+1  2.200000000e+1  2.300000000e+1  2.400000000e+1 │ 2.500000000e+1  2.600000000e+1  2.700000000e+1  2.800000000e+1  2.900000000e+1 │ 3.000000000e+1  3.100000000e+1  3.200000000e+1  3.300000000e+1  3.400000000e+1 │ 3.500000000e+1  3.600000000e+1  3.700000000e+1  3.800000000e+1  3.900000000e+1 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.000000000e+2  1.010000000e+2  1.020000000e+2  1.030000000e+2  1.040000000e+2 │ 1.050000000e+2  1.060000000e+2  1.070000000e+2  1.080000000e+2  1.090000000e+2 │ 1.100000000e+2  1.110000000e+2  1.120000000e+2  1.130000000e+2  1.140000000e+2 │ 1.150000000e+2  1.160000000e+2  1.170000000e+2  1.180000000e+2  1.190000000e+2 ││
    ││      │ 1.200000000e+2  1.210000000e+2  1.220000000e+2  1.230000000e+2  1.240000000e+2 │ 1.250000000e+2  1.260000000e+2  1.270000000e+2  1.280000000e+2  1.290000000e+2 │ 1.300000000e+2  1.310000000e+2  1.320000000e+2  1.330000000e+2  1.340000000e+2 │ 1.350000000e+2  1.360000000e+2  1.370000000e+2  1.380000000e+2  1.390000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.400000000e+2  1.410000000e+2  1.420000000e+2  1.430000000e+2  1.440000000e+2 │ 1.450000000e+2  1.460000000e+2  1.470000000e+2  1.480000000e+2  1.490000000e+2 │ 1.500000000e+2  1.510000000e+2  1.520000000e+2  1.530000000e+2  1.540000000e+2 │ 1.550000000e+2  1.560000000e+2  1.570000000e+2  1.580000000e+2  1.590000000e+2 ││
    ││axis 3│ 1.600000000e+2  1.610000000e+2  1.620000000e+2  1.630000000e+2  1.640000000e+2 │ 1.650000000e+2  1.660000000e+2  1.670000000e+2  1.680000000e+2  1.690000000e+2 │ 1.700000000e+2  1.710000000e+2  1.720000000e+2  1.730000000e+2  1.740000000e+2 │ 1.750000000e+2  1.760000000e+2  1.770000000e+2  1.780000000e+2  1.790000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 2.400000000e+2  2.410000000e+2  2.420000000e+2  2.430000000e+2  2.440000000e+2 │ 2.450000000e+2  2.460000000e+2  2.470000000e+2  2.480000000e+2  2.490000000e+2 │ 2.500000000e+2  2.510000000e+2  2.520000000e+2  2.530000000e+2  2.540000000e+2 │ 2.550000000e+2  2.560000000e+2  2.570000000e+2  2.580000000e+2  2.590000000e+2 ││
    ││      │ 2.600000000e+2  2.610000000e+2  2.620000000e+2  2.630000000e+2  2.640000000e+2 │ 2.650000000e+2  2.660000000e+2  2.670000000e+2  2.680000000e+2  2.690000000e+2 │ 2.700000000e+2  2.710000000e+2  2.720000000e+2  2.730000000e+2  2.740000000e+2 │ 2.750000000e+2  2.760000000e+2  2.770000000e+2  2.780000000e+2  2.790000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                            │ ...                                                                            │ ...                                                                            │ ...                                                                            ││
    ││axis 3│                                                                                │                                                                                │                                                                                │                                                                                ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.600000000e+2  5.610000000e+2  5.620000000e+2  5.630000000e+2  5.640000000e+2 │ 5.650000000e+2  5.660000000e+2  5.670000000e+2  5.680000000e+2  5.690000000e+2 │ 5.700000000e+2  5.710000000e+2  5.720000000e+2  5.730000000e+2  5.740000000e+2 │ 5.750000000e+2  5.760000000e+2  5.770000000e+2  5.780000000e+2  5.790000000e+2 ││
    ││axis 3│ 5.800000000e+2  5.810000000e+2  5.820000000e+2  5.830000000e+2  5.840000000e+2 │ 5.850000000e+2  5.860000000e+2  5.870000000e+2  5.880000000e+2  5.890000000e+2 │ 5.900000000e+2  5.910000000e+2  5.920000000e+2  5.930000000e+2  5.940000000e+2 │ 5.950000000e+2  5.960000000e+2  5.970000000e+2  5.980000000e+2  5.990000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 6.600000000e+2  6.610000000e+2  6.620000000e+2  6.630000000e+2  6.640000000e+2 │ 6.650000000e+2  6.660000000e+2  6.670000000e+2  6.680000000e+2  6.690000000e+2 │ 6.700000000e+2  6.710000000e+2  6.720000000e+2  6.730000000e+2  6.740000000e+2 │ 6.750000000e+2  6.760000000e+2  6.770000000e+2  6.780000000e+2  6.790000000e+2 ││
    ││      │ 6.800000000e+2  6.810000000e+2  6.820000000e+2  6.830000000e+2  6.840000000e+2 │ 6.850000000e+2  6.860000000e+2  6.870000000e+2  6.880000000e+2  6.890000000e+2 │ 6.900000000e+2  6.910000000e+2  6.920000000e+2  6.930000000e+2  6.940000000e+2 │ 6.950000000e+2  6.960000000e+2  6.970000000e+2  6.980000000e+2  6.990000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.000000000e+2  7.010000000e+2  7.020000000e+2  7.030000000e+2  7.040000000e+2 │ 7.050000000e+2  7.060000000e+2  7.070000000e+2  7.080000000e+2  7.090000000e+2 │ 7.100000000e+2  7.110000000e+2  7.120000000e+2  7.130000000e+2  7.140000000e+2 │ 7.150000000e+2  7.160000000e+2  7.170000000e+2  7.180000000e+2  7.190000000e+2 ││
    ││axis 3│ 7.200000000e+2  7.210000000e+2  7.220000000e+2  7.230000000e+2  7.240000000e+2 │ 7.250000000e+2  7.260000000e+2  7.270000000e+2  7.280000000e+2  7.290000000e+2 │ 7.300000000e+2  7.310000000e+2  7.320000000e+2  7.330000000e+2  7.340000000e+2 │ 7.350000000e+2  7.360000000e+2  7.370000000e+2  7.380000000e+2  7.390000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 8.000000000e+2  8.010000000e+2  8.020000000e+2  8.030000000e+2  8.040000000e+2 │ 8.050000000e+2  8.060000000e+2  8.070000000e+2  8.080000000e+2  8.090000000e+2 │ 8.100000000e+2  8.110000000e+2  8.120000000e+2  8.130000000e+2  8.140000000e+2 │ 8.150000000e+2  8.160000000e+2  8.170000000e+2  8.180000000e+2  8.190000000e+2 ││
    ││      │ 8.200000000e+2  8.210000000e+2  8.220000000e+2  8.230000000e+2  8.240000000e+2 │ 8.250000000e+2  8.260000000e+2  8.270000000e+2  8.280000000e+2  8.290000000e+2 │ 8.300000000e+2  8.310000000e+2  8.320000000e+2  8.330000000e+2  8.340000000e+2 │ 8.350000000e+2  8.360000000e+2  8.370000000e+2  8.380000000e+2  8.390000000e+2 ││
    │└──────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                           │1 @ 4                                                                           │2 @ 4                                                                           │3 @ 4                                                                           ││
    ││      │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 8.400000000e+2  8.410000000e+2  8.420000000e+2  8.430000000e+2  8.440000000e+2 │ 8.450000000e+2  8.460000000e+2  8.470000000e+2  8.480000000e+2  8.490000000e+2 │ 8.500000000e+2  8.510000000e+2  8.520000000e+2  8.530000000e+2  8.540000000e+2 │ 8.550000000e+2  8.560000000e+2  8.570000000e+2  8.580000000e+2  8.590000000e+2 ││
    ││axis 3│ 8.600000000e+2  8.610000000e+2  8.620000000e+2  8.630000000e+2  8.640000000e+2 │ 8.650000000e+2  8.660000000e+2  8.670000000e+2  8.680000000e+2  8.690000000e+2 │ 8.700000000e+2  8.710000000e+2  8.720000000e+2  8.730000000e+2  8.740000000e+2 │ 8.750000000e+2  8.760000000e+2  8.770000000e+2  8.780000000e+2  8.790000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 9.400000000e+2  9.410000000e+2  9.420000000e+2  9.430000000e+2  9.440000000e+2 │ 9.450000000e+2  9.460000000e+2  9.470000000e+2  9.480000000e+2  9.490000000e+2 │ 9.500000000e+2  9.510000000e+2  9.520000000e+2  9.530000000e+2  9.540000000e+2 │ 9.550000000e+2  9.560000000e+2  9.570000000e+2  9.580000000e+2  9.590000000e+2 ││
    ││      │ 9.600000000e+2  9.610000000e+2  9.620000000e+2  9.630000000e+2  9.640000000e+2 │ 9.650000000e+2  9.660000000e+2  9.670000000e+2  9.680000000e+2  9.690000000e+2 │ 9.700000000e+2  9.710000000e+2  9.720000000e+2  9.730000000e+2  9.740000000e+2 │ 9.750000000e+2  9.760000000e+2  9.770000000e+2  9.780000000e+2  9.790000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 9.800000000e+2  9.810000000e+2  9.820000000e+2  9.830000000e+2  9.840000000e+2 │ 9.850000000e+2  9.860000000e+2  9.870000000e+2  9.880000000e+2  9.890000000e+2 │ 9.900000000e+2  9.910000000e+2  9.920000000e+2  9.930000000e+2  9.940000000e+2 │ 9.950000000e+2  9.960000000e+2  9.970000000e+2  9.980000000e+2  9.990000000e+2 ││
    ││axis 3│ 1.000000000e+3  1.001000000e+3  1.002000000e+3  1.003000000e+3  1.004000000e+3 │ 1.005000000e+3  1.006000000e+3  1.007000000e+3  1.008000000e+3  1.009000000e+3 │ 1.010000000e+3  1.011000000e+3  1.012000000e+3  1.013000000e+3  1.014000000e+3 │ 1.015000000e+3  1.016000000e+3  1.017000000e+3  1.018000000e+3  1.019000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.080000000e+3  1.081000000e+3  1.082000000e+3  1.083000000e+3  1.084000000e+3 │ 1.085000000e+3  1.086000000e+3  1.087000000e+3  1.088000000e+3  1.089000000e+3 │ 1.090000000e+3  1.091000000e+3  1.092000000e+3  1.093000000e+3  1.094000000e+3 │ 1.095000000e+3  1.096000000e+3  1.097000000e+3  1.098000000e+3  1.099000000e+3 ││
    ││      │ 1.100000000e+3  1.101000000e+3  1.102000000e+3  1.103000000e+3  1.104000000e+3 │ 1.105000000e+3  1.106000000e+3  1.107000000e+3  1.108000000e+3  1.109000000e+3 │ 1.110000000e+3  1.111000000e+3  1.112000000e+3  1.113000000e+3  1.114000000e+3 │ 1.115000000e+3  1.116000000e+3  1.117000000e+3  1.118000000e+3  1.119000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                            │ ...                                                                            │ ...                                                                            │ ...                                                                            ││
    ││axis 3│                                                                                │                                                                                │                                                                                │                                                                                ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.400000000e+3  1.401000000e+3  1.402000000e+3  1.403000000e+3  1.404000000e+3 │ 1.405000000e+3  1.406000000e+3  1.407000000e+3  1.408000000e+3  1.409000000e+3 │ 1.410000000e+3  1.411000000e+3  1.412000000e+3  1.413000000e+3  1.414000000e+3 │ 1.415000000e+3  1.416000000e+3  1.417000000e+3  1.418000000e+3  1.419000000e+3 ││
    ││axis 3│ 1.420000000e+3  1.421000000e+3  1.422000000e+3  1.423000000e+3  1.424000000e+3 │ 1.425000000e+3  1.426000000e+3  1.427000000e+3  1.428000000e+3  1.429000000e+3 │ 1.430000000e+3  1.431000000e+3  1.432000000e+3  1.433000000e+3  1.434000000e+3 │ 1.435000000e+3  1.436000000e+3  1.437000000e+3  1.438000000e+3  1.439000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.500000000e+3  1.501000000e+3  1.502000000e+3  1.503000000e+3  1.504000000e+3 │ 1.505000000e+3  1.506000000e+3  1.507000000e+3  1.508000000e+3  1.509000000e+3 │ 1.510000000e+3  1.511000000e+3  1.512000000e+3  1.513000000e+3  1.514000000e+3 │ 1.515000000e+3  1.516000000e+3  1.517000000e+3  1.518000000e+3  1.519000000e+3 ││
    ││      │ 1.520000000e+3  1.521000000e+3  1.522000000e+3  1.523000000e+3  1.524000000e+3 │ 1.525000000e+3  1.526000000e+3  1.527000000e+3  1.528000000e+3  1.529000000e+3 │ 1.530000000e+3  1.531000000e+3  1.532000000e+3  1.533000000e+3  1.534000000e+3 │ 1.535000000e+3  1.536000000e+3  1.537000000e+3  1.538000000e+3  1.539000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 1.540000000e+3  1.541000000e+3  1.542000000e+3  1.543000000e+3  1.544000000e+3 │ 1.545000000e+3  1.546000000e+3  1.547000000e+3  1.548000000e+3  1.549000000e+3 │ 1.550000000e+3  1.551000000e+3  1.552000000e+3  1.553000000e+3  1.554000000e+3 │ 1.555000000e+3  1.556000000e+3  1.557000000e+3  1.558000000e+3  1.559000000e+3 ││
    ││axis 3│ 1.560000000e+3  1.561000000e+3  1.562000000e+3  1.563000000e+3  1.564000000e+3 │ 1.565000000e+3  1.566000000e+3  1.567000000e+3  1.568000000e+3  1.569000000e+3 │ 1.570000000e+3  1.571000000e+3  1.572000000e+3  1.573000000e+3  1.574000000e+3 │ 1.575000000e+3  1.576000000e+3  1.577000000e+3  1.578000000e+3  1.579000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.640000000e+3  1.641000000e+3  1.642000000e+3  1.643000000e+3  1.644000000e+3 │ 1.645000000e+3  1.646000000e+3  1.647000000e+3  1.648000000e+3  1.649000000e+3 │ 1.650000000e+3  1.651000000e+3  1.652000000e+3  1.653000000e+3  1.654000000e+3 │ 1.655000000e+3  1.656000000e+3  1.657000000e+3  1.658000000e+3  1.659000000e+3 ││
    ││      │ 1.660000000e+3  1.661000000e+3  1.662000000e+3  1.663000000e+3  1.664000000e+3 │ 1.665000000e+3  1.666000000e+3  1.667000000e+3  1.668000000e+3  1.669000000e+3 │ 1.670000000e+3  1.671000000e+3  1.672000000e+3  1.673000000e+3  1.674000000e+3 │ 1.675000000e+3  1.676000000e+3  1.677000000e+3  1.678000000e+3  1.679000000e+3 ││
    │└──────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                                           │1 @ 4                                                                           │2 @ 4                                                                           │3 @ 4                                                                           ││
    ││      │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.680000000e+3  1.681000000e+3  1.682000000e+3  1.683000000e+3  1.684000000e+3 │ 1.685000000e+3  1.686000000e+3  1.687000000e+3  1.688000000e+3  1.689000000e+3 │ 1.690000000e+3  1.691000000e+3  1.692000000e+3  1.693000000e+3  1.694000000e+3 │ 1.695000000e+3  1.696000000e+3  1.697000000e+3  1.698000000e+3  1.699000000e+3 ││
    ││axis 3│ 1.700000000e+3  1.701000000e+3  1.702000000e+3  1.703000000e+3  1.704000000e+3 │ 1.705000000e+3  1.706000000e+3  1.707000000e+3  1.708000000e+3  1.709000000e+3 │ 1.710000000e+3  1.711000000e+3  1.712000000e+3  1.713000000e+3  1.714000000e+3 │ 1.715000000e+3  1.716000000e+3  1.717000000e+3  1.718000000e+3  1.719000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.780000000e+3  1.781000000e+3  1.782000000e+3  1.783000000e+3  1.784000000e+3 │ 1.785000000e+3  1.786000000e+3  1.787000000e+3  1.788000000e+3  1.789000000e+3 │ 1.790000000e+3  1.791000000e+3  1.792000000e+3  1.793000000e+3  1.794000000e+3 │ 1.795000000e+3  1.796000000e+3  1.797000000e+3  1.798000000e+3  1.799000000e+3 ││
    ││      │ 1.800000000e+3  1.801000000e+3  1.802000000e+3  1.803000000e+3  1.804000000e+3 │ 1.805000000e+3  1.806000000e+3  1.807000000e+3  1.808000000e+3  1.809000000e+3 │ 1.810000000e+3  1.811000000e+3  1.812000000e+3  1.813000000e+3  1.814000000e+3 │ 1.815000000e+3  1.816000000e+3  1.817000000e+3  1.818000000e+3  1.819000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.820000000e+3  1.821000000e+3  1.822000000e+3  1.823000000e+3  1.824000000e+3 │ 1.825000000e+3  1.826000000e+3  1.827000000e+3  1.828000000e+3  1.829000000e+3 │ 1.830000000e+3  1.831000000e+3  1.832000000e+3  1.833000000e+3  1.834000000e+3 │ 1.835000000e+3  1.836000000e+3  1.837000000e+3  1.838000000e+3  1.839000000e+3 ││
    ││axis 3│ 1.840000000e+3  1.841000000e+3  1.842000000e+3  1.843000000e+3  1.844000000e+3 │ 1.845000000e+3  1.846000000e+3  1.847000000e+3  1.848000000e+3  1.849000000e+3 │ 1.850000000e+3  1.851000000e+3  1.852000000e+3  1.853000000e+3  1.854000000e+3 │ 1.855000000e+3  1.856000000e+3  1.857000000e+3  1.858000000e+3  1.859000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.920000000e+3  1.921000000e+3  1.922000000e+3  1.923000000e+3  1.924000000e+3 │ 1.925000000e+3  1.926000000e+3  1.927000000e+3  1.928000000e+3  1.929000000e+3 │ 1.930000000e+3  1.931000000e+3  1.932000000e+3  1.933000000e+3  1.934000000e+3 │ 1.935000000e+3  1.936000000e+3  1.937000000e+3  1.938000000e+3  1.939000000e+3 ││
    ││      │ 1.940000000e+3  1.941000000e+3  1.942000000e+3  1.943000000e+3  1.944000000e+3 │ 1.945000000e+3  1.946000000e+3  1.947000000e+3  1.948000000e+3  1.949000000e+3 │ 1.950000000e+3  1.951000000e+3  1.952000000e+3  1.953000000e+3  1.954000000e+3 │ 1.955000000e+3  1.956000000e+3  1.957000000e+3  1.958000000e+3  1.959000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                            │ ...                                                                            │ ...                                                                            │ ...                                                                            ││
    ││axis 3│                                                                                │                                                                                │                                                                                │                                                                                ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.240000000e+3  2.241000000e+3  2.242000000e+3  2.243000000e+3  2.244000000e+3 │ 2.245000000e+3  2.246000000e+3  2.247000000e+3  2.248000000e+3  2.249000000e+3 │ 2.250000000e+3  2.251000000e+3  2.252000000e+3  2.253000000e+3  2.254000000e+3 │ 2.255000000e+3  2.256000000e+3  2.257000000e+3  2.258000000e+3  2.259000000e+3 ││
    ││axis 3│ 2.260000000e+3  2.261000000e+3  2.262000000e+3  2.263000000e+3  2.264000000e+3 │ 2.265000000e+3  2.266000000e+3  2.267000000e+3  2.268000000e+3  2.269000000e+3 │ 2.270000000e+3  2.271000000e+3  2.272000000e+3  2.273000000e+3  2.274000000e+3 │ 2.275000000e+3  2.276000000e+3  2.277000000e+3  2.278000000e+3  2.279000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 2.340000000e+3  2.341000000e+3  2.342000000e+3  2.343000000e+3  2.344000000e+3 │ 2.345000000e+3  2.346000000e+3  2.347000000e+3  2.348000000e+3  2.349000000e+3 │ 2.350000000e+3  2.351000000e+3  2.352000000e+3  2.353000000e+3  2.354000000e+3 │ 2.355000000e+3  2.356000000e+3  2.357000000e+3  2.358000000e+3  2.359000000e+3 ││
    ││      │ 2.360000000e+3  2.361000000e+3  2.362000000e+3  2.363000000e+3  2.364000000e+3 │ 2.365000000e+3  2.366000000e+3  2.367000000e+3  2.368000000e+3  2.369000000e+3 │ 2.370000000e+3  2.371000000e+3  2.372000000e+3  2.373000000e+3  2.374000000e+3 │ 2.375000000e+3  2.376000000e+3  2.377000000e+3  2.378000000e+3  2.379000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 2.380000000e+3  2.381000000e+3  2.382000000e+3  2.383000000e+3  2.384000000e+3 │ 2.385000000e+3  2.386000000e+3  2.387000000e+3  2.388000000e+3  2.389000000e+3 │ 2.390000000e+3  2.391000000e+3  2.392000000e+3  2.393000000e+3  2.394000000e+3 │ 2.395000000e+3  2.396000000e+3  2.397000000e+3  2.398000000e+3  2.399000000e+3 ││
    ││axis 3│ 2.400000000e+3  2.401000000e+3  2.402000000e+3  2.403000000e+3  2.404000000e+3 │ 2.405000000e+3  2.406000000e+3  2.407000000e+3  2.408000000e+3  2.409000000e+3 │ 2.410000000e+3  2.411000000e+3  2.412000000e+3  2.413000000e+3  2.414000000e+3 │ 2.415000000e+3  2.416000000e+3  2.417000000e+3  2.418000000e+3  2.419000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 2.480000000e+3  2.481000000e+3  2.482000000e+3  2.483000000e+3  2.484000000e+3 │ 2.485000000e+3  2.486000000e+3  2.487000000e+3  2.488000000e+3  2.489000000e+3 │ 2.490000000e+3  2.491000000e+3  2.492000000e+3  2.493000000e+3  2.494000000e+3 │ 2.495000000e+3  2.496000000e+3  2.497000000e+3  2.498000000e+3  2.499000000e+3 ││
    ││      │ 2.500000000e+3  2.501000000e+3  2.502000000e+3  2.503000000e+3  2.504000000e+3 │ 2.505000000e+3  2.506000000e+3  2.507000000e+3  2.508000000e+3  2.509000000e+3 │ 2.510000000e+3  2.511000000e+3  2.512000000e+3  2.513000000e+3  2.514000000e+3 │ 2.515000000e+3  2.516000000e+3  2.517000000e+3  2.518000000e+3  2.519000000e+3 ││
    │└──────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4,1:7|4:2,5:6->2:5,3:3                                                                                                          │
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                │1 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000     1.400000000e+2  ...  5.600000000e+2  7.000000000e+2 │ 2.520000000e+3  2.660000000e+3  ...  3.080000000e+3  3.220000000e+3 ││
    ││axis 3│ 8.400000000e+2  9.800000000e+2  ...  1.400000000e+3  1.540000000e+3 │ 3.360000000e+3  3.500000000e+3  ...  3.920000000e+3  4.060000000e+3 ││
    ││      │ 1.680000000e+3  1.820000000e+3  ...  2.240000000e+3  2.380000000e+3 │ 4.200000000e+3  4.340000000e+3  ...  4.760000000e+3  4.900000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.000000000     1.410000000e+2  ...  5.610000000e+2  7.010000000e+2 │ 2.521000000e+3  2.661000000e+3  ...  3.081000000e+3  3.221000000e+3 ││
    ││axis 3│ 8.410000000e+2  9.810000000e+2  ...  1.401000000e+3  1.541000000e+3 │ 3.361000000e+3  3.501000000e+3  ...  3.921000000e+3  4.061000000e+3 ││
    ││      │ 1.681000000e+3  1.821000000e+3  ...  2.241000000e+3  2.381000000e+3 │ 4.201000000e+3  4.341000000e+3  ...  4.761000000e+3  4.901000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.000000000     1.420000000e+2  ...  5.620000000e+2  7.020000000e+2 │ 2.522000000e+3  2.662000000e+3  ...  3.082000000e+3  3.222000000e+3 ││
    ││axis 3│ 8.420000000e+2  9.820000000e+2  ...  1.402000000e+3  1.542000000e+3 │ 3.362000000e+3  3.502000000e+3  ...  3.922000000e+3  4.062000000e+3 ││
    ││      │ 1.682000000e+3  1.822000000e+3  ...  2.242000000e+3  2.382000000e+3 │ 4.202000000e+3  4.342000000e+3  ...  4.762000000e+3  4.902000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 3.000000000     1.430000000e+2  ...  5.630000000e+2  7.030000000e+2 │ 2.523000000e+3  2.663000000e+3  ...  3.083000000e+3  3.223000000e+3 ││
    ││axis 3│ 8.430000000e+2  9.830000000e+2  ...  1.403000000e+3  1.543000000e+3 │ 3.363000000e+3  3.503000000e+3  ...  3.923000000e+3  4.063000000e+3 ││
    ││      │ 1.683000000e+3  1.823000000e+3  ...  2.243000000e+3  2.383000000e+3 │ 4.203000000e+3  4.343000000e+3  ...  4.763000000e+3  4.903000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 4.000000000     1.440000000e+2  ...  5.640000000e+2  7.040000000e+2 │ 2.524000000e+3  2.664000000e+3  ...  3.084000000e+3  3.224000000e+3 ││
    ││axis 3│ 8.440000000e+2  9.840000000e+2  ...  1.404000000e+3  1.544000000e+3 │ 3.364000000e+3  3.504000000e+3  ...  3.924000000e+3  4.064000000e+3 ││
    ││      │ 1.684000000e+3  1.824000000e+3  ...  2.244000000e+3  2.384000000e+3 │ 4.204000000e+3  4.344000000e+3  ...  4.764000000e+3  4.904000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                │1 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 2.000000000e+1  1.600000000e+2  ...  5.800000000e+2  7.200000000e+2 │ 2.540000000e+3  2.680000000e+3  ...  3.100000000e+3  3.240000000e+3 ││
    ││axis 3│ 8.600000000e+2  1.000000000e+3  ...  1.420000000e+3  1.560000000e+3 │ 3.380000000e+3  3.520000000e+3  ...  3.940000000e+3  4.080000000e+3 ││
    ││      │ 1.700000000e+3  1.840000000e+3  ...  2.260000000e+3  2.400000000e+3 │ 4.220000000e+3  4.360000000e+3  ...  4.780000000e+3  4.920000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 2.100000000e+1  1.610000000e+2  ...  5.810000000e+2  7.210000000e+2 │ 2.541000000e+3  2.681000000e+3  ...  3.101000000e+3  3.241000000e+3 ││
    ││axis 3│ 8.610000000e+2  1.001000000e+3  ...  1.421000000e+3  1.561000000e+3 │ 3.381000000e+3  3.521000000e+3  ...  3.941000000e+3  4.081000000e+3 ││
    ││      │ 1.701000000e+3  1.841000000e+3  ...  2.261000000e+3  2.401000000e+3 │ 4.221000000e+3  4.361000000e+3  ...  4.781000000e+3  4.921000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.200000000e+1  1.620000000e+2  ...  5.820000000e+2  7.220000000e+2 │ 2.542000000e+3  2.682000000e+3  ...  3.102000000e+3  3.242000000e+3 ││
    ││axis 3│ 8.620000000e+2  1.002000000e+3  ...  1.422000000e+3  1.562000000e+3 │ 3.382000000e+3  3.522000000e+3  ...  3.942000000e+3  4.082000000e+3 ││
    ││      │ 1.702000000e+3  1.842000000e+3  ...  2.262000000e+3  2.402000000e+3 │ 4.222000000e+3  4.362000000e+3  ...  4.782000000e+3  4.922000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 2.300000000e+1  1.630000000e+2  ...  5.830000000e+2  7.230000000e+2 │ 2.543000000e+3  2.683000000e+3  ...  3.103000000e+3  3.243000000e+3 ││
    ││axis 3│ 8.630000000e+2  1.003000000e+3  ...  1.423000000e+3  1.563000000e+3 │ 3.383000000e+3  3.523000000e+3  ...  3.943000000e+3  4.083000000e+3 ││
    ││      │ 1.703000000e+3  1.843000000e+3  ...  2.263000000e+3  2.403000000e+3 │ 4.223000000e+3  4.363000000e+3  ...  4.783000000e+3  4.923000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.400000000e+1  1.640000000e+2  ...  5.840000000e+2  7.240000000e+2 │ 2.544000000e+3  2.684000000e+3  ...  3.104000000e+3  3.244000000e+3 ││
    ││axis 3│ 8.640000000e+2  1.004000000e+3  ...  1.424000000e+3  1.564000000e+3 │ 3.384000000e+3  3.524000000e+3  ...  3.944000000e+3  4.084000000e+3 ││
    ││      │ 1.704000000e+3  1.844000000e+3  ...  2.264000000e+3  2.404000000e+3 │ 4.224000000e+3  4.364000000e+3  ...  4.784000000e+3  4.924000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                                                                                │
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││5 @ 1 │0 @ 4                                                                │1 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.000000000e+2  2.400000000e+2  ...  6.600000000e+2  8.000000000e+2 │ 2.620000000e+3  2.760000000e+3  ...  3.180000000e+3  3.320000000e+3 ││
    ││axis 3│ 9.400000000e+2  1.080000000e+3  ...  1.500000000e+3  1.640000000e+3 │ 3.460000000e+3  3.600000000e+3  ...  4.020000000e+3  4.160000000e+3 ││
    ││      │ 1.780000000e+3  1.920000000e+3  ...  2.340000000e+3  2.480000000e+3 │ 4.300000000e+3  4.440000000e+3  ...  4.860000000e+3  5.000000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.010000000e+2  2.410000000e+2  ...  6.610000000e+2  8.010000000e+2 │ 2.621000000e+3  2.761000000e+3  ...  3.181000000e+3  3.321000000e+3 ││
    ││axis 3│ 9.410000000e+2  1.081000000e+3  ...  1.501000000e+3  1.641000000e+3 │ 3.461000000e+3  3.601000000e+3  ...  4.021000000e+3  4.161000000e+3 ││
    ││      │ 1.781000000e+3  1.921000000e+3  ...  2.341000000e+3  2.481000000e+3 │ 4.301000000e+3  4.441000000e+3  ...  4.861000000e+3  5.001000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.020000000e+2  2.420000000e+2  ...  6.620000000e+2  8.020000000e+2 │ 2.622000000e+3  2.762000000e+3  ...  3.182000000e+3  3.322000000e+3 ││
    ││axis 3│ 9.420000000e+2  1.082000000e+3  ...  1.502000000e+3  1.642000000e+3 │ 3.462000000e+3  3.602000000e+3  ...  4.022000000e+3  4.162000000e+3 ││
    ││      │ 1.782000000e+3  1.922000000e+3  ...  2.342000000e+3  2.482000000e+3 │ 4.302000000e+3  4.442000000e+3  ...  4.862000000e+3  5.002000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.030000000e+2  2.430000000e+2  ...  6.630000000e+2  8.030000000e+2 │ 2.623000000e+3  2.763000000e+3  ...  3.183000000e+3  3.323000000e+3 ││
    ││axis 3│ 9.430000000e+2  1.083000000e+3  ...  1.503000000e+3  1.643000000e+3 │ 3.463000000e+3  3.603000000e+3  ...  4.023000000e+3  4.163000000e+3 ││
    ││      │ 1.783000000e+3  1.923000000e+3  ...  2.343000000e+3  2.483000000e+3 │ 4.303000000e+3  4.443000000e+3  ...  4.863000000e+3  5.003000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.040000000e+2  2.440000000e+2  ...  6.640000000e+2  8.040000000e+2 │ 2.624000000e+3  2.764000000e+3  ...  3.184000000e+3  3.324000000e+3 ││
    ││axis 3│ 9.440000000e+2  1.084000000e+3  ...  1.504000000e+3  1.644000000e+3 │ 3.464000000e+3  3.604000000e+3  ...  4.024000000e+3  4.164000000e+3 ││
    ││      │ 1.784000000e+3  1.924000000e+3  ...  2.344000000e+3  2.484000000e+3 │ 4.304000000e+3  4.444000000e+3  ...  4.864000000e+3  5.004000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││6 @ 1 │0 @ 4                                                                │1 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.200000000e+2  2.600000000e+2  ...  6.800000000e+2  8.200000000e+2 │ 2.640000000e+3  2.780000000e+3  ...  3.200000000e+3  3.340000000e+3 ││
    ││axis 3│ 9.600000000e+2  1.100000000e+3  ...  1.520000000e+3  1.660000000e+3 │ 3.480000000e+3  3.620000000e+3  ...  4.040000000e+3  4.180000000e+3 ││
    ││      │ 1.800000000e+3  1.940000000e+3  ...  2.360000000e+3  2.500000000e+3 │ 4.320000000e+3  4.460000000e+3  ...  4.880000000e+3  5.020000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.210000000e+2  2.610000000e+2  ...  6.810000000e+2  8.210000000e+2 │ 2.641000000e+3  2.781000000e+3  ...  3.201000000e+3  3.341000000e+3 ││
    ││axis 3│ 9.610000000e+2  1.101000000e+3  ...  1.521000000e+3  1.661000000e+3 │ 3.481000000e+3  3.621000000e+3  ...  4.041000000e+3  4.181000000e+3 ││
    ││      │ 1.801000000e+3  1.941000000e+3  ...  2.361000000e+3  2.501000000e+3 │ 4.321000000e+3  4.461000000e+3  ...  4.881000000e+3  5.021000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.220000000e+2  2.620000000e+2  ...  6.820000000e+2  8.220000000e+2 │ 2.642000000e+3  2.782000000e+3  ...  3.202000000e+3  3.342000000e+3 ││
    ││axis 3│ 9.620000000e+2  1.102000000e+3  ...  1.522000000e+3  1.662000000e+3 │ 3.482000000e+3  3.622000000e+3  ...  4.042000000e+3  4.182000000e+3 ││
    ││      │ 1.802000000e+3  1.942000000e+3  ...  2.362000000e+3  2.502000000e+3 │ 4.322000000e+3  4.462000000e+3  ...  4.882000000e+3  5.022000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.230000000e+2  2.630000000e+2  ...  6.830000000e+2  8.230000000e+2 │ 2.643000000e+3  2.783000000e+3  ...  3.203000000e+3  3.343000000e+3 ││
    ││axis 3│ 9.630000000e+2  1.103000000e+3  ...  1.523000000e+3  1.663000000e+3 │ 3.483000000e+3  3.623000000e+3  ...  4.043000000e+3  4.183000000e+3 ││
    ││      │ 1.803000000e+3  1.943000000e+3  ...  2.363000000e+3  2.503000000e+3 │ 4.323000000e+3  4.463000000e+3  ...  4.883000000e+3  5.023000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.240000000e+2  2.640000000e+2  ...  6.840000000e+2  8.240000000e+2 │ 2.644000000e+3  2.784000000e+3  ...  3.204000000e+3  3.344000000e+3 ││
    ││axis 3│ 9.640000000e+2  1.104000000e+3  ...  1.524000000e+3  1.664000000e+3 │ 3.484000000e+3  3.624000000e+3  ...  4.044000000e+3  4.184000000e+3 ││
    ││      │ 1.804000000e+3  1.944000000e+3  ...  2.364000000e+3  2.504000000e+3 │ 4.324000000e+3  4.464000000e+3  ...  4.884000000e+3  5.024000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 sum out axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => b|i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:3                                 │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 1                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││axis 0│ 1.800000000e+1  2.200000000e+1  2.600000000e+1 ││
    ││      │ 6.600000000e+1  7.000000000e+1  7.400000000e+1 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => c|a->d" in
  Train.forward_and_forget backend ctx ho2;
  (* Axis 5 of hey2, i.e. d in the einsum spec, has the lowest variation (progresses by 1), that's
     why axis 1 of ho2 appears nearly constant. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4|2:2->1:5                                                                                                              │
    │┌──────┬────────────────────────────────┬────────────────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0                           │1 @ 0                           │2 @ 0                           │3 @ 0                           ││
    ││      │axis 2                          │axis 2                          │axis 2                          │axis 2                          ││
    │├──────┼────────────────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 1.575000000e+5  4.750200000e+5 │ 1.581300000e+5  4.756500000e+5 │ 1.587600000e+5  4.762800000e+5 │ 1.593900000e+5  4.769100000e+5 ││
    ││      │ 1.576260000e+5  4.751460000e+5 │ 1.582560000e+5  4.757760000e+5 │ 1.588860000e+5  4.764060000e+5 │ 1.595160000e+5  4.770360000e+5 ││
    ││      │ 1.577520000e+5  4.752720000e+5 │ 1.583820000e+5  4.759020000e+5 │ 1.590120000e+5  4.765320000e+5 │ 1.596420000e+5  4.771620000e+5 ││
    ││      │ 1.578780000e+5  4.753980000e+5 │ 1.585080000e+5  4.760280000e+5 │ 1.591380000e+5  4.766580000e+5 │ 1.597680000e+5  4.772880000e+5 ││
    ││      │ 1.580040000e+5  4.755240000e+5 │ 1.586340000e+5  4.761540000e+5 │ 1.592640000e+5  4.767840000e+5 │ 1.598940000e+5  4.774140000e+5 ││
    │└──────┴────────────────────────────────┴────────────────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum outer product" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 3 ] () in
  let%op c = (a + 1) *+ "i; j => i->j" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌─────────────────────────────┐
    │[0]: r2 shape 0:2            │
    │┌┬──────────────────────────┐│
    │││axis 0                    ││
    │├┼──────────────────────────┤│
    │││ 0.000000000  1.000000000 ││
    │└┴──────────────────────────┘│
    └─────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────┐
    │[1]: r3 shape 0:3                         │
    │┌┬───────────────────────────────────────┐│
    │││axis 0                                 ││
    │├┼───────────────────────────────────────┤│
    │││ 0.000000000  1.000000000  2.000000000 ││
    │└┴───────────────────────────────────────┘│
    └──────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[4]: ;=>_c shape 1:2->0:3          │
    │┌──────┬──────────────────────────┐│
    ││      │axis 1                    ││
    │├──────┼──────────────────────────┤│
    ││axis 0│ 0.000000000  0.000000000 ││
    ││      │ 1.000000000  2.000000000 ││
    ││      │ 2.000000000  4.000000000 ││
    │└──────┴──────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 5 ] ~input_dims:[ 6 ] ~output_dims:[ 7 ] () in
  let%op c = a *+ "i|j->k; l|m->n => il|jm->kn" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: r5x7x6 shape 0:5|2:6->1:7                                                                                                                                                                                                                                                                                                                                        │
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                                │1 @ 0                                                                │2 @ 0                                                                │3 @ 0                                                                │4 @ 0                                                                ││
    ││      │axis 2                                                               │axis 2                                                               │axis 2                                                               │axis 2                                                               │axis 2                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000     1.000000000     ...  4.000000000     5.000000000    │ 4.200000000e+1  4.300000000e+1  ...  4.600000000e+1  4.700000000e+1 │ 8.400000000e+1  8.500000000e+1  ...  8.800000000e+1  8.900000000e+1 │ 1.260000000e+2  1.270000000e+2  ...  1.300000000e+2  1.310000000e+2 │ 1.680000000e+2  1.690000000e+2  ...  1.720000000e+2  1.730000000e+2 ││
    ││      │ 6.000000000     7.000000000     ...  1.000000000e+1  1.100000000e+1 │ 4.800000000e+1  4.900000000e+1  ...  5.200000000e+1  5.300000000e+1 │ 9.000000000e+1  9.100000000e+1  ...  9.400000000e+1  9.500000000e+1 │ 1.320000000e+2  1.330000000e+2  ...  1.360000000e+2  1.370000000e+2 │ 1.740000000e+2  1.750000000e+2  ...  1.780000000e+2  1.790000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 3.000000000e+1  3.100000000e+1  ...  3.400000000e+1  3.500000000e+1 │ 7.200000000e+1  7.300000000e+1  ...  7.600000000e+1  7.700000000e+1 │ 1.140000000e+2  1.150000000e+2  ...  1.180000000e+2  1.190000000e+2 │ 1.560000000e+2  1.570000000e+2  ...  1.600000000e+2  1.610000000e+2 │ 1.980000000e+2  1.990000000e+2  ...  2.020000000e+2  2.030000000e+2 ││
    ││      │ 3.600000000e+1  3.700000000e+1  ...  4.000000000e+1  4.100000000e+1 │ 7.800000000e+1  7.900000000e+1  ...  8.200000000e+1  8.300000000e+1 │ 1.200000000e+2  1.210000000e+2  ...  1.240000000e+2  1.250000000e+2 │ 1.620000000e+2  1.630000000e+2  ...  1.660000000e+2  1.670000000e+2 │ 2.040000000e+2  2.050000000e+2  ...  2.080000000e+2  2.090000000e+2 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[7]: ;=>_c shape 0:2,1:5|4:3,5:6->2:4,3:7                                                                                                                                                                                 │
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 0.000000000     1.000000000     ...  4.000000000     5.000000000    │ 0.000000000     2.000000000     ...  8.000000000     1.000000000e+1 ││
    ││axis 3│ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 6.000000000     7.000000000     ...  1.000000000e+1  1.100000000e+1 │ 1.200000000e+1  1.400000000e+1  ...  2.000000000e+1  2.200000000e+1 ││
    ││      │ ...          ...          ...  ...          ...                     │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 3.000000000e+1  3.100000000e+1  ...  3.400000000e+1  3.500000000e+1 │ 6.000000000e+1  6.200000000e+1  ...  6.800000000e+1  7.000000000e+1 ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 3.600000000e+1  3.700000000e+1  ...  4.000000000e+1  4.100000000e+1 │ 7.200000000e+1  7.400000000e+1  ...  8.000000000e+1  8.200000000e+1 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 0.000000000     3.000000000     ...  1.200000000e+1  1.500000000e+1 │ 0.000000000     4.000000000     ...  1.600000000e+1  2.000000000e+1 │ 0.000000000     5.000000000     ...  2.000000000e+1  2.500000000e+1 ││
    ││axis 3│ 1.800000000e+1  2.100000000e+1  ...  3.000000000e+1  3.300000000e+1 │ 2.400000000e+1  2.800000000e+1  ...  4.000000000e+1  4.400000000e+1 │ 3.000000000e+1  3.500000000e+1  ...  5.000000000e+1  5.500000000e+1 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 9.000000000e+1  9.300000000e+1  ...  1.020000000e+2  1.050000000e+2 │ 1.200000000e+2  1.240000000e+2  ...  1.360000000e+2  1.400000000e+2 │ 1.500000000e+2  1.550000000e+2  ...  1.700000000e+2  1.750000000e+2 ││
    ││      │ 1.080000000e+2  1.110000000e+2  ...  1.200000000e+2  1.230000000e+2 │ 1.440000000e+2  1.480000000e+2  ...  1.600000000e+2  1.640000000e+2 │ 1.800000000e+2  1.850000000e+2  ...  2.000000000e+2  2.050000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 0.000000000     6.000000000     ...  2.400000000e+1  3.000000000e+1 │ 0.000000000     7.000000000     ...  2.800000000e+1  3.500000000e+1 │ 0.000000000     8.000000000     ...  3.200000000e+1  4.000000000e+1 ││
    ││axis 3│ 3.600000000e+1  4.200000000e+1  ...  6.000000000e+1  6.600000000e+1 │ 4.200000000e+1  4.900000000e+1  ...  7.000000000e+1  7.700000000e+1 │ 4.800000000e+1  5.600000000e+1  ...  8.000000000e+1  8.800000000e+1 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 1.800000000e+2  1.860000000e+2  ...  2.040000000e+2  2.100000000e+2 │ 2.100000000e+2  2.170000000e+2  ...  2.380000000e+2  2.450000000e+2 │ 2.400000000e+2  2.480000000e+2  ...  2.720000000e+2  2.800000000e+2 ││
    ││      │ 2.160000000e+2  2.220000000e+2  ...  2.400000000e+2  2.460000000e+2 │ 2.520000000e+2  2.590000000e+2  ...  2.800000000e+2  2.870000000e+2 │ 2.880000000e+2  2.960000000e+2  ...  3.200000000e+2  3.280000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 0.000000000     9.000000000     ...  3.600000000e+1  4.500000000e+1 │ 0.000000000     1.000000000e+1  ...  4.000000000e+1  5.000000000e+1 │ 0.000000000     1.100000000e+1  ...  4.400000000e+1  5.500000000e+1 ││
    ││axis 3│ 5.400000000e+1  6.300000000e+1  ...  9.000000000e+1  9.900000000e+1 │ 6.000000000e+1  7.000000000e+1  ...  1.000000000e+2  1.100000000e+2 │ 6.600000000e+1  7.700000000e+1  ...  1.100000000e+2  1.210000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 2.700000000e+2  2.790000000e+2  ...  3.060000000e+2  3.150000000e+2 │ 3.000000000e+2  3.100000000e+2  ...  3.400000000e+2  3.500000000e+2 │ 3.300000000e+2  3.410000000e+2  ...  3.740000000e+2  3.850000000e+2 ││
    ││      │ 3.240000000e+2  3.330000000e+2  ...  3.600000000e+2  3.690000000e+2 │ 3.600000000e+2  3.700000000e+2  ...  4.000000000e+2  4.100000000e+2 │ 3.960000000e+2  4.070000000e+2  ...  4.400000000e+2  4.510000000e+2 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 4.200000000e+1  4.300000000e+1  ...  4.600000000e+1  4.700000000e+1 │ 8.400000000e+1  8.600000000e+1  ...  9.200000000e+1  9.400000000e+1 ││
    ││axis 3│ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 4.800000000e+1  4.900000000e+1  ...  5.200000000e+1  5.300000000e+1 │ 9.600000000e+1  9.800000000e+1  ...  1.040000000e+2  1.060000000e+2 ││
    ││      │ ...          ...          ...  ...          ...                     │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 7.200000000e+1  7.300000000e+1  ...  7.600000000e+1  7.700000000e+1 │ 1.440000000e+2  1.460000000e+2  ...  1.520000000e+2  1.540000000e+2 ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 7.800000000e+1  7.900000000e+1  ...  8.200000000e+1  8.300000000e+1 │ 1.560000000e+2  1.580000000e+2  ...  1.640000000e+2  1.660000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.260000000e+2  1.290000000e+2  ...  1.380000000e+2  1.410000000e+2 │ 1.680000000e+2  1.720000000e+2  ...  1.840000000e+2  1.880000000e+2 │ 2.100000000e+2  2.150000000e+2  ...  2.300000000e+2  2.350000000e+2 ││
    ││axis 3│ 1.440000000e+2  1.470000000e+2  ...  1.560000000e+2  1.590000000e+2 │ 1.920000000e+2  1.960000000e+2  ...  2.080000000e+2  2.120000000e+2 │ 2.400000000e+2  2.450000000e+2  ...  2.600000000e+2  2.650000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 2.160000000e+2  2.190000000e+2  ...  2.280000000e+2  2.310000000e+2 │ 2.880000000e+2  2.920000000e+2  ...  3.040000000e+2  3.080000000e+2 │ 3.600000000e+2  3.650000000e+2  ...  3.800000000e+2  3.850000000e+2 ││
    ││      │ 2.340000000e+2  2.370000000e+2  ...  2.460000000e+2  2.490000000e+2 │ 3.120000000e+2  3.160000000e+2  ...  3.280000000e+2  3.320000000e+2 │ 3.900000000e+2  3.950000000e+2  ...  4.100000000e+2  4.150000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.520000000e+2  2.580000000e+2  ...  2.760000000e+2  2.820000000e+2 │ 2.940000000e+2  3.010000000e+2  ...  3.220000000e+2  3.290000000e+2 │ 3.360000000e+2  3.440000000e+2  ...  3.680000000e+2  3.760000000e+2 ││
    ││axis 3│ 2.880000000e+2  2.940000000e+2  ...  3.120000000e+2  3.180000000e+2 │ 3.360000000e+2  3.430000000e+2  ...  3.640000000e+2  3.710000000e+2 │ 3.840000000e+2  3.920000000e+2  ...  4.160000000e+2  4.240000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 4.320000000e+2  4.380000000e+2  ...  4.560000000e+2  4.620000000e+2 │ 5.040000000e+2  5.110000000e+2  ...  5.320000000e+2  5.390000000e+2 │ 5.760000000e+2  5.840000000e+2  ...  6.080000000e+2  6.160000000e+2 ││
    ││      │ 4.680000000e+2  4.740000000e+2  ...  4.920000000e+2  4.980000000e+2 │ 5.460000000e+2  5.530000000e+2  ...  5.740000000e+2  5.810000000e+2 │ 6.240000000e+2  6.320000000e+2  ...  6.560000000e+2  6.640000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 3.780000000e+2  3.870000000e+2  ...  4.140000000e+2  4.230000000e+2 │ 4.200000000e+2  4.300000000e+2  ...  4.600000000e+2  4.700000000e+2 │ 4.620000000e+2  4.730000000e+2  ...  5.060000000e+2  5.170000000e+2 ││
    ││axis 3│ 4.320000000e+2  4.410000000e+2  ...  4.680000000e+2  4.770000000e+2 │ 4.800000000e+2  4.900000000e+2  ...  5.200000000e+2  5.300000000e+2 │ 5.280000000e+2  5.390000000e+2  ...  5.720000000e+2  5.830000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 6.480000000e+2  6.570000000e+2  ...  6.840000000e+2  6.930000000e+2 │ 7.200000000e+2  7.300000000e+2  ...  7.600000000e+2  7.700000000e+2 │ 7.920000000e+2  8.030000000e+2  ...  8.360000000e+2  8.470000000e+2 ││
    ││      │ 7.020000000e+2  7.110000000e+2  ...  7.380000000e+2  7.470000000e+2 │ 7.800000000e+2  7.900000000e+2  ...  8.200000000e+2  8.300000000e+2 │ 8.580000000e+2  8.690000000e+2  ...  9.020000000e+2  9.130000000e+2 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 8.400000000e+1  8.500000000e+1  ...  8.800000000e+1  8.900000000e+1 │ 1.680000000e+2  1.700000000e+2  ...  1.760000000e+2  1.780000000e+2 ││
    ││axis 3│ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 9.000000000e+1  9.100000000e+1  ...  9.400000000e+1  9.500000000e+1 │ 1.800000000e+2  1.820000000e+2  ...  1.880000000e+2  1.900000000e+2 ││
    ││      │ ...          ...          ...  ...          ...                     │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.140000000e+2  1.150000000e+2  ...  1.180000000e+2  1.190000000e+2 │ 2.280000000e+2  2.300000000e+2  ...  2.360000000e+2  2.380000000e+2 ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.200000000e+2  1.210000000e+2  ...  1.240000000e+2  1.250000000e+2 │ 2.400000000e+2  2.420000000e+2  ...  2.480000000e+2  2.500000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 2.520000000e+2  2.550000000e+2  ...  2.640000000e+2  2.670000000e+2 │ 3.360000000e+2  3.400000000e+2  ...  3.520000000e+2  3.560000000e+2 │ 4.200000000e+2  4.250000000e+2  ...  4.400000000e+2  4.450000000e+2 ││
    ││axis 3│ 2.700000000e+2  2.730000000e+2  ...  2.820000000e+2  2.850000000e+2 │ 3.600000000e+2  3.640000000e+2  ...  3.760000000e+2  3.800000000e+2 │ 4.500000000e+2  4.550000000e+2  ...  4.700000000e+2  4.750000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 3.420000000e+2  3.450000000e+2  ...  3.540000000e+2  3.570000000e+2 │ 4.560000000e+2  4.600000000e+2  ...  4.720000000e+2  4.760000000e+2 │ 5.700000000e+2  5.750000000e+2  ...  5.900000000e+2  5.950000000e+2 ││
    ││      │ 3.600000000e+2  3.630000000e+2  ...  3.720000000e+2  3.750000000e+2 │ 4.800000000e+2  4.840000000e+2  ...  4.960000000e+2  5.000000000e+2 │ 6.000000000e+2  6.050000000e+2  ...  6.200000000e+2  6.250000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 5.040000000e+2  5.100000000e+2  ...  5.280000000e+2  5.340000000e+2 │ 5.880000000e+2  5.950000000e+2  ...  6.160000000e+2  6.230000000e+2 │ 6.720000000e+2  6.800000000e+2  ...  7.040000000e+2  7.120000000e+2 ││
    ││axis 3│ 5.400000000e+2  5.460000000e+2  ...  5.640000000e+2  5.700000000e+2 │ 6.300000000e+2  6.370000000e+2  ...  6.580000000e+2  6.650000000e+2 │ 7.200000000e+2  7.280000000e+2  ...  7.520000000e+2  7.600000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 6.840000000e+2  6.900000000e+2  ...  7.080000000e+2  7.140000000e+2 │ 7.980000000e+2  8.050000000e+2  ...  8.260000000e+2  8.330000000e+2 │ 9.120000000e+2  9.200000000e+2  ...  9.440000000e+2  9.520000000e+2 ││
    ││      │ 7.200000000e+2  7.260000000e+2  ...  7.440000000e+2  7.500000000e+2 │ 8.400000000e+2  8.470000000e+2  ...  8.680000000e+2  8.750000000e+2 │ 9.600000000e+2  9.680000000e+2  ...  9.920000000e+2  1.000000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 7.560000000e+2  7.650000000e+2  ...  7.920000000e+2  8.010000000e+2 │ 8.400000000e+2  8.500000000e+2  ...  8.800000000e+2  8.900000000e+2 │ 9.240000000e+2  9.350000000e+2  ...  9.680000000e+2  9.790000000e+2 ││
    ││axis 3│ 8.100000000e+2  8.190000000e+2  ...  8.460000000e+2  8.550000000e+2 │ 9.000000000e+2  9.100000000e+2  ...  9.400000000e+2  9.500000000e+2 │ 9.900000000e+2  1.001000000e+3  ...  1.034000000e+3  1.045000000e+3 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 1.026000000e+3  1.035000000e+3  ...  1.062000000e+3  1.071000000e+3 │ 1.140000000e+3  1.150000000e+3  ...  1.180000000e+3  1.190000000e+3 │ 1.254000000e+3  1.265000000e+3  ...  1.298000000e+3  1.309000000e+3 ││
    ││      │ 1.080000000e+3  1.089000000e+3  ...  1.116000000e+3  1.125000000e+3 │ 1.200000000e+3  1.210000000e+3  ...  1.240000000e+3  1.250000000e+3 │ 1.320000000e+3  1.331000000e+3  ...  1.364000000e+3  1.375000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.260000000e+2  1.270000000e+2  ...  1.300000000e+2  1.310000000e+2 │ 2.520000000e+2  2.540000000e+2  ...  2.600000000e+2  2.620000000e+2 ││
    ││axis 3│ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.320000000e+2  1.330000000e+2  ...  1.360000000e+2  1.370000000e+2 │ 2.640000000e+2  2.660000000e+2  ...  2.720000000e+2  2.740000000e+2 ││
    ││      │ ...          ...          ...  ...          ...                     │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.560000000e+2  1.570000000e+2  ...  1.600000000e+2  1.610000000e+2 │ 3.120000000e+2  3.140000000e+2  ...  3.200000000e+2  3.220000000e+2 ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.620000000e+2  1.630000000e+2  ...  1.660000000e+2  1.670000000e+2 │ 3.240000000e+2  3.260000000e+2  ...  3.320000000e+2  3.340000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 3.780000000e+2  3.810000000e+2  ...  3.900000000e+2  3.930000000e+2 │ 5.040000000e+2  5.080000000e+2  ...  5.200000000e+2  5.240000000e+2 │ 6.300000000e+2  6.350000000e+2  ...  6.500000000e+2  6.550000000e+2 ││
    ││axis 3│ 3.960000000e+2  3.990000000e+2  ...  4.080000000e+2  4.110000000e+2 │ 5.280000000e+2  5.320000000e+2  ...  5.440000000e+2  5.480000000e+2 │ 6.600000000e+2  6.650000000e+2  ...  6.800000000e+2  6.850000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 4.680000000e+2  4.710000000e+2  ...  4.800000000e+2  4.830000000e+2 │ 6.240000000e+2  6.280000000e+2  ...  6.400000000e+2  6.440000000e+2 │ 7.800000000e+2  7.850000000e+2  ...  8.000000000e+2  8.050000000e+2 ││
    ││      │ 4.860000000e+2  4.890000000e+2  ...  4.980000000e+2  5.010000000e+2 │ 6.480000000e+2  6.520000000e+2  ...  6.640000000e+2  6.680000000e+2 │ 8.100000000e+2  8.150000000e+2  ...  8.300000000e+2  8.350000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 7.560000000e+2  7.620000000e+2  ...  7.800000000e+2  7.860000000e+2 │ 8.820000000e+2  8.890000000e+2  ...  9.100000000e+2  9.170000000e+2 │ 1.008000000e+3  1.016000000e+3  ...  1.040000000e+3  1.048000000e+3 ││
    ││axis 3│ 7.920000000e+2  7.980000000e+2  ...  8.160000000e+2  8.220000000e+2 │ 9.240000000e+2  9.310000000e+2  ...  9.520000000e+2  9.590000000e+2 │ 1.056000000e+3  1.064000000e+3  ...  1.088000000e+3  1.096000000e+3 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 9.360000000e+2  9.420000000e+2  ...  9.600000000e+2  9.660000000e+2 │ 1.092000000e+3  1.099000000e+3  ...  1.120000000e+3  1.127000000e+3 │ 1.248000000e+3  1.256000000e+3  ...  1.280000000e+3  1.288000000e+3 ││
    ││      │ 9.720000000e+2  9.780000000e+2  ...  9.960000000e+2  1.002000000e+3 │ 1.134000000e+3  1.141000000e+3  ...  1.162000000e+3  1.169000000e+3 │ 1.296000000e+3  1.304000000e+3  ...  1.328000000e+3  1.336000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.134000000e+3  1.143000000e+3  ...  1.170000000e+3  1.179000000e+3 │ 1.260000000e+3  1.270000000e+3  ...  1.300000000e+3  1.310000000e+3 │ 1.386000000e+3  1.397000000e+3  ...  1.430000000e+3  1.441000000e+3 ││
    ││axis 3│ 1.188000000e+3  1.197000000e+3  ...  1.224000000e+3  1.233000000e+3 │ 1.320000000e+3  1.330000000e+3  ...  1.360000000e+3  1.370000000e+3 │ 1.452000000e+3  1.463000000e+3  ...  1.496000000e+3  1.507000000e+3 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 1.404000000e+3  1.413000000e+3  ...  1.440000000e+3  1.449000000e+3 │ 1.560000000e+3  1.570000000e+3  ...  1.600000000e+3  1.610000000e+3 │ 1.716000000e+3  1.727000000e+3  ...  1.760000000e+3  1.771000000e+3 ││
    ││      │ 1.458000000e+3  1.467000000e+3  ...  1.494000000e+3  1.503000000e+3 │ 1.620000000e+3  1.630000000e+3  ...  1.660000000e+3  1.670000000e+3 │ 1.782000000e+3  1.793000000e+3  ...  1.826000000e+3  1.837000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.680000000e+2  1.690000000e+2  ...  1.720000000e+2  1.730000000e+2 │ 3.360000000e+2  3.380000000e+2  ...  3.440000000e+2  3.460000000e+2 ││
    ││axis 3│ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.740000000e+2  1.750000000e+2  ...  1.780000000e+2  1.790000000e+2 │ 3.480000000e+2  3.500000000e+2  ...  3.560000000e+2  3.580000000e+2 ││
    ││      │ ...          ...          ...  ...          ...                     │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 1.980000000e+2  1.990000000e+2  ...  2.020000000e+2  2.030000000e+2 │ 3.960000000e+2  3.980000000e+2  ...  4.040000000e+2  4.060000000e+2 ││
    ││      │ 0.000000000  0.000000000  ...  0.000000000  0.000000000             │ 2.040000000e+2  2.050000000e+2  ...  2.080000000e+2  2.090000000e+2 │ 4.080000000e+2  4.100000000e+2  ...  4.160000000e+2  4.180000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 5.040000000e+2  5.070000000e+2  ...  5.160000000e+2  5.190000000e+2 │ 6.720000000e+2  6.760000000e+2  ...  6.880000000e+2  6.920000000e+2 │ 8.400000000e+2  8.450000000e+2  ...  8.600000000e+2  8.650000000e+2 ││
    ││axis 3│ 5.220000000e+2  5.250000000e+2  ...  5.340000000e+2  5.370000000e+2 │ 6.960000000e+2  7.000000000e+2  ...  7.120000000e+2  7.160000000e+2 │ 8.700000000e+2  8.750000000e+2  ...  8.900000000e+2  8.950000000e+2 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 5.940000000e+2  5.970000000e+2  ...  6.060000000e+2  6.090000000e+2 │ 7.920000000e+2  7.960000000e+2  ...  8.080000000e+2  8.120000000e+2 │ 9.900000000e+2  9.950000000e+2  ...  1.010000000e+3  1.015000000e+3 ││
    ││      │ 6.120000000e+2  6.150000000e+2  ...  6.240000000e+2  6.270000000e+2 │ 8.160000000e+2  8.200000000e+2  ...  8.320000000e+2  8.360000000e+2 │ 1.020000000e+3  1.025000000e+3  ...  1.040000000e+3  1.045000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.008000000e+3  1.014000000e+3  ...  1.032000000e+3  1.038000000e+3 │ 1.176000000e+3  1.183000000e+3  ...  1.204000000e+3  1.211000000e+3 │ 1.344000000e+3  1.352000000e+3  ...  1.376000000e+3  1.384000000e+3 ││
    ││axis 3│ 1.044000000e+3  1.050000000e+3  ...  1.068000000e+3  1.074000000e+3 │ 1.218000000e+3  1.225000000e+3  ...  1.246000000e+3  1.253000000e+3 │ 1.392000000e+3  1.400000000e+3  ...  1.424000000e+3  1.432000000e+3 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 1.188000000e+3  1.194000000e+3  ...  1.212000000e+3  1.218000000e+3 │ 1.386000000e+3  1.393000000e+3  ...  1.414000000e+3  1.421000000e+3 │ 1.584000000e+3  1.592000000e+3  ...  1.616000000e+3  1.624000000e+3 ││
    ││      │ 1.224000000e+3  1.230000000e+3  ...  1.248000000e+3  1.254000000e+3 │ 1.428000000e+3  1.435000000e+3  ...  1.456000000e+3  1.463000000e+3 │ 1.632000000e+3  1.640000000e+3  ...  1.664000000e+3  1.672000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.512000000e+3  1.521000000e+3  ...  1.548000000e+3  1.557000000e+3 │ 1.680000000e+3  1.690000000e+3  ...  1.720000000e+3  1.730000000e+3 │ 1.848000000e+3  1.859000000e+3  ...  1.892000000e+3  1.903000000e+3 ││
    ││axis 3│ 1.566000000e+3  1.575000000e+3  ...  1.602000000e+3  1.611000000e+3 │ 1.740000000e+3  1.750000000e+3  ...  1.780000000e+3  1.790000000e+3 │ 1.914000000e+3  1.925000000e+3  ...  1.958000000e+3  1.969000000e+3 ││
    ││      │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            │ ...             ...             ...  ...             ...            ││
    ││      │ 1.782000000e+3  1.791000000e+3  ...  1.818000000e+3  1.827000000e+3 │ 1.980000000e+3  1.990000000e+3  ...  2.020000000e+3  2.030000000e+3 │ 2.178000000e+3  2.189000000e+3  ...  2.222000000e+3  2.233000000e+3 ││
    ││      │ 1.836000000e+3  1.845000000e+3  ...  1.872000000e+3  1.881000000e+3 │ 2.040000000e+3  2.050000000e+3  ...  2.080000000e+3  2.090000000e+3 │ 2.244000000e+3  2.255000000e+3  ...  2.288000000e+3  2.299000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum matrix/inner+outer products" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 4 ] ~output_dims:[ 5 ] () in
  let%op a2 = a *+ "b|i->o; b|i->o => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx a2 in
  let%op c = b *+ "b|h->o; b|i->h => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx c in
  let%op d = a *+ "a|i->h; b|h->o => ab|i->o" b in
  Train.forward_and_forget backend ctx d;
  let%op e = a *+ "b|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx e;
  let%op f = a *+ "a|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_a2 shape 0:2|2:3->1:4                                                                            │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                           │1 @ 0                                           ││
    ││      │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000     1.000000000     4.000000000    │ 1.440000000e+2  1.690000000e+2  1.960000000e+2 ││
    ││      │ 9.000000000     1.600000000e+1  2.500000000e+1 │ 2.250000000e+2  2.560000000e+2  2.890000000e+2 ││
    ││      │ 3.600000000e+1  4.900000000e+1  6.400000000e+1 │ 3.240000000e+2  3.610000000e+2  4.000000000e+2 ││
    ││      │ 8.100000000e+1  1.000000000e+2  1.210000000e+2 │ 4.410000000e+2  4.840000000e+2  5.290000000e+2 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: ;=>_c shape 0:2|2:3->1:5                                                                             │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                           │1 @ 0                                           ││
    ││      │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 4.200000000e+1  4.800000000e+1  5.400000000e+1 │ 1.434000000e+3  1.520000000e+3  1.606000000e+3 ││
    ││      │ 1.140000000e+2  1.360000000e+2  1.580000000e+2 │ 1.698000000e+3  1.800000000e+3  1.902000000e+3 ││
    ││      │ 1.860000000e+2  2.240000000e+2  2.620000000e+2 │ 1.962000000e+3  2.080000000e+3  2.198000000e+3 ││
    ││      │ 2.580000000e+2  3.120000000e+2  3.660000000e+2 │ 2.226000000e+3  2.360000000e+3  2.494000000e+3 ││
    ││      │ 3.300000000e+2  4.000000000e+2  4.700000000e+2 │ 2.490000000e+3  2.640000000e+3  2.790000000e+3 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: ;=>_d shape 0:2,1:2|3:3->2:5                                                                         │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 1                                           │1 @ 1                                           ││
    ││      │axis 3                                          │axis 3                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││0 @ 0 │ 4.200000000e+1  4.800000000e+1  5.400000000e+1 │ 4.020000000e+2  4.880000000e+2  5.740000000e+2 ││
    ││axis 2│ 1.140000000e+2  1.360000000e+2  1.580000000e+2 │ 4.740000000e+2  5.760000000e+2  6.780000000e+2 ││
    ││      │ 1.860000000e+2  2.240000000e+2  2.620000000e+2 │ 5.460000000e+2  6.640000000e+2  7.820000000e+2 ││
    ││      │ 2.580000000e+2  3.120000000e+2  3.660000000e+2 │ 6.180000000e+2  7.520000000e+2  8.860000000e+2 ││
    ││      │ 3.300000000e+2  4.000000000e+2  4.700000000e+2 │ 6.900000000e+2  8.400000000e+2  9.900000000e+2 ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││1 @ 0 │ 1.140000000e+2  1.200000000e+2  1.260000000e+2 │ 1.434000000e+3  1.520000000e+3  1.606000000e+3 ││
    ││axis 2│ 3.780000000e+2  4.000000000e+2  4.220000000e+2 │ 1.698000000e+3  1.800000000e+3  1.902000000e+3 ││
    ││      │ 6.420000000e+2  6.800000000e+2  7.180000000e+2 │ 1.962000000e+3  2.080000000e+3  2.198000000e+3 ││
    ││      │ 9.060000000e+2  9.600000000e+2  1.014000000e+3 │ 2.226000000e+3  2.360000000e+3  2.494000000e+3 ││
    ││      │ 1.170000000e+3  1.240000000e+3  1.310000000e+3 │ 2.490000000e+3  2.640000000e+3  2.790000000e+3 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[5]: ;=>_e shape 1:3->0:5                                │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 1                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││axis 0│ 1.476000000e+3  1.568000000e+3  1.660000000e+3 ││
    ││      │ 1.812000000e+3  1.936000000e+3  2.060000000e+3 ││
    ││      │ 2.148000000e+3  2.304000000e+3  2.460000000e+3 ││
    ││      │ 2.484000000e+3  2.672000000e+3  2.860000000e+3 ││
    ││      │ 2.820000000e+3  3.040000000e+3  3.260000000e+3 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[6]: ;=>_f shape 1:3->0:5                                │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 1                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││axis 0│ 1.992000000e+3  2.176000000e+3  2.360000000e+3 ││
    ││      │ 2.664000000e+3  2.912000000e+3  3.160000000e+3 ││
    ││      │ 3.336000000e+3  3.648000000e+3  3.960000000e+3 ││
    ││      │ 4.008000000e+3  4.384000000e+3  4.760000000e+3 ││
    ││      │ 4.680000000e+3  5.120000000e+3  5.560000000e+3 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|i->o => ...|o->i" in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|2:4->1:3                                                                                                    │
    │┌──────┬───────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                  │1 @ 0                                                           ││
    ││      │axis 2                                                 │axis 2                                                          ││
    │├──────┼───────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  3.000000000  6.000000000  9.000000000    │ 1.200000000e+1  1.500000000e+1  1.800000000e+1  2.100000000e+1 ││
    ││      │ 1.000000000  4.000000000  7.000000000  1.000000000e+1 │ 1.300000000e+1  1.600000000e+1  1.900000000e+1  2.200000000e+1 ││
    ││      │ 2.000000000  5.000000000  8.000000000  1.100000000e+1 │ 1.400000000e+1  1.700000000e+1  2.000000000e+1  2.300000000e+1 ││
    │└──────┴───────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "b|...->o => o|...->b" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:4|2:3->1:2                                                                                                                                                                              │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                           │1 @ 0                                           │2 @ 0                                           │3 @ 0                                           ││
    ││      │axis 2                                          │axis 2                                          │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000     1.000000000     2.000000000    │ 3.000000000     4.000000000     5.000000000    │ 6.000000000     7.000000000     8.000000000    │ 9.000000000     1.000000000e+1  1.100000000e+1 ││
    ││      │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho3 = hey2 ++ "...b|...i->...o => ...i|...o->...b" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                                                                                                                                                            │
    │┌──────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                           │1 @ 4                                                                           │2 @ 4                                                                           │3 @ 4                                                                           ││
    ││      │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000     1.000000000     2.000000000     3.000000000     4.000000000    │ 5.000000000     6.000000000     7.000000000     8.000000000     9.000000000    │ 1.000000000e+1  1.100000000e+1  1.200000000e+1  1.300000000e+1  1.400000000e+1 │ 1.500000000e+1  1.600000000e+1  1.700000000e+1  1.800000000e+1  1.900000000e+1 ││
    ││axis 3│ 2.000000000e+1  2.100000000e+1  2.200000000e+1  2.300000000e+1  2.400000000e+1 │ 2.500000000e+1  2.600000000e+1  2.700000000e+1  2.800000000e+1  2.900000000e+1 │ 3.000000000e+1  3.100000000e+1  3.200000000e+1  3.300000000e+1  3.400000000e+1 │ 3.500000000e+1  3.600000000e+1  3.700000000e+1  3.800000000e+1  3.900000000e+1 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.000000000e+2  1.010000000e+2  1.020000000e+2  1.030000000e+2  1.040000000e+2 │ 1.050000000e+2  1.060000000e+2  1.070000000e+2  1.080000000e+2  1.090000000e+2 │ 1.100000000e+2  1.110000000e+2  1.120000000e+2  1.130000000e+2  1.140000000e+2 │ 1.150000000e+2  1.160000000e+2  1.170000000e+2  1.180000000e+2  1.190000000e+2 ││
    ││      │ 1.200000000e+2  1.210000000e+2  1.220000000e+2  1.230000000e+2  1.240000000e+2 │ 1.250000000e+2  1.260000000e+2  1.270000000e+2  1.280000000e+2  1.290000000e+2 │ 1.300000000e+2  1.310000000e+2  1.320000000e+2  1.330000000e+2  1.340000000e+2 │ 1.350000000e+2  1.360000000e+2  1.370000000e+2  1.380000000e+2  1.390000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.400000000e+2  1.410000000e+2  1.420000000e+2  1.430000000e+2  1.440000000e+2 │ 1.450000000e+2  1.460000000e+2  1.470000000e+2  1.480000000e+2  1.490000000e+2 │ 1.500000000e+2  1.510000000e+2  1.520000000e+2  1.530000000e+2  1.540000000e+2 │ 1.550000000e+2  1.560000000e+2  1.570000000e+2  1.580000000e+2  1.590000000e+2 ││
    ││axis 3│ 1.600000000e+2  1.610000000e+2  1.620000000e+2  1.630000000e+2  1.640000000e+2 │ 1.650000000e+2  1.660000000e+2  1.670000000e+2  1.680000000e+2  1.690000000e+2 │ 1.700000000e+2  1.710000000e+2  1.720000000e+2  1.730000000e+2  1.740000000e+2 │ 1.750000000e+2  1.760000000e+2  1.770000000e+2  1.780000000e+2  1.790000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 2.400000000e+2  2.410000000e+2  2.420000000e+2  2.430000000e+2  2.440000000e+2 │ 2.450000000e+2  2.460000000e+2  2.470000000e+2  2.480000000e+2  2.490000000e+2 │ 2.500000000e+2  2.510000000e+2  2.520000000e+2  2.530000000e+2  2.540000000e+2 │ 2.550000000e+2  2.560000000e+2  2.570000000e+2  2.580000000e+2  2.590000000e+2 ││
    ││      │ 2.600000000e+2  2.610000000e+2  2.620000000e+2  2.630000000e+2  2.640000000e+2 │ 2.650000000e+2  2.660000000e+2  2.670000000e+2  2.680000000e+2  2.690000000e+2 │ 2.700000000e+2  2.710000000e+2  2.720000000e+2  2.730000000e+2  2.740000000e+2 │ 2.750000000e+2  2.760000000e+2  2.770000000e+2  2.780000000e+2  2.790000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                            │ ...                                                                            │ ...                                                                            │ ...                                                                            ││
    ││axis 3│                                                                                │                                                                                │                                                                                │                                                                                ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.600000000e+2  5.610000000e+2  5.620000000e+2  5.630000000e+2  5.640000000e+2 │ 5.650000000e+2  5.660000000e+2  5.670000000e+2  5.680000000e+2  5.690000000e+2 │ 5.700000000e+2  5.710000000e+2  5.720000000e+2  5.730000000e+2  5.740000000e+2 │ 5.750000000e+2  5.760000000e+2  5.770000000e+2  5.780000000e+2  5.790000000e+2 ││
    ││axis 3│ 5.800000000e+2  5.810000000e+2  5.820000000e+2  5.830000000e+2  5.840000000e+2 │ 5.850000000e+2  5.860000000e+2  5.870000000e+2  5.880000000e+2  5.890000000e+2 │ 5.900000000e+2  5.910000000e+2  5.920000000e+2  5.930000000e+2  5.940000000e+2 │ 5.950000000e+2  5.960000000e+2  5.970000000e+2  5.980000000e+2  5.990000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 6.600000000e+2  6.610000000e+2  6.620000000e+2  6.630000000e+2  6.640000000e+2 │ 6.650000000e+2  6.660000000e+2  6.670000000e+2  6.680000000e+2  6.690000000e+2 │ 6.700000000e+2  6.710000000e+2  6.720000000e+2  6.730000000e+2  6.740000000e+2 │ 6.750000000e+2  6.760000000e+2  6.770000000e+2  6.780000000e+2  6.790000000e+2 ││
    ││      │ 6.800000000e+2  6.810000000e+2  6.820000000e+2  6.830000000e+2  6.840000000e+2 │ 6.850000000e+2  6.860000000e+2  6.870000000e+2  6.880000000e+2  6.890000000e+2 │ 6.900000000e+2  6.910000000e+2  6.920000000e+2  6.930000000e+2  6.940000000e+2 │ 6.950000000e+2  6.960000000e+2  6.970000000e+2  6.980000000e+2  6.990000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.000000000e+2  7.010000000e+2  7.020000000e+2  7.030000000e+2  7.040000000e+2 │ 7.050000000e+2  7.060000000e+2  7.070000000e+2  7.080000000e+2  7.090000000e+2 │ 7.100000000e+2  7.110000000e+2  7.120000000e+2  7.130000000e+2  7.140000000e+2 │ 7.150000000e+2  7.160000000e+2  7.170000000e+2  7.180000000e+2  7.190000000e+2 ││
    ││axis 3│ 7.200000000e+2  7.210000000e+2  7.220000000e+2  7.230000000e+2  7.240000000e+2 │ 7.250000000e+2  7.260000000e+2  7.270000000e+2  7.280000000e+2  7.290000000e+2 │ 7.300000000e+2  7.310000000e+2  7.320000000e+2  7.330000000e+2  7.340000000e+2 │ 7.350000000e+2  7.360000000e+2  7.370000000e+2  7.380000000e+2  7.390000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 8.000000000e+2  8.010000000e+2  8.020000000e+2  8.030000000e+2  8.040000000e+2 │ 8.050000000e+2  8.060000000e+2  8.070000000e+2  8.080000000e+2  8.090000000e+2 │ 8.100000000e+2  8.110000000e+2  8.120000000e+2  8.130000000e+2  8.140000000e+2 │ 8.150000000e+2  8.160000000e+2  8.170000000e+2  8.180000000e+2  8.190000000e+2 ││
    ││      │ 8.200000000e+2  8.210000000e+2  8.220000000e+2  8.230000000e+2  8.240000000e+2 │ 8.250000000e+2  8.260000000e+2  8.270000000e+2  8.280000000e+2  8.290000000e+2 │ 8.300000000e+2  8.310000000e+2  8.320000000e+2  8.330000000e+2  8.340000000e+2 │ 8.350000000e+2  8.360000000e+2  8.370000000e+2  8.380000000e+2  8.390000000e+2 ││
    │└──────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                           │1 @ 4                                                                           │2 @ 4                                                                           │3 @ 4                                                                           ││
    ││      │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 8.400000000e+2  8.410000000e+2  8.420000000e+2  8.430000000e+2  8.440000000e+2 │ 8.450000000e+2  8.460000000e+2  8.470000000e+2  8.480000000e+2  8.490000000e+2 │ 8.500000000e+2  8.510000000e+2  8.520000000e+2  8.530000000e+2  8.540000000e+2 │ 8.550000000e+2  8.560000000e+2  8.570000000e+2  8.580000000e+2  8.590000000e+2 ││
    ││axis 3│ 8.600000000e+2  8.610000000e+2  8.620000000e+2  8.630000000e+2  8.640000000e+2 │ 8.650000000e+2  8.660000000e+2  8.670000000e+2  8.680000000e+2  8.690000000e+2 │ 8.700000000e+2  8.710000000e+2  8.720000000e+2  8.730000000e+2  8.740000000e+2 │ 8.750000000e+2  8.760000000e+2  8.770000000e+2  8.780000000e+2  8.790000000e+2 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 9.400000000e+2  9.410000000e+2  9.420000000e+2  9.430000000e+2  9.440000000e+2 │ 9.450000000e+2  9.460000000e+2  9.470000000e+2  9.480000000e+2  9.490000000e+2 │ 9.500000000e+2  9.510000000e+2  9.520000000e+2  9.530000000e+2  9.540000000e+2 │ 9.550000000e+2  9.560000000e+2  9.570000000e+2  9.580000000e+2  9.590000000e+2 ││
    ││      │ 9.600000000e+2  9.610000000e+2  9.620000000e+2  9.630000000e+2  9.640000000e+2 │ 9.650000000e+2  9.660000000e+2  9.670000000e+2  9.680000000e+2  9.690000000e+2 │ 9.700000000e+2  9.710000000e+2  9.720000000e+2  9.730000000e+2  9.740000000e+2 │ 9.750000000e+2  9.760000000e+2  9.770000000e+2  9.780000000e+2  9.790000000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 9.800000000e+2  9.810000000e+2  9.820000000e+2  9.830000000e+2  9.840000000e+2 │ 9.850000000e+2  9.860000000e+2  9.870000000e+2  9.880000000e+2  9.890000000e+2 │ 9.900000000e+2  9.910000000e+2  9.920000000e+2  9.930000000e+2  9.940000000e+2 │ 9.950000000e+2  9.960000000e+2  9.970000000e+2  9.980000000e+2  9.990000000e+2 ││
    ││axis 3│ 1.000000000e+3  1.001000000e+3  1.002000000e+3  1.003000000e+3  1.004000000e+3 │ 1.005000000e+3  1.006000000e+3  1.007000000e+3  1.008000000e+3  1.009000000e+3 │ 1.010000000e+3  1.011000000e+3  1.012000000e+3  1.013000000e+3  1.014000000e+3 │ 1.015000000e+3  1.016000000e+3  1.017000000e+3  1.018000000e+3  1.019000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.080000000e+3  1.081000000e+3  1.082000000e+3  1.083000000e+3  1.084000000e+3 │ 1.085000000e+3  1.086000000e+3  1.087000000e+3  1.088000000e+3  1.089000000e+3 │ 1.090000000e+3  1.091000000e+3  1.092000000e+3  1.093000000e+3  1.094000000e+3 │ 1.095000000e+3  1.096000000e+3  1.097000000e+3  1.098000000e+3  1.099000000e+3 ││
    ││      │ 1.100000000e+3  1.101000000e+3  1.102000000e+3  1.103000000e+3  1.104000000e+3 │ 1.105000000e+3  1.106000000e+3  1.107000000e+3  1.108000000e+3  1.109000000e+3 │ 1.110000000e+3  1.111000000e+3  1.112000000e+3  1.113000000e+3  1.114000000e+3 │ 1.115000000e+3  1.116000000e+3  1.117000000e+3  1.118000000e+3  1.119000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                            │ ...                                                                            │ ...                                                                            │ ...                                                                            ││
    ││axis 3│                                                                                │                                                                                │                                                                                │                                                                                ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.400000000e+3  1.401000000e+3  1.402000000e+3  1.403000000e+3  1.404000000e+3 │ 1.405000000e+3  1.406000000e+3  1.407000000e+3  1.408000000e+3  1.409000000e+3 │ 1.410000000e+3  1.411000000e+3  1.412000000e+3  1.413000000e+3  1.414000000e+3 │ 1.415000000e+3  1.416000000e+3  1.417000000e+3  1.418000000e+3  1.419000000e+3 ││
    ││axis 3│ 1.420000000e+3  1.421000000e+3  1.422000000e+3  1.423000000e+3  1.424000000e+3 │ 1.425000000e+3  1.426000000e+3  1.427000000e+3  1.428000000e+3  1.429000000e+3 │ 1.430000000e+3  1.431000000e+3  1.432000000e+3  1.433000000e+3  1.434000000e+3 │ 1.435000000e+3  1.436000000e+3  1.437000000e+3  1.438000000e+3  1.439000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.500000000e+3  1.501000000e+3  1.502000000e+3  1.503000000e+3  1.504000000e+3 │ 1.505000000e+3  1.506000000e+3  1.507000000e+3  1.508000000e+3  1.509000000e+3 │ 1.510000000e+3  1.511000000e+3  1.512000000e+3  1.513000000e+3  1.514000000e+3 │ 1.515000000e+3  1.516000000e+3  1.517000000e+3  1.518000000e+3  1.519000000e+3 ││
    ││      │ 1.520000000e+3  1.521000000e+3  1.522000000e+3  1.523000000e+3  1.524000000e+3 │ 1.525000000e+3  1.526000000e+3  1.527000000e+3  1.528000000e+3  1.529000000e+3 │ 1.530000000e+3  1.531000000e+3  1.532000000e+3  1.533000000e+3  1.534000000e+3 │ 1.535000000e+3  1.536000000e+3  1.537000000e+3  1.538000000e+3  1.539000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 1.540000000e+3  1.541000000e+3  1.542000000e+3  1.543000000e+3  1.544000000e+3 │ 1.545000000e+3  1.546000000e+3  1.547000000e+3  1.548000000e+3  1.549000000e+3 │ 1.550000000e+3  1.551000000e+3  1.552000000e+3  1.553000000e+3  1.554000000e+3 │ 1.555000000e+3  1.556000000e+3  1.557000000e+3  1.558000000e+3  1.559000000e+3 ││
    ││axis 3│ 1.560000000e+3  1.561000000e+3  1.562000000e+3  1.563000000e+3  1.564000000e+3 │ 1.565000000e+3  1.566000000e+3  1.567000000e+3  1.568000000e+3  1.569000000e+3 │ 1.570000000e+3  1.571000000e+3  1.572000000e+3  1.573000000e+3  1.574000000e+3 │ 1.575000000e+3  1.576000000e+3  1.577000000e+3  1.578000000e+3  1.579000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.640000000e+3  1.641000000e+3  1.642000000e+3  1.643000000e+3  1.644000000e+3 │ 1.645000000e+3  1.646000000e+3  1.647000000e+3  1.648000000e+3  1.649000000e+3 │ 1.650000000e+3  1.651000000e+3  1.652000000e+3  1.653000000e+3  1.654000000e+3 │ 1.655000000e+3  1.656000000e+3  1.657000000e+3  1.658000000e+3  1.659000000e+3 ││
    ││      │ 1.660000000e+3  1.661000000e+3  1.662000000e+3  1.663000000e+3  1.664000000e+3 │ 1.665000000e+3  1.666000000e+3  1.667000000e+3  1.668000000e+3  1.669000000e+3 │ 1.670000000e+3  1.671000000e+3  1.672000000e+3  1.673000000e+3  1.674000000e+3 │ 1.675000000e+3  1.676000000e+3  1.677000000e+3  1.678000000e+3  1.679000000e+3 ││
    │└──────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                                           │1 @ 4                                                                           │2 @ 4                                                                           │3 @ 4                                                                           ││
    ││      │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          │axis 5                                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.680000000e+3  1.681000000e+3  1.682000000e+3  1.683000000e+3  1.684000000e+3 │ 1.685000000e+3  1.686000000e+3  1.687000000e+3  1.688000000e+3  1.689000000e+3 │ 1.690000000e+3  1.691000000e+3  1.692000000e+3  1.693000000e+3  1.694000000e+3 │ 1.695000000e+3  1.696000000e+3  1.697000000e+3  1.698000000e+3  1.699000000e+3 ││
    ││axis 3│ 1.700000000e+3  1.701000000e+3  1.702000000e+3  1.703000000e+3  1.704000000e+3 │ 1.705000000e+3  1.706000000e+3  1.707000000e+3  1.708000000e+3  1.709000000e+3 │ 1.710000000e+3  1.711000000e+3  1.712000000e+3  1.713000000e+3  1.714000000e+3 │ 1.715000000e+3  1.716000000e+3  1.717000000e+3  1.718000000e+3  1.719000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.780000000e+3  1.781000000e+3  1.782000000e+3  1.783000000e+3  1.784000000e+3 │ 1.785000000e+3  1.786000000e+3  1.787000000e+3  1.788000000e+3  1.789000000e+3 │ 1.790000000e+3  1.791000000e+3  1.792000000e+3  1.793000000e+3  1.794000000e+3 │ 1.795000000e+3  1.796000000e+3  1.797000000e+3  1.798000000e+3  1.799000000e+3 ││
    ││      │ 1.800000000e+3  1.801000000e+3  1.802000000e+3  1.803000000e+3  1.804000000e+3 │ 1.805000000e+3  1.806000000e+3  1.807000000e+3  1.808000000e+3  1.809000000e+3 │ 1.810000000e+3  1.811000000e+3  1.812000000e+3  1.813000000e+3  1.814000000e+3 │ 1.815000000e+3  1.816000000e+3  1.817000000e+3  1.818000000e+3  1.819000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.820000000e+3  1.821000000e+3  1.822000000e+3  1.823000000e+3  1.824000000e+3 │ 1.825000000e+3  1.826000000e+3  1.827000000e+3  1.828000000e+3  1.829000000e+3 │ 1.830000000e+3  1.831000000e+3  1.832000000e+3  1.833000000e+3  1.834000000e+3 │ 1.835000000e+3  1.836000000e+3  1.837000000e+3  1.838000000e+3  1.839000000e+3 ││
    ││axis 3│ 1.840000000e+3  1.841000000e+3  1.842000000e+3  1.843000000e+3  1.844000000e+3 │ 1.845000000e+3  1.846000000e+3  1.847000000e+3  1.848000000e+3  1.849000000e+3 │ 1.850000000e+3  1.851000000e+3  1.852000000e+3  1.853000000e+3  1.854000000e+3 │ 1.855000000e+3  1.856000000e+3  1.857000000e+3  1.858000000e+3  1.859000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 1.920000000e+3  1.921000000e+3  1.922000000e+3  1.923000000e+3  1.924000000e+3 │ 1.925000000e+3  1.926000000e+3  1.927000000e+3  1.928000000e+3  1.929000000e+3 │ 1.930000000e+3  1.931000000e+3  1.932000000e+3  1.933000000e+3  1.934000000e+3 │ 1.935000000e+3  1.936000000e+3  1.937000000e+3  1.938000000e+3  1.939000000e+3 ││
    ││      │ 1.940000000e+3  1.941000000e+3  1.942000000e+3  1.943000000e+3  1.944000000e+3 │ 1.945000000e+3  1.946000000e+3  1.947000000e+3  1.948000000e+3  1.949000000e+3 │ 1.950000000e+3  1.951000000e+3  1.952000000e+3  1.953000000e+3  1.954000000e+3 │ 1.955000000e+3  1.956000000e+3  1.957000000e+3  1.958000000e+3  1.959000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                            │ ...                                                                            │ ...                                                                            │ ...                                                                            ││
    ││axis 3│                                                                                │                                                                                │                                                                                │                                                                                ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.240000000e+3  2.241000000e+3  2.242000000e+3  2.243000000e+3  2.244000000e+3 │ 2.245000000e+3  2.246000000e+3  2.247000000e+3  2.248000000e+3  2.249000000e+3 │ 2.250000000e+3  2.251000000e+3  2.252000000e+3  2.253000000e+3  2.254000000e+3 │ 2.255000000e+3  2.256000000e+3  2.257000000e+3  2.258000000e+3  2.259000000e+3 ││
    ││axis 3│ 2.260000000e+3  2.261000000e+3  2.262000000e+3  2.263000000e+3  2.264000000e+3 │ 2.265000000e+3  2.266000000e+3  2.267000000e+3  2.268000000e+3  2.269000000e+3 │ 2.270000000e+3  2.271000000e+3  2.272000000e+3  2.273000000e+3  2.274000000e+3 │ 2.275000000e+3  2.276000000e+3  2.277000000e+3  2.278000000e+3  2.279000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 2.340000000e+3  2.341000000e+3  2.342000000e+3  2.343000000e+3  2.344000000e+3 │ 2.345000000e+3  2.346000000e+3  2.347000000e+3  2.348000000e+3  2.349000000e+3 │ 2.350000000e+3  2.351000000e+3  2.352000000e+3  2.353000000e+3  2.354000000e+3 │ 2.355000000e+3  2.356000000e+3  2.357000000e+3  2.358000000e+3  2.359000000e+3 ││
    ││      │ 2.360000000e+3  2.361000000e+3  2.362000000e+3  2.363000000e+3  2.364000000e+3 │ 2.365000000e+3  2.366000000e+3  2.367000000e+3  2.368000000e+3  2.369000000e+3 │ 2.370000000e+3  2.371000000e+3  2.372000000e+3  2.373000000e+3  2.374000000e+3 │ 2.375000000e+3  2.376000000e+3  2.377000000e+3  2.378000000e+3  2.379000000e+3 ││
    │├──────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 2.380000000e+3  2.381000000e+3  2.382000000e+3  2.383000000e+3  2.384000000e+3 │ 2.385000000e+3  2.386000000e+3  2.387000000e+3  2.388000000e+3  2.389000000e+3 │ 2.390000000e+3  2.391000000e+3  2.392000000e+3  2.393000000e+3  2.394000000e+3 │ 2.395000000e+3  2.396000000e+3  2.397000000e+3  2.398000000e+3  2.399000000e+3 ││
    ││axis 3│ 2.400000000e+3  2.401000000e+3  2.402000000e+3  2.403000000e+3  2.404000000e+3 │ 2.405000000e+3  2.406000000e+3  2.407000000e+3  2.408000000e+3  2.409000000e+3 │ 2.410000000e+3  2.411000000e+3  2.412000000e+3  2.413000000e+3  2.414000000e+3 │ 2.415000000e+3  2.416000000e+3  2.417000000e+3  2.418000000e+3  2.419000000e+3 ││
    ││      │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            │ ...             ...             ...             ...             ...            ││
    ││      │ 2.480000000e+3  2.481000000e+3  2.482000000e+3  2.483000000e+3  2.484000000e+3 │ 2.485000000e+3  2.486000000e+3  2.487000000e+3  2.488000000e+3  2.489000000e+3 │ 2.490000000e+3  2.491000000e+3  2.492000000e+3  2.493000000e+3  2.494000000e+3 │ 2.495000000e+3  2.496000000e+3  2.497000000e+3  2.498000000e+3  2.499000000e+3 ││
    ││      │ 2.500000000e+3  2.501000000e+3  2.502000000e+3  2.503000000e+3  2.504000000e+3 │ 2.505000000e+3  2.506000000e+3  2.507000000e+3  2.508000000e+3  2.509000000e+3 │ 2.510000000e+3  2.511000000e+3  2.512000000e+3  2.513000000e+3  2.514000000e+3 │ 2.515000000e+3  2.516000000e+3  2.517000000e+3  2.518000000e+3  2.519000000e+3 ││
    │└──────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: =>_ho3 shape 0:2,1:5|4:4,5:7->2:6,3:3                                                                                                                                                                                                                                                      │
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                │3 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.000000000     2.000000000e+1  ...  1.000000000e+2  1.200000000e+2 │ 5.000000000     2.500000000e+1  ...  1.050000000e+2  1.250000000e+2 │ 1.000000000e+1  3.000000000e+1  ...  1.100000000e+2  1.300000000e+2 │ 1.500000000e+1  3.500000000e+1  ...  1.150000000e+2  1.350000000e+2 ││
    ││axis 3│ 8.400000000e+2  8.600000000e+2  ...  9.400000000e+2  9.600000000e+2 │ 8.450000000e+2  8.650000000e+2  ...  9.450000000e+2  9.650000000e+2 │ 8.500000000e+2  8.700000000e+2  ...  9.500000000e+2  9.700000000e+2 │ 8.550000000e+2  8.750000000e+2  ...  9.550000000e+2  9.750000000e+2 ││
    ││      │ 1.680000000e+3  1.700000000e+3  ...  1.780000000e+3  1.800000000e+3 │ 1.685000000e+3  1.705000000e+3  ...  1.785000000e+3  1.805000000e+3 │ 1.690000000e+3  1.710000000e+3  ...  1.790000000e+3  1.810000000e+3 │ 1.695000000e+3  1.715000000e+3  ...  1.795000000e+3  1.815000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.400000000e+2  1.600000000e+2  ...  2.400000000e+2  2.600000000e+2 │ 1.450000000e+2  1.650000000e+2  ...  2.450000000e+2  2.650000000e+2 │ 1.500000000e+2  1.700000000e+2  ...  2.500000000e+2  2.700000000e+2 │ 1.550000000e+2  1.750000000e+2  ...  2.550000000e+2  2.750000000e+2 ││
    ││axis 3│ 9.800000000e+2  1.000000000e+3  ...  1.080000000e+3  1.100000000e+3 │ 9.850000000e+2  1.005000000e+3  ...  1.085000000e+3  1.105000000e+3 │ 9.900000000e+2  1.010000000e+3  ...  1.090000000e+3  1.110000000e+3 │ 9.950000000e+2  1.015000000e+3  ...  1.095000000e+3  1.115000000e+3 ││
    ││      │ 1.820000000e+3  1.840000000e+3  ...  1.920000000e+3  1.940000000e+3 │ 1.825000000e+3  1.845000000e+3  ...  1.925000000e+3  1.945000000e+3 │ 1.830000000e+3  1.850000000e+3  ...  1.930000000e+3  1.950000000e+3 │ 1.835000000e+3  1.855000000e+3  ...  1.935000000e+3  1.955000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                 │ ...                                                                 │ ...                                                                 │ ...                                                                 ││
    ││axis 3│                                                                     │                                                                     │                                                                     │                                                                     ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.600000000e+2  5.800000000e+2  ...  6.600000000e+2  6.800000000e+2 │ 5.650000000e+2  5.850000000e+2  ...  6.650000000e+2  6.850000000e+2 │ 5.700000000e+2  5.900000000e+2  ...  6.700000000e+2  6.900000000e+2 │ 5.750000000e+2  5.950000000e+2  ...  6.750000000e+2  6.950000000e+2 ││
    ││axis 3│ 1.400000000e+3  1.420000000e+3  ...  1.500000000e+3  1.520000000e+3 │ 1.405000000e+3  1.425000000e+3  ...  1.505000000e+3  1.525000000e+3 │ 1.410000000e+3  1.430000000e+3  ...  1.510000000e+3  1.530000000e+3 │ 1.415000000e+3  1.435000000e+3  ...  1.515000000e+3  1.535000000e+3 ││
    ││      │ 2.240000000e+3  2.260000000e+3  ...  2.340000000e+3  2.360000000e+3 │ 2.245000000e+3  2.265000000e+3  ...  2.345000000e+3  2.365000000e+3 │ 2.250000000e+3  2.270000000e+3  ...  2.350000000e+3  2.370000000e+3 │ 2.255000000e+3  2.275000000e+3  ...  2.355000000e+3  2.375000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.000000000e+2  7.200000000e+2  ...  8.000000000e+2  8.200000000e+2 │ 7.050000000e+2  7.250000000e+2  ...  8.050000000e+2  8.250000000e+2 │ 7.100000000e+2  7.300000000e+2  ...  8.100000000e+2  8.300000000e+2 │ 7.150000000e+2  7.350000000e+2  ...  8.150000000e+2  8.350000000e+2 ││
    ││axis 3│ 1.540000000e+3  1.560000000e+3  ...  1.640000000e+3  1.660000000e+3 │ 1.545000000e+3  1.565000000e+3  ...  1.645000000e+3  1.665000000e+3 │ 1.550000000e+3  1.570000000e+3  ...  1.650000000e+3  1.670000000e+3 │ 1.555000000e+3  1.575000000e+3  ...  1.655000000e+3  1.675000000e+3 ││
    ││      │ 2.380000000e+3  2.400000000e+3  ...  2.480000000e+3  2.500000000e+3 │ 2.385000000e+3  2.405000000e+3  ...  2.485000000e+3  2.505000000e+3 │ 2.390000000e+3  2.410000000e+3  ...  2.490000000e+3  2.510000000e+3 │ 2.395000000e+3  2.415000000e+3  ...  2.495000000e+3  2.515000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                │3 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.000000000     2.100000000e+1  ...  1.010000000e+2  1.210000000e+2 │ 6.000000000     2.600000000e+1  ...  1.060000000e+2  1.260000000e+2 │ 1.100000000e+1  3.100000000e+1  ...  1.110000000e+2  1.310000000e+2 │ 1.600000000e+1  3.600000000e+1  ...  1.160000000e+2  1.360000000e+2 ││
    ││axis 3│ 8.410000000e+2  8.610000000e+2  ...  9.410000000e+2  9.610000000e+2 │ 8.460000000e+2  8.660000000e+2  ...  9.460000000e+2  9.660000000e+2 │ 8.510000000e+2  8.710000000e+2  ...  9.510000000e+2  9.710000000e+2 │ 8.560000000e+2  8.760000000e+2  ...  9.560000000e+2  9.760000000e+2 ││
    ││      │ 1.681000000e+3  1.701000000e+3  ...  1.781000000e+3  1.801000000e+3 │ 1.686000000e+3  1.706000000e+3  ...  1.786000000e+3  1.806000000e+3 │ 1.691000000e+3  1.711000000e+3  ...  1.791000000e+3  1.811000000e+3 │ 1.696000000e+3  1.716000000e+3  ...  1.796000000e+3  1.816000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.410000000e+2  1.610000000e+2  ...  2.410000000e+2  2.610000000e+2 │ 1.460000000e+2  1.660000000e+2  ...  2.460000000e+2  2.660000000e+2 │ 1.510000000e+2  1.710000000e+2  ...  2.510000000e+2  2.710000000e+2 │ 1.560000000e+2  1.760000000e+2  ...  2.560000000e+2  2.760000000e+2 ││
    ││axis 3│ 9.810000000e+2  1.001000000e+3  ...  1.081000000e+3  1.101000000e+3 │ 9.860000000e+2  1.006000000e+3  ...  1.086000000e+3  1.106000000e+3 │ 9.910000000e+2  1.011000000e+3  ...  1.091000000e+3  1.111000000e+3 │ 9.960000000e+2  1.016000000e+3  ...  1.096000000e+3  1.116000000e+3 ││
    ││      │ 1.821000000e+3  1.841000000e+3  ...  1.921000000e+3  1.941000000e+3 │ 1.826000000e+3  1.846000000e+3  ...  1.926000000e+3  1.946000000e+3 │ 1.831000000e+3  1.851000000e+3  ...  1.931000000e+3  1.951000000e+3 │ 1.836000000e+3  1.856000000e+3  ...  1.936000000e+3  1.956000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                 │ ...                                                                 │ ...                                                                 │ ...                                                                 ││
    ││axis 3│                                                                     │                                                                     │                                                                     │                                                                     ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.610000000e+2  5.810000000e+2  ...  6.610000000e+2  6.810000000e+2 │ 5.660000000e+2  5.860000000e+2  ...  6.660000000e+2  6.860000000e+2 │ 5.710000000e+2  5.910000000e+2  ...  6.710000000e+2  6.910000000e+2 │ 5.760000000e+2  5.960000000e+2  ...  6.760000000e+2  6.960000000e+2 ││
    ││axis 3│ 1.401000000e+3  1.421000000e+3  ...  1.501000000e+3  1.521000000e+3 │ 1.406000000e+3  1.426000000e+3  ...  1.506000000e+3  1.526000000e+3 │ 1.411000000e+3  1.431000000e+3  ...  1.511000000e+3  1.531000000e+3 │ 1.416000000e+3  1.436000000e+3  ...  1.516000000e+3  1.536000000e+3 ││
    ││      │ 2.241000000e+3  2.261000000e+3  ...  2.341000000e+3  2.361000000e+3 │ 2.246000000e+3  2.266000000e+3  ...  2.346000000e+3  2.366000000e+3 │ 2.251000000e+3  2.271000000e+3  ...  2.351000000e+3  2.371000000e+3 │ 2.256000000e+3  2.276000000e+3  ...  2.356000000e+3  2.376000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.010000000e+2  7.210000000e+2  ...  8.010000000e+2  8.210000000e+2 │ 7.060000000e+2  7.260000000e+2  ...  8.060000000e+2  8.260000000e+2 │ 7.110000000e+2  7.310000000e+2  ...  8.110000000e+2  8.310000000e+2 │ 7.160000000e+2  7.360000000e+2  ...  8.160000000e+2  8.360000000e+2 ││
    ││axis 3│ 1.541000000e+3  1.561000000e+3  ...  1.641000000e+3  1.661000000e+3 │ 1.546000000e+3  1.566000000e+3  ...  1.646000000e+3  1.666000000e+3 │ 1.551000000e+3  1.571000000e+3  ...  1.651000000e+3  1.671000000e+3 │ 1.556000000e+3  1.576000000e+3  ...  1.656000000e+3  1.676000000e+3 ││
    ││      │ 2.381000000e+3  2.401000000e+3  ...  2.481000000e+3  2.501000000e+3 │ 2.386000000e+3  2.406000000e+3  ...  2.486000000e+3  2.506000000e+3 │ 2.391000000e+3  2.411000000e+3  ...  2.491000000e+3  2.511000000e+3 │ 2.396000000e+3  2.416000000e+3  ...  2.496000000e+3  2.516000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                │3 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 2.000000000     2.200000000e+1  ...  1.020000000e+2  1.220000000e+2 │ 7.000000000     2.700000000e+1  ...  1.070000000e+2  1.270000000e+2 │ 1.200000000e+1  3.200000000e+1  ...  1.120000000e+2  1.320000000e+2 │ 1.700000000e+1  3.700000000e+1  ...  1.170000000e+2  1.370000000e+2 ││
    ││axis 3│ 8.420000000e+2  8.620000000e+2  ...  9.420000000e+2  9.620000000e+2 │ 8.470000000e+2  8.670000000e+2  ...  9.470000000e+2  9.670000000e+2 │ 8.520000000e+2  8.720000000e+2  ...  9.520000000e+2  9.720000000e+2 │ 8.570000000e+2  8.770000000e+2  ...  9.570000000e+2  9.770000000e+2 ││
    ││      │ 1.682000000e+3  1.702000000e+3  ...  1.782000000e+3  1.802000000e+3 │ 1.687000000e+3  1.707000000e+3  ...  1.787000000e+3  1.807000000e+3 │ 1.692000000e+3  1.712000000e+3  ...  1.792000000e+3  1.812000000e+3 │ 1.697000000e+3  1.717000000e+3  ...  1.797000000e+3  1.817000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.420000000e+2  1.620000000e+2  ...  2.420000000e+2  2.620000000e+2 │ 1.470000000e+2  1.670000000e+2  ...  2.470000000e+2  2.670000000e+2 │ 1.520000000e+2  1.720000000e+2  ...  2.520000000e+2  2.720000000e+2 │ 1.570000000e+2  1.770000000e+2  ...  2.570000000e+2  2.770000000e+2 ││
    ││axis 3│ 9.820000000e+2  1.002000000e+3  ...  1.082000000e+3  1.102000000e+3 │ 9.870000000e+2  1.007000000e+3  ...  1.087000000e+3  1.107000000e+3 │ 9.920000000e+2  1.012000000e+3  ...  1.092000000e+3  1.112000000e+3 │ 9.970000000e+2  1.017000000e+3  ...  1.097000000e+3  1.117000000e+3 ││
    ││      │ 1.822000000e+3  1.842000000e+3  ...  1.922000000e+3  1.942000000e+3 │ 1.827000000e+3  1.847000000e+3  ...  1.927000000e+3  1.947000000e+3 │ 1.832000000e+3  1.852000000e+3  ...  1.932000000e+3  1.952000000e+3 │ 1.837000000e+3  1.857000000e+3  ...  1.937000000e+3  1.957000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                 │ ...                                                                 │ ...                                                                 │ ...                                                                 ││
    ││axis 3│                                                                     │                                                                     │                                                                     │                                                                     ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.620000000e+2  5.820000000e+2  ...  6.620000000e+2  6.820000000e+2 │ 5.670000000e+2  5.870000000e+2  ...  6.670000000e+2  6.870000000e+2 │ 5.720000000e+2  5.920000000e+2  ...  6.720000000e+2  6.920000000e+2 │ 5.770000000e+2  5.970000000e+2  ...  6.770000000e+2  6.970000000e+2 ││
    ││axis 3│ 1.402000000e+3  1.422000000e+3  ...  1.502000000e+3  1.522000000e+3 │ 1.407000000e+3  1.427000000e+3  ...  1.507000000e+3  1.527000000e+3 │ 1.412000000e+3  1.432000000e+3  ...  1.512000000e+3  1.532000000e+3 │ 1.417000000e+3  1.437000000e+3  ...  1.517000000e+3  1.537000000e+3 ││
    ││      │ 2.242000000e+3  2.262000000e+3  ...  2.342000000e+3  2.362000000e+3 │ 2.247000000e+3  2.267000000e+3  ...  2.347000000e+3  2.367000000e+3 │ 2.252000000e+3  2.272000000e+3  ...  2.352000000e+3  2.372000000e+3 │ 2.257000000e+3  2.277000000e+3  ...  2.357000000e+3  2.377000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.020000000e+2  7.220000000e+2  ...  8.020000000e+2  8.220000000e+2 │ 7.070000000e+2  7.270000000e+2  ...  8.070000000e+2  8.270000000e+2 │ 7.120000000e+2  7.320000000e+2  ...  8.120000000e+2  8.320000000e+2 │ 7.170000000e+2  7.370000000e+2  ...  8.170000000e+2  8.370000000e+2 ││
    ││axis 3│ 1.542000000e+3  1.562000000e+3  ...  1.642000000e+3  1.662000000e+3 │ 1.547000000e+3  1.567000000e+3  ...  1.647000000e+3  1.667000000e+3 │ 1.552000000e+3  1.572000000e+3  ...  1.652000000e+3  1.672000000e+3 │ 1.557000000e+3  1.577000000e+3  ...  1.657000000e+3  1.677000000e+3 ││
    ││      │ 2.382000000e+3  2.402000000e+3  ...  2.482000000e+3  2.502000000e+3 │ 2.387000000e+3  2.407000000e+3  ...  2.487000000e+3  2.507000000e+3 │ 2.392000000e+3  2.412000000e+3  ...  2.492000000e+3  2.512000000e+3 │ 2.397000000e+3  2.417000000e+3  ...  2.497000000e+3  2.517000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                │3 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 3.000000000     2.300000000e+1  ...  1.030000000e+2  1.230000000e+2 │ 8.000000000     2.800000000e+1  ...  1.080000000e+2  1.280000000e+2 │ 1.300000000e+1  3.300000000e+1  ...  1.130000000e+2  1.330000000e+2 │ 1.800000000e+1  3.800000000e+1  ...  1.180000000e+2  1.380000000e+2 ││
    ││axis 3│ 8.430000000e+2  8.630000000e+2  ...  9.430000000e+2  9.630000000e+2 │ 8.480000000e+2  8.680000000e+2  ...  9.480000000e+2  9.680000000e+2 │ 8.530000000e+2  8.730000000e+2  ...  9.530000000e+2  9.730000000e+2 │ 8.580000000e+2  8.780000000e+2  ...  9.580000000e+2  9.780000000e+2 ││
    ││      │ 1.683000000e+3  1.703000000e+3  ...  1.783000000e+3  1.803000000e+3 │ 1.688000000e+3  1.708000000e+3  ...  1.788000000e+3  1.808000000e+3 │ 1.693000000e+3  1.713000000e+3  ...  1.793000000e+3  1.813000000e+3 │ 1.698000000e+3  1.718000000e+3  ...  1.798000000e+3  1.818000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.430000000e+2  1.630000000e+2  ...  2.430000000e+2  2.630000000e+2 │ 1.480000000e+2  1.680000000e+2  ...  2.480000000e+2  2.680000000e+2 │ 1.530000000e+2  1.730000000e+2  ...  2.530000000e+2  2.730000000e+2 │ 1.580000000e+2  1.780000000e+2  ...  2.580000000e+2  2.780000000e+2 ││
    ││axis 3│ 9.830000000e+2  1.003000000e+3  ...  1.083000000e+3  1.103000000e+3 │ 9.880000000e+2  1.008000000e+3  ...  1.088000000e+3  1.108000000e+3 │ 9.930000000e+2  1.013000000e+3  ...  1.093000000e+3  1.113000000e+3 │ 9.980000000e+2  1.018000000e+3  ...  1.098000000e+3  1.118000000e+3 ││
    ││      │ 1.823000000e+3  1.843000000e+3  ...  1.923000000e+3  1.943000000e+3 │ 1.828000000e+3  1.848000000e+3  ...  1.928000000e+3  1.948000000e+3 │ 1.833000000e+3  1.853000000e+3  ...  1.933000000e+3  1.953000000e+3 │ 1.838000000e+3  1.858000000e+3  ...  1.938000000e+3  1.958000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                 │ ...                                                                 │ ...                                                                 │ ...                                                                 ││
    ││axis 3│                                                                     │                                                                     │                                                                     │                                                                     ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.630000000e+2  5.830000000e+2  ...  6.630000000e+2  6.830000000e+2 │ 5.680000000e+2  5.880000000e+2  ...  6.680000000e+2  6.880000000e+2 │ 5.730000000e+2  5.930000000e+2  ...  6.730000000e+2  6.930000000e+2 │ 5.780000000e+2  5.980000000e+2  ...  6.780000000e+2  6.980000000e+2 ││
    ││axis 3│ 1.403000000e+3  1.423000000e+3  ...  1.503000000e+3  1.523000000e+3 │ 1.408000000e+3  1.428000000e+3  ...  1.508000000e+3  1.528000000e+3 │ 1.413000000e+3  1.433000000e+3  ...  1.513000000e+3  1.533000000e+3 │ 1.418000000e+3  1.438000000e+3  ...  1.518000000e+3  1.538000000e+3 ││
    ││      │ 2.243000000e+3  2.263000000e+3  ...  2.343000000e+3  2.363000000e+3 │ 2.248000000e+3  2.268000000e+3  ...  2.348000000e+3  2.368000000e+3 │ 2.253000000e+3  2.273000000e+3  ...  2.353000000e+3  2.373000000e+3 │ 2.258000000e+3  2.278000000e+3  ...  2.358000000e+3  2.378000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.030000000e+2  7.230000000e+2  ...  8.030000000e+2  8.230000000e+2 │ 7.080000000e+2  7.280000000e+2  ...  8.080000000e+2  8.280000000e+2 │ 7.130000000e+2  7.330000000e+2  ...  8.130000000e+2  8.330000000e+2 │ 7.180000000e+2  7.380000000e+2  ...  8.180000000e+2  8.380000000e+2 ││
    ││axis 3│ 1.543000000e+3  1.563000000e+3  ...  1.643000000e+3  1.663000000e+3 │ 1.548000000e+3  1.568000000e+3  ...  1.648000000e+3  1.668000000e+3 │ 1.553000000e+3  1.573000000e+3  ...  1.653000000e+3  1.673000000e+3 │ 1.558000000e+3  1.578000000e+3  ...  1.658000000e+3  1.678000000e+3 ││
    ││      │ 2.383000000e+3  2.403000000e+3  ...  2.483000000e+3  2.503000000e+3 │ 2.388000000e+3  2.408000000e+3  ...  2.488000000e+3  2.508000000e+3 │ 2.393000000e+3  2.413000000e+3  ...  2.493000000e+3  2.513000000e+3 │ 2.398000000e+3  2.418000000e+3  ...  2.498000000e+3  2.518000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                                                │1 @ 4                                                                │2 @ 4                                                                │3 @ 4                                                                ││
    ││      │axis 5                                                               │axis 5                                                               │axis 5                                                               │axis 5                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 4.000000000     2.400000000e+1  ...  1.040000000e+2  1.240000000e+2 │ 9.000000000     2.900000000e+1  ...  1.090000000e+2  1.290000000e+2 │ 1.400000000e+1  3.400000000e+1  ...  1.140000000e+2  1.340000000e+2 │ 1.900000000e+1  3.900000000e+1  ...  1.190000000e+2  1.390000000e+2 ││
    ││axis 3│ 8.440000000e+2  8.640000000e+2  ...  9.440000000e+2  9.640000000e+2 │ 8.490000000e+2  8.690000000e+2  ...  9.490000000e+2  9.690000000e+2 │ 8.540000000e+2  8.740000000e+2  ...  9.540000000e+2  9.740000000e+2 │ 8.590000000e+2  8.790000000e+2  ...  9.590000000e+2  9.790000000e+2 ││
    ││      │ 1.684000000e+3  1.704000000e+3  ...  1.784000000e+3  1.804000000e+3 │ 1.689000000e+3  1.709000000e+3  ...  1.789000000e+3  1.809000000e+3 │ 1.694000000e+3  1.714000000e+3  ...  1.794000000e+3  1.814000000e+3 │ 1.699000000e+3  1.719000000e+3  ...  1.799000000e+3  1.819000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.440000000e+2  1.640000000e+2  ...  2.440000000e+2  2.640000000e+2 │ 1.490000000e+2  1.690000000e+2  ...  2.490000000e+2  2.690000000e+2 │ 1.540000000e+2  1.740000000e+2  ...  2.540000000e+2  2.740000000e+2 │ 1.590000000e+2  1.790000000e+2  ...  2.590000000e+2  2.790000000e+2 ││
    ││axis 3│ 9.840000000e+2  1.004000000e+3  ...  1.084000000e+3  1.104000000e+3 │ 9.890000000e+2  1.009000000e+3  ...  1.089000000e+3  1.109000000e+3 │ 9.940000000e+2  1.014000000e+3  ...  1.094000000e+3  1.114000000e+3 │ 9.990000000e+2  1.019000000e+3  ...  1.099000000e+3  1.119000000e+3 ││
    ││      │ 1.824000000e+3  1.844000000e+3  ...  1.924000000e+3  1.944000000e+3 │ 1.829000000e+3  1.849000000e+3  ...  1.929000000e+3  1.949000000e+3 │ 1.834000000e+3  1.854000000e+3  ...  1.934000000e+3  1.954000000e+3 │ 1.839000000e+3  1.859000000e+3  ...  1.939000000e+3  1.959000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                 │ ...                                                                 │ ...                                                                 │ ...                                                                 ││
    ││axis 3│                                                                     │                                                                     │                                                                     │                                                                     ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.640000000e+2  5.840000000e+2  ...  6.640000000e+2  6.840000000e+2 │ 5.690000000e+2  5.890000000e+2  ...  6.690000000e+2  6.890000000e+2 │ 5.740000000e+2  5.940000000e+2  ...  6.740000000e+2  6.940000000e+2 │ 5.790000000e+2  5.990000000e+2  ...  6.790000000e+2  6.990000000e+2 ││
    ││axis 3│ 1.404000000e+3  1.424000000e+3  ...  1.504000000e+3  1.524000000e+3 │ 1.409000000e+3  1.429000000e+3  ...  1.509000000e+3  1.529000000e+3 │ 1.414000000e+3  1.434000000e+3  ...  1.514000000e+3  1.534000000e+3 │ 1.419000000e+3  1.439000000e+3  ...  1.519000000e+3  1.539000000e+3 ││
    ││      │ 2.244000000e+3  2.264000000e+3  ...  2.344000000e+3  2.364000000e+3 │ 2.249000000e+3  2.269000000e+3  ...  2.349000000e+3  2.369000000e+3 │ 2.254000000e+3  2.274000000e+3  ...  2.354000000e+3  2.374000000e+3 │ 2.259000000e+3  2.279000000e+3  ...  2.359000000e+3  2.379000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.040000000e+2  7.240000000e+2  ...  8.040000000e+2  8.240000000e+2 │ 7.090000000e+2  7.290000000e+2  ...  8.090000000e+2  8.290000000e+2 │ 7.140000000e+2  7.340000000e+2  ...  8.140000000e+2  8.340000000e+2 │ 7.190000000e+2  7.390000000e+2  ...  8.190000000e+2  8.390000000e+2 ││
    ││axis 3│ 1.544000000e+3  1.564000000e+3  ...  1.644000000e+3  1.664000000e+3 │ 1.549000000e+3  1.569000000e+3  ...  1.649000000e+3  1.669000000e+3 │ 1.554000000e+3  1.574000000e+3  ...  1.654000000e+3  1.674000000e+3 │ 1.559000000e+3  1.579000000e+3  ...  1.659000000e+3  1.679000000e+3 ││
    ││      │ 2.384000000e+3  2.404000000e+3  ...  2.484000000e+3  2.504000000e+3 │ 2.389000000e+3  2.409000000e+3  ...  2.489000000e+3  2.509000000e+3 │ 2.394000000e+3  2.414000000e+3  ...  2.494000000e+3  2.514000000e+3 │ 2.399000000e+3  2.419000000e+3  ...  2.499000000e+3  2.519000000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let%op ho4 = hey2 ++ "...b|...i->...o => i|o->b" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:5|2:7->1:3                                                                                                                                                                                                                                                                                                                                        │
    │┌──────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                                │1 @ 0                                                                │2 @ 0                                                                │3 @ 0                                                                │4 @ 0                                                                ││
    ││      │axis 2                                                               │axis 2                                                               │axis 2                                                               │axis 2                                                               │axis 2                                                               ││
    │├──────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 7.764000000e+4  7.860000000e+4  ...  8.244000000e+4  8.340000000e+4 │ 7.768800000e+4  7.864800000e+4  ...  8.248800000e+4  8.344800000e+4 │ 7.773600000e+4  7.869600000e+4  ...  8.253600000e+4  8.349600000e+4 │ 7.778400000e+4  7.874400000e+4  ...  8.258400000e+4  8.354400000e+4 │ 7.783200000e+4  7.879200000e+4  ...  8.263200000e+4  8.359200000e+4 ││
    ││      │ 1.179600000e+5  1.189200000e+5  ...  1.227600000e+5  1.237200000e+5 │ 1.180080000e+5  1.189680000e+5  ...  1.228080000e+5  1.237680000e+5 │ 1.180560000e+5  1.190160000e+5  ...  1.228560000e+5  1.238160000e+5 │ 1.181040000e+5  1.190640000e+5  ...  1.229040000e+5  1.238640000e+5 │ 1.181520000e+5  1.191120000e+5  ...  1.229520000e+5  1.239120000e+5 ││
    ││      │ 1.582800000e+5  1.592400000e+5  ...  1.630800000e+5  1.640400000e+5 │ 1.583280000e+5  1.592880000e+5  ...  1.631280000e+5  1.640880000e+5 │ 1.583760000e+5  1.593360000e+5  ...  1.631760000e+5  1.641360000e+5 │ 1.584240000e+5  1.593840000e+5  ...  1.632240000e+5  1.641840000e+5 │ 1.584720000e+5  1.594320000e+5  ...  1.632720000e+5  1.642320000e+5 ││
    │└──────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho5 = hey ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho5;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho5;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────┐
    │[6]: =>_ho5 shape 0:4                                              │
    │┌┬────────────────────────────────────────────────────────────────┐│
    │││axis 0                                                          ││
    │├┼────────────────────────────────────────────────────────────────┤│
    │││ 4.200000000e+1  6.000000000e+1  7.800000000e+1  9.600000000e+1 ││
    │└┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────┘
    |}];
  let hey3 = TDSL.range_of_shape ~output_dims:[ 3; 4 ] () in
  let%op ho6 = hey3 ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho6;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey3;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────┐
    │[7]: r3x4 shape 0:3,1:4                                            │
    │┌──────┬──────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                    ││
    │├──────┼──────────────────────────────────────────────────────────┤│
    ││axis 0│ 0.000000000  1.000000000  2.000000000     3.000000000    ││
    ││      │ 4.000000000  5.000000000  6.000000000     7.000000000    ││
    ││      │ 8.000000000  9.000000000  1.000000000e+1  1.100000000e+1 ││
    │└──────┴──────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho6;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────┐
    │[8]: =>_ho6 shape 0:4                                              │
    │┌┬────────────────────────────────────────────────────────────────┐│
    │││axis 0                                                          ││
    │├┼────────────────────────────────────────────────────────────────┤│
    │││ 1.200000000e+1  1.500000000e+1  1.800000000e+1  2.100000000e+1 ││
    │└┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let hey4 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3; 4 ] () in
  let%op ho7 = hey4 ++ "i->...o => ...io" in
  Train.forward_and_forget backend ctx ho7;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey4;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[9]: r3x4x2 shape 2:2->0:3,1:4                                                                       │
    │┌──────┬──────────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0                     │1 @ 0                           │2 @ 0                           ││
    ││      │axis 2                    │axis 2                          │axis 2                          ││
    │├──────┼──────────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000 │ 8.000000000     9.000000000    │ 1.600000000e+1  1.700000000e+1 ││
    ││      │ 2.000000000  3.000000000 │ 1.000000000e+1  1.100000000e+1 │ 1.800000000e+1  1.900000000e+1 ││
    ││      │ 4.000000000  5.000000000 │ 1.200000000e+1  1.300000000e+1 │ 2.000000000e+1  2.100000000e+1 ││
    ││      │ 6.000000000  7.000000000 │ 1.400000000e+1  1.500000000e+1 │ 2.200000000e+1  2.300000000e+1 ││
    │└──────┴──────────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho7;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────┐
    │[10]: =>_ho7 shape 0:3,1:2,2:4                                           │
    │┌──────┬────────────────────────────────────────────────────────────────┐│
    ││      │axis 2                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││0 @ 0 │ 0.000000000  2.000000000  4.000000000  6.000000000             ││
    ││axis 1│ 1.000000000  3.000000000  5.000000000  7.000000000             ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││1 @ 0 │ 8.000000000  1.000000000e+1  1.200000000e+1  1.400000000e+1    ││
    ││axis 1│ 9.000000000  1.100000000e+1  1.300000000e+1  1.500000000e+1    ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││2 @ 0 │ 1.600000000e+1  1.800000000e+1  2.000000000e+1  2.200000000e+1 ││
    ││axis 1│ 1.700000000e+1  1.900000000e+1  2.100000000e+1  2.300000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->...; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                                                                                                                 │
    │┌──────┬────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                               │1 @ 0                                                           │2 @ 0                                                           ││
    ││      │axis 2                                              │axis 2                                                          │axis 2                                                          ││
    │├──────┼────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000  2.000000000  3.000000000 │ 8.000000000     9.000000000     1.000000000e+1  1.100000000e+1 │ 1.600000000e+1  1.700000000e+1  1.800000000e+1  1.900000000e+1 ││
    ││      │ 4.000000000  5.000000000  6.000000000  7.000000000 │ 1.200000000e+1  1.300000000e+1  1.400000000e+1  1.500000000e+1 │ 2.000000000e+1  2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4                       │
    │┌──────┬─────────────┬─────────────┬────────────────┐│
    ││      │0 @ 0        │1 @ 0        │2 @ 0           ││
    ││      │axis 2       │axis 2       │axis 2          ││
    │├──────┼─────────────┼─────────────┼────────────────┤│
    ││axis 1│ 0.000000000 │ 4.000000000 │ 8.000000000    ││
    ││      │ 1.000000000 │ 5.000000000 │ 9.000000000    ││
    ││      │ 2.000000000 │ 6.000000000 │ 1.000000000e+1 ││
    ││      │ 3.000000000 │ 7.000000000 │ 1.100000000e+1 ││
    │└──────┴─────────────┴─────────────┴────────────────┘│
    └─────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                                                 │
    │┌──────┬────────────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││axis 0│ 0.000000000     6.000000000     1.600000000e+1  3.000000000e+1 ││
    ││      │ 8.000000000e+1  1.100000000e+2  1.440000000e+2  1.820000000e+2 ││
    ││      │ 2.880000000e+2  3.420000000e+2  4.000000000e+2  4.620000000e+2 ││
    │└──────┴────────────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let d = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let e = TDSL.range_of_shape ~input_dims:[ 4 ] ~output_dims:[ 3 ] () in
  let%op f = d *+ "i->...;j->... => ...ij" e in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3           │
    │┌──────┬──────────────────────────┐│
    ││      │axis 1                    ││
    │├──────┼──────────────────────────┤│
    ││axis 0│ 0.000000000  1.000000000 ││
    ││      │ 2.000000000  3.000000000 ││
    ││      │ 4.000000000  5.000000000 ││
    │└──────┴──────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────┐
    │[4]: r3x4 shape 1:4->0:3                                           │
    │┌──────┬──────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                    ││
    │├──────┼──────────────────────────────────────────────────────────┤│
    ││axis 0│ 0.000000000  1.000000000  2.000000000     3.000000000    ││
    ││      │ 4.000000000  5.000000000  6.000000000     7.000000000    ││
    ││      │ 8.000000000  9.000000000  1.000000000e+1  1.100000000e+1 ││
    │└──────┴──────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────┐
    │[5]: ;=>_f shape 0:3,1:2,2:4                                             │
    │┌──────┬────────────────────────────────────────────────────────────────┐│
    ││      │axis 2                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││0 @ 0 │ 0.000000000  0.000000000  0.000000000  0.000000000             ││
    ││axis 1│ 0.000000000  1.000000000  2.000000000  3.000000000             ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││1 @ 0 │ 8.000000000     1.000000000e+1  1.200000000e+1  1.400000000e+1 ││
    ││axis 1│ 1.200000000e+1  1.500000000e+1  1.800000000e+1  2.100000000e+1 ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││2 @ 0 │ 3.200000000e+1  3.600000000e+1  4.000000000e+1  4.400000000e+1 ││
    ││axis 1│ 4.000000000e+1  4.500000000e+1  5.000000000e+1  5.500000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 fixed dim axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|1->... => ...|..." in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:4                                                 │
    │┌──────┬────────────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││axis 0│ 1.000000000     4.000000000     7.000000000     1.000000000e+1 ││
    ││      │ 1.300000000e+1  1.600000000e+1  1.900000000e+1  2.200000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "...|...->... => ...|...->0" in
  let ctx = Train.forward_and_ctx backend ctx ho2 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                                         │
    │┌──────┬─────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                        │1 @ 0                                           ││
    ││      │axis 2                                       │axis 2                                          ││
    │├──────┼─────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000     2.000000000    │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 ││
    ││      │ 3.000000000  4.000000000     5.000000000    │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 6.000000000  7.000000000     8.000000000    │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 ││
    ││      │ 9.000000000  1.000000000e+1  1.100000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴─────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:2|2:3->1:1                                                                            │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                           │1 @ 0                                           ││
    ││      │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 1.800000000e+1  2.200000000e+1  2.600000000e+1 │ 6.600000000e+1  7.000000000e+1  7.400000000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let%op ho3 = hey2 ++ "...|...->... => 0" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3           │
    │┌──────┬──────────────────────────┐│
    ││      │axis 1                    ││
    │├──────┼──────────────────────────┤│
    ││axis 0│ 0.000000000  1.000000000 ││
    ││      │ 2.000000000  3.000000000 ││
    ││      │ 4.000000000  5.000000000 ││
    │└──────┴──────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌──────────────────────┐
    │[4]: =>_ho3 shape 0:1 │
    │┌┬────────────────┐   │
    │││axis 0          │   │
    │├┼────────────────┤   │
    │││ 1.500000000e+1 │   │
    │└┴────────────────┘   │
    └──────────────────────┘
    |}];
  let%op ho4 = hey2 ++ "i->j => i0j" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌────────────────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:2,1:1,2:3                   │
    │┌──────┬───────────────────────────────────────┐│
    ││      │axis 2                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││0 @ 0 │ 0.000000000  2.000000000  4.000000000 ││
    ││axis 1│                                       ││
    │├──────┼───────────────────────────────────────┤│
    ││1 @ 0 │ 1.000000000  3.000000000  5.000000000 ││
    ││axis 1│                                       ││
    │└──────┴───────────────────────────────────────┘│
    └────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum with fixed dim axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->1; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                                                                                                                 │
    │┌──────┬────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                               │1 @ 0                                                           │2 @ 0                                                           ││
    ││      │axis 2                                              │axis 2                                                          │axis 2                                                          ││
    │├──────┼────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000  2.000000000  3.000000000 │ 8.000000000     9.000000000     1.000000000e+1  1.100000000e+1 │ 1.600000000e+1  1.700000000e+1  1.800000000e+1  1.900000000e+1 ││
    ││      │ 4.000000000  5.000000000  6.000000000  7.000000000 │ 1.200000000e+1  1.300000000e+1  1.400000000e+1  1.500000000e+1 │ 2.000000000e+1  2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4                       │
    │┌──────┬─────────────┬─────────────┬────────────────┐│
    ││      │0 @ 0        │1 @ 0        │2 @ 0           ││
    ││      │axis 2       │axis 2       │axis 2          ││
    │├──────┼─────────────┼─────────────┼────────────────┤│
    ││axis 1│ 0.000000000 │ 4.000000000 │ 8.000000000    ││
    ││      │ 1.000000000 │ 5.000000000 │ 9.000000000    ││
    ││      │ 2.000000000 │ 6.000000000 │ 1.000000000e+1 ││
    ││      │ 3.000000000 │ 7.000000000 │ 1.100000000e+1 ││
    │└──────┴─────────────┴─────────────┴────────────────┘│
    └─────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                                                 │
    │┌──────┬────────────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┤│
    ││axis 0│ 0.000000000     5.000000000     1.200000000e+1  2.100000000e+1 ││
    ││      │ 4.800000000e+1  6.500000000e+1  8.400000000e+1  1.050000000e+2 ││
    ││      │ 1.600000000e+2  1.890000000e+2  2.200000000e+2  2.530000000e+2 ││
    │└──────┴────────────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "outer_sum simulating axis concatenation" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let ri = TDSL.range 3 in
  let%op ti = ri ++ "i=>i0" in
  (* Write position 2 of ti, otherwise shape inference concludes it's dim-1 and broadcasted. *)
  let%cd _ = ti =: 0 ++ "i=>i2" in
  let rj = TDSL.range 4 in
  let%op tj = rj ++ "j=>j1" in
  let rk = TDSL.range 5 in
  let%op tk = rk ++ "k=>k2" in
  let positions = TDSL.outer_sum "ijl;kl=>ijkl" (TDSL.outer_sum "il;jl=>ijl" ti tj) tk in
  Train.set_hosted tk.value;
  Train.forward_and_forget backend ctx positions;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ positions;
  [%expect
    {|
    ┌────────────────────────────────────────────────┐
    │[9]: ;=>+ shape 0:4,1:5,2:6,3:3                 │
    │┌──────┬───────────────────────────────────────┐│
    ││0 @ 0 │axis 3                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││0 @ 1 │ 0.000000000  0.000000000  0.000000000 ││
    ││axis 2│ 0.000000000  0.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 0.000000000  0.000000000  4.000000000 ││
    ││      │ 0.000000000  0.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││1 @ 1 │ 0.000000000  1.000000000  0.000000000 ││
    ││axis 2│ 0.000000000  1.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 0.000000000  1.000000000  4.000000000 ││
    ││      │ 0.000000000  1.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││2 @ 1 │ 0.000000000  2.000000000  0.000000000 ││
    ││axis 2│ 0.000000000  2.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 0.000000000  2.000000000  4.000000000 ││
    ││      │ 0.000000000  2.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││3 @ 1 │ 0.000000000  3.000000000  0.000000000 ││
    ││axis 2│ 0.000000000  3.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 0.000000000  3.000000000  4.000000000 ││
    ││      │ 0.000000000  3.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││4 @ 1 │ 0.000000000  4.000000000  0.000000000 ││
    ││axis 2│ 0.000000000  4.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 0.000000000  4.000000000  4.000000000 ││
    ││      │ 0.000000000  4.000000000  5.000000000 ││
    │└──────┴───────────────────────────────────────┘│
    ├────────────────────────────────────────────────┤
    │┌──────┬───────────────────────────────────────┐│
    ││1 @ 0 │axis 3                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││0 @ 1 │ 1.000000000  0.000000000  0.000000000 ││
    ││axis 2│ 1.000000000  0.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 1.000000000  0.000000000  4.000000000 ││
    ││      │ 1.000000000  0.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││1 @ 1 │ 1.000000000  1.000000000  0.000000000 ││
    ││axis 2│ 1.000000000  1.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 1.000000000  1.000000000  4.000000000 ││
    ││      │ 1.000000000  1.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││2 @ 1 │ 1.000000000  2.000000000  0.000000000 ││
    ││axis 2│ 1.000000000  2.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 1.000000000  2.000000000  4.000000000 ││
    ││      │ 1.000000000  2.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││3 @ 1 │ 1.000000000  3.000000000  0.000000000 ││
    ││axis 2│ 1.000000000  3.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 1.000000000  3.000000000  4.000000000 ││
    ││      │ 1.000000000  3.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││4 @ 1 │ 1.000000000  4.000000000  0.000000000 ││
    ││axis 2│ 1.000000000  4.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 1.000000000  4.000000000  4.000000000 ││
    ││      │ 1.000000000  4.000000000  5.000000000 ││
    │└──────┴───────────────────────────────────────┘│
    ├────────────────────────────────────────────────┤
    │┌──────┬───────────────────────────────────────┐│
    ││2 @ 0 │axis 3                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││0 @ 1 │ 2.000000000  0.000000000  0.000000000 ││
    ││axis 2│ 2.000000000  0.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 2.000000000  0.000000000  4.000000000 ││
    ││      │ 2.000000000  0.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││1 @ 1 │ 2.000000000  1.000000000  0.000000000 ││
    ││axis 2│ 2.000000000  1.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 2.000000000  1.000000000  4.000000000 ││
    ││      │ 2.000000000  1.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││2 @ 1 │ 2.000000000  2.000000000  0.000000000 ││
    ││axis 2│ 2.000000000  2.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 2.000000000  2.000000000  4.000000000 ││
    ││      │ 2.000000000  2.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││3 @ 1 │ 2.000000000  3.000000000  0.000000000 ││
    ││axis 2│ 2.000000000  3.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 2.000000000  3.000000000  4.000000000 ││
    ││      │ 2.000000000  3.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││4 @ 1 │ 2.000000000  4.000000000  0.000000000 ││
    ││axis 2│ 2.000000000  4.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 2.000000000  4.000000000  4.000000000 ││
    ││      │ 2.000000000  4.000000000  5.000000000 ││
    │└──────┴───────────────────────────────────────┘│
    ├────────────────────────────────────────────────┤
    │┌──────┬───────────────────────────────────────┐│
    ││3 @ 0 │axis 3                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││0 @ 1 │ 3.000000000  0.000000000  0.000000000 ││
    ││axis 2│ 3.000000000  0.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 3.000000000  0.000000000  4.000000000 ││
    ││      │ 3.000000000  0.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││1 @ 1 │ 3.000000000  1.000000000  0.000000000 ││
    ││axis 2│ 3.000000000  1.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 3.000000000  1.000000000  4.000000000 ││
    ││      │ 3.000000000  1.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││2 @ 1 │ 3.000000000  2.000000000  0.000000000 ││
    ││axis 2│ 3.000000000  2.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 3.000000000  2.000000000  4.000000000 ││
    ││      │ 3.000000000  2.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││3 @ 1 │ 3.000000000  3.000000000  0.000000000 ││
    ││axis 2│ 3.000000000  3.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 3.000000000  3.000000000  4.000000000 ││
    ││      │ 3.000000000  3.000000000  5.000000000 ││
    │├──────┼───────────────────────────────────────┤│
    ││4 @ 1 │ 3.000000000  4.000000000  0.000000000 ││
    ││axis 2│ 3.000000000  4.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 3.000000000  4.000000000  4.000000000 ││
    ││      │ 3.000000000  4.000000000  5.000000000 ││
    │└──────┴───────────────────────────────────────┘│
    └────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ti;
  [%expect
    {|
    ┌────────────────────────────────────────────────┐
    │[1]: =>_ti shape 0:4,1:3                        │
    │┌──────┬───────────────────────────────────────┐│
    ││      │axis 1                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││axis 0│ 0.000000000  0.000000000  0.000000000 ││
    ││      │ 1.000000000  0.000000000  0.000000000 ││
    ││      │ 2.000000000  0.000000000  0.000000000 ││
    ││      │ 3.000000000  0.000000000  0.000000000 ││
    │└──────┴───────────────────────────────────────┘│
    └────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ tk;
  [%expect
    {|
    ┌────────────────────────────────────────────────┐
    │[7]: =>_tk shape 0:6,1:3                        │
    │┌──────┬───────────────────────────────────────┐│
    ││      │axis 1                                 ││
    │├──────┼───────────────────────────────────────┤│
    ││axis 0│ 0.000000000  0.000000000  0.000000000 ││
    ││      │ 0.000000000  0.000000000  1.000000000 ││
    ││      │ ...          ...          ...         ││
    ││      │ 0.000000000  0.000000000  4.000000000 ││
    ││      │ 0.000000000  0.000000000  5.000000000 ││
    │└──────┴───────────────────────────────────────┘│
    └────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum with a leftmost input axis preserved as output axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a =
    TDSL.range_of_shape ~label:[ "a" ] ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] ()
  in
  let b =
    TDSL.range_of_shape ~label:[ "b" ] ~batch_dims:[ 3 ] ~input_dims:[ 2; 3 ] ~output_dims:[ 4 ] ()
  in
  let%op c = a *+ "...|i->1; ...|j...->i => ...|ij" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4_a shape 0:3|2:4->1:2                                                                                                                                                               │
    │┌──────┬────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                               │1 @ 0                                                           │2 @ 0                                                           ││
    ││      │axis 2                                              │axis 2                                                          │axis 2                                                          ││
    │├──────┼────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000  1.000000000  2.000000000  3.000000000 │ 8.000000000     9.000000000     1.000000000e+1  1.100000000e+1 │ 1.600000000e+1  1.700000000e+1  1.800000000e+1  1.900000000e+1 ││
    ││      │ 4.000000000  5.000000000  6.000000000  7.000000000 │ 1.200000000e+1  1.300000000e+1  1.400000000e+1  1.500000000e+1 │ 2.000000000e+1  2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r3x4x2x3_b shape 0:3|2:2,3:3->1:4                                                                    │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││0 @ 0 │0 @ 2                                           │1 @ 2                                           ││
    ││      │axis 3                                          │axis 3                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000     1.000000000     2.000000000    │ 3.000000000     4.000000000     5.000000000    ││
    ││      │ 6.000000000     7.000000000     8.000000000    │ 9.000000000     1.000000000e+1  1.100000000e+1 ││
    ││      │ 1.200000000e+1  1.300000000e+1  1.400000000e+1 │ 1.500000000e+1  1.600000000e+1  1.700000000e+1 ││
    ││      │ 1.800000000e+1  1.900000000e+1  2.000000000e+1 │ 2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││1 @ 0 │0 @ 2                                           │1 @ 2                                           ││
    ││      │axis 3                                          │axis 3                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 2.400000000e+1  2.500000000e+1  2.600000000e+1 │ 2.700000000e+1  2.800000000e+1  2.900000000e+1 ││
    ││      │ 3.000000000e+1  3.100000000e+1  3.200000000e+1 │ 3.300000000e+1  3.400000000e+1  3.500000000e+1 ││
    ││      │ 3.600000000e+1  3.700000000e+1  3.800000000e+1 │ 3.900000000e+1  4.000000000e+1  4.100000000e+1 ││
    ││      │ 4.200000000e+1  4.300000000e+1  4.400000000e+1 │ 4.500000000e+1  4.600000000e+1  4.700000000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││2 @ 0 │0 @ 2                                           │1 @ 2                                           ││
    ││      │axis 3                                          │axis 3                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 4.800000000e+1  4.900000000e+1  5.000000000e+1 │ 5.100000000e+1  5.200000000e+1  5.300000000e+1 ││
    ││      │ 5.400000000e+1  5.500000000e+1  5.600000000e+1 │ 5.700000000e+1  5.800000000e+1  5.900000000e+1 ││
    ││      │ 6.000000000e+1  6.100000000e+1  6.200000000e+1 │ 6.300000000e+1  6.400000000e+1  6.500000000e+1 ││
    ││      │ 6.600000000e+1  6.700000000e+1  6.800000000e+1 │ 6.900000000e+1  7.000000000e+1  7.100000000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4,2:2                                                                               │
    │┌──────┬────────────────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0                           │1 @ 0                           │2 @ 0                           ││
    ││      │axis 2                          │axis 2                          │axis 2                          ││
    │├──────┼────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 1.200000000e+1  4.800000000e+1 │ 9.000000000e+2  1.008000000e+3 │ 2.940000000e+3  3.120000000e+3 ││
    ││      │ 1.050000000e+2  1.500000000e+2 │ 1.209000000e+3  1.326000000e+3 │ 3.465000000e+3  3.654000000e+3 ││
    ││      │ 2.340000000e+2  2.880000000e+2 │ 1.554000000e+3  1.680000000e+3 │ 4.026000000e+3  4.224000000e+3 ││
    ││      │ 3.990000000e+2  4.620000000e+2 │ 1.935000000e+3  2.070000000e+3 │ 4.623000000e+3  4.830000000e+3 ││
    │└──────┴────────────────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum permuting two leftmost input axes as output axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a = TDSL.range_of_shape ~label:[ "a" ] ~input_dims:[ 2 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~label:[ "b" ] ~input_dims:[ 2; 3; 4 ] ~output_dims:[ 2 ] () in
  let%op c = a *+ "i->1; ij...->0 => ...->ji" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[0]: r2x2_a shape 1:2->0:2         │
    │┌──────┬──────────────────────────┐│
    ││      │axis 1                    ││
    │├──────┼──────────────────────────┤│
    ││axis 0│ 0.000000000  1.000000000 ││
    ││      │ 2.000000000  3.000000000 ││
    │└──────┴──────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r2x2x3x4_b shape 1:2,2:3,3:4->0:2                                                                                                                                                                     │
    │┌──────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 2                                                           │1 @ 2                                                           │2 @ 2                                                           ││
    ││      │axis 3                                                          │axis 3                                                          │axis 3                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││0 @ 1 │ 0.000000000     1.000000000     2.000000000     3.000000000    │ 4.000000000     5.000000000     6.000000000     7.000000000    │ 8.000000000     9.000000000     1.000000000e+1  1.100000000e+1 ││
    ││axis 0│ 2.400000000e+1  2.500000000e+1  2.600000000e+1  2.700000000e+1 │ 2.800000000e+1  2.900000000e+1  3.000000000e+1  3.100000000e+1 │ 3.200000000e+1  3.300000000e+1  3.400000000e+1  3.500000000e+1 ││
    │├──────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││1 @ 1 │ 1.200000000e+1  1.300000000e+1  1.400000000e+1  1.500000000e+1 │ 1.600000000e+1  1.700000000e+1  1.800000000e+1  1.900000000e+1 │ 2.000000000e+1  2.100000000e+1  2.200000000e+1  2.300000000e+1 ││
    ││axis 0│ 3.600000000e+1  3.700000000e+1  3.800000000e+1  3.900000000e+1 │ 4.000000000e+1  4.100000000e+1  4.200000000e+1  4.300000000e+1 │ 4.400000000e+1  4.500000000e+1  4.600000000e+1  4.700000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 2:4->0:3,1:2                                                                                                                                                                              │
    │┌──────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                           │1 @ 0                                                           │2 @ 0                                                           ││
    ││      │axis 2                                                          │axis 2                                                          │axis 2                                                          ││
    │├──────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.000000000     2.000000000     4.000000000     6.000000000    │ 8.000000000     1.000000000e+1  1.200000000e+1  1.400000000e+1 │ 1.600000000e+1  1.800000000e+1  2.000000000e+1  2.200000000e+1 ││
    ││      │ 3.600000000e+1  3.900000000e+1  4.200000000e+1  4.500000000e+1 │ 4.800000000e+1  5.100000000e+1  5.400000000e+1  5.700000000e+1 │ 6.000000000e+1  6.300000000e+1  6.600000000e+1  6.900000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
