open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module NTDSL = Operation.NTDSL
module Rand = Arrayjit.Rand.Lib

module type Backend = Arrayjit.Backend_intf.Backend

let%expect_test "einsum1 permute axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => o|b->i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:4|2:2->1:3                                                                                      │
    │┌──────┬─────────────────────────┬─────────────────────────┬─────────────────────────┬────────────────────────────┐│
    ││      │0 @ 0                    │1 @ 0                    │2 @ 0                    │3 @ 0                       ││
    ││      │axis 2                   │axis 2                   │axis 2                   │axis 2                      ││
    │├──────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼────────────────────────────┤│
    ││axis 1│ 0.0000000  1.2000000e+1 │ 3.0000000  1.5000000e+1 │ 6.0000000  1.8000000e+1 │ 9.0000000     2.1000000e+1 ││
    ││      │ 1.0000000  1.3000000e+1 │ 4.0000000  1.6000000e+1 │ 7.0000000  1.9000000e+1 │ 1.0000000e+1  2.2000000e+1 ││
    ││      │ 2.0000000  1.4000000e+1 │ 5.0000000  1.7000000e+1 │ 8.0000000  2.0000000e+1 │ 1.1000000e+1  2.3000000e+1 ││
    │└──────┴─────────────────────────┴─────────────────────────┴─────────────────────────┴────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => cf|ae->db" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                                                                                                                    │
    │┌──────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                 │1 @ 4                                                                 │2 @ 4                                                                 │3 @ 4                                                                 ││
    ││      │axis 5                                                                │axis 5                                                                │axis 5                                                                │axis 5                                                                ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000     1.0000000     2.0000000     3.0000000     4.0000000    │ 5.0000000     6.0000000     7.0000000     8.0000000     9.0000000    │ 1.0000000e+1  1.1000000e+1  1.2000000e+1  1.3000000e+1  1.4000000e+1 │ 1.5000000e+1  1.6000000e+1  1.7000000e+1  1.8000000e+1  1.9000000e+1 ││
    ││axis 3│ 2.0000000e+1  2.1000000e+1  2.2000000e+1  2.3000000e+1  2.4000000e+1 │ 2.5000000e+1  2.6000000e+1  2.7000000e+1  2.8000000e+1  2.9000000e+1 │ 3.0000000e+1  3.1000000e+1  3.2000000e+1  3.3000000e+1  3.4000000e+1 │ 3.5000000e+1  3.6000000e+1  3.7000000e+1  3.8000000e+1  3.9000000e+1 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.0000000e+2  1.0100000e+2  1.0200000e+2  1.0300000e+2  1.0400000e+2 │ 1.0500000e+2  1.0600000e+2  1.0700000e+2  1.0800000e+2  1.0900000e+2 │ 1.1000000e+2  1.1100000e+2  1.1200000e+2  1.1300000e+2  1.1400000e+2 │ 1.1500000e+2  1.1600000e+2  1.1700000e+2  1.1800000e+2  1.1900000e+2 ││
    ││      │ 1.2000000e+2  1.2100000e+2  1.2200000e+2  1.2300000e+2  1.2400000e+2 │ 1.2500000e+2  1.2600000e+2  1.2700000e+2  1.2800000e+2  1.2900000e+2 │ 1.3000000e+2  1.3100000e+2  1.3200000e+2  1.3300000e+2  1.3400000e+2 │ 1.3500000e+2  1.3600000e+2  1.3700000e+2  1.3800000e+2  1.3900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4000000e+2  1.4100000e+2  1.4200000e+2  1.4300000e+2  1.4400000e+2 │ 1.4500000e+2  1.4600000e+2  1.4700000e+2  1.4800000e+2  1.4900000e+2 │ 1.5000000e+2  1.5100000e+2  1.5200000e+2  1.5300000e+2  1.5400000e+2 │ 1.5500000e+2  1.5600000e+2  1.5700000e+2  1.5800000e+2  1.5900000e+2 ││
    ││axis 3│ 1.6000000e+2  1.6100000e+2  1.6200000e+2  1.6300000e+2  1.6400000e+2 │ 1.6500000e+2  1.6600000e+2  1.6700000e+2  1.6800000e+2  1.6900000e+2 │ 1.7000000e+2  1.7100000e+2  1.7200000e+2  1.7300000e+2  1.7400000e+2 │ 1.7500000e+2  1.7600000e+2  1.7700000e+2  1.7800000e+2  1.7900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 2.4000000e+2  2.4100000e+2  2.4200000e+2  2.4300000e+2  2.4400000e+2 │ 2.4500000e+2  2.4600000e+2  2.4700000e+2  2.4800000e+2  2.4900000e+2 │ 2.5000000e+2  2.5100000e+2  2.5200000e+2  2.5300000e+2  2.5400000e+2 │ 2.5500000e+2  2.5600000e+2  2.5700000e+2  2.5800000e+2  2.5900000e+2 ││
    ││      │ 2.6000000e+2  2.6100000e+2  2.6200000e+2  2.6300000e+2  2.6400000e+2 │ 2.6500000e+2  2.6600000e+2  2.6700000e+2  2.6800000e+2  2.6900000e+2 │ 2.7000000e+2  2.7100000e+2  2.7200000e+2  2.7300000e+2  2.7400000e+2 │ 2.7500000e+2  2.7600000e+2  2.7700000e+2  2.7800000e+2  2.7900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                  │ ...                                                                  │ ...                                                                  │ ...                                                                  ││
    ││axis 3│                                                                      │                                                                      │                                                                      │                                                                      ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6000000e+2  5.6100000e+2  5.6200000e+2  5.6300000e+2  5.6400000e+2 │ 5.6500000e+2  5.6600000e+2  5.6700000e+2  5.6800000e+2  5.6900000e+2 │ 5.7000000e+2  5.7100000e+2  5.7200000e+2  5.7300000e+2  5.7400000e+2 │ 5.7500000e+2  5.7600000e+2  5.7700000e+2  5.7800000e+2  5.7900000e+2 ││
    ││axis 3│ 5.8000000e+2  5.8100000e+2  5.8200000e+2  5.8300000e+2  5.8400000e+2 │ 5.8500000e+2  5.8600000e+2  5.8700000e+2  5.8800000e+2  5.8900000e+2 │ 5.9000000e+2  5.9100000e+2  5.9200000e+2  5.9300000e+2  5.9400000e+2 │ 5.9500000e+2  5.9600000e+2  5.9700000e+2  5.9800000e+2  5.9900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 6.6000000e+2  6.6100000e+2  6.6200000e+2  6.6300000e+2  6.6400000e+2 │ 6.6500000e+2  6.6600000e+2  6.6700000e+2  6.6800000e+2  6.6900000e+2 │ 6.7000000e+2  6.7100000e+2  6.7200000e+2  6.7300000e+2  6.7400000e+2 │ 6.7500000e+2  6.7600000e+2  6.7700000e+2  6.7800000e+2  6.7900000e+2 ││
    ││      │ 6.8000000e+2  6.8100000e+2  6.8200000e+2  6.8300000e+2  6.8400000e+2 │ 6.8500000e+2  6.8600000e+2  6.8700000e+2  6.8800000e+2  6.8900000e+2 │ 6.9000000e+2  6.9100000e+2  6.9200000e+2  6.9300000e+2  6.9400000e+2 │ 6.9500000e+2  6.9600000e+2  6.9700000e+2  6.9800000e+2  6.9900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0000000e+2  7.0100000e+2  7.0200000e+2  7.0300000e+2  7.0400000e+2 │ 7.0500000e+2  7.0600000e+2  7.0700000e+2  7.0800000e+2  7.0900000e+2 │ 7.1000000e+2  7.1100000e+2  7.1200000e+2  7.1300000e+2  7.1400000e+2 │ 7.1500000e+2  7.1600000e+2  7.1700000e+2  7.1800000e+2  7.1900000e+2 ││
    ││axis 3│ 7.2000000e+2  7.2100000e+2  7.2200000e+2  7.2300000e+2  7.2400000e+2 │ 7.2500000e+2  7.2600000e+2  7.2700000e+2  7.2800000e+2  7.2900000e+2 │ 7.3000000e+2  7.3100000e+2  7.3200000e+2  7.3300000e+2  7.3400000e+2 │ 7.3500000e+2  7.3600000e+2  7.3700000e+2  7.3800000e+2  7.3900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 8.0000000e+2  8.0100000e+2  8.0200000e+2  8.0300000e+2  8.0400000e+2 │ 8.0500000e+2  8.0600000e+2  8.0700000e+2  8.0800000e+2  8.0900000e+2 │ 8.1000000e+2  8.1100000e+2  8.1200000e+2  8.1300000e+2  8.1400000e+2 │ 8.1500000e+2  8.1600000e+2  8.1700000e+2  8.1800000e+2  8.1900000e+2 ││
    ││      │ 8.2000000e+2  8.2100000e+2  8.2200000e+2  8.2300000e+2  8.2400000e+2 │ 8.2500000e+2  8.2600000e+2  8.2700000e+2  8.2800000e+2  8.2900000e+2 │ 8.3000000e+2  8.3100000e+2  8.3200000e+2  8.3300000e+2  8.3400000e+2 │ 8.3500000e+2  8.3600000e+2  8.3700000e+2  8.3800000e+2  8.3900000e+2 ││
    │└──────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                 │1 @ 4                                                                 │2 @ 4                                                                 │3 @ 4                                                                 ││
    ││      │axis 5                                                                │axis 5                                                                │axis 5                                                                │axis 5                                                                ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 8.4000000e+2  8.4100000e+2  8.4200000e+2  8.4300000e+2  8.4400000e+2 │ 8.4500000e+2  8.4600000e+2  8.4700000e+2  8.4800000e+2  8.4900000e+2 │ 8.5000000e+2  8.5100000e+2  8.5200000e+2  8.5300000e+2  8.5400000e+2 │ 8.5500000e+2  8.5600000e+2  8.5700000e+2  8.5800000e+2  8.5900000e+2 ││
    ││axis 3│ 8.6000000e+2  8.6100000e+2  8.6200000e+2  8.6300000e+2  8.6400000e+2 │ 8.6500000e+2  8.6600000e+2  8.6700000e+2  8.6800000e+2  8.6900000e+2 │ 8.7000000e+2  8.7100000e+2  8.7200000e+2  8.7300000e+2  8.7400000e+2 │ 8.7500000e+2  8.7600000e+2  8.7700000e+2  8.7800000e+2  8.7900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 9.4000000e+2  9.4100000e+2  9.4200000e+2  9.4300000e+2  9.4400000e+2 │ 9.4500000e+2  9.4600000e+2  9.4700000e+2  9.4800000e+2  9.4900000e+2 │ 9.5000000e+2  9.5100000e+2  9.5200000e+2  9.5300000e+2  9.5400000e+2 │ 9.5500000e+2  9.5600000e+2  9.5700000e+2  9.5800000e+2  9.5900000e+2 ││
    ││      │ 9.6000000e+2  9.6100000e+2  9.6200000e+2  9.6300000e+2  9.6400000e+2 │ 9.6500000e+2  9.6600000e+2  9.6700000e+2  9.6800000e+2  9.6900000e+2 │ 9.7000000e+2  9.7100000e+2  9.7200000e+2  9.7300000e+2  9.7400000e+2 │ 9.7500000e+2  9.7600000e+2  9.7700000e+2  9.7800000e+2  9.7900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 9.8000000e+2  9.8100000e+2  9.8200000e+2  9.8300000e+2  9.8400000e+2 │ 9.8500000e+2  9.8600000e+2  9.8700000e+2  9.8800000e+2  9.8900000e+2 │ 9.9000000e+2  9.9100000e+2  9.9200000e+2  9.9300000e+2  9.9400000e+2 │ 9.9500000e+2  9.9600000e+2  9.9700000e+2  9.9800000e+2  9.9900000e+2 ││
    ││axis 3│ 1.0000000e+3  1.0010000e+3  1.0020000e+3  1.0030000e+3  1.0040000e+3 │ 1.0050000e+3  1.0060000e+3  1.0070000e+3  1.0080000e+3  1.0090000e+3 │ 1.0100000e+3  1.0110000e+3  1.0120000e+3  1.0130000e+3  1.0140000e+3 │ 1.0150000e+3  1.0160000e+3  1.0170000e+3  1.0180000e+3  1.0190000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.0800000e+3  1.0810000e+3  1.0820000e+3  1.0830000e+3  1.0840000e+3 │ 1.0850000e+3  1.0860000e+3  1.0870000e+3  1.0880000e+3  1.0890000e+3 │ 1.0900000e+3  1.0910000e+3  1.0920000e+3  1.0930000e+3  1.0940000e+3 │ 1.0950000e+3  1.0960000e+3  1.0970000e+3  1.0980000e+3  1.0990000e+3 ││
    ││      │ 1.1000000e+3  1.1010000e+3  1.1020000e+3  1.1030000e+3  1.1040000e+3 │ 1.1050000e+3  1.1060000e+3  1.1070000e+3  1.1080000e+3  1.1090000e+3 │ 1.1100000e+3  1.1110000e+3  1.1120000e+3  1.1130000e+3  1.1140000e+3 │ 1.1150000e+3  1.1160000e+3  1.1170000e+3  1.1180000e+3  1.1190000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                  │ ...                                                                  │ ...                                                                  │ ...                                                                  ││
    ││axis 3│                                                                      │                                                                      │                                                                      │                                                                      ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.4000000e+3  1.4010000e+3  1.4020000e+3  1.4030000e+3  1.4040000e+3 │ 1.4050000e+3  1.4060000e+3  1.4070000e+3  1.4080000e+3  1.4090000e+3 │ 1.4100000e+3  1.4110000e+3  1.4120000e+3  1.4130000e+3  1.4140000e+3 │ 1.4150000e+3  1.4160000e+3  1.4170000e+3  1.4180000e+3  1.4190000e+3 ││
    ││axis 3│ 1.4200000e+3  1.4210000e+3  1.4220000e+3  1.4230000e+3  1.4240000e+3 │ 1.4250000e+3  1.4260000e+3  1.4270000e+3  1.4280000e+3  1.4290000e+3 │ 1.4300000e+3  1.4310000e+3  1.4320000e+3  1.4330000e+3  1.4340000e+3 │ 1.4350000e+3  1.4360000e+3  1.4370000e+3  1.4380000e+3  1.4390000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.5000000e+3  1.5010000e+3  1.5020000e+3  1.5030000e+3  1.5040000e+3 │ 1.5050000e+3  1.5060000e+3  1.5070000e+3  1.5080000e+3  1.5090000e+3 │ 1.5100000e+3  1.5110000e+3  1.5120000e+3  1.5130000e+3  1.5140000e+3 │ 1.5150000e+3  1.5160000e+3  1.5170000e+3  1.5180000e+3  1.5190000e+3 ││
    ││      │ 1.5200000e+3  1.5210000e+3  1.5220000e+3  1.5230000e+3  1.5240000e+3 │ 1.5250000e+3  1.5260000e+3  1.5270000e+3  1.5280000e+3  1.5290000e+3 │ 1.5300000e+3  1.5310000e+3  1.5320000e+3  1.5330000e+3  1.5340000e+3 │ 1.5350000e+3  1.5360000e+3  1.5370000e+3  1.5380000e+3  1.5390000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 1.5400000e+3  1.5410000e+3  1.5420000e+3  1.5430000e+3  1.5440000e+3 │ 1.5450000e+3  1.5460000e+3  1.5470000e+3  1.5480000e+3  1.5490000e+3 │ 1.5500000e+3  1.5510000e+3  1.5520000e+3  1.5530000e+3  1.5540000e+3 │ 1.5550000e+3  1.5560000e+3  1.5570000e+3  1.5580000e+3  1.5590000e+3 ││
    ││axis 3│ 1.5600000e+3  1.5610000e+3  1.5620000e+3  1.5630000e+3  1.5640000e+3 │ 1.5650000e+3  1.5660000e+3  1.5670000e+3  1.5680000e+3  1.5690000e+3 │ 1.5700000e+3  1.5710000e+3  1.5720000e+3  1.5730000e+3  1.5740000e+3 │ 1.5750000e+3  1.5760000e+3  1.5770000e+3  1.5780000e+3  1.5790000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.6400000e+3  1.6410000e+3  1.6420000e+3  1.6430000e+3  1.6440000e+3 │ 1.6450000e+3  1.6460000e+3  1.6470000e+3  1.6480000e+3  1.6490000e+3 │ 1.6500000e+3  1.6510000e+3  1.6520000e+3  1.6530000e+3  1.6540000e+3 │ 1.6550000e+3  1.6560000e+3  1.6570000e+3  1.6580000e+3  1.6590000e+3 ││
    ││      │ 1.6600000e+3  1.6610000e+3  1.6620000e+3  1.6630000e+3  1.6640000e+3 │ 1.6650000e+3  1.6660000e+3  1.6670000e+3  1.6680000e+3  1.6690000e+3 │ 1.6700000e+3  1.6710000e+3  1.6720000e+3  1.6730000e+3  1.6740000e+3 │ 1.6750000e+3  1.6760000e+3  1.6770000e+3  1.6780000e+3  1.6790000e+3 ││
    │└──────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                                 │1 @ 4                                                                 │2 @ 4                                                                 │3 @ 4                                                                 ││
    ││      │axis 5                                                                │axis 5                                                                │axis 5                                                                │axis 5                                                                ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.6800000e+3  1.6810000e+3  1.6820000e+3  1.6830000e+3  1.6840000e+3 │ 1.6850000e+3  1.6860000e+3  1.6870000e+3  1.6880000e+3  1.6890000e+3 │ 1.6900000e+3  1.6910000e+3  1.6920000e+3  1.6930000e+3  1.6940000e+3 │ 1.6950000e+3  1.6960000e+3  1.6970000e+3  1.6980000e+3  1.6990000e+3 ││
    ││axis 3│ 1.7000000e+3  1.7010000e+3  1.7020000e+3  1.7030000e+3  1.7040000e+3 │ 1.7050000e+3  1.7060000e+3  1.7070000e+3  1.7080000e+3  1.7090000e+3 │ 1.7100000e+3  1.7110000e+3  1.7120000e+3  1.7130000e+3  1.7140000e+3 │ 1.7150000e+3  1.7160000e+3  1.7170000e+3  1.7180000e+3  1.7190000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.7800000e+3  1.7810000e+3  1.7820000e+3  1.7830000e+3  1.7840000e+3 │ 1.7850000e+3  1.7860000e+3  1.7870000e+3  1.7880000e+3  1.7890000e+3 │ 1.7900000e+3  1.7910000e+3  1.7920000e+3  1.7930000e+3  1.7940000e+3 │ 1.7950000e+3  1.7960000e+3  1.7970000e+3  1.7980000e+3  1.7990000e+3 ││
    ││      │ 1.8000000e+3  1.8010000e+3  1.8020000e+3  1.8030000e+3  1.8040000e+3 │ 1.8050000e+3  1.8060000e+3  1.8070000e+3  1.8080000e+3  1.8090000e+3 │ 1.8100000e+3  1.8110000e+3  1.8120000e+3  1.8130000e+3  1.8140000e+3 │ 1.8150000e+3  1.8160000e+3  1.8170000e+3  1.8180000e+3  1.8190000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.8200000e+3  1.8210000e+3  1.8220000e+3  1.8230000e+3  1.8240000e+3 │ 1.8250000e+3  1.8260000e+3  1.8270000e+3  1.8280000e+3  1.8290000e+3 │ 1.8300000e+3  1.8310000e+3  1.8320000e+3  1.8330000e+3  1.8340000e+3 │ 1.8350000e+3  1.8360000e+3  1.8370000e+3  1.8380000e+3  1.8390000e+3 ││
    ││axis 3│ 1.8400000e+3  1.8410000e+3  1.8420000e+3  1.8430000e+3  1.8440000e+3 │ 1.8450000e+3  1.8460000e+3  1.8470000e+3  1.8480000e+3  1.8490000e+3 │ 1.8500000e+3  1.8510000e+3  1.8520000e+3  1.8530000e+3  1.8540000e+3 │ 1.8550000e+3  1.8560000e+3  1.8570000e+3  1.8580000e+3  1.8590000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.9200000e+3  1.9210000e+3  1.9220000e+3  1.9230000e+3  1.9240000e+3 │ 1.9250000e+3  1.9260000e+3  1.9270000e+3  1.9280000e+3  1.9290000e+3 │ 1.9300000e+3  1.9310000e+3  1.9320000e+3  1.9330000e+3  1.9340000e+3 │ 1.9350000e+3  1.9360000e+3  1.9370000e+3  1.9380000e+3  1.9390000e+3 ││
    ││      │ 1.9400000e+3  1.9410000e+3  1.9420000e+3  1.9430000e+3  1.9440000e+3 │ 1.9450000e+3  1.9460000e+3  1.9470000e+3  1.9480000e+3  1.9490000e+3 │ 1.9500000e+3  1.9510000e+3  1.9520000e+3  1.9530000e+3  1.9540000e+3 │ 1.9550000e+3  1.9560000e+3  1.9570000e+3  1.9580000e+3  1.9590000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                  │ ...                                                                  │ ...                                                                  │ ...                                                                  ││
    ││axis 3│                                                                      │                                                                      │                                                                      │                                                                      ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.2400000e+3  2.2410000e+3  2.2420000e+3  2.2430000e+3  2.2440000e+3 │ 2.2450000e+3  2.2460000e+3  2.2470000e+3  2.2480000e+3  2.2490000e+3 │ 2.2500000e+3  2.2510000e+3  2.2520000e+3  2.2530000e+3  2.2540000e+3 │ 2.2550000e+3  2.2560000e+3  2.2570000e+3  2.2580000e+3  2.2590000e+3 ││
    ││axis 3│ 2.2600000e+3  2.2610000e+3  2.2620000e+3  2.2630000e+3  2.2640000e+3 │ 2.2650000e+3  2.2660000e+3  2.2670000e+3  2.2680000e+3  2.2690000e+3 │ 2.2700000e+3  2.2710000e+3  2.2720000e+3  2.2730000e+3  2.2740000e+3 │ 2.2750000e+3  2.2760000e+3  2.2770000e+3  2.2780000e+3  2.2790000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 2.3400000e+3  2.3410000e+3  2.3420000e+3  2.3430000e+3  2.3440000e+3 │ 2.3450000e+3  2.3460000e+3  2.3470000e+3  2.3480000e+3  2.3490000e+3 │ 2.3500000e+3  2.3510000e+3  2.3520000e+3  2.3530000e+3  2.3540000e+3 │ 2.3550000e+3  2.3560000e+3  2.3570000e+3  2.3580000e+3  2.3590000e+3 ││
    ││      │ 2.3600000e+3  2.3610000e+3  2.3620000e+3  2.3630000e+3  2.3640000e+3 │ 2.3650000e+3  2.3660000e+3  2.3670000e+3  2.3680000e+3  2.3690000e+3 │ 2.3700000e+3  2.3710000e+3  2.3720000e+3  2.3730000e+3  2.3740000e+3 │ 2.3750000e+3  2.3760000e+3  2.3770000e+3  2.3780000e+3  2.3790000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 2.3800000e+3  2.3810000e+3  2.3820000e+3  2.3830000e+3  2.3840000e+3 │ 2.3850000e+3  2.3860000e+3  2.3870000e+3  2.3880000e+3  2.3890000e+3 │ 2.3900000e+3  2.3910000e+3  2.3920000e+3  2.3930000e+3  2.3940000e+3 │ 2.3950000e+3  2.3960000e+3  2.3970000e+3  2.3980000e+3  2.3990000e+3 ││
    ││axis 3│ 2.4000000e+3  2.4010000e+3  2.4020000e+3  2.4030000e+3  2.4040000e+3 │ 2.4050000e+3  2.4060000e+3  2.4070000e+3  2.4080000e+3  2.4090000e+3 │ 2.4100000e+3  2.4110000e+3  2.4120000e+3  2.4130000e+3  2.4140000e+3 │ 2.4150000e+3  2.4160000e+3  2.4170000e+3  2.4180000e+3  2.4190000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 2.4800000e+3  2.4810000e+3  2.4820000e+3  2.4830000e+3  2.4840000e+3 │ 2.4850000e+3  2.4860000e+3  2.4870000e+3  2.4880000e+3  2.4890000e+3 │ 2.4900000e+3  2.4910000e+3  2.4920000e+3  2.4930000e+3  2.4940000e+3 │ 2.4950000e+3  2.4960000e+3  2.4970000e+3  2.4980000e+3  2.4990000e+3 ││
    ││      │ 2.5000000e+3  2.5010000e+3  2.5020000e+3  2.5030000e+3  2.5040000e+3 │ 2.5050000e+3  2.5060000e+3  2.5070000e+3  2.5080000e+3  2.5090000e+3 │ 2.5100000e+3  2.5110000e+3  2.5120000e+3  2.5130000e+3  2.5140000e+3 │ 2.5150000e+3  2.5160000e+3  2.5170000e+3  2.5180000e+3  2.5190000e+3 ││
    │└──────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4,1:7|4:2,5:6->2:5,3:3                                                                                          │
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                        │1 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000     1.4000000e+2  ...  5.6000000e+2  7.0000000e+2 │ 2.5200000e+3  2.6600000e+3  ...  3.0800000e+3  3.2200000e+3 ││
    ││axis 3│ 8.4000000e+2  9.8000000e+2  ...  1.4000000e+3  1.5400000e+3 │ 3.3600000e+3  3.5000000e+3  ...  3.9200000e+3  4.0600000e+3 ││
    ││      │ 1.6800000e+3  1.8200000e+3  ...  2.2400000e+3  2.3800000e+3 │ 4.2000000e+3  4.3400000e+3  ...  4.7600000e+3  4.9000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.0000000     1.4100000e+2  ...  5.6100000e+2  7.0100000e+2 │ 2.5210000e+3  2.6610000e+3  ...  3.0810000e+3  3.2210000e+3 ││
    ││axis 3│ 8.4100000e+2  9.8100000e+2  ...  1.4010000e+3  1.5410000e+3 │ 3.3610000e+3  3.5010000e+3  ...  3.9210000e+3  4.0610000e+3 ││
    ││      │ 1.6810000e+3  1.8210000e+3  ...  2.2410000e+3  2.3810000e+3 │ 4.2010000e+3  4.3410000e+3  ...  4.7610000e+3  4.9010000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.0000000     1.4200000e+2  ...  5.6200000e+2  7.0200000e+2 │ 2.5220000e+3  2.6620000e+3  ...  3.0820000e+3  3.2220000e+3 ││
    ││axis 3│ 8.4200000e+2  9.8200000e+2  ...  1.4020000e+3  1.5420000e+3 │ 3.3620000e+3  3.5020000e+3  ...  3.9220000e+3  4.0620000e+3 ││
    ││      │ 1.6820000e+3  1.8220000e+3  ...  2.2420000e+3  2.3820000e+3 │ 4.2020000e+3  4.3420000e+3  ...  4.7620000e+3  4.9020000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 3.0000000     1.4300000e+2  ...  5.6300000e+2  7.0300000e+2 │ 2.5230000e+3  2.6630000e+3  ...  3.0830000e+3  3.2230000e+3 ││
    ││axis 3│ 8.4300000e+2  9.8300000e+2  ...  1.4030000e+3  1.5430000e+3 │ 3.3630000e+3  3.5030000e+3  ...  3.9230000e+3  4.0630000e+3 ││
    ││      │ 1.6830000e+3  1.8230000e+3  ...  2.2430000e+3  2.3830000e+3 │ 4.2030000e+3  4.3430000e+3  ...  4.7630000e+3  4.9030000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 4.0000000     1.4400000e+2  ...  5.6400000e+2  7.0400000e+2 │ 2.5240000e+3  2.6640000e+3  ...  3.0840000e+3  3.2240000e+3 ││
    ││axis 3│ 8.4400000e+2  9.8400000e+2  ...  1.4040000e+3  1.5440000e+3 │ 3.3640000e+3  3.5040000e+3  ...  3.9240000e+3  4.0640000e+3 ││
    ││      │ 1.6840000e+3  1.8240000e+3  ...  2.2440000e+3  2.3840000e+3 │ 4.2040000e+3  4.3440000e+3  ...  4.7640000e+3  4.9040000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                        │1 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 2.0000000e+1  1.6000000e+2  ...  5.8000000e+2  7.2000000e+2 │ 2.5400000e+3  2.6800000e+3  ...  3.1000000e+3  3.2400000e+3 ││
    ││axis 3│ 8.6000000e+2  1.0000000e+3  ...  1.4200000e+3  1.5600000e+3 │ 3.3800000e+3  3.5200000e+3  ...  3.9400000e+3  4.0800000e+3 ││
    ││      │ 1.7000000e+3  1.8400000e+3  ...  2.2600000e+3  2.4000000e+3 │ 4.2200000e+3  4.3600000e+3  ...  4.7800000e+3  4.9200000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 2.1000000e+1  1.6100000e+2  ...  5.8100000e+2  7.2100000e+2 │ 2.5410000e+3  2.6810000e+3  ...  3.1010000e+3  3.2410000e+3 ││
    ││axis 3│ 8.6100000e+2  1.0010000e+3  ...  1.4210000e+3  1.5610000e+3 │ 3.3810000e+3  3.5210000e+3  ...  3.9410000e+3  4.0810000e+3 ││
    ││      │ 1.7010000e+3  1.8410000e+3  ...  2.2610000e+3  2.4010000e+3 │ 4.2210000e+3  4.3610000e+3  ...  4.7810000e+3  4.9210000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.2000000e+1  1.6200000e+2  ...  5.8200000e+2  7.2200000e+2 │ 2.5420000e+3  2.6820000e+3  ...  3.1020000e+3  3.2420000e+3 ││
    ││axis 3│ 8.6200000e+2  1.0020000e+3  ...  1.4220000e+3  1.5620000e+3 │ 3.3820000e+3  3.5220000e+3  ...  3.9420000e+3  4.0820000e+3 ││
    ││      │ 1.7020000e+3  1.8420000e+3  ...  2.2620000e+3  2.4020000e+3 │ 4.2220000e+3  4.3620000e+3  ...  4.7820000e+3  4.9220000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 2.3000000e+1  1.6300000e+2  ...  5.8300000e+2  7.2300000e+2 │ 2.5430000e+3  2.6830000e+3  ...  3.1030000e+3  3.2430000e+3 ││
    ││axis 3│ 8.6300000e+2  1.0030000e+3  ...  1.4230000e+3  1.5630000e+3 │ 3.3830000e+3  3.5230000e+3  ...  3.9430000e+3  4.0830000e+3 ││
    ││      │ 1.7030000e+3  1.8430000e+3  ...  2.2630000e+3  2.4030000e+3 │ 4.2230000e+3  4.3630000e+3  ...  4.7830000e+3  4.9230000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.4000000e+1  1.6400000e+2  ...  5.8400000e+2  7.2400000e+2 │ 2.5440000e+3  2.6840000e+3  ...  3.1040000e+3  3.2440000e+3 ││
    ││axis 3│ 8.6400000e+2  1.0040000e+3  ...  1.4240000e+3  1.5640000e+3 │ 3.3840000e+3  3.5240000e+3  ...  3.9440000e+3  4.0840000e+3 ││
    ││      │ 1.7040000e+3  1.8440000e+3  ...  2.2640000e+3  2.4040000e+3 │ 4.2240000e+3  4.3640000e+3  ...  4.7840000e+3  4.9240000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                                                                │
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││5 @ 1 │0 @ 4                                                        │1 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.0000000e+2  2.4000000e+2  ...  6.6000000e+2  8.0000000e+2 │ 2.6200000e+3  2.7600000e+3  ...  3.1800000e+3  3.3200000e+3 ││
    ││axis 3│ 9.4000000e+2  1.0800000e+3  ...  1.5000000e+3  1.6400000e+3 │ 3.4600000e+3  3.6000000e+3  ...  4.0200000e+3  4.1600000e+3 ││
    ││      │ 1.7800000e+3  1.9200000e+3  ...  2.3400000e+3  2.4800000e+3 │ 4.3000000e+3  4.4400000e+3  ...  4.8600000e+3  5.0000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.0100000e+2  2.4100000e+2  ...  6.6100000e+2  8.0100000e+2 │ 2.6210000e+3  2.7610000e+3  ...  3.1810000e+3  3.3210000e+3 ││
    ││axis 3│ 9.4100000e+2  1.0810000e+3  ...  1.5010000e+3  1.6410000e+3 │ 3.4610000e+3  3.6010000e+3  ...  4.0210000e+3  4.1610000e+3 ││
    ││      │ 1.7810000e+3  1.9210000e+3  ...  2.3410000e+3  2.4810000e+3 │ 4.3010000e+3  4.4410000e+3  ...  4.8610000e+3  5.0010000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.0200000e+2  2.4200000e+2  ...  6.6200000e+2  8.0200000e+2 │ 2.6220000e+3  2.7620000e+3  ...  3.1820000e+3  3.3220000e+3 ││
    ││axis 3│ 9.4200000e+2  1.0820000e+3  ...  1.5020000e+3  1.6420000e+3 │ 3.4620000e+3  3.6020000e+3  ...  4.0220000e+3  4.1620000e+3 ││
    ││      │ 1.7820000e+3  1.9220000e+3  ...  2.3420000e+3  2.4820000e+3 │ 4.3020000e+3  4.4420000e+3  ...  4.8620000e+3  5.0020000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.0300000e+2  2.4300000e+2  ...  6.6300000e+2  8.0300000e+2 │ 2.6230000e+3  2.7630000e+3  ...  3.1830000e+3  3.3230000e+3 ││
    ││axis 3│ 9.4300000e+2  1.0830000e+3  ...  1.5030000e+3  1.6430000e+3 │ 3.4630000e+3  3.6030000e+3  ...  4.0230000e+3  4.1630000e+3 ││
    ││      │ 1.7830000e+3  1.9230000e+3  ...  2.3430000e+3  2.4830000e+3 │ 4.3030000e+3  4.4430000e+3  ...  4.8630000e+3  5.0030000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.0400000e+2  2.4400000e+2  ...  6.6400000e+2  8.0400000e+2 │ 2.6240000e+3  2.7640000e+3  ...  3.1840000e+3  3.3240000e+3 ││
    ││axis 3│ 9.4400000e+2  1.0840000e+3  ...  1.5040000e+3  1.6440000e+3 │ 3.4640000e+3  3.6040000e+3  ...  4.0240000e+3  4.1640000e+3 ││
    ││      │ 1.7840000e+3  1.9240000e+3  ...  2.3440000e+3  2.4840000e+3 │ 4.3040000e+3  4.4440000e+3  ...  4.8640000e+3  5.0040000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││6 @ 1 │0 @ 4                                                        │1 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.2000000e+2  2.6000000e+2  ...  6.8000000e+2  8.2000000e+2 │ 2.6400000e+3  2.7800000e+3  ...  3.2000000e+3  3.3400000e+3 ││
    ││axis 3│ 9.6000000e+2  1.1000000e+3  ...  1.5200000e+3  1.6600000e+3 │ 3.4800000e+3  3.6200000e+3  ...  4.0400000e+3  4.1800000e+3 ││
    ││      │ 1.8000000e+3  1.9400000e+3  ...  2.3600000e+3  2.5000000e+3 │ 4.3200000e+3  4.4600000e+3  ...  4.8800000e+3  5.0200000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.2100000e+2  2.6100000e+2  ...  6.8100000e+2  8.2100000e+2 │ 2.6410000e+3  2.7810000e+3  ...  3.2010000e+3  3.3410000e+3 ││
    ││axis 3│ 9.6100000e+2  1.1010000e+3  ...  1.5210000e+3  1.6610000e+3 │ 3.4810000e+3  3.6210000e+3  ...  4.0410000e+3  4.1810000e+3 ││
    ││      │ 1.8010000e+3  1.9410000e+3  ...  2.3610000e+3  2.5010000e+3 │ 4.3210000e+3  4.4610000e+3  ...  4.8810000e+3  5.0210000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.2200000e+2  2.6200000e+2  ...  6.8200000e+2  8.2200000e+2 │ 2.6420000e+3  2.7820000e+3  ...  3.2020000e+3  3.3420000e+3 ││
    ││axis 3│ 9.6200000e+2  1.1020000e+3  ...  1.5220000e+3  1.6620000e+3 │ 3.4820000e+3  3.6220000e+3  ...  4.0420000e+3  4.1820000e+3 ││
    ││      │ 1.8020000e+3  1.9420000e+3  ...  2.3620000e+3  2.5020000e+3 │ 4.3220000e+3  4.4620000e+3  ...  4.8820000e+3  5.0220000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.2300000e+2  2.6300000e+2  ...  6.8300000e+2  8.2300000e+2 │ 2.6430000e+3  2.7830000e+3  ...  3.2030000e+3  3.3430000e+3 ││
    ││axis 3│ 9.6300000e+2  1.1030000e+3  ...  1.5230000e+3  1.6630000e+3 │ 3.4830000e+3  3.6230000e+3  ...  4.0430000e+3  4.1830000e+3 ││
    ││      │ 1.8030000e+3  1.9430000e+3  ...  2.3630000e+3  2.5030000e+3 │ 4.3230000e+3  4.4630000e+3  ...  4.8830000e+3  5.0230000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.2400000e+2  2.6400000e+2  ...  6.8400000e+2  8.2400000e+2 │ 2.6440000e+3  2.7840000e+3  ...  3.2040000e+3  3.3440000e+3 ││
    ││axis 3│ 9.6400000e+2  1.1040000e+3  ...  1.5240000e+3  1.6640000e+3 │ 3.4840000e+3  3.6240000e+3  ...  4.0440000e+3  4.1840000e+3 ││
    ││      │ 1.8040000e+3  1.9440000e+3  ...  2.3640000e+3  2.5040000e+3 │ 4.3240000e+3  4.4640000e+3  ...  4.8840000e+3  5.0240000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 sum out axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => b|i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:3                           │
    │┌──────┬──────────────────────────────────────────┐│
    ││      │axis 1                                    ││
    │├──────┼──────────────────────────────────────────┤│
    ││axis 0│ 1.8000000e+1  2.2000000e+1  2.6000000e+1 ││
    ││      │ 6.6000000e+1  7.0000000e+1  7.4000000e+1 ││
    │└──────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => c|a->d" in
  Train.forward_and_forget backend ctx ho2;
  (* Axis 5 of hey2, i.e. d in the einsum spec, has the lowest variation (progresses by 1), that's
     why axis 1 of ho2 appears nearly constant. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4|2:2->1:5                                                                                              │
    │┌──────┬────────────────────────────┬────────────────────────────┬────────────────────────────┬────────────────────────────┐│
    ││      │0 @ 0                       │1 @ 0                       │2 @ 0                       │3 @ 0                       ││
    ││      │axis 2                      │axis 2                      │axis 2                      │axis 2                      ││
    │├──────┼────────────────────────────┼────────────────────────────┼────────────────────────────┼────────────────────────────┤│
    ││axis 1│ 1.5750000e+5  4.7502000e+5 │ 1.5813000e+5  4.7565000e+5 │ 1.5876000e+5  4.7628000e+5 │ 1.5939000e+5  4.7691000e+5 ││
    ││      │ 1.5762600e+5  4.7514600e+5 │ 1.5825600e+5  4.7577600e+5 │ 1.5888600e+5  4.7640600e+5 │ 1.5951600e+5  4.7703600e+5 ││
    ││      │ 1.5775200e+5  4.7527200e+5 │ 1.5838200e+5  4.7590200e+5 │ 1.5901200e+5  4.7653200e+5 │ 1.5964200e+5  4.7716200e+5 ││
    ││      │ 1.5787800e+5  4.7539800e+5 │ 1.5850800e+5  4.7602800e+5 │ 1.5913800e+5  4.7665800e+5 │ 1.5976800e+5  4.7728800e+5 ││
    ││      │ 1.5800400e+5  4.7552400e+5 │ 1.5863400e+5  4.7615400e+5 │ 1.5926400e+5  4.7678400e+5 │ 1.5989400e+5  4.7741400e+5 ││
    │└──────┴────────────────────────────┴────────────────────────────┴────────────────────────────┴────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum outer product" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 3 ] () in
  let%op c = (a + 1) *+ "i; j => i->j" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌─────────────────────────┐
    │[0]: r2 shape 0:2        │
    │┌┬──────────────────────┐│
    │││axis 0                ││
    │├┼──────────────────────┤│
    │││ 0.0000000  1.0000000 ││
    │└┴──────────────────────┘│
    └─────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[1]: r3 shape 0:3                   │
    │┌┬─────────────────────────────────┐│
    │││axis 0                           ││
    │├┼─────────────────────────────────┤│
    │││ 0.0000000  1.0000000  2.0000000 ││
    │└┴─────────────────────────────────┘│
    └────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────┐
    │[4]: ;=>_c shape 1:2->0:3      │
    │┌──────┬──────────────────────┐│
    ││      │axis 1                ││
    │├──────┼──────────────────────┤│
    ││axis 0│ 0.0000000  0.0000000 ││
    ││      │ 1.0000000  2.0000000 ││
    ││      │ 2.0000000  4.0000000 ││
    │└──────┴──────────────────────┘│
    └───────────────────────────────┘
    |}];
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 5 ] ~input_dims:[ 6 ] ~output_dims:[ 7 ] () in
  let%op c = a *+ "i|j->k; l|m->n => il|jm->kn" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: r5x7x6 shape 0:5|2:6->1:7                                                                                                                                                                                                                                                                                                │
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                        │1 @ 0                                                        │2 @ 0                                                        │3 @ 0                                                        │4 @ 0                                                        ││
    ││      │axis 2                                                       │axis 2                                                       │axis 2                                                       │axis 2                                                       │axis 2                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.0000000     1.0000000     ...  4.0000000     5.0000000    │ 4.2000000e+1  4.3000000e+1  ...  4.6000000e+1  4.7000000e+1 │ 8.4000000e+1  8.5000000e+1  ...  8.8000000e+1  8.9000000e+1 │ 1.2600000e+2  1.2700000e+2  ...  1.3000000e+2  1.3100000e+2 │ 1.6800000e+2  1.6900000e+2  ...  1.7200000e+2  1.7300000e+2 ││
    ││      │ 6.0000000     7.0000000     ...  1.0000000e+1  1.1000000e+1 │ 4.8000000e+1  4.9000000e+1  ...  5.2000000e+1  5.3000000e+1 │ 9.0000000e+1  9.1000000e+1  ...  9.4000000e+1  9.5000000e+1 │ 1.3200000e+2  1.3300000e+2  ...  1.3600000e+2  1.3700000e+2 │ 1.7400000e+2  1.7500000e+2  ...  1.7800000e+2  1.7900000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 3.0000000e+1  3.1000000e+1  ...  3.4000000e+1  3.5000000e+1 │ 7.2000000e+1  7.3000000e+1  ...  7.6000000e+1  7.7000000e+1 │ 1.1400000e+2  1.1500000e+2  ...  1.1800000e+2  1.1900000e+2 │ 1.5600000e+2  1.5700000e+2  ...  1.6000000e+2  1.6100000e+2 │ 1.9800000e+2  1.9900000e+2  ...  2.0200000e+2  2.0300000e+2 ││
    ││      │ 3.6000000e+1  3.7000000e+1  ...  4.0000000e+1  4.1000000e+1 │ 7.8000000e+1  7.9000000e+1  ...  8.2000000e+1  8.3000000e+1 │ 1.2000000e+2  1.2100000e+2  ...  1.2400000e+2  1.2500000e+2 │ 1.6200000e+2  1.6300000e+2  ...  1.6600000e+2  1.6700000e+2 │ 2.0400000e+2  2.0500000e+2  ...  2.0800000e+2  2.0900000e+2 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[7]: ;=>_c shape 0:2,1:5|4:3,5:6->2:4,3:7                                                                                                                                                         │
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 0.0000000     1.0000000     ...  4.0000000     5.0000000    │ 0.0000000     2.0000000     ...  8.0000000     1.0000000e+1 ││
    ││axis 3│ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 6.0000000     7.0000000     ...  1.0000000e+1  1.1000000e+1 │ 1.2000000e+1  1.4000000e+1  ...  2.0000000e+1  2.2000000e+1 ││
    ││      │ ...        ...        ...  ...        ...                   │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 3.0000000e+1  3.1000000e+1  ...  3.4000000e+1  3.5000000e+1 │ 6.0000000e+1  6.2000000e+1  ...  6.8000000e+1  7.0000000e+1 ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 3.6000000e+1  3.7000000e+1  ...  4.0000000e+1  4.1000000e+1 │ 7.2000000e+1  7.4000000e+1  ...  8.0000000e+1  8.2000000e+1 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 0.0000000     3.0000000     ...  1.2000000e+1  1.5000000e+1 │ 0.0000000     4.0000000     ...  1.6000000e+1  2.0000000e+1 │ 0.0000000     5.0000000     ...  2.0000000e+1  2.5000000e+1 ││
    ││axis 3│ 1.8000000e+1  2.1000000e+1  ...  3.0000000e+1  3.3000000e+1 │ 2.4000000e+1  2.8000000e+1  ...  4.0000000e+1  4.4000000e+1 │ 3.0000000e+1  3.5000000e+1  ...  5.0000000e+1  5.5000000e+1 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 9.0000000e+1  9.3000000e+1  ...  1.0200000e+2  1.0500000e+2 │ 1.2000000e+2  1.2400000e+2  ...  1.3600000e+2  1.4000000e+2 │ 1.5000000e+2  1.5500000e+2  ...  1.7000000e+2  1.7500000e+2 ││
    ││      │ 1.0800000e+2  1.1100000e+2  ...  1.2000000e+2  1.2300000e+2 │ 1.4400000e+2  1.4800000e+2  ...  1.6000000e+2  1.6400000e+2 │ 1.8000000e+2  1.8500000e+2  ...  2.0000000e+2  2.0500000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 0.0000000     6.0000000     ...  2.4000000e+1  3.0000000e+1 │ 0.0000000     7.0000000     ...  2.8000000e+1  3.5000000e+1 │ 0.0000000     8.0000000     ...  3.2000000e+1  4.0000000e+1 ││
    ││axis 3│ 3.6000000e+1  4.2000000e+1  ...  6.0000000e+1  6.6000000e+1 │ 4.2000000e+1  4.9000000e+1  ...  7.0000000e+1  7.7000000e+1 │ 4.8000000e+1  5.6000000e+1  ...  8.0000000e+1  8.8000000e+1 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 1.8000000e+2  1.8600000e+2  ...  2.0400000e+2  2.1000000e+2 │ 2.1000000e+2  2.1700000e+2  ...  2.3800000e+2  2.4500000e+2 │ 2.4000000e+2  2.4800000e+2  ...  2.7200000e+2  2.8000000e+2 ││
    ││      │ 2.1600000e+2  2.2200000e+2  ...  2.4000000e+2  2.4600000e+2 │ 2.5200000e+2  2.5900000e+2  ...  2.8000000e+2  2.8700000e+2 │ 2.8800000e+2  2.9600000e+2  ...  3.2000000e+2  3.2800000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 0.0000000     9.0000000     ...  3.6000000e+1  4.5000000e+1 │ 0.0000000     1.0000000e+1  ...  4.0000000e+1  5.0000000e+1 │ 0.0000000     1.1000000e+1  ...  4.4000000e+1  5.5000000e+1 ││
    ││axis 3│ 5.4000000e+1  6.3000000e+1  ...  9.0000000e+1  9.9000000e+1 │ 6.0000000e+1  7.0000000e+1  ...  1.0000000e+2  1.1000000e+2 │ 6.6000000e+1  7.7000000e+1  ...  1.1000000e+2  1.2100000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 2.7000000e+2  2.7900000e+2  ...  3.0600000e+2  3.1500000e+2 │ 3.0000000e+2  3.1000000e+2  ...  3.4000000e+2  3.5000000e+2 │ 3.3000000e+2  3.4100000e+2  ...  3.7400000e+2  3.8500000e+2 ││
    ││      │ 3.2400000e+2  3.3300000e+2  ...  3.6000000e+2  3.6900000e+2 │ 3.6000000e+2  3.7000000e+2  ...  4.0000000e+2  4.1000000e+2 │ 3.9600000e+2  4.0700000e+2  ...  4.4000000e+2  4.5100000e+2 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 4.2000000e+1  4.3000000e+1  ...  4.6000000e+1  4.7000000e+1 │ 8.4000000e+1  8.6000000e+1  ...  9.2000000e+1  9.4000000e+1 ││
    ││axis 3│ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 4.8000000e+1  4.9000000e+1  ...  5.2000000e+1  5.3000000e+1 │ 9.6000000e+1  9.8000000e+1  ...  1.0400000e+2  1.0600000e+2 ││
    ││      │ ...        ...        ...  ...        ...                   │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 7.2000000e+1  7.3000000e+1  ...  7.6000000e+1  7.7000000e+1 │ 1.4400000e+2  1.4600000e+2  ...  1.5200000e+2  1.5400000e+2 ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 7.8000000e+1  7.9000000e+1  ...  8.2000000e+1  8.3000000e+1 │ 1.5600000e+2  1.5800000e+2  ...  1.6400000e+2  1.6600000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.2600000e+2  1.2900000e+2  ...  1.3800000e+2  1.4100000e+2 │ 1.6800000e+2  1.7200000e+2  ...  1.8400000e+2  1.8800000e+2 │ 2.1000000e+2  2.1500000e+2  ...  2.3000000e+2  2.3500000e+2 ││
    ││axis 3│ 1.4400000e+2  1.4700000e+2  ...  1.5600000e+2  1.5900000e+2 │ 1.9200000e+2  1.9600000e+2  ...  2.0800000e+2  2.1200000e+2 │ 2.4000000e+2  2.4500000e+2  ...  2.6000000e+2  2.6500000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 2.1600000e+2  2.1900000e+2  ...  2.2800000e+2  2.3100000e+2 │ 2.8800000e+2  2.9200000e+2  ...  3.0400000e+2  3.0800000e+2 │ 3.6000000e+2  3.6500000e+2  ...  3.8000000e+2  3.8500000e+2 ││
    ││      │ 2.3400000e+2  2.3700000e+2  ...  2.4600000e+2  2.4900000e+2 │ 3.1200000e+2  3.1600000e+2  ...  3.2800000e+2  3.3200000e+2 │ 3.9000000e+2  3.9500000e+2  ...  4.1000000e+2  4.1500000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.5200000e+2  2.5800000e+2  ...  2.7600000e+2  2.8200000e+2 │ 2.9400000e+2  3.0100000e+2  ...  3.2200000e+2  3.2900000e+2 │ 3.3600000e+2  3.4400000e+2  ...  3.6800000e+2  3.7600000e+2 ││
    ││axis 3│ 2.8800000e+2  2.9400000e+2  ...  3.1200000e+2  3.1800000e+2 │ 3.3600000e+2  3.4300000e+2  ...  3.6400000e+2  3.7100000e+2 │ 3.8400000e+2  3.9200000e+2  ...  4.1600000e+2  4.2400000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 4.3200000e+2  4.3800000e+2  ...  4.5600000e+2  4.6200000e+2 │ 5.0400000e+2  5.1100000e+2  ...  5.3200000e+2  5.3900000e+2 │ 5.7600000e+2  5.8400000e+2  ...  6.0800000e+2  6.1600000e+2 ││
    ││      │ 4.6800000e+2  4.7400000e+2  ...  4.9200000e+2  4.9800000e+2 │ 5.4600000e+2  5.5300000e+2  ...  5.7400000e+2  5.8100000e+2 │ 6.2400000e+2  6.3200000e+2  ...  6.5600000e+2  6.6400000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 3.7800000e+2  3.8700000e+2  ...  4.1400000e+2  4.2300000e+2 │ 4.2000000e+2  4.3000000e+2  ...  4.6000000e+2  4.7000000e+2 │ 4.6200000e+2  4.7300000e+2  ...  5.0600000e+2  5.1700000e+2 ││
    ││axis 3│ 4.3200000e+2  4.4100000e+2  ...  4.6800000e+2  4.7700000e+2 │ 4.8000000e+2  4.9000000e+2  ...  5.2000000e+2  5.3000000e+2 │ 5.2800000e+2  5.3900000e+2  ...  5.7200000e+2  5.8300000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 6.4800000e+2  6.5700000e+2  ...  6.8400000e+2  6.9300000e+2 │ 7.2000000e+2  7.3000000e+2  ...  7.6000000e+2  7.7000000e+2 │ 7.9200000e+2  8.0300000e+2  ...  8.3600000e+2  8.4700000e+2 ││
    ││      │ 7.0200000e+2  7.1100000e+2  ...  7.3800000e+2  7.4700000e+2 │ 7.8000000e+2  7.9000000e+2  ...  8.2000000e+2  8.3000000e+2 │ 8.5800000e+2  8.6900000e+2  ...  9.0200000e+2  9.1300000e+2 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 8.4000000e+1  8.5000000e+1  ...  8.8000000e+1  8.9000000e+1 │ 1.6800000e+2  1.7000000e+2  ...  1.7600000e+2  1.7800000e+2 ││
    ││axis 3│ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 9.0000000e+1  9.1000000e+1  ...  9.4000000e+1  9.5000000e+1 │ 1.8000000e+2  1.8200000e+2  ...  1.8800000e+2  1.9000000e+2 ││
    ││      │ ...        ...        ...  ...        ...                   │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.1400000e+2  1.1500000e+2  ...  1.1800000e+2  1.1900000e+2 │ 2.2800000e+2  2.3000000e+2  ...  2.3600000e+2  2.3800000e+2 ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.2000000e+2  1.2100000e+2  ...  1.2400000e+2  1.2500000e+2 │ 2.4000000e+2  2.4200000e+2  ...  2.4800000e+2  2.5000000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 2.5200000e+2  2.5500000e+2  ...  2.6400000e+2  2.6700000e+2 │ 3.3600000e+2  3.4000000e+2  ...  3.5200000e+2  3.5600000e+2 │ 4.2000000e+2  4.2500000e+2  ...  4.4000000e+2  4.4500000e+2 ││
    ││axis 3│ 2.7000000e+2  2.7300000e+2  ...  2.8200000e+2  2.8500000e+2 │ 3.6000000e+2  3.6400000e+2  ...  3.7600000e+2  3.8000000e+2 │ 4.5000000e+2  4.5500000e+2  ...  4.7000000e+2  4.7500000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 3.4200000e+2  3.4500000e+2  ...  3.5400000e+2  3.5700000e+2 │ 4.5600000e+2  4.6000000e+2  ...  4.7200000e+2  4.7600000e+2 │ 5.7000000e+2  5.7500000e+2  ...  5.9000000e+2  5.9500000e+2 ││
    ││      │ 3.6000000e+2  3.6300000e+2  ...  3.7200000e+2  3.7500000e+2 │ 4.8000000e+2  4.8400000e+2  ...  4.9600000e+2  5.0000000e+2 │ 6.0000000e+2  6.0500000e+2  ...  6.2000000e+2  6.2500000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 5.0400000e+2  5.1000000e+2  ...  5.2800000e+2  5.3400000e+2 │ 5.8800000e+2  5.9500000e+2  ...  6.1600000e+2  6.2300000e+2 │ 6.7200000e+2  6.8000000e+2  ...  7.0400000e+2  7.1200000e+2 ││
    ││axis 3│ 5.4000000e+2  5.4600000e+2  ...  5.6400000e+2  5.7000000e+2 │ 6.3000000e+2  6.3700000e+2  ...  6.5800000e+2  6.6500000e+2 │ 7.2000000e+2  7.2800000e+2  ...  7.5200000e+2  7.6000000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 6.8400000e+2  6.9000000e+2  ...  7.0800000e+2  7.1400000e+2 │ 7.9800000e+2  8.0500000e+2  ...  8.2600000e+2  8.3300000e+2 │ 9.1200000e+2  9.2000000e+2  ...  9.4400000e+2  9.5200000e+2 ││
    ││      │ 7.2000000e+2  7.2600000e+2  ...  7.4400000e+2  7.5000000e+2 │ 8.4000000e+2  8.4700000e+2  ...  8.6800000e+2  8.7500000e+2 │ 9.6000000e+2  9.6800000e+2  ...  9.9200000e+2  1.0000000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 7.5600000e+2  7.6500000e+2  ...  7.9200000e+2  8.0100000e+2 │ 8.4000000e+2  8.5000000e+2  ...  8.8000000e+2  8.9000000e+2 │ 9.2400000e+2  9.3500000e+2  ...  9.6800000e+2  9.7900000e+2 ││
    ││axis 3│ 8.1000000e+2  8.1900000e+2  ...  8.4600000e+2  8.5500000e+2 │ 9.0000000e+2  9.1000000e+2  ...  9.4000000e+2  9.5000000e+2 │ 9.9000000e+2  1.0010000e+3  ...  1.0340000e+3  1.0450000e+3 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 1.0260000e+3  1.0350000e+3  ...  1.0620000e+3  1.0710000e+3 │ 1.1400000e+3  1.1500000e+3  ...  1.1800000e+3  1.1900000e+3 │ 1.2540000e+3  1.2650000e+3  ...  1.2980000e+3  1.3090000e+3 ││
    ││      │ 1.0800000e+3  1.0890000e+3  ...  1.1160000e+3  1.1250000e+3 │ 1.2000000e+3  1.2100000e+3  ...  1.2400000e+3  1.2500000e+3 │ 1.3200000e+3  1.3310000e+3  ...  1.3640000e+3  1.3750000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.2600000e+2  1.2700000e+2  ...  1.3000000e+2  1.3100000e+2 │ 2.5200000e+2  2.5400000e+2  ...  2.6000000e+2  2.6200000e+2 ││
    ││axis 3│ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.3200000e+2  1.3300000e+2  ...  1.3600000e+2  1.3700000e+2 │ 2.6400000e+2  2.6600000e+2  ...  2.7200000e+2  2.7400000e+2 ││
    ││      │ ...        ...        ...  ...        ...                   │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.5600000e+2  1.5700000e+2  ...  1.6000000e+2  1.6100000e+2 │ 3.1200000e+2  3.1400000e+2  ...  3.2000000e+2  3.2200000e+2 ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.6200000e+2  1.6300000e+2  ...  1.6600000e+2  1.6700000e+2 │ 3.2400000e+2  3.2600000e+2  ...  3.3200000e+2  3.3400000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 3.7800000e+2  3.8100000e+2  ...  3.9000000e+2  3.9300000e+2 │ 5.0400000e+2  5.0800000e+2  ...  5.2000000e+2  5.2400000e+2 │ 6.3000000e+2  6.3500000e+2  ...  6.5000000e+2  6.5500000e+2 ││
    ││axis 3│ 3.9600000e+2  3.9900000e+2  ...  4.0800000e+2  4.1100000e+2 │ 5.2800000e+2  5.3200000e+2  ...  5.4400000e+2  5.4800000e+2 │ 6.6000000e+2  6.6500000e+2  ...  6.8000000e+2  6.8500000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 4.6800000e+2  4.7100000e+2  ...  4.8000000e+2  4.8300000e+2 │ 6.2400000e+2  6.2800000e+2  ...  6.4000000e+2  6.4400000e+2 │ 7.8000000e+2  7.8500000e+2  ...  8.0000000e+2  8.0500000e+2 ││
    ││      │ 4.8600000e+2  4.8900000e+2  ...  4.9800000e+2  5.0100000e+2 │ 6.4800000e+2  6.5200000e+2  ...  6.6400000e+2  6.6800000e+2 │ 8.1000000e+2  8.1500000e+2  ...  8.3000000e+2  8.3500000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 7.5600000e+2  7.6200000e+2  ...  7.8000000e+2  7.8600000e+2 │ 8.8200000e+2  8.8900000e+2  ...  9.1000000e+2  9.1700000e+2 │ 1.0080000e+3  1.0160000e+3  ...  1.0400000e+3  1.0480000e+3 ││
    ││axis 3│ 7.9200000e+2  7.9800000e+2  ...  8.1600000e+2  8.2200000e+2 │ 9.2400000e+2  9.3100000e+2  ...  9.5200000e+2  9.5900000e+2 │ 1.0560000e+3  1.0640000e+3  ...  1.0880000e+3  1.0960000e+3 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 9.3600000e+2  9.4200000e+2  ...  9.6000000e+2  9.6600000e+2 │ 1.0920000e+3  1.0990000e+3  ...  1.1200000e+3  1.1270000e+3 │ 1.2480000e+3  1.2560000e+3  ...  1.2800000e+3  1.2880000e+3 ││
    ││      │ 9.7200000e+2  9.7800000e+2  ...  9.9600000e+2  1.0020000e+3 │ 1.1340000e+3  1.1410000e+3  ...  1.1620000e+3  1.1690000e+3 │ 1.2960000e+3  1.3040000e+3  ...  1.3280000e+3  1.3360000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.1340000e+3  1.1430000e+3  ...  1.1700000e+3  1.1790000e+3 │ 1.2600000e+3  1.2700000e+3  ...  1.3000000e+3  1.3100000e+3 │ 1.3860000e+3  1.3970000e+3  ...  1.4300000e+3  1.4410000e+3 ││
    ││axis 3│ 1.1880000e+3  1.1970000e+3  ...  1.2240000e+3  1.2330000e+3 │ 1.3200000e+3  1.3300000e+3  ...  1.3600000e+3  1.3700000e+3 │ 1.4520000e+3  1.4630000e+3  ...  1.4960000e+3  1.5070000e+3 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 1.4040000e+3  1.4130000e+3  ...  1.4400000e+3  1.4490000e+3 │ 1.5600000e+3  1.5700000e+3  ...  1.6000000e+3  1.6100000e+3 │ 1.7160000e+3  1.7270000e+3  ...  1.7600000e+3  1.7710000e+3 ││
    ││      │ 1.4580000e+3  1.4670000e+3  ...  1.4940000e+3  1.5030000e+3 │ 1.6200000e+3  1.6300000e+3  ...  1.6600000e+3  1.6700000e+3 │ 1.7820000e+3  1.7930000e+3  ...  1.8260000e+3  1.8370000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.6800000e+2  1.6900000e+2  ...  1.7200000e+2  1.7300000e+2 │ 3.3600000e+2  3.3800000e+2  ...  3.4400000e+2  3.4600000e+2 ││
    ││axis 3│ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.7400000e+2  1.7500000e+2  ...  1.7800000e+2  1.7900000e+2 │ 3.4800000e+2  3.5000000e+2  ...  3.5600000e+2  3.5800000e+2 ││
    ││      │ ...        ...        ...  ...        ...                   │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 1.9800000e+2  1.9900000e+2  ...  2.0200000e+2  2.0300000e+2 │ 3.9600000e+2  3.9800000e+2  ...  4.0400000e+2  4.0600000e+2 ││
    ││      │ 0.0000000  0.0000000  ...  0.0000000  0.0000000             │ 2.0400000e+2  2.0500000e+2  ...  2.0800000e+2  2.0900000e+2 │ 4.0800000e+2  4.1000000e+2  ...  4.1600000e+2  4.1800000e+2 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 5.0400000e+2  5.0700000e+2  ...  5.1600000e+2  5.1900000e+2 │ 6.7200000e+2  6.7600000e+2  ...  6.8800000e+2  6.9200000e+2 │ 8.4000000e+2  8.4500000e+2  ...  8.6000000e+2  8.6500000e+2 ││
    ││axis 3│ 5.2200000e+2  5.2500000e+2  ...  5.3400000e+2  5.3700000e+2 │ 6.9600000e+2  7.0000000e+2  ...  7.1200000e+2  7.1600000e+2 │ 8.7000000e+2  8.7500000e+2  ...  8.9000000e+2  8.9500000e+2 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 5.9400000e+2  5.9700000e+2  ...  6.0600000e+2  6.0900000e+2 │ 7.9200000e+2  7.9600000e+2  ...  8.0800000e+2  8.1200000e+2 │ 9.9000000e+2  9.9500000e+2  ...  1.0100000e+3  1.0150000e+3 ││
    ││      │ 6.1200000e+2  6.1500000e+2  ...  6.2400000e+2  6.2700000e+2 │ 8.1600000e+2  8.2000000e+2  ...  8.3200000e+2  8.3600000e+2 │ 1.0200000e+3  1.0250000e+3  ...  1.0400000e+3  1.0450000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.0080000e+3  1.0140000e+3  ...  1.0320000e+3  1.0380000e+3 │ 1.1760000e+3  1.1830000e+3  ...  1.2040000e+3  1.2110000e+3 │ 1.3440000e+3  1.3520000e+3  ...  1.3760000e+3  1.3840000e+3 ││
    ││axis 3│ 1.0440000e+3  1.0500000e+3  ...  1.0680000e+3  1.0740000e+3 │ 1.2180000e+3  1.2250000e+3  ...  1.2460000e+3  1.2530000e+3 │ 1.3920000e+3  1.4000000e+3  ...  1.4240000e+3  1.4320000e+3 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 1.1880000e+3  1.1940000e+3  ...  1.2120000e+3  1.2180000e+3 │ 1.3860000e+3  1.3930000e+3  ...  1.4140000e+3  1.4210000e+3 │ 1.5840000e+3  1.5920000e+3  ...  1.6160000e+3  1.6240000e+3 ││
    ││      │ 1.2240000e+3  1.2300000e+3  ...  1.2480000e+3  1.2540000e+3 │ 1.4280000e+3  1.4350000e+3  ...  1.4560000e+3  1.4630000e+3 │ 1.6320000e+3  1.6400000e+3  ...  1.6640000e+3  1.6720000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.5120000e+3  1.5210000e+3  ...  1.5480000e+3  1.5570000e+3 │ 1.6800000e+3  1.6900000e+3  ...  1.7200000e+3  1.7300000e+3 │ 1.8480000e+3  1.8590000e+3  ...  1.8920000e+3  1.9030000e+3 ││
    ││axis 3│ 1.5660000e+3  1.5750000e+3  ...  1.6020000e+3  1.6110000e+3 │ 1.7400000e+3  1.7500000e+3  ...  1.7800000e+3  1.7900000e+3 │ 1.9140000e+3  1.9250000e+3  ...  1.9580000e+3  1.9690000e+3 ││
    ││      │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          │ ...           ...           ...  ...           ...          ││
    ││      │ 1.7820000e+3  1.7910000e+3  ...  1.8180000e+3  1.8270000e+3 │ 1.9800000e+3  1.9900000e+3  ...  2.0200000e+3  2.0300000e+3 │ 2.1780000e+3  2.1890000e+3  ...  2.2220000e+3  2.2330000e+3 ││
    ││      │ 1.8360000e+3  1.8450000e+3  ...  1.8720000e+3  1.8810000e+3 │ 2.0400000e+3  2.0500000e+3  ...  2.0800000e+3  2.0900000e+3 │ 2.2440000e+3  2.2550000e+3  ...  2.2880000e+3  2.2990000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum matrix/inner+outer products" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 4 ] ~output_dims:[ 5 ] () in
  let%op a2 = a *+ "b|i->o; b|i->o => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx a2 in
  let%op c = b *+ "b|h->o; b|i->h => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx c in
  let%op d = a *+ "a|i->h; b|h->o => ab|i->o" b in
  Train.forward_and_forget backend ctx d;
  let%op e = a *+ "b|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx e;
  let%op f = a *+ "a|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_a2 shape 0:2|2:3->1:4                                                                │
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                     │1 @ 0                                     ││
    ││      │axis 2                                    │axis 2                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000     1.0000000     4.0000000    │ 1.4400000e+2  1.6900000e+2  1.9600000e+2 ││
    ││      │ 9.0000000     1.6000000e+1  2.5000000e+1 │ 2.2500000e+2  2.5600000e+2  2.8900000e+2 ││
    ││      │ 3.6000000e+1  4.9000000e+1  6.4000000e+1 │ 3.2400000e+2  3.6100000e+2  4.0000000e+2 ││
    ││      │ 8.1000000e+1  1.0000000e+2  1.2100000e+2 │ 4.4100000e+2  4.8400000e+2  5.2900000e+2 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: ;=>_c shape 0:2|2:3->1:5                                                                 │
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                     │1 @ 0                                     ││
    ││      │axis 2                                    │axis 2                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 4.2000000e+1  4.8000000e+1  5.4000000e+1 │ 1.4340000e+3  1.5200000e+3  1.6060000e+3 ││
    ││      │ 1.1400000e+2  1.3600000e+2  1.5800000e+2 │ 1.6980000e+3  1.8000000e+3  1.9020000e+3 ││
    ││      │ 1.8600000e+2  2.2400000e+2  2.6200000e+2 │ 1.9620000e+3  2.0800000e+3  2.1980000e+3 ││
    ││      │ 2.5800000e+2  3.1200000e+2  3.6600000e+2 │ 2.2260000e+3  2.3600000e+3  2.4940000e+3 ││
    ││      │ 3.3000000e+2  4.0000000e+2  4.7000000e+2 │ 2.4900000e+3  2.6400000e+3  2.7900000e+3 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: ;=>_d shape 0:2,1:2|3:3->2:5                                                             │
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 1                                     │1 @ 1                                     ││
    ││      │axis 3                                    │axis 3                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││0 @ 0 │ 4.2000000e+1  4.8000000e+1  5.4000000e+1 │ 4.0200000e+2  4.8800000e+2  5.7400000e+2 ││
    ││axis 2│ 1.1400000e+2  1.3600000e+2  1.5800000e+2 │ 4.7400000e+2  5.7600000e+2  6.7800000e+2 ││
    ││      │ 1.8600000e+2  2.2400000e+2  2.6200000e+2 │ 5.4600000e+2  6.6400000e+2  7.8200000e+2 ││
    ││      │ 2.5800000e+2  3.1200000e+2  3.6600000e+2 │ 6.1800000e+2  7.5200000e+2  8.8600000e+2 ││
    ││      │ 3.3000000e+2  4.0000000e+2  4.7000000e+2 │ 6.9000000e+2  8.4000000e+2  9.9000000e+2 ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││1 @ 0 │ 1.1400000e+2  1.2000000e+2  1.2600000e+2 │ 1.4340000e+3  1.5200000e+3  1.6060000e+3 ││
    ││axis 2│ 3.7800000e+2  4.0000000e+2  4.2200000e+2 │ 1.6980000e+3  1.8000000e+3  1.9020000e+3 ││
    ││      │ 6.4200000e+2  6.8000000e+2  7.1800000e+2 │ 1.9620000e+3  2.0800000e+3  2.1980000e+3 ││
    ││      │ 9.0600000e+2  9.6000000e+2  1.0140000e+3 │ 2.2260000e+3  2.3600000e+3  2.4940000e+3 ││
    ││      │ 1.1700000e+3  1.2400000e+3  1.3100000e+3 │ 2.4900000e+3  2.6400000e+3  2.7900000e+3 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[5]: ;=>_e shape 1:3->0:5                          │
    │┌──────┬──────────────────────────────────────────┐│
    ││      │axis 1                                    ││
    │├──────┼──────────────────────────────────────────┤│
    ││axis 0│ 1.4760000e+3  1.5680000e+3  1.6600000e+3 ││
    ││      │ 1.8120000e+3  1.9360000e+3  2.0600000e+3 ││
    ││      │ 2.1480000e+3  2.3040000e+3  2.4600000e+3 ││
    ││      │ 2.4840000e+3  2.6720000e+3  2.8600000e+3 ││
    ││      │ 2.8200000e+3  3.0400000e+3  3.2600000e+3 ││
    │└──────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[6]: ;=>_f shape 1:3->0:5                          │
    │┌──────┬──────────────────────────────────────────┐│
    ││      │axis 1                                    ││
    │├──────┼──────────────────────────────────────────┤│
    ││axis 0│ 1.9920000e+3  2.1760000e+3  2.3600000e+3 ││
    ││      │ 2.6640000e+3  2.9120000e+3  3.1600000e+3 ││
    ││      │ 3.3360000e+3  3.6480000e+3  3.9600000e+3 ││
    ││      │ 4.0080000e+3  4.3840000e+3  4.7600000e+3 ││
    ││      │ 4.6800000e+3  5.1200000e+3  5.5600000e+3 ││
    │└──────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|i->o => ...|o->i" in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|2:4->1:3                                                                                    │
    │┌──────┬───────────────────────────────────────────────┬────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                          │1 @ 0                                                   ││
    ││      │axis 2                                         │axis 2                                                  ││
    │├──────┼───────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  3.0000000  6.0000000  9.0000000    │ 1.2000000e+1  1.5000000e+1  1.8000000e+1  2.1000000e+1 ││
    ││      │ 1.0000000  4.0000000  7.0000000  1.0000000e+1 │ 1.3000000e+1  1.6000000e+1  1.9000000e+1  2.2000000e+1 ││
    ││      │ 2.0000000  5.0000000  8.0000000  1.1000000e+1 │ 1.4000000e+1  1.7000000e+1  2.0000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────────────┴────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "b|...->o => o|...->b" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:4|2:3->1:2                                                                                                                                                      │
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                     │1 @ 0                                     │2 @ 0                                     │3 @ 0                                     ││
    ││      │axis 2                                    │axis 2                                    │axis 2                                    │axis 2                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000     1.0000000     2.0000000    │ 3.0000000     4.0000000     5.0000000    │ 6.0000000     7.0000000     8.0000000    │ 9.0000000     1.0000000e+1  1.1000000e+1 ││
    ││      │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho3 = hey2 ++ "...b|...i->...o => ...i|...o->...b" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                                                                                                                    │
    │┌──────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                                 │1 @ 4                                                                 │2 @ 4                                                                 │3 @ 4                                                                 ││
    ││      │axis 5                                                                │axis 5                                                                │axis 5                                                                │axis 5                                                                ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000     1.0000000     2.0000000     3.0000000     4.0000000    │ 5.0000000     6.0000000     7.0000000     8.0000000     9.0000000    │ 1.0000000e+1  1.1000000e+1  1.2000000e+1  1.3000000e+1  1.4000000e+1 │ 1.5000000e+1  1.6000000e+1  1.7000000e+1  1.8000000e+1  1.9000000e+1 ││
    ││axis 3│ 2.0000000e+1  2.1000000e+1  2.2000000e+1  2.3000000e+1  2.4000000e+1 │ 2.5000000e+1  2.6000000e+1  2.7000000e+1  2.8000000e+1  2.9000000e+1 │ 3.0000000e+1  3.1000000e+1  3.2000000e+1  3.3000000e+1  3.4000000e+1 │ 3.5000000e+1  3.6000000e+1  3.7000000e+1  3.8000000e+1  3.9000000e+1 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.0000000e+2  1.0100000e+2  1.0200000e+2  1.0300000e+2  1.0400000e+2 │ 1.0500000e+2  1.0600000e+2  1.0700000e+2  1.0800000e+2  1.0900000e+2 │ 1.1000000e+2  1.1100000e+2  1.1200000e+2  1.1300000e+2  1.1400000e+2 │ 1.1500000e+2  1.1600000e+2  1.1700000e+2  1.1800000e+2  1.1900000e+2 ││
    ││      │ 1.2000000e+2  1.2100000e+2  1.2200000e+2  1.2300000e+2  1.2400000e+2 │ 1.2500000e+2  1.2600000e+2  1.2700000e+2  1.2800000e+2  1.2900000e+2 │ 1.3000000e+2  1.3100000e+2  1.3200000e+2  1.3300000e+2  1.3400000e+2 │ 1.3500000e+2  1.3600000e+2  1.3700000e+2  1.3800000e+2  1.3900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4000000e+2  1.4100000e+2  1.4200000e+2  1.4300000e+2  1.4400000e+2 │ 1.4500000e+2  1.4600000e+2  1.4700000e+2  1.4800000e+2  1.4900000e+2 │ 1.5000000e+2  1.5100000e+2  1.5200000e+2  1.5300000e+2  1.5400000e+2 │ 1.5500000e+2  1.5600000e+2  1.5700000e+2  1.5800000e+2  1.5900000e+2 ││
    ││axis 3│ 1.6000000e+2  1.6100000e+2  1.6200000e+2  1.6300000e+2  1.6400000e+2 │ 1.6500000e+2  1.6600000e+2  1.6700000e+2  1.6800000e+2  1.6900000e+2 │ 1.7000000e+2  1.7100000e+2  1.7200000e+2  1.7300000e+2  1.7400000e+2 │ 1.7500000e+2  1.7600000e+2  1.7700000e+2  1.7800000e+2  1.7900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 2.4000000e+2  2.4100000e+2  2.4200000e+2  2.4300000e+2  2.4400000e+2 │ 2.4500000e+2  2.4600000e+2  2.4700000e+2  2.4800000e+2  2.4900000e+2 │ 2.5000000e+2  2.5100000e+2  2.5200000e+2  2.5300000e+2  2.5400000e+2 │ 2.5500000e+2  2.5600000e+2  2.5700000e+2  2.5800000e+2  2.5900000e+2 ││
    ││      │ 2.6000000e+2  2.6100000e+2  2.6200000e+2  2.6300000e+2  2.6400000e+2 │ 2.6500000e+2  2.6600000e+2  2.6700000e+2  2.6800000e+2  2.6900000e+2 │ 2.7000000e+2  2.7100000e+2  2.7200000e+2  2.7300000e+2  2.7400000e+2 │ 2.7500000e+2  2.7600000e+2  2.7700000e+2  2.7800000e+2  2.7900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                  │ ...                                                                  │ ...                                                                  │ ...                                                                  ││
    ││axis 3│                                                                      │                                                                      │                                                                      │                                                                      ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6000000e+2  5.6100000e+2  5.6200000e+2  5.6300000e+2  5.6400000e+2 │ 5.6500000e+2  5.6600000e+2  5.6700000e+2  5.6800000e+2  5.6900000e+2 │ 5.7000000e+2  5.7100000e+2  5.7200000e+2  5.7300000e+2  5.7400000e+2 │ 5.7500000e+2  5.7600000e+2  5.7700000e+2  5.7800000e+2  5.7900000e+2 ││
    ││axis 3│ 5.8000000e+2  5.8100000e+2  5.8200000e+2  5.8300000e+2  5.8400000e+2 │ 5.8500000e+2  5.8600000e+2  5.8700000e+2  5.8800000e+2  5.8900000e+2 │ 5.9000000e+2  5.9100000e+2  5.9200000e+2  5.9300000e+2  5.9400000e+2 │ 5.9500000e+2  5.9600000e+2  5.9700000e+2  5.9800000e+2  5.9900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 6.6000000e+2  6.6100000e+2  6.6200000e+2  6.6300000e+2  6.6400000e+2 │ 6.6500000e+2  6.6600000e+2  6.6700000e+2  6.6800000e+2  6.6900000e+2 │ 6.7000000e+2  6.7100000e+2  6.7200000e+2  6.7300000e+2  6.7400000e+2 │ 6.7500000e+2  6.7600000e+2  6.7700000e+2  6.7800000e+2  6.7900000e+2 ││
    ││      │ 6.8000000e+2  6.8100000e+2  6.8200000e+2  6.8300000e+2  6.8400000e+2 │ 6.8500000e+2  6.8600000e+2  6.8700000e+2  6.8800000e+2  6.8900000e+2 │ 6.9000000e+2  6.9100000e+2  6.9200000e+2  6.9300000e+2  6.9400000e+2 │ 6.9500000e+2  6.9600000e+2  6.9700000e+2  6.9800000e+2  6.9900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0000000e+2  7.0100000e+2  7.0200000e+2  7.0300000e+2  7.0400000e+2 │ 7.0500000e+2  7.0600000e+2  7.0700000e+2  7.0800000e+2  7.0900000e+2 │ 7.1000000e+2  7.1100000e+2  7.1200000e+2  7.1300000e+2  7.1400000e+2 │ 7.1500000e+2  7.1600000e+2  7.1700000e+2  7.1800000e+2  7.1900000e+2 ││
    ││axis 3│ 7.2000000e+2  7.2100000e+2  7.2200000e+2  7.2300000e+2  7.2400000e+2 │ 7.2500000e+2  7.2600000e+2  7.2700000e+2  7.2800000e+2  7.2900000e+2 │ 7.3000000e+2  7.3100000e+2  7.3200000e+2  7.3300000e+2  7.3400000e+2 │ 7.3500000e+2  7.3600000e+2  7.3700000e+2  7.3800000e+2  7.3900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 8.0000000e+2  8.0100000e+2  8.0200000e+2  8.0300000e+2  8.0400000e+2 │ 8.0500000e+2  8.0600000e+2  8.0700000e+2  8.0800000e+2  8.0900000e+2 │ 8.1000000e+2  8.1100000e+2  8.1200000e+2  8.1300000e+2  8.1400000e+2 │ 8.1500000e+2  8.1600000e+2  8.1700000e+2  8.1800000e+2  8.1900000e+2 ││
    ││      │ 8.2000000e+2  8.2100000e+2  8.2200000e+2  8.2300000e+2  8.2400000e+2 │ 8.2500000e+2  8.2600000e+2  8.2700000e+2  8.2800000e+2  8.2900000e+2 │ 8.3000000e+2  8.3100000e+2  8.3200000e+2  8.3300000e+2  8.3400000e+2 │ 8.3500000e+2  8.3600000e+2  8.3700000e+2  8.3800000e+2  8.3900000e+2 ││
    │└──────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                                 │1 @ 4                                                                 │2 @ 4                                                                 │3 @ 4                                                                 ││
    ││      │axis 5                                                                │axis 5                                                                │axis 5                                                                │axis 5                                                                ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 8.4000000e+2  8.4100000e+2  8.4200000e+2  8.4300000e+2  8.4400000e+2 │ 8.4500000e+2  8.4600000e+2  8.4700000e+2  8.4800000e+2  8.4900000e+2 │ 8.5000000e+2  8.5100000e+2  8.5200000e+2  8.5300000e+2  8.5400000e+2 │ 8.5500000e+2  8.5600000e+2  8.5700000e+2  8.5800000e+2  8.5900000e+2 ││
    ││axis 3│ 8.6000000e+2  8.6100000e+2  8.6200000e+2  8.6300000e+2  8.6400000e+2 │ 8.6500000e+2  8.6600000e+2  8.6700000e+2  8.6800000e+2  8.6900000e+2 │ 8.7000000e+2  8.7100000e+2  8.7200000e+2  8.7300000e+2  8.7400000e+2 │ 8.7500000e+2  8.7600000e+2  8.7700000e+2  8.7800000e+2  8.7900000e+2 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 9.4000000e+2  9.4100000e+2  9.4200000e+2  9.4300000e+2  9.4400000e+2 │ 9.4500000e+2  9.4600000e+2  9.4700000e+2  9.4800000e+2  9.4900000e+2 │ 9.5000000e+2  9.5100000e+2  9.5200000e+2  9.5300000e+2  9.5400000e+2 │ 9.5500000e+2  9.5600000e+2  9.5700000e+2  9.5800000e+2  9.5900000e+2 ││
    ││      │ 9.6000000e+2  9.6100000e+2  9.6200000e+2  9.6300000e+2  9.6400000e+2 │ 9.6500000e+2  9.6600000e+2  9.6700000e+2  9.6800000e+2  9.6900000e+2 │ 9.7000000e+2  9.7100000e+2  9.7200000e+2  9.7300000e+2  9.7400000e+2 │ 9.7500000e+2  9.7600000e+2  9.7700000e+2  9.7800000e+2  9.7900000e+2 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 9.8000000e+2  9.8100000e+2  9.8200000e+2  9.8300000e+2  9.8400000e+2 │ 9.8500000e+2  9.8600000e+2  9.8700000e+2  9.8800000e+2  9.8900000e+2 │ 9.9000000e+2  9.9100000e+2  9.9200000e+2  9.9300000e+2  9.9400000e+2 │ 9.9500000e+2  9.9600000e+2  9.9700000e+2  9.9800000e+2  9.9900000e+2 ││
    ││axis 3│ 1.0000000e+3  1.0010000e+3  1.0020000e+3  1.0030000e+3  1.0040000e+3 │ 1.0050000e+3  1.0060000e+3  1.0070000e+3  1.0080000e+3  1.0090000e+3 │ 1.0100000e+3  1.0110000e+3  1.0120000e+3  1.0130000e+3  1.0140000e+3 │ 1.0150000e+3  1.0160000e+3  1.0170000e+3  1.0180000e+3  1.0190000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.0800000e+3  1.0810000e+3  1.0820000e+3  1.0830000e+3  1.0840000e+3 │ 1.0850000e+3  1.0860000e+3  1.0870000e+3  1.0880000e+3  1.0890000e+3 │ 1.0900000e+3  1.0910000e+3  1.0920000e+3  1.0930000e+3  1.0940000e+3 │ 1.0950000e+3  1.0960000e+3  1.0970000e+3  1.0980000e+3  1.0990000e+3 ││
    ││      │ 1.1000000e+3  1.1010000e+3  1.1020000e+3  1.1030000e+3  1.1040000e+3 │ 1.1050000e+3  1.1060000e+3  1.1070000e+3  1.1080000e+3  1.1090000e+3 │ 1.1100000e+3  1.1110000e+3  1.1120000e+3  1.1130000e+3  1.1140000e+3 │ 1.1150000e+3  1.1160000e+3  1.1170000e+3  1.1180000e+3  1.1190000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                  │ ...                                                                  │ ...                                                                  │ ...                                                                  ││
    ││axis 3│                                                                      │                                                                      │                                                                      │                                                                      ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.4000000e+3  1.4010000e+3  1.4020000e+3  1.4030000e+3  1.4040000e+3 │ 1.4050000e+3  1.4060000e+3  1.4070000e+3  1.4080000e+3  1.4090000e+3 │ 1.4100000e+3  1.4110000e+3  1.4120000e+3  1.4130000e+3  1.4140000e+3 │ 1.4150000e+3  1.4160000e+3  1.4170000e+3  1.4180000e+3  1.4190000e+3 ││
    ││axis 3│ 1.4200000e+3  1.4210000e+3  1.4220000e+3  1.4230000e+3  1.4240000e+3 │ 1.4250000e+3  1.4260000e+3  1.4270000e+3  1.4280000e+3  1.4290000e+3 │ 1.4300000e+3  1.4310000e+3  1.4320000e+3  1.4330000e+3  1.4340000e+3 │ 1.4350000e+3  1.4360000e+3  1.4370000e+3  1.4380000e+3  1.4390000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.5000000e+3  1.5010000e+3  1.5020000e+3  1.5030000e+3  1.5040000e+3 │ 1.5050000e+3  1.5060000e+3  1.5070000e+3  1.5080000e+3  1.5090000e+3 │ 1.5100000e+3  1.5110000e+3  1.5120000e+3  1.5130000e+3  1.5140000e+3 │ 1.5150000e+3  1.5160000e+3  1.5170000e+3  1.5180000e+3  1.5190000e+3 ││
    ││      │ 1.5200000e+3  1.5210000e+3  1.5220000e+3  1.5230000e+3  1.5240000e+3 │ 1.5250000e+3  1.5260000e+3  1.5270000e+3  1.5280000e+3  1.5290000e+3 │ 1.5300000e+3  1.5310000e+3  1.5320000e+3  1.5330000e+3  1.5340000e+3 │ 1.5350000e+3  1.5360000e+3  1.5370000e+3  1.5380000e+3  1.5390000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 1.5400000e+3  1.5410000e+3  1.5420000e+3  1.5430000e+3  1.5440000e+3 │ 1.5450000e+3  1.5460000e+3  1.5470000e+3  1.5480000e+3  1.5490000e+3 │ 1.5500000e+3  1.5510000e+3  1.5520000e+3  1.5530000e+3  1.5540000e+3 │ 1.5550000e+3  1.5560000e+3  1.5570000e+3  1.5580000e+3  1.5590000e+3 ││
    ││axis 3│ 1.5600000e+3  1.5610000e+3  1.5620000e+3  1.5630000e+3  1.5640000e+3 │ 1.5650000e+3  1.5660000e+3  1.5670000e+3  1.5680000e+3  1.5690000e+3 │ 1.5700000e+3  1.5710000e+3  1.5720000e+3  1.5730000e+3  1.5740000e+3 │ 1.5750000e+3  1.5760000e+3  1.5770000e+3  1.5780000e+3  1.5790000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.6400000e+3  1.6410000e+3  1.6420000e+3  1.6430000e+3  1.6440000e+3 │ 1.6450000e+3  1.6460000e+3  1.6470000e+3  1.6480000e+3  1.6490000e+3 │ 1.6500000e+3  1.6510000e+3  1.6520000e+3  1.6530000e+3  1.6540000e+3 │ 1.6550000e+3  1.6560000e+3  1.6570000e+3  1.6580000e+3  1.6590000e+3 ││
    ││      │ 1.6600000e+3  1.6610000e+3  1.6620000e+3  1.6630000e+3  1.6640000e+3 │ 1.6650000e+3  1.6660000e+3  1.6670000e+3  1.6680000e+3  1.6690000e+3 │ 1.6700000e+3  1.6710000e+3  1.6720000e+3  1.6730000e+3  1.6740000e+3 │ 1.6750000e+3  1.6760000e+3  1.6770000e+3  1.6780000e+3  1.6790000e+3 ││
    │└──────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                                 │1 @ 4                                                                 │2 @ 4                                                                 │3 @ 4                                                                 ││
    ││      │axis 5                                                                │axis 5                                                                │axis 5                                                                │axis 5                                                                ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.6800000e+3  1.6810000e+3  1.6820000e+3  1.6830000e+3  1.6840000e+3 │ 1.6850000e+3  1.6860000e+3  1.6870000e+3  1.6880000e+3  1.6890000e+3 │ 1.6900000e+3  1.6910000e+3  1.6920000e+3  1.6930000e+3  1.6940000e+3 │ 1.6950000e+3  1.6960000e+3  1.6970000e+3  1.6980000e+3  1.6990000e+3 ││
    ││axis 3│ 1.7000000e+3  1.7010000e+3  1.7020000e+3  1.7030000e+3  1.7040000e+3 │ 1.7050000e+3  1.7060000e+3  1.7070000e+3  1.7080000e+3  1.7090000e+3 │ 1.7100000e+3  1.7110000e+3  1.7120000e+3  1.7130000e+3  1.7140000e+3 │ 1.7150000e+3  1.7160000e+3  1.7170000e+3  1.7180000e+3  1.7190000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.7800000e+3  1.7810000e+3  1.7820000e+3  1.7830000e+3  1.7840000e+3 │ 1.7850000e+3  1.7860000e+3  1.7870000e+3  1.7880000e+3  1.7890000e+3 │ 1.7900000e+3  1.7910000e+3  1.7920000e+3  1.7930000e+3  1.7940000e+3 │ 1.7950000e+3  1.7960000e+3  1.7970000e+3  1.7980000e+3  1.7990000e+3 ││
    ││      │ 1.8000000e+3  1.8010000e+3  1.8020000e+3  1.8030000e+3  1.8040000e+3 │ 1.8050000e+3  1.8060000e+3  1.8070000e+3  1.8080000e+3  1.8090000e+3 │ 1.8100000e+3  1.8110000e+3  1.8120000e+3  1.8130000e+3  1.8140000e+3 │ 1.8150000e+3  1.8160000e+3  1.8170000e+3  1.8180000e+3  1.8190000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.8200000e+3  1.8210000e+3  1.8220000e+3  1.8230000e+3  1.8240000e+3 │ 1.8250000e+3  1.8260000e+3  1.8270000e+3  1.8280000e+3  1.8290000e+3 │ 1.8300000e+3  1.8310000e+3  1.8320000e+3  1.8330000e+3  1.8340000e+3 │ 1.8350000e+3  1.8360000e+3  1.8370000e+3  1.8380000e+3  1.8390000e+3 ││
    ││axis 3│ 1.8400000e+3  1.8410000e+3  1.8420000e+3  1.8430000e+3  1.8440000e+3 │ 1.8450000e+3  1.8460000e+3  1.8470000e+3  1.8480000e+3  1.8490000e+3 │ 1.8500000e+3  1.8510000e+3  1.8520000e+3  1.8530000e+3  1.8540000e+3 │ 1.8550000e+3  1.8560000e+3  1.8570000e+3  1.8580000e+3  1.8590000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 1.9200000e+3  1.9210000e+3  1.9220000e+3  1.9230000e+3  1.9240000e+3 │ 1.9250000e+3  1.9260000e+3  1.9270000e+3  1.9280000e+3  1.9290000e+3 │ 1.9300000e+3  1.9310000e+3  1.9320000e+3  1.9330000e+3  1.9340000e+3 │ 1.9350000e+3  1.9360000e+3  1.9370000e+3  1.9380000e+3  1.9390000e+3 ││
    ││      │ 1.9400000e+3  1.9410000e+3  1.9420000e+3  1.9430000e+3  1.9440000e+3 │ 1.9450000e+3  1.9460000e+3  1.9470000e+3  1.9480000e+3  1.9490000e+3 │ 1.9500000e+3  1.9510000e+3  1.9520000e+3  1.9530000e+3  1.9540000e+3 │ 1.9550000e+3  1.9560000e+3  1.9570000e+3  1.9580000e+3  1.9590000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                                  │ ...                                                                  │ ...                                                                  │ ...                                                                  ││
    ││axis 3│                                                                      │                                                                      │                                                                      │                                                                      ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.2400000e+3  2.2410000e+3  2.2420000e+3  2.2430000e+3  2.2440000e+3 │ 2.2450000e+3  2.2460000e+3  2.2470000e+3  2.2480000e+3  2.2490000e+3 │ 2.2500000e+3  2.2510000e+3  2.2520000e+3  2.2530000e+3  2.2540000e+3 │ 2.2550000e+3  2.2560000e+3  2.2570000e+3  2.2580000e+3  2.2590000e+3 ││
    ││axis 3│ 2.2600000e+3  2.2610000e+3  2.2620000e+3  2.2630000e+3  2.2640000e+3 │ 2.2650000e+3  2.2660000e+3  2.2670000e+3  2.2680000e+3  2.2690000e+3 │ 2.2700000e+3  2.2710000e+3  2.2720000e+3  2.2730000e+3  2.2740000e+3 │ 2.2750000e+3  2.2760000e+3  2.2770000e+3  2.2780000e+3  2.2790000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 2.3400000e+3  2.3410000e+3  2.3420000e+3  2.3430000e+3  2.3440000e+3 │ 2.3450000e+3  2.3460000e+3  2.3470000e+3  2.3480000e+3  2.3490000e+3 │ 2.3500000e+3  2.3510000e+3  2.3520000e+3  2.3530000e+3  2.3540000e+3 │ 2.3550000e+3  2.3560000e+3  2.3570000e+3  2.3580000e+3  2.3590000e+3 ││
    ││      │ 2.3600000e+3  2.3610000e+3  2.3620000e+3  2.3630000e+3  2.3640000e+3 │ 2.3650000e+3  2.3660000e+3  2.3670000e+3  2.3680000e+3  2.3690000e+3 │ 2.3700000e+3  2.3710000e+3  2.3720000e+3  2.3730000e+3  2.3740000e+3 │ 2.3750000e+3  2.3760000e+3  2.3770000e+3  2.3780000e+3  2.3790000e+3 ││
    │├──────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 2.3800000e+3  2.3810000e+3  2.3820000e+3  2.3830000e+3  2.3840000e+3 │ 2.3850000e+3  2.3860000e+3  2.3870000e+3  2.3880000e+3  2.3890000e+3 │ 2.3900000e+3  2.3910000e+3  2.3920000e+3  2.3930000e+3  2.3940000e+3 │ 2.3950000e+3  2.3960000e+3  2.3970000e+3  2.3980000e+3  2.3990000e+3 ││
    ││axis 3│ 2.4000000e+3  2.4010000e+3  2.4020000e+3  2.4030000e+3  2.4040000e+3 │ 2.4050000e+3  2.4060000e+3  2.4070000e+3  2.4080000e+3  2.4090000e+3 │ 2.4100000e+3  2.4110000e+3  2.4120000e+3  2.4130000e+3  2.4140000e+3 │ 2.4150000e+3  2.4160000e+3  2.4170000e+3  2.4180000e+3  2.4190000e+3 ││
    ││      │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          │ ...           ...           ...           ...           ...          ││
    ││      │ 2.4800000e+3  2.4810000e+3  2.4820000e+3  2.4830000e+3  2.4840000e+3 │ 2.4850000e+3  2.4860000e+3  2.4870000e+3  2.4880000e+3  2.4890000e+3 │ 2.4900000e+3  2.4910000e+3  2.4920000e+3  2.4930000e+3  2.4940000e+3 │ 2.4950000e+3  2.4960000e+3  2.4970000e+3  2.4980000e+3  2.4990000e+3 ││
    ││      │ 2.5000000e+3  2.5010000e+3  2.5020000e+3  2.5030000e+3  2.5040000e+3 │ 2.5050000e+3  2.5060000e+3  2.5070000e+3  2.5080000e+3  2.5090000e+3 │ 2.5100000e+3  2.5110000e+3  2.5120000e+3  2.5130000e+3  2.5140000e+3 │ 2.5150000e+3  2.5160000e+3  2.5170000e+3  2.5180000e+3  2.5190000e+3 ││
    │└──────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: =>_ho3 shape 0:2,1:5|4:4,5:7->2:6,3:3                                                                                                                                                                                                                      │
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        │3 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0000000     2.0000000e+1  ...  1.0000000e+2  1.2000000e+2 │ 5.0000000     2.5000000e+1  ...  1.0500000e+2  1.2500000e+2 │ 1.0000000e+1  3.0000000e+1  ...  1.1000000e+2  1.3000000e+2 │ 1.5000000e+1  3.5000000e+1  ...  1.1500000e+2  1.3500000e+2 ││
    ││axis 3│ 8.4000000e+2  8.6000000e+2  ...  9.4000000e+2  9.6000000e+2 │ 8.4500000e+2  8.6500000e+2  ...  9.4500000e+2  9.6500000e+2 │ 8.5000000e+2  8.7000000e+2  ...  9.5000000e+2  9.7000000e+2 │ 8.5500000e+2  8.7500000e+2  ...  9.5500000e+2  9.7500000e+2 ││
    ││      │ 1.6800000e+3  1.7000000e+3  ...  1.7800000e+3  1.8000000e+3 │ 1.6850000e+3  1.7050000e+3  ...  1.7850000e+3  1.8050000e+3 │ 1.6900000e+3  1.7100000e+3  ...  1.7900000e+3  1.8100000e+3 │ 1.6950000e+3  1.7150000e+3  ...  1.7950000e+3  1.8150000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4000000e+2  1.6000000e+2  ...  2.4000000e+2  2.6000000e+2 │ 1.4500000e+2  1.6500000e+2  ...  2.4500000e+2  2.6500000e+2 │ 1.5000000e+2  1.7000000e+2  ...  2.5000000e+2  2.7000000e+2 │ 1.5500000e+2  1.7500000e+2  ...  2.5500000e+2  2.7500000e+2 ││
    ││axis 3│ 9.8000000e+2  1.0000000e+3  ...  1.0800000e+3  1.1000000e+3 │ 9.8500000e+2  1.0050000e+3  ...  1.0850000e+3  1.1050000e+3 │ 9.9000000e+2  1.0100000e+3  ...  1.0900000e+3  1.1100000e+3 │ 9.9500000e+2  1.0150000e+3  ...  1.0950000e+3  1.1150000e+3 ││
    ││      │ 1.8200000e+3  1.8400000e+3  ...  1.9200000e+3  1.9400000e+3 │ 1.8250000e+3  1.8450000e+3  ...  1.9250000e+3  1.9450000e+3 │ 1.8300000e+3  1.8500000e+3  ...  1.9300000e+3  1.9500000e+3 │ 1.8350000e+3  1.8550000e+3  ...  1.9350000e+3  1.9550000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                         │ ...                                                         │ ...                                                         │ ...                                                         ││
    ││axis 3│                                                             │                                                             │                                                             │                                                             ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6000000e+2  5.8000000e+2  ...  6.6000000e+2  6.8000000e+2 │ 5.6500000e+2  5.8500000e+2  ...  6.6500000e+2  6.8500000e+2 │ 5.7000000e+2  5.9000000e+2  ...  6.7000000e+2  6.9000000e+2 │ 5.7500000e+2  5.9500000e+2  ...  6.7500000e+2  6.9500000e+2 ││
    ││axis 3│ 1.4000000e+3  1.4200000e+3  ...  1.5000000e+3  1.5200000e+3 │ 1.4050000e+3  1.4250000e+3  ...  1.5050000e+3  1.5250000e+3 │ 1.4100000e+3  1.4300000e+3  ...  1.5100000e+3  1.5300000e+3 │ 1.4150000e+3  1.4350000e+3  ...  1.5150000e+3  1.5350000e+3 ││
    ││      │ 2.2400000e+3  2.2600000e+3  ...  2.3400000e+3  2.3600000e+3 │ 2.2450000e+3  2.2650000e+3  ...  2.3450000e+3  2.3650000e+3 │ 2.2500000e+3  2.2700000e+3  ...  2.3500000e+3  2.3700000e+3 │ 2.2550000e+3  2.2750000e+3  ...  2.3550000e+3  2.3750000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0000000e+2  7.2000000e+2  ...  8.0000000e+2  8.2000000e+2 │ 7.0500000e+2  7.2500000e+2  ...  8.0500000e+2  8.2500000e+2 │ 7.1000000e+2  7.3000000e+2  ...  8.1000000e+2  8.3000000e+2 │ 7.1500000e+2  7.3500000e+2  ...  8.1500000e+2  8.3500000e+2 ││
    ││axis 3│ 1.5400000e+3  1.5600000e+3  ...  1.6400000e+3  1.6600000e+3 │ 1.5450000e+3  1.5650000e+3  ...  1.6450000e+3  1.6650000e+3 │ 1.5500000e+3  1.5700000e+3  ...  1.6500000e+3  1.6700000e+3 │ 1.5550000e+3  1.5750000e+3  ...  1.6550000e+3  1.6750000e+3 ││
    ││      │ 2.3800000e+3  2.4000000e+3  ...  2.4800000e+3  2.5000000e+3 │ 2.3850000e+3  2.4050000e+3  ...  2.4850000e+3  2.5050000e+3 │ 2.3900000e+3  2.4100000e+3  ...  2.4900000e+3  2.5100000e+3 │ 2.3950000e+3  2.4150000e+3  ...  2.4950000e+3  2.5150000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        │3 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.0000000     2.1000000e+1  ...  1.0100000e+2  1.2100000e+2 │ 6.0000000     2.6000000e+1  ...  1.0600000e+2  1.2600000e+2 │ 1.1000000e+1  3.1000000e+1  ...  1.1100000e+2  1.3100000e+2 │ 1.6000000e+1  3.6000000e+1  ...  1.1600000e+2  1.3600000e+2 ││
    ││axis 3│ 8.4100000e+2  8.6100000e+2  ...  9.4100000e+2  9.6100000e+2 │ 8.4600000e+2  8.6600000e+2  ...  9.4600000e+2  9.6600000e+2 │ 8.5100000e+2  8.7100000e+2  ...  9.5100000e+2  9.7100000e+2 │ 8.5600000e+2  8.7600000e+2  ...  9.5600000e+2  9.7600000e+2 ││
    ││      │ 1.6810000e+3  1.7010000e+3  ...  1.7810000e+3  1.8010000e+3 │ 1.6860000e+3  1.7060000e+3  ...  1.7860000e+3  1.8060000e+3 │ 1.6910000e+3  1.7110000e+3  ...  1.7910000e+3  1.8110000e+3 │ 1.6960000e+3  1.7160000e+3  ...  1.7960000e+3  1.8160000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4100000e+2  1.6100000e+2  ...  2.4100000e+2  2.6100000e+2 │ 1.4600000e+2  1.6600000e+2  ...  2.4600000e+2  2.6600000e+2 │ 1.5100000e+2  1.7100000e+2  ...  2.5100000e+2  2.7100000e+2 │ 1.5600000e+2  1.7600000e+2  ...  2.5600000e+2  2.7600000e+2 ││
    ││axis 3│ 9.8100000e+2  1.0010000e+3  ...  1.0810000e+3  1.1010000e+3 │ 9.8600000e+2  1.0060000e+3  ...  1.0860000e+3  1.1060000e+3 │ 9.9100000e+2  1.0110000e+3  ...  1.0910000e+3  1.1110000e+3 │ 9.9600000e+2  1.0160000e+3  ...  1.0960000e+3  1.1160000e+3 ││
    ││      │ 1.8210000e+3  1.8410000e+3  ...  1.9210000e+3  1.9410000e+3 │ 1.8260000e+3  1.8460000e+3  ...  1.9260000e+3  1.9460000e+3 │ 1.8310000e+3  1.8510000e+3  ...  1.9310000e+3  1.9510000e+3 │ 1.8360000e+3  1.8560000e+3  ...  1.9360000e+3  1.9560000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                         │ ...                                                         │ ...                                                         │ ...                                                         ││
    ││axis 3│                                                             │                                                             │                                                             │                                                             ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6100000e+2  5.8100000e+2  ...  6.6100000e+2  6.8100000e+2 │ 5.6600000e+2  5.8600000e+2  ...  6.6600000e+2  6.8600000e+2 │ 5.7100000e+2  5.9100000e+2  ...  6.7100000e+2  6.9100000e+2 │ 5.7600000e+2  5.9600000e+2  ...  6.7600000e+2  6.9600000e+2 ││
    ││axis 3│ 1.4010000e+3  1.4210000e+3  ...  1.5010000e+3  1.5210000e+3 │ 1.4060000e+3  1.4260000e+3  ...  1.5060000e+3  1.5260000e+3 │ 1.4110000e+3  1.4310000e+3  ...  1.5110000e+3  1.5310000e+3 │ 1.4160000e+3  1.4360000e+3  ...  1.5160000e+3  1.5360000e+3 ││
    ││      │ 2.2410000e+3  2.2610000e+3  ...  2.3410000e+3  2.3610000e+3 │ 2.2460000e+3  2.2660000e+3  ...  2.3460000e+3  2.3660000e+3 │ 2.2510000e+3  2.2710000e+3  ...  2.3510000e+3  2.3710000e+3 │ 2.2560000e+3  2.2760000e+3  ...  2.3560000e+3  2.3760000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0100000e+2  7.2100000e+2  ...  8.0100000e+2  8.2100000e+2 │ 7.0600000e+2  7.2600000e+2  ...  8.0600000e+2  8.2600000e+2 │ 7.1100000e+2  7.3100000e+2  ...  8.1100000e+2  8.3100000e+2 │ 7.1600000e+2  7.3600000e+2  ...  8.1600000e+2  8.3600000e+2 ││
    ││axis 3│ 1.5410000e+3  1.5610000e+3  ...  1.6410000e+3  1.6610000e+3 │ 1.5460000e+3  1.5660000e+3  ...  1.6460000e+3  1.6660000e+3 │ 1.5510000e+3  1.5710000e+3  ...  1.6510000e+3  1.6710000e+3 │ 1.5560000e+3  1.5760000e+3  ...  1.6560000e+3  1.6760000e+3 ││
    ││      │ 2.3810000e+3  2.4010000e+3  ...  2.4810000e+3  2.5010000e+3 │ 2.3860000e+3  2.4060000e+3  ...  2.4860000e+3  2.5060000e+3 │ 2.3910000e+3  2.4110000e+3  ...  2.4910000e+3  2.5110000e+3 │ 2.3960000e+3  2.4160000e+3  ...  2.4960000e+3  2.5160000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        │3 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 2.0000000     2.2000000e+1  ...  1.0200000e+2  1.2200000e+2 │ 7.0000000     2.7000000e+1  ...  1.0700000e+2  1.2700000e+2 │ 1.2000000e+1  3.2000000e+1  ...  1.1200000e+2  1.3200000e+2 │ 1.7000000e+1  3.7000000e+1  ...  1.1700000e+2  1.3700000e+2 ││
    ││axis 3│ 8.4200000e+2  8.6200000e+2  ...  9.4200000e+2  9.6200000e+2 │ 8.4700000e+2  8.6700000e+2  ...  9.4700000e+2  9.6700000e+2 │ 8.5200000e+2  8.7200000e+2  ...  9.5200000e+2  9.7200000e+2 │ 8.5700000e+2  8.7700000e+2  ...  9.5700000e+2  9.7700000e+2 ││
    ││      │ 1.6820000e+3  1.7020000e+3  ...  1.7820000e+3  1.8020000e+3 │ 1.6870000e+3  1.7070000e+3  ...  1.7870000e+3  1.8070000e+3 │ 1.6920000e+3  1.7120000e+3  ...  1.7920000e+3  1.8120000e+3 │ 1.6970000e+3  1.7170000e+3  ...  1.7970000e+3  1.8170000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4200000e+2  1.6200000e+2  ...  2.4200000e+2  2.6200000e+2 │ 1.4700000e+2  1.6700000e+2  ...  2.4700000e+2  2.6700000e+2 │ 1.5200000e+2  1.7200000e+2  ...  2.5200000e+2  2.7200000e+2 │ 1.5700000e+2  1.7700000e+2  ...  2.5700000e+2  2.7700000e+2 ││
    ││axis 3│ 9.8200000e+2  1.0020000e+3  ...  1.0820000e+3  1.1020000e+3 │ 9.8700000e+2  1.0070000e+3  ...  1.0870000e+3  1.1070000e+3 │ 9.9200000e+2  1.0120000e+3  ...  1.0920000e+3  1.1120000e+3 │ 9.9700000e+2  1.0170000e+3  ...  1.0970000e+3  1.1170000e+3 ││
    ││      │ 1.8220000e+3  1.8420000e+3  ...  1.9220000e+3  1.9420000e+3 │ 1.8270000e+3  1.8470000e+3  ...  1.9270000e+3  1.9470000e+3 │ 1.8320000e+3  1.8520000e+3  ...  1.9320000e+3  1.9520000e+3 │ 1.8370000e+3  1.8570000e+3  ...  1.9370000e+3  1.9570000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                         │ ...                                                         │ ...                                                         │ ...                                                         ││
    ││axis 3│                                                             │                                                             │                                                             │                                                             ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6200000e+2  5.8200000e+2  ...  6.6200000e+2  6.8200000e+2 │ 5.6700000e+2  5.8700000e+2  ...  6.6700000e+2  6.8700000e+2 │ 5.7200000e+2  5.9200000e+2  ...  6.7200000e+2  6.9200000e+2 │ 5.7700000e+2  5.9700000e+2  ...  6.7700000e+2  6.9700000e+2 ││
    ││axis 3│ 1.4020000e+3  1.4220000e+3  ...  1.5020000e+3  1.5220000e+3 │ 1.4070000e+3  1.4270000e+3  ...  1.5070000e+3  1.5270000e+3 │ 1.4120000e+3  1.4320000e+3  ...  1.5120000e+3  1.5320000e+3 │ 1.4170000e+3  1.4370000e+3  ...  1.5170000e+3  1.5370000e+3 ││
    ││      │ 2.2420000e+3  2.2620000e+3  ...  2.3420000e+3  2.3620000e+3 │ 2.2470000e+3  2.2670000e+3  ...  2.3470000e+3  2.3670000e+3 │ 2.2520000e+3  2.2720000e+3  ...  2.3520000e+3  2.3720000e+3 │ 2.2570000e+3  2.2770000e+3  ...  2.3570000e+3  2.3770000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0200000e+2  7.2200000e+2  ...  8.0200000e+2  8.2200000e+2 │ 7.0700000e+2  7.2700000e+2  ...  8.0700000e+2  8.2700000e+2 │ 7.1200000e+2  7.3200000e+2  ...  8.1200000e+2  8.3200000e+2 │ 7.1700000e+2  7.3700000e+2  ...  8.1700000e+2  8.3700000e+2 ││
    ││axis 3│ 1.5420000e+3  1.5620000e+3  ...  1.6420000e+3  1.6620000e+3 │ 1.5470000e+3  1.5670000e+3  ...  1.6470000e+3  1.6670000e+3 │ 1.5520000e+3  1.5720000e+3  ...  1.6520000e+3  1.6720000e+3 │ 1.5570000e+3  1.5770000e+3  ...  1.6570000e+3  1.6770000e+3 ││
    ││      │ 2.3820000e+3  2.4020000e+3  ...  2.4820000e+3  2.5020000e+3 │ 2.3870000e+3  2.4070000e+3  ...  2.4870000e+3  2.5070000e+3 │ 2.3920000e+3  2.4120000e+3  ...  2.4920000e+3  2.5120000e+3 │ 2.3970000e+3  2.4170000e+3  ...  2.4970000e+3  2.5170000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        │3 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 3.0000000     2.3000000e+1  ...  1.0300000e+2  1.2300000e+2 │ 8.0000000     2.8000000e+1  ...  1.0800000e+2  1.2800000e+2 │ 1.3000000e+1  3.3000000e+1  ...  1.1300000e+2  1.3300000e+2 │ 1.8000000e+1  3.8000000e+1  ...  1.1800000e+2  1.3800000e+2 ││
    ││axis 3│ 8.4300000e+2  8.6300000e+2  ...  9.4300000e+2  9.6300000e+2 │ 8.4800000e+2  8.6800000e+2  ...  9.4800000e+2  9.6800000e+2 │ 8.5300000e+2  8.7300000e+2  ...  9.5300000e+2  9.7300000e+2 │ 8.5800000e+2  8.7800000e+2  ...  9.5800000e+2  9.7800000e+2 ││
    ││      │ 1.6830000e+3  1.7030000e+3  ...  1.7830000e+3  1.8030000e+3 │ 1.6880000e+3  1.7080000e+3  ...  1.7880000e+3  1.8080000e+3 │ 1.6930000e+3  1.7130000e+3  ...  1.7930000e+3  1.8130000e+3 │ 1.6980000e+3  1.7180000e+3  ...  1.7980000e+3  1.8180000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4300000e+2  1.6300000e+2  ...  2.4300000e+2  2.6300000e+2 │ 1.4800000e+2  1.6800000e+2  ...  2.4800000e+2  2.6800000e+2 │ 1.5300000e+2  1.7300000e+2  ...  2.5300000e+2  2.7300000e+2 │ 1.5800000e+2  1.7800000e+2  ...  2.5800000e+2  2.7800000e+2 ││
    ││axis 3│ 9.8300000e+2  1.0030000e+3  ...  1.0830000e+3  1.1030000e+3 │ 9.8800000e+2  1.0080000e+3  ...  1.0880000e+3  1.1080000e+3 │ 9.9300000e+2  1.0130000e+3  ...  1.0930000e+3  1.1130000e+3 │ 9.9800000e+2  1.0180000e+3  ...  1.0980000e+3  1.1180000e+3 ││
    ││      │ 1.8230000e+3  1.8430000e+3  ...  1.9230000e+3  1.9430000e+3 │ 1.8280000e+3  1.8480000e+3  ...  1.9280000e+3  1.9480000e+3 │ 1.8330000e+3  1.8530000e+3  ...  1.9330000e+3  1.9530000e+3 │ 1.8380000e+3  1.8580000e+3  ...  1.9380000e+3  1.9580000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                         │ ...                                                         │ ...                                                         │ ...                                                         ││
    ││axis 3│                                                             │                                                             │                                                             │                                                             ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6300000e+2  5.8300000e+2  ...  6.6300000e+2  6.8300000e+2 │ 5.6800000e+2  5.8800000e+2  ...  6.6800000e+2  6.8800000e+2 │ 5.7300000e+2  5.9300000e+2  ...  6.7300000e+2  6.9300000e+2 │ 5.7800000e+2  5.9800000e+2  ...  6.7800000e+2  6.9800000e+2 ││
    ││axis 3│ 1.4030000e+3  1.4230000e+3  ...  1.5030000e+3  1.5230000e+3 │ 1.4080000e+3  1.4280000e+3  ...  1.5080000e+3  1.5280000e+3 │ 1.4130000e+3  1.4330000e+3  ...  1.5130000e+3  1.5330000e+3 │ 1.4180000e+3  1.4380000e+3  ...  1.5180000e+3  1.5380000e+3 ││
    ││      │ 2.2430000e+3  2.2630000e+3  ...  2.3430000e+3  2.3630000e+3 │ 2.2480000e+3  2.2680000e+3  ...  2.3480000e+3  2.3680000e+3 │ 2.2530000e+3  2.2730000e+3  ...  2.3530000e+3  2.3730000e+3 │ 2.2580000e+3  2.2780000e+3  ...  2.3580000e+3  2.3780000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0300000e+2  7.2300000e+2  ...  8.0300000e+2  8.2300000e+2 │ 7.0800000e+2  7.2800000e+2  ...  8.0800000e+2  8.2800000e+2 │ 7.1300000e+2  7.3300000e+2  ...  8.1300000e+2  8.3300000e+2 │ 7.1800000e+2  7.3800000e+2  ...  8.1800000e+2  8.3800000e+2 ││
    ││axis 3│ 1.5430000e+3  1.5630000e+3  ...  1.6430000e+3  1.6630000e+3 │ 1.5480000e+3  1.5680000e+3  ...  1.6480000e+3  1.6680000e+3 │ 1.5530000e+3  1.5730000e+3  ...  1.6530000e+3  1.6730000e+3 │ 1.5580000e+3  1.5780000e+3  ...  1.6580000e+3  1.6780000e+3 ││
    ││      │ 2.3830000e+3  2.4030000e+3  ...  2.4830000e+3  2.5030000e+3 │ 2.3880000e+3  2.4080000e+3  ...  2.4880000e+3  2.5080000e+3 │ 2.3930000e+3  2.4130000e+3  ...  2.4930000e+3  2.5130000e+3 │ 2.3980000e+3  2.4180000e+3  ...  2.4980000e+3  2.5180000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                                        │1 @ 4                                                        │2 @ 4                                                        │3 @ 4                                                        ││
    ││      │axis 5                                                       │axis 5                                                       │axis 5                                                       │axis 5                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 4.0000000     2.4000000e+1  ...  1.0400000e+2  1.2400000e+2 │ 9.0000000     2.9000000e+1  ...  1.0900000e+2  1.2900000e+2 │ 1.4000000e+1  3.4000000e+1  ...  1.1400000e+2  1.3400000e+2 │ 1.9000000e+1  3.9000000e+1  ...  1.1900000e+2  1.3900000e+2 ││
    ││axis 3│ 8.4400000e+2  8.6400000e+2  ...  9.4400000e+2  9.6400000e+2 │ 8.4900000e+2  8.6900000e+2  ...  9.4900000e+2  9.6900000e+2 │ 8.5400000e+2  8.7400000e+2  ...  9.5400000e+2  9.7400000e+2 │ 8.5900000e+2  8.7900000e+2  ...  9.5900000e+2  9.7900000e+2 ││
    ││      │ 1.6840000e+3  1.7040000e+3  ...  1.7840000e+3  1.8040000e+3 │ 1.6890000e+3  1.7090000e+3  ...  1.7890000e+3  1.8090000e+3 │ 1.6940000e+3  1.7140000e+3  ...  1.7940000e+3  1.8140000e+3 │ 1.6990000e+3  1.7190000e+3  ...  1.7990000e+3  1.8190000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4400000e+2  1.6400000e+2  ...  2.4400000e+2  2.6400000e+2 │ 1.4900000e+2  1.6900000e+2  ...  2.4900000e+2  2.6900000e+2 │ 1.5400000e+2  1.7400000e+2  ...  2.5400000e+2  2.7400000e+2 │ 1.5900000e+2  1.7900000e+2  ...  2.5900000e+2  2.7900000e+2 ││
    ││axis 3│ 9.8400000e+2  1.0040000e+3  ...  1.0840000e+3  1.1040000e+3 │ 9.8900000e+2  1.0090000e+3  ...  1.0890000e+3  1.1090000e+3 │ 9.9400000e+2  1.0140000e+3  ...  1.0940000e+3  1.1140000e+3 │ 9.9900000e+2  1.0190000e+3  ...  1.0990000e+3  1.1190000e+3 ││
    ││      │ 1.8240000e+3  1.8440000e+3  ...  1.9240000e+3  1.9440000e+3 │ 1.8290000e+3  1.8490000e+3  ...  1.9290000e+3  1.9490000e+3 │ 1.8340000e+3  1.8540000e+3  ...  1.9340000e+3  1.9540000e+3 │ 1.8390000e+3  1.8590000e+3  ...  1.9390000e+3  1.9590000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                         │ ...                                                         │ ...                                                         │ ...                                                         ││
    ││axis 3│                                                             │                                                             │                                                             │                                                             ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6400000e+2  5.8400000e+2  ...  6.6400000e+2  6.8400000e+2 │ 5.6900000e+2  5.8900000e+2  ...  6.6900000e+2  6.8900000e+2 │ 5.7400000e+2  5.9400000e+2  ...  6.7400000e+2  6.9400000e+2 │ 5.7900000e+2  5.9900000e+2  ...  6.7900000e+2  6.9900000e+2 ││
    ││axis 3│ 1.4040000e+3  1.4240000e+3  ...  1.5040000e+3  1.5240000e+3 │ 1.4090000e+3  1.4290000e+3  ...  1.5090000e+3  1.5290000e+3 │ 1.4140000e+3  1.4340000e+3  ...  1.5140000e+3  1.5340000e+3 │ 1.4190000e+3  1.4390000e+3  ...  1.5190000e+3  1.5390000e+3 ││
    ││      │ 2.2440000e+3  2.2640000e+3  ...  2.3440000e+3  2.3640000e+3 │ 2.2490000e+3  2.2690000e+3  ...  2.3490000e+3  2.3690000e+3 │ 2.2540000e+3  2.2740000e+3  ...  2.3540000e+3  2.3740000e+3 │ 2.2590000e+3  2.2790000e+3  ...  2.3590000e+3  2.3790000e+3 ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0400000e+2  7.2400000e+2  ...  8.0400000e+2  8.2400000e+2 │ 7.0900000e+2  7.2900000e+2  ...  8.0900000e+2  8.2900000e+2 │ 7.1400000e+2  7.3400000e+2  ...  8.1400000e+2  8.3400000e+2 │ 7.1900000e+2  7.3900000e+2  ...  8.1900000e+2  8.3900000e+2 ││
    ││axis 3│ 1.5440000e+3  1.5640000e+3  ...  1.6440000e+3  1.6640000e+3 │ 1.5490000e+3  1.5690000e+3  ...  1.6490000e+3  1.6690000e+3 │ 1.5540000e+3  1.5740000e+3  ...  1.6540000e+3  1.6740000e+3 │ 1.5590000e+3  1.5790000e+3  ...  1.6590000e+3  1.6790000e+3 ││
    ││      │ 2.3840000e+3  2.4040000e+3  ...  2.4840000e+3  2.5040000e+3 │ 2.3890000e+3  2.4090000e+3  ...  2.4890000e+3  2.5090000e+3 │ 2.3940000e+3  2.4140000e+3  ...  2.4940000e+3  2.5140000e+3 │ 2.3990000e+3  2.4190000e+3  ...  2.4990000e+3  2.5190000e+3 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let%op ho4 = hey2 ++ "...b|...i->...o => i|o->b" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:5|2:7->1:3                                                                                                                                                                                                                                                                                                │
    │┌──────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                        │1 @ 0                                                        │2 @ 0                                                        │3 @ 0                                                        │4 @ 0                                                        ││
    ││      │axis 2                                                       │axis 2                                                       │axis 2                                                       │axis 2                                                       │axis 2                                                       ││
    │├──────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────┤│
    ││axis 1│ 7.7640000e+4  7.8600000e+4  ...  8.2440000e+4  8.3400000e+4 │ 7.7688000e+4  7.8648000e+4  ...  8.2488000e+4  8.3448000e+4 │ 7.7736000e+4  7.8696000e+4  ...  8.2536000e+4  8.3496000e+4 │ 7.7784000e+4  7.8744000e+4  ...  8.2584000e+4  8.3544000e+4 │ 7.7832000e+4  7.8792000e+4  ...  8.2632000e+4  8.3592000e+4 ││
    ││      │ 1.1796000e+5  1.1892000e+5  ...  1.2276000e+5  1.2372000e+5 │ 1.1800800e+5  1.1896800e+5  ...  1.2280800e+5  1.2376800e+5 │ 1.1805600e+5  1.1901600e+5  ...  1.2285600e+5  1.2381600e+5 │ 1.1810400e+5  1.1906400e+5  ...  1.2290400e+5  1.2386400e+5 │ 1.1815200e+5  1.1911200e+5  ...  1.2295200e+5  1.2391200e+5 ││
    ││      │ 1.5828000e+5  1.5924000e+5  ...  1.6308000e+5  1.6404000e+5 │ 1.5832800e+5  1.5928800e+5  ...  1.6312800e+5  1.6408800e+5 │ 1.5837600e+5  1.5933600e+5  ...  1.6317600e+5  1.6413600e+5 │ 1.5842400e+5  1.5938400e+5  ...  1.6322400e+5  1.6418400e+5 │ 1.5847200e+5  1.5943200e+5  ...  1.6327200e+5  1.6423200e+5 ││
    │└──────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho5 = hey ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho5;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho5;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────┐
    │[6]: =>_ho5 shape 0:4                                      │
    │┌┬────────────────────────────────────────────────────────┐│
    │││axis 0                                                  ││
    │├┼────────────────────────────────────────────────────────┤│
    │││ 4.2000000e+1  6.0000000e+1  7.8000000e+1  9.6000000e+1 ││
    │└┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────┘
    |}];
  let hey3 = TDSL.range_of_shape ~output_dims:[ 3; 4 ] () in
  let%op ho6 = hey3 ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho6;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey3;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────┐
    │[7]: r3x4 shape 0:3,1:4                                    │
    │┌──────┬──────────────────────────────────────────────────┐│
    ││      │axis 1                                            ││
    │├──────┼──────────────────────────────────────────────────┤│
    ││axis 0│ 0.0000000  1.0000000  2.0000000     3.0000000    ││
    ││      │ 4.0000000  5.0000000  6.0000000     7.0000000    ││
    ││      │ 8.0000000  9.0000000  1.0000000e+1  1.1000000e+1 ││
    │└──────┴──────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho6;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────┐
    │[8]: =>_ho6 shape 0:4                                      │
    │┌┬────────────────────────────────────────────────────────┐│
    │││axis 0                                                  ││
    │├┼────────────────────────────────────────────────────────┤│
    │││ 1.2000000e+1  1.5000000e+1  1.8000000e+1  2.1000000e+1 ││
    │└┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let hey4 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3; 4 ] () in
  let%op ho7 = hey4 ++ "i->...o => ...io" in
  Train.forward_and_forget backend ctx ho7;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey4;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────────────────────┐
    │[9]: r3x4x2 shape 2:2->0:3,1:4                                                           │
    │┌──────┬──────────────────────┬────────────────────────────┬────────────────────────────┐│
    ││      │0 @ 0                 │1 @ 0                       │2 @ 0                       ││
    ││      │axis 2                │axis 2                      │axis 2                      ││
    │├──────┼──────────────────────┼────────────────────────────┼────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000 │ 8.0000000     9.0000000    │ 1.6000000e+1  1.7000000e+1 ││
    ││      │ 2.0000000  3.0000000 │ 1.0000000e+1  1.1000000e+1 │ 1.8000000e+1  1.9000000e+1 ││
    ││      │ 4.0000000  5.0000000 │ 1.2000000e+1  1.3000000e+1 │ 2.0000000e+1  2.1000000e+1 ││
    ││      │ 6.0000000  7.0000000 │ 1.4000000e+1  1.5000000e+1 │ 2.2000000e+1  2.3000000e+1 ││
    │└──────┴──────────────────────┴────────────────────────────┴────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho7;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────┐
    │[10]: =>_ho7 shape 0:3,1:2,2:4                                   │
    │┌──────┬────────────────────────────────────────────────────────┐│
    ││      │axis 2                                                  ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││0 @ 0 │ 0.0000000  2.0000000  4.0000000  6.0000000             ││
    ││axis 1│ 1.0000000  3.0000000  5.0000000  7.0000000             ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││1 @ 0 │ 8.0000000  1.0000000e+1  1.2000000e+1  1.4000000e+1    ││
    ││axis 1│ 9.0000000  1.1000000e+1  1.3000000e+1  1.5000000e+1    ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││2 @ 0 │ 1.6000000e+1  1.8000000e+1  2.0000000e+1  2.2000000e+1 ││
    ││axis 1│ 1.7000000e+1  1.9000000e+1  2.1000000e+1  2.3000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->...; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                                                                                         │
    │┌──────┬────────────────────────────────────────────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                       │1 @ 0                                                   │2 @ 0                                                   ││
    ││      │axis 2                                      │axis 2                                                  │axis 2                                                  ││
    │├──────┼────────────────────────────────────────────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000  2.0000000  3.0000000 │ 8.0000000     9.0000000     1.0000000e+1  1.1000000e+1 │ 1.6000000e+1  1.7000000e+1  1.8000000e+1  1.9000000e+1 ││
    ││      │ 4.0000000  5.0000000  6.0000000  7.0000000 │ 1.2000000e+1  1.3000000e+1  1.4000000e+1  1.5000000e+1 │ 2.0000000e+1  2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴────────────────────────────────────────────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4                 │
    │┌──────┬───────────┬───────────┬──────────────┐│
    ││      │0 @ 0      │1 @ 0      │2 @ 0         ││
    ││      │axis 2     │axis 2     │axis 2        ││
    │├──────┼───────────┼───────────┼──────────────┤│
    ││axis 1│ 0.0000000 │ 4.0000000 │ 8.0000000    ││
    ││      │ 1.0000000 │ 5.0000000 │ 9.0000000    ││
    ││      │ 2.0000000 │ 6.0000000 │ 1.0000000e+1 ││
    ││      │ 3.0000000 │ 7.0000000 │ 1.1000000e+1 ││
    │└──────┴───────────┴───────────┴──────────────┘│
    └───────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                                         │
    │┌──────┬────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                  ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││axis 0│ 0.0000000     6.0000000     1.6000000e+1  3.0000000e+1 ││
    ││      │ 8.0000000e+1  1.1000000e+2  1.4400000e+2  1.8200000e+2 ││
    ││      │ 2.8800000e+2  3.4200000e+2  4.0000000e+2  4.6200000e+2 ││
    │└──────┴────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let d = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let e = TDSL.range_of_shape ~input_dims:[ 4 ] ~output_dims:[ 3 ] () in
  let%op f = d *+ "i->...;j->... => ...ij" e in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌───────────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3       │
    │┌──────┬──────────────────────┐│
    ││      │axis 1                ││
    │├──────┼──────────────────────┤│
    ││axis 0│ 0.0000000  1.0000000 ││
    ││      │ 2.0000000  3.0000000 ││
    ││      │ 4.0000000  5.0000000 ││
    │└──────┴──────────────────────┘│
    └───────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────┐
    │[4]: r3x4 shape 1:4->0:3                                   │
    │┌──────┬──────────────────────────────────────────────────┐│
    ││      │axis 1                                            ││
    │├──────┼──────────────────────────────────────────────────┤│
    ││axis 0│ 0.0000000  1.0000000  2.0000000     3.0000000    ││
    ││      │ 4.0000000  5.0000000  6.0000000     7.0000000    ││
    ││      │ 8.0000000  9.0000000  1.0000000e+1  1.1000000e+1 ││
    │└──────┴──────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────┐
    │[5]: ;=>_f shape 0:3,1:2,2:4                                     │
    │┌──────┬────────────────────────────────────────────────────────┐│
    ││      │axis 2                                                  ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││0 @ 0 │ 0.0000000  0.0000000  0.0000000  0.0000000             ││
    ││axis 1│ 0.0000000  1.0000000  2.0000000  3.0000000             ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││1 @ 0 │ 8.0000000     1.0000000e+1  1.2000000e+1  1.4000000e+1 ││
    ││axis 1│ 1.2000000e+1  1.5000000e+1  1.8000000e+1  2.1000000e+1 ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││2 @ 0 │ 3.2000000e+1  3.6000000e+1  4.0000000e+1  4.4000000e+1 ││
    ││axis 1│ 4.0000000e+1  4.5000000e+1  5.0000000e+1  5.5000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 fixed dim axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|1->... => ...|..." in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:4                                         │
    │┌──────┬────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                  ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││axis 0│ 1.0000000     4.0000000     7.0000000     1.0000000e+1 ││
    ││      │ 1.3000000e+1  1.6000000e+1  1.9000000e+1  2.2000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "...|...->... => ...|...->0" in
  let ctx = Train.forward_and_ctx backend ctx ho2 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                             │
    │┌──────┬───────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                     ││
    ││      │axis 2                                 │axis 2                                    ││
    │├──────┼───────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000     2.0000000    │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 ││
    ││      │ 3.0000000  4.0000000     5.0000000    │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 6.0000000  7.0000000     8.0000000    │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 ││
    ││      │ 9.0000000  1.0000000e+1  1.1000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴───────────────────────────────────────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:2|2:3->1:1                                                                │
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││      │0 @ 0                                     │1 @ 0                                     ││
    ││      │axis 2                                    │axis 2                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 1.8000000e+1  2.2000000e+1  2.6000000e+1 │ 6.6000000e+1  7.0000000e+1  7.4000000e+1 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let%op ho3 = hey2 ++ "...|...->... => 0" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌───────────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3       │
    │┌──────┬──────────────────────┐│
    ││      │axis 1                ││
    │├──────┼──────────────────────┤│
    ││axis 0│ 0.0000000  1.0000000 ││
    ││      │ 2.0000000  3.0000000 ││
    ││      │ 4.0000000  5.0000000 ││
    │└──────┴──────────────────────┘│
    └───────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌──────────────────────┐
    │[4]: =>_ho3 shape 0:1 │
    │┌┬──────────────┐     │
    │││axis 0        │     │
    │├┼──────────────┤     │
    │││ 1.5000000e+1 │     │
    │└┴──────────────┘     │
    └──────────────────────┘
    |}];
  let%op ho4 = hey2 ++ "i->j => i0j" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌──────────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:2,1:1,2:3             │
    │┌──────┬─────────────────────────────────┐│
    ││      │axis 2                           ││
    │├──────┼─────────────────────────────────┤│
    ││0 @ 0 │ 0.0000000  2.0000000  4.0000000 ││
    ││axis 1│                                 ││
    │├──────┼─────────────────────────────────┤│
    ││1 @ 0 │ 1.0000000  3.0000000  5.0000000 ││
    ││axis 1│                                 ││
    │└──────┴─────────────────────────────────┘│
    └──────────────────────────────────────────┘
    |}]

let%expect_test "einsum with fixed dim axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->1; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                                                                                         │
    │┌──────┬────────────────────────────────────────────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                       │1 @ 0                                                   │2 @ 0                                                   ││
    ││      │axis 2                                      │axis 2                                                  │axis 2                                                  ││
    │├──────┼────────────────────────────────────────────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000  2.0000000  3.0000000 │ 8.0000000     9.0000000     1.0000000e+1  1.1000000e+1 │ 1.6000000e+1  1.7000000e+1  1.8000000e+1  1.9000000e+1 ││
    ││      │ 4.0000000  5.0000000  6.0000000  7.0000000 │ 1.2000000e+1  1.3000000e+1  1.4000000e+1  1.5000000e+1 │ 2.0000000e+1  2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴────────────────────────────────────────────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4                 │
    │┌──────┬───────────┬───────────┬──────────────┐│
    ││      │0 @ 0      │1 @ 0      │2 @ 0         ││
    ││      │axis 2     │axis 2     │axis 2        ││
    │├──────┼───────────┼───────────┼──────────────┤│
    ││axis 1│ 0.0000000 │ 4.0000000 │ 8.0000000    ││
    ││      │ 1.0000000 │ 5.0000000 │ 9.0000000    ││
    ││      │ 2.0000000 │ 6.0000000 │ 1.0000000e+1 ││
    ││      │ 3.0000000 │ 7.0000000 │ 1.1000000e+1 ││
    │└──────┴───────────┴───────────┴──────────────┘│
    └───────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                                         │
    │┌──────┬────────────────────────────────────────────────────────┐│
    ││      │axis 1                                                  ││
    │├──────┼────────────────────────────────────────────────────────┤│
    ││axis 0│ 0.0000000     5.0000000     1.2000000e+1  2.1000000e+1 ││
    ││      │ 4.8000000e+1  6.5000000e+1  8.4000000e+1  1.0500000e+2 ││
    ││      │ 1.6000000e+2  1.8900000e+2  2.2000000e+2  2.5300000e+2 ││
    │└──────┴────────────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "outer_sum simulating axis concatenation" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let ri = TDSL.range 3 in
  let%op ti = ri ++ "i=>i0" in
  (* Write position 2 of ti, otherwise shape inference concludes it's dim-1 and broadcasted. *)
  let%cd _ = ti =: 0 ++ "i=>i2" in
  let rj = TDSL.range 4 in
  let%op tj = rj ++ "j=>j1" in
  let rk = TDSL.range 5 in
  let%op tk = rk ++ "k=>k2" in
  let positions = TDSL.outer_sum "ijl;kl=>ijkl" (TDSL.outer_sum "il;jl=>ijl" ti tj) tk in
  Train.set_hosted tk.value;
  Train.forward_and_forget backend ctx positions;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ positions;
  [%expect
    {|
    ┌──────────────────────────────────────────┐
    │[9]: ;=>+ shape 0:4,1:5,2:6,3:3           │
    │┌──────┬─────────────────────────────────┐│
    ││0 @ 0 │axis 3                           ││
    │├──────┼─────────────────────────────────┤│
    ││0 @ 1 │ 0.0000000  0.0000000  0.0000000 ││
    ││axis 2│ 0.0000000  0.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 0.0000000  0.0000000  4.0000000 ││
    ││      │ 0.0000000  0.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││1 @ 1 │ 0.0000000  1.0000000  0.0000000 ││
    ││axis 2│ 0.0000000  1.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 0.0000000  1.0000000  4.0000000 ││
    ││      │ 0.0000000  1.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││2 @ 1 │ 0.0000000  2.0000000  0.0000000 ││
    ││axis 2│ 0.0000000  2.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 0.0000000  2.0000000  4.0000000 ││
    ││      │ 0.0000000  2.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││3 @ 1 │ 0.0000000  3.0000000  0.0000000 ││
    ││axis 2│ 0.0000000  3.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 0.0000000  3.0000000  4.0000000 ││
    ││      │ 0.0000000  3.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││4 @ 1 │ 0.0000000  4.0000000  0.0000000 ││
    ││axis 2│ 0.0000000  4.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 0.0000000  4.0000000  4.0000000 ││
    ││      │ 0.0000000  4.0000000  5.0000000 ││
    │└──────┴─────────────────────────────────┘│
    ├──────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────┐│
    ││1 @ 0 │axis 3                           ││
    │├──────┼─────────────────────────────────┤│
    ││0 @ 1 │ 1.0000000  0.0000000  0.0000000 ││
    ││axis 2│ 1.0000000  0.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 1.0000000  0.0000000  4.0000000 ││
    ││      │ 1.0000000  0.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││1 @ 1 │ 1.0000000  1.0000000  0.0000000 ││
    ││axis 2│ 1.0000000  1.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 1.0000000  1.0000000  4.0000000 ││
    ││      │ 1.0000000  1.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││2 @ 1 │ 1.0000000  2.0000000  0.0000000 ││
    ││axis 2│ 1.0000000  2.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 1.0000000  2.0000000  4.0000000 ││
    ││      │ 1.0000000  2.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││3 @ 1 │ 1.0000000  3.0000000  0.0000000 ││
    ││axis 2│ 1.0000000  3.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 1.0000000  3.0000000  4.0000000 ││
    ││      │ 1.0000000  3.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││4 @ 1 │ 1.0000000  4.0000000  0.0000000 ││
    ││axis 2│ 1.0000000  4.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 1.0000000  4.0000000  4.0000000 ││
    ││      │ 1.0000000  4.0000000  5.0000000 ││
    │└──────┴─────────────────────────────────┘│
    ├──────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────┐│
    ││2 @ 0 │axis 3                           ││
    │├──────┼─────────────────────────────────┤│
    ││0 @ 1 │ 2.0000000  0.0000000  0.0000000 ││
    ││axis 2│ 2.0000000  0.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 2.0000000  0.0000000  4.0000000 ││
    ││      │ 2.0000000  0.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││1 @ 1 │ 2.0000000  1.0000000  0.0000000 ││
    ││axis 2│ 2.0000000  1.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 2.0000000  1.0000000  4.0000000 ││
    ││      │ 2.0000000  1.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││2 @ 1 │ 2.0000000  2.0000000  0.0000000 ││
    ││axis 2│ 2.0000000  2.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 2.0000000  2.0000000  4.0000000 ││
    ││      │ 2.0000000  2.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││3 @ 1 │ 2.0000000  3.0000000  0.0000000 ││
    ││axis 2│ 2.0000000  3.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 2.0000000  3.0000000  4.0000000 ││
    ││      │ 2.0000000  3.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││4 @ 1 │ 2.0000000  4.0000000  0.0000000 ││
    ││axis 2│ 2.0000000  4.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 2.0000000  4.0000000  4.0000000 ││
    ││      │ 2.0000000  4.0000000  5.0000000 ││
    │└──────┴─────────────────────────────────┘│
    ├──────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────┐│
    ││3 @ 0 │axis 3                           ││
    │├──────┼─────────────────────────────────┤│
    ││0 @ 1 │ 3.0000000  0.0000000  0.0000000 ││
    ││axis 2│ 3.0000000  0.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 3.0000000  0.0000000  4.0000000 ││
    ││      │ 3.0000000  0.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││1 @ 1 │ 3.0000000  1.0000000  0.0000000 ││
    ││axis 2│ 3.0000000  1.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 3.0000000  1.0000000  4.0000000 ││
    ││      │ 3.0000000  1.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││2 @ 1 │ 3.0000000  2.0000000  0.0000000 ││
    ││axis 2│ 3.0000000  2.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 3.0000000  2.0000000  4.0000000 ││
    ││      │ 3.0000000  2.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││3 @ 1 │ 3.0000000  3.0000000  0.0000000 ││
    ││axis 2│ 3.0000000  3.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 3.0000000  3.0000000  4.0000000 ││
    ││      │ 3.0000000  3.0000000  5.0000000 ││
    │├──────┼─────────────────────────────────┤│
    ││4 @ 1 │ 3.0000000  4.0000000  0.0000000 ││
    ││axis 2│ 3.0000000  4.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 3.0000000  4.0000000  4.0000000 ││
    ││      │ 3.0000000  4.0000000  5.0000000 ││
    │└──────┴─────────────────────────────────┘│
    └──────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ti;
  [%expect
    {|
    ┌──────────────────────────────────────────┐
    │[1]: =>_ti shape 0:4,1:3                  │
    │┌──────┬─────────────────────────────────┐│
    ││      │axis 1                           ││
    │├──────┼─────────────────────────────────┤│
    ││axis 0│ 0.0000000  0.0000000  0.0000000 ││
    ││      │ 1.0000000  0.0000000  0.0000000 ││
    ││      │ 2.0000000  0.0000000  0.0000000 ││
    ││      │ 3.0000000  0.0000000  0.0000000 ││
    │└──────┴─────────────────────────────────┘│
    └──────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ tk;
  [%expect
    {|
    ┌──────────────────────────────────────────┐
    │[7]: =>_tk shape 0:6,1:3                  │
    │┌──────┬─────────────────────────────────┐│
    ││      │axis 1                           ││
    │├──────┼─────────────────────────────────┤│
    ││axis 0│ 0.0000000  0.0000000  0.0000000 ││
    ││      │ 0.0000000  0.0000000  1.0000000 ││
    ││      │ ...        ...        ...       ││
    ││      │ 0.0000000  0.0000000  4.0000000 ││
    ││      │ 0.0000000  0.0000000  5.0000000 ││
    │└──────┴─────────────────────────────────┘│
    └──────────────────────────────────────────┘
    |}]

let%expect_test "einsum with a leftmost input axis preserved as output axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a =
    TDSL.range_of_shape ~label:[ "a" ] ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] ()
  in
  let b =
    TDSL.range_of_shape ~label:[ "b" ] ~batch_dims:[ 3 ] ~input_dims:[ 2; 3 ] ~output_dims:[ 4 ] ()
  in
  let%op c = a *+ "...|i->1; ...|j...->i => ...|ij" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4_a shape 0:3|2:4->1:2                                                                                                                                       │
    │┌──────┬────────────────────────────────────────────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                       │1 @ 0                                                   │2 @ 0                                                   ││
    ││      │axis 2                                      │axis 2                                                  │axis 2                                                  ││
    │├──────┼────────────────────────────────────────────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.0000000  1.0000000  2.0000000  3.0000000 │ 8.0000000     9.0000000     1.0000000e+1  1.1000000e+1 │ 1.6000000e+1  1.7000000e+1  1.8000000e+1  1.9000000e+1 ││
    ││      │ 4.0000000  5.0000000  6.0000000  7.0000000 │ 1.2000000e+1  1.3000000e+1  1.4000000e+1  1.5000000e+1 │ 2.0000000e+1  2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴────────────────────────────────────────────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r3x4x2x3_b shape 0:3|2:2,3:3->1:4                                                        │
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││0 @ 0 │0 @ 2                                     │1 @ 2                                     ││
    ││      │axis 3                                    │axis 3                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 0.0000000     1.0000000     2.0000000    │ 3.0000000     4.0000000     5.0000000    ││
    ││      │ 6.0000000     7.0000000     8.0000000    │ 9.0000000     1.0000000e+1  1.1000000e+1 ││
    ││      │ 1.2000000e+1  1.3000000e+1  1.4000000e+1 │ 1.5000000e+1  1.6000000e+1  1.7000000e+1 ││
    ││      │ 1.8000000e+1  1.9000000e+1  2.0000000e+1 │ 2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││1 @ 0 │0 @ 2                                     │1 @ 2                                     ││
    ││      │axis 3                                    │axis 3                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 2.4000000e+1  2.5000000e+1  2.6000000e+1 │ 2.7000000e+1  2.8000000e+1  2.9000000e+1 ││
    ││      │ 3.0000000e+1  3.1000000e+1  3.2000000e+1 │ 3.3000000e+1  3.4000000e+1  3.5000000e+1 ││
    ││      │ 3.6000000e+1  3.7000000e+1  3.8000000e+1 │ 3.9000000e+1  4.0000000e+1  4.1000000e+1 ││
    ││      │ 4.2000000e+1  4.3000000e+1  4.4000000e+1 │ 4.5000000e+1  4.6000000e+1  4.7000000e+1 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬──────────────────────────────────────────┬──────────────────────────────────────────┐│
    ││2 @ 0 │0 @ 2                                     │1 @ 2                                     ││
    ││      │axis 3                                    │axis 3                                    ││
    │├──────┼──────────────────────────────────────────┼──────────────────────────────────────────┤│
    ││axis 1│ 4.8000000e+1  4.9000000e+1  5.0000000e+1 │ 5.1000000e+1  5.2000000e+1  5.3000000e+1 ││
    ││      │ 5.4000000e+1  5.5000000e+1  5.6000000e+1 │ 5.7000000e+1  5.8000000e+1  5.9000000e+1 ││
    ││      │ 6.0000000e+1  6.1000000e+1  6.2000000e+1 │ 6.3000000e+1  6.4000000e+1  6.5000000e+1 ││
    ││      │ 6.6000000e+1  6.7000000e+1  6.8000000e+1 │ 6.9000000e+1  7.0000000e+1  7.1000000e+1 ││
    │└──────┴──────────────────────────────────────────┴──────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4,2:2                                                                   │
    │┌──────┬────────────────────────────┬────────────────────────────┬────────────────────────────┐│
    ││      │0 @ 0                       │1 @ 0                       │2 @ 0                       ││
    ││      │axis 2                      │axis 2                      │axis 2                      ││
    │├──────┼────────────────────────────┼────────────────────────────┼────────────────────────────┤│
    ││axis 1│ 1.2000000e+1  4.8000000e+1 │ 9.0000000e+2  1.0080000e+3 │ 2.9400000e+3  3.1200000e+3 ││
    ││      │ 1.0500000e+2  1.5000000e+2 │ 1.2090000e+3  1.3260000e+3 │ 3.4650000e+3  3.6540000e+3 ││
    ││      │ 2.3400000e+2  2.8800000e+2 │ 1.5540000e+3  1.6800000e+3 │ 4.0260000e+3  4.2240000e+3 ││
    ││      │ 3.9900000e+2  4.6200000e+2 │ 1.9350000e+3  2.0700000e+3 │ 4.6230000e+3  4.8300000e+3 ││
    │└──────┴────────────────────────────┴────────────────────────────┴────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum permuting two leftmost input axes as output axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a = TDSL.range_of_shape ~label:[ "a" ] ~input_dims:[ 2 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~label:[ "b" ] ~input_dims:[ 2; 3; 4 ] ~output_dims:[ 2 ] () in
  let%op c = a *+ "i->1; ij...->0 => ...->ji" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────┐
    │[0]: r2x2_a shape 1:2->0:2     │
    │┌──────┬──────────────────────┐│
    ││      │axis 1                ││
    │├──────┼──────────────────────┤│
    ││axis 0│ 0.0000000  1.0000000 ││
    ││      │ 2.0000000  3.0000000 ││
    │└──────┴──────────────────────┘│
    └───────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r2x2x3x4_b shape 1:2,2:3,3:4->0:2                                                                                                                                             │
    │┌──────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┐│
    ││      │0 @ 2                                                   │1 @ 2                                                   │2 @ 2                                                   ││
    ││      │axis 3                                                  │axis 3                                                  │axis 3                                                  ││
    │├──────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││0 @ 1 │ 0.0000000     1.0000000     2.0000000     3.0000000    │ 4.0000000     5.0000000     6.0000000     7.0000000    │ 8.0000000     9.0000000     1.0000000e+1  1.1000000e+1 ││
    ││axis 0│ 2.4000000e+1  2.5000000e+1  2.6000000e+1  2.7000000e+1 │ 2.8000000e+1  2.9000000e+1  3.0000000e+1  3.1000000e+1 │ 3.2000000e+1  3.3000000e+1  3.4000000e+1  3.5000000e+1 ││
    │├──────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││1 @ 1 │ 1.2000000e+1  1.3000000e+1  1.4000000e+1  1.5000000e+1 │ 1.6000000e+1  1.7000000e+1  1.8000000e+1  1.9000000e+1 │ 2.0000000e+1  2.1000000e+1  2.2000000e+1  2.3000000e+1 ││
    ││axis 0│ 3.6000000e+1  3.7000000e+1  3.8000000e+1  3.9000000e+1 │ 4.0000000e+1  4.1000000e+1  4.2000000e+1  4.3000000e+1 │ 4.4000000e+1  4.5000000e+1  4.6000000e+1  4.7000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 2:4->0:3,1:2                                                                                                                                                      │
    │┌──────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                   │1 @ 0                                                   │2 @ 0                                                   ││
    ││      │axis 2                                                  │axis 2                                                  │axis 2                                                  ││
    │├──────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────┤│
    ││axis 1│ 0.0000000     2.0000000     4.0000000     6.0000000    │ 8.0000000     1.0000000e+1  1.2000000e+1  1.4000000e+1 │ 1.6000000e+1  1.8000000e+1  2.0000000e+1  2.2000000e+1 ││
    ││      │ 3.6000000e+1  3.9000000e+1  4.2000000e+1  4.5000000e+1 │ 4.8000000e+1  5.1000000e+1  5.4000000e+1  5.7000000e+1 │ 6.0000000e+1  6.3000000e+1  6.6000000e+1  6.9000000e+1 ││
    │└──────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
