open Base
open Ocannl

module FDSL = Operation.FDSL

let () = Session.SDSL.set_executor OCaml

let%expect_test "einsum1 permute axes" =
  let open Session.SDSL in
  drop_all_sessions();
  Random.init 0;
  let hey =
    FDSL.range_of_shape ~batch_dims:[2] ~input_dims:[3] ~output_dims:[4] () in
  let%nn_op ho = hey++"b|i->o => o|b->i" in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────┐
    │[1]: shape 0:2|2:3->1:4                                         │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 0.00e+0  1.00e+0  2.00e+0 │ 1.20e+1  1.30e+1  1.40e+1 ││
    ││      │ 3.00e+0  4.00e+0  5.00e+0 │ 1.50e+1  1.60e+1  1.70e+1 ││
    ││      │ 6.00e+0  7.00e+0  8.00e+0 │ 1.80e+1  1.90e+1  2.00e+1 ││
    ││      │ 9.00e+0  1.00e+1  1.10e+1 │ 2.10e+1  2.20e+1  2.30e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘ |} ];
  print_formula ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: shape 0:4|2:2->1:3                                                             │
    │┌──────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┐│
    ││      │0 @ 0             │1 @ 0             │2 @ 0             │3 @ 0             ││
    ││      │axis 2            │axis 2            │axis 2            │axis 2            ││
    │├──────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤│
    ││axis 1│ 0.00e+0  1.20e+1 │ 3.00e+0  1.50e+1 │ 6.00e+0  1.80e+1 │ 9.00e+0  2.10e+1 ││
    ││      │ 1.00e+0  1.30e+1 │ 4.00e+0  1.60e+1 │ 7.00e+0  1.90e+1 │ 1.00e+1  2.20e+1 ││
    ││      │ 2.00e+0  1.40e+1 │ 5.00e+0  1.70e+1 │ 8.00e+0  2.00e+1 │ 1.10e+1  2.30e+1 ││
    │└──────┴──────────────────┴──────────────────┴──────────────────┴──────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────┘ |} ];
    let hey2 =
      FDSL.range_of_shape ~batch_dims:[2;3] ~input_dims:[4;5] ~output_dims:[6;7] () in
    let%nn_op ho2 = hey2++"ab|cd->ef => cf|ae->db" in
    refresh_session ();
    print_formula ~with_code:false ~with_grad:false `Default @@ hey2;
    [%expect {|
      ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │[3]: shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                             │
      │┌──────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┐│
      ││0 @ 1 │0 @ 4                                        │1 @ 4                                        │2 @ 4                                        │3 @ 4                                        ││
      ││      │axis 5                                       │axis 5                                       │axis 5                                       │axis 5                                       ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││0 @ 2 │ 0.00e+0  1.00e+0  2.00e+0  3.00e+0  4.00e+0 │ 5.00e+0  6.00e+0  7.00e+0  8.00e+0  9.00e+0 │ 1.00e+1  1.10e+1  1.20e+1  1.30e+1  1.40e+1 │ 1.50e+1  1.60e+1  1.70e+1  1.80e+1  1.90e+1 ││
      ││axis 3│ 2.00e+1  2.10e+1  2.20e+1  2.30e+1  2.40e+1 │ 2.50e+1  2.60e+1  2.70e+1  2.80e+1  2.90e+1 │ 3.00e+1  3.10e+1  3.20e+1  3.30e+1  3.40e+1 │ 3.50e+1  3.60e+1  3.70e+1  3.80e+1  3.90e+1 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 1.00e+2  1.01e+2  1.02e+2  1.03e+2  1.04e+2 │ 1.05e+2  1.06e+2  1.07e+2  1.08e+2  1.09e+2 │ 1.10e+2  1.11e+2  1.12e+2  1.13e+2  1.14e+2 │ 1.15e+2  1.16e+2  1.17e+2  1.18e+2  1.19e+2 ││
      ││      │ 1.20e+2  1.21e+2  1.22e+2  1.23e+2  1.24e+2 │ 1.25e+2  1.26e+2  1.27e+2  1.28e+2  1.29e+2 │ 1.30e+2  1.31e+2  1.32e+2  1.33e+2  1.34e+2 │ 1.35e+2  1.36e+2  1.37e+2  1.38e+2  1.39e+2 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││1 @ 2 │ 1.40e+2  1.41e+2  1.42e+2  1.43e+2  1.44e+2 │ 1.45e+2  1.46e+2  1.47e+2  1.48e+2  1.49e+2 │ 1.50e+2  1.51e+2  1.52e+2  1.53e+2  1.54e+2 │ 1.55e+2  1.56e+2  1.57e+2  1.58e+2  1.59e+2 ││
      ││axis 3│ 1.60e+2  1.61e+2  1.62e+2  1.63e+2  1.64e+2 │ 1.65e+2  1.66e+2  1.67e+2  1.68e+2  1.69e+2 │ 1.70e+2  1.71e+2  1.72e+2  1.73e+2  1.74e+2 │ 1.75e+2  1.76e+2  1.77e+2  1.78e+2  1.79e+2 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 2.40e+2  2.41e+2  2.42e+2  2.43e+2  2.44e+2 │ 2.45e+2  2.46e+2  2.47e+2  2.48e+2  2.49e+2 │ 2.50e+2  2.51e+2  2.52e+2  2.53e+2  2.54e+2 │ 2.55e+2  2.56e+2  2.57e+2  2.58e+2  2.59e+2 ││
      ││      │ 2.60e+2  2.61e+2  2.62e+2  2.63e+2  2.64e+2 │ 2.65e+2  2.66e+2  2.67e+2  2.68e+2  2.69e+2 │ 2.70e+2  2.71e+2  2.72e+2  2.73e+2  2.74e+2 │ 2.75e+2  2.76e+2  2.77e+2  2.78e+2  2.79e+2 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││~~~~~ │ ...                                         │ ...                                         │ ...                                         │ ...                                         ││
      ││axis 3│                                             │                                             │                                             │                                             ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││4 @ 2 │ 5.60e+2  5.61e+2  5.62e+2  5.63e+2  5.64e+2 │ 5.65e+2  5.66e+2  5.67e+2  5.68e+2  5.69e+2 │ 5.70e+2  5.71e+2  5.72e+2  5.73e+2  5.74e+2 │ 5.75e+2  5.76e+2  5.77e+2  5.78e+2  5.79e+2 ││
      ││axis 3│ 5.80e+2  5.81e+2  5.82e+2  5.83e+2  5.84e+2 │ 5.85e+2  5.86e+2  5.87e+2  5.88e+2  5.89e+2 │ 5.90e+2  5.91e+2  5.92e+2  5.93e+2  5.94e+2 │ 5.95e+2  5.96e+2  5.97e+2  5.98e+2  5.99e+2 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 6.60e+2  6.61e+2  6.62e+2  6.63e+2  6.64e+2 │ 6.65e+2  6.66e+2  6.67e+2  6.68e+2  6.69e+2 │ 6.70e+2  6.71e+2  6.72e+2  6.73e+2  6.74e+2 │ 6.75e+2  6.76e+2  6.77e+2  6.78e+2  6.79e+2 ││
      ││      │ 6.80e+2  6.81e+2  6.82e+2  6.83e+2  6.84e+2 │ 6.85e+2  6.86e+2  6.87e+2  6.88e+2  6.89e+2 │ 6.90e+2  6.91e+2  6.92e+2  6.93e+2  6.94e+2 │ 6.95e+2  6.96e+2  6.97e+2  6.98e+2  6.99e+2 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││5 @ 2 │ 7.00e+2  7.01e+2  7.02e+2  7.03e+2  7.04e+2 │ 7.05e+2  7.06e+2  7.07e+2  7.08e+2  7.09e+2 │ 7.10e+2  7.11e+2  7.12e+2  7.13e+2  7.14e+2 │ 7.15e+2  7.16e+2  7.17e+2  7.18e+2  7.19e+2 ││
      ││axis 3│ 7.20e+2  7.21e+2  7.22e+2  7.23e+2  7.24e+2 │ 7.25e+2  7.26e+2  7.27e+2  7.28e+2  7.29e+2 │ 7.30e+2  7.31e+2  7.32e+2  7.33e+2  7.34e+2 │ 7.35e+2  7.36e+2  7.37e+2  7.38e+2  7.39e+2 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 8.00e+2  8.01e+2  8.02e+2  8.03e+2  8.04e+2 │ 8.05e+2  8.06e+2  8.07e+2  8.08e+2  8.09e+2 │ 8.10e+2  8.11e+2  8.12e+2  8.13e+2  8.14e+2 │ 8.15e+2  8.16e+2  8.17e+2  8.18e+2  8.19e+2 ││
      ││      │ 8.20e+2  8.21e+2  8.22e+2  8.23e+2  8.24e+2 │ 8.25e+2  8.26e+2  8.27e+2  8.28e+2  8.29e+2 │ 8.30e+2  8.31e+2  8.32e+2  8.33e+2  8.34e+2 │ 8.35e+2  8.36e+2  8.37e+2  8.38e+2  8.39e+2 ││
      │└──────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┘│
      ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┐│
      ││1 @ 1 │0 @ 4                                        │1 @ 4                                        │2 @ 4                                        │3 @ 4                                        ││
      ││      │axis 5                                       │axis 5                                       │axis 5                                       │axis 5                                       ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││0 @ 2 │ 8.40e+2  8.41e+2  8.42e+2  8.43e+2  8.44e+2 │ 8.45e+2  8.46e+2  8.47e+2  8.48e+2  8.49e+2 │ 8.50e+2  8.51e+2  8.52e+2  8.53e+2  8.54e+2 │ 8.55e+2  8.56e+2  8.57e+2  8.58e+2  8.59e+2 ││
      ││axis 3│ 8.60e+2  8.61e+2  8.62e+2  8.63e+2  8.64e+2 │ 8.65e+2  8.66e+2  8.67e+2  8.68e+2  8.69e+2 │ 8.70e+2  8.71e+2  8.72e+2  8.73e+2  8.74e+2 │ 8.75e+2  8.76e+2  8.77e+2  8.78e+2  8.79e+2 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 9.40e+2  9.41e+2  9.42e+2  9.43e+2  9.44e+2 │ 9.45e+2  9.46e+2  9.47e+2  9.48e+2  9.49e+2 │ 9.50e+2  9.51e+2  9.52e+2  9.53e+2  9.54e+2 │ 9.55e+2  9.56e+2  9.57e+2  9.58e+2  9.59e+2 ││
      ││      │ 9.60e+2  9.61e+2  9.62e+2  9.63e+2  9.64e+2 │ 9.65e+2  9.66e+2  9.67e+2  9.68e+2  9.69e+2 │ 9.70e+2  9.71e+2  9.72e+2  9.73e+2  9.74e+2 │ 9.75e+2  9.76e+2  9.77e+2  9.78e+2  9.79e+2 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││1 @ 2 │ 9.80e+2  9.81e+2  9.82e+2  9.83e+2  9.84e+2 │ 9.85e+2  9.86e+2  9.87e+2  9.88e+2  9.89e+2 │ 9.90e+2  9.91e+2  9.92e+2  9.93e+2  9.94e+2 │ 9.95e+2  9.96e+2  9.97e+2  9.98e+2  9.99e+2 ││
      ││axis 3│ 1.00e+3  1.00e+3  1.00e+3  1.00e+3  1.00e+3 │ 1.00e+3  1.01e+3  1.01e+3  1.01e+3  1.01e+3 │ 1.01e+3  1.01e+3  1.01e+3  1.01e+3  1.01e+3 │ 1.02e+3  1.02e+3  1.02e+3  1.02e+3  1.02e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 1.08e+3  1.08e+3  1.08e+3  1.08e+3  1.08e+3 │ 1.08e+3  1.09e+3  1.09e+3  1.09e+3  1.09e+3 │ 1.09e+3  1.09e+3  1.09e+3  1.09e+3  1.09e+3 │ 1.10e+3  1.10e+3  1.10e+3  1.10e+3  1.10e+3 ││
      ││      │ 1.10e+3  1.10e+3  1.10e+3  1.10e+3  1.10e+3 │ 1.10e+3  1.11e+3  1.11e+3  1.11e+3  1.11e+3 │ 1.11e+3  1.11e+3  1.11e+3  1.11e+3  1.11e+3 │ 1.12e+3  1.12e+3  1.12e+3  1.12e+3  1.12e+3 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││~~~~~ │ ...                                         │ ...                                         │ ...                                         │ ...                                         ││
      ││axis 3│                                             │                                             │                                             │                                             ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││4 @ 2 │ 1.40e+3  1.40e+3  1.40e+3  1.40e+3  1.40e+3 │ 1.40e+3  1.41e+3  1.41e+3  1.41e+3  1.41e+3 │ 1.41e+3  1.41e+3  1.41e+3  1.41e+3  1.41e+3 │ 1.42e+3  1.42e+3  1.42e+3  1.42e+3  1.42e+3 ││
      ││axis 3│ 1.42e+3  1.42e+3  1.42e+3  1.42e+3  1.42e+3 │ 1.42e+3  1.43e+3  1.43e+3  1.43e+3  1.43e+3 │ 1.43e+3  1.43e+3  1.43e+3  1.43e+3  1.43e+3 │ 1.44e+3  1.44e+3  1.44e+3  1.44e+3  1.44e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 1.50e+3  1.50e+3  1.50e+3  1.50e+3  1.50e+3 │ 1.50e+3  1.51e+3  1.51e+3  1.51e+3  1.51e+3 │ 1.51e+3  1.51e+3  1.51e+3  1.51e+3  1.51e+3 │ 1.52e+3  1.52e+3  1.52e+3  1.52e+3  1.52e+3 ││
      ││      │ 1.52e+3  1.52e+3  1.52e+3  1.52e+3  1.52e+3 │ 1.52e+3  1.53e+3  1.53e+3  1.53e+3  1.53e+3 │ 1.53e+3  1.53e+3  1.53e+3  1.53e+3  1.53e+3 │ 1.54e+3  1.54e+3  1.54e+3  1.54e+3  1.54e+3 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││5 @ 2 │ 1.54e+3  1.54e+3  1.54e+3  1.54e+3  1.54e+3 │ 1.54e+3  1.55e+3  1.55e+3  1.55e+3  1.55e+3 │ 1.55e+3  1.55e+3  1.55e+3  1.55e+3  1.55e+3 │ 1.56e+3  1.56e+3  1.56e+3  1.56e+3  1.56e+3 ││
      ││axis 3│ 1.56e+3  1.56e+3  1.56e+3  1.56e+3  1.56e+3 │ 1.56e+3  1.57e+3  1.57e+3  1.57e+3  1.57e+3 │ 1.57e+3  1.57e+3  1.57e+3  1.57e+3  1.57e+3 │ 1.58e+3  1.58e+3  1.58e+3  1.58e+3  1.58e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 1.64e+3  1.64e+3  1.64e+3  1.64e+3  1.64e+3 │ 1.64e+3  1.65e+3  1.65e+3  1.65e+3  1.65e+3 │ 1.65e+3  1.65e+3  1.65e+3  1.65e+3  1.65e+3 │ 1.66e+3  1.66e+3  1.66e+3  1.66e+3  1.66e+3 ││
      ││      │ 1.66e+3  1.66e+3  1.66e+3  1.66e+3  1.66e+3 │ 1.66e+3  1.67e+3  1.67e+3  1.67e+3  1.67e+3 │ 1.67e+3  1.67e+3  1.67e+3  1.67e+3  1.67e+3 │ 1.68e+3  1.68e+3  1.68e+3  1.68e+3  1.68e+3 ││
      │└──────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┘│
      ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┐│
      ││2 @ 1 │0 @ 4                                        │1 @ 4                                        │2 @ 4                                        │3 @ 4                                        ││
      ││      │axis 5                                       │axis 5                                       │axis 5                                       │axis 5                                       ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││0 @ 2 │ 1.68e+3  1.68e+3  1.68e+3  1.68e+3  1.68e+3 │ 1.68e+3  1.69e+3  1.69e+3  1.69e+3  1.69e+3 │ 1.69e+3  1.69e+3  1.69e+3  1.69e+3  1.69e+3 │ 1.70e+3  1.70e+3  1.70e+3  1.70e+3  1.70e+3 ││
      ││axis 3│ 1.70e+3  1.70e+3  1.70e+3  1.70e+3  1.70e+3 │ 1.70e+3  1.71e+3  1.71e+3  1.71e+3  1.71e+3 │ 1.71e+3  1.71e+3  1.71e+3  1.71e+3  1.71e+3 │ 1.72e+3  1.72e+3  1.72e+3  1.72e+3  1.72e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 1.78e+3  1.78e+3  1.78e+3  1.78e+3  1.78e+3 │ 1.78e+3  1.79e+3  1.79e+3  1.79e+3  1.79e+3 │ 1.79e+3  1.79e+3  1.79e+3  1.79e+3  1.79e+3 │ 1.80e+3  1.80e+3  1.80e+3  1.80e+3  1.80e+3 ││
      ││      │ 1.80e+3  1.80e+3  1.80e+3  1.80e+3  1.80e+3 │ 1.80e+3  1.81e+3  1.81e+3  1.81e+3  1.81e+3 │ 1.81e+3  1.81e+3  1.81e+3  1.81e+3  1.81e+3 │ 1.82e+3  1.82e+3  1.82e+3  1.82e+3  1.82e+3 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││1 @ 2 │ 1.82e+3  1.82e+3  1.82e+3  1.82e+3  1.82e+3 │ 1.82e+3  1.83e+3  1.83e+3  1.83e+3  1.83e+3 │ 1.83e+3  1.83e+3  1.83e+3  1.83e+3  1.83e+3 │ 1.84e+3  1.84e+3  1.84e+3  1.84e+3  1.84e+3 ││
      ││axis 3│ 1.84e+3  1.84e+3  1.84e+3  1.84e+3  1.84e+3 │ 1.84e+3  1.85e+3  1.85e+3  1.85e+3  1.85e+3 │ 1.85e+3  1.85e+3  1.85e+3  1.85e+3  1.85e+3 │ 1.86e+3  1.86e+3  1.86e+3  1.86e+3  1.86e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 1.92e+3  1.92e+3  1.92e+3  1.92e+3  1.92e+3 │ 1.92e+3  1.93e+3  1.93e+3  1.93e+3  1.93e+3 │ 1.93e+3  1.93e+3  1.93e+3  1.93e+3  1.93e+3 │ 1.94e+3  1.94e+3  1.94e+3  1.94e+3  1.94e+3 ││
      ││      │ 1.94e+3  1.94e+3  1.94e+3  1.94e+3  1.94e+3 │ 1.94e+3  1.95e+3  1.95e+3  1.95e+3  1.95e+3 │ 1.95e+3  1.95e+3  1.95e+3  1.95e+3  1.95e+3 │ 1.96e+3  1.96e+3  1.96e+3  1.96e+3  1.96e+3 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││~~~~~ │ ...                                         │ ...                                         │ ...                                         │ ...                                         ││
      ││axis 3│                                             │                                             │                                             │                                             ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││4 @ 2 │ 2.24e+3  2.24e+3  2.24e+3  2.24e+3  2.24e+3 │ 2.24e+3  2.25e+3  2.25e+3  2.25e+3  2.25e+3 │ 2.25e+3  2.25e+3  2.25e+3  2.25e+3  2.25e+3 │ 2.26e+3  2.26e+3  2.26e+3  2.26e+3  2.26e+3 ││
      ││axis 3│ 2.26e+3  2.26e+3  2.26e+3  2.26e+3  2.26e+3 │ 2.26e+3  2.27e+3  2.27e+3  2.27e+3  2.27e+3 │ 2.27e+3  2.27e+3  2.27e+3  2.27e+3  2.27e+3 │ 2.28e+3  2.28e+3  2.28e+3  2.28e+3  2.28e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 2.34e+3  2.34e+3  2.34e+3  2.34e+3  2.34e+3 │ 2.34e+3  2.35e+3  2.35e+3  2.35e+3  2.35e+3 │ 2.35e+3  2.35e+3  2.35e+3  2.35e+3  2.35e+3 │ 2.36e+3  2.36e+3  2.36e+3  2.36e+3  2.36e+3 ││
      ││      │ 2.36e+3  2.36e+3  2.36e+3  2.36e+3  2.36e+3 │ 2.36e+3  2.37e+3  2.37e+3  2.37e+3  2.37e+3 │ 2.37e+3  2.37e+3  2.37e+3  2.37e+3  2.37e+3 │ 2.38e+3  2.38e+3  2.38e+3  2.38e+3  2.38e+3 ││
      │├──────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┼─────────────────────────────────────────────┤│
      ││5 @ 2 │ 2.38e+3  2.38e+3  2.38e+3  2.38e+3  2.38e+3 │ 2.38e+3  2.39e+3  2.39e+3  2.39e+3  2.39e+3 │ 2.39e+3  2.39e+3  2.39e+3  2.39e+3  2.39e+3 │ 2.40e+3  2.40e+3  2.40e+3  2.40e+3  2.40e+3 ││
      ││axis 3│ 2.40e+3  2.40e+3  2.40e+3  2.40e+3  2.40e+3 │ 2.40e+3  2.41e+3  2.41e+3  2.41e+3  2.41e+3 │ 2.41e+3  2.41e+3  2.41e+3  2.41e+3  2.41e+3 │ 2.42e+3  2.42e+3  2.42e+3  2.42e+3  2.42e+3 ││
      ││      │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     │ ...      ...      ...      ...      ...     ││
      ││      │ 2.48e+3  2.48e+3  2.48e+3  2.48e+3  2.48e+3 │ 2.48e+3  2.49e+3  2.49e+3  2.49e+3  2.49e+3 │ 2.49e+3  2.49e+3  2.49e+3  2.49e+3  2.49e+3 │ 2.50e+3  2.50e+3  2.50e+3  2.50e+3  2.50e+3 ││
      ││      │ 2.50e+3  2.50e+3  2.50e+3  2.50e+3  2.50e+3 │ 2.50e+3  2.51e+3  2.51e+3  2.51e+3  2.51e+3 │ 2.51e+3  2.51e+3  2.51e+3  2.51e+3  2.51e+3 │ 2.52e+3  2.52e+3  2.52e+3  2.52e+3  2.52e+3 ││
      │└──────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┴─────────────────────────────────────────────┘│
      └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |} ];
    print_formula ~with_code:false ~with_grad:false `Default @@ ho2;
    [%expect {|
      ┌────────────────────────────────────────────────────────────────────────────────────────────┐
      │[4]: shape 0:4,1:7|4:2,5:6->2:5,3:3                                                         │
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││0 @ 1 │0 @ 4                                    │1 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 2 │ 0.00e+0  1.40e+2  ...  5.60e+2  7.00e+2 │ 2.52e+3  2.66e+3  ...  3.08e+3  3.22e+3 ││
      ││axis 3│ 8.40e+2  9.80e+2  ...  1.40e+3  1.54e+3 │ 3.36e+3  3.50e+3  ...  3.92e+3  4.06e+3 ││
      ││      │ 1.68e+3  1.82e+3  ...  2.24e+3  2.38e+3 │ 4.20e+3  4.34e+3  ...  4.76e+3  4.90e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 2 │ 1.00e+0  1.41e+2  ...  5.61e+2  7.01e+2 │ 2.52e+3  2.66e+3  ...  3.08e+3  3.22e+3 ││
      ││axis 3│ 8.41e+2  9.81e+2  ...  1.40e+3  1.54e+3 │ 3.36e+3  3.50e+3  ...  3.92e+3  4.06e+3 ││
      ││      │ 1.68e+3  1.82e+3  ...  2.24e+3  2.38e+3 │ 4.20e+3  4.34e+3  ...  4.76e+3  4.90e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││2 @ 2 │ 2.00e+0  1.42e+2  ...  5.62e+2  7.02e+2 │ 2.52e+3  2.66e+3  ...  3.08e+3  3.22e+3 ││
      ││axis 3│ 8.42e+2  9.82e+2  ...  1.40e+3  1.54e+3 │ 3.36e+3  3.50e+3  ...  3.92e+3  4.06e+3 ││
      ││      │ 1.68e+3  1.82e+3  ...  2.24e+3  2.38e+3 │ 4.20e+3  4.34e+3  ...  4.76e+3  4.90e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││3 @ 2 │ 3.00e+0  1.43e+2  ...  5.63e+2  7.03e+2 │ 2.52e+3  2.66e+3  ...  3.08e+3  3.22e+3 ││
      ││axis 3│ 8.43e+2  9.83e+2  ...  1.40e+3  1.54e+3 │ 3.36e+3  3.50e+3  ...  3.92e+3  4.06e+3 ││
      ││      │ 1.68e+3  1.82e+3  ...  2.24e+3  2.38e+3 │ 4.20e+3  4.34e+3  ...  4.76e+3  4.90e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││4 @ 2 │ 4.00e+0  1.44e+2  ...  5.64e+2  7.04e+2 │ 2.52e+3  2.66e+3  ...  3.08e+3  3.22e+3 ││
      ││axis 3│ 8.44e+2  9.84e+2  ...  1.40e+3  1.54e+3 │ 3.36e+3  3.50e+3  ...  3.92e+3  4.06e+3 ││
      ││      │ 1.68e+3  1.82e+3  ...  2.24e+3  2.38e+3 │ 4.20e+3  4.34e+3  ...  4.76e+3  4.90e+3 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││1 @ 1 │0 @ 4                                    │1 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 2 │ 2.00e+1  1.60e+2  ...  5.80e+2  7.20e+2 │ 2.54e+3  2.68e+3  ...  3.10e+3  3.24e+3 ││
      ││axis 3│ 8.60e+2  1.00e+3  ...  1.42e+3  1.56e+3 │ 3.38e+3  3.52e+3  ...  3.94e+3  4.08e+3 ││
      ││      │ 1.70e+3  1.84e+3  ...  2.26e+3  2.40e+3 │ 4.22e+3  4.36e+3  ...  4.78e+3  4.92e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 2 │ 2.10e+1  1.61e+2  ...  5.81e+2  7.21e+2 │ 2.54e+3  2.68e+3  ...  3.10e+3  3.24e+3 ││
      ││axis 3│ 8.61e+2  1.00e+3  ...  1.42e+3  1.56e+3 │ 3.38e+3  3.52e+3  ...  3.94e+3  4.08e+3 ││
      ││      │ 1.70e+3  1.84e+3  ...  2.26e+3  2.40e+3 │ 4.22e+3  4.36e+3  ...  4.78e+3  4.92e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││2 @ 2 │ 2.20e+1  1.62e+2  ...  5.82e+2  7.22e+2 │ 2.54e+3  2.68e+3  ...  3.10e+3  3.24e+3 ││
      ││axis 3│ 8.62e+2  1.00e+3  ...  1.42e+3  1.56e+3 │ 3.38e+3  3.52e+3  ...  3.94e+3  4.08e+3 ││
      ││      │ 1.70e+3  1.84e+3  ...  2.26e+3  2.40e+3 │ 4.22e+3  4.36e+3  ...  4.78e+3  4.92e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││3 @ 2 │ 2.30e+1  1.63e+2  ...  5.83e+2  7.23e+2 │ 2.54e+3  2.68e+3  ...  3.10e+3  3.24e+3 ││
      ││axis 3│ 8.63e+2  1.00e+3  ...  1.42e+3  1.56e+3 │ 3.38e+3  3.52e+3  ...  3.94e+3  4.08e+3 ││
      ││      │ 1.70e+3  1.84e+3  ...  2.26e+3  2.40e+3 │ 4.22e+3  4.36e+3  ...  4.78e+3  4.92e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││4 @ 2 │ 2.40e+1  1.64e+2  ...  5.84e+2  7.24e+2 │ 2.54e+3  2.68e+3  ...  3.10e+3  3.24e+3 ││
      ││axis 3│ 8.64e+2  1.00e+3  ...  1.42e+3  1.56e+3 │ 3.38e+3  3.52e+3  ...  3.94e+3  4.08e+3 ││
      ││      │ 1.70e+3  1.84e+3  ...  2.26e+3  2.40e+3 │ 4.22e+3  4.36e+3  ...  4.78e+3  4.92e+3 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├────────────────────────────────────────────────────────────────────────────────────────────┤
      │ ...                                                                                        │
      ├────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││5 @ 1 │0 @ 4                                    │1 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 2 │ 1.00e+2  2.40e+2  ...  6.60e+2  8.00e+2 │ 2.62e+3  2.76e+3  ...  3.18e+3  3.32e+3 ││
      ││axis 3│ 9.40e+2  1.08e+3  ...  1.50e+3  1.64e+3 │ 3.46e+3  3.60e+3  ...  4.02e+3  4.16e+3 ││
      ││      │ 1.78e+3  1.92e+3  ...  2.34e+3  2.48e+3 │ 4.30e+3  4.44e+3  ...  4.86e+3  5.00e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 2 │ 1.01e+2  2.41e+2  ...  6.61e+2  8.01e+2 │ 2.62e+3  2.76e+3  ...  3.18e+3  3.32e+3 ││
      ││axis 3│ 9.41e+2  1.08e+3  ...  1.50e+3  1.64e+3 │ 3.46e+3  3.60e+3  ...  4.02e+3  4.16e+3 ││
      ││      │ 1.78e+3  1.92e+3  ...  2.34e+3  2.48e+3 │ 4.30e+3  4.44e+3  ...  4.86e+3  5.00e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││2 @ 2 │ 1.02e+2  2.42e+2  ...  6.62e+2  8.02e+2 │ 2.62e+3  2.76e+3  ...  3.18e+3  3.32e+3 ││
      ││axis 3│ 9.42e+2  1.08e+3  ...  1.50e+3  1.64e+3 │ 3.46e+3  3.60e+3  ...  4.02e+3  4.16e+3 ││
      ││      │ 1.78e+3  1.92e+3  ...  2.34e+3  2.48e+3 │ 4.30e+3  4.44e+3  ...  4.86e+3  5.00e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││3 @ 2 │ 1.03e+2  2.43e+2  ...  6.63e+2  8.03e+2 │ 2.62e+3  2.76e+3  ...  3.18e+3  3.32e+3 ││
      ││axis 3│ 9.43e+2  1.08e+3  ...  1.50e+3  1.64e+3 │ 3.46e+3  3.60e+3  ...  4.02e+3  4.16e+3 ││
      ││      │ 1.78e+3  1.92e+3  ...  2.34e+3  2.48e+3 │ 4.30e+3  4.44e+3  ...  4.86e+3  5.00e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││4 @ 2 │ 1.04e+2  2.44e+2  ...  6.64e+2  8.04e+2 │ 2.62e+3  2.76e+3  ...  3.18e+3  3.32e+3 ││
      ││axis 3│ 9.44e+2  1.08e+3  ...  1.50e+3  1.64e+3 │ 3.46e+3  3.60e+3  ...  4.02e+3  4.16e+3 ││
      ││      │ 1.78e+3  1.92e+3  ...  2.34e+3  2.48e+3 │ 4.30e+3  4.44e+3  ...  4.86e+3  5.00e+3 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      ├────────────────────────────────────────────────────────────────────────────────────────────┤
      │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
      ││6 @ 1 │0 @ 4                                    │1 @ 4                                    ││
      ││      │axis 5                                   │axis 5                                   ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││0 @ 2 │ 1.20e+2  2.60e+2  ...  6.80e+2  8.20e+2 │ 2.64e+3  2.78e+3  ...  3.20e+3  3.34e+3 ││
      ││axis 3│ 9.60e+2  1.10e+3  ...  1.52e+3  1.66e+3 │ 3.48e+3  3.62e+3  ...  4.04e+3  4.18e+3 ││
      ││      │ 1.80e+3  1.94e+3  ...  2.36e+3  2.50e+3 │ 4.32e+3  4.46e+3  ...  4.88e+3  5.02e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││1 @ 2 │ 1.21e+2  2.61e+2  ...  6.81e+2  8.21e+2 │ 2.64e+3  2.78e+3  ...  3.20e+3  3.34e+3 ││
      ││axis 3│ 9.61e+2  1.10e+3  ...  1.52e+3  1.66e+3 │ 3.48e+3  3.62e+3  ...  4.04e+3  4.18e+3 ││
      ││      │ 1.80e+3  1.94e+3  ...  2.36e+3  2.50e+3 │ 4.32e+3  4.46e+3  ...  4.88e+3  5.02e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││2 @ 2 │ 1.22e+2  2.62e+2  ...  6.82e+2  8.22e+2 │ 2.64e+3  2.78e+3  ...  3.20e+3  3.34e+3 ││
      ││axis 3│ 9.62e+2  1.10e+3  ...  1.52e+3  1.66e+3 │ 3.48e+3  3.62e+3  ...  4.04e+3  4.18e+3 ││
      ││      │ 1.80e+3  1.94e+3  ...  2.36e+3  2.50e+3 │ 4.32e+3  4.46e+3  ...  4.88e+3  5.02e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││3 @ 2 │ 1.23e+2  2.63e+2  ...  6.83e+2  8.23e+2 │ 2.64e+3  2.78e+3  ...  3.20e+3  3.34e+3 ││
      ││axis 3│ 9.63e+2  1.10e+3  ...  1.52e+3  1.66e+3 │ 3.48e+3  3.62e+3  ...  4.04e+3  4.18e+3 ││
      ││      │ 1.80e+3  1.94e+3  ...  2.36e+3  2.50e+3 │ 4.32e+3  4.46e+3  ...  4.88e+3  5.02e+3 ││
      │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
      ││4 @ 2 │ 1.24e+2  2.64e+2  ...  6.84e+2  8.24e+2 │ 2.64e+3  2.78e+3  ...  3.20e+3  3.34e+3 ││
      ││axis 3│ 9.64e+2  1.10e+3  ...  1.52e+3  1.66e+3 │ 3.48e+3  3.62e+3  ...  4.04e+3  4.18e+3 ││
      ││      │ 1.80e+3  1.94e+3  ...  2.36e+3  2.50e+3 │ 4.32e+3  4.46e+3  ...  4.88e+3  5.02e+3 ││
      │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
      └────────────────────────────────────────────────────────────────────────────────────────────┘ |} ]
  
let%expect_test "einsum1 sum out axes" =
  let open Session.SDSL in
  drop_all_sessions();
  Random.init 0;
  let hey =
    FDSL.range_of_shape ~batch_dims:[2] ~input_dims:[3] ~output_dims:[4] () in
  let%nn_op ho = hey++"b|i->o => b|i" in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────┐
    │[1]: shape 0:2|2:3->1:4                                         │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 0.00e+0  1.00e+0  2.00e+0 │ 1.20e+1  1.30e+1  1.40e+1 ││
    ││      │ 3.00e+0  4.00e+0  5.00e+0 │ 1.50e+1  1.60e+1  1.70e+1 ││
    ││      │ 6.00e+0  7.00e+0  8.00e+0 │ 1.80e+1  1.90e+1  2.00e+1 ││
    ││      │ 9.00e+0  1.00e+1  1.10e+1 │ 2.10e+1  2.20e+1  2.30e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘ |} ];
  print_formula ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect {|
    ┌────────────────────────────────────┐
    │[2]: shape 0:2|1:3                  │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 1.80e+1  2.20e+1  2.60e+1 ││
    ││      │ 6.60e+1  7.00e+1  7.40e+1 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘ |} ];
    let hey2 =
      FDSL.range_of_shape ~batch_dims:[2;3] ~input_dims:[4;5] ~output_dims:[6;7] () in
    let%nn_op ho2 = hey2++"ab|cd->ef => c|a->d" in
    refresh_session ();
    (* Axis 5 of hey2, i.e. d in the einsum spec, has the lowest variation (progresses by 1),
       that's why axis 1 of ho2 appears nearly constant. *)
    print_formula ~with_code:false ~with_grad:false `Default @@ ho2;
    [%expect {|
      ┌────────────────────────────────────────────────────────────────────────────────────┐
      │[4]: shape 0:4|2:2->1:5                                                             │
      │┌──────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┐│
      ││      │0 @ 0             │1 @ 0             │2 @ 0             │3 @ 0             ││
      ││      │axis 2            │axis 2            │axis 2            │axis 2            ││
      │├──────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤│
      ││axis 1│ 1.58e+5  4.75e+5 │ 1.58e+5  4.76e+5 │ 1.59e+5  4.76e+5 │ 1.59e+5  4.77e+5 ││
      ││      │ 1.58e+5  4.75e+5 │ 1.58e+5  4.76e+5 │ 1.59e+5  4.76e+5 │ 1.60e+5  4.77e+5 ││
      ││      │ 1.58e+5  4.75e+5 │ 1.58e+5  4.76e+5 │ 1.59e+5  4.77e+5 │ 1.60e+5  4.77e+5 ││
      ││      │ 1.58e+5  4.75e+5 │ 1.59e+5  4.76e+5 │ 1.59e+5  4.77e+5 │ 1.60e+5  4.77e+5 ││
      ││      │ 1.58e+5  4.76e+5 │ 1.59e+5  4.76e+5 │ 1.59e+5  4.77e+5 │ 1.60e+5  4.77e+5 ││
      │└──────┴──────────────────┴──────────────────┴──────────────────┴──────────────────┘│
      └────────────────────────────────────────────────────────────────────────────────────┘ |}]


let%expect_test "einsum outer product" =
  let open Session.SDSL in
  drop_all_sessions();
  Random.init 0;
  let a =
    FDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[2] () in
  let b =
    FDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[3] () in
  let%nn_op c = (a + 1) *+"i; j => i->j" b in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ a;
  [%expect {|
    ┌─────────────────────┐
    │[1]: shape 0:2       │
    │┌┬──────────────────┐│
    │││axis 0            ││
    │├┼──────────────────┤│
    │││ 0.00e+0  1.00e+0 ││
    │└┴──────────────────┘│
    └─────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ b;
  [%expect {|
    ┌──────────────────────────────┐
    │[2]: shape 0:3                │
    │┌┬───────────────────────────┐│
    │││axis 0                     ││
    │├┼───────────────────────────┤│
    │││ 0.00e+0  1.00e+0  2.00e+0 ││
    │└┴───────────────────────────┘│
    └──────────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ c;
  [%expect {|
    ┌───────────────────────────┐
    │[5]: shape 1:2->0:3        │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 0.00e+0  0.00e+0 ││
    ││      │ 1.00e+0  2.00e+0 ││
    ││      │ 2.00e+0  4.00e+0 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘ |}];
  let a =
    FDSL.range_of_shape ~batch_dims:[2] ~input_dims:[3] ~output_dims:[4] () in
  let b =
    FDSL.range_of_shape ~batch_dims:[5] ~input_dims:[6] ~output_dims:[7] () in
  let%nn_op c = a *+"i|j->k; l|m->n => il|jm->kn" b in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ a;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────┐
    │[6]: shape 0:2|2:3->1:4                                         │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 0.00e+0  1.00e+0  2.00e+0 │ 1.20e+1  1.30e+1  1.40e+1 ││
    ││      │ 3.00e+0  4.00e+0  5.00e+0 │ 1.50e+1  1.60e+1  1.70e+1 ││
    ││      │ 6.00e+0  7.00e+0  8.00e+0 │ 1.80e+1  1.90e+1  2.00e+1 ││
    ││      │ 9.00e+0  1.00e+1  1.10e+1 │ 2.10e+1  2.20e+1  2.30e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ b;
  [%expect {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[7]: shape 0:5|2:6->1:7                                                                                                                                                                                                   │
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││      │0 @ 0                                    │1 @ 0                                    │2 @ 0                                    │3 @ 0                                    │4 @ 0                                    ││
    ││      │axis 2                                   │axis 2                                   │axis 2                                   │axis 2                                   │axis 2                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││axis 1│ 0.00e+0  1.00e+0  ...  4.00e+0  5.00e+0 │ 4.20e+1  4.30e+1  ...  4.60e+1  4.70e+1 │ 8.40e+1  8.50e+1  ...  8.80e+1  8.90e+1 │ 1.26e+2  1.27e+2  ...  1.30e+2  1.31e+2 │ 1.68e+2  1.69e+2  ...  1.72e+2  1.73e+2 ││
    ││      │ 6.00e+0  7.00e+0  ...  1.00e+1  1.10e+1 │ 4.80e+1  4.90e+1  ...  5.20e+1  5.30e+1 │ 9.00e+1  9.10e+1  ...  9.40e+1  9.50e+1 │ 1.32e+2  1.33e+2  ...  1.36e+2  1.37e+2 │ 1.74e+2  1.75e+2  ...  1.78e+2  1.79e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 3.00e+1  3.10e+1  ...  3.40e+1  3.50e+1 │ 7.20e+1  7.30e+1  ...  7.60e+1  7.70e+1 │ 1.14e+2  1.15e+2  ...  1.18e+2  1.19e+2 │ 1.56e+2  1.57e+2  ...  1.60e+2  1.61e+2 │ 1.98e+2  1.99e+2  ...  2.02e+2  2.03e+2 ││
    ││      │ 3.60e+1  3.70e+1  ...  4.00e+1  4.10e+1 │ 7.80e+1  7.90e+1  ...  8.20e+1  8.30e+1 │ 1.20e+2  1.21e+2  ...  1.24e+2  1.25e+2 │ 1.62e+2  1.63e+2  ...  1.66e+2  1.67e+2 │ 2.04e+2  2.05e+2  ...  2.08e+2  2.09e+2 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}];
  print_formula ~with_code:false ~with_grad:false `Default @@ c;
  [%expect {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[8]: shape 0:2,1:5|4:3,5:6->2:4,3:7                                                                                                   │
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                    │1 @ 4                                    │2 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 0.00e+0  1.00e+0  ...  4.00e+0  5.00e+0 │ 0.00e+0  2.00e+0  ...  8.00e+0  1.00e+1 ││
    ││axis 3│ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 6.00e+0  7.00e+0  ...  1.00e+1  1.10e+1 │ 1.20e+1  1.40e+1  ...  2.00e+1  2.20e+1 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 3.00e+1  3.10e+1  ...  3.40e+1  3.50e+1 │ 6.00e+1  6.20e+1  ...  6.80e+1  7.00e+1 ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 3.60e+1  3.70e+1  ...  4.00e+1  4.10e+1 │ 7.20e+1  7.40e+1  ...  8.00e+1  8.20e+1 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 2 │ 0.00e+0  3.00e+0  ...  1.20e+1  1.50e+1 │ 0.00e+0  4.00e+0  ...  1.60e+1  2.00e+1 │ 0.00e+0  5.00e+0  ...  2.00e+1  2.50e+1 ││
    ││axis 3│ 1.80e+1  2.10e+1  ...  3.00e+1  3.30e+1 │ 2.40e+1  2.80e+1  ...  4.00e+1  4.40e+1 │ 3.00e+1  3.50e+1  ...  5.00e+1  5.50e+1 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 9.00e+1  9.30e+1  ...  1.02e+2  1.05e+2 │ 1.20e+2  1.24e+2  ...  1.36e+2  1.40e+2 │ 1.50e+2  1.55e+2  ...  1.70e+2  1.75e+2 ││
    ││      │ 1.08e+2  1.11e+2  ...  1.20e+2  1.23e+2 │ 1.44e+2  1.48e+2  ...  1.60e+2  1.64e+2 │ 1.80e+2  1.85e+2  ...  2.00e+2  2.05e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││2 @ 2 │ 0.00e+0  6.00e+0  ...  2.40e+1  3.00e+1 │ 0.00e+0  7.00e+0  ...  2.80e+1  3.50e+1 │ 0.00e+0  8.00e+0  ...  3.20e+1  4.00e+1 ││
    ││axis 3│ 3.60e+1  4.20e+1  ...  6.00e+1  6.60e+1 │ 4.20e+1  4.90e+1  ...  7.00e+1  7.70e+1 │ 4.80e+1  5.60e+1  ...  8.00e+1  8.80e+1 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.80e+2  1.86e+2  ...  2.04e+2  2.10e+2 │ 2.10e+2  2.17e+2  ...  2.38e+2  2.45e+2 │ 2.40e+2  2.48e+2  ...  2.72e+2  2.80e+2 ││
    ││      │ 2.16e+2  2.22e+2  ...  2.40e+2  2.46e+2 │ 2.52e+2  2.59e+2  ...  2.80e+2  2.87e+2 │ 2.88e+2  2.96e+2  ...  3.20e+2  3.28e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││3 @ 2 │ 0.00e+0  9.00e+0  ...  3.60e+1  4.50e+1 │ 0.00e+0  1.00e+1  ...  4.00e+1  5.00e+1 │ 0.00e+0  1.10e+1  ...  4.40e+1  5.50e+1 ││
    ││axis 3│ 5.40e+1  6.30e+1  ...  9.00e+1  9.90e+1 │ 6.00e+1  7.00e+1  ...  1.00e+2  1.10e+2 │ 6.60e+1  7.70e+1  ...  1.10e+2  1.21e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.70e+2  2.79e+2  ...  3.06e+2  3.15e+2 │ 3.00e+2  3.10e+2  ...  3.40e+2  3.50e+2 │ 3.30e+2  3.41e+2  ...  3.74e+2  3.85e+2 ││
    ││      │ 3.24e+2  3.33e+2  ...  3.60e+2  3.69e+2 │ 3.60e+2  3.70e+2  ...  4.00e+2  4.10e+2 │ 3.96e+2  4.07e+2  ...  4.40e+2  4.51e+2 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                    │1 @ 4                                    │2 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 4.20e+1  4.30e+1  ...  4.60e+1  4.70e+1 │ 8.40e+1  8.60e+1  ...  9.20e+1  9.40e+1 ││
    ││axis 3│ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 4.80e+1  4.90e+1  ...  5.20e+1  5.30e+1 │ 9.60e+1  9.80e+1  ...  1.04e+2  1.06e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 7.20e+1  7.30e+1  ...  7.60e+1  7.70e+1 │ 1.44e+2  1.46e+2  ...  1.52e+2  1.54e+2 ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 7.80e+1  7.90e+1  ...  8.20e+1  8.30e+1 │ 1.56e+2  1.58e+2  ...  1.64e+2  1.66e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 2 │ 1.26e+2  1.29e+2  ...  1.38e+2  1.41e+2 │ 1.68e+2  1.72e+2  ...  1.84e+2  1.88e+2 │ 2.10e+2  2.15e+2  ...  2.30e+2  2.35e+2 ││
    ││axis 3│ 1.44e+2  1.47e+2  ...  1.56e+2  1.59e+2 │ 1.92e+2  1.96e+2  ...  2.08e+2  2.12e+2 │ 2.40e+2  2.45e+2  ...  2.60e+2  2.65e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 2.16e+2  2.19e+2  ...  2.28e+2  2.31e+2 │ 2.88e+2  2.92e+2  ...  3.04e+2  3.08e+2 │ 3.60e+2  3.65e+2  ...  3.80e+2  3.85e+2 ││
    ││      │ 2.34e+2  2.37e+2  ...  2.46e+2  2.49e+2 │ 3.12e+2  3.16e+2  ...  3.28e+2  3.32e+2 │ 3.90e+2  3.95e+2  ...  4.10e+2  4.15e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││2 @ 2 │ 2.52e+2  2.58e+2  ...  2.76e+2  2.82e+2 │ 2.94e+2  3.01e+2  ...  3.22e+2  3.29e+2 │ 3.36e+2  3.44e+2  ...  3.68e+2  3.76e+2 ││
    ││axis 3│ 2.88e+2  2.94e+2  ...  3.12e+2  3.18e+2 │ 3.36e+2  3.43e+2  ...  3.64e+2  3.71e+2 │ 3.84e+2  3.92e+2  ...  4.16e+2  4.24e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 4.32e+2  4.38e+2  ...  4.56e+2  4.62e+2 │ 5.04e+2  5.11e+2  ...  5.32e+2  5.39e+2 │ 5.76e+2  5.84e+2  ...  6.08e+2  6.16e+2 ││
    ││      │ 4.68e+2  4.74e+2  ...  4.92e+2  4.98e+2 │ 5.46e+2  5.53e+2  ...  5.74e+2  5.81e+2 │ 6.24e+2  6.32e+2  ...  6.56e+2  6.64e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││3 @ 2 │ 3.78e+2  3.87e+2  ...  4.14e+2  4.23e+2 │ 4.20e+2  4.30e+2  ...  4.60e+2  4.70e+2 │ 4.62e+2  4.73e+2  ...  5.06e+2  5.17e+2 ││
    ││axis 3│ 4.32e+2  4.41e+2  ...  4.68e+2  4.77e+2 │ 4.80e+2  4.90e+2  ...  5.20e+2  5.30e+2 │ 5.28e+2  5.39e+2  ...  5.72e+2  5.83e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 6.48e+2  6.57e+2  ...  6.84e+2  6.93e+2 │ 7.20e+2  7.30e+2  ...  7.60e+2  7.70e+2 │ 7.92e+2  8.03e+2  ...  8.36e+2  8.47e+2 ││
    ││      │ 7.02e+2  7.11e+2  ...  7.38e+2  7.47e+2 │ 7.80e+2  7.90e+2  ...  8.20e+2  8.30e+2 │ 8.58e+2  8.69e+2  ...  9.02e+2  9.13e+2 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                    │1 @ 4                                    │2 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 8.40e+1  8.50e+1  ...  8.80e+1  8.90e+1 │ 1.68e+2  1.70e+2  ...  1.76e+2  1.78e+2 ││
    ││axis 3│ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 9.00e+1  9.10e+1  ...  9.40e+1  9.50e+1 │ 1.80e+2  1.82e+2  ...  1.88e+2  1.90e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.14e+2  1.15e+2  ...  1.18e+2  1.19e+2 │ 2.28e+2  2.30e+2  ...  2.36e+2  2.38e+2 ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.20e+2  1.21e+2  ...  1.24e+2  1.25e+2 │ 2.40e+2  2.42e+2  ...  2.48e+2  2.50e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 2 │ 2.52e+2  2.55e+2  ...  2.64e+2  2.67e+2 │ 3.36e+2  3.40e+2  ...  3.52e+2  3.56e+2 │ 4.20e+2  4.25e+2  ...  4.40e+2  4.45e+2 ││
    ││axis 3│ 2.70e+2  2.73e+2  ...  2.82e+2  2.85e+2 │ 3.60e+2  3.64e+2  ...  3.76e+2  3.80e+2 │ 4.50e+2  4.55e+2  ...  4.70e+2  4.75e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 3.42e+2  3.45e+2  ...  3.54e+2  3.57e+2 │ 4.56e+2  4.60e+2  ...  4.72e+2  4.76e+2 │ 5.70e+2  5.75e+2  ...  5.90e+2  5.95e+2 ││
    ││      │ 3.60e+2  3.63e+2  ...  3.72e+2  3.75e+2 │ 4.80e+2  4.84e+2  ...  4.96e+2  5.00e+2 │ 6.00e+2  6.05e+2  ...  6.20e+2  6.25e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││2 @ 2 │ 5.04e+2  5.10e+2  ...  5.28e+2  5.34e+2 │ 5.88e+2  5.95e+2  ...  6.16e+2  6.23e+2 │ 6.72e+2  6.80e+2  ...  7.04e+2  7.12e+2 ││
    ││axis 3│ 5.40e+2  5.46e+2  ...  5.64e+2  5.70e+2 │ 6.30e+2  6.37e+2  ...  6.58e+2  6.65e+2 │ 7.20e+2  7.28e+2  ...  7.52e+2  7.60e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 6.84e+2  6.90e+2  ...  7.08e+2  7.14e+2 │ 7.98e+2  8.05e+2  ...  8.26e+2  8.33e+2 │ 9.12e+2  9.20e+2  ...  9.44e+2  9.52e+2 ││
    ││      │ 7.20e+2  7.26e+2  ...  7.44e+2  7.50e+2 │ 8.40e+2  8.47e+2  ...  8.68e+2  8.75e+2 │ 9.60e+2  9.68e+2  ...  9.92e+2  1.00e+3 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││3 @ 2 │ 7.56e+2  7.65e+2  ...  7.92e+2  8.01e+2 │ 8.40e+2  8.50e+2  ...  8.80e+2  8.90e+2 │ 9.24e+2  9.35e+2  ...  9.68e+2  9.79e+2 ││
    ││axis 3│ 8.10e+2  8.19e+2  ...  8.46e+2  8.55e+2 │ 9.00e+2  9.10e+2  ...  9.40e+2  9.50e+2 │ 9.90e+2  1.00e+3  ...  1.03e+3  1.04e+3 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.03e+3  1.04e+3  ...  1.06e+3  1.07e+3 │ 1.14e+3  1.15e+3  ...  1.18e+3  1.19e+3 │ 1.25e+3  1.26e+3  ...  1.30e+3  1.31e+3 ││
    ││      │ 1.08e+3  1.09e+3  ...  1.12e+3  1.12e+3 │ 1.20e+3  1.21e+3  ...  1.24e+3  1.25e+3 │ 1.32e+3  1.33e+3  ...  1.36e+3  1.38e+3 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                    │1 @ 4                                    │2 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.26e+2  1.27e+2  ...  1.30e+2  1.31e+2 │ 2.52e+2  2.54e+2  ...  2.60e+2  2.62e+2 ││
    ││axis 3│ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.32e+2  1.33e+2  ...  1.36e+2  1.37e+2 │ 2.64e+2  2.66e+2  ...  2.72e+2  2.74e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.56e+2  1.57e+2  ...  1.60e+2  1.61e+2 │ 3.12e+2  3.14e+2  ...  3.20e+2  3.22e+2 ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.62e+2  1.63e+2  ...  1.66e+2  1.67e+2 │ 3.24e+2  3.26e+2  ...  3.32e+2  3.34e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 2 │ 3.78e+2  3.81e+2  ...  3.90e+2  3.93e+2 │ 5.04e+2  5.08e+2  ...  5.20e+2  5.24e+2 │ 6.30e+2  6.35e+2  ...  6.50e+2  6.55e+2 ││
    ││axis 3│ 3.96e+2  3.99e+2  ...  4.08e+2  4.11e+2 │ 5.28e+2  5.32e+2  ...  5.44e+2  5.48e+2 │ 6.60e+2  6.65e+2  ...  6.80e+2  6.85e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 4.68e+2  4.71e+2  ...  4.80e+2  4.83e+2 │ 6.24e+2  6.28e+2  ...  6.40e+2  6.44e+2 │ 7.80e+2  7.85e+2  ...  8.00e+2  8.05e+2 ││
    ││      │ 4.86e+2  4.89e+2  ...  4.98e+2  5.01e+2 │ 6.48e+2  6.52e+2  ...  6.64e+2  6.68e+2 │ 8.10e+2  8.15e+2  ...  8.30e+2  8.35e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││2 @ 2 │ 7.56e+2  7.62e+2  ...  7.80e+2  7.86e+2 │ 8.82e+2  8.89e+2  ...  9.10e+2  9.17e+2 │ 1.01e+3  1.02e+3  ...  1.04e+3  1.05e+3 ││
    ││axis 3│ 7.92e+2  7.98e+2  ...  8.16e+2  8.22e+2 │ 9.24e+2  9.31e+2  ...  9.52e+2  9.59e+2 │ 1.06e+3  1.06e+3  ...  1.09e+3  1.10e+3 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 9.36e+2  9.42e+2  ...  9.60e+2  9.66e+2 │ 1.09e+3  1.10e+3  ...  1.12e+3  1.13e+3 │ 1.25e+3  1.26e+3  ...  1.28e+3  1.29e+3 ││
    ││      │ 9.72e+2  9.78e+2  ...  9.96e+2  1.00e+3 │ 1.13e+3  1.14e+3  ...  1.16e+3  1.17e+3 │ 1.30e+3  1.30e+3  ...  1.33e+3  1.34e+3 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││3 @ 2 │ 1.13e+3  1.14e+3  ...  1.17e+3  1.18e+3 │ 1.26e+3  1.27e+3  ...  1.30e+3  1.31e+3 │ 1.39e+3  1.40e+3  ...  1.43e+3  1.44e+3 ││
    ││axis 3│ 1.19e+3  1.20e+3  ...  1.22e+3  1.23e+3 │ 1.32e+3  1.33e+3  ...  1.36e+3  1.37e+3 │ 1.45e+3  1.46e+3  ...  1.50e+3  1.51e+3 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.40e+3  1.41e+3  ...  1.44e+3  1.45e+3 │ 1.56e+3  1.57e+3  ...  1.60e+3  1.61e+3 │ 1.72e+3  1.73e+3  ...  1.76e+3  1.77e+3 ││
    ││      │ 1.46e+3  1.47e+3  ...  1.49e+3  1.50e+3 │ 1.62e+3  1.63e+3  ...  1.66e+3  1.67e+3 │ 1.78e+3  1.79e+3  ...  1.83e+3  1.84e+3 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                    │1 @ 4                                    │2 @ 4                                    ││
    ││      │axis 5                                   │axis 5                                   │axis 5                                   ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.68e+2  1.69e+2  ...  1.72e+2  1.73e+2 │ 3.36e+2  3.38e+2  ...  3.44e+2  3.46e+2 ││
    ││axis 3│ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.74e+2  1.75e+2  ...  1.78e+2  1.79e+2 │ 3.48e+2  3.50e+2  ...  3.56e+2  3.58e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 1.98e+2  1.99e+2  ...  2.02e+2  2.03e+2 │ 3.96e+2  3.98e+2  ...  4.04e+2  4.06e+2 ││
    ││      │ 0.00e+0  0.00e+0  ...  0.00e+0  0.00e+0 │ 2.04e+2  2.05e+2  ...  2.08e+2  2.09e+2 │ 4.08e+2  4.10e+2  ...  4.16e+2  4.18e+2 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││1 @ 2 │ 5.04e+2  5.07e+2  ...  5.16e+2  5.19e+2 │ 6.72e+2  6.76e+2  ...  6.88e+2  6.92e+2 │ 8.40e+2  8.45e+2  ...  8.60e+2  8.65e+2 ││
    ││axis 3│ 5.22e+2  5.25e+2  ...  5.34e+2  5.37e+2 │ 6.96e+2  7.00e+2  ...  7.12e+2  7.16e+2 │ 8.70e+2  8.75e+2  ...  8.90e+2  8.95e+2 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 5.94e+2  5.97e+2  ...  6.06e+2  6.09e+2 │ 7.92e+2  7.96e+2  ...  8.08e+2  8.12e+2 │ 9.90e+2  9.95e+2  ...  1.01e+3  1.02e+3 ││
    ││      │ 6.12e+2  6.15e+2  ...  6.24e+2  6.27e+2 │ 8.16e+2  8.20e+2  ...  8.32e+2  8.36e+2 │ 1.02e+3  1.02e+3  ...  1.04e+3  1.04e+3 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││2 @ 2 │ 1.01e+3  1.01e+3  ...  1.03e+3  1.04e+3 │ 1.18e+3  1.18e+3  ...  1.20e+3  1.21e+3 │ 1.34e+3  1.35e+3  ...  1.38e+3  1.38e+3 ││
    ││axis 3│ 1.04e+3  1.05e+3  ...  1.07e+3  1.07e+3 │ 1.22e+3  1.22e+3  ...  1.25e+3  1.25e+3 │ 1.39e+3  1.40e+3  ...  1.42e+3  1.43e+3 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.19e+3  1.19e+3  ...  1.21e+3  1.22e+3 │ 1.39e+3  1.39e+3  ...  1.41e+3  1.42e+3 │ 1.58e+3  1.59e+3  ...  1.62e+3  1.62e+3 ││
    ││      │ 1.22e+3  1.23e+3  ...  1.25e+3  1.25e+3 │ 1.43e+3  1.44e+3  ...  1.46e+3  1.46e+3 │ 1.63e+3  1.64e+3  ...  1.66e+3  1.67e+3 ││
    │├──────┼─────────────────────────────────────────┼─────────────────────────────────────────┼─────────────────────────────────────────┤│
    ││3 @ 2 │ 1.51e+3  1.52e+3  ...  1.55e+3  1.56e+3 │ 1.68e+3  1.69e+3  ...  1.72e+3  1.73e+3 │ 1.85e+3  1.86e+3  ...  1.89e+3  1.90e+3 ││
    ││axis 3│ 1.57e+3  1.58e+3  ...  1.60e+3  1.61e+3 │ 1.74e+3  1.75e+3  ...  1.78e+3  1.79e+3 │ 1.91e+3  1.92e+3  ...  1.96e+3  1.97e+3 ││
    ││      │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     │ ...      ...      ...  ...      ...     ││
    ││      │ 1.78e+3  1.79e+3  ...  1.82e+3  1.83e+3 │ 1.98e+3  1.99e+3  ...  2.02e+3  2.03e+3 │ 2.18e+3  2.19e+3  ...  2.22e+3  2.23e+3 ││
    ││      │ 1.84e+3  1.84e+3  ...  1.87e+3  1.88e+3 │ 2.04e+3  2.05e+3  ...  2.08e+3  2.09e+3 │ 2.24e+3  2.26e+3  ...  2.29e+3  2.30e+3 ││
    │└──────┴─────────────────────────────────────────┴─────────────────────────────────────────┴─────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
