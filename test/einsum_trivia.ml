open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module NTDSL = Operation.NTDSL
module Rand = Arrayjit.Rand.Lib

module type Backend = Arrayjit.Backend_intf.Backend

let%expect_test "einsum1 permute axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => o|b->i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:4|2:2->1:3                                      │
    │┌──────┬─────────────┬─────────────┬─────────────┬────────────────┐│
    ││      │0 @ 0        │1 @ 0        │2 @ 0        │3 @ 0           ││
    ││      │axis 2       │axis 2       │axis 2       │axis 2          ││
    │├──────┼─────────────┼─────────────┼─────────────┼────────────────┤│
    ││axis 1│ 0.0  1.2e+1 │ 3.0  1.5e+1 │ 6.0  1.8e+1 │ 9.0     2.1e+1 ││
    ││      │ 1.0  1.3e+1 │ 4.0  1.6e+1 │ 7.0  1.9e+1 │ 1.0e+1  2.2e+1 ││
    ││      │ 2.0  1.4e+1 │ 5.0  1.7e+1 │ 8.0  2.0e+1 │ 1.1e+1  2.3e+1 ││
    │└──────┴─────────────┴─────────────┴─────────────┴────────────────┘│
    └───────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => cf|ae->db" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                            │
    │┌──────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                   │1 @ 4                                   │2 @ 4                                   │3 @ 4                                   ││
    ││      │axis 5                                  │axis 5                                  │axis 5                                  │axis 5                                  ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0     1.0     2.0     3.0     4.0    │ 5.0     6.0     7.0     8.0     9.0    │ 1.0e+1  1.1e+1  1.2e+1  1.3e+1  1.4e+1 │ 1.5e+1  1.6e+1  1.7e+1  1.8e+1  1.9e+1 ││
    ││axis 3│ 2.0e+1  2.1e+1  2.2e+1  2.3e+1  2.4e+1 │ 2.5e+1  2.6e+1  2.7e+1  2.8e+1  2.9e+1 │ 3.0e+1  3.1e+1  3.2e+1  3.3e+1  3.4e+1 │ 3.5e+1  3.6e+1  3.7e+1  3.8e+1  3.9e+1 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.0e+2  1.0e+2  1.0e+2  1.0e+2  1.0e+2 │ 1.1e+2  1.1e+2  1.1e+2  1.1e+2  1.1e+2 │ 1.1e+2  1.1e+2  1.1e+2  1.1e+2  1.1e+2 │ 1.2e+2  1.2e+2  1.2e+2  1.2e+2  1.2e+2 ││
    ││      │ 1.2e+2  1.2e+2  1.2e+2  1.2e+2  1.2e+2 │ 1.3e+2  1.3e+2  1.3e+2  1.3e+2  1.3e+2 │ 1.3e+2  1.3e+2  1.3e+2  1.3e+2  1.3e+2 │ 1.4e+2  1.4e+2  1.4e+2  1.4e+2  1.4e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.4e+2  1.4e+2  1.4e+2  1.4e+2 │ 1.5e+2  1.5e+2  1.5e+2  1.5e+2  1.5e+2 │ 1.5e+2  1.5e+2  1.5e+2  1.5e+2  1.5e+2 │ 1.6e+2  1.6e+2  1.6e+2  1.6e+2  1.6e+2 ││
    ││axis 3│ 1.6e+2  1.6e+2  1.6e+2  1.6e+2  1.6e+2 │ 1.7e+2  1.7e+2  1.7e+2  1.7e+2  1.7e+2 │ 1.7e+2  1.7e+2  1.7e+2  1.7e+2  1.7e+2 │ 1.8e+2  1.8e+2  1.8e+2  1.8e+2  1.8e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 2.4e+2  2.4e+2  2.4e+2  2.4e+2  2.4e+2 │ 2.5e+2  2.5e+2  2.5e+2  2.5e+2  2.5e+2 │ 2.5e+2  2.5e+2  2.5e+2  2.5e+2  2.5e+2 │ 2.6e+2  2.6e+2  2.6e+2  2.6e+2  2.6e+2 ││
    ││      │ 2.6e+2  2.6e+2  2.6e+2  2.6e+2  2.6e+2 │ 2.7e+2  2.7e+2  2.7e+2  2.7e+2  2.7e+2 │ 2.7e+2  2.7e+2  2.7e+2  2.7e+2  2.7e+2 │ 2.8e+2  2.8e+2  2.8e+2  2.8e+2  2.8e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││~~~~~ │ ...                                    │ ...                                    │ ...                                    │ ...                                    ││
    ││axis 3│                                        │                                        │                                        │                                        ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.6e+2  5.6e+2  5.6e+2  5.6e+2 │ 5.7e+2  5.7e+2  5.7e+2  5.7e+2  5.7e+2 │ 5.7e+2  5.7e+2  5.7e+2  5.7e+2  5.7e+2 │ 5.8e+2  5.8e+2  5.8e+2  5.8e+2  5.8e+2 ││
    ││axis 3│ 5.8e+2  5.8e+2  5.8e+2  5.8e+2  5.8e+2 │ 5.9e+2  5.9e+2  5.9e+2  5.9e+2  5.9e+2 │ 5.9e+2  5.9e+2  5.9e+2  5.9e+2  5.9e+2 │ 6.0e+2  6.0e+2  6.0e+2  6.0e+2  6.0e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 6.6e+2  6.6e+2  6.6e+2  6.6e+2  6.6e+2 │ 6.7e+2  6.7e+2  6.7e+2  6.7e+2  6.7e+2 │ 6.7e+2  6.7e+2  6.7e+2  6.7e+2  6.7e+2 │ 6.8e+2  6.8e+2  6.8e+2  6.8e+2  6.8e+2 ││
    ││      │ 6.8e+2  6.8e+2  6.8e+2  6.8e+2  6.8e+2 │ 6.9e+2  6.9e+2  6.9e+2  6.9e+2  6.9e+2 │ 6.9e+2  6.9e+2  6.9e+2  6.9e+2  6.9e+2 │ 7.0e+2  7.0e+2  7.0e+2  7.0e+2  7.0e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.0e+2  7.0e+2  7.0e+2  7.0e+2 │ 7.1e+2  7.1e+2  7.1e+2  7.1e+2  7.1e+2 │ 7.1e+2  7.1e+2  7.1e+2  7.1e+2  7.1e+2 │ 7.2e+2  7.2e+2  7.2e+2  7.2e+2  7.2e+2 ││
    ││axis 3│ 7.2e+2  7.2e+2  7.2e+2  7.2e+2  7.2e+2 │ 7.3e+2  7.3e+2  7.3e+2  7.3e+2  7.3e+2 │ 7.3e+2  7.3e+2  7.3e+2  7.3e+2  7.3e+2 │ 7.4e+2  7.4e+2  7.4e+2  7.4e+2  7.4e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 8.0e+2  8.0e+2  8.0e+2  8.0e+2  8.0e+2 │ 8.1e+2  8.1e+2  8.1e+2  8.1e+2  8.1e+2 │ 8.1e+2  8.1e+2  8.1e+2  8.1e+2  8.1e+2 │ 8.2e+2  8.2e+2  8.2e+2  8.2e+2  8.2e+2 ││
    ││      │ 8.2e+2  8.2e+2  8.2e+2  8.2e+2  8.2e+2 │ 8.3e+2  8.3e+2  8.3e+2  8.3e+2  8.3e+2 │ 8.3e+2  8.3e+2  8.3e+2  8.3e+2  8.3e+2 │ 8.4e+2  8.4e+2  8.4e+2  8.4e+2  8.4e+2 ││
    │└──────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                   │1 @ 4                                   │2 @ 4                                   │3 @ 4                                   ││
    ││      │axis 5                                  │axis 5                                  │axis 5                                  │axis 5                                  ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││0 @ 2 │ 8.4e+2  8.4e+2  8.4e+2  8.4e+2  8.4e+2 │ 8.5e+2  8.5e+2  8.5e+2  8.5e+2  8.5e+2 │ 8.5e+2  8.5e+2  8.5e+2  8.5e+2  8.5e+2 │ 8.6e+2  8.6e+2  8.6e+2  8.6e+2  8.6e+2 ││
    ││axis 3│ 8.6e+2  8.6e+2  8.6e+2  8.6e+2  8.6e+2 │ 8.7e+2  8.7e+2  8.7e+2  8.7e+2  8.7e+2 │ 8.7e+2  8.7e+2  8.7e+2  8.7e+2  8.7e+2 │ 8.8e+2  8.8e+2  8.8e+2  8.8e+2  8.8e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 9.4e+2  9.4e+2  9.4e+2  9.4e+2  9.4e+2 │ 9.5e+2  9.5e+2  9.5e+2  9.5e+2  9.5e+2 │ 9.5e+2  9.5e+2  9.5e+2  9.5e+2  9.5e+2 │ 9.6e+2  9.6e+2  9.6e+2  9.6e+2  9.6e+2 ││
    ││      │ 9.6e+2  9.6e+2  9.6e+2  9.6e+2  9.6e+2 │ 9.7e+2  9.7e+2  9.7e+2  9.7e+2  9.7e+2 │ 9.7e+2  9.7e+2  9.7e+2  9.7e+2  9.7e+2 │ 9.8e+2  9.8e+2  9.8e+2  9.8e+2  9.8e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││1 @ 2 │ 9.8e+2  9.8e+2  9.8e+2  9.8e+2  9.8e+2 │ 9.9e+2  9.9e+2  9.9e+2  9.9e+2  9.9e+2 │ 9.9e+2  9.9e+2  9.9e+2  9.9e+2  9.9e+2 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 ││
    ││axis 3│ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 ││
    ││      │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││~~~~~ │ ...                                    │ ...                                    │ ...                                    │ ...                                    ││
    ││axis 3│                                        │                                        │                                        │                                        ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││4 @ 2 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 ││
    ││axis 3│ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 ││
    ││      │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││5 @ 2 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 ││
    ││axis 3│ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    ││      │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    │└──────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                   │1 @ 4                                   │2 @ 4                                   │3 @ 4                                   ││
    ││      │axis 5                                  │axis 5                                  │axis 5                                  │axis 5                                  ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││0 @ 2 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    ││axis 3│ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 ││
    ││      │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││1 @ 2 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 ││
    ││axis 3│ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 ││
    ││      │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 2.0e+3  2.0e+3  2.0e+3  2.0e+3  2.0e+3 │ 2.0e+3  2.0e+3  2.0e+3  2.0e+3  2.0e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││~~~~~ │ ...                                    │ ...                                    │ ...                                    │ ...                                    ││
    ││axis 3│                                        │                                        │                                        │                                        ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││4 @ 2 │ 2.2e+3  2.2e+3  2.2e+3  2.2e+3  2.2e+3 │ 2.2e+3  2.2e+3  2.2e+3  2.2e+3  2.2e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 ││
    ││axis 3│ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    ││      │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││5 @ 2 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    ││axis 3│ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 ││
    ││      │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 ││
    │└──────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4,1:7|4:2,5:6->2:5,3:3                                          │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                │1 @ 4                                ││
    ││      │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0     1.4e+2  ...  5.6e+2  7.0e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.4e+2  9.8e+2  ...  1.4e+3  1.5e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.2e+3  2.4e+3 │ 4.2e+3  4.3e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.0     1.4e+2  ...  5.6e+2  7.0e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.4e+2  9.8e+2  ...  1.4e+3  1.5e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.2e+3  2.4e+3 │ 4.2e+3  4.3e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 2.0     1.4e+2  ...  5.6e+2  7.0e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.4e+2  9.8e+2  ...  1.4e+3  1.5e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.2e+3  2.4e+3 │ 4.2e+3  4.3e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 3.0     1.4e+2  ...  5.6e+2  7.0e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.4e+2  9.8e+2  ...  1.4e+3  1.5e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.2e+3  2.4e+3 │ 4.2e+3  4.3e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 4.0     1.4e+2  ...  5.6e+2  7.0e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.4e+2  9.8e+2  ...  1.4e+3  1.5e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.2e+3  2.4e+3 │ 4.2e+3  4.3e+3  ...  4.8e+3  4.9e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                │1 @ 4                                ││
    ││      │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 2.0e+1  1.6e+2  ...  5.8e+2  7.2e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.6e+2  1.0e+3  ...  1.4e+3  1.6e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.3e+3  2.4e+3 │ 4.2e+3  4.4e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 2.1e+1  1.6e+2  ...  5.8e+2  7.2e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.6e+2  1.0e+3  ...  1.4e+3  1.6e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.3e+3  2.4e+3 │ 4.2e+3  4.4e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 2.2e+1  1.6e+2  ...  5.8e+2  7.2e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.6e+2  1.0e+3  ...  1.4e+3  1.6e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.3e+3  2.4e+3 │ 4.2e+3  4.4e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 2.3e+1  1.6e+2  ...  5.8e+2  7.2e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.6e+2  1.0e+3  ...  1.4e+3  1.6e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.3e+3  2.4e+3 │ 4.2e+3  4.4e+3  ...  4.8e+3  4.9e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 2.4e+1  1.6e+2  ...  5.8e+2  7.2e+2 │ 2.5e+3  2.7e+3  ...  3.1e+3  3.2e+3 ││
    ││axis 3│ 8.6e+2  1.0e+3  ...  1.4e+3  1.6e+3 │ 3.4e+3  3.5e+3  ...  3.9e+3  4.1e+3 ││
    ││      │ 1.7e+3  1.8e+3  ...  2.3e+3  2.4e+3 │ 4.2e+3  4.4e+3  ...  4.8e+3  4.9e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                │
    ├────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││5 @ 1 │0 @ 4                                │1 @ 4                                ││
    ││      │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 1.0e+2  2.4e+2  ...  6.6e+2  8.0e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.4e+2  1.1e+3  ...  1.5e+3  1.6e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.3e+3  2.5e+3 │ 4.3e+3  4.4e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.0e+2  2.4e+2  ...  6.6e+2  8.0e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.4e+2  1.1e+3  ...  1.5e+3  1.6e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.3e+3  2.5e+3 │ 4.3e+3  4.4e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 1.0e+2  2.4e+2  ...  6.6e+2  8.0e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.4e+2  1.1e+3  ...  1.5e+3  1.6e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.3e+3  2.5e+3 │ 4.3e+3  4.4e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 1.0e+2  2.4e+2  ...  6.6e+2  8.0e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.4e+2  1.1e+3  ...  1.5e+3  1.6e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.3e+3  2.5e+3 │ 4.3e+3  4.4e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 1.0e+2  2.4e+2  ...  6.6e+2  8.0e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.4e+2  1.1e+3  ...  1.5e+3  1.6e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.3e+3  2.5e+3 │ 4.3e+3  4.4e+3  ...  4.9e+3  5.0e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││6 @ 1 │0 @ 4                                │1 @ 4                                ││
    ││      │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 1.2e+2  2.6e+2  ...  6.8e+2  8.2e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.6e+2  1.1e+3  ...  1.5e+3  1.7e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.4e+3  2.5e+3 │ 4.3e+3  4.5e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.2e+2  2.6e+2  ...  6.8e+2  8.2e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.6e+2  1.1e+3  ...  1.5e+3  1.7e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.4e+3  2.5e+3 │ 4.3e+3  4.5e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 1.2e+2  2.6e+2  ...  6.8e+2  8.2e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.6e+2  1.1e+3  ...  1.5e+3  1.7e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.4e+3  2.5e+3 │ 4.3e+3  4.5e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 1.2e+2  2.6e+2  ...  6.8e+2  8.2e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.6e+2  1.1e+3  ...  1.5e+3  1.7e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.4e+3  2.5e+3 │ 4.3e+3  4.5e+3  ...  4.9e+3  5.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 1.2e+2  2.6e+2  ...  6.8e+2  8.2e+2 │ 2.6e+3  2.8e+3  ...  3.2e+3  3.3e+3 ││
    ││axis 3│ 9.6e+2  1.1e+3  ...  1.5e+3  1.7e+3 │ 3.5e+3  3.6e+3  ...  4.0e+3  4.2e+3 ││
    ││      │ 1.8e+3  1.9e+3  ...  2.4e+3  2.5e+3 │ 4.3e+3  4.5e+3  ...  4.9e+3  5.0e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 sum out axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => b|i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:3         │
    │┌──────┬────────────────────────┐│
    ││      │axis 1                  ││
    │├──────┼────────────────────────┤│
    ││axis 0│ 1.8e+1  2.2e+1  2.6e+1 ││
    ││      │ 6.6e+1  7.0e+1  7.4e+1 ││
    │└──────┴────────────────────────┘│
    └─────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => c|a->d" in
  Train.forward_and_forget backend ctx ho2;
  (* Axis 5 of hey2, i.e. d in the einsum spec, has the lowest variation (progresses by 1), that's
     why axis 1 of ho2 appears nearly constant. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4|2:2->1:5                                              │
    │┌──────┬────────────────┬────────────────┬────────────────┬────────────────┐│
    ││      │0 @ 0           │1 @ 0           │2 @ 0           │3 @ 0           ││
    ││      │axis 2          │axis 2          │axis 2          │axis 2          ││
    │├──────┼────────────────┼────────────────┼────────────────┼────────────────┤│
    ││axis 1│ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 ││
    ││      │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 ││
    ││      │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 ││
    ││      │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 ││
    ││      │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 │ 1.6e+5  4.8e+5 ││
    │└──────┴────────────────┴────────────────┴────────────────┴────────────────┘│
    └────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum outer product" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 3 ] () in
  let%op c = (a + 1) *+ "i; j => i->j" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌──────────────────┐
    │[0]: r2 shape 0:2 │
    │┌┬──────────┐     │
    │││axis 0    │     │
    │├┼──────────┤     │
    │││ 0.0  1.0 │     │
    │└┴──────────┘     │
    └──────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────┐
    │[1]: r3 shape 0:3 │
    │┌┬───────────────┐│
    │││axis 0         ││
    │├┼───────────────┤│
    │││ 0.0  1.0  2.0 ││
    │└┴───────────────┘│
    └──────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────┐
    │[4]: ;=>_c shape 1:2->0:3 │
    │┌──────┬──────────┐       │
    ││      │axis 1    │       │
    │├──────┼──────────┤       │
    ││axis 0│ 0.0  0.0 │       │
    ││      │ 1.0  2.0 │       │
    ││      │ 2.0  4.0 │       │
    │└──────┴──────────┘       │
    └──────────────────────────┘
    |}];
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 5 ] ~input_dims:[ 6 ] ~output_dims:[ 7 ] () in
  let%op c = a *+ "i|j->k; l|m->n => il|jm->kn" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[5]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: r5x7x6 shape 0:5|2:6->1:7                                                                                                                                                                        │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││      │0 @ 0                                │1 @ 0                                │2 @ 0                                │3 @ 0                                │4 @ 0                                ││
    ││      │axis 2                               │axis 2                               │axis 2                               │axis 2                               │axis 2                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││axis 1│ 0.0     1.0     ...  4.0     5.0    │ 4.2e+1  4.3e+1  ...  4.6e+1  4.7e+1 │ 8.4e+1  8.5e+1  ...  8.8e+1  8.9e+1 │ 1.3e+2  1.3e+2  ...  1.3e+2  1.3e+2 │ 1.7e+2  1.7e+2  ...  1.7e+2  1.7e+2 ││
    ││      │ 6.0     7.0     ...  1.0e+1  1.1e+1 │ 4.8e+1  4.9e+1  ...  5.2e+1  5.3e+1 │ 9.0e+1  9.1e+1  ...  9.4e+1  9.5e+1 │ 1.3e+2  1.3e+2  ...  1.4e+2  1.4e+2 │ 1.7e+2  1.8e+2  ...  1.8e+2  1.8e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 3.0e+1  3.1e+1  ...  3.4e+1  3.5e+1 │ 7.2e+1  7.3e+1  ...  7.6e+1  7.7e+1 │ 1.1e+2  1.2e+2  ...  1.2e+2  1.2e+2 │ 1.6e+2  1.6e+2  ...  1.6e+2  1.6e+2 │ 2.0e+2  2.0e+2  ...  2.0e+2  2.0e+2 ││
    ││      │ 3.6e+1  3.7e+1  ...  4.0e+1  4.1e+1 │ 7.8e+1  7.9e+1  ...  8.2e+1  8.3e+1 │ 1.2e+2  1.2e+2  ...  1.2e+2  1.3e+2 │ 1.6e+2  1.6e+2  ...  1.7e+2  1.7e+2 │ 2.0e+2  2.1e+2  ...  2.1e+2  2.1e+2 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[7]: ;=>_c shape 0:2,1:5|4:3,5:6->2:4,3:7                                                                                 │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0  0.0  ...  0.0  0.0             │ 0.0     1.0     ...  4.0     5.0    │ 0.0     2.0     ...  8.0     1.0e+1 ││
    ││axis 3│ 0.0  0.0  ...  0.0  0.0             │ 6.0     7.0     ...  1.0e+1  1.1e+1 │ 1.2e+1  1.4e+1  ...  2.0e+1  2.2e+1 ││
    ││      │ ...  ...  ...  ...  ...             │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 3.0e+1  3.1e+1  ...  3.4e+1  3.5e+1 │ 6.0e+1  6.2e+1  ...  6.8e+1  7.0e+1 ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 3.6e+1  3.7e+1  ...  4.0e+1  4.1e+1 │ 7.2e+1  7.4e+1  ...  8.0e+1  8.2e+1 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 0.0     3.0     ...  1.2e+1  1.5e+1 │ 0.0     4.0     ...  1.6e+1  2.0e+1 │ 0.0     5.0     ...  2.0e+1  2.5e+1 ││
    ││axis 3│ 1.8e+1  2.1e+1  ...  3.0e+1  3.3e+1 │ 2.4e+1  2.8e+1  ...  4.0e+1  4.4e+1 │ 3.0e+1  3.5e+1  ...  5.0e+1  5.5e+1 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 9.0e+1  9.3e+1  ...  1.0e+2  1.1e+2 │ 1.2e+2  1.2e+2  ...  1.4e+2  1.4e+2 │ 1.5e+2  1.6e+2  ...  1.7e+2  1.8e+2 ││
    ││      │ 1.1e+2  1.1e+2  ...  1.2e+2  1.2e+2 │ 1.4e+2  1.5e+2  ...  1.6e+2  1.6e+2 │ 1.8e+2  1.9e+2  ...  2.0e+2  2.1e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 0.0     6.0     ...  2.4e+1  3.0e+1 │ 0.0     7.0     ...  2.8e+1  3.5e+1 │ 0.0     8.0     ...  3.2e+1  4.0e+1 ││
    ││axis 3│ 3.6e+1  4.2e+1  ...  6.0e+1  6.6e+1 │ 4.2e+1  4.9e+1  ...  7.0e+1  7.7e+1 │ 4.8e+1  5.6e+1  ...  8.0e+1  8.8e+1 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.8e+2  1.9e+2  ...  2.0e+2  2.1e+2 │ 2.1e+2  2.2e+2  ...  2.4e+2  2.5e+2 │ 2.4e+2  2.5e+2  ...  2.7e+2  2.8e+2 ││
    ││      │ 2.2e+2  2.2e+2  ...  2.4e+2  2.5e+2 │ 2.5e+2  2.6e+2  ...  2.8e+2  2.9e+2 │ 2.9e+2  3.0e+2  ...  3.2e+2  3.3e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 0.0     9.0     ...  3.6e+1  4.5e+1 │ 0.0     1.0e+1  ...  4.0e+1  5.0e+1 │ 0.0     1.1e+1  ...  4.4e+1  5.5e+1 ││
    ││axis 3│ 5.4e+1  6.3e+1  ...  9.0e+1  9.9e+1 │ 6.0e+1  7.0e+1  ...  1.0e+2  1.1e+2 │ 6.6e+1  7.7e+1  ...  1.1e+2  1.2e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.7e+2  2.8e+2  ...  3.1e+2  3.2e+2 │ 3.0e+2  3.1e+2  ...  3.4e+2  3.5e+2 │ 3.3e+2  3.4e+2  ...  3.7e+2  3.9e+2 ││
    ││      │ 3.2e+2  3.3e+2  ...  3.6e+2  3.7e+2 │ 3.6e+2  3.7e+2  ...  4.0e+2  4.1e+2 │ 4.0e+2  4.1e+2  ...  4.4e+2  4.5e+2 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0  0.0  ...  0.0  0.0             │ 4.2e+1  4.3e+1  ...  4.6e+1  4.7e+1 │ 8.4e+1  8.6e+1  ...  9.2e+1  9.4e+1 ││
    ││axis 3│ 0.0  0.0  ...  0.0  0.0             │ 4.8e+1  4.9e+1  ...  5.2e+1  5.3e+1 │ 9.6e+1  9.8e+1  ...  1.0e+2  1.1e+2 ││
    ││      │ ...  ...  ...  ...  ...             │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 7.2e+1  7.3e+1  ...  7.6e+1  7.7e+1 │ 1.4e+2  1.5e+2  ...  1.5e+2  1.5e+2 ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 7.8e+1  7.9e+1  ...  8.2e+1  8.3e+1 │ 1.6e+2  1.6e+2  ...  1.6e+2  1.7e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.3e+2  1.3e+2  ...  1.4e+2  1.4e+2 │ 1.7e+2  1.7e+2  ...  1.8e+2  1.9e+2 │ 2.1e+2  2.2e+2  ...  2.3e+2  2.4e+2 ││
    ││axis 3│ 1.4e+2  1.5e+2  ...  1.6e+2  1.6e+2 │ 1.9e+2  2.0e+2  ...  2.1e+2  2.1e+2 │ 2.4e+2  2.5e+2  ...  2.6e+2  2.7e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 2.2e+2  2.2e+2  ...  2.3e+2  2.3e+2 │ 2.9e+2  2.9e+2  ...  3.0e+2  3.1e+2 │ 3.6e+2  3.7e+2  ...  3.8e+2  3.9e+2 ││
    ││      │ 2.3e+2  2.4e+2  ...  2.5e+2  2.5e+2 │ 3.1e+2  3.2e+2  ...  3.3e+2  3.3e+2 │ 3.9e+2  4.0e+2  ...  4.1e+2  4.2e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 2.5e+2  2.6e+2  ...  2.8e+2  2.8e+2 │ 2.9e+2  3.0e+2  ...  3.2e+2  3.3e+2 │ 3.4e+2  3.4e+2  ...  3.7e+2  3.8e+2 ││
    ││axis 3│ 2.9e+2  2.9e+2  ...  3.1e+2  3.2e+2 │ 3.4e+2  3.4e+2  ...  3.6e+2  3.7e+2 │ 3.8e+2  3.9e+2  ...  4.2e+2  4.2e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 4.3e+2  4.4e+2  ...  4.6e+2  4.6e+2 │ 5.0e+2  5.1e+2  ...  5.3e+2  5.4e+2 │ 5.8e+2  5.8e+2  ...  6.1e+2  6.2e+2 ││
    ││      │ 4.7e+2  4.7e+2  ...  4.9e+2  5.0e+2 │ 5.5e+2  5.5e+2  ...  5.7e+2  5.8e+2 │ 6.2e+2  6.3e+2  ...  6.6e+2  6.6e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 3.8e+2  3.9e+2  ...  4.1e+2  4.2e+2 │ 4.2e+2  4.3e+2  ...  4.6e+2  4.7e+2 │ 4.6e+2  4.7e+2  ...  5.1e+2  5.2e+2 ││
    ││axis 3│ 4.3e+2  4.4e+2  ...  4.7e+2  4.8e+2 │ 4.8e+2  4.9e+2  ...  5.2e+2  5.3e+2 │ 5.3e+2  5.4e+2  ...  5.7e+2  5.8e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 6.5e+2  6.6e+2  ...  6.8e+2  6.9e+2 │ 7.2e+2  7.3e+2  ...  7.6e+2  7.7e+2 │ 7.9e+2  8.0e+2  ...  8.4e+2  8.5e+2 ││
    ││      │ 7.0e+2  7.1e+2  ...  7.4e+2  7.5e+2 │ 7.8e+2  7.9e+2  ...  8.2e+2  8.3e+2 │ 8.6e+2  8.7e+2  ...  9.0e+2  9.1e+2 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0  0.0  ...  0.0  0.0             │ 8.4e+1  8.5e+1  ...  8.8e+1  8.9e+1 │ 1.7e+2  1.7e+2  ...  1.8e+2  1.8e+2 ││
    ││axis 3│ 0.0  0.0  ...  0.0  0.0             │ 9.0e+1  9.1e+1  ...  9.4e+1  9.5e+1 │ 1.8e+2  1.8e+2  ...  1.9e+2  1.9e+2 ││
    ││      │ ...  ...  ...  ...  ...             │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 1.1e+2  1.2e+2  ...  1.2e+2  1.2e+2 │ 2.3e+2  2.3e+2  ...  2.4e+2  2.4e+2 ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 1.2e+2  1.2e+2  ...  1.2e+2  1.3e+2 │ 2.4e+2  2.4e+2  ...  2.5e+2  2.5e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 2.5e+2  2.6e+2  ...  2.6e+2  2.7e+2 │ 3.4e+2  3.4e+2  ...  3.5e+2  3.6e+2 │ 4.2e+2  4.3e+2  ...  4.4e+2  4.5e+2 ││
    ││axis 3│ 2.7e+2  2.7e+2  ...  2.8e+2  2.9e+2 │ 3.6e+2  3.6e+2  ...  3.8e+2  3.8e+2 │ 4.5e+2  4.6e+2  ...  4.7e+2  4.8e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 3.4e+2  3.5e+2  ...  3.5e+2  3.6e+2 │ 4.6e+2  4.6e+2  ...  4.7e+2  4.8e+2 │ 5.7e+2  5.8e+2  ...  5.9e+2  6.0e+2 ││
    ││      │ 3.6e+2  3.6e+2  ...  3.7e+2  3.8e+2 │ 4.8e+2  4.8e+2  ...  5.0e+2  5.0e+2 │ 6.0e+2  6.1e+2  ...  6.2e+2  6.3e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 5.0e+2  5.1e+2  ...  5.3e+2  5.3e+2 │ 5.9e+2  6.0e+2  ...  6.2e+2  6.2e+2 │ 6.7e+2  6.8e+2  ...  7.0e+2  7.1e+2 ││
    ││axis 3│ 5.4e+2  5.5e+2  ...  5.6e+2  5.7e+2 │ 6.3e+2  6.4e+2  ...  6.6e+2  6.7e+2 │ 7.2e+2  7.3e+2  ...  7.5e+2  7.6e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 6.8e+2  6.9e+2  ...  7.1e+2  7.1e+2 │ 8.0e+2  8.1e+2  ...  8.3e+2  8.3e+2 │ 9.1e+2  9.2e+2  ...  9.4e+2  9.5e+2 ││
    ││      │ 7.2e+2  7.3e+2  ...  7.4e+2  7.5e+2 │ 8.4e+2  8.5e+2  ...  8.7e+2  8.8e+2 │ 9.6e+2  9.7e+2  ...  9.9e+2  1.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 7.6e+2  7.7e+2  ...  7.9e+2  8.0e+2 │ 8.4e+2  8.5e+2  ...  8.8e+2  8.9e+2 │ 9.2e+2  9.4e+2  ...  9.7e+2  9.8e+2 ││
    ││axis 3│ 8.1e+2  8.2e+2  ...  8.5e+2  8.6e+2 │ 9.0e+2  9.1e+2  ...  9.4e+2  9.5e+2 │ 9.9e+2  1.0e+3  ...  1.0e+3  1.0e+3 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.0e+3  1.0e+3  ...  1.1e+3  1.1e+3 │ 1.1e+3  1.2e+3  ...  1.2e+3  1.2e+3 │ 1.3e+3  1.3e+3  ...  1.3e+3  1.3e+3 ││
    ││      │ 1.1e+3  1.1e+3  ...  1.1e+3  1.1e+3 │ 1.2e+3  1.2e+3  ...  1.2e+3  1.3e+3 │ 1.3e+3  1.3e+3  ...  1.4e+3  1.4e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0  0.0  ...  0.0  0.0             │ 1.3e+2  1.3e+2  ...  1.3e+2  1.3e+2 │ 2.5e+2  2.5e+2  ...  2.6e+2  2.6e+2 ││
    ││axis 3│ 0.0  0.0  ...  0.0  0.0             │ 1.3e+2  1.3e+2  ...  1.4e+2  1.4e+2 │ 2.6e+2  2.7e+2  ...  2.7e+2  2.7e+2 ││
    ││      │ ...  ...  ...  ...  ...             │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 1.6e+2  1.6e+2  ...  1.6e+2  1.6e+2 │ 3.1e+2  3.1e+2  ...  3.2e+2  3.2e+2 ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 1.6e+2  1.6e+2  ...  1.7e+2  1.7e+2 │ 3.2e+2  3.3e+2  ...  3.3e+2  3.3e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 3.8e+2  3.8e+2  ...  3.9e+2  3.9e+2 │ 5.0e+2  5.1e+2  ...  5.2e+2  5.2e+2 │ 6.3e+2  6.4e+2  ...  6.5e+2  6.6e+2 ││
    ││axis 3│ 4.0e+2  4.0e+2  ...  4.1e+2  4.1e+2 │ 5.3e+2  5.3e+2  ...  5.4e+2  5.5e+2 │ 6.6e+2  6.7e+2  ...  6.8e+2  6.9e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 4.7e+2  4.7e+2  ...  4.8e+2  4.8e+2 │ 6.2e+2  6.3e+2  ...  6.4e+2  6.4e+2 │ 7.8e+2  7.9e+2  ...  8.0e+2  8.1e+2 ││
    ││      │ 4.9e+2  4.9e+2  ...  5.0e+2  5.0e+2 │ 6.5e+2  6.5e+2  ...  6.6e+2  6.7e+2 │ 8.1e+2  8.2e+2  ...  8.3e+2  8.4e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 7.6e+2  7.6e+2  ...  7.8e+2  7.9e+2 │ 8.8e+2  8.9e+2  ...  9.1e+2  9.2e+2 │ 1.0e+3  1.0e+3  ...  1.0e+3  1.0e+3 ││
    ││axis 3│ 7.9e+2  8.0e+2  ...  8.2e+2  8.2e+2 │ 9.2e+2  9.3e+2  ...  9.5e+2  9.6e+2 │ 1.1e+3  1.1e+3  ...  1.1e+3  1.1e+3 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 9.4e+2  9.4e+2  ...  9.6e+2  9.7e+2 │ 1.1e+3  1.1e+3  ...  1.1e+3  1.1e+3 │ 1.2e+3  1.3e+3  ...  1.3e+3  1.3e+3 ││
    ││      │ 9.7e+2  9.8e+2  ...  1.0e+3  1.0e+3 │ 1.1e+3  1.1e+3  ...  1.2e+3  1.2e+3 │ 1.3e+3  1.3e+3  ...  1.3e+3  1.3e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 1.1e+3  1.1e+3  ...  1.2e+3  1.2e+3 │ 1.3e+3  1.3e+3  ...  1.3e+3  1.3e+3 │ 1.4e+3  1.4e+3  ...  1.4e+3  1.4e+3 ││
    ││axis 3│ 1.2e+3  1.2e+3  ...  1.2e+3  1.2e+3 │ 1.3e+3  1.3e+3  ...  1.4e+3  1.4e+3 │ 1.5e+3  1.5e+3  ...  1.5e+3  1.5e+3 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.4e+3  1.4e+3  ...  1.4e+3  1.4e+3 │ 1.6e+3  1.6e+3  ...  1.6e+3  1.6e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 ││
    ││      │ 1.5e+3  1.5e+3  ...  1.5e+3  1.5e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 │ 1.8e+3  1.8e+3  ...  1.8e+3  1.8e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0  0.0  ...  0.0  0.0             │ 1.7e+2  1.7e+2  ...  1.7e+2  1.7e+2 │ 3.4e+2  3.4e+2  ...  3.4e+2  3.5e+2 ││
    ││axis 3│ 0.0  0.0  ...  0.0  0.0             │ 1.7e+2  1.8e+2  ...  1.8e+2  1.8e+2 │ 3.5e+2  3.5e+2  ...  3.6e+2  3.6e+2 ││
    ││      │ ...  ...  ...  ...  ...             │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 2.0e+2  2.0e+2  ...  2.0e+2  2.0e+2 │ 4.0e+2  4.0e+2  ...  4.0e+2  4.1e+2 ││
    ││      │ 0.0  0.0  ...  0.0  0.0             │ 2.0e+2  2.1e+2  ...  2.1e+2  2.1e+2 │ 4.1e+2  4.1e+2  ...  4.2e+2  4.2e+2 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 5.0e+2  5.1e+2  ...  5.2e+2  5.2e+2 │ 6.7e+2  6.8e+2  ...  6.9e+2  6.9e+2 │ 8.4e+2  8.5e+2  ...  8.6e+2  8.7e+2 ││
    ││axis 3│ 5.2e+2  5.3e+2  ...  5.3e+2  5.4e+2 │ 7.0e+2  7.0e+2  ...  7.1e+2  7.2e+2 │ 8.7e+2  8.8e+2  ...  8.9e+2  9.0e+2 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 5.9e+2  6.0e+2  ...  6.1e+2  6.1e+2 │ 7.9e+2  8.0e+2  ...  8.1e+2  8.1e+2 │ 9.9e+2  1.0e+3  ...  1.0e+3  1.0e+3 ││
    ││      │ 6.1e+2  6.2e+2  ...  6.2e+2  6.3e+2 │ 8.2e+2  8.2e+2  ...  8.3e+2  8.4e+2 │ 1.0e+3  1.0e+3  ...  1.0e+3  1.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││2 @ 2 │ 1.0e+3  1.0e+3  ...  1.0e+3  1.0e+3 │ 1.2e+3  1.2e+3  ...  1.2e+3  1.2e+3 │ 1.3e+3  1.4e+3  ...  1.4e+3  1.4e+3 ││
    ││axis 3│ 1.0e+3  1.1e+3  ...  1.1e+3  1.1e+3 │ 1.2e+3  1.2e+3  ...  1.2e+3  1.3e+3 │ 1.4e+3  1.4e+3  ...  1.4e+3  1.4e+3 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.2e+3  1.2e+3  ...  1.2e+3  1.2e+3 │ 1.4e+3  1.4e+3  ...  1.4e+3  1.4e+3 │ 1.6e+3  1.6e+3  ...  1.6e+3  1.6e+3 ││
    ││      │ 1.2e+3  1.2e+3  ...  1.2e+3  1.3e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││3 @ 2 │ 1.5e+3  1.5e+3  ...  1.5e+3  1.6e+3 │ 1.7e+3  1.7e+3  ...  1.7e+3  1.7e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  1.9e+3 ││
    ││axis 3│ 1.6e+3  1.6e+3  ...  1.6e+3  1.6e+3 │ 1.7e+3  1.8e+3  ...  1.8e+3  1.8e+3 │ 1.9e+3  1.9e+3  ...  2.0e+3  2.0e+3 ││
    ││      │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    │ ...     ...     ...  ...     ...    ││
    ││      │ 1.8e+3  1.8e+3  ...  1.8e+3  1.8e+3 │ 2.0e+3  2.0e+3  ...  2.0e+3  2.0e+3 │ 2.2e+3  2.2e+3  ...  2.2e+3  2.2e+3 ││
    ││      │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 2.0e+3  2.1e+3  ...  2.1e+3  2.1e+3 │ 2.2e+3  2.3e+3  ...  2.3e+3  2.3e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum matrix/inner+outer products" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 4 ] ~output_dims:[ 5 ] () in
  let%op a2 = a *+ "b|i->o; b|i->o => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx a2 in
  let%op c = b *+ "b|h->o; b|i->h => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx c in
  let%op d = a *+ "a|i->h; b|h->o => ab|i->o" b in
  Train.forward_and_forget backend ctx d;
  let%op e = a *+ "b|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx e;
  let%op f = a *+ "a|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[2]: ;=>_a2 shape 0:2|2:3->1:4                            │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0                   │1 @ 0                   ││
    ││      │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0     1.0     4.0    │ 1.4e+2  1.7e+2  2.0e+2 ││
    ││      │ 9.0     1.6e+1  2.5e+1 │ 2.3e+2  2.6e+2  2.9e+2 ││
    ││      │ 3.6e+1  4.9e+1  6.4e+1 │ 3.2e+2  3.6e+2  4.0e+2 ││
    ││      │ 8.1e+1  1.0e+2  1.2e+2 │ 4.4e+2  4.8e+2  5.3e+2 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[3]: ;=>_c shape 0:2|2:3->1:5                             │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0                   │1 @ 0                   ││
    ││      │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 4.2e+1  4.8e+1  5.4e+1 │ 1.4e+3  1.5e+3  1.6e+3 ││
    ││      │ 1.1e+2  1.4e+2  1.6e+2 │ 1.7e+3  1.8e+3  1.9e+3 ││
    ││      │ 1.9e+2  2.2e+2  2.6e+2 │ 2.0e+3  2.1e+3  2.2e+3 ││
    ││      │ 2.6e+2  3.1e+2  3.7e+2 │ 2.2e+3  2.4e+3  2.5e+3 ││
    ││      │ 3.3e+2  4.0e+2  4.7e+2 │ 2.5e+3  2.6e+3  2.8e+3 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[4]: ;=>_d shape 0:2,1:2|3:3->2:5                         │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 1                   │1 @ 1                   ││
    ││      │axis 3                  │axis 3                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││0 @ 0 │ 4.2e+1  4.8e+1  5.4e+1 │ 4.0e+2  4.9e+2  5.7e+2 ││
    ││axis 2│ 1.1e+2  1.4e+2  1.6e+2 │ 4.7e+2  5.8e+2  6.8e+2 ││
    ││      │ 1.9e+2  2.2e+2  2.6e+2 │ 5.5e+2  6.6e+2  7.8e+2 ││
    ││      │ 2.6e+2  3.1e+2  3.7e+2 │ 6.2e+2  7.5e+2  8.9e+2 ││
    ││      │ 3.3e+2  4.0e+2  4.7e+2 │ 6.9e+2  8.4e+2  9.9e+2 ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││1 @ 0 │ 1.1e+2  1.2e+2  1.3e+2 │ 1.4e+3  1.5e+3  1.6e+3 ││
    ││axis 2│ 3.8e+2  4.0e+2  4.2e+2 │ 1.7e+3  1.8e+3  1.9e+3 ││
    ││      │ 6.4e+2  6.8e+2  7.2e+2 │ 2.0e+3  2.1e+3  2.2e+3 ││
    ││      │ 9.1e+2  9.6e+2  1.0e+3 │ 2.2e+3  2.4e+3  2.5e+3 ││
    ││      │ 1.2e+3  1.2e+3  1.3e+3 │ 2.5e+3  2.6e+3  2.8e+3 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌─────────────────────────────────┐
    │[5]: ;=>_e shape 1:3->0:5        │
    │┌──────┬────────────────────────┐│
    ││      │axis 1                  ││
    │├──────┼────────────────────────┤│
    ││axis 0│ 1.5e+3  1.6e+3  1.7e+3 ││
    ││      │ 1.8e+3  1.9e+3  2.1e+3 ││
    ││      │ 2.1e+3  2.3e+3  2.5e+3 ││
    ││      │ 2.5e+3  2.7e+3  2.9e+3 ││
    ││      │ 2.8e+3  3.0e+3  3.3e+3 ││
    │└──────┴────────────────────────┘│
    └─────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────┐
    │[6]: ;=>_f shape 1:3->0:5        │
    │┌──────┬────────────────────────┐│
    ││      │axis 1                  ││
    │├──────┼────────────────────────┤│
    ││axis 0│ 2.0e+3  2.2e+3  2.4e+3 ││
    ││      │ 2.7e+3  2.9e+3  3.2e+3 ││
    ││      │ 3.3e+3  3.6e+3  4.0e+3 ││
    ││      │ 4.0e+3  4.4e+3  4.8e+3 ││
    ││      │ 4.7e+3  5.1e+3  5.6e+3 ││
    │└──────┴────────────────────────┘│
    └─────────────────────────────────┘
    |}]

let%expect_test "einsum1 broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|i->o => ...|o->i" in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|2:4->1:3                                    │
    │┌──────┬───────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0                  │1 @ 0                           ││
    ││      │axis 2                 │axis 2                          ││
    │├──────┼───────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.0  3.0  6.0  9.0    │ 1.2e+1  1.5e+1  1.8e+1  2.1e+1 ││
    ││      │ 1.0  4.0  7.0  1.0e+1 │ 1.3e+1  1.6e+1  1.9e+1  2.2e+1 ││
    ││      │ 2.0  5.0  8.0  1.1e+1 │ 1.4e+1  1.7e+1  2.0e+1  2.3e+1 ││
    │└──────┴───────────────────────┴────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "b|...->o => o|...->b" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:4|2:3->1:2                                                                              │
    │┌──────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0                   │1 @ 0                   │2 @ 0                   │3 @ 0                   ││
    ││      │axis 2                  │axis 2                  │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0     1.0     2.0    │ 3.0     4.0     5.0    │ 6.0     7.0     8.0    │ 9.0     1.0e+1  1.1e+1 ││
    ││      │ 1.2e+1  1.3e+1  1.4e+1 │ 1.5e+1  1.6e+1  1.7e+1 │ 1.8e+1  1.9e+1  2.0e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴────────────────────────┴────────────────────────┴────────────────────────┴────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho3 = hey2 ++ "...b|...i->...o => ...i|...o->...b" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                            │
    │┌──────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                   │1 @ 4                                   │2 @ 4                                   │3 @ 4                                   ││
    ││      │axis 5                                  │axis 5                                  │axis 5                                  │axis 5                                  ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││0 @ 2 │ 0.0     1.0     2.0     3.0     4.0    │ 5.0     6.0     7.0     8.0     9.0    │ 1.0e+1  1.1e+1  1.2e+1  1.3e+1  1.4e+1 │ 1.5e+1  1.6e+1  1.7e+1  1.8e+1  1.9e+1 ││
    ││axis 3│ 2.0e+1  2.1e+1  2.2e+1  2.3e+1  2.4e+1 │ 2.5e+1  2.6e+1  2.7e+1  2.8e+1  2.9e+1 │ 3.0e+1  3.1e+1  3.2e+1  3.3e+1  3.4e+1 │ 3.5e+1  3.6e+1  3.7e+1  3.8e+1  3.9e+1 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.0e+2  1.0e+2  1.0e+2  1.0e+2  1.0e+2 │ 1.1e+2  1.1e+2  1.1e+2  1.1e+2  1.1e+2 │ 1.1e+2  1.1e+2  1.1e+2  1.1e+2  1.1e+2 │ 1.2e+2  1.2e+2  1.2e+2  1.2e+2  1.2e+2 ││
    ││      │ 1.2e+2  1.2e+2  1.2e+2  1.2e+2  1.2e+2 │ 1.3e+2  1.3e+2  1.3e+2  1.3e+2  1.3e+2 │ 1.3e+2  1.3e+2  1.3e+2  1.3e+2  1.3e+2 │ 1.4e+2  1.4e+2  1.4e+2  1.4e+2  1.4e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.4e+2  1.4e+2  1.4e+2  1.4e+2 │ 1.5e+2  1.5e+2  1.5e+2  1.5e+2  1.5e+2 │ 1.5e+2  1.5e+2  1.5e+2  1.5e+2  1.5e+2 │ 1.6e+2  1.6e+2  1.6e+2  1.6e+2  1.6e+2 ││
    ││axis 3│ 1.6e+2  1.6e+2  1.6e+2  1.6e+2  1.6e+2 │ 1.7e+2  1.7e+2  1.7e+2  1.7e+2  1.7e+2 │ 1.7e+2  1.7e+2  1.7e+2  1.7e+2  1.7e+2 │ 1.8e+2  1.8e+2  1.8e+2  1.8e+2  1.8e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 2.4e+2  2.4e+2  2.4e+2  2.4e+2  2.4e+2 │ 2.5e+2  2.5e+2  2.5e+2  2.5e+2  2.5e+2 │ 2.5e+2  2.5e+2  2.5e+2  2.5e+2  2.5e+2 │ 2.6e+2  2.6e+2  2.6e+2  2.6e+2  2.6e+2 ││
    ││      │ 2.6e+2  2.6e+2  2.6e+2  2.6e+2  2.6e+2 │ 2.7e+2  2.7e+2  2.7e+2  2.7e+2  2.7e+2 │ 2.7e+2  2.7e+2  2.7e+2  2.7e+2  2.7e+2 │ 2.8e+2  2.8e+2  2.8e+2  2.8e+2  2.8e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││~~~~~ │ ...                                    │ ...                                    │ ...                                    │ ...                                    ││
    ││axis 3│                                        │                                        │                                        │                                        ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.6e+2  5.6e+2  5.6e+2  5.6e+2 │ 5.7e+2  5.7e+2  5.7e+2  5.7e+2  5.7e+2 │ 5.7e+2  5.7e+2  5.7e+2  5.7e+2  5.7e+2 │ 5.8e+2  5.8e+2  5.8e+2  5.8e+2  5.8e+2 ││
    ││axis 3│ 5.8e+2  5.8e+2  5.8e+2  5.8e+2  5.8e+2 │ 5.9e+2  5.9e+2  5.9e+2  5.9e+2  5.9e+2 │ 5.9e+2  5.9e+2  5.9e+2  5.9e+2  5.9e+2 │ 6.0e+2  6.0e+2  6.0e+2  6.0e+2  6.0e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 6.6e+2  6.6e+2  6.6e+2  6.6e+2  6.6e+2 │ 6.7e+2  6.7e+2  6.7e+2  6.7e+2  6.7e+2 │ 6.7e+2  6.7e+2  6.7e+2  6.7e+2  6.7e+2 │ 6.8e+2  6.8e+2  6.8e+2  6.8e+2  6.8e+2 ││
    ││      │ 6.8e+2  6.8e+2  6.8e+2  6.8e+2  6.8e+2 │ 6.9e+2  6.9e+2  6.9e+2  6.9e+2  6.9e+2 │ 6.9e+2  6.9e+2  6.9e+2  6.9e+2  6.9e+2 │ 7.0e+2  7.0e+2  7.0e+2  7.0e+2  7.0e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.0e+2  7.0e+2  7.0e+2  7.0e+2 │ 7.1e+2  7.1e+2  7.1e+2  7.1e+2  7.1e+2 │ 7.1e+2  7.1e+2  7.1e+2  7.1e+2  7.1e+2 │ 7.2e+2  7.2e+2  7.2e+2  7.2e+2  7.2e+2 ││
    ││axis 3│ 7.2e+2  7.2e+2  7.2e+2  7.2e+2  7.2e+2 │ 7.3e+2  7.3e+2  7.3e+2  7.3e+2  7.3e+2 │ 7.3e+2  7.3e+2  7.3e+2  7.3e+2  7.3e+2 │ 7.4e+2  7.4e+2  7.4e+2  7.4e+2  7.4e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 8.0e+2  8.0e+2  8.0e+2  8.0e+2  8.0e+2 │ 8.1e+2  8.1e+2  8.1e+2  8.1e+2  8.1e+2 │ 8.1e+2  8.1e+2  8.1e+2  8.1e+2  8.1e+2 │ 8.2e+2  8.2e+2  8.2e+2  8.2e+2  8.2e+2 ││
    ││      │ 8.2e+2  8.2e+2  8.2e+2  8.2e+2  8.2e+2 │ 8.3e+2  8.3e+2  8.3e+2  8.3e+2  8.3e+2 │ 8.3e+2  8.3e+2  8.3e+2  8.3e+2  8.3e+2 │ 8.4e+2  8.4e+2  8.4e+2  8.4e+2  8.4e+2 ││
    │└──────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                   │1 @ 4                                   │2 @ 4                                   │3 @ 4                                   ││
    ││      │axis 5                                  │axis 5                                  │axis 5                                  │axis 5                                  ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││0 @ 2 │ 8.4e+2  8.4e+2  8.4e+2  8.4e+2  8.4e+2 │ 8.5e+2  8.5e+2  8.5e+2  8.5e+2  8.5e+2 │ 8.5e+2  8.5e+2  8.5e+2  8.5e+2  8.5e+2 │ 8.6e+2  8.6e+2  8.6e+2  8.6e+2  8.6e+2 ││
    ││axis 3│ 8.6e+2  8.6e+2  8.6e+2  8.6e+2  8.6e+2 │ 8.7e+2  8.7e+2  8.7e+2  8.7e+2  8.7e+2 │ 8.7e+2  8.7e+2  8.7e+2  8.7e+2  8.7e+2 │ 8.8e+2  8.8e+2  8.8e+2  8.8e+2  8.8e+2 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 9.4e+2  9.4e+2  9.4e+2  9.4e+2  9.4e+2 │ 9.5e+2  9.5e+2  9.5e+2  9.5e+2  9.5e+2 │ 9.5e+2  9.5e+2  9.5e+2  9.5e+2  9.5e+2 │ 9.6e+2  9.6e+2  9.6e+2  9.6e+2  9.6e+2 ││
    ││      │ 9.6e+2  9.6e+2  9.6e+2  9.6e+2  9.6e+2 │ 9.7e+2  9.7e+2  9.7e+2  9.7e+2  9.7e+2 │ 9.7e+2  9.7e+2  9.7e+2  9.7e+2  9.7e+2 │ 9.8e+2  9.8e+2  9.8e+2  9.8e+2  9.8e+2 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││1 @ 2 │ 9.8e+2  9.8e+2  9.8e+2  9.8e+2  9.8e+2 │ 9.9e+2  9.9e+2  9.9e+2  9.9e+2  9.9e+2 │ 9.9e+2  9.9e+2  9.9e+2  9.9e+2  9.9e+2 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 ││
    ││axis 3│ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 │ 1.0e+3  1.0e+3  1.0e+3  1.0e+3  1.0e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 ││
    ││      │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 │ 1.1e+3  1.1e+3  1.1e+3  1.1e+3  1.1e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││~~~~~ │ ...                                    │ ...                                    │ ...                                    │ ...                                    ││
    ││axis 3│                                        │                                        │                                        │                                        ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││4 @ 2 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 ││
    ││axis 3│ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 │ 1.4e+3  1.4e+3  1.4e+3  1.4e+3  1.4e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 ││
    ││      │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││5 @ 2 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.5e+3  1.5e+3  1.5e+3  1.5e+3  1.5e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 ││
    ││axis 3│ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.6e+3  1.6e+3  1.6e+3  1.6e+3  1.6e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    ││      │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    │└──────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┬────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                   │1 @ 4                                   │2 @ 4                                   │3 @ 4                                   ││
    ││      │axis 5                                  │axis 5                                  │axis 5                                  │axis 5                                  ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││0 @ 2 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    ││axis 3│ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 │ 1.7e+3  1.7e+3  1.7e+3  1.7e+3  1.7e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 ││
    ││      │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││1 @ 2 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 ││
    ││axis 3│ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.8e+3  1.8e+3  1.8e+3  1.8e+3  1.8e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 ││
    ││      │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 1.9e+3  1.9e+3  1.9e+3  1.9e+3  1.9e+3 │ 2.0e+3  2.0e+3  2.0e+3  2.0e+3  2.0e+3 │ 2.0e+3  2.0e+3  2.0e+3  2.0e+3  2.0e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││~~~~~ │ ...                                    │ ...                                    │ ...                                    │ ...                                    ││
    ││axis 3│                                        │                                        │                                        │                                        ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││4 @ 2 │ 2.2e+3  2.2e+3  2.2e+3  2.2e+3  2.2e+3 │ 2.2e+3  2.2e+3  2.2e+3  2.2e+3  2.2e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 ││
    ││axis 3│ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.3e+3  2.3e+3  2.3e+3  2.3e+3  2.3e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    ││      │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    │├──────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┼────────────────────────────────────────┤│
    ││5 @ 2 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    ││axis 3│ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 │ 2.4e+3  2.4e+3  2.4e+3  2.4e+3  2.4e+3 ││
    ││      │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    │ ...     ...     ...     ...     ...    ││
    ││      │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 ││
    ││      │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 │ 2.5e+3  2.5e+3  2.5e+3  2.5e+3  2.5e+3 ││
    │└──────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┴────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: =>_ho3 shape 0:2,1:5|4:4,5:7->2:6,3:3                                                                                                                      │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                │3 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 0.0     2.0e+1  ...  1.0e+2  1.2e+2 │ 5.0     2.5e+1  ...  1.1e+2  1.3e+2 │ 1.0e+1  3.0e+1  ...  1.1e+2  1.3e+2 │ 1.5e+1  3.5e+1  ...  1.2e+2  1.4e+2 ││
    ││axis 3│ 8.4e+2  8.6e+2  ...  9.4e+2  9.6e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.6e+2  8.8e+2  ...  9.6e+2  9.8e+2 ││
    ││      │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.6e+2  ...  2.4e+2  2.6e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.6e+2  1.8e+2  ...  2.6e+2  2.8e+2 ││
    ││axis 3│ 9.8e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 1.0e+3  1.0e+3  ...  1.1e+3  1.1e+3 ││
    ││      │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...                                 │ ...                                 ││
    ││axis 3│                                     │                                     │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.8e+2  ...  6.6e+2  6.8e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.8e+2  6.0e+2  ...  6.8e+2  7.0e+2 ││
    ││axis 3│ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 ││
    ││      │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.2e+2  ...  8.0e+2  8.2e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.2e+2  7.4e+2  ...  8.2e+2  8.4e+2 ││
    ││axis 3│ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 ││
    ││      │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                │3 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 1.0     2.1e+1  ...  1.0e+2  1.2e+2 │ 6.0     2.6e+1  ...  1.1e+2  1.3e+2 │ 1.1e+1  3.1e+1  ...  1.1e+2  1.3e+2 │ 1.6e+1  3.6e+1  ...  1.2e+2  1.4e+2 ││
    ││axis 3│ 8.4e+2  8.6e+2  ...  9.4e+2  9.6e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.6e+2  8.8e+2  ...  9.6e+2  9.8e+2 ││
    ││      │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.6e+2  ...  2.4e+2  2.6e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.6e+2  1.8e+2  ...  2.6e+2  2.8e+2 ││
    ││axis 3│ 9.8e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 1.0e+3  1.0e+3  ...  1.1e+3  1.1e+3 ││
    ││      │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...                                 │ ...                                 ││
    ││axis 3│                                     │                                     │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.8e+2  ...  6.6e+2  6.8e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.8e+2  6.0e+2  ...  6.8e+2  7.0e+2 ││
    ││axis 3│ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 ││
    ││      │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.2e+2  ...  8.0e+2  8.2e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.2e+2  7.4e+2  ...  8.2e+2  8.4e+2 ││
    ││axis 3│ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 ││
    ││      │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                │3 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 2.0     2.2e+1  ...  1.0e+2  1.2e+2 │ 7.0     2.7e+1  ...  1.1e+2  1.3e+2 │ 1.2e+1  3.2e+1  ...  1.1e+2  1.3e+2 │ 1.7e+1  3.7e+1  ...  1.2e+2  1.4e+2 ││
    ││axis 3│ 8.4e+2  8.6e+2  ...  9.4e+2  9.6e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.6e+2  8.8e+2  ...  9.6e+2  9.8e+2 ││
    ││      │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.6e+2  ...  2.4e+2  2.6e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.6e+2  1.8e+2  ...  2.6e+2  2.8e+2 ││
    ││axis 3│ 9.8e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 1.0e+3  1.0e+3  ...  1.1e+3  1.1e+3 ││
    ││      │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...                                 │ ...                                 ││
    ││axis 3│                                     │                                     │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.8e+2  ...  6.6e+2  6.8e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.8e+2  6.0e+2  ...  6.8e+2  7.0e+2 ││
    ││axis 3│ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 ││
    ││      │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.2e+2  ...  8.0e+2  8.2e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.2e+2  7.4e+2  ...  8.2e+2  8.4e+2 ││
    ││axis 3│ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 ││
    ││      │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                │3 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 3.0     2.3e+1  ...  1.0e+2  1.2e+2 │ 8.0     2.8e+1  ...  1.1e+2  1.3e+2 │ 1.3e+1  3.3e+1  ...  1.1e+2  1.3e+2 │ 1.8e+1  3.8e+1  ...  1.2e+2  1.4e+2 ││
    ││axis 3│ 8.4e+2  8.6e+2  ...  9.4e+2  9.6e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.6e+2  8.8e+2  ...  9.6e+2  9.8e+2 ││
    ││      │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.6e+2  ...  2.4e+2  2.6e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.6e+2  1.8e+2  ...  2.6e+2  2.8e+2 ││
    ││axis 3│ 9.8e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 1.0e+3  1.0e+3  ...  1.1e+3  1.1e+3 ││
    ││      │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...                                 │ ...                                 ││
    ││axis 3│                                     │                                     │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.8e+2  ...  6.6e+2  6.8e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.8e+2  6.0e+2  ...  6.8e+2  7.0e+2 ││
    ││axis 3│ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 ││
    ││      │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.2e+2  ...  8.0e+2  8.2e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.2e+2  7.4e+2  ...  8.2e+2  8.4e+2 ││
    ││axis 3│ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 ││
    ││      │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                │1 @ 4                                │2 @ 4                                │3 @ 4                                ││
    ││      │axis 5                               │axis 5                               │axis 5                               │axis 5                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││0 @ 2 │ 4.0     2.4e+1  ...  1.0e+2  1.2e+2 │ 9.0     2.9e+1  ...  1.1e+2  1.3e+2 │ 1.4e+1  3.4e+1  ...  1.1e+2  1.3e+2 │ 1.9e+1  3.9e+1  ...  1.2e+2  1.4e+2 ││
    ││axis 3│ 8.4e+2  8.6e+2  ...  9.4e+2  9.6e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.5e+2  8.7e+2  ...  9.5e+2  9.7e+2 │ 8.6e+2  8.8e+2  ...  9.6e+2  9.8e+2 ││
    ││      │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 │ 1.7e+3  1.7e+3  ...  1.8e+3  1.8e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││1 @ 2 │ 1.4e+2  1.6e+2  ...  2.4e+2  2.6e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.5e+2  1.7e+2  ...  2.5e+2  2.7e+2 │ 1.6e+2  1.8e+2  ...  2.6e+2  2.8e+2 ││
    ││axis 3│ 9.8e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 9.9e+2  1.0e+3  ...  1.1e+3  1.1e+3 │ 1.0e+3  1.0e+3  ...  1.1e+3  1.1e+3 ││
    ││      │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.8e+3  ...  1.9e+3  1.9e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 │ 1.8e+3  1.9e+3  ...  1.9e+3  2.0e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││~~~~~ │ ...                                 │ ...                                 │ ...                                 │ ...                                 ││
    ││axis 3│                                     │                                     │                                     │                                     ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││4 @ 2 │ 5.6e+2  5.8e+2  ...  6.6e+2  6.8e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.7e+2  5.9e+2  ...  6.7e+2  6.9e+2 │ 5.8e+2  6.0e+2  ...  6.8e+2  7.0e+2 ││
    ││axis 3│ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 │ 1.4e+3  1.4e+3  ...  1.5e+3  1.5e+3 ││
    ││      │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.2e+3  2.3e+3  ...  2.3e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 │ 2.3e+3  2.3e+3  ...  2.4e+3  2.4e+3 ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││5 @ 2 │ 7.0e+2  7.2e+2  ...  8.0e+2  8.2e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.1e+2  7.3e+2  ...  8.1e+2  8.3e+2 │ 7.2e+2  7.4e+2  ...  8.2e+2  8.4e+2 ││
    ││axis 3│ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.5e+3  1.6e+3  ...  1.6e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 │ 1.6e+3  1.6e+3  ...  1.7e+3  1.7e+3 ││
    ││      │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 │ 2.4e+3  2.4e+3  ...  2.5e+3  2.5e+3 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let%op ho4 = hey2 ++ "...b|...i->...o => i|o->b" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:5|2:7->1:3                                                                                                                                                                        │
    │┌──────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐│
    ││      │0 @ 0                                │1 @ 0                                │2 @ 0                                │3 @ 0                                │4 @ 0                                ││
    ││      │axis 2                               │axis 2                               │axis 2                               │axis 2                               │axis 2                               ││
    │├──────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┼─────────────────────────────────────┤│
    ││axis 1│ 7.8e+4  7.9e+4  ...  8.2e+4  8.3e+4 │ 7.8e+4  7.9e+4  ...  8.2e+4  8.3e+4 │ 7.8e+4  7.9e+4  ...  8.3e+4  8.3e+4 │ 7.8e+4  7.9e+4  ...  8.3e+4  8.4e+4 │ 7.8e+4  7.9e+4  ...  8.3e+4  8.4e+4 ││
    ││      │ 1.2e+5  1.2e+5  ...  1.2e+5  1.2e+5 │ 1.2e+5  1.2e+5  ...  1.2e+5  1.2e+5 │ 1.2e+5  1.2e+5  ...  1.2e+5  1.2e+5 │ 1.2e+5  1.2e+5  ...  1.2e+5  1.2e+5 │ 1.2e+5  1.2e+5  ...  1.2e+5  1.2e+5 ││
    ││      │ 1.6e+5  1.6e+5  ...  1.6e+5  1.6e+5 │ 1.6e+5  1.6e+5  ...  1.6e+5  1.6e+5 │ 1.6e+5  1.6e+5  ...  1.6e+5  1.6e+5 │ 1.6e+5  1.6e+5  ...  1.6e+5  1.6e+5 │ 1.6e+5  1.6e+5  ...  1.6e+5  1.6e+5 ││
    │└──────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┴─────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho5 = hey ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho5;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho5;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[6]: =>_ho5 shape 0:4              │
    │┌┬────────────────────────────────┐│
    │││axis 0                          ││
    │├┼────────────────────────────────┤│
    │││ 4.2e+1  6.0e+1  7.8e+1  9.6e+1 ││
    │└┴────────────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  let hey3 = TDSL.range_of_shape ~output_dims:[ 3; 4 ] () in
  let%op ho6 = hey3 ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho6;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey3;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[7]: r3x4 shape 0:3,1:4            │
    │┌──────┬──────────────────────────┐│
    ││      │axis 1                    ││
    │├──────┼──────────────────────────┤│
    ││axis 0│ 0.0  1.0  2.0     3.0    ││
    ││      │ 4.0  5.0  6.0     7.0    ││
    ││      │ 8.0  9.0  1.0e+1  1.1e+1 ││
    │└──────┴──────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho6;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[8]: =>_ho6 shape 0:4              │
    │┌┬────────────────────────────────┐│
    │││axis 0                          ││
    │├┼────────────────────────────────┤│
    │││ 1.2e+1  1.5e+1  1.8e+1  2.1e+1 ││
    │└┴────────────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let hey4 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3; 4 ] () in
  let%op ho7 = hey4 ++ "i->...o => ...io" in
  Train.forward_and_forget backend ctx ho7;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey4;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────┐
    │[9]: r3x4x2 shape 2:2->0:3,1:4                       │
    │┌──────┬──────────┬────────────────┬────────────────┐│
    ││      │0 @ 0     │1 @ 0           │2 @ 0           ││
    ││      │axis 2    │axis 2          │axis 2          ││
    │├──────┼──────────┼────────────────┼────────────────┤│
    ││axis 1│ 0.0  1.0 │ 8.0     9.0    │ 1.6e+1  1.7e+1 ││
    ││      │ 2.0  3.0 │ 1.0e+1  1.1e+1 │ 1.8e+1  1.9e+1 ││
    ││      │ 4.0  5.0 │ 1.2e+1  1.3e+1 │ 2.0e+1  2.1e+1 ││
    ││      │ 6.0  7.0 │ 1.4e+1  1.5e+1 │ 2.2e+1  2.3e+1 ││
    │└──────┴──────────┴────────────────┴────────────────┘│
    └─────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho7;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[10]: =>_ho7 shape 0:3,1:2,2:4           │
    │┌──────┬────────────────────────────────┐│
    ││      │axis 2                          ││
    │├──────┼────────────────────────────────┤│
    ││0 @ 0 │ 0.0  2.0  4.0  6.0             ││
    ││axis 1│ 1.0  3.0  5.0  7.0             ││
    │├──────┼────────────────────────────────┤│
    ││1 @ 0 │ 8.0  1.0e+1  1.2e+1  1.4e+1    ││
    ││axis 1│ 9.0  1.1e+1  1.3e+1  1.5e+1    ││
    │├──────┼────────────────────────────────┤│
    ││2 @ 0 │ 1.6e+1  1.8e+1  2.0e+1  2.2e+1 ││
    ││axis 1│ 1.7e+1  1.9e+1  2.1e+1  2.3e+1 ││
    │└──────┴────────────────────────────────┘│
    └─────────────────────────────────────────┘
    |}]

let%expect_test "einsum broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->...; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                 │
    │┌──────┬────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0               │1 @ 0                           │2 @ 0                           ││
    ││      │axis 2              │axis 2                          │axis 2                          ││
    │├──────┼────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.0  1.0  2.0  3.0 │ 8.0     9.0     1.0e+1  1.1e+1 │ 1.6e+1  1.7e+1  1.8e+1  1.9e+1 ││
    ││      │ 4.0  5.0  6.0  7.0 │ 1.2e+1  1.3e+1  1.4e+1  1.5e+1 │ 2.0e+1  2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4 │
    │┌──────┬──────┬──────┬────────┐│
    ││      │0 @ 0 │1 @ 0 │2 @ 0   ││
    ││      │axis 2│axis 2│axis 2  ││
    │├──────┼──────┼──────┼────────┤│
    ││axis 1│ 0.0  │ 4.0  │ 8.0    ││
    ││      │ 1.0  │ 5.0  │ 9.0    ││
    ││      │ 2.0  │ 6.0  │ 1.0e+1 ││
    ││      │ 3.0  │ 7.0  │ 1.1e+1 ││
    │└──────┴──────┴──────┴────────┘│
    └───────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                 │
    │┌──────┬────────────────────────────────┐│
    ││      │axis 1                          ││
    │├──────┼────────────────────────────────┤│
    ││axis 0│ 0.0     6.0     1.6e+1  3.0e+1 ││
    ││      │ 8.0e+1  1.1e+2  1.4e+2  1.8e+2 ││
    ││      │ 2.9e+2  3.4e+2  4.0e+2  4.6e+2 ││
    │└──────┴────────────────────────────────┘│
    └─────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let d = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let e = TDSL.range_of_shape ~input_dims:[ 4 ] ~output_dims:[ 3 ] () in
  let%op f = d *+ "i->...;j->... => ...ij" e in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌─────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3 │
    │┌──────┬──────────┐      │
    ││      │axis 1    │      │
    │├──────┼──────────┤      │
    ││axis 0│ 0.0  1.0 │      │
    ││      │ 2.0  3.0 │      │
    ││      │ 4.0  5.0 │      │
    │└──────┴──────────┘      │
    └─────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌───────────────────────────────────┐
    │[4]: r3x4 shape 1:4->0:3           │
    │┌──────┬──────────────────────────┐│
    ││      │axis 1                    ││
    │├──────┼──────────────────────────┤│
    ││axis 0│ 0.0  1.0  2.0     3.0    ││
    ││      │ 4.0  5.0  6.0     7.0    ││
    ││      │ 8.0  9.0  1.0e+1  1.1e+1 ││
    │└──────┴──────────────────────────┘│
    └───────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[5]: ;=>_f shape 0:3,1:2,2:4             │
    │┌──────┬────────────────────────────────┐│
    ││      │axis 2                          ││
    │├──────┼────────────────────────────────┤│
    ││0 @ 0 │ 0.0  0.0  0.0  0.0             ││
    ││axis 1│ 0.0  1.0  2.0  3.0             ││
    │├──────┼────────────────────────────────┤│
    ││1 @ 0 │ 8.0     1.0e+1  1.2e+1  1.4e+1 ││
    ││axis 1│ 1.2e+1  1.5e+1  1.8e+1  2.1e+1 ││
    │├──────┼────────────────────────────────┤│
    ││2 @ 0 │ 3.2e+1  3.6e+1  4.0e+1  4.4e+1 ││
    ││axis 1│ 4.0e+1  4.5e+1  5.0e+1  5.5e+1 ││
    │└──────┴────────────────────────────────┘│
    └─────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 fixed dim axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|1->... => ...|..." in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:4                 │
    │┌──────┬────────────────────────────────┐│
    ││      │axis 1                          ││
    │├──────┼────────────────────────────────┤│
    ││axis 0│ 1.0     4.0     7.0     1.0e+1 ││
    ││      │ 1.3e+1  1.6e+1  1.9e+1  2.2e+1 ││
    │└──────┴────────────────────────────────┘│
    └─────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "...|...->... => ...|...->0" in
  let ctx = Train.forward_and_ctx backend ctx ho2 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                         │
    │┌──────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                   ││
    ││      │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0  1.0     2.0    │ 1.2e+1  1.3e+1  1.4e+1 ││
    ││      │ 3.0  4.0     5.0    │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 6.0  7.0     8.0    │ 1.8e+1  1.9e+1  2.0e+1 ││
    ││      │ 9.0  1.0e+1  1.1e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:2|2:3->1:1                            │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0                   │1 @ 0                   ││
    ││      │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 1.8e+1  2.2e+1  2.6e+1 │ 6.6e+1  7.0e+1  7.4e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  let hey2 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let%op ho3 = hey2 ++ "...|...->... => 0" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌─────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3 │
    │┌──────┬──────────┐      │
    ││      │axis 1    │      │
    │├──────┼──────────┤      │
    ││axis 0│ 0.0  1.0 │      │
    ││      │ 2.0  3.0 │      │
    ││      │ 4.0  5.0 │      │
    │└──────┴──────────┘      │
    └─────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌──────────────────────┐
    │[4]: =>_ho3 shape 0:1 │
    │┌┬────────┐           │
    │││axis 0  │           │
    │├┼────────┤           │
    │││ 1.5e+1 │           │
    │└┴────────┘           │
    └──────────────────────┘
    |}];
  let%op ho4 = hey2 ++ "i->j => i0j" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌──────────────────────────────┐
    │[5]: =>_ho4 shape 0:2,1:1,2:3 │
    │┌──────┬───────────────┐      │
    ││      │axis 2         │      │
    │├──────┼───────────────┤      │
    ││0 @ 0 │ 0.0  2.0  4.0 │      │
    ││axis 1│               │      │
    │├──────┼───────────────┤      │
    ││1 @ 0 │ 1.0  3.0  5.0 │      │
    ││axis 1│               │      │
    │└──────┴───────────────┘      │
    └──────────────────────────────┘
    |}]

let%expect_test "einsum with fixed dim axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->1; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                 │
    │┌──────┬────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0               │1 @ 0                           │2 @ 0                           ││
    ││      │axis 2              │axis 2                          │axis 2                          ││
    │├──────┼────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.0  1.0  2.0  3.0 │ 8.0     9.0     1.0e+1  1.1e+1 │ 1.6e+1  1.7e+1  1.8e+1  1.9e+1 ││
    ││      │ 4.0  5.0  6.0  7.0 │ 1.2e+1  1.3e+1  1.4e+1  1.5e+1 │ 2.0e+1  2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4 │
    │┌──────┬──────┬──────┬────────┐│
    ││      │0 @ 0 │1 @ 0 │2 @ 0   ││
    ││      │axis 2│axis 2│axis 2  ││
    │├──────┼──────┼──────┼────────┤│
    ││axis 1│ 0.0  │ 4.0  │ 8.0    ││
    ││      │ 1.0  │ 5.0  │ 9.0    ││
    ││      │ 2.0  │ 6.0  │ 1.0e+1 ││
    ││      │ 3.0  │ 7.0  │ 1.1e+1 ││
    │└──────┴──────┴──────┴────────┘│
    └───────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                 │
    │┌──────┬────────────────────────────────┐│
    ││      │axis 1                          ││
    │├──────┼────────────────────────────────┤│
    ││axis 0│ 0.0     5.0     1.2e+1  2.1e+1 ││
    ││      │ 4.8e+1  6.5e+1  8.4e+1  1.1e+2 ││
    ││      │ 1.6e+2  1.9e+2  2.2e+2  2.5e+2 ││
    │└──────┴────────────────────────────────┘│
    └─────────────────────────────────────────┘
    |}]

let%expect_test "outer_sum simulating axis concatenation" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let ri = TDSL.range 3 in
  let%op ti = ri ++ "i=>i0" in
  (* Write position 2 of ti, otherwise shape inference concludes it's dim-1 and broadcasted. *)
  let%cd _ = ti =: 0 ++ "i=>i2" in
  let rj = TDSL.range 4 in
  let%op tj = rj ++ "j=>j1" in
  let rk = TDSL.range 5 in
  let%op tk = rk ++ "k=>k2" in
  let positions = TDSL.outer_sum "ijl;kl=>ijkl" (TDSL.outer_sum "il;jl=>ijl" ti tj) tk in
  Train.set_hosted tk.value;
  Train.forward_and_forget backend ctx positions;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ positions;
  [%expect
    {|
    ┌────────────────────────────────┐
    │[9]: ;=>+ shape 0:4,1:5,2:6,3:3 │
    │┌──────┬───────────────┐        │
    ││0 @ 0 │axis 3         │        │
    │├──────┼───────────────┤        │
    ││0 @ 1 │ 0.0  0.0  0.0 │        │
    ││axis 2│ 0.0  0.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 0.0  0.0  4.0 │        │
    ││      │ 0.0  0.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││1 @ 1 │ 0.0  1.0  0.0 │        │
    ││axis 2│ 0.0  1.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 0.0  1.0  4.0 │        │
    ││      │ 0.0  1.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││2 @ 1 │ 0.0  2.0  0.0 │        │
    ││axis 2│ 0.0  2.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 0.0  2.0  4.0 │        │
    ││      │ 0.0  2.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││3 @ 1 │ 0.0  3.0  0.0 │        │
    ││axis 2│ 0.0  3.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 0.0  3.0  4.0 │        │
    ││      │ 0.0  3.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││4 @ 1 │ 0.0  4.0  0.0 │        │
    ││axis 2│ 0.0  4.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 0.0  4.0  4.0 │        │
    ││      │ 0.0  4.0  5.0 │        │
    │└──────┴───────────────┘        │
    ├────────────────────────────────┤
    │┌──────┬───────────────┐        │
    ││1 @ 0 │axis 3         │        │
    │├──────┼───────────────┤        │
    ││0 @ 1 │ 1.0  0.0  0.0 │        │
    ││axis 2│ 1.0  0.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 1.0  0.0  4.0 │        │
    ││      │ 1.0  0.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││1 @ 1 │ 1.0  1.0  0.0 │        │
    ││axis 2│ 1.0  1.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 1.0  1.0  4.0 │        │
    ││      │ 1.0  1.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││2 @ 1 │ 1.0  2.0  0.0 │        │
    ││axis 2│ 1.0  2.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 1.0  2.0  4.0 │        │
    ││      │ 1.0  2.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││3 @ 1 │ 1.0  3.0  0.0 │        │
    ││axis 2│ 1.0  3.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 1.0  3.0  4.0 │        │
    ││      │ 1.0  3.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││4 @ 1 │ 1.0  4.0  0.0 │        │
    ││axis 2│ 1.0  4.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 1.0  4.0  4.0 │        │
    ││      │ 1.0  4.0  5.0 │        │
    │└──────┴───────────────┘        │
    ├────────────────────────────────┤
    │┌──────┬───────────────┐        │
    ││2 @ 0 │axis 3         │        │
    │├──────┼───────────────┤        │
    ││0 @ 1 │ 2.0  0.0  0.0 │        │
    ││axis 2│ 2.0  0.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 2.0  0.0  4.0 │        │
    ││      │ 2.0  0.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││1 @ 1 │ 2.0  1.0  0.0 │        │
    ││axis 2│ 2.0  1.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 2.0  1.0  4.0 │        │
    ││      │ 2.0  1.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││2 @ 1 │ 2.0  2.0  0.0 │        │
    ││axis 2│ 2.0  2.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 2.0  2.0  4.0 │        │
    ││      │ 2.0  2.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││3 @ 1 │ 2.0  3.0  0.0 │        │
    ││axis 2│ 2.0  3.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 2.0  3.0  4.0 │        │
    ││      │ 2.0  3.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││4 @ 1 │ 2.0  4.0  0.0 │        │
    ││axis 2│ 2.0  4.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 2.0  4.0  4.0 │        │
    ││      │ 2.0  4.0  5.0 │        │
    │└──────┴───────────────┘        │
    ├────────────────────────────────┤
    │┌──────┬───────────────┐        │
    ││3 @ 0 │axis 3         │        │
    │├──────┼───────────────┤        │
    ││0 @ 1 │ 3.0  0.0  0.0 │        │
    ││axis 2│ 3.0  0.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 3.0  0.0  4.0 │        │
    ││      │ 3.0  0.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││1 @ 1 │ 3.0  1.0  0.0 │        │
    ││axis 2│ 3.0  1.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 3.0  1.0  4.0 │        │
    ││      │ 3.0  1.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││2 @ 1 │ 3.0  2.0  0.0 │        │
    ││axis 2│ 3.0  2.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 3.0  2.0  4.0 │        │
    ││      │ 3.0  2.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││3 @ 1 │ 3.0  3.0  0.0 │        │
    ││axis 2│ 3.0  3.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 3.0  3.0  4.0 │        │
    ││      │ 3.0  3.0  5.0 │        │
    │├──────┼───────────────┤        │
    ││4 @ 1 │ 3.0  4.0  0.0 │        │
    ││axis 2│ 3.0  4.0  1.0 │        │
    ││      │ ...  ...  ... │        │
    ││      │ 3.0  4.0  4.0 │        │
    ││      │ 3.0  4.0  5.0 │        │
    │└──────┴───────────────┘        │
    └────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ti;
  [%expect
    {|
    ┌─────────────────────────┐
    │[1]: =>_ti shape 0:4,1:3 │
    │┌──────┬───────────────┐ │
    ││      │axis 1         │ │
    │├──────┼───────────────┤ │
    ││axis 0│ 0.0  0.0  0.0 │ │
    ││      │ 1.0  0.0  0.0 │ │
    ││      │ 2.0  0.0  0.0 │ │
    ││      │ 3.0  0.0  0.0 │ │
    │└──────┴───────────────┘ │
    └─────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ tk;
  [%expect
    {|
    ┌─────────────────────────┐
    │[7]: =>_tk shape 0:6,1:3 │
    │┌──────┬───────────────┐ │
    ││      │axis 1         │ │
    │├──────┼───────────────┤ │
    ││axis 0│ 0.0  0.0  0.0 │ │
    ││      │ 0.0  0.0  1.0 │ │
    ││      │ ...  ...  ... │ │
    ││      │ 0.0  0.0  4.0 │ │
    ││      │ 0.0  0.0  5.0 │ │
    │└──────┴───────────────┘ │
    └─────────────────────────┘
    |}]

let%expect_test "einsum with a leftmost input axis preserved as output axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a =
    TDSL.range_of_shape ~label:[ "a" ] ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] ()
  in
  let b =
    TDSL.range_of_shape ~label:[ "b" ] ~batch_dims:[ 3 ] ~input_dims:[ 2; 3 ] ~output_dims:[ 4 ] ()
  in
  let%op c = a *+ "...|i->1; ...|j...->i => ...|ij" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4_a shape 0:3|2:4->1:2                                                               │
    │┌──────┬────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0               │1 @ 0                           │2 @ 0                           ││
    ││      │axis 2              │axis 2                          │axis 2                          ││
    │├──────┼────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.0  1.0  2.0  3.0 │ 8.0     9.0     1.0e+1  1.1e+1 │ 1.6e+1  1.7e+1  1.8e+1  1.9e+1 ││
    ││      │ 4.0  5.0  6.0  7.0 │ 1.2e+1  1.3e+1  1.4e+1  1.5e+1 │ 2.0e+1  2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────┐
    │[1]: r3x4x2x3_b shape 0:3|2:2,3:3->1:4                    │
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││0 @ 0 │0 @ 2                   │1 @ 2                   ││
    ││      │axis 3                  │axis 3                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 0.0     1.0     2.0    │ 3.0     4.0     5.0    ││
    ││      │ 6.0     7.0     8.0    │ 9.0     1.0e+1  1.1e+1 ││
    ││      │ 1.2e+1  1.3e+1  1.4e+1 │ 1.5e+1  1.6e+1  1.7e+1 ││
    ││      │ 1.8e+1  1.9e+1  2.0e+1 │ 2.1e+1  2.2e+1  2.3e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    ├──────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││1 @ 0 │0 @ 2                   │1 @ 2                   ││
    ││      │axis 3                  │axis 3                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 2.4e+1  2.5e+1  2.6e+1 │ 2.7e+1  2.8e+1  2.9e+1 ││
    ││      │ 3.0e+1  3.1e+1  3.2e+1 │ 3.3e+1  3.4e+1  3.5e+1 ││
    ││      │ 3.6e+1  3.7e+1  3.8e+1 │ 3.9e+1  4.0e+1  4.1e+1 ││
    ││      │ 4.2e+1  4.3e+1  4.4e+1 │ 4.5e+1  4.6e+1  4.7e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    ├──────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────┬────────────────────────┐│
    ││2 @ 0 │0 @ 2                   │1 @ 2                   ││
    ││      │axis 3                  │axis 3                  ││
    │├──────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 4.8e+1  4.9e+1  5.0e+1 │ 5.1e+1  5.2e+1  5.3e+1 ││
    ││      │ 5.4e+1  5.5e+1  5.6e+1 │ 5.7e+1  5.8e+1  5.9e+1 ││
    ││      │ 6.0e+1  6.1e+1  6.2e+1 │ 6.3e+1  6.4e+1  6.5e+1 ││
    ││      │ 6.6e+1  6.7e+1  6.8e+1 │ 6.9e+1  7.0e+1  7.1e+1 ││
    │└──────┴────────────────────────┴────────────────────────┘│
    └──────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4,2:2                               │
    │┌──────┬────────────────┬────────────────┬────────────────┐│
    ││      │0 @ 0           │1 @ 0           │2 @ 0           ││
    ││      │axis 2          │axis 2          │axis 2          ││
    │├──────┼────────────────┼────────────────┼────────────────┤│
    ││axis 1│ 1.2e+1  4.8e+1 │ 9.0e+2  1.0e+3 │ 2.9e+3  3.1e+3 ││
    ││      │ 1.1e+2  1.5e+2 │ 1.2e+3  1.3e+3 │ 3.5e+3  3.7e+3 ││
    ││      │ 2.3e+2  2.9e+2 │ 1.6e+3  1.7e+3 │ 4.0e+3  4.2e+3 ││
    ││      │ 4.0e+2  4.6e+2 │ 1.9e+3  2.1e+3 │ 4.6e+3  4.8e+3 ││
    │└──────┴────────────────┴────────────────┴────────────────┘│
    └───────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum permuting two leftmost input axes as output axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a = TDSL.range_of_shape ~label:[ "a" ] ~input_dims:[ 2 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~label:[ "b" ] ~input_dims:[ 2; 3; 4 ] ~output_dims:[ 2 ] () in
  let%op c = a *+ "i->1; ij...->0 => ...->ji" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────┐
    │[0]: r2x2_a shape 1:2->0:2 │
    │┌──────┬──────────┐        │
    ││      │axis 1    │        │
    │├──────┼──────────┤        │
    ││axis 0│ 0.0  1.0 │        │
    ││      │ 2.0  3.0 │        │
    │└──────┴──────────┘        │
    └───────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r2x2x3x4_b shape 1:2,2:3,3:4->0:2                                                                     │
    │┌──────┬────────────────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 2                           │1 @ 2                           │2 @ 2                           ││
    ││      │axis 3                          │axis 3                          │axis 3                          ││
    │├──────┼────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││0 @ 1 │ 0.0     1.0     2.0     3.0    │ 4.0     5.0     6.0     7.0    │ 8.0     9.0     1.0e+1  1.1e+1 ││
    ││axis 0│ 2.4e+1  2.5e+1  2.6e+1  2.7e+1 │ 2.8e+1  2.9e+1  3.0e+1  3.1e+1 │ 3.2e+1  3.3e+1  3.4e+1  3.5e+1 ││
    │├──────┼────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││1 @ 1 │ 1.2e+1  1.3e+1  1.4e+1  1.5e+1 │ 1.6e+1  1.7e+1  1.8e+1  1.9e+1 │ 2.0e+1  2.1e+1  2.2e+1  2.3e+1 ││
    ││axis 0│ 3.6e+1  3.7e+1  3.8e+1  3.9e+1 │ 4.0e+1  4.1e+1  4.2e+1  4.3e+1 │ 4.4e+1  4.5e+1  4.6e+1  4.7e+1 ││
    │└──────┴────────────────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 2:4->0:3,1:2                                                                              │
    │┌──────┬────────────────────────────────┬────────────────────────────────┬────────────────────────────────┐│
    ││      │0 @ 0                           │1 @ 0                           │2 @ 0                           ││
    ││      │axis 2                          │axis 2                          │axis 2                          ││
    │├──────┼────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤│
    ││axis 1│ 0.0     2.0     4.0     6.0    │ 8.0     1.0e+1  1.2e+1  1.4e+1 │ 1.6e+1  1.8e+1  2.0e+1  2.2e+1 ││
    ││      │ 3.6e+1  3.9e+1  4.2e+1  4.5e+1 │ 4.8e+1  5.1e+1  5.4e+1  5.7e+1 │ 6.0e+1  6.3e+1  6.6e+1  6.9e+1 ││
    │└──────┴────────────────────────────────┴────────────────────────────────┴────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
