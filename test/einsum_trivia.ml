open Base
open Ocannl

module FDSL = Operation.FDSL

let () = Session.SDSL.set_executor OCaml

let%expect_test "einsum1 permute axes" =
  let open Session.SDSL in
  drop_all_sessions();
  Random.init 0;
  let hey =
    FDSL.range_of_shape ~batch_dims:[2] ~input_dims:[3] ~output_dims:[4] () in
  let%nn_op ho = hey++"b|i->o => o|b->i" in
  refresh_session ();
  print_formula ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────┐
    │[1]: shape 0:2|2:3->1:4                                         │
    │┌──────┬───────────────────────────┬───────────────────────────┐│
    ││      │0 @ 0                      │1 @ 0                      ││
    ││      │axis 2                     │axis 2                     ││
    │├──────┼───────────────────────────┼───────────────────────────┤│
    ││axis 1│ 0.00e+0  1.00e+0  2.00e+0 │ 1.20e+1  1.30e+1  1.40e+1 ││
    ││      │ 3.00e+0  4.00e+0  5.00e+0 │ 1.50e+1  1.60e+1  1.70e+1 ││
    ││      │ 6.00e+0  7.00e+0  8.00e+0 │ 1.80e+1  1.90e+1  2.00e+1 ││
    ││      │ 9.00e+0  1.00e+1  1.10e+1 │ 2.10e+1  2.20e+1  2.30e+1 ││
    │└──────┴───────────────────────────┴───────────────────────────┘│
    └────────────────────────────────────────────────────────────────┘ |} ];
  print_formula ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect {|
    ┌────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: shape 0:4|2:2->1:3                                                             │
    │┌──────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┐│
    ││      │0 @ 0             │1 @ 0             │2 @ 0             │3 @ 0             ││
    ││      │axis 2            │axis 2            │axis 2            │axis 2            ││
    │├──────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤│
    ││axis 1│ 0.00e+0  1.20e+1 │ 3.00e+0  1.50e+1 │ 6.00e+0  1.80e+1 │ 9.00e+0  2.10e+1 ││
    ││      │ 1.00e+0  1.30e+1 │ 4.00e+0  1.60e+1 │ 7.00e+0  1.90e+1 │ 1.00e+1  2.20e+1 ││
    ││      │ 2.00e+0  1.40e+1 │ 5.00e+0  1.70e+1 │ 8.00e+0  2.00e+1 │ 1.10e+1  2.30e+1 ││
    │└──────┴──────────────────┴──────────────────┴──────────────────┴──────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────┘ |} ]
