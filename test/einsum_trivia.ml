open Base
open Ocannl
module Tn = Arrayjit.Tnode
module IDX = Train.IDX
module CDSL = Train.CDSL
module TDSL = Operation.TDSL
module NTDSL = Operation.NTDSL
module Rand = Arrayjit.Rand.Lib

module type Backend = Arrayjit.Backend_intf.Backend

let%expect_test "einsum1 permute axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => o|b->i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:4|2:2->1:3                                                                      │
    │┌──────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────────┐│
    ││      │0 @ 0                │1 @ 0                │2 @ 0                │3 @ 0                   ││
    ││      │axis 2               │axis 2               │axis 2               │axis 2                  ││
    │├──────┼─────────────────────┼─────────────────────┼─────────────────────┼────────────────────────┤│
    ││axis 1│ 0.00000  1.20000e+1 │ 3.00000  1.50000e+1 │ 6.00000  1.80000e+1 │ 9.00000     2.10000e+1 ││
    ││      │ 1.00000  1.30000e+1 │ 4.00000  1.60000e+1 │ 7.00000  1.90000e+1 │ 1.00000e+1  2.20000e+1 ││
    ││      │ 2.00000  1.40000e+1 │ 5.00000  1.70000e+1 │ 8.00000  2.00000e+1 │ 1.10000e+1  2.30000e+1 ││
    │└──────┴─────────────────────┴─────────────────────┴─────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => cf|ae->db" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                                                                            │
    │┌──────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                       │1 @ 4                                                       │2 @ 4                                                       │3 @ 4                                                       ││
    ││      │axis 5                                                      │axis 5                                                      │axis 5                                                      │axis 5                                                      ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000     1.00000     2.00000     3.00000     4.00000    │ 5.00000     6.00000     7.00000     8.00000     9.00000    │ 1.00000e+1  1.10000e+1  1.20000e+1  1.30000e+1  1.40000e+1 │ 1.50000e+1  1.60000e+1  1.70000e+1  1.80000e+1  1.90000e+1 ││
    ││axis 3│ 2.00000e+1  2.10000e+1  2.20000e+1  2.30000e+1  2.40000e+1 │ 2.50000e+1  2.60000e+1  2.70000e+1  2.80000e+1  2.90000e+1 │ 3.00000e+1  3.10000e+1  3.20000e+1  3.30000e+1  3.40000e+1 │ 3.50000e+1  3.60000e+1  3.70000e+1  3.80000e+1  3.90000e+1 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.00000e+2  1.01000e+2  1.02000e+2  1.03000e+2  1.04000e+2 │ 1.05000e+2  1.06000e+2  1.07000e+2  1.08000e+2  1.09000e+2 │ 1.10000e+2  1.11000e+2  1.12000e+2  1.13000e+2  1.14000e+2 │ 1.15000e+2  1.16000e+2  1.17000e+2  1.18000e+2  1.19000e+2 ││
    ││      │ 1.20000e+2  1.21000e+2  1.22000e+2  1.23000e+2  1.24000e+2 │ 1.25000e+2  1.26000e+2  1.27000e+2  1.28000e+2  1.29000e+2 │ 1.30000e+2  1.31000e+2  1.32000e+2  1.33000e+2  1.34000e+2 │ 1.35000e+2  1.36000e+2  1.37000e+2  1.38000e+2  1.39000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.40000e+2  1.41000e+2  1.42000e+2  1.43000e+2  1.44000e+2 │ 1.45000e+2  1.46000e+2  1.47000e+2  1.48000e+2  1.49000e+2 │ 1.50000e+2  1.51000e+2  1.52000e+2  1.53000e+2  1.54000e+2 │ 1.55000e+2  1.56000e+2  1.57000e+2  1.58000e+2  1.59000e+2 ││
    ││axis 3│ 1.60000e+2  1.61000e+2  1.62000e+2  1.63000e+2  1.64000e+2 │ 1.65000e+2  1.66000e+2  1.67000e+2  1.68000e+2  1.69000e+2 │ 1.70000e+2  1.71000e+2  1.72000e+2  1.73000e+2  1.74000e+2 │ 1.75000e+2  1.76000e+2  1.77000e+2  1.78000e+2  1.79000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 2.40000e+2  2.41000e+2  2.42000e+2  2.43000e+2  2.44000e+2 │ 2.45000e+2  2.46000e+2  2.47000e+2  2.48000e+2  2.49000e+2 │ 2.50000e+2  2.51000e+2  2.52000e+2  2.53000e+2  2.54000e+2 │ 2.55000e+2  2.56000e+2  2.57000e+2  2.58000e+2  2.59000e+2 ││
    ││      │ 2.60000e+2  2.61000e+2  2.62000e+2  2.63000e+2  2.64000e+2 │ 2.65000e+2  2.66000e+2  2.67000e+2  2.68000e+2  2.69000e+2 │ 2.70000e+2  2.71000e+2  2.72000e+2  2.73000e+2  2.74000e+2 │ 2.75000e+2  2.76000e+2  2.77000e+2  2.78000e+2  2.79000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                        │ ...                                                        │ ...                                                        │ ...                                                        ││
    ││axis 3│                                                            │                                                            │                                                            │                                                            ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.60000e+2  5.61000e+2  5.62000e+2  5.63000e+2  5.64000e+2 │ 5.65000e+2  5.66000e+2  5.67000e+2  5.68000e+2  5.69000e+2 │ 5.70000e+2  5.71000e+2  5.72000e+2  5.73000e+2  5.74000e+2 │ 5.75000e+2  5.76000e+2  5.77000e+2  5.78000e+2  5.79000e+2 ││
    ││axis 3│ 5.80000e+2  5.81000e+2  5.82000e+2  5.83000e+2  5.84000e+2 │ 5.85000e+2  5.86000e+2  5.87000e+2  5.88000e+2  5.89000e+2 │ 5.90000e+2  5.91000e+2  5.92000e+2  5.93000e+2  5.94000e+2 │ 5.95000e+2  5.96000e+2  5.97000e+2  5.98000e+2  5.99000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 6.60000e+2  6.61000e+2  6.62000e+2  6.63000e+2  6.64000e+2 │ 6.65000e+2  6.66000e+2  6.67000e+2  6.68000e+2  6.69000e+2 │ 6.70000e+2  6.71000e+2  6.72000e+2  6.73000e+2  6.74000e+2 │ 6.75000e+2  6.76000e+2  6.77000e+2  6.78000e+2  6.79000e+2 ││
    ││      │ 6.80000e+2  6.81000e+2  6.82000e+2  6.83000e+2  6.84000e+2 │ 6.85000e+2  6.86000e+2  6.87000e+2  6.88000e+2  6.89000e+2 │ 6.90000e+2  6.91000e+2  6.92000e+2  6.93000e+2  6.94000e+2 │ 6.95000e+2  6.96000e+2  6.97000e+2  6.98000e+2  6.99000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.00000e+2  7.01000e+2  7.02000e+2  7.03000e+2  7.04000e+2 │ 7.05000e+2  7.06000e+2  7.07000e+2  7.08000e+2  7.09000e+2 │ 7.10000e+2  7.11000e+2  7.12000e+2  7.13000e+2  7.14000e+2 │ 7.15000e+2  7.16000e+2  7.17000e+2  7.18000e+2  7.19000e+2 ││
    ││axis 3│ 7.20000e+2  7.21000e+2  7.22000e+2  7.23000e+2  7.24000e+2 │ 7.25000e+2  7.26000e+2  7.27000e+2  7.28000e+2  7.29000e+2 │ 7.30000e+2  7.31000e+2  7.32000e+2  7.33000e+2  7.34000e+2 │ 7.35000e+2  7.36000e+2  7.37000e+2  7.38000e+2  7.39000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 8.00000e+2  8.01000e+2  8.02000e+2  8.03000e+2  8.04000e+2 │ 8.05000e+2  8.06000e+2  8.07000e+2  8.08000e+2  8.09000e+2 │ 8.10000e+2  8.11000e+2  8.12000e+2  8.13000e+2  8.14000e+2 │ 8.15000e+2  8.16000e+2  8.17000e+2  8.18000e+2  8.19000e+2 ││
    ││      │ 8.20000e+2  8.21000e+2  8.22000e+2  8.23000e+2  8.24000e+2 │ 8.25000e+2  8.26000e+2  8.27000e+2  8.28000e+2  8.29000e+2 │ 8.30000e+2  8.31000e+2  8.32000e+2  8.33000e+2  8.34000e+2 │ 8.35000e+2  8.36000e+2  8.37000e+2  8.38000e+2  8.39000e+2 ││
    │└──────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                       │1 @ 4                                                       │2 @ 4                                                       │3 @ 4                                                       ││
    ││      │axis 5                                                      │axis 5                                                      │axis 5                                                      │axis 5                                                      ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 8.40000e+2  8.41000e+2  8.42000e+2  8.43000e+2  8.44000e+2 │ 8.45000e+2  8.46000e+2  8.47000e+2  8.48000e+2  8.49000e+2 │ 8.50000e+2  8.51000e+2  8.52000e+2  8.53000e+2  8.54000e+2 │ 8.55000e+2  8.56000e+2  8.57000e+2  8.58000e+2  8.59000e+2 ││
    ││axis 3│ 8.60000e+2  8.61000e+2  8.62000e+2  8.63000e+2  8.64000e+2 │ 8.65000e+2  8.66000e+2  8.67000e+2  8.68000e+2  8.69000e+2 │ 8.70000e+2  8.71000e+2  8.72000e+2  8.73000e+2  8.74000e+2 │ 8.75000e+2  8.76000e+2  8.77000e+2  8.78000e+2  8.79000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 9.40000e+2  9.41000e+2  9.42000e+2  9.43000e+2  9.44000e+2 │ 9.45000e+2  9.46000e+2  9.47000e+2  9.48000e+2  9.49000e+2 │ 9.50000e+2  9.51000e+2  9.52000e+2  9.53000e+2  9.54000e+2 │ 9.55000e+2  9.56000e+2  9.57000e+2  9.58000e+2  9.59000e+2 ││
    ││      │ 9.60000e+2  9.61000e+2  9.62000e+2  9.63000e+2  9.64000e+2 │ 9.65000e+2  9.66000e+2  9.67000e+2  9.68000e+2  9.69000e+2 │ 9.70000e+2  9.71000e+2  9.72000e+2  9.73000e+2  9.74000e+2 │ 9.75000e+2  9.76000e+2  9.77000e+2  9.78000e+2  9.79000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 9.80000e+2  9.81000e+2  9.82000e+2  9.83000e+2  9.84000e+2 │ 9.85000e+2  9.86000e+2  9.87000e+2  9.88000e+2  9.89000e+2 │ 9.90000e+2  9.91000e+2  9.92000e+2  9.93000e+2  9.94000e+2 │ 9.95000e+2  9.96000e+2  9.97000e+2  9.98000e+2  9.99000e+2 ││
    ││axis 3│ 1.00000e+3  1.00100e+3  1.00200e+3  1.00300e+3  1.00400e+3 │ 1.00500e+3  1.00600e+3  1.00700e+3  1.00800e+3  1.00900e+3 │ 1.01000e+3  1.01100e+3  1.01200e+3  1.01300e+3  1.01400e+3 │ 1.01500e+3  1.01600e+3  1.01700e+3  1.01800e+3  1.01900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.08000e+3  1.08100e+3  1.08200e+3  1.08300e+3  1.08400e+3 │ 1.08500e+3  1.08600e+3  1.08700e+3  1.08800e+3  1.08900e+3 │ 1.09000e+3  1.09100e+3  1.09200e+3  1.09300e+3  1.09400e+3 │ 1.09500e+3  1.09600e+3  1.09700e+3  1.09800e+3  1.09900e+3 ││
    ││      │ 1.10000e+3  1.10100e+3  1.10200e+3  1.10300e+3  1.10400e+3 │ 1.10500e+3  1.10600e+3  1.10700e+3  1.10800e+3  1.10900e+3 │ 1.11000e+3  1.11100e+3  1.11200e+3  1.11300e+3  1.11400e+3 │ 1.11500e+3  1.11600e+3  1.11700e+3  1.11800e+3  1.11900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                        │ ...                                                        │ ...                                                        │ ...                                                        ││
    ││axis 3│                                                            │                                                            │                                                            │                                                            ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.40000e+3  1.40100e+3  1.40200e+3  1.40300e+3  1.40400e+3 │ 1.40500e+3  1.40600e+3  1.40700e+3  1.40800e+3  1.40900e+3 │ 1.41000e+3  1.41100e+3  1.41200e+3  1.41300e+3  1.41400e+3 │ 1.41500e+3  1.41600e+3  1.41700e+3  1.41800e+3  1.41900e+3 ││
    ││axis 3│ 1.42000e+3  1.42100e+3  1.42200e+3  1.42300e+3  1.42400e+3 │ 1.42500e+3  1.42600e+3  1.42700e+3  1.42800e+3  1.42900e+3 │ 1.43000e+3  1.43100e+3  1.43200e+3  1.43300e+3  1.43400e+3 │ 1.43500e+3  1.43600e+3  1.43700e+3  1.43800e+3  1.43900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.50000e+3  1.50100e+3  1.50200e+3  1.50300e+3  1.50400e+3 │ 1.50500e+3  1.50600e+3  1.50700e+3  1.50800e+3  1.50900e+3 │ 1.51000e+3  1.51100e+3  1.51200e+3  1.51300e+3  1.51400e+3 │ 1.51500e+3  1.51600e+3  1.51700e+3  1.51800e+3  1.51900e+3 ││
    ││      │ 1.52000e+3  1.52100e+3  1.52200e+3  1.52300e+3  1.52400e+3 │ 1.52500e+3  1.52600e+3  1.52700e+3  1.52800e+3  1.52900e+3 │ 1.53000e+3  1.53100e+3  1.53200e+3  1.53300e+3  1.53400e+3 │ 1.53500e+3  1.53600e+3  1.53700e+3  1.53800e+3  1.53900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 1.54000e+3  1.54100e+3  1.54200e+3  1.54300e+3  1.54400e+3 │ 1.54500e+3  1.54600e+3  1.54700e+3  1.54800e+3  1.54900e+3 │ 1.55000e+3  1.55100e+3  1.55200e+3  1.55300e+3  1.55400e+3 │ 1.55500e+3  1.55600e+3  1.55700e+3  1.55800e+3  1.55900e+3 ││
    ││axis 3│ 1.56000e+3  1.56100e+3  1.56200e+3  1.56300e+3  1.56400e+3 │ 1.56500e+3  1.56600e+3  1.56700e+3  1.56800e+3  1.56900e+3 │ 1.57000e+3  1.57100e+3  1.57200e+3  1.57300e+3  1.57400e+3 │ 1.57500e+3  1.57600e+3  1.57700e+3  1.57800e+3  1.57900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.64000e+3  1.64100e+3  1.64200e+3  1.64300e+3  1.64400e+3 │ 1.64500e+3  1.64600e+3  1.64700e+3  1.64800e+3  1.64900e+3 │ 1.65000e+3  1.65100e+3  1.65200e+3  1.65300e+3  1.65400e+3 │ 1.65500e+3  1.65600e+3  1.65700e+3  1.65800e+3  1.65900e+3 ││
    ││      │ 1.66000e+3  1.66100e+3  1.66200e+3  1.66300e+3  1.66400e+3 │ 1.66500e+3  1.66600e+3  1.66700e+3  1.66800e+3  1.66900e+3 │ 1.67000e+3  1.67100e+3  1.67200e+3  1.67300e+3  1.67400e+3 │ 1.67500e+3  1.67600e+3  1.67700e+3  1.67800e+3  1.67900e+3 ││
    │└──────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                       │1 @ 4                                                       │2 @ 4                                                       │3 @ 4                                                       ││
    ││      │axis 5                                                      │axis 5                                                      │axis 5                                                      │axis 5                                                      ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.68000e+3  1.68100e+3  1.68200e+3  1.68300e+3  1.68400e+3 │ 1.68500e+3  1.68600e+3  1.68700e+3  1.68800e+3  1.68900e+3 │ 1.69000e+3  1.69100e+3  1.69200e+3  1.69300e+3  1.69400e+3 │ 1.69500e+3  1.69600e+3  1.69700e+3  1.69800e+3  1.69900e+3 ││
    ││axis 3│ 1.70000e+3  1.70100e+3  1.70200e+3  1.70300e+3  1.70400e+3 │ 1.70500e+3  1.70600e+3  1.70700e+3  1.70800e+3  1.70900e+3 │ 1.71000e+3  1.71100e+3  1.71200e+3  1.71300e+3  1.71400e+3 │ 1.71500e+3  1.71600e+3  1.71700e+3  1.71800e+3  1.71900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.78000e+3  1.78100e+3  1.78200e+3  1.78300e+3  1.78400e+3 │ 1.78500e+3  1.78600e+3  1.78700e+3  1.78800e+3  1.78900e+3 │ 1.79000e+3  1.79100e+3  1.79200e+3  1.79300e+3  1.79400e+3 │ 1.79500e+3  1.79600e+3  1.79700e+3  1.79800e+3  1.79900e+3 ││
    ││      │ 1.80000e+3  1.80100e+3  1.80200e+3  1.80300e+3  1.80400e+3 │ 1.80500e+3  1.80600e+3  1.80700e+3  1.80800e+3  1.80900e+3 │ 1.81000e+3  1.81100e+3  1.81200e+3  1.81300e+3  1.81400e+3 │ 1.81500e+3  1.81600e+3  1.81700e+3  1.81800e+3  1.81900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.82000e+3  1.82100e+3  1.82200e+3  1.82300e+3  1.82400e+3 │ 1.82500e+3  1.82600e+3  1.82700e+3  1.82800e+3  1.82900e+3 │ 1.83000e+3  1.83100e+3  1.83200e+3  1.83300e+3  1.83400e+3 │ 1.83500e+3  1.83600e+3  1.83700e+3  1.83800e+3  1.83900e+3 ││
    ││axis 3│ 1.84000e+3  1.84100e+3  1.84200e+3  1.84300e+3  1.84400e+3 │ 1.84500e+3  1.84600e+3  1.84700e+3  1.84800e+3  1.84900e+3 │ 1.85000e+3  1.85100e+3  1.85200e+3  1.85300e+3  1.85400e+3 │ 1.85500e+3  1.85600e+3  1.85700e+3  1.85800e+3  1.85900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.92000e+3  1.92100e+3  1.92200e+3  1.92300e+3  1.92400e+3 │ 1.92500e+3  1.92600e+3  1.92700e+3  1.92800e+3  1.92900e+3 │ 1.93000e+3  1.93100e+3  1.93200e+3  1.93300e+3  1.93400e+3 │ 1.93500e+3  1.93600e+3  1.93700e+3  1.93800e+3  1.93900e+3 ││
    ││      │ 1.94000e+3  1.94100e+3  1.94200e+3  1.94300e+3  1.94400e+3 │ 1.94500e+3  1.94600e+3  1.94700e+3  1.94800e+3  1.94900e+3 │ 1.95000e+3  1.95100e+3  1.95200e+3  1.95300e+3  1.95400e+3 │ 1.95500e+3  1.95600e+3  1.95700e+3  1.95800e+3  1.95900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                        │ ...                                                        │ ...                                                        │ ...                                                        ││
    ││axis 3│                                                            │                                                            │                                                            │                                                            ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.24000e+3  2.24100e+3  2.24200e+3  2.24300e+3  2.24400e+3 │ 2.24500e+3  2.24600e+3  2.24700e+3  2.24800e+3  2.24900e+3 │ 2.25000e+3  2.25100e+3  2.25200e+3  2.25300e+3  2.25400e+3 │ 2.25500e+3  2.25600e+3  2.25700e+3  2.25800e+3  2.25900e+3 ││
    ││axis 3│ 2.26000e+3  2.26100e+3  2.26200e+3  2.26300e+3  2.26400e+3 │ 2.26500e+3  2.26600e+3  2.26700e+3  2.26800e+3  2.26900e+3 │ 2.27000e+3  2.27100e+3  2.27200e+3  2.27300e+3  2.27400e+3 │ 2.27500e+3  2.27600e+3  2.27700e+3  2.27800e+3  2.27900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 2.34000e+3  2.34100e+3  2.34200e+3  2.34300e+3  2.34400e+3 │ 2.34500e+3  2.34600e+3  2.34700e+3  2.34800e+3  2.34900e+3 │ 2.35000e+3  2.35100e+3  2.35200e+3  2.35300e+3  2.35400e+3 │ 2.35500e+3  2.35600e+3  2.35700e+3  2.35800e+3  2.35900e+3 ││
    ││      │ 2.36000e+3  2.36100e+3  2.36200e+3  2.36300e+3  2.36400e+3 │ 2.36500e+3  2.36600e+3  2.36700e+3  2.36800e+3  2.36900e+3 │ 2.37000e+3  2.37100e+3  2.37200e+3  2.37300e+3  2.37400e+3 │ 2.37500e+3  2.37600e+3  2.37700e+3  2.37800e+3  2.37900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 2.38000e+3  2.38100e+3  2.38200e+3  2.38300e+3  2.38400e+3 │ 2.38500e+3  2.38600e+3  2.38700e+3  2.38800e+3  2.38900e+3 │ 2.39000e+3  2.39100e+3  2.39200e+3  2.39300e+3  2.39400e+3 │ 2.39500e+3  2.39600e+3  2.39700e+3  2.39800e+3  2.39900e+3 ││
    ││axis 3│ 2.40000e+3  2.40100e+3  2.40200e+3  2.40300e+3  2.40400e+3 │ 2.40500e+3  2.40600e+3  2.40700e+3  2.40800e+3  2.40900e+3 │ 2.41000e+3  2.41100e+3  2.41200e+3  2.41300e+3  2.41400e+3 │ 2.41500e+3  2.41600e+3  2.41700e+3  2.41800e+3  2.41900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 2.48000e+3  2.48100e+3  2.48200e+3  2.48300e+3  2.48400e+3 │ 2.48500e+3  2.48600e+3  2.48700e+3  2.48800e+3  2.48900e+3 │ 2.49000e+3  2.49100e+3  2.49200e+3  2.49300e+3  2.49400e+3 │ 2.49500e+3  2.49600e+3  2.49700e+3  2.49800e+3  2.49900e+3 ││
    ││      │ 2.50000e+3  2.50100e+3  2.50200e+3  2.50300e+3  2.50400e+3 │ 2.50500e+3  2.50600e+3  2.50700e+3  2.50800e+3  2.50900e+3 │ 2.51000e+3  2.51100e+3  2.51200e+3  2.51300e+3  2.51400e+3 │ 2.51500e+3  2.51600e+3  2.51700e+3  2.51800e+3  2.51900e+3 ││
    │└──────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4,1:7|4:2,5:6->2:5,3:3                                                                          │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                │1 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000     1.40000e+2  ...  5.60000e+2  7.00000e+2 │ 2.52000e+3  2.66000e+3  ...  3.08000e+3  3.22000e+3 ││
    ││axis 3│ 8.40000e+2  9.80000e+2  ...  1.40000e+3  1.54000e+3 │ 3.36000e+3  3.50000e+3  ...  3.92000e+3  4.06000e+3 ││
    ││      │ 1.68000e+3  1.82000e+3  ...  2.24000e+3  2.38000e+3 │ 4.20000e+3  4.34000e+3  ...  4.76000e+3  4.90000e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.00000     1.41000e+2  ...  5.61000e+2  7.01000e+2 │ 2.52100e+3  2.66100e+3  ...  3.08100e+3  3.22100e+3 ││
    ││axis 3│ 8.41000e+2  9.81000e+2  ...  1.40100e+3  1.54100e+3 │ 3.36100e+3  3.50100e+3  ...  3.92100e+3  4.06100e+3 ││
    ││      │ 1.68100e+3  1.82100e+3  ...  2.24100e+3  2.38100e+3 │ 4.20100e+3  4.34100e+3  ...  4.76100e+3  4.90100e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.00000     1.42000e+2  ...  5.62000e+2  7.02000e+2 │ 2.52200e+3  2.66200e+3  ...  3.08200e+3  3.22200e+3 ││
    ││axis 3│ 8.42000e+2  9.82000e+2  ...  1.40200e+3  1.54200e+3 │ 3.36200e+3  3.50200e+3  ...  3.92200e+3  4.06200e+3 ││
    ││      │ 1.68200e+3  1.82200e+3  ...  2.24200e+3  2.38200e+3 │ 4.20200e+3  4.34200e+3  ...  4.76200e+3  4.90200e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 3.00000     1.43000e+2  ...  5.63000e+2  7.03000e+2 │ 2.52300e+3  2.66300e+3  ...  3.08300e+3  3.22300e+3 ││
    ││axis 3│ 8.43000e+2  9.83000e+2  ...  1.40300e+3  1.54300e+3 │ 3.36300e+3  3.50300e+3  ...  3.92300e+3  4.06300e+3 ││
    ││      │ 1.68300e+3  1.82300e+3  ...  2.24300e+3  2.38300e+3 │ 4.20300e+3  4.34300e+3  ...  4.76300e+3  4.90300e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 4.00000     1.44000e+2  ...  5.64000e+2  7.04000e+2 │ 2.52400e+3  2.66400e+3  ...  3.08400e+3  3.22400e+3 ││
    ││axis 3│ 8.44000e+2  9.84000e+2  ...  1.40400e+3  1.54400e+3 │ 3.36400e+3  3.50400e+3  ...  3.92400e+3  4.06400e+3 ││
    ││      │ 1.68400e+3  1.82400e+3  ...  2.24400e+3  2.38400e+3 │ 4.20400e+3  4.34400e+3  ...  4.76400e+3  4.90400e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                │1 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 2.00000e+1  1.60000e+2  ...  5.80000e+2  7.20000e+2 │ 2.54000e+3  2.68000e+3  ...  3.10000e+3  3.24000e+3 ││
    ││axis 3│ 8.60000e+2  1.00000e+3  ...  1.42000e+3  1.56000e+3 │ 3.38000e+3  3.52000e+3  ...  3.94000e+3  4.08000e+3 ││
    ││      │ 1.70000e+3  1.84000e+3  ...  2.26000e+3  2.40000e+3 │ 4.22000e+3  4.36000e+3  ...  4.78000e+3  4.92000e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 2.10000e+1  1.61000e+2  ...  5.81000e+2  7.21000e+2 │ 2.54100e+3  2.68100e+3  ...  3.10100e+3  3.24100e+3 ││
    ││axis 3│ 8.61000e+2  1.00100e+3  ...  1.42100e+3  1.56100e+3 │ 3.38100e+3  3.52100e+3  ...  3.94100e+3  4.08100e+3 ││
    ││      │ 1.70100e+3  1.84100e+3  ...  2.26100e+3  2.40100e+3 │ 4.22100e+3  4.36100e+3  ...  4.78100e+3  4.92100e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.20000e+1  1.62000e+2  ...  5.82000e+2  7.22000e+2 │ 2.54200e+3  2.68200e+3  ...  3.10200e+3  3.24200e+3 ││
    ││axis 3│ 8.62000e+2  1.00200e+3  ...  1.42200e+3  1.56200e+3 │ 3.38200e+3  3.52200e+3  ...  3.94200e+3  4.08200e+3 ││
    ││      │ 1.70200e+3  1.84200e+3  ...  2.26200e+3  2.40200e+3 │ 4.22200e+3  4.36200e+3  ...  4.78200e+3  4.92200e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 2.30000e+1  1.63000e+2  ...  5.83000e+2  7.23000e+2 │ 2.54300e+3  2.68300e+3  ...  3.10300e+3  3.24300e+3 ││
    ││axis 3│ 8.63000e+2  1.00300e+3  ...  1.42300e+3  1.56300e+3 │ 3.38300e+3  3.52300e+3  ...  3.94300e+3  4.08300e+3 ││
    ││      │ 1.70300e+3  1.84300e+3  ...  2.26300e+3  2.40300e+3 │ 4.22300e+3  4.36300e+3  ...  4.78300e+3  4.92300e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.40000e+1  1.64000e+2  ...  5.84000e+2  7.24000e+2 │ 2.54400e+3  2.68400e+3  ...  3.10400e+3  3.24400e+3 ││
    ││axis 3│ 8.64000e+2  1.00400e+3  ...  1.42400e+3  1.56400e+3 │ 3.38400e+3  3.52400e+3  ...  3.94400e+3  4.08400e+3 ││
    ││      │ 1.70400e+3  1.84400e+3  ...  2.26400e+3  2.40400e+3 │ 4.22400e+3  4.36400e+3  ...  4.78400e+3  4.92400e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │ ...                                                                                                                │
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││5 @ 1 │0 @ 4                                                │1 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.00000e+2  2.40000e+2  ...  6.60000e+2  8.00000e+2 │ 2.62000e+3  2.76000e+3  ...  3.18000e+3  3.32000e+3 ││
    ││axis 3│ 9.40000e+2  1.08000e+3  ...  1.50000e+3  1.64000e+3 │ 3.46000e+3  3.60000e+3  ...  4.02000e+3  4.16000e+3 ││
    ││      │ 1.78000e+3  1.92000e+3  ...  2.34000e+3  2.48000e+3 │ 4.30000e+3  4.44000e+3  ...  4.86000e+3  5.00000e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.01000e+2  2.41000e+2  ...  6.61000e+2  8.01000e+2 │ 2.62100e+3  2.76100e+3  ...  3.18100e+3  3.32100e+3 ││
    ││axis 3│ 9.41000e+2  1.08100e+3  ...  1.50100e+3  1.64100e+3 │ 3.46100e+3  3.60100e+3  ...  4.02100e+3  4.16100e+3 ││
    ││      │ 1.78100e+3  1.92100e+3  ...  2.34100e+3  2.48100e+3 │ 4.30100e+3  4.44100e+3  ...  4.86100e+3  5.00100e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.02000e+2  2.42000e+2  ...  6.62000e+2  8.02000e+2 │ 2.62200e+3  2.76200e+3  ...  3.18200e+3  3.32200e+3 ││
    ││axis 3│ 9.42000e+2  1.08200e+3  ...  1.50200e+3  1.64200e+3 │ 3.46200e+3  3.60200e+3  ...  4.02200e+3  4.16200e+3 ││
    ││      │ 1.78200e+3  1.92200e+3  ...  2.34200e+3  2.48200e+3 │ 4.30200e+3  4.44200e+3  ...  4.86200e+3  5.00200e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.03000e+2  2.43000e+2  ...  6.63000e+2  8.03000e+2 │ 2.62300e+3  2.76300e+3  ...  3.18300e+3  3.32300e+3 ││
    ││axis 3│ 9.43000e+2  1.08300e+3  ...  1.50300e+3  1.64300e+3 │ 3.46300e+3  3.60300e+3  ...  4.02300e+3  4.16300e+3 ││
    ││      │ 1.78300e+3  1.92300e+3  ...  2.34300e+3  2.48300e+3 │ 4.30300e+3  4.44300e+3  ...  4.86300e+3  5.00300e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.04000e+2  2.44000e+2  ...  6.64000e+2  8.04000e+2 │ 2.62400e+3  2.76400e+3  ...  3.18400e+3  3.32400e+3 ││
    ││axis 3│ 9.44000e+2  1.08400e+3  ...  1.50400e+3  1.64400e+3 │ 3.46400e+3  3.60400e+3  ...  4.02400e+3  4.16400e+3 ││
    ││      │ 1.78400e+3  1.92400e+3  ...  2.34400e+3  2.48400e+3 │ 4.30400e+3  4.44400e+3  ...  4.86400e+3  5.00400e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││6 @ 1 │0 @ 4                                                │1 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.20000e+2  2.60000e+2  ...  6.80000e+2  8.20000e+2 │ 2.64000e+3  2.78000e+3  ...  3.20000e+3  3.34000e+3 ││
    ││axis 3│ 9.60000e+2  1.10000e+3  ...  1.52000e+3  1.66000e+3 │ 3.48000e+3  3.62000e+3  ...  4.04000e+3  4.18000e+3 ││
    ││      │ 1.80000e+3  1.94000e+3  ...  2.36000e+3  2.50000e+3 │ 4.32000e+3  4.46000e+3  ...  4.88000e+3  5.02000e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.21000e+2  2.61000e+2  ...  6.81000e+2  8.21000e+2 │ 2.64100e+3  2.78100e+3  ...  3.20100e+3  3.34100e+3 ││
    ││axis 3│ 9.61000e+2  1.10100e+3  ...  1.52100e+3  1.66100e+3 │ 3.48100e+3  3.62100e+3  ...  4.04100e+3  4.18100e+3 ││
    ││      │ 1.80100e+3  1.94100e+3  ...  2.36100e+3  2.50100e+3 │ 4.32100e+3  4.46100e+3  ...  4.88100e+3  5.02100e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.22000e+2  2.62000e+2  ...  6.82000e+2  8.22000e+2 │ 2.64200e+3  2.78200e+3  ...  3.20200e+3  3.34200e+3 ││
    ││axis 3│ 9.62000e+2  1.10200e+3  ...  1.52200e+3  1.66200e+3 │ 3.48200e+3  3.62200e+3  ...  4.04200e+3  4.18200e+3 ││
    ││      │ 1.80200e+3  1.94200e+3  ...  2.36200e+3  2.50200e+3 │ 4.32200e+3  4.46200e+3  ...  4.88200e+3  5.02200e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.23000e+2  2.63000e+2  ...  6.83000e+2  8.23000e+2 │ 2.64300e+3  2.78300e+3  ...  3.20300e+3  3.34300e+3 ││
    ││axis 3│ 9.63000e+2  1.10300e+3  ...  1.52300e+3  1.66300e+3 │ 3.48300e+3  3.62300e+3  ...  4.04300e+3  4.18300e+3 ││
    ││      │ 1.80300e+3  1.94300e+3  ...  2.36300e+3  2.50300e+3 │ 4.32300e+3  4.46300e+3  ...  4.88300e+3  5.02300e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.24000e+2  2.64000e+2  ...  6.84000e+2  8.24000e+2 │ 2.64400e+3  2.78400e+3  ...  3.20400e+3  3.34400e+3 ││
    ││axis 3│ 9.64000e+2  1.10400e+3  ...  1.52400e+3  1.66400e+3 │ 3.48400e+3  3.62400e+3  ...  4.04400e+3  4.18400e+3 ││
    ││      │ 1.80400e+3  1.94400e+3  ...  2.36400e+3  2.50400e+3 │ 4.32400e+3  4.46400e+3  ...  4.88400e+3  5.02400e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 sum out axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "b|i->o => b|i" in
  Train.forward_and_forget backend ctx ho;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:3                     │
    │┌──────┬────────────────────────────────────┐│
    ││      │axis 1                              ││
    │├──────┼────────────────────────────────────┤│
    ││axis 0│ 1.80000e+1  2.20000e+1  2.60000e+1 ││
    ││      │ 6.60000e+1  7.00000e+1  7.40000e+1 ││
    │└──────┴────────────────────────────────────┘│
    └─────────────────────────────────────────────┘
    |}];
  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho2 = hey2 ++ "ab|cd->ef => c|a->d" in
  Train.forward_and_forget backend ctx ho2;
  (* Axis 5 of hey2, i.e. d in the einsum spec, has the lowest variation (progresses by 1), that's
     why axis 1 of ho2 appears nearly constant. *)
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: =>_ho2 shape 0:4|2:2->1:5                                                                              │
    │┌──────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0                   │1 @ 0                   │2 @ 0                   │3 @ 0                   ││
    ││      │axis 2                  │axis 2                  │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 1.57500e+5  4.75020e+5 │ 1.58130e+5  4.75650e+5 │ 1.58760e+5  4.76280e+5 │ 1.59390e+5  4.76910e+5 ││
    ││      │ 1.57626e+5  4.75146e+5 │ 1.58256e+5  4.75776e+5 │ 1.58886e+5  4.76406e+5 │ 1.59516e+5  4.77036e+5 ││
    ││      │ 1.57752e+5  4.75272e+5 │ 1.58382e+5  4.75902e+5 │ 1.59012e+5  4.76532e+5 │ 1.59642e+5  4.77162e+5 ││
    ││      │ 1.57878e+5  4.75398e+5 │ 1.58508e+5  4.76028e+5 │ 1.59138e+5  4.76658e+5 │ 1.59768e+5  4.77288e+5 ││
    ││      │ 1.58004e+5  4.75524e+5 │ 1.58634e+5  4.76154e+5 │ 1.59264e+5  4.76784e+5 │ 1.59894e+5  4.77414e+5 ││
    │└──────┴────────────────────────┴────────────────────────┴────────────────────────┴────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum outer product" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[] ~input_dims:[] ~output_dims:[ 3 ] () in
  let%op c = (a + 1) *+ "i; j => i->j" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌─────────────────────┐
    │[0]: r2 shape 0:2    │
    │┌┬──────────────────┐│
    │││axis 0            ││
    │├┼──────────────────┤│
    │││ 0.00000  1.00000 ││
    │└┴──────────────────┘│
    └─────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────┐
    │[1]: r3 shape 0:3             │
    │┌┬───────────────────────────┐│
    │││axis 0                     ││
    │├┼───────────────────────────┤│
    │││ 0.00000  1.00000  2.00000 ││
    │└┴───────────────────────────┘│
    └──────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────┐
    │[4]: ;=>_c shape 1:2->0:3  │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 0.00000  0.00000 ││
    ││      │ 1.00000  2.00000 ││
    ││      │ 2.00000  4.00000 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘
    |}];
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 5 ] ~input_dims:[ 6 ] ~output_dims:[ 7 ] () in
  let%op c = a *+ "i|j->k; l|m->n => il|jm->kn" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[5]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[6]: r5x7x6 shape 0:5|2:6->1:7                                                                                                                                                                                                                                                        │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                │1 @ 0                                                │2 @ 0                                                │3 @ 0                                                │4 @ 0                                                ││
    ││      │axis 2                                               │axis 2                                               │axis 2                                               │axis 2                                               │axis 2                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││axis 1│ 0.00000     1.00000     ...  4.00000     5.00000    │ 4.20000e+1  4.30000e+1  ...  4.60000e+1  4.70000e+1 │ 8.40000e+1  8.50000e+1  ...  8.80000e+1  8.90000e+1 │ 1.26000e+2  1.27000e+2  ...  1.30000e+2  1.31000e+2 │ 1.68000e+2  1.69000e+2  ...  1.72000e+2  1.73000e+2 ││
    ││      │ 6.00000     7.00000     ...  1.00000e+1  1.10000e+1 │ 4.80000e+1  4.90000e+1  ...  5.20000e+1  5.30000e+1 │ 9.00000e+1  9.10000e+1  ...  9.40000e+1  9.50000e+1 │ 1.32000e+2  1.33000e+2  ...  1.36000e+2  1.37000e+2 │ 1.74000e+2  1.75000e+2  ...  1.78000e+2  1.79000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 3.00000e+1  3.10000e+1  ...  3.40000e+1  3.50000e+1 │ 7.20000e+1  7.30000e+1  ...  7.60000e+1  7.70000e+1 │ 1.14000e+2  1.15000e+2  ...  1.18000e+2  1.19000e+2 │ 1.56000e+2  1.57000e+2  ...  1.60000e+2  1.61000e+2 │ 1.98000e+2  1.99000e+2  ...  2.02000e+2  2.03000e+2 ││
    ││      │ 3.60000e+1  3.70000e+1  ...  4.00000e+1  4.10000e+1 │ 7.80000e+1  7.90000e+1  ...  8.20000e+1  8.30000e+1 │ 1.20000e+2  1.21000e+2  ...  1.24000e+2  1.25000e+2 │ 1.62000e+2  1.63000e+2  ...  1.66000e+2  1.67000e+2 │ 2.04000e+2  2.05000e+2  ...  2.08000e+2  2.09000e+2 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[7]: ;=>_c shape 0:2,1:5|4:3,5:6->2:4,3:7                                                                                                                                 │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000  0.00000  ...  0.00000  0.00000             │ 0.00000     1.00000     ...  4.00000     5.00000    │ 0.00000     2.00000     ...  8.00000     1.00000e+1 ││
    ││axis 3│ 0.00000  0.00000  ...  0.00000  0.00000             │ 6.00000     7.00000     ...  1.00000e+1  1.10000e+1 │ 1.20000e+1  1.40000e+1  ...  2.00000e+1  2.20000e+1 ││
    ││      │ ...      ...      ...  ...      ...                 │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 3.00000e+1  3.10000e+1  ...  3.40000e+1  3.50000e+1 │ 6.00000e+1  6.20000e+1  ...  6.80000e+1  7.00000e+1 ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 3.60000e+1  3.70000e+1  ...  4.00000e+1  4.10000e+1 │ 7.20000e+1  7.40000e+1  ...  8.00000e+1  8.20000e+1 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 0.00000     3.00000     ...  1.20000e+1  1.50000e+1 │ 0.00000     4.00000     ...  1.60000e+1  2.00000e+1 │ 0.00000     5.00000     ...  2.00000e+1  2.50000e+1 ││
    ││axis 3│ 1.80000e+1  2.10000e+1  ...  3.00000e+1  3.30000e+1 │ 2.40000e+1  2.80000e+1  ...  4.00000e+1  4.40000e+1 │ 3.00000e+1  3.50000e+1  ...  5.00000e+1  5.50000e+1 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 9.00000e+1  9.30000e+1  ...  1.02000e+2  1.05000e+2 │ 1.20000e+2  1.24000e+2  ...  1.36000e+2  1.40000e+2 │ 1.50000e+2  1.55000e+2  ...  1.70000e+2  1.75000e+2 ││
    ││      │ 1.08000e+2  1.11000e+2  ...  1.20000e+2  1.23000e+2 │ 1.44000e+2  1.48000e+2  ...  1.60000e+2  1.64000e+2 │ 1.80000e+2  1.85000e+2  ...  2.00000e+2  2.05000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 0.00000     6.00000     ...  2.40000e+1  3.00000e+1 │ 0.00000     7.00000     ...  2.80000e+1  3.50000e+1 │ 0.00000     8.00000     ...  3.20000e+1  4.00000e+1 ││
    ││axis 3│ 3.60000e+1  4.20000e+1  ...  6.00000e+1  6.60000e+1 │ 4.20000e+1  4.90000e+1  ...  7.00000e+1  7.70000e+1 │ 4.80000e+1  5.60000e+1  ...  8.00000e+1  8.80000e+1 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.80000e+2  1.86000e+2  ...  2.04000e+2  2.10000e+2 │ 2.10000e+2  2.17000e+2  ...  2.38000e+2  2.45000e+2 │ 2.40000e+2  2.48000e+2  ...  2.72000e+2  2.80000e+2 ││
    ││      │ 2.16000e+2  2.22000e+2  ...  2.40000e+2  2.46000e+2 │ 2.52000e+2  2.59000e+2  ...  2.80000e+2  2.87000e+2 │ 2.88000e+2  2.96000e+2  ...  3.20000e+2  3.28000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 0.00000     9.00000     ...  3.60000e+1  4.50000e+1 │ 0.00000     1.00000e+1  ...  4.00000e+1  5.00000e+1 │ 0.00000     1.10000e+1  ...  4.40000e+1  5.50000e+1 ││
    ││axis 3│ 5.40000e+1  6.30000e+1  ...  9.00000e+1  9.90000e+1 │ 6.00000e+1  7.00000e+1  ...  1.00000e+2  1.10000e+2 │ 6.60000e+1  7.70000e+1  ...  1.10000e+2  1.21000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.70000e+2  2.79000e+2  ...  3.06000e+2  3.15000e+2 │ 3.00000e+2  3.10000e+2  ...  3.40000e+2  3.50000e+2 │ 3.30000e+2  3.41000e+2  ...  3.74000e+2  3.85000e+2 ││
    ││      │ 3.24000e+2  3.33000e+2  ...  3.60000e+2  3.69000e+2 │ 3.60000e+2  3.70000e+2  ...  4.00000e+2  4.10000e+2 │ 3.96000e+2  4.07000e+2  ...  4.40000e+2  4.51000e+2 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000  0.00000  ...  0.00000  0.00000             │ 4.20000e+1  4.30000e+1  ...  4.60000e+1  4.70000e+1 │ 8.40000e+1  8.60000e+1  ...  9.20000e+1  9.40000e+1 ││
    ││axis 3│ 0.00000  0.00000  ...  0.00000  0.00000             │ 4.80000e+1  4.90000e+1  ...  5.20000e+1  5.30000e+1 │ 9.60000e+1  9.80000e+1  ...  1.04000e+2  1.06000e+2 ││
    ││      │ ...      ...      ...  ...      ...                 │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 7.20000e+1  7.30000e+1  ...  7.60000e+1  7.70000e+1 │ 1.44000e+2  1.46000e+2  ...  1.52000e+2  1.54000e+2 ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 7.80000e+1  7.90000e+1  ...  8.20000e+1  8.30000e+1 │ 1.56000e+2  1.58000e+2  ...  1.64000e+2  1.66000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.26000e+2  1.29000e+2  ...  1.38000e+2  1.41000e+2 │ 1.68000e+2  1.72000e+2  ...  1.84000e+2  1.88000e+2 │ 2.10000e+2  2.15000e+2  ...  2.30000e+2  2.35000e+2 ││
    ││axis 3│ 1.44000e+2  1.47000e+2  ...  1.56000e+2  1.59000e+2 │ 1.92000e+2  1.96000e+2  ...  2.08000e+2  2.12000e+2 │ 2.40000e+2  2.45000e+2  ...  2.60000e+2  2.65000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 2.16000e+2  2.19000e+2  ...  2.28000e+2  2.31000e+2 │ 2.88000e+2  2.92000e+2  ...  3.04000e+2  3.08000e+2 │ 3.60000e+2  3.65000e+2  ...  3.80000e+2  3.85000e+2 ││
    ││      │ 2.34000e+2  2.37000e+2  ...  2.46000e+2  2.49000e+2 │ 3.12000e+2  3.16000e+2  ...  3.28000e+2  3.32000e+2 │ 3.90000e+2  3.95000e+2  ...  4.10000e+2  4.15000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 2.52000e+2  2.58000e+2  ...  2.76000e+2  2.82000e+2 │ 2.94000e+2  3.01000e+2  ...  3.22000e+2  3.29000e+2 │ 3.36000e+2  3.44000e+2  ...  3.68000e+2  3.76000e+2 ││
    ││axis 3│ 2.88000e+2  2.94000e+2  ...  3.12000e+2  3.18000e+2 │ 3.36000e+2  3.43000e+2  ...  3.64000e+2  3.71000e+2 │ 3.84000e+2  3.92000e+2  ...  4.16000e+2  4.24000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 4.32000e+2  4.38000e+2  ...  4.56000e+2  4.62000e+2 │ 5.04000e+2  5.11000e+2  ...  5.32000e+2  5.39000e+2 │ 5.76000e+2  5.84000e+2  ...  6.08000e+2  6.16000e+2 ││
    ││      │ 4.68000e+2  4.74000e+2  ...  4.92000e+2  4.98000e+2 │ 5.46000e+2  5.53000e+2  ...  5.74000e+2  5.81000e+2 │ 6.24000e+2  6.32000e+2  ...  6.56000e+2  6.64000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 3.78000e+2  3.87000e+2  ...  4.14000e+2  4.23000e+2 │ 4.20000e+2  4.30000e+2  ...  4.60000e+2  4.70000e+2 │ 4.62000e+2  4.73000e+2  ...  5.06000e+2  5.17000e+2 ││
    ││axis 3│ 4.32000e+2  4.41000e+2  ...  4.68000e+2  4.77000e+2 │ 4.80000e+2  4.90000e+2  ...  5.20000e+2  5.30000e+2 │ 5.28000e+2  5.39000e+2  ...  5.72000e+2  5.83000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 6.48000e+2  6.57000e+2  ...  6.84000e+2  6.93000e+2 │ 7.20000e+2  7.30000e+2  ...  7.60000e+2  7.70000e+2 │ 7.92000e+2  8.03000e+2  ...  8.36000e+2  8.47000e+2 ││
    ││      │ 7.02000e+2  7.11000e+2  ...  7.38000e+2  7.47000e+2 │ 7.80000e+2  7.90000e+2  ...  8.20000e+2  8.30000e+2 │ 8.58000e+2  8.69000e+2  ...  9.02000e+2  9.13000e+2 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000  0.00000  ...  0.00000  0.00000             │ 8.40000e+1  8.50000e+1  ...  8.80000e+1  8.90000e+1 │ 1.68000e+2  1.70000e+2  ...  1.76000e+2  1.78000e+2 ││
    ││axis 3│ 0.00000  0.00000  ...  0.00000  0.00000             │ 9.00000e+1  9.10000e+1  ...  9.40000e+1  9.50000e+1 │ 1.80000e+2  1.82000e+2  ...  1.88000e+2  1.90000e+2 ││
    ││      │ ...      ...      ...  ...      ...                 │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.14000e+2  1.15000e+2  ...  1.18000e+2  1.19000e+2 │ 2.28000e+2  2.30000e+2  ...  2.36000e+2  2.38000e+2 ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.20000e+2  1.21000e+2  ...  1.24000e+2  1.25000e+2 │ 2.40000e+2  2.42000e+2  ...  2.48000e+2  2.50000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 2.52000e+2  2.55000e+2  ...  2.64000e+2  2.67000e+2 │ 3.36000e+2  3.40000e+2  ...  3.52000e+2  3.56000e+2 │ 4.20000e+2  4.25000e+2  ...  4.40000e+2  4.45000e+2 ││
    ││axis 3│ 2.70000e+2  2.73000e+2  ...  2.82000e+2  2.85000e+2 │ 3.60000e+2  3.64000e+2  ...  3.76000e+2  3.80000e+2 │ 4.50000e+2  4.55000e+2  ...  4.70000e+2  4.75000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 3.42000e+2  3.45000e+2  ...  3.54000e+2  3.57000e+2 │ 4.56000e+2  4.60000e+2  ...  4.72000e+2  4.76000e+2 │ 5.70000e+2  5.75000e+2  ...  5.90000e+2  5.95000e+2 ││
    ││      │ 3.60000e+2  3.63000e+2  ...  3.72000e+2  3.75000e+2 │ 4.80000e+2  4.84000e+2  ...  4.96000e+2  5.00000e+2 │ 6.00000e+2  6.05000e+2  ...  6.20000e+2  6.25000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 5.04000e+2  5.10000e+2  ...  5.28000e+2  5.34000e+2 │ 5.88000e+2  5.95000e+2  ...  6.16000e+2  6.23000e+2 │ 6.72000e+2  6.80000e+2  ...  7.04000e+2  7.12000e+2 ││
    ││axis 3│ 5.40000e+2  5.46000e+2  ...  5.64000e+2  5.70000e+2 │ 6.30000e+2  6.37000e+2  ...  6.58000e+2  6.65000e+2 │ 7.20000e+2  7.28000e+2  ...  7.52000e+2  7.60000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 6.84000e+2  6.90000e+2  ...  7.08000e+2  7.14000e+2 │ 7.98000e+2  8.05000e+2  ...  8.26000e+2  8.33000e+2 │ 9.12000e+2  9.20000e+2  ...  9.44000e+2  9.52000e+2 ││
    ││      │ 7.20000e+2  7.26000e+2  ...  7.44000e+2  7.50000e+2 │ 8.40000e+2  8.47000e+2  ...  8.68000e+2  8.75000e+2 │ 9.60000e+2  9.68000e+2  ...  9.92000e+2  1.00000e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 7.56000e+2  7.65000e+2  ...  7.92000e+2  8.01000e+2 │ 8.40000e+2  8.50000e+2  ...  8.80000e+2  8.90000e+2 │ 9.24000e+2  9.35000e+2  ...  9.68000e+2  9.79000e+2 ││
    ││axis 3│ 8.10000e+2  8.19000e+2  ...  8.46000e+2  8.55000e+2 │ 9.00000e+2  9.10000e+2  ...  9.40000e+2  9.50000e+2 │ 9.90000e+2  1.00100e+3  ...  1.03400e+3  1.04500e+3 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.02600e+3  1.03500e+3  ...  1.06200e+3  1.07100e+3 │ 1.14000e+3  1.15000e+3  ...  1.18000e+3  1.19000e+3 │ 1.25400e+3  1.26500e+3  ...  1.29800e+3  1.30900e+3 ││
    ││      │ 1.08000e+3  1.08900e+3  ...  1.11600e+3  1.12500e+3 │ 1.20000e+3  1.21000e+3  ...  1.24000e+3  1.25000e+3 │ 1.32000e+3  1.33100e+3  ...  1.36400e+3  1.37500e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.26000e+2  1.27000e+2  ...  1.30000e+2  1.31000e+2 │ 2.52000e+2  2.54000e+2  ...  2.60000e+2  2.62000e+2 ││
    ││axis 3│ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.32000e+2  1.33000e+2  ...  1.36000e+2  1.37000e+2 │ 2.64000e+2  2.66000e+2  ...  2.72000e+2  2.74000e+2 ││
    ││      │ ...      ...      ...  ...      ...                 │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.56000e+2  1.57000e+2  ...  1.60000e+2  1.61000e+2 │ 3.12000e+2  3.14000e+2  ...  3.20000e+2  3.22000e+2 ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.62000e+2  1.63000e+2  ...  1.66000e+2  1.67000e+2 │ 3.24000e+2  3.26000e+2  ...  3.32000e+2  3.34000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 3.78000e+2  3.81000e+2  ...  3.90000e+2  3.93000e+2 │ 5.04000e+2  5.08000e+2  ...  5.20000e+2  5.24000e+2 │ 6.30000e+2  6.35000e+2  ...  6.50000e+2  6.55000e+2 ││
    ││axis 3│ 3.96000e+2  3.99000e+2  ...  4.08000e+2  4.11000e+2 │ 5.28000e+2  5.32000e+2  ...  5.44000e+2  5.48000e+2 │ 6.60000e+2  6.65000e+2  ...  6.80000e+2  6.85000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 4.68000e+2  4.71000e+2  ...  4.80000e+2  4.83000e+2 │ 6.24000e+2  6.28000e+2  ...  6.40000e+2  6.44000e+2 │ 7.80000e+2  7.85000e+2  ...  8.00000e+2  8.05000e+2 ││
    ││      │ 4.86000e+2  4.89000e+2  ...  4.98000e+2  5.01000e+2 │ 6.48000e+2  6.52000e+2  ...  6.64000e+2  6.68000e+2 │ 8.10000e+2  8.15000e+2  ...  8.30000e+2  8.35000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 7.56000e+2  7.62000e+2  ...  7.80000e+2  7.86000e+2 │ 8.82000e+2  8.89000e+2  ...  9.10000e+2  9.17000e+2 │ 1.00800e+3  1.01600e+3  ...  1.04000e+3  1.04800e+3 ││
    ││axis 3│ 7.92000e+2  7.98000e+2  ...  8.16000e+2  8.22000e+2 │ 9.24000e+2  9.31000e+2  ...  9.52000e+2  9.59000e+2 │ 1.05600e+3  1.06400e+3  ...  1.08800e+3  1.09600e+3 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 9.36000e+2  9.42000e+2  ...  9.60000e+2  9.66000e+2 │ 1.09200e+3  1.09900e+3  ...  1.12000e+3  1.12700e+3 │ 1.24800e+3  1.25600e+3  ...  1.28000e+3  1.28800e+3 ││
    ││      │ 9.72000e+2  9.78000e+2  ...  9.96000e+2  1.00200e+3 │ 1.13400e+3  1.14100e+3  ...  1.16200e+3  1.16900e+3 │ 1.29600e+3  1.30400e+3  ...  1.32800e+3  1.33600e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.13400e+3  1.14300e+3  ...  1.17000e+3  1.17900e+3 │ 1.26000e+3  1.27000e+3  ...  1.30000e+3  1.31000e+3 │ 1.38600e+3  1.39700e+3  ...  1.43000e+3  1.44100e+3 ││
    ││axis 3│ 1.18800e+3  1.19700e+3  ...  1.22400e+3  1.23300e+3 │ 1.32000e+3  1.33000e+3  ...  1.36000e+3  1.37000e+3 │ 1.45200e+3  1.46300e+3  ...  1.49600e+3  1.50700e+3 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.40400e+3  1.41300e+3  ...  1.44000e+3  1.44900e+3 │ 1.56000e+3  1.57000e+3  ...  1.60000e+3  1.61000e+3 │ 1.71600e+3  1.72700e+3  ...  1.76000e+3  1.77100e+3 ││
    ││      │ 1.45800e+3  1.46700e+3  ...  1.49400e+3  1.50300e+3 │ 1.62000e+3  1.63000e+3  ...  1.66000e+3  1.67000e+3 │ 1.78200e+3  1.79300e+3  ...  1.82600e+3  1.83700e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.68000e+2  1.69000e+2  ...  1.72000e+2  1.73000e+2 │ 3.36000e+2  3.38000e+2  ...  3.44000e+2  3.46000e+2 ││
    ││axis 3│ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.74000e+2  1.75000e+2  ...  1.78000e+2  1.79000e+2 │ 3.48000e+2  3.50000e+2  ...  3.56000e+2  3.58000e+2 ││
    ││      │ ...      ...      ...  ...      ...                 │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 1.98000e+2  1.99000e+2  ...  2.02000e+2  2.03000e+2 │ 3.96000e+2  3.98000e+2  ...  4.04000e+2  4.06000e+2 ││
    ││      │ 0.00000  0.00000  ...  0.00000  0.00000             │ 2.04000e+2  2.05000e+2  ...  2.08000e+2  2.09000e+2 │ 4.08000e+2  4.10000e+2  ...  4.16000e+2  4.18000e+2 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 5.04000e+2  5.07000e+2  ...  5.16000e+2  5.19000e+2 │ 6.72000e+2  6.76000e+2  ...  6.88000e+2  6.92000e+2 │ 8.40000e+2  8.45000e+2  ...  8.60000e+2  8.65000e+2 ││
    ││axis 3│ 5.22000e+2  5.25000e+2  ...  5.34000e+2  5.37000e+2 │ 6.96000e+2  7.00000e+2  ...  7.12000e+2  7.16000e+2 │ 8.70000e+2  8.75000e+2  ...  8.90000e+2  8.95000e+2 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 5.94000e+2  5.97000e+2  ...  6.06000e+2  6.09000e+2 │ 7.92000e+2  7.96000e+2  ...  8.08000e+2  8.12000e+2 │ 9.90000e+2  9.95000e+2  ...  1.01000e+3  1.01500e+3 ││
    ││      │ 6.12000e+2  6.15000e+2  ...  6.24000e+2  6.27000e+2 │ 8.16000e+2  8.20000e+2  ...  8.32000e+2  8.36000e+2 │ 1.02000e+3  1.02500e+3  ...  1.04000e+3  1.04500e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││2 @ 2 │ 1.00800e+3  1.01400e+3  ...  1.03200e+3  1.03800e+3 │ 1.17600e+3  1.18300e+3  ...  1.20400e+3  1.21100e+3 │ 1.34400e+3  1.35200e+3  ...  1.37600e+3  1.38400e+3 ││
    ││axis 3│ 1.04400e+3  1.05000e+3  ...  1.06800e+3  1.07400e+3 │ 1.21800e+3  1.22500e+3  ...  1.24600e+3  1.25300e+3 │ 1.39200e+3  1.40000e+3  ...  1.42400e+3  1.43200e+3 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.18800e+3  1.19400e+3  ...  1.21200e+3  1.21800e+3 │ 1.38600e+3  1.39300e+3  ...  1.41400e+3  1.42100e+3 │ 1.58400e+3  1.59200e+3  ...  1.61600e+3  1.62400e+3 ││
    ││      │ 1.22400e+3  1.23000e+3  ...  1.24800e+3  1.25400e+3 │ 1.42800e+3  1.43500e+3  ...  1.45600e+3  1.46300e+3 │ 1.63200e+3  1.64000e+3  ...  1.66400e+3  1.67200e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││3 @ 2 │ 1.51200e+3  1.52100e+3  ...  1.54800e+3  1.55700e+3 │ 1.68000e+3  1.69000e+3  ...  1.72000e+3  1.73000e+3 │ 1.84800e+3  1.85900e+3  ...  1.89200e+3  1.90300e+3 ││
    ││axis 3│ 1.56600e+3  1.57500e+3  ...  1.60200e+3  1.61100e+3 │ 1.74000e+3  1.75000e+3  ...  1.78000e+3  1.79000e+3 │ 1.91400e+3  1.92500e+3  ...  1.95800e+3  1.96900e+3 ││
    ││      │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        │ ...         ...         ...  ...         ...        ││
    ││      │ 1.78200e+3  1.79100e+3  ...  1.81800e+3  1.82700e+3 │ 1.98000e+3  1.99000e+3  ...  2.02000e+3  2.03000e+3 │ 2.17800e+3  2.18900e+3  ...  2.22200e+3  2.23300e+3 ││
    ││      │ 1.83600e+3  1.84500e+3  ...  1.87200e+3  1.88100e+3 │ 2.04000e+3  2.05000e+3  ...  2.08000e+3  2.09000e+3 │ 2.24400e+3  2.25500e+3  ...  2.28800e+3  2.29900e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum matrix/inner+outer products" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 4 ] ~output_dims:[ 5 ] () in
  let%op a2 = a *+ "b|i->o; b|i->o => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx a2 in
  let%op c = b *+ "b|h->o; b|i->h => b|i->o" a in
  let ctx = Train.forward_and_ctx backend ctx c in
  let%op d = a *+ "a|i->h; b|h->o => ab|i->o" b in
  Train.forward_and_forget backend ctx d;
  let%op e = a *+ "b|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx e;
  let%op f = a *+ "a|i->h; b|h->o => i->o" b in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_a2 shape 0:2|2:3->1:4                                                    │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                               ││
    ││      │axis 2                              │axis 2                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000     1.00000     4.00000    │ 1.44000e+2  1.69000e+2  1.96000e+2 ││
    ││      │ 9.00000     1.60000e+1  2.50000e+1 │ 2.25000e+2  2.56000e+2  2.89000e+2 ││
    ││      │ 3.60000e+1  4.90000e+1  6.40000e+1 │ 3.24000e+2  3.61000e+2  4.00000e+2 ││
    ││      │ 8.10000e+1  1.00000e+2  1.21000e+2 │ 4.41000e+2  4.84000e+2  5.29000e+2 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │[3]: ;=>_c shape 0:2|2:3->1:5                                                     │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                               ││
    ││      │axis 2                              │axis 2                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 4.20000e+1  4.80000e+1  5.40000e+1 │ 1.43400e+3  1.52000e+3  1.60600e+3 ││
    ││      │ 1.14000e+2  1.36000e+2  1.58000e+2 │ 1.69800e+3  1.80000e+3  1.90200e+3 ││
    ││      │ 1.86000e+2  2.24000e+2  2.62000e+2 │ 1.96200e+3  2.08000e+3  2.19800e+3 ││
    ││      │ 2.58000e+2  3.12000e+2  3.66000e+2 │ 2.22600e+3  2.36000e+3  2.49400e+3 ││
    ││      │ 3.30000e+2  4.00000e+2  4.70000e+2 │ 2.49000e+3  2.64000e+3  2.79000e+3 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │[4]: ;=>_d shape 0:2,1:2|3:3->2:5                                                 │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 1                               │1 @ 1                               ││
    ││      │axis 3                              │axis 3                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││0 @ 0 │ 4.20000e+1  4.80000e+1  5.40000e+1 │ 4.02000e+2  4.88000e+2  5.74000e+2 ││
    ││axis 2│ 1.14000e+2  1.36000e+2  1.58000e+2 │ 4.74000e+2  5.76000e+2  6.78000e+2 ││
    ││      │ 1.86000e+2  2.24000e+2  2.62000e+2 │ 5.46000e+2  6.64000e+2  7.82000e+2 ││
    ││      │ 2.58000e+2  3.12000e+2  3.66000e+2 │ 6.18000e+2  7.52000e+2  8.86000e+2 ││
    ││      │ 3.30000e+2  4.00000e+2  4.70000e+2 │ 6.90000e+2  8.40000e+2  9.90000e+2 ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││1 @ 0 │ 1.14000e+2  1.20000e+2  1.26000e+2 │ 1.43400e+3  1.52000e+3  1.60600e+3 ││
    ││axis 2│ 3.78000e+2  4.00000e+2  4.22000e+2 │ 1.69800e+3  1.80000e+3  1.90200e+3 ││
    ││      │ 6.42000e+2  6.80000e+2  7.18000e+2 │ 1.96200e+3  2.08000e+3  2.19800e+3 ││
    ││      │ 9.06000e+2  9.60000e+2  1.01400e+3 │ 2.22600e+3  2.36000e+3  2.49400e+3 ││
    ││      │ 1.17000e+3  1.24000e+3  1.31000e+3 │ 2.49000e+3  2.64000e+3  2.79000e+3 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌─────────────────────────────────────────────┐
    │[5]: ;=>_e shape 1:3->0:5                    │
    │┌──────┬────────────────────────────────────┐│
    ││      │axis 1                              ││
    │├──────┼────────────────────────────────────┤│
    ││axis 0│ 1.47600e+3  1.56800e+3  1.66000e+3 ││
    ││      │ 1.81200e+3  1.93600e+3  2.06000e+3 ││
    ││      │ 2.14800e+3  2.30400e+3  2.46000e+3 ││
    ││      │ 2.48400e+3  2.67200e+3  2.86000e+3 ││
    ││      │ 2.82000e+3  3.04000e+3  3.26000e+3 ││
    │└──────┴────────────────────────────────────┘│
    └─────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────────────────┐
    │[6]: ;=>_f shape 1:3->0:5                    │
    │┌──────┬────────────────────────────────────┐│
    ││      │axis 1                              ││
    │├──────┼────────────────────────────────────┤│
    ││axis 0│ 1.99200e+3  2.17600e+3  2.36000e+3 ││
    ││      │ 2.66400e+3  2.91200e+3  3.16000e+3 ││
    ││      │ 3.33600e+3  3.64800e+3  3.96000e+3 ││
    ││      │ 4.00800e+3  4.38400e+3  4.76000e+3 ││
    ││      │ 4.68000e+3  5.12000e+3  5.56000e+3 ││
    │└──────┴────────────────────────────────────┘│
    └─────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|i->o => ...|o->i" in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|2:4->1:3                                                                    │
    │┌──────┬───────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                  │1 @ 0                                           ││
    ││      │axis 2                                 │axis 2                                          ││
    │├──────┼───────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.00000  3.00000  6.00000  9.00000    │ 1.20000e+1  1.50000e+1  1.80000e+1  2.10000e+1 ││
    ││      │ 1.00000  4.00000  7.00000  1.00000e+1 │ 1.30000e+1  1.60000e+1  1.90000e+1  2.20000e+1 ││
    ││      │ 2.00000  5.00000  8.00000  1.10000e+1 │ 1.40000e+1  1.70000e+1  2.00000e+1  2.30000e+1 ││
    │└──────┴───────────────────────────────────────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "b|...->o => o|...->b" in
  Train.forward_and_forget backend ctx ho2;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:4|2:3->1:2                                                                                                                              │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                               │2 @ 0                               │3 @ 0                               ││
    ││      │axis 2                              │axis 2                              │axis 2                              │axis 2                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000     1.00000     2.00000    │ 3.00000     4.00000     5.00000    │ 6.00000     7.00000     8.00000    │ 9.00000     1.00000e+1  1.10000e+1 ││
    ││      │ 1.20000e+1  1.30000e+1  1.40000e+1 │ 1.50000e+1  1.60000e+1  1.70000e+1 │ 1.80000e+1  1.90000e+1  2.00000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┴────────────────────────────────────┴────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let hey2 =
    TDSL.range_of_shape ~batch_dims:[ 2; 3 ] ~input_dims:[ 4; 5 ] ~output_dims:[ 6; 7 ] ()
  in
  let%op ho3 = hey2 ++ "...b|...i->...o => ...i|...o->...b" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[3]: r2x3x6x7x4x5 shape 0:2,1:3|4:4,5:5->2:6,3:7                                                                                                                                                                                                            │
    │┌──────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                       │1 @ 4                                                       │2 @ 4                                                       │3 @ 4                                                       ││
    ││      │axis 5                                                      │axis 5                                                      │axis 5                                                      │axis 5                                                      ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000     1.00000     2.00000     3.00000     4.00000    │ 5.00000     6.00000     7.00000     8.00000     9.00000    │ 1.00000e+1  1.10000e+1  1.20000e+1  1.30000e+1  1.40000e+1 │ 1.50000e+1  1.60000e+1  1.70000e+1  1.80000e+1  1.90000e+1 ││
    ││axis 3│ 2.00000e+1  2.10000e+1  2.20000e+1  2.30000e+1  2.40000e+1 │ 2.50000e+1  2.60000e+1  2.70000e+1  2.80000e+1  2.90000e+1 │ 3.00000e+1  3.10000e+1  3.20000e+1  3.30000e+1  3.40000e+1 │ 3.50000e+1  3.60000e+1  3.70000e+1  3.80000e+1  3.90000e+1 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.00000e+2  1.01000e+2  1.02000e+2  1.03000e+2  1.04000e+2 │ 1.05000e+2  1.06000e+2  1.07000e+2  1.08000e+2  1.09000e+2 │ 1.10000e+2  1.11000e+2  1.12000e+2  1.13000e+2  1.14000e+2 │ 1.15000e+2  1.16000e+2  1.17000e+2  1.18000e+2  1.19000e+2 ││
    ││      │ 1.20000e+2  1.21000e+2  1.22000e+2  1.23000e+2  1.24000e+2 │ 1.25000e+2  1.26000e+2  1.27000e+2  1.28000e+2  1.29000e+2 │ 1.30000e+2  1.31000e+2  1.32000e+2  1.33000e+2  1.34000e+2 │ 1.35000e+2  1.36000e+2  1.37000e+2  1.38000e+2  1.39000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.40000e+2  1.41000e+2  1.42000e+2  1.43000e+2  1.44000e+2 │ 1.45000e+2  1.46000e+2  1.47000e+2  1.48000e+2  1.49000e+2 │ 1.50000e+2  1.51000e+2  1.52000e+2  1.53000e+2  1.54000e+2 │ 1.55000e+2  1.56000e+2  1.57000e+2  1.58000e+2  1.59000e+2 ││
    ││axis 3│ 1.60000e+2  1.61000e+2  1.62000e+2  1.63000e+2  1.64000e+2 │ 1.65000e+2  1.66000e+2  1.67000e+2  1.68000e+2  1.69000e+2 │ 1.70000e+2  1.71000e+2  1.72000e+2  1.73000e+2  1.74000e+2 │ 1.75000e+2  1.76000e+2  1.77000e+2  1.78000e+2  1.79000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 2.40000e+2  2.41000e+2  2.42000e+2  2.43000e+2  2.44000e+2 │ 2.45000e+2  2.46000e+2  2.47000e+2  2.48000e+2  2.49000e+2 │ 2.50000e+2  2.51000e+2  2.52000e+2  2.53000e+2  2.54000e+2 │ 2.55000e+2  2.56000e+2  2.57000e+2  2.58000e+2  2.59000e+2 ││
    ││      │ 2.60000e+2  2.61000e+2  2.62000e+2  2.63000e+2  2.64000e+2 │ 2.65000e+2  2.66000e+2  2.67000e+2  2.68000e+2  2.69000e+2 │ 2.70000e+2  2.71000e+2  2.72000e+2  2.73000e+2  2.74000e+2 │ 2.75000e+2  2.76000e+2  2.77000e+2  2.78000e+2  2.79000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                        │ ...                                                        │ ...                                                        │ ...                                                        ││
    ││axis 3│                                                            │                                                            │                                                            │                                                            ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.60000e+2  5.61000e+2  5.62000e+2  5.63000e+2  5.64000e+2 │ 5.65000e+2  5.66000e+2  5.67000e+2  5.68000e+2  5.69000e+2 │ 5.70000e+2  5.71000e+2  5.72000e+2  5.73000e+2  5.74000e+2 │ 5.75000e+2  5.76000e+2  5.77000e+2  5.78000e+2  5.79000e+2 ││
    ││axis 3│ 5.80000e+2  5.81000e+2  5.82000e+2  5.83000e+2  5.84000e+2 │ 5.85000e+2  5.86000e+2  5.87000e+2  5.88000e+2  5.89000e+2 │ 5.90000e+2  5.91000e+2  5.92000e+2  5.93000e+2  5.94000e+2 │ 5.95000e+2  5.96000e+2  5.97000e+2  5.98000e+2  5.99000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 6.60000e+2  6.61000e+2  6.62000e+2  6.63000e+2  6.64000e+2 │ 6.65000e+2  6.66000e+2  6.67000e+2  6.68000e+2  6.69000e+2 │ 6.70000e+2  6.71000e+2  6.72000e+2  6.73000e+2  6.74000e+2 │ 6.75000e+2  6.76000e+2  6.77000e+2  6.78000e+2  6.79000e+2 ││
    ││      │ 6.80000e+2  6.81000e+2  6.82000e+2  6.83000e+2  6.84000e+2 │ 6.85000e+2  6.86000e+2  6.87000e+2  6.88000e+2  6.89000e+2 │ 6.90000e+2  6.91000e+2  6.92000e+2  6.93000e+2  6.94000e+2 │ 6.95000e+2  6.96000e+2  6.97000e+2  6.98000e+2  6.99000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.00000e+2  7.01000e+2  7.02000e+2  7.03000e+2  7.04000e+2 │ 7.05000e+2  7.06000e+2  7.07000e+2  7.08000e+2  7.09000e+2 │ 7.10000e+2  7.11000e+2  7.12000e+2  7.13000e+2  7.14000e+2 │ 7.15000e+2  7.16000e+2  7.17000e+2  7.18000e+2  7.19000e+2 ││
    ││axis 3│ 7.20000e+2  7.21000e+2  7.22000e+2  7.23000e+2  7.24000e+2 │ 7.25000e+2  7.26000e+2  7.27000e+2  7.28000e+2  7.29000e+2 │ 7.30000e+2  7.31000e+2  7.32000e+2  7.33000e+2  7.34000e+2 │ 7.35000e+2  7.36000e+2  7.37000e+2  7.38000e+2  7.39000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 8.00000e+2  8.01000e+2  8.02000e+2  8.03000e+2  8.04000e+2 │ 8.05000e+2  8.06000e+2  8.07000e+2  8.08000e+2  8.09000e+2 │ 8.10000e+2  8.11000e+2  8.12000e+2  8.13000e+2  8.14000e+2 │ 8.15000e+2  8.16000e+2  8.17000e+2  8.18000e+2  8.19000e+2 ││
    ││      │ 8.20000e+2  8.21000e+2  8.22000e+2  8.23000e+2  8.24000e+2 │ 8.25000e+2  8.26000e+2  8.27000e+2  8.28000e+2  8.29000e+2 │ 8.30000e+2  8.31000e+2  8.32000e+2  8.33000e+2  8.34000e+2 │ 8.35000e+2  8.36000e+2  8.37000e+2  8.38000e+2  8.39000e+2 ││
    │└──────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                       │1 @ 4                                                       │2 @ 4                                                       │3 @ 4                                                       ││
    ││      │axis 5                                                      │axis 5                                                      │axis 5                                                      │axis 5                                                      ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 8.40000e+2  8.41000e+2  8.42000e+2  8.43000e+2  8.44000e+2 │ 8.45000e+2  8.46000e+2  8.47000e+2  8.48000e+2  8.49000e+2 │ 8.50000e+2  8.51000e+2  8.52000e+2  8.53000e+2  8.54000e+2 │ 8.55000e+2  8.56000e+2  8.57000e+2  8.58000e+2  8.59000e+2 ││
    ││axis 3│ 8.60000e+2  8.61000e+2  8.62000e+2  8.63000e+2  8.64000e+2 │ 8.65000e+2  8.66000e+2  8.67000e+2  8.68000e+2  8.69000e+2 │ 8.70000e+2  8.71000e+2  8.72000e+2  8.73000e+2  8.74000e+2 │ 8.75000e+2  8.76000e+2  8.77000e+2  8.78000e+2  8.79000e+2 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 9.40000e+2  9.41000e+2  9.42000e+2  9.43000e+2  9.44000e+2 │ 9.45000e+2  9.46000e+2  9.47000e+2  9.48000e+2  9.49000e+2 │ 9.50000e+2  9.51000e+2  9.52000e+2  9.53000e+2  9.54000e+2 │ 9.55000e+2  9.56000e+2  9.57000e+2  9.58000e+2  9.59000e+2 ││
    ││      │ 9.60000e+2  9.61000e+2  9.62000e+2  9.63000e+2  9.64000e+2 │ 9.65000e+2  9.66000e+2  9.67000e+2  9.68000e+2  9.69000e+2 │ 9.70000e+2  9.71000e+2  9.72000e+2  9.73000e+2  9.74000e+2 │ 9.75000e+2  9.76000e+2  9.77000e+2  9.78000e+2  9.79000e+2 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 9.80000e+2  9.81000e+2  9.82000e+2  9.83000e+2  9.84000e+2 │ 9.85000e+2  9.86000e+2  9.87000e+2  9.88000e+2  9.89000e+2 │ 9.90000e+2  9.91000e+2  9.92000e+2  9.93000e+2  9.94000e+2 │ 9.95000e+2  9.96000e+2  9.97000e+2  9.98000e+2  9.99000e+2 ││
    ││axis 3│ 1.00000e+3  1.00100e+3  1.00200e+3  1.00300e+3  1.00400e+3 │ 1.00500e+3  1.00600e+3  1.00700e+3  1.00800e+3  1.00900e+3 │ 1.01000e+3  1.01100e+3  1.01200e+3  1.01300e+3  1.01400e+3 │ 1.01500e+3  1.01600e+3  1.01700e+3  1.01800e+3  1.01900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.08000e+3  1.08100e+3  1.08200e+3  1.08300e+3  1.08400e+3 │ 1.08500e+3  1.08600e+3  1.08700e+3  1.08800e+3  1.08900e+3 │ 1.09000e+3  1.09100e+3  1.09200e+3  1.09300e+3  1.09400e+3 │ 1.09500e+3  1.09600e+3  1.09700e+3  1.09800e+3  1.09900e+3 ││
    ││      │ 1.10000e+3  1.10100e+3  1.10200e+3  1.10300e+3  1.10400e+3 │ 1.10500e+3  1.10600e+3  1.10700e+3  1.10800e+3  1.10900e+3 │ 1.11000e+3  1.11100e+3  1.11200e+3  1.11300e+3  1.11400e+3 │ 1.11500e+3  1.11600e+3  1.11700e+3  1.11800e+3  1.11900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                        │ ...                                                        │ ...                                                        │ ...                                                        ││
    ││axis 3│                                                            │                                                            │                                                            │                                                            ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 1.40000e+3  1.40100e+3  1.40200e+3  1.40300e+3  1.40400e+3 │ 1.40500e+3  1.40600e+3  1.40700e+3  1.40800e+3  1.40900e+3 │ 1.41000e+3  1.41100e+3  1.41200e+3  1.41300e+3  1.41400e+3 │ 1.41500e+3  1.41600e+3  1.41700e+3  1.41800e+3  1.41900e+3 ││
    ││axis 3│ 1.42000e+3  1.42100e+3  1.42200e+3  1.42300e+3  1.42400e+3 │ 1.42500e+3  1.42600e+3  1.42700e+3  1.42800e+3  1.42900e+3 │ 1.43000e+3  1.43100e+3  1.43200e+3  1.43300e+3  1.43400e+3 │ 1.43500e+3  1.43600e+3  1.43700e+3  1.43800e+3  1.43900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.50000e+3  1.50100e+3  1.50200e+3  1.50300e+3  1.50400e+3 │ 1.50500e+3  1.50600e+3  1.50700e+3  1.50800e+3  1.50900e+3 │ 1.51000e+3  1.51100e+3  1.51200e+3  1.51300e+3  1.51400e+3 │ 1.51500e+3  1.51600e+3  1.51700e+3  1.51800e+3  1.51900e+3 ││
    ││      │ 1.52000e+3  1.52100e+3  1.52200e+3  1.52300e+3  1.52400e+3 │ 1.52500e+3  1.52600e+3  1.52700e+3  1.52800e+3  1.52900e+3 │ 1.53000e+3  1.53100e+3  1.53200e+3  1.53300e+3  1.53400e+3 │ 1.53500e+3  1.53600e+3  1.53700e+3  1.53800e+3  1.53900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 1.54000e+3  1.54100e+3  1.54200e+3  1.54300e+3  1.54400e+3 │ 1.54500e+3  1.54600e+3  1.54700e+3  1.54800e+3  1.54900e+3 │ 1.55000e+3  1.55100e+3  1.55200e+3  1.55300e+3  1.55400e+3 │ 1.55500e+3  1.55600e+3  1.55700e+3  1.55800e+3  1.55900e+3 ││
    ││axis 3│ 1.56000e+3  1.56100e+3  1.56200e+3  1.56300e+3  1.56400e+3 │ 1.56500e+3  1.56600e+3  1.56700e+3  1.56800e+3  1.56900e+3 │ 1.57000e+3  1.57100e+3  1.57200e+3  1.57300e+3  1.57400e+3 │ 1.57500e+3  1.57600e+3  1.57700e+3  1.57800e+3  1.57900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.64000e+3  1.64100e+3  1.64200e+3  1.64300e+3  1.64400e+3 │ 1.64500e+3  1.64600e+3  1.64700e+3  1.64800e+3  1.64900e+3 │ 1.65000e+3  1.65100e+3  1.65200e+3  1.65300e+3  1.65400e+3 │ 1.65500e+3  1.65600e+3  1.65700e+3  1.65800e+3  1.65900e+3 ││
    ││      │ 1.66000e+3  1.66100e+3  1.66200e+3  1.66300e+3  1.66400e+3 │ 1.66500e+3  1.66600e+3  1.66700e+3  1.66800e+3  1.66900e+3 │ 1.67000e+3  1.67100e+3  1.67200e+3  1.67300e+3  1.67400e+3 │ 1.67500e+3  1.67600e+3  1.67700e+3  1.67800e+3  1.67900e+3 ││
    │└──────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                       │1 @ 4                                                       │2 @ 4                                                       │3 @ 4                                                       ││
    ││      │axis 5                                                      │axis 5                                                      │axis 5                                                      │axis 5                                                      ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.68000e+3  1.68100e+3  1.68200e+3  1.68300e+3  1.68400e+3 │ 1.68500e+3  1.68600e+3  1.68700e+3  1.68800e+3  1.68900e+3 │ 1.69000e+3  1.69100e+3  1.69200e+3  1.69300e+3  1.69400e+3 │ 1.69500e+3  1.69600e+3  1.69700e+3  1.69800e+3  1.69900e+3 ││
    ││axis 3│ 1.70000e+3  1.70100e+3  1.70200e+3  1.70300e+3  1.70400e+3 │ 1.70500e+3  1.70600e+3  1.70700e+3  1.70800e+3  1.70900e+3 │ 1.71000e+3  1.71100e+3  1.71200e+3  1.71300e+3  1.71400e+3 │ 1.71500e+3  1.71600e+3  1.71700e+3  1.71800e+3  1.71900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.78000e+3  1.78100e+3  1.78200e+3  1.78300e+3  1.78400e+3 │ 1.78500e+3  1.78600e+3  1.78700e+3  1.78800e+3  1.78900e+3 │ 1.79000e+3  1.79100e+3  1.79200e+3  1.79300e+3  1.79400e+3 │ 1.79500e+3  1.79600e+3  1.79700e+3  1.79800e+3  1.79900e+3 ││
    ││      │ 1.80000e+3  1.80100e+3  1.80200e+3  1.80300e+3  1.80400e+3 │ 1.80500e+3  1.80600e+3  1.80700e+3  1.80800e+3  1.80900e+3 │ 1.81000e+3  1.81100e+3  1.81200e+3  1.81300e+3  1.81400e+3 │ 1.81500e+3  1.81600e+3  1.81700e+3  1.81800e+3  1.81900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.82000e+3  1.82100e+3  1.82200e+3  1.82300e+3  1.82400e+3 │ 1.82500e+3  1.82600e+3  1.82700e+3  1.82800e+3  1.82900e+3 │ 1.83000e+3  1.83100e+3  1.83200e+3  1.83300e+3  1.83400e+3 │ 1.83500e+3  1.83600e+3  1.83700e+3  1.83800e+3  1.83900e+3 ││
    ││axis 3│ 1.84000e+3  1.84100e+3  1.84200e+3  1.84300e+3  1.84400e+3 │ 1.84500e+3  1.84600e+3  1.84700e+3  1.84800e+3  1.84900e+3 │ 1.85000e+3  1.85100e+3  1.85200e+3  1.85300e+3  1.85400e+3 │ 1.85500e+3  1.85600e+3  1.85700e+3  1.85800e+3  1.85900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 1.92000e+3  1.92100e+3  1.92200e+3  1.92300e+3  1.92400e+3 │ 1.92500e+3  1.92600e+3  1.92700e+3  1.92800e+3  1.92900e+3 │ 1.93000e+3  1.93100e+3  1.93200e+3  1.93300e+3  1.93400e+3 │ 1.93500e+3  1.93600e+3  1.93700e+3  1.93800e+3  1.93900e+3 ││
    ││      │ 1.94000e+3  1.94100e+3  1.94200e+3  1.94300e+3  1.94400e+3 │ 1.94500e+3  1.94600e+3  1.94700e+3  1.94800e+3  1.94900e+3 │ 1.95000e+3  1.95100e+3  1.95200e+3  1.95300e+3  1.95400e+3 │ 1.95500e+3  1.95600e+3  1.95700e+3  1.95800e+3  1.95900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                        │ ...                                                        │ ...                                                        │ ...                                                        ││
    ││axis 3│                                                            │                                                            │                                                            │                                                            ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 2.24000e+3  2.24100e+3  2.24200e+3  2.24300e+3  2.24400e+3 │ 2.24500e+3  2.24600e+3  2.24700e+3  2.24800e+3  2.24900e+3 │ 2.25000e+3  2.25100e+3  2.25200e+3  2.25300e+3  2.25400e+3 │ 2.25500e+3  2.25600e+3  2.25700e+3  2.25800e+3  2.25900e+3 ││
    ││axis 3│ 2.26000e+3  2.26100e+3  2.26200e+3  2.26300e+3  2.26400e+3 │ 2.26500e+3  2.26600e+3  2.26700e+3  2.26800e+3  2.26900e+3 │ 2.27000e+3  2.27100e+3  2.27200e+3  2.27300e+3  2.27400e+3 │ 2.27500e+3  2.27600e+3  2.27700e+3  2.27800e+3  2.27900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 2.34000e+3  2.34100e+3  2.34200e+3  2.34300e+3  2.34400e+3 │ 2.34500e+3  2.34600e+3  2.34700e+3  2.34800e+3  2.34900e+3 │ 2.35000e+3  2.35100e+3  2.35200e+3  2.35300e+3  2.35400e+3 │ 2.35500e+3  2.35600e+3  2.35700e+3  2.35800e+3  2.35900e+3 ││
    ││      │ 2.36000e+3  2.36100e+3  2.36200e+3  2.36300e+3  2.36400e+3 │ 2.36500e+3  2.36600e+3  2.36700e+3  2.36800e+3  2.36900e+3 │ 2.37000e+3  2.37100e+3  2.37200e+3  2.37300e+3  2.37400e+3 │ 2.37500e+3  2.37600e+3  2.37700e+3  2.37800e+3  2.37900e+3 ││
    │├──────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 2.38000e+3  2.38100e+3  2.38200e+3  2.38300e+3  2.38400e+3 │ 2.38500e+3  2.38600e+3  2.38700e+3  2.38800e+3  2.38900e+3 │ 2.39000e+3  2.39100e+3  2.39200e+3  2.39300e+3  2.39400e+3 │ 2.39500e+3  2.39600e+3  2.39700e+3  2.39800e+3  2.39900e+3 ││
    ││axis 3│ 2.40000e+3  2.40100e+3  2.40200e+3  2.40300e+3  2.40400e+3 │ 2.40500e+3  2.40600e+3  2.40700e+3  2.40800e+3  2.40900e+3 │ 2.41000e+3  2.41100e+3  2.41200e+3  2.41300e+3  2.41400e+3 │ 2.41500e+3  2.41600e+3  2.41700e+3  2.41800e+3  2.41900e+3 ││
    ││      │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        │ ...         ...         ...         ...         ...        ││
    ││      │ 2.48000e+3  2.48100e+3  2.48200e+3  2.48300e+3  2.48400e+3 │ 2.48500e+3  2.48600e+3  2.48700e+3  2.48800e+3  2.48900e+3 │ 2.49000e+3  2.49100e+3  2.49200e+3  2.49300e+3  2.49400e+3 │ 2.49500e+3  2.49600e+3  2.49700e+3  2.49800e+3  2.49900e+3 ││
    ││      │ 2.50000e+3  2.50100e+3  2.50200e+3  2.50300e+3  2.50400e+3 │ 2.50500e+3  2.50600e+3  2.50700e+3  2.50800e+3  2.50900e+3 │ 2.51000e+3  2.51100e+3  2.51200e+3  2.51300e+3  2.51400e+3 │ 2.51500e+3  2.51600e+3  2.51700e+3  2.51800e+3  2.51900e+3 ││
    │└──────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[4]: =>_ho3 shape 0:2,1:5|4:4,5:7->2:6,3:3                                                                                                                                                                                      │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││0 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                │3 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 0.00000     2.00000e+1  ...  1.00000e+2  1.20000e+2 │ 5.00000     2.50000e+1  ...  1.05000e+2  1.25000e+2 │ 1.00000e+1  3.00000e+1  ...  1.10000e+2  1.30000e+2 │ 1.50000e+1  3.50000e+1  ...  1.15000e+2  1.35000e+2 ││
    ││axis 3│ 8.40000e+2  8.60000e+2  ...  9.40000e+2  9.60000e+2 │ 8.45000e+2  8.65000e+2  ...  9.45000e+2  9.65000e+2 │ 8.50000e+2  8.70000e+2  ...  9.50000e+2  9.70000e+2 │ 8.55000e+2  8.75000e+2  ...  9.55000e+2  9.75000e+2 ││
    ││      │ 1.68000e+3  1.70000e+3  ...  1.78000e+3  1.80000e+3 │ 1.68500e+3  1.70500e+3  ...  1.78500e+3  1.80500e+3 │ 1.69000e+3  1.71000e+3  ...  1.79000e+3  1.81000e+3 │ 1.69500e+3  1.71500e+3  ...  1.79500e+3  1.81500e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.40000e+2  1.60000e+2  ...  2.40000e+2  2.60000e+2 │ 1.45000e+2  1.65000e+2  ...  2.45000e+2  2.65000e+2 │ 1.50000e+2  1.70000e+2  ...  2.50000e+2  2.70000e+2 │ 1.55000e+2  1.75000e+2  ...  2.55000e+2  2.75000e+2 ││
    ││axis 3│ 9.80000e+2  1.00000e+3  ...  1.08000e+3  1.10000e+3 │ 9.85000e+2  1.00500e+3  ...  1.08500e+3  1.10500e+3 │ 9.90000e+2  1.01000e+3  ...  1.09000e+3  1.11000e+3 │ 9.95000e+2  1.01500e+3  ...  1.09500e+3  1.11500e+3 ││
    ││      │ 1.82000e+3  1.84000e+3  ...  1.92000e+3  1.94000e+3 │ 1.82500e+3  1.84500e+3  ...  1.92500e+3  1.94500e+3 │ 1.83000e+3  1.85000e+3  ...  1.93000e+3  1.95000e+3 │ 1.83500e+3  1.85500e+3  ...  1.93500e+3  1.95500e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...                                                 │ ...                                                 ││
    ││axis 3│                                                     │                                                     │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.60000e+2  5.80000e+2  ...  6.60000e+2  6.80000e+2 │ 5.65000e+2  5.85000e+2  ...  6.65000e+2  6.85000e+2 │ 5.70000e+2  5.90000e+2  ...  6.70000e+2  6.90000e+2 │ 5.75000e+2  5.95000e+2  ...  6.75000e+2  6.95000e+2 ││
    ││axis 3│ 1.40000e+3  1.42000e+3  ...  1.50000e+3  1.52000e+3 │ 1.40500e+3  1.42500e+3  ...  1.50500e+3  1.52500e+3 │ 1.41000e+3  1.43000e+3  ...  1.51000e+3  1.53000e+3 │ 1.41500e+3  1.43500e+3  ...  1.51500e+3  1.53500e+3 ││
    ││      │ 2.24000e+3  2.26000e+3  ...  2.34000e+3  2.36000e+3 │ 2.24500e+3  2.26500e+3  ...  2.34500e+3  2.36500e+3 │ 2.25000e+3  2.27000e+3  ...  2.35000e+3  2.37000e+3 │ 2.25500e+3  2.27500e+3  ...  2.35500e+3  2.37500e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.00000e+2  7.20000e+2  ...  8.00000e+2  8.20000e+2 │ 7.05000e+2  7.25000e+2  ...  8.05000e+2  8.25000e+2 │ 7.10000e+2  7.30000e+2  ...  8.10000e+2  8.30000e+2 │ 7.15000e+2  7.35000e+2  ...  8.15000e+2  8.35000e+2 ││
    ││axis 3│ 1.54000e+3  1.56000e+3  ...  1.64000e+3  1.66000e+3 │ 1.54500e+3  1.56500e+3  ...  1.64500e+3  1.66500e+3 │ 1.55000e+3  1.57000e+3  ...  1.65000e+3  1.67000e+3 │ 1.55500e+3  1.57500e+3  ...  1.65500e+3  1.67500e+3 ││
    ││      │ 2.38000e+3  2.40000e+3  ...  2.48000e+3  2.50000e+3 │ 2.38500e+3  2.40500e+3  ...  2.48500e+3  2.50500e+3 │ 2.39000e+3  2.41000e+3  ...  2.49000e+3  2.51000e+3 │ 2.39500e+3  2.41500e+3  ...  2.49500e+3  2.51500e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││1 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                │3 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 1.00000     2.10000e+1  ...  1.01000e+2  1.21000e+2 │ 6.00000     2.60000e+1  ...  1.06000e+2  1.26000e+2 │ 1.10000e+1  3.10000e+1  ...  1.11000e+2  1.31000e+2 │ 1.60000e+1  3.60000e+1  ...  1.16000e+2  1.36000e+2 ││
    ││axis 3│ 8.41000e+2  8.61000e+2  ...  9.41000e+2  9.61000e+2 │ 8.46000e+2  8.66000e+2  ...  9.46000e+2  9.66000e+2 │ 8.51000e+2  8.71000e+2  ...  9.51000e+2  9.71000e+2 │ 8.56000e+2  8.76000e+2  ...  9.56000e+2  9.76000e+2 ││
    ││      │ 1.68100e+3  1.70100e+3  ...  1.78100e+3  1.80100e+3 │ 1.68600e+3  1.70600e+3  ...  1.78600e+3  1.80600e+3 │ 1.69100e+3  1.71100e+3  ...  1.79100e+3  1.81100e+3 │ 1.69600e+3  1.71600e+3  ...  1.79600e+3  1.81600e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.41000e+2  1.61000e+2  ...  2.41000e+2  2.61000e+2 │ 1.46000e+2  1.66000e+2  ...  2.46000e+2  2.66000e+2 │ 1.51000e+2  1.71000e+2  ...  2.51000e+2  2.71000e+2 │ 1.56000e+2  1.76000e+2  ...  2.56000e+2  2.76000e+2 ││
    ││axis 3│ 9.81000e+2  1.00100e+3  ...  1.08100e+3  1.10100e+3 │ 9.86000e+2  1.00600e+3  ...  1.08600e+3  1.10600e+3 │ 9.91000e+2  1.01100e+3  ...  1.09100e+3  1.11100e+3 │ 9.96000e+2  1.01600e+3  ...  1.09600e+3  1.11600e+3 ││
    ││      │ 1.82100e+3  1.84100e+3  ...  1.92100e+3  1.94100e+3 │ 1.82600e+3  1.84600e+3  ...  1.92600e+3  1.94600e+3 │ 1.83100e+3  1.85100e+3  ...  1.93100e+3  1.95100e+3 │ 1.83600e+3  1.85600e+3  ...  1.93600e+3  1.95600e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...                                                 │ ...                                                 ││
    ││axis 3│                                                     │                                                     │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.61000e+2  5.81000e+2  ...  6.61000e+2  6.81000e+2 │ 5.66000e+2  5.86000e+2  ...  6.66000e+2  6.86000e+2 │ 5.71000e+2  5.91000e+2  ...  6.71000e+2  6.91000e+2 │ 5.76000e+2  5.96000e+2  ...  6.76000e+2  6.96000e+2 ││
    ││axis 3│ 1.40100e+3  1.42100e+3  ...  1.50100e+3  1.52100e+3 │ 1.40600e+3  1.42600e+3  ...  1.50600e+3  1.52600e+3 │ 1.41100e+3  1.43100e+3  ...  1.51100e+3  1.53100e+3 │ 1.41600e+3  1.43600e+3  ...  1.51600e+3  1.53600e+3 ││
    ││      │ 2.24100e+3  2.26100e+3  ...  2.34100e+3  2.36100e+3 │ 2.24600e+3  2.26600e+3  ...  2.34600e+3  2.36600e+3 │ 2.25100e+3  2.27100e+3  ...  2.35100e+3  2.37100e+3 │ 2.25600e+3  2.27600e+3  ...  2.35600e+3  2.37600e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.01000e+2  7.21000e+2  ...  8.01000e+2  8.21000e+2 │ 7.06000e+2  7.26000e+2  ...  8.06000e+2  8.26000e+2 │ 7.11000e+2  7.31000e+2  ...  8.11000e+2  8.31000e+2 │ 7.16000e+2  7.36000e+2  ...  8.16000e+2  8.36000e+2 ││
    ││axis 3│ 1.54100e+3  1.56100e+3  ...  1.64100e+3  1.66100e+3 │ 1.54600e+3  1.56600e+3  ...  1.64600e+3  1.66600e+3 │ 1.55100e+3  1.57100e+3  ...  1.65100e+3  1.67100e+3 │ 1.55600e+3  1.57600e+3  ...  1.65600e+3  1.67600e+3 ││
    ││      │ 2.38100e+3  2.40100e+3  ...  2.48100e+3  2.50100e+3 │ 2.38600e+3  2.40600e+3  ...  2.48600e+3  2.50600e+3 │ 2.39100e+3  2.41100e+3  ...  2.49100e+3  2.51100e+3 │ 2.39600e+3  2.41600e+3  ...  2.49600e+3  2.51600e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││2 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                │3 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 2.00000     2.20000e+1  ...  1.02000e+2  1.22000e+2 │ 7.00000     2.70000e+1  ...  1.07000e+2  1.27000e+2 │ 1.20000e+1  3.20000e+1  ...  1.12000e+2  1.32000e+2 │ 1.70000e+1  3.70000e+1  ...  1.17000e+2  1.37000e+2 ││
    ││axis 3│ 8.42000e+2  8.62000e+2  ...  9.42000e+2  9.62000e+2 │ 8.47000e+2  8.67000e+2  ...  9.47000e+2  9.67000e+2 │ 8.52000e+2  8.72000e+2  ...  9.52000e+2  9.72000e+2 │ 8.57000e+2  8.77000e+2  ...  9.57000e+2  9.77000e+2 ││
    ││      │ 1.68200e+3  1.70200e+3  ...  1.78200e+3  1.80200e+3 │ 1.68700e+3  1.70700e+3  ...  1.78700e+3  1.80700e+3 │ 1.69200e+3  1.71200e+3  ...  1.79200e+3  1.81200e+3 │ 1.69700e+3  1.71700e+3  ...  1.79700e+3  1.81700e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.42000e+2  1.62000e+2  ...  2.42000e+2  2.62000e+2 │ 1.47000e+2  1.67000e+2  ...  2.47000e+2  2.67000e+2 │ 1.52000e+2  1.72000e+2  ...  2.52000e+2  2.72000e+2 │ 1.57000e+2  1.77000e+2  ...  2.57000e+2  2.77000e+2 ││
    ││axis 3│ 9.82000e+2  1.00200e+3  ...  1.08200e+3  1.10200e+3 │ 9.87000e+2  1.00700e+3  ...  1.08700e+3  1.10700e+3 │ 9.92000e+2  1.01200e+3  ...  1.09200e+3  1.11200e+3 │ 9.97000e+2  1.01700e+3  ...  1.09700e+3  1.11700e+3 ││
    ││      │ 1.82200e+3  1.84200e+3  ...  1.92200e+3  1.94200e+3 │ 1.82700e+3  1.84700e+3  ...  1.92700e+3  1.94700e+3 │ 1.83200e+3  1.85200e+3  ...  1.93200e+3  1.95200e+3 │ 1.83700e+3  1.85700e+3  ...  1.93700e+3  1.95700e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...                                                 │ ...                                                 ││
    ││axis 3│                                                     │                                                     │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.62000e+2  5.82000e+2  ...  6.62000e+2  6.82000e+2 │ 5.67000e+2  5.87000e+2  ...  6.67000e+2  6.87000e+2 │ 5.72000e+2  5.92000e+2  ...  6.72000e+2  6.92000e+2 │ 5.77000e+2  5.97000e+2  ...  6.77000e+2  6.97000e+2 ││
    ││axis 3│ 1.40200e+3  1.42200e+3  ...  1.50200e+3  1.52200e+3 │ 1.40700e+3  1.42700e+3  ...  1.50700e+3  1.52700e+3 │ 1.41200e+3  1.43200e+3  ...  1.51200e+3  1.53200e+3 │ 1.41700e+3  1.43700e+3  ...  1.51700e+3  1.53700e+3 ││
    ││      │ 2.24200e+3  2.26200e+3  ...  2.34200e+3  2.36200e+3 │ 2.24700e+3  2.26700e+3  ...  2.34700e+3  2.36700e+3 │ 2.25200e+3  2.27200e+3  ...  2.35200e+3  2.37200e+3 │ 2.25700e+3  2.27700e+3  ...  2.35700e+3  2.37700e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.02000e+2  7.22000e+2  ...  8.02000e+2  8.22000e+2 │ 7.07000e+2  7.27000e+2  ...  8.07000e+2  8.27000e+2 │ 7.12000e+2  7.32000e+2  ...  8.12000e+2  8.32000e+2 │ 7.17000e+2  7.37000e+2  ...  8.17000e+2  8.37000e+2 ││
    ││axis 3│ 1.54200e+3  1.56200e+3  ...  1.64200e+3  1.66200e+3 │ 1.54700e+3  1.56700e+3  ...  1.64700e+3  1.66700e+3 │ 1.55200e+3  1.57200e+3  ...  1.65200e+3  1.67200e+3 │ 1.55700e+3  1.57700e+3  ...  1.65700e+3  1.67700e+3 ││
    ││      │ 2.38200e+3  2.40200e+3  ...  2.48200e+3  2.50200e+3 │ 2.38700e+3  2.40700e+3  ...  2.48700e+3  2.50700e+3 │ 2.39200e+3  2.41200e+3  ...  2.49200e+3  2.51200e+3 │ 2.39700e+3  2.41700e+3  ...  2.49700e+3  2.51700e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││3 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                │3 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 3.00000     2.30000e+1  ...  1.03000e+2  1.23000e+2 │ 8.00000     2.80000e+1  ...  1.08000e+2  1.28000e+2 │ 1.30000e+1  3.30000e+1  ...  1.13000e+2  1.33000e+2 │ 1.80000e+1  3.80000e+1  ...  1.18000e+2  1.38000e+2 ││
    ││axis 3│ 8.43000e+2  8.63000e+2  ...  9.43000e+2  9.63000e+2 │ 8.48000e+2  8.68000e+2  ...  9.48000e+2  9.68000e+2 │ 8.53000e+2  8.73000e+2  ...  9.53000e+2  9.73000e+2 │ 8.58000e+2  8.78000e+2  ...  9.58000e+2  9.78000e+2 ││
    ││      │ 1.68300e+3  1.70300e+3  ...  1.78300e+3  1.80300e+3 │ 1.68800e+3  1.70800e+3  ...  1.78800e+3  1.80800e+3 │ 1.69300e+3  1.71300e+3  ...  1.79300e+3  1.81300e+3 │ 1.69800e+3  1.71800e+3  ...  1.79800e+3  1.81800e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.43000e+2  1.63000e+2  ...  2.43000e+2  2.63000e+2 │ 1.48000e+2  1.68000e+2  ...  2.48000e+2  2.68000e+2 │ 1.53000e+2  1.73000e+2  ...  2.53000e+2  2.73000e+2 │ 1.58000e+2  1.78000e+2  ...  2.58000e+2  2.78000e+2 ││
    ││axis 3│ 9.83000e+2  1.00300e+3  ...  1.08300e+3  1.10300e+3 │ 9.88000e+2  1.00800e+3  ...  1.08800e+3  1.10800e+3 │ 9.93000e+2  1.01300e+3  ...  1.09300e+3  1.11300e+3 │ 9.98000e+2  1.01800e+3  ...  1.09800e+3  1.11800e+3 ││
    ││      │ 1.82300e+3  1.84300e+3  ...  1.92300e+3  1.94300e+3 │ 1.82800e+3  1.84800e+3  ...  1.92800e+3  1.94800e+3 │ 1.83300e+3  1.85300e+3  ...  1.93300e+3  1.95300e+3 │ 1.83800e+3  1.85800e+3  ...  1.93800e+3  1.95800e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...                                                 │ ...                                                 ││
    ││axis 3│                                                     │                                                     │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.63000e+2  5.83000e+2  ...  6.63000e+2  6.83000e+2 │ 5.68000e+2  5.88000e+2  ...  6.68000e+2  6.88000e+2 │ 5.73000e+2  5.93000e+2  ...  6.73000e+2  6.93000e+2 │ 5.78000e+2  5.98000e+2  ...  6.78000e+2  6.98000e+2 ││
    ││axis 3│ 1.40300e+3  1.42300e+3  ...  1.50300e+3  1.52300e+3 │ 1.40800e+3  1.42800e+3  ...  1.50800e+3  1.52800e+3 │ 1.41300e+3  1.43300e+3  ...  1.51300e+3  1.53300e+3 │ 1.41800e+3  1.43800e+3  ...  1.51800e+3  1.53800e+3 ││
    ││      │ 2.24300e+3  2.26300e+3  ...  2.34300e+3  2.36300e+3 │ 2.24800e+3  2.26800e+3  ...  2.34800e+3  2.36800e+3 │ 2.25300e+3  2.27300e+3  ...  2.35300e+3  2.37300e+3 │ 2.25800e+3  2.27800e+3  ...  2.35800e+3  2.37800e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.03000e+2  7.23000e+2  ...  8.03000e+2  8.23000e+2 │ 7.08000e+2  7.28000e+2  ...  8.08000e+2  8.28000e+2 │ 7.13000e+2  7.33000e+2  ...  8.13000e+2  8.33000e+2 │ 7.18000e+2  7.38000e+2  ...  8.18000e+2  8.38000e+2 ││
    ││axis 3│ 1.54300e+3  1.56300e+3  ...  1.64300e+3  1.66300e+3 │ 1.54800e+3  1.56800e+3  ...  1.64800e+3  1.66800e+3 │ 1.55300e+3  1.57300e+3  ...  1.65300e+3  1.67300e+3 │ 1.55800e+3  1.57800e+3  ...  1.65800e+3  1.67800e+3 ││
    ││      │ 2.38300e+3  2.40300e+3  ...  2.48300e+3  2.50300e+3 │ 2.38800e+3  2.40800e+3  ...  2.48800e+3  2.50800e+3 │ 2.39300e+3  2.41300e+3  ...  2.49300e+3  2.51300e+3 │ 2.39800e+3  2.41800e+3  ...  2.49800e+3  2.51800e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││4 @ 1 │0 @ 4                                                │1 @ 4                                                │2 @ 4                                                │3 @ 4                                                ││
    ││      │axis 5                                               │axis 5                                               │axis 5                                               │axis 5                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││0 @ 2 │ 4.00000     2.40000e+1  ...  1.04000e+2  1.24000e+2 │ 9.00000     2.90000e+1  ...  1.09000e+2  1.29000e+2 │ 1.40000e+1  3.40000e+1  ...  1.14000e+2  1.34000e+2 │ 1.90000e+1  3.90000e+1  ...  1.19000e+2  1.39000e+2 ││
    ││axis 3│ 8.44000e+2  8.64000e+2  ...  9.44000e+2  9.64000e+2 │ 8.49000e+2  8.69000e+2  ...  9.49000e+2  9.69000e+2 │ 8.54000e+2  8.74000e+2  ...  9.54000e+2  9.74000e+2 │ 8.59000e+2  8.79000e+2  ...  9.59000e+2  9.79000e+2 ││
    ││      │ 1.68400e+3  1.70400e+3  ...  1.78400e+3  1.80400e+3 │ 1.68900e+3  1.70900e+3  ...  1.78900e+3  1.80900e+3 │ 1.69400e+3  1.71400e+3  ...  1.79400e+3  1.81400e+3 │ 1.69900e+3  1.71900e+3  ...  1.79900e+3  1.81900e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││1 @ 2 │ 1.44000e+2  1.64000e+2  ...  2.44000e+2  2.64000e+2 │ 1.49000e+2  1.69000e+2  ...  2.49000e+2  2.69000e+2 │ 1.54000e+2  1.74000e+2  ...  2.54000e+2  2.74000e+2 │ 1.59000e+2  1.79000e+2  ...  2.59000e+2  2.79000e+2 ││
    ││axis 3│ 9.84000e+2  1.00400e+3  ...  1.08400e+3  1.10400e+3 │ 9.89000e+2  1.00900e+3  ...  1.08900e+3  1.10900e+3 │ 9.94000e+2  1.01400e+3  ...  1.09400e+3  1.11400e+3 │ 9.99000e+2  1.01900e+3  ...  1.09900e+3  1.11900e+3 ││
    ││      │ 1.82400e+3  1.84400e+3  ...  1.92400e+3  1.94400e+3 │ 1.82900e+3  1.84900e+3  ...  1.92900e+3  1.94900e+3 │ 1.83400e+3  1.85400e+3  ...  1.93400e+3  1.95400e+3 │ 1.83900e+3  1.85900e+3  ...  1.93900e+3  1.95900e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││~~~~~ │ ...                                                 │ ...                                                 │ ...                                                 │ ...                                                 ││
    ││axis 3│                                                     │                                                     │                                                     │                                                     ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││4 @ 2 │ 5.64000e+2  5.84000e+2  ...  6.64000e+2  6.84000e+2 │ 5.69000e+2  5.89000e+2  ...  6.69000e+2  6.89000e+2 │ 5.74000e+2  5.94000e+2  ...  6.74000e+2  6.94000e+2 │ 5.79000e+2  5.99000e+2  ...  6.79000e+2  6.99000e+2 ││
    ││axis 3│ 1.40400e+3  1.42400e+3  ...  1.50400e+3  1.52400e+3 │ 1.40900e+3  1.42900e+3  ...  1.50900e+3  1.52900e+3 │ 1.41400e+3  1.43400e+3  ...  1.51400e+3  1.53400e+3 │ 1.41900e+3  1.43900e+3  ...  1.51900e+3  1.53900e+3 ││
    ││      │ 2.24400e+3  2.26400e+3  ...  2.34400e+3  2.36400e+3 │ 2.24900e+3  2.26900e+3  ...  2.34900e+3  2.36900e+3 │ 2.25400e+3  2.27400e+3  ...  2.35400e+3  2.37400e+3 │ 2.25900e+3  2.27900e+3  ...  2.35900e+3  2.37900e+3 ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││5 @ 2 │ 7.04000e+2  7.24000e+2  ...  8.04000e+2  8.24000e+2 │ 7.09000e+2  7.29000e+2  ...  8.09000e+2  8.29000e+2 │ 7.14000e+2  7.34000e+2  ...  8.14000e+2  8.34000e+2 │ 7.19000e+2  7.39000e+2  ...  8.19000e+2  8.39000e+2 ││
    ││axis 3│ 1.54400e+3  1.56400e+3  ...  1.64400e+3  1.66400e+3 │ 1.54900e+3  1.56900e+3  ...  1.64900e+3  1.66900e+3 │ 1.55400e+3  1.57400e+3  ...  1.65400e+3  1.67400e+3 │ 1.55900e+3  1.57900e+3  ...  1.65900e+3  1.67900e+3 ││
    ││      │ 2.38400e+3  2.40400e+3  ...  2.48400e+3  2.50400e+3 │ 2.38900e+3  2.40900e+3  ...  2.48900e+3  2.50900e+3 │ 2.39400e+3  2.41400e+3  ...  2.49400e+3  2.51400e+3 │ 2.39900e+3  2.41900e+3  ...  2.49900e+3  2.51900e+3 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];

  let%op ho4 = hey2 ++ "...b|...i->...o => i|o->b" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:5|2:7->1:3                                                                                                                                                                                                                                                        │
    │┌──────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐│
    ││      │0 @ 0                                                │1 @ 0                                                │2 @ 0                                                │3 @ 0                                                │4 @ 0                                                ││
    ││      │axis 2                                               │axis 2                                               │axis 2                                               │axis 2                                               │axis 2                                               ││
    │├──────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤│
    ││axis 1│ 7.76400e+4  7.86000e+4  ...  8.24400e+4  8.34000e+4 │ 7.76880e+4  7.86480e+4  ...  8.24880e+4  8.34480e+4 │ 7.77360e+4  7.86960e+4  ...  8.25360e+4  8.34960e+4 │ 7.77840e+4  7.87440e+4  ...  8.25840e+4  8.35440e+4 │ 7.78320e+4  7.87920e+4  ...  8.26320e+4  8.35920e+4 ││
    ││      │ 1.17960e+5  1.18920e+5  ...  1.22760e+5  1.23720e+5 │ 1.18008e+5  1.18968e+5  ...  1.22808e+5  1.23768e+5 │ 1.18056e+5  1.19016e+5  ...  1.22856e+5  1.23816e+5 │ 1.18104e+5  1.19064e+5  ...  1.22904e+5  1.23864e+5 │ 1.18152e+5  1.19112e+5  ...  1.22952e+5  1.23912e+5 ││
    ││      │ 1.58280e+5  1.59240e+5  ...  1.63080e+5  1.64040e+5 │ 1.58328e+5  1.59288e+5  ...  1.63128e+5  1.64088e+5 │ 1.58376e+5  1.59336e+5  ...  1.63176e+5  1.64136e+5 │ 1.58424e+5  1.59384e+5  ...  1.63224e+5  1.64184e+5 │ 1.58472e+5  1.59432e+5  ...  1.63272e+5  1.64232e+5 ││
    │└──────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let%op ho5 = hey ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho5;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho5;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[6]: =>_ho5 shape 0:4                              │
    │┌┬────────────────────────────────────────────────┐│
    │││axis 0                                          ││
    │├┼────────────────────────────────────────────────┤│
    │││ 4.20000e+1  6.00000e+1  7.80000e+1  9.60000e+1 ││
    │└┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}];
  let hey3 = TDSL.range_of_shape ~output_dims:[ 3; 4 ] () in
  let%op ho6 = hey3 ++ "...|...->...o => o" in
  Train.forward_and_forget backend ctx ho6;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey3;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[7]: r3x4 shape 0:3,1:4                            │
    │┌──────┬──────────────────────────────────────────┐│
    ││      │axis 1                                    ││
    │├──────┼──────────────────────────────────────────┤│
    ││axis 0│ 0.00000  1.00000  2.00000     3.00000    ││
    ││      │ 4.00000  5.00000  6.00000     7.00000    ││
    ││      │ 8.00000  9.00000  1.00000e+1  1.10000e+1 ││
    │└──────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho6;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[8]: =>_ho6 shape 0:4                              │
    │┌┬────────────────────────────────────────────────┐│
    │││axis 0                                          ││
    │├┼────────────────────────────────────────────────┤│
    │││ 1.20000e+1  1.50000e+1  1.80000e+1  2.10000e+1 ││
    │└┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let hey4 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3; 4 ] () in
  let%op ho7 = hey4 ++ "i->...o => ...io" in
  Train.forward_and_forget backend ctx ho7;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey4;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │[9]: r3x4x2 shape 2:2->0:3,1:4                                               │
    │┌──────┬──────────────────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0             │1 @ 0                   │2 @ 0                   ││
    ││      │axis 2            │axis 2                  │axis 2                  ││
    │├──────┼──────────────────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 0.00000  1.00000 │ 8.00000     9.00000    │ 1.60000e+1  1.70000e+1 ││
    ││      │ 2.00000  3.00000 │ 1.00000e+1  1.10000e+1 │ 1.80000e+1  1.90000e+1 ││
    ││      │ 4.00000  5.00000 │ 1.20000e+1  1.30000e+1 │ 2.00000e+1  2.10000e+1 ││
    ││      │ 6.00000  7.00000 │ 1.40000e+1  1.50000e+1 │ 2.20000e+1  2.30000e+1 ││
    │└──────┴──────────────────┴────────────────────────┴────────────────────────┘│
    └─────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho7;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[10]: =>_ho7 shape 0:3,1:2,2:4                           │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││0 @ 0 │ 0.00000  2.00000  4.00000  6.00000             ││
    ││axis 1│ 1.00000  3.00000  5.00000  7.00000             ││
    │├──────┼────────────────────────────────────────────────┤│
    ││1 @ 0 │ 8.00000  1.00000e+1  1.20000e+1  1.40000e+1    ││
    ││axis 1│ 9.00000  1.10000e+1  1.30000e+1  1.50000e+1    ││
    │├──────┼────────────────────────────────────────────────┤│
    ││2 @ 0 │ 1.60000e+1  1.80000e+1  2.00000e+1  2.20000e+1 ││
    ││axis 1│ 1.70000e+1  1.90000e+1  2.10000e+1  2.30000e+1 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum broadcast or sum out prefix axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->...; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                                                                 │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                                           │2 @ 0                                           ││
    ││      │axis 2                              │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000  2.00000  3.00000 │ 8.00000     9.00000     1.00000e+1  1.10000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1  1.90000e+1 ││
    ││      │ 4.00000  5.00000  6.00000  7.00000 │ 1.20000e+1  1.30000e+1  1.40000e+1  1.50000e+1 │ 2.00000e+1  2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4           │
    │┌──────┬─────────┬─────────┬────────────┐│
    ││      │0 @ 0    │1 @ 0    │2 @ 0       ││
    ││      │axis 2   │axis 2   │axis 2      ││
    │├──────┼─────────┼─────────┼────────────┤│
    ││axis 1│ 0.00000 │ 4.00000 │ 8.00000    ││
    ││      │ 1.00000 │ 5.00000 │ 9.00000    ││
    ││      │ 2.00000 │ 6.00000 │ 1.00000e+1 ││
    ││      │ 3.00000 │ 7.00000 │ 1.10000e+1 ││
    │└──────┴─────────┴─────────┴────────────┘│
    └─────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                                 │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 1                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││axis 0│ 0.00000     6.00000     1.60000e+1  3.00000e+1 ││
    ││      │ 8.00000e+1  1.10000e+2  1.44000e+2  1.82000e+2 ││
    ││      │ 2.88000e+2  3.42000e+2  4.00000e+2  4.62000e+2 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}];
  (* Broadcast with a shift. *)
  let d = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let e = TDSL.range_of_shape ~input_dims:[ 4 ] ~output_dims:[ 3 ] () in
  let%op f = d *+ "i->...;j->... => ...ij" e in
  Train.forward_and_forget backend ctx f;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ d;
  [%expect
    {|
    ┌───────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3   │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 0.00000  1.00000 ││
    ││      │ 2.00000  3.00000 ││
    ││      │ 4.00000  5.00000 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ e;
  [%expect
    {|
    ┌───────────────────────────────────────────────────┐
    │[4]: r3x4 shape 1:4->0:3                           │
    │┌──────┬──────────────────────────────────────────┐│
    ││      │axis 1                                    ││
    │├──────┼──────────────────────────────────────────┤│
    ││axis 0│ 0.00000  1.00000  2.00000     3.00000    ││
    ││      │ 4.00000  5.00000  6.00000     7.00000    ││
    ││      │ 8.00000  9.00000  1.00000e+1  1.10000e+1 ││
    │└──────┴──────────────────────────────────────────┘│
    └───────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ f;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[5]: ;=>_f shape 0:3,1:2,2:4                             │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││0 @ 0 │ 0.00000  0.00000  0.00000  0.00000             ││
    ││axis 1│ 0.00000  1.00000  2.00000  3.00000             ││
    │├──────┼────────────────────────────────────────────────┤│
    ││1 @ 0 │ 8.00000     1.00000e+1  1.20000e+1  1.40000e+1 ││
    ││axis 1│ 1.20000e+1  1.50000e+1  1.80000e+1  2.10000e+1 ││
    │├──────┼────────────────────────────────────────────────┤│
    ││2 @ 0 │ 3.20000e+1  3.60000e+1  4.00000e+1  4.40000e+1 ││
    ││axis 1│ 4.00000e+1  4.50000e+1  5.00000e+1  5.50000e+1 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum1 fixed dim axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let hey = TDSL.range_of_shape ~batch_dims:[ 2 ] ~input_dims:[ 3 ] ~output_dims:[ 4 ] () in
  let%op ho = hey ++ "...|1->... => ...|..." in
  let ctx = Train.forward_and_ctx backend ctx ho in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[1]: =>_ho shape 0:2|1:4                                 │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 1                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││axis 0│ 1.00000     4.00000     7.00000     1.00000e+1 ││
    ││      │ 1.30000e+1  1.60000e+1  1.90000e+1  2.20000e+1 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}];
  let%op ho2 = hey ++ "...|...->... => ...|...->0" in
  let ctx = Train.forward_and_ctx backend ctx ho2 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │[0]: r2x4x3 shape 0:2|2:3->1:4                                                 │
    │┌──────┬─────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                            │1 @ 0                               ││
    ││      │axis 2                           │axis 2                              ││
    │├──────┼─────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000     2.00000    │ 1.20000e+1  1.30000e+1  1.40000e+1 ││
    ││      │ 3.00000  4.00000     5.00000    │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 6.00000  7.00000     8.00000    │ 1.80000e+1  1.90000e+1  2.00000e+1 ││
    ││      │ 9.00000  1.00000e+1  1.10000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴─────────────────────────────────┴────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho2;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │[2]: =>_ho2 shape 0:2|2:3->1:1                                                    │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                               ││
    ││      │axis 2                              │axis 2                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 1.80000e+1  2.20000e+1  2.60000e+1 │ 6.60000e+1  7.00000e+1  7.40000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────┘
    |}];
  let hey2 = TDSL.range_of_shape ~input_dims:[ 2 ] ~output_dims:[ 3 ] () in
  let%op ho3 = hey2 ++ "...|...->... => 0" in
  let ctx = Train.forward_and_ctx backend ctx ho3 in
  Tensor.print ~with_code:false ~with_grad:false `Default @@ hey2;
  [%expect
    {|
    ┌───────────────────────────┐
    │[3]: r3x2 shape 1:2->0:3   │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 0.00000  1.00000 ││
    ││      │ 2.00000  3.00000 ││
    ││      │ 4.00000  5.00000 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho3;
  [%expect
    {|
    ┌──────────────────────┐
    │[4]: =>_ho3 shape 0:1 │
    │┌┬────────────┐       │
    │││axis 0      │       │
    │├┼────────────┤       │
    │││ 1.50000e+1 │       │
    │└┴────────────┘       │
    └──────────────────────┘
    |}];
  let%op ho4 = hey2 ++ "i->j => i0j" in
  Train.forward_and_forget backend ctx ho4;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ho4;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[5]: =>_ho4 shape 0:2,1:1,2:3       │
    │┌──────┬───────────────────────────┐│
    ││      │axis 2                     ││
    │├──────┼───────────────────────────┤│
    ││0 @ 0 │ 0.00000  2.00000  4.00000 ││
    ││axis 1│                           ││
    │├──────┼───────────────────────────┤│
    ││1 @ 0 │ 1.00000  3.00000  5.00000 ││
    ││axis 1│                           ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘
    |}]

let%expect_test "einsum with fixed dim axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let a = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~batch_dims:[ 3 ] ~input_dims:[ 1 ] ~output_dims:[ 4 ] () in
  let%op c = a *+ "...|i->1; ...|...->i => ...|i" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4 shape 0:3|2:4->1:2                                                                                                                 │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                                           │2 @ 0                                           ││
    ││      │axis 2                              │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000  2.00000  3.00000 │ 8.00000     9.00000     1.00000e+1  1.10000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1  1.90000e+1 ││
    ││      │ 4.00000  5.00000  6.00000  7.00000 │ 1.20000e+1  1.30000e+1  1.40000e+1  1.50000e+1 │ 2.00000e+1  2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌─────────────────────────────────────────┐
    │[1]: r3x4x1 shape 0:3|2:1->1:4           │
    │┌──────┬─────────┬─────────┬────────────┐│
    ││      │0 @ 0    │1 @ 0    │2 @ 0       ││
    ││      │axis 2   │axis 2   │axis 2      ││
    │├──────┼─────────┼─────────┼────────────┤│
    ││axis 1│ 0.00000 │ 4.00000 │ 8.00000    ││
    ││      │ 1.00000 │ 5.00000 │ 9.00000    ││
    ││      │ 2.00000 │ 6.00000 │ 1.00000e+1 ││
    ││      │ 3.00000 │ 7.00000 │ 1.10000e+1 ││
    │└──────┴─────────┴─────────┴────────────┘│
    └─────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌─────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4                                 │
    │┌──────┬────────────────────────────────────────────────┐│
    ││      │axis 1                                          ││
    │├──────┼────────────────────────────────────────────────┤│
    ││axis 0│ 0.00000     5.00000     1.20000e+1  2.10000e+1 ││
    ││      │ 4.80000e+1  6.50000e+1  8.40000e+1  1.05000e+2 ││
    ││      │ 1.60000e+2  1.89000e+2  2.20000e+2  2.53000e+2 ││
    │└──────┴────────────────────────────────────────────────┘│
    └─────────────────────────────────────────────────────────┘
    |}]

let%expect_test "outer_sum simulating axis concatenation" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  Rand.init 0;
  let ri = TDSL.range 3 in
  let%op ti = ri ++ "i=>i0" in
  (* Write position 2 of ti, otherwise shape inference concludes it's dim-1 and broadcasted. *)
  let%cd _ = ti =: 0 ++ "i=>i2" in
  let rj = TDSL.range 4 in
  let%op tj = rj ++ "j=>j1" in
  let rk = TDSL.range 5 in
  let%op tk = rk ++ "k=>k2" in
  let positions = TDSL.outer_sum "ijl;kl=>ijkl" (TDSL.outer_sum "il;jl=>ijl" ti tj) tk in
  Train.set_hosted tk.value;
  Train.forward_and_forget backend ctx positions;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ positions;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[9]: ;=>+ shape 0:4,1:5,2:6,3:3     │
    │┌──────┬───────────────────────────┐│
    ││0 @ 0 │axis 3                     ││
    │├──────┼───────────────────────────┤│
    ││0 @ 1 │ 0.00000  0.00000  0.00000 ││
    ││axis 2│ 0.00000  0.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 0.00000  0.00000  4.00000 ││
    ││      │ 0.00000  0.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││1 @ 1 │ 0.00000  1.00000  0.00000 ││
    ││axis 2│ 0.00000  1.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 0.00000  1.00000  4.00000 ││
    ││      │ 0.00000  1.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││2 @ 1 │ 0.00000  2.00000  0.00000 ││
    ││axis 2│ 0.00000  2.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 0.00000  2.00000  4.00000 ││
    ││      │ 0.00000  2.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││3 @ 1 │ 0.00000  3.00000  0.00000 ││
    ││axis 2│ 0.00000  3.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 0.00000  3.00000  4.00000 ││
    ││      │ 0.00000  3.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││4 @ 1 │ 0.00000  4.00000  0.00000 ││
    ││axis 2│ 0.00000  4.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 0.00000  4.00000  4.00000 ││
    ││      │ 0.00000  4.00000  5.00000 ││
    │└──────┴───────────────────────────┘│
    ├────────────────────────────────────┤
    │┌──────┬───────────────────────────┐│
    ││1 @ 0 │axis 3                     ││
    │├──────┼───────────────────────────┤│
    ││0 @ 1 │ 1.00000  0.00000  0.00000 ││
    ││axis 2│ 1.00000  0.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 1.00000  0.00000  4.00000 ││
    ││      │ 1.00000  0.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││1 @ 1 │ 1.00000  1.00000  0.00000 ││
    ││axis 2│ 1.00000  1.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 1.00000  1.00000  4.00000 ││
    ││      │ 1.00000  1.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││2 @ 1 │ 1.00000  2.00000  0.00000 ││
    ││axis 2│ 1.00000  2.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 1.00000  2.00000  4.00000 ││
    ││      │ 1.00000  2.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││3 @ 1 │ 1.00000  3.00000  0.00000 ││
    ││axis 2│ 1.00000  3.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 1.00000  3.00000  4.00000 ││
    ││      │ 1.00000  3.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││4 @ 1 │ 1.00000  4.00000  0.00000 ││
    ││axis 2│ 1.00000  4.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 1.00000  4.00000  4.00000 ││
    ││      │ 1.00000  4.00000  5.00000 ││
    │└──────┴───────────────────────────┘│
    ├────────────────────────────────────┤
    │┌──────┬───────────────────────────┐│
    ││2 @ 0 │axis 3                     ││
    │├──────┼───────────────────────────┤│
    ││0 @ 1 │ 2.00000  0.00000  0.00000 ││
    ││axis 2│ 2.00000  0.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 2.00000  0.00000  4.00000 ││
    ││      │ 2.00000  0.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││1 @ 1 │ 2.00000  1.00000  0.00000 ││
    ││axis 2│ 2.00000  1.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 2.00000  1.00000  4.00000 ││
    ││      │ 2.00000  1.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││2 @ 1 │ 2.00000  2.00000  0.00000 ││
    ││axis 2│ 2.00000  2.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 2.00000  2.00000  4.00000 ││
    ││      │ 2.00000  2.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││3 @ 1 │ 2.00000  3.00000  0.00000 ││
    ││axis 2│ 2.00000  3.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 2.00000  3.00000  4.00000 ││
    ││      │ 2.00000  3.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││4 @ 1 │ 2.00000  4.00000  0.00000 ││
    ││axis 2│ 2.00000  4.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 2.00000  4.00000  4.00000 ││
    ││      │ 2.00000  4.00000  5.00000 ││
    │└──────┴───────────────────────────┘│
    ├────────────────────────────────────┤
    │┌──────┬───────────────────────────┐│
    ││3 @ 0 │axis 3                     ││
    │├──────┼───────────────────────────┤│
    ││0 @ 1 │ 3.00000  0.00000  0.00000 ││
    ││axis 2│ 3.00000  0.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 3.00000  0.00000  4.00000 ││
    ││      │ 3.00000  0.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││1 @ 1 │ 3.00000  1.00000  0.00000 ││
    ││axis 2│ 3.00000  1.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 3.00000  1.00000  4.00000 ││
    ││      │ 3.00000  1.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││2 @ 1 │ 3.00000  2.00000  0.00000 ││
    ││axis 2│ 3.00000  2.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 3.00000  2.00000  4.00000 ││
    ││      │ 3.00000  2.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││3 @ 1 │ 3.00000  3.00000  0.00000 ││
    ││axis 2│ 3.00000  3.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 3.00000  3.00000  4.00000 ││
    ││      │ 3.00000  3.00000  5.00000 ││
    │├──────┼───────────────────────────┤│
    ││4 @ 1 │ 3.00000  4.00000  0.00000 ││
    ││axis 2│ 3.00000  4.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 3.00000  4.00000  4.00000 ││
    ││      │ 3.00000  4.00000  5.00000 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ ti;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[1]: =>_ti shape 0:4,1:3            │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 0.00000  0.00000  0.00000 ││
    ││      │ 1.00000  0.00000  0.00000 ││
    ││      │ 2.00000  0.00000  0.00000 ││
    ││      │ 3.00000  0.00000  0.00000 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ tk;
  [%expect
    {|
    ┌────────────────────────────────────┐
    │[7]: =>_tk shape 0:6,1:3            │
    │┌──────┬───────────────────────────┐│
    ││      │axis 1                     ││
    │├──────┼───────────────────────────┤│
    ││axis 0│ 0.00000  0.00000  0.00000 ││
    ││      │ 0.00000  0.00000  1.00000 ││
    ││      │ ...      ...      ...     ││
    ││      │ 0.00000  0.00000  4.00000 ││
    ││      │ 0.00000  0.00000  5.00000 ││
    │└──────┴───────────────────────────┘│
    └────────────────────────────────────┘
    |}]

let%expect_test "einsum with a leftmost input axis preserved as output axis" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a =
    TDSL.range_of_shape ~label:[ "a" ] ~batch_dims:[ 3 ] ~input_dims:[ 4 ] ~output_dims:[ 2 ] ()
  in
  let b =
    TDSL.range_of_shape ~label:[ "b" ] ~batch_dims:[ 3 ] ~input_dims:[ 2; 3 ] ~output_dims:[ 4 ] ()
  in
  let%op c = a *+ "...|i->1; ...|j...->i => ...|ij" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[0]: r3x2x4_a shape 0:3|2:4->1:2                                                                                                               │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                               │1 @ 0                                           │2 @ 0                                           ││
    ││      │axis 2                              │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.00000  1.00000  2.00000  3.00000 │ 8.00000     9.00000     1.00000e+1  1.10000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1  1.90000e+1 ││
    ││      │ 4.00000  5.00000  6.00000  7.00000 │ 1.20000e+1  1.30000e+1  1.40000e+1  1.50000e+1 │ 2.00000e+1  2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r3x4x2x3_b shape 0:3|2:2,3:3->1:4                                            │
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││0 @ 0 │0 @ 2                               │1 @ 2                               ││
    ││      │axis 3                              │axis 3                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 0.00000     1.00000     2.00000    │ 3.00000     4.00000     5.00000    ││
    ││      │ 6.00000     7.00000     8.00000    │ 9.00000     1.00000e+1  1.10000e+1 ││
    ││      │ 1.20000e+1  1.30000e+1  1.40000e+1 │ 1.50000e+1  1.60000e+1  1.70000e+1 ││
    ││      │ 1.80000e+1  1.90000e+1  2.00000e+1 │ 2.10000e+1  2.20000e+1  2.30000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││1 @ 0 │0 @ 2                               │1 @ 2                               ││
    ││      │axis 3                              │axis 3                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 2.40000e+1  2.50000e+1  2.60000e+1 │ 2.70000e+1  2.80000e+1  2.90000e+1 ││
    ││      │ 3.00000e+1  3.10000e+1  3.20000e+1 │ 3.30000e+1  3.40000e+1  3.50000e+1 ││
    ││      │ 3.60000e+1  3.70000e+1  3.80000e+1 │ 3.90000e+1  4.00000e+1  4.10000e+1 ││
    ││      │ 4.20000e+1  4.30000e+1  4.40000e+1 │ 4.50000e+1  4.60000e+1  4.70000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    ├──────────────────────────────────────────────────────────────────────────────────┤
    │┌──────┬────────────────────────────────────┬────────────────────────────────────┐│
    ││2 @ 0 │0 @ 2                               │1 @ 2                               ││
    ││      │axis 3                              │axis 3                              ││
    │├──────┼────────────────────────────────────┼────────────────────────────────────┤│
    ││axis 1│ 4.80000e+1  4.90000e+1  5.00000e+1 │ 5.10000e+1  5.20000e+1  5.30000e+1 ││
    ││      │ 5.40000e+1  5.50000e+1  5.60000e+1 │ 5.70000e+1  5.80000e+1  5.90000e+1 ││
    ││      │ 6.00000e+1  6.10000e+1  6.20000e+1 │ 6.30000e+1  6.40000e+1  6.50000e+1 ││
    ││      │ 6.60000e+1  6.70000e+1  6.80000e+1 │ 6.90000e+1  7.00000e+1  7.10000e+1 ││
    │└──────┴────────────────────────────────────┴────────────────────────────────────┘│
    └──────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 0:3|1:4,2:2                                                       │
    │┌──────┬────────────────────────┬────────────────────────┬────────────────────────┐│
    ││      │0 @ 0                   │1 @ 0                   │2 @ 0                   ││
    ││      │axis 2                  │axis 2                  │axis 2                  ││
    │├──────┼────────────────────────┼────────────────────────┼────────────────────────┤│
    ││axis 1│ 1.20000e+1  4.80000e+1 │ 9.00000e+2  1.00800e+3 │ 2.94000e+3  3.12000e+3 ││
    ││      │ 1.05000e+2  1.50000e+2 │ 1.20900e+3  1.32600e+3 │ 3.46500e+3  3.65400e+3 ││
    ││      │ 2.34000e+2  2.88000e+2 │ 1.55400e+3  1.68000e+3 │ 4.02600e+3  4.22400e+3 ││
    ││      │ 3.99000e+2  4.62000e+2 │ 1.93500e+3  2.07000e+3 │ 4.62300e+3  4.83000e+3 ││
    │└──────┴────────────────────────┴────────────────────────┴────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────┘
    |}]

let%expect_test "einsum permuting two leftmost input axes as output axes" =
  Tensor.unsafe_reinitialize ();
  let module Backend = (val Arrayjit.Backends.fresh_backend ()) in
  let backend =
    (module Backend : Backend
      with type buffer_ptr = Backend.buffer_ptr
       and type dev = Backend.dev
       and type runner = Backend.runner
       and type event = Backend.event)
  in
  let stream = Backend.(new_stream @@ get_device ~ordinal:0) in
  let ctx = Backend.make_context stream in
  let a = TDSL.range_of_shape ~label:[ "a" ] ~input_dims:[ 2 ] ~output_dims:[ 2 ] () in
  let b = TDSL.range_of_shape ~label:[ "b" ] ~input_dims:[ 2; 3; 4 ] ~output_dims:[ 2 ] () in
  let%op c = a *+ "i->1; ij...->0 => ...->ji" b in
  Train.forward_and_forget backend ctx c;
  Tensor.print ~with_code:false ~with_grad:false `Default @@ a;
  [%expect
    {|
    ┌───────────────────────────┐
    │[0]: r2x2_a shape 1:2->0:2 │
    │┌──────┬──────────────────┐│
    ││      │axis 1            ││
    │├──────┼──────────────────┤│
    ││axis 0│ 0.00000  1.00000 ││
    ││      │ 2.00000  3.00000 ││
    │└──────┴──────────────────┘│
    └───────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ b;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[1]: r2x2x3x4_b shape 1:2,2:3,3:4->0:2                                                                                                                     │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 2                                           │1 @ 2                                           │2 @ 2                                           ││
    ││      │axis 3                                          │axis 3                                          │axis 3                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││0 @ 1 │ 0.00000     1.00000     2.00000     3.00000    │ 4.00000     5.00000     6.00000     7.00000    │ 8.00000     9.00000     1.00000e+1  1.10000e+1 ││
    ││axis 0│ 2.40000e+1  2.50000e+1  2.60000e+1  2.70000e+1 │ 2.80000e+1  2.90000e+1  3.00000e+1  3.10000e+1 │ 3.20000e+1  3.30000e+1  3.40000e+1  3.50000e+1 ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││1 @ 1 │ 1.20000e+1  1.30000e+1  1.40000e+1  1.50000e+1 │ 1.60000e+1  1.70000e+1  1.80000e+1  1.90000e+1 │ 2.00000e+1  2.10000e+1  2.20000e+1  2.30000e+1 ││
    ││axis 0│ 3.60000e+1  3.70000e+1  3.80000e+1  3.90000e+1 │ 4.00000e+1  4.10000e+1  4.20000e+1  4.30000e+1 │ 4.40000e+1  4.50000e+1  4.60000e+1  4.70000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  Tensor.print ~with_code:false ~with_grad:false `Default @@ c;
  [%expect
    {|
    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │[2]: ;=>_c shape 2:4->0:3,1:2                                                                                                                              │
    │┌──────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────────────┐│
    ││      │0 @ 0                                           │1 @ 0                                           │2 @ 0                                           ││
    ││      │axis 2                                          │axis 2                                          │axis 2                                          ││
    │├──────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────────────┤│
    ││axis 1│ 0.00000     2.00000     4.00000     6.00000    │ 8.00000     1.00000e+1  1.20000e+1  1.40000e+1 │ 1.60000e+1  1.80000e+1  2.00000e+1  2.20000e+1 ││
    ││      │ 3.60000e+1  3.90000e+1  4.20000e+1  4.50000e+1 │ 4.80000e+1  5.10000e+1  5.40000e+1  5.70000e+1 │ 6.00000e+1  6.30000e+1  6.60000e+1  6.90000e+1 ││
    │└──────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────────────┘│
    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
