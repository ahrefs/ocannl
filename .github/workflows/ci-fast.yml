# Fast CI using pre-built relocatable switch
#
# This workflow restores a cached opam switch instead of building from scratch,
# reducing setup time from ~15 min to ~1-2 min.
#
# Prerequisites:
# - Run the build-switch-cache.yml workflow first to create the release
# - Update SWITCH_CACHE_TAG to match your release tag

name: CI (Fast)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  # Update this when you rebuild the switch cache
  SWITCH_CACHE_TAG: switch-cache-v1
  OCAML_VERSION: "5.4.0"

jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bubblewrap zstd

      - name: Install opam
        run: |
          bash -c "sh <(curl -fsSL https://opam.ocaml.org/install.sh)" -- --version 2.2.1

      - name: Initialize opam (bare, no switch)
        run: |
          opam init -y --bare --disable-sandboxing

      - name: Restore cached switch
        run: |
          TARBALL_URL="https://github.com/${{ github.repository }}/releases/download/${SWITCH_CACHE_TAG}/ocannl-switch-${OCAML_VERSION}-linux-x86_64-slim.tar.zst"
          echo "Downloading switch from: $TARBALL_URL"
          
          # Download and extract in one pipeline
          curl -fSL "$TARBALL_URL" | tar -I zstd -xf - -C ~/.opam
          
          # Link the switch to this directory (creates _opam symlink)
          opam switch link ocannl-switch .
          
          # Verify switch works
          eval $(opam env)
          ocamlopt -version
          dune --version

      - name: Build
        run: |
          eval $(opam env)
          dune build

      - name: Run tests
        run: |
          eval $(opam env)
          dune runtest

  # Fallback job that builds from scratch if cache is unavailable
  test-fallback:
    runs-on: ubuntu-24.04
    if: failure()  # Only runs if the main test job fails
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up OCaml (traditional way)
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ env.OCAML_VERSION }}
          dune-cache: true

      - name: Install dependencies
        run: opam install . -y --deps-only --with-test

      - name: Build
        run: opam exec -- dune build

      - name: Run tests
        run: opam exec -- dune runtest
